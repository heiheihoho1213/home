1:"$Sreact.fragment"
2:I[37767,["/_next/static/chunks/13d576de3999a9ec.js","/_next/static/chunks/4a4bc4fd39133772.js"],"default"]
89:I[99706,["/_next/static/chunks/b18da497cd71639c.js","/_next/static/chunks/a43937f87dbafba4.js"],"OutletBoundary"]
8a:"$Sreact.suspense"
3:Tbd4,è¿˜è®°å¾—å‡ ä¸ªæœˆå‰ï¼Œæ˜é‡‘ä½œè€… ***@çŒ«é—·å°817*** çš„ Vue3 ç‰ˆä¸Šçº¿äº†ï¼Œåœ°å€æ˜¯è¿™ä¸ªï¼š<https://github.com/maomentai817/pixel-ui> ã€‚ç°åœ¨æˆ‘ä¸ä»–åˆä½œçš„ React ç‰ˆä¹Ÿæ¥äº†ï¼Œgithub åœ°å€ï¼š<https://github.com/maomentai817/pixel-ui-react>

***

![image.png](/img/posts/Pixel-UI-React/1.jpeg)

### 1ï¸âƒ£ é¡¹ç›®åˆè¡·

çº¢ç™½æœºã€GameBoy æ¸¸æˆï¼Œé‚£ç§å—çŠ¶åƒç´  UI æ€»è®©äººå¿ƒé©°ç¥å¾€ã€‚ç°åœ¨è™½ç„¶æ˜¯ç°ä»£ Web æ—¶ä»£ï¼Œä½†åƒç´ é£ UI çš„ç¾å­¦ä¾ç„¶ä»¤äººç€è¿·ã€‚

ç°æœ‰çš„ 8-bit é£ç»„ä»¶åº“ *NES.css* æ˜¯ä¸€ä¸ª CSS æ¡†æ¶, å®ƒåªéœ€è¦ CSSï¼Œä¸ä¾èµ–äºä»»ä½• JavaScript, æ ¸å¿ƒç»˜åˆ¶é€»è¾‘éƒ½æ˜¯åŸºäº *box-shadow* å®ç°, ä½†åœ¨ä¸åŒæµè§ˆå™¨ç¯å¢ƒ, æµè§ˆå™¨ç¼©æ”¾æ—¶ï¼Œ*box-shadow* çš„æµ®ç‚¹åç§»å€¼ç»è¿‡ç¼©æ”¾åæ— æ³•ç²¾å‡†å¯¹é½ç‰©ç†åƒç´ ç½‘æ ¼ï¼Œå¯¼è‡´æ¸²æŸ“å‡ºç°é—´éš™ã€‚å­åƒç´ å®šä½ã€åƒç´ èˆå…¥è¯¯å·®å’Œ *box-shadow* æœ¬èº«ä¸é€‚åˆç²¾ç»†æ‹¼æ¥æ¸²æŸ“ç­‰åŸå› é€ æˆäº†ä¸€äº›å›°æ‰°

![QQ\_1747188289846.png](/img/posts/Pixel-UI-React/2.jpeg)

[NES.css](https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnostalgic-css%2FNES.css "https://github.com/nostalgic-css/NES.css")

äºæ˜¯å°±æœ‰äº†åŸºäº Vue 3 / React + TypeScript + UnoCSS + CSS Houdini æ‰“é€ çš„ä¸€æ¬¾ç»„ä»¶åº“ â€”â€” è®©**åƒç´ é£é‡å›å‰ç«¯è§†é‡**ã€‚

Vue3 é¡¹ç›®åœ°å€ğŸ‘‡\
ğŸ“¦ [pixel-ui](https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmaomentai817%2Fpixel-ui "https://github.com/maomentai817/pixel-ui")

React é¡¹ç›®åœ°å€ğŸ‘‡\
ğŸ“¦ [pixel-ui-react](https://github.com/maomentai817/pixel-ui-react)

ç»„ä»¶åº“é¦–é¡µğŸ‘‡\
ğŸ“ [Home](https://maomentai817.github.io/pixel-ui-react)

***

### 2ï¸âƒ£ æŠ€æœ¯é€‰å‹

| æŠ€æœ¯æ ˆ               | ç”¨é€”                       |
| ----------------- | ------------------------ |
| React19 + *Hooks* | ç»„ä»¶åŒ–å¼€å‘æ ¸å¿ƒ                  |
| TypeScript        | ç±»å‹ç³»ç»Ÿå¢å¼ºå¼€å‘ä½“éªŒ               |
| UnoCSS            | åŸå­åŒ– CSSï¼Œçµæ´»é…ç½®æ ·å¼ç±»          |
| CSS Houdini       | è‡ªå®šä¹‰ Paint Worklet æ¸²æŸ“åƒç´ è¾¹æ¡† |
| Dumi              | ç»„ä»¶å±•ç¤º + æ–‡æ¡£ç³»ç»Ÿ              |
| Vitest            | æµ‹è¯•ç»„ä»¶é€»è¾‘ä¸æ¸²æŸ“                |
| pnpm + Monorepo     | é«˜æ•ˆæ„å»ºä¸å¤šåŒ…ç®¡ç†                |

***

### 3ï¸âƒ£ é¡¹ç›®ç›®å‰è¿›åº¦

å·²è¿ç§»ä¸Šçº¿ç»„ä»¶ï¼š

*   âœ… Button æŒ‰é’®
*   âœ… Icon å›¾æ ‡
*   âœ… Overlay é®ç½©å±‚
*   âœ… Text æ–‡æœ¬
*   âœ… ConfigProvider å…¨å±€é…ç½®
*   âœ… Input è¾“å…¥æ¡†
*   âœ… Popconfirm æ°”æ³¡ç¡®è®¤æ¡†
*   âœ… Tooltip æ–‡å­—æç¤º

å·²å‘å¸ƒ npmï¼Œå¯ä¾›ä¸‹è½½ã€‚

> æ›´è¿‡è§„åˆ’è§ vue ç‰ˆï¼š<https://juejin.cn/post/7503846429081944101>

***

### 4ï¸âƒ£ æ•ˆæœé¢„è§ˆ

![image.png](/img/posts/Pixel-UI-React/3.jpeg)

![image.png](/img/posts/Pixel-UI-React/4.jpeg)

![image.png](/img/posts/Pixel-UI-React/5.jpeg)

æ¬¢è¿å¤§å®¶ï¼š

*   ğŸŒŸ ç‚¹ä¸ª Star
*   ğŸ› æ Issueï¼Œæœ‰ä»€ä¹ˆå¥½çš„ç‚¹å­å’Œæƒ³æ³•éƒ½å¯ä»¥æ
*   ğŸ¤ æ PRï¼Œå¢å¼ºå®Œå–„åŠŸèƒ½
*   ğŸ“¢ åˆ†äº«ç»™åƒç´ æ§æœ‹å‹ï¼

> é¡¹ç›®åœ°å€ï¼š<https://github.com/maomentai817/pixel-ui-react>4:Ta042,## 1. è™šæ‹Ÿ DOM

#### ä¸ºä»€ä¹ˆä½¿ç”¨è™šæ‹Ÿ DOMï¼ˆvdomï¼‰

- DOM æ“ä½œå¾ˆæ…¢ï¼Œè½»å¾®çš„æ“ä½œéƒ½å¯èƒ½å¯¼è‡´é¡µé¢é‡æ–°æ’ç‰ˆï¼Œéå¸¸è€—æ€§èƒ½ã€‚ç›¸å¯¹äº DOM å¯¹è±¡ï¼Œjs å¯¹è±¡å¤„ç†èµ·æ¥æ›´å¿«ï¼Œè€Œä¸”æ›´ç®€å•ã€‚é€šè¿‡ diff ç®—æ³•å¯¹æ¯”æ–°æ—§ vdomï¼ˆjs å¯¹è±¡ï¼‰ ä¹‹é—´çš„å·®å¼‚ï¼Œå¯ä»¥æ‰¹é‡çš„ã€æœ€å°åŒ–çš„æ‰§è¡Œ dom æ“ä½œï¼Œä»è€Œæå‡ç”¨æˆ·ä½“éªŒ
- DOM å†…ç½®å±æ€§å¤ªå¤šï¼Œä½¿ç”¨ vdom å¯ä»¥åªå°è£…è‡ªå·±æƒ³è¦çš„å±æ€§æ¥å‡å°‘è®¡ç®—å¼€é”€
  ![å›¾ç‰‡](/img/posts/react/old-dom.png)

#### react æ¸²æŸ“

åœ¨æŸä¸€æ—¶é—´èŠ‚ç‚¹è°ƒç”¨ React çš„ render() æ–¹æ³•ï¼Œä¼šåˆ›å»ºä¸€æ£µç”± React å…ƒç´ ç»„æˆçš„æ ‘ã€‚åœ¨ä¸‹ä¸€æ¬¡ state æˆ– props æ›´æ–°æ—¶ï¼Œç›¸åŒçš„ render() æ–¹æ³•ä¼šè¿”å›ä¸€æ£µä¸åŒçš„æ ‘ã€‚React éœ€è¦åŸºäºè¿™ä¸¤æ£µæ ‘ä¹‹é—´çš„å·®åˆ«æ¥åˆ¤æ–­å¦‚ä½•æœ‰æ•ˆç‡çš„æ›´æ–° UI ä»¥ä¿è¯å½“å‰ UI ä¸æœ€æ–°çš„æ ‘ä¿æŒåŒæ­¥ã€‚è¿™ç§ç®—æ³•èµ·ä¸ªåå­—ï¼Œå«åš DIFF ç®—æ³•ï¼Œå­—é¢æ„æ€ï¼Œå°±æ˜¯å¯¹æ¯”å·®å¼‚ã€‚

#### DIFF

react æ¸²æŸ“æ ‘ï¼š

![å›¾ç‰‡](/img/posts/react/diff-tree.png)

ç®—æ³•ç­–ç•¥

- æ·±åº¦ä¼˜å…ˆéå†
- åŒçº§æ¯”è¾ƒ
- æ‹¥æœ‰ä¸åŒç±»å‹çš„ä¸¤ä¸ªç»„ä»¶å°†ä¼šç”Ÿæˆä¸åŒçš„æ ‘å½¢ç»“æ„ã€‚
- ä½¿ç”¨ key æ¥ä¿æŒç¨³å®šæ¸²æŸ“

diff åŸåˆ™

- åˆ é™¤ï¼šnewVdom ä¸å­˜åœ¨æ—¶
- æ›¿æ¢ï¼švdom å’Œ newVdom ç±»å‹ä¸åŒæˆ– key ä¸åŒæ—¶
- æ›´æ–°ï¼šæœ‰ç›¸åŒç±»å‹å’Œ key ä½† vdom å’Œ newVdom ä¸åŒæ—¶

## 2. Fiber ç»“æ„

ä¸ºä»€ä¹ˆéœ€è¦ fiber

ä¸€ä¸ªæ–°çš„æ›´æ–°æ¸²æŸ“ç»“æ„ï¼Œæ›´å¥½çš„éå†æ¸²æŸ“æ ‘ï¼Œæé«˜æ€§èƒ½ã€‚

- diff ç®—æ³•é‡‡ç”¨æ·±åº¦ä¼˜å…ˆéå†ï¼ˆé€’å½’ï¼‰çš„æ–¹å¼ï¼Œå¯¹äºå¤§å‹é¡¹ç›®ï¼Œç»„ä»¶æ ‘ä¼šå¾ˆå¤§ï¼Œè¿™ä¸ªæ—¶å€™é€’å½’éå†çš„æˆæœ¬å°±ä¼šå¾ˆé«˜ï¼Œä¼šé€ æˆä¸»çº¿ç¨‹è¢«æŒç»­å ç”¨ï¼Œç»“æœå°±æ˜¯ä¸»çº¿ç¨‹ä¸Šçš„å¸ƒå±€ã€åŠ¨ç”»ç­‰å‘¨æœŸæ€§ä»»åŠ¡å°±æ— æ³•ç«‹å³å¾—åˆ°å¤„ç†ï¼Œé€ æˆè§†è§‰ä¸Šçš„å¡é¡¿ï¼Œå½±å“ç”¨æˆ·ä½“éªŒã€‚

fiber æ ¸å¿ƒæ€æƒ³

1. å¢é‡æ¸²æŸ“ï¼Œç©ºé—²æ›´æ–°ï¼ˆæŠŠæ¸²æŸ“ä»»åŠ¡æ‹†åˆ†æˆå—ï¼ŒåŒ€åˆ°å¤šå¸§ï¼‰ï¼Œä½¿ç”¨é“¾è¡¨å¾ªç¯ä»£æ›¿é€’å½’æ¥è¿›è¡Œæ·±åº¦ä¼˜å…ˆéå†ï¼Œç®—æ³•æ—¶é—´å¤æ‚åº¦ O(n)
2. æ›´æ–°æ—¶èƒ½å¤Ÿæš‚åœï¼Œç»ˆæ­¢ï¼Œå¤ç”¨æ¸²æŸ“ä»»åŠ¡
3. ç»™ä¸åŒç±»å‹çš„æ›´æ–°èµ‹äºˆä¼˜å…ˆçº§
4. ç»™æ–°ç‰ˆ react æä¾›å¹¶å‘çš„åŸºç¡€èƒ½åŠ›

![å›¾ç‰‡](/img/posts/react/fiber-1.jpeg)

fiber æ ‘(åŒå‘é“¾è¡¨)ï¼š

```js
// å‚è€ƒ jsx
<div>
  <article>
    <span></span>
  </article>
  <p>
    <strong></strong>
  </p>
  <a></a>
</div>
```

![å›¾ç‰‡](/img/posts/react/fiber-2.png)

å› ä¸ºè¦å€ŸåŠ© fiberï¼Œæ‰€ä»¥åœ¨ vdom å¤–éœ€è¦åŒ…è£…ä¸€ä¸ª fiber node çš„å°è£…æ¥å‚ä¸è°ƒåº¦ã€‚

## 3. å®ç°ä¸€ä¸ª mini-fiber

### ã€‡ æµç¨‹å›¾

![å›¾ç‰‡](/img/posts/react/fiber.png)

### â‘  Tags

ç”±äºè¦æ¸²æŸ“ä¸åŒçš„ç»„ä»¶å’ŒåŸç”Ÿæ ‡ç­¾ï¼Œç»™å„ä¸ªç±»å‹æ‰“ä¸Šæ ‡ç­¾ï¼š

```js
// ReactWorkTags
export const FunctionComponent = 0;
export const ClassComponent = 1;
export const IndeterminateComponent = 2;
...
export const HostComponent = 5;
export const HostText = 6;
export const Fragment = 7;
```

### â‘¡ Fiber å¯¹è±¡

æ–°å»ºä¸€ä¸ª fiber å°è£…ç±»

```js
// ReactFiber
export function createFiber(vnode, returnFiber) {
  const fiber = {
    type: vnode.type, // è¡¨ç¤ºfiberçš„çœŸå®ç±»å‹ è¿™ä¸ªå’ŒelementTypeå¤§éƒ¨åˆ†æƒ…å†µä¸‹æ˜¯ä¸€æ ·çš„ åœ¨ä½¿ç”¨äº†æ‡’åŠ è½½ä¹‹ç±»çš„åŠŸèƒ½æ—¶å¯èƒ½ä¼šä¸ä¸€æ ·ã€‚ åŒºåˆ«äº tagï¼Œtypeå¯ä»¥è‡ªå®šä¹‰ï¼Œå½“æ˜¯ç»„ä»¶æ—¶ typeå¯ä»¥æ˜¯è¿™ä¸ªç»„ä»¶çš„æ„é€ å‡½æ•°ï¼Œç”¨æˆ·åˆ›å»ºå…ƒç´ æ—¶ä½¿ç”¨
    key: vnode.key,
    props: vnode.props, // å±æ€§
    // ç¬¬ä¸€ä¸ªå­èŠ‚ç‚¹fiber
    child: null,
    // ä¸‹ä¸€ä¸ªå…„å¼Ÿfiber
    sibling: null,
    // çˆ¶fiber
    return: returnFiber,
    // domæˆ–å®ä¾‹
    // å‡½æ•°å¼ç»„ä»¶ä¸ºnullï¼Œä»–çš„å®ä¾‹å­˜åœ¨childé‡Œï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆrenderé‡Œåªèƒ½æœ‰ä¸€ä¸ªè·ŸèŠ‚ç‚¹
    stateNode: null,
    // èŠ‚ç‚¹ä¸‹æ ‡
    index: null,
    // old fiber
    alternate: null,
    flags: Placement,
    tag: null,
  };

  const { type } = vnode;

  // æ‰“ tag
  if (isStr(type)) {
    // åŸç”Ÿæ ‡ç­¾
    fiber.tag = HostComponent; // ä¼ å…¥çš„æ˜¯dom.nodeName
  } else if (isFn(type)) {
    // å‡½æ•°ç»„ä»¶ ç±»ç»„ä»¶
    fiber.tag = type.prototype.isReactComponent
      ? ClassComponent
      : FunctionComponent;
  } else if (isUndefined(type)) {
    // æ­¤æ—¶æ˜¯çº¯æ–‡æœ¬æˆ–æ•°å­—èŠ‚ç‚¹
    fiber.tag = HostText;
    fiber.props = { children: vnode };
  } else {
    fiber.tag = Fragment;
  }

  return fiber;
}
```

å…¶ä¸­ flags ç”¨äºåŒºåˆ†æ¥ä¸‹æ¥è¿›è¡Œä»€ä¹ˆæ“ä½œï¼š

```js
export const Placement = /*                    */ 0b0000000000000000000010; // 2
export const Update = /*                       */ 0b0000000000000000000100; // 4
export const Deletion = /*                     */ 0b0000000000000000001000; // 8
```

> çŸ¥é“ä¸ºä»€ä¹ˆä½¿ç”¨ äºŒè¿›åˆ¶å—ï¼Ÿè€ƒè™‘åˆ°å³å°†è¿›è¡Œçš„æ“ä½œå¯èƒ½ä¼šæœ‰å¤šä¸ªï¼Œä¸ºäº†æé«˜å¯æ‰©å±•æ€§ï¼Œä½¿ç”¨äºŒè¿›åˆ¶æ–¹ä¾¿ä½è¿ç®—ï¼Œç›¸åŠ åŒæ ·å…·æœ‰å”¯ä¸€æ€§ã€‚åˆ¤æ–­ï¼š`state & Update === true`

åŒºåˆ† å‡½æ•°å¼ç»„ä»¶å’Œç±»å¼ç»„ä»¶ï¼Œéœ€è¦é¢å¤–åŠ æ ‡å¿—ã€‚æˆ‘ä»¬éƒ½çŸ¥é“ ç±»å¼ç»„ä»¶æœ€ç»ˆéƒ½ä¼šç»§æ‰¿ Component ç»„ä»¶ï¼Œæˆ‘èƒ½å°±åœ¨è¿™ä¸ªä¸Šè¾¹åšæ‰‹è„šï¼š

```js
export default function Component(props) {
  this.props = props;
}

// ç±»ç»„ä»¶æ ‡è®°
Component.prototype.isReactComponent = {};
```

åªè¦åˆ¤æ–­æœ‰æ²¡æœ‰ isReactComponent å°±å¯ä»¥åŒºåˆ†æ˜¯å¦æ˜¯å‡½æ•°å¼ç»„ä»¶äº†ã€‚

å¦‚æ­¤å°±æ„å»ºäº†ä¸€ä¸ªå¯¹ react vdom äºŒæ¬¡å°è£…çš„ Fiber å¯¹è±¡ã€‚

### â‘¢ æ¸²æŸ“å®¹å™¨

æˆ‘ä»¬éƒ½çŸ¥é“ï¼ŒReact 17+ çš„æ ¹ç»„ä»¶æ¸²æŸ“æ–¹å¼ï¼š

```js
// æ–°çš„æ¸²æŸ“æ–¹å¼ï¼Œå¼€æ”¾å‡ºäº† root å¯¹è±¡å•ä¾‹ï¼Œæ–¹ä¾¿é‡å¤render
const root = ReactDOM.createRoot(document.getElementById("root"));
root.render(jsx);

...
root.render(jsx1);
```

é‚£ä¸å¦‚å°±ä»è¿™é‡Œå…¥æ‰‹ï¼Œæ¥çœ‹çœ‹ fiber æ˜¯æ€ä¹ˆå°è£… dom çš„ã€‚

```js
function createRoot(container) {
  const root = {
    containerInfo: container,
  };

  return new ReactDOMRoot(root);
}

function ReactDOMRoot(internalRoot) {
  this._internalRoot = internalRoot;
}
```

createRoot è¿”å›äº†ä¸€ä¸ªæ–°çš„ ReactDOMRoot å¯¹è±¡:

```js
ReactDOMRoot.prototype.render = function (children) {
  const root = this._internalRoot;

  updateContainer(children, root);
};

function updateContainer(element, container) {
  const { containerInfo } = container;

  // è¿™é‡Œå¯ä»¥çœ‹åˆ°ï¼Œ reactçš„å®¹å™¨æ ¹èŠ‚ç‚¹ä¸€å®šæ˜¯åŸç”Ÿçš„domï¼Œä¸ç„¶ä¸å­˜åœ¨nodeName
  const rootFiber = createFiber(element, {
    type: containerInfo.nodeName.toLocaleLowerCase(),
    stateNode: containerInfo,
  });

  scheduleUpdateOnFiber(rootFiber);
}
```

è¿™ä¸ªå¯¹è±¡å®ç°äº† root çš„ render æ–¹æ³•ï¼Œè°ƒç”¨äº† updateContainer æ–¹æ³•ã€‚è€Œè¿™ä¸ªæ–¹æ³•åˆ›å»ºäº†ä¸€ä¸ª Fiber å¯¹è±¡ï¼Œé€šè¿‡ scheduleUpdateOnFiber åŠ å…¥è°ƒåº¦å™¨ï¼š

```js
export function scheduleUpdateOnFiber(fiber) {
  // work in process
  wip = fiber;
  wipRoot = fiber;
}
```

work in process è¡¨ç¤ºå½“å‰æ­£åœ¨å¤„ç†çš„ fiber èŠ‚ç‚¹ã€‚

æˆ‘ä»¬çœ‹åˆ°äº†ï¼Œåˆå§‹åŒ–å·¥ä½œå®Œæˆåï¼Œä¼¼ä¹æ²¡æœ‰æ¸²æŸ“çš„æ“ä½œï¼Œåªæ˜¯ new äº†ä¸€å †å¯¹è±¡ã€‚æ‰€ä»¥éœ€è¦åˆ›å»ºä¸€ä¸ªè°ƒåº¦ä»»åŠ¡ã€‚

### â‘£ è°ƒåº¦å™¨ä¹‹ä¸€

æµè§ˆå™¨æœ‰è‡ªå·±çš„è°ƒåº¦å·¥å…·ï¼š

> è¿™é‡Œæˆ‘ä»¬æš‚ä¸”ä½¿ç”¨æµè§ˆå™¨è‡ªå¸¦çš„ç©ºé—²æ—¶é—´ç‰‡è°ƒåº¦å·¥å…·ã€‚ç”±äºè€ƒè™‘åˆ°å…¼å®¹æ€§ï¼ŒReact è‡ªå·±å®ç°äº†è¿™ä¸ªå‡½æ•°ï¼Œæ”¾åœ¨ Scheduler é‡Œï¼Œä¸‹è¾¹ä¼šè®²åˆ°ã€‚

```js
// TODOï¼šreact scheduler éƒ¨åˆ†åŸç”Ÿå®ç°äº†ä¸€å¥—ï¼šæµè§ˆå™¨äº‹ä»¶å¾ªç¯ç©ºé—²æ—¶é—´æ®µå†…è°ƒç”¨å‡½æ•°æ’é˜Ÿ
requestIdleCallback(workLoop);
```

æˆ‘ä»¬è¿™é‡Œå…³æ³¨çš„é‡ç‚¹è¿˜æ˜¯åœ¨å¦‚ä½•è°ƒåº¦ä¸Šï¼š

```js
function workLoop(IdleDeadLine) {
  // å¯ä»¥è‡ªå·±å®šä¹‰ä¼˜å…ˆçº§æ¥æ ¸å®æ‰§è¡Œä»€ä¹ˆäº‹ä»¶ï¼Œè¿™é‡Œåˆ¤æ–­åªè¦ç©ºé—²å°±æ’é˜Ÿ
  while (wip && IdleDeadLine.timeRemaining() > 0) {
    // æ‰§è¡Œä»»åŠ¡ï¼šä½¿ç”¨æ–°çš„ O(n) ç®—æ³•
    performUnitOfWork();
  }

  // ç¡®ä¿è°ƒåº¦å™¨åœ¨è¿è¡Œ
  requestIdleCallback(workLoop);

  // å¦‚æœæ‰€æœ‰çš„ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ï¼Œcommitä¸€ä¸‹ï¼Œå°±æ˜¯è¯´è§¦å‘ä¸€æ¬¡æ›´æ–°ã€‚ä» root å¼€å§‹åˆ·æ–°ä¸€éæ¸²æŸ“
  if (!wip && wipRoot) {
    commitRoot();
  }
}
```

ä¸Šè¾¹çš„ä»£ç æ˜¯ä¸€ä¸ªå¾ªç¯è°ƒåº¦ï¼Œåå¤è°ƒç”¨ requestIdleCallbackï¼Œè®© CPU åœ¨ç©ºé—²æ—¶é—´ç‰‡è°ƒç”¨æˆ‘ä»¬è‡ªå·±å®šä¹‰çš„è°ƒåº¦å‡½æ•°æ¥æ¸²æŸ“ç•Œé¢ã€‚å½“æœ‰ç©ºé—²æ—¶é—´æ—¶ï¼Œæ‰§è¡Œ performUnitOfWorkï¼Œå½“æ²¡æœ‰å·¥ä½œä¸­çš„ fiber å®ä¾‹ï¼Œè¯´æ˜æ˜¯æ¸²æŸ“æ ¹èŠ‚ç‚¹ï¼Œæ­¤æ—¶ä¸èƒ½å¤ç”¨ä¸Šè¾¹çš„æ›´æ–°é€»è¾‘ï¼Œå› ä¸ºèŠ‚ç‚¹éƒ½è¿˜æ²¡æœ‰å‘¢ï¼Œè°ˆä¸ä¸Šæ›´æ–°ï¼Œæ­¤æ—¶éœ€è°ƒç”¨ commitRootã€‚

æ‰§è¡Œä»»åŠ¡ä»£ç å¦‚ä¸‹ï¼š

```js
// performUnitOfWork
const { tag } = wip;

// é€šè¿‡ tag åŒºåˆ†æ¸²æŸ“æ¨¡å¼
switch (tag) {
  case HostComponent:
    updateHostComponent(wip);
    break;

  case FunctionComponent:
    updateFunctionComponent(wip);
    break;

  case ClassComponent:
    updateClassComponent(wip);
    break;

  case Fragment:
    updateFragmentComponent(wip);
    break;

  case HostText:
    updateTextComponent(wip);
    break;

  default:
    break;
}

// 2. æ›´æ–°wip å¤šå‰æ ‘æ·±åº¦ä¼˜å…ˆéå†
// ä¼˜å…ˆæ‰¾å­©å­ï¼Œæ²¡æœ‰å­©å­å°±æ‰¾å…„å¼Ÿï¼Œæ²¡æœ‰å…„å¼Ÿæ‰¾çˆ¶çº§çš„å…„å¼Ÿï¼Œç›´åˆ°æ‰¾åˆ°æ ¹èŠ‚ç‚¹ã€‚æ—¶é—´å¤æ‚åº¦ï¼šO(n)
if (wip.child) {
  wip = wip.child;
  return;
}

let next = wip;

while (next) {
  if (next.sibling) {
    wip = next.sibling;
    return;
  }
  next = next.return;
}
wip = null;
```

commitRoot ä»£ç å¦‚ä¸‹ï¼š

```js
// commitRoot
commitWorker(wipRoot);
// é˜²æ­¢è¢« å¤šæ¬¡æ‰§è¡Œ
wipRoot = null;

// fiber æ ‘åˆ›å»ºçš„è¿‡ç¨‹
function commitWorker(wip) {
  // ç›´åˆ°æ‰¾ä¸åˆ° wipï¼Œé€€å‡º
  if (!wip) {
    return;
  }
  // è‡ªå·±
  const { stateNode, flags } = wip;
  // çˆ¶domèŠ‚ç‚¹
  const parentNode = getParentNode(wip.return); //wip.return.stateNode;

  // å…·ä½“ flags çš„è®¾ç½®ï¼Œåœ¨ åè¾¹ diff ç®—æ³•ä¸­å®ç°

  // å³å°†åˆ›å»ºçš„
  if (flags & Placement && stateNode) {
    parentNode.appendChild(stateNode);
  }

  // å³å°†æ›´æ–°çš„
  if (flags & Update && stateNode) {
    updateNode(stateNode, wip.alternate.props, wip.props);
  }

  // å³å°†åˆ é™¤çš„
  if (wip.deletions) {
    commitDeletions(wip.deletions, stateNode || parentNode);
  }

  // 2. ä¸‹ä¸€ä¸ªå­©å­
  commitWorker(wip.child);
  // 3. ä¸‹ä¸€ä¸ªå…„å¼Ÿ
  commitWorker(wip.sibling);
}

function getParentNode(wip) {
  // è‡ªå®šä¹‰ç»„ä»¶æ²¡æœ‰å®ä½“ï¼Œreturné‡Œå…¨æ˜¯childï¼Œéœ€å¾€ä¸Šæ‰¾çˆ¶ç»„ä»¶
  let tem = wip;
  while (tem) {
    if (tem.stateNode) {
      return tem.stateNode;
    }
    tem = tem.return;
  }
}

// prev  {a: 1}
// next { b: 3}
export function updateNode(node, prevVal, nextVal) {
  Object.keys(nextVal).forEach((k) => {
    if (k === 'children') {
      // æœ‰å¯èƒ½æ˜¯æ–‡æœ¬ï¼Œæˆ‘ä»¬è‡ªå·±è®¾ç½®çš„æ–‡æœ¬èŠ‚ç‚¹ props.children
      if (isStringOrNumber(nextVal[k])) {
        node.textContent = nextVal[k] + '';
      }
    } else if (k.slice(0, 2) === 'on') {
      const eventName = k.slice(2).toLocaleLowerCase();
      node.addEventListener(eventName, nextVal[k]);
    } else {
      node[k] = nextVal[k];
    }
  });
}

function commitDeletions(deletions, parentNode) {
  for (let i = 0; i < deletions.length; i++) {
    parentNode.removeChild(getStateNode(deletions[i]));
  }
}

function getStateNode(fiber) {
  let tem = fiber;
  while (!tem.stateNode) {
    tem = tem.child;
  }

  return tem.stateNode;
}
```

### â‘¤ æ¸²æŸ“èŠ‚ç‚¹

ä¸Šè¾¹çš„ commit æ“ä½œæˆ‘ä»¬çœ‹åˆ°äº†ï¼Œæ˜¯æ ¹æ®èŠ‚ç‚¹çš„ flags å’Œ stateNode å®ä¾‹æ¥æ›´æ–°çš„ã€‚åœ¨æ¸²æŸ“çš„æ—¶å€™ï¼Œéœ€è¦å†™å…¥è¿™ä¸¤ä»½å±æ€§ï¼Œ

1. æ¸²æŸ“åŸç”ŸèŠ‚ç‚¹ï¼š

createElement åˆ›å»ºå…ƒç´ ï¼Œprops é€šè¿‡ updateNode æ›´æ–°

```js
export function updateHostComponent(wip) {
  // åˆæ¬¡åŠ è½½ï¼ŒstateNode=null
  if (!wip.stateNode) {
    // type : dom.nodeName.toLowerCase()
    wip.stateNode = document.createElement(wip.type);
    // æœ€ç»ˆéƒ½ä¼šå½’ç±»åˆ°åŸç”ŸèŠ‚ç‚¹
    // åˆå§‹åŒ–åœ¨è¿™é‡Œcommitï¼Œä¹‹åçš„æ›´æ–°åœ¨commitWorkeré‡Œcommit
    updateNode(wip.stateNode, {}, wip.props);
  }

  // åè°ƒå­èŠ‚ç‚¹
  reconcileChildren(wip, wip.props.children);
}
```

2. æ¸²æŸ“æ–‡æœ¬èŠ‚ç‚¹

```js
export function updateTextComponent(wip) {
  // è¿˜è®°å¾—ä¸Šè¾¹åŸç”ŸèŠ‚ç‚¹æ”¾åœ¨äº† props.children ä¸­
  wip.stateNode = document.createTextNode(wip.props.children);
}
```

3. æ¸²æŸ“ç±»å¼ç»„ä»¶

```js
export function updateClassComponent(wip) {
  const { type, props } = wip;

  // type æ˜¯ç±»çš„æ„é€ å™¨
  const instance = new type(props);
  const children = instance.render();

  reconcileChildren(wip, children);
}
```

4. æ¸²æŸ“å‡½æ•°å¼ç»„ä»¶

```js
export function updateFunctionComponent(wip) {
  // è¯»å– hook çš„æ“ä½œä¹‹åè®²hookåŸç†æ—¶ä¼šæåˆ°
  // renderWithHooks(wip);
  const { type, props } = wip;

  const children = type(props);

  reconcileChildren(wip, children);
}
```

5. æ¸²æŸ“ Fragment

```js
export function updateFragmentComponent(wip) {
  reconcileChildren(wip, wip.props.children);
}
```

æœ€åæ˜¯è°ƒèŠ‚å­èŠ‚ç‚¹å‡½æ•°ï¼Œè¿™ä¹Ÿæ˜¯ diff ç®—æ³•å®ç°çš„åœ°æ–¹ï¼Œè®¾ç½® flag ä¹Ÿåœ¨è¿™é‡Œï¼š

```js
function reconcileChildren(wip, children) {
  if (isStringOrNumber(children)) {
    return;
  }

  // åŸç”Ÿ dom åªæœ‰ä¸€ä¸ª childï¼Œä¼šæ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œè¿™é‡Œç»Ÿä¸€æ”¾åœ¨æ•°ç»„é‡Œ
  const newChildren = isArray(children) ? children : [children];

  // è®°å½•ä¸Šä¸€ä¸ªfiber
  let previousNewFiber = null;
  let oldFiber = wip.alternate?.child;
  for (let i = 0; i < newChildren.length; i++) {
    const newChild = newChildren[i];
    if (!newChild) {
      // è§„é¿è¿™æ ·çš„å†™æ³•ï¼š {null}
      continue;
    }
    const newFiber = createFiber(newChild, wip);

    const same = sameNode(newFiber, oldFiber);

    if (same) {
      // æ ‡è®°ï¼šæ›´æ–°èŠ‚ç‚¹
      Object.assign(newFiber, {
        stateNode: oldFiber.stateNode,
        alternate: oldFiber,
        flags: Update,
      });
    }

    if (!same && oldFiber) {
      // ä¸æ–°çš„ä¸ä¸€æ ·ï¼Œæ ‡è®°ï¼šåˆ é™¤
      deleteChild(wip, oldFiber);
    }

    if (oldFiber) {
      oldFiber = oldFiber.sibling;
    }

    // createFiber é»˜è®¤çš„ flagså°±æ˜¯æ ‡è¯†ï¼šPlacement æ–°å»º
    if (i === 0) {
      // å­èŠ‚ç‚¹ä¸­çš„ç¬¬ä¸€ä¸ªï¼ŒæŠŠé“¾è¡¨æ„å»ºèµ·æ¥
      wip.child = newFiber;
    } else {
      previousNewFiber.sibling = newFiber;
    }

    previousNewFiber = newFiber;
  }
}

function deleteChild(returnFiber, childToDelete) {
  const deletions = returnFiber.deletions;

  if (deletions) {
    returnFiber.deletions.push(childToDelete);
  } else {
    returnFiber.deletions = [childToDelete];
  }
}

function sameNode(a, b) {
  return a && b && a.type === b.type && a.key === b.key;
}
```

### â‘¥ è°ƒåº¦å™¨ä¹‹äºŒ

è®²è‡ªå®šä¹‰è°ƒåº¦ CPU ç©ºé—²æ—¶é—´ç‰‡ä¹‹å‰ï¼Œå…ˆå›é¡¾ä¸€ä¸‹ä¹‹å‰åŠ å…¥è°ƒåº¦å™¨çš„å‡½æ•°ï¼š

```js
// rootèŠ‚ç‚¹è°ƒç”¨
export function scheduleUpdateOnFiber(fiber) {
  // work in process
  wip = fiber;
  wipRoot = fiber;

  // æ–°å»ºä¸€ä¸ªè‡ªå®šä¹‰çš„è°ƒåº¦
  scheduleCallback(workLoop);
}
```

ä¸Šè¾¹ä¸ºäº†ä¸ä½¿ç”¨ js è‡ªå¸¦çš„è°ƒåº¦å™¨ requestIdleCallbackï¼Œreact è¿™é‡Œè‡ªå®šä¹‰äº†è°ƒåº¦çš„å®ç°ã€‚æˆ‘ä»¬æ¥ç®€æ˜“å®ç°ä¸€ä¸‹è¿™ä¸ªè°ƒåº¦å™¨ï¼š

---

ï¼ˆè°ƒåº¦å™¨å®ç°å¼€å§‹ï¼‰

```js
// scheduler.js
// ç‰µæ‰¯åˆ°æœ€å°å †çš„ç®—æ³•ï¼Œå¯ä»¥å‚è€ƒçŸ¥è¯†åº“ä¸­åŸºç¡€éƒ¨åˆ†ç®—æ³•
import { push, pop, peek } from './minHeap';

// ä»»åŠ¡é˜Ÿåˆ—
let taskQueue = [];
// ä»»åŠ¡è®¡æ•°
let taskIdCounter = 1;

// ä»»åŠ¡ä¼˜å…ˆçº§ å»¶è¿Ÿæ—¶é—´
export function scheduleCallback(callback) {
  const currentTime = getCurrentTime();

  const timeout = -1; // æºç ä¸­è¿˜ä¼šæœ‰ priorityLevel ä½œä¸ºä¸€ä¸ªæƒé‡ç»´åº¦
  const expirationTime = currentTime + timeout;

  // æ¯æ¬¡è°ƒåº¦ï¼Œidè‡ªå¢ï¼Œpushè¿›å †
  const newTask = {
    id: taskIdCounter++,
    callback, // å›è°ƒå‡½æ•°
    expirationTime, // ä»»åŠ¡å¼€å§‹æ—¶é—´
    sortIndex: expirationTime, // ä»»åŠ¡æ’åºï¼Œå–å†³äºè¿‡æœŸæ—¶é—´ï¼ˆè¿™é‡Œç®€å•çš„ä»»åŠ¡è¿‡æœŸæ—¶é—´è¶Šè¿‘ï¼Œä¼˜å…ˆçº§è¶Šé«˜ï¼‰
  };
  push(taskQueue, newTask);

  // è¯·æ±‚è°ƒåº¦
  requestHostCallback();
}

// MessageChannelå…è®¸æˆ‘ä»¬åœ¨ä¸åŒçš„æµè§ˆä¸Šä¸‹æ–‡ï¼Œæ¯”å¦‚window.open()æ‰“å¼€çš„çª—å£æˆ–è€…iframeç­‰ä¹‹é—´å»ºç«‹é€šä¿¡ç®¡é“ï¼Œå¹¶é€šè¿‡ä¸¤ç«¯çš„ç«¯å£ï¼ˆport1å’Œport2ï¼‰å‘é€æ¶ˆæ¯ã€‚MessageChannelä»¥DOM Eventçš„å½¢å¼å‘é€æ¶ˆæ¯ï¼Œæ‰€ä»¥å®ƒå±äºå¼‚æ­¥çš„å®ä»»åŠ¡ã€‚
const channel = new MessageChannel();
const port = channel.port2;
channel.port1.onmessage = function () {
  handleWorkMessage();
};

function requestHostCallback() {
  port.postMessage(null);
}

function handleWorkMessage() {
  // æ¯æ¬¡å–å‡ºå †é¡¶æœ€å°çš„
  let currentTask = peek(taskQueue);
  while (currentTask) {
    // æš‚ä¸è€ƒè™‘æ‰§è¡Œè¿›åº¦ä»¥åŠä¸­æ–­æ‰§è¡Œ
    const callback = currentTask.callback;
    currentTask.callback = null;
    callback();
    // åˆ é™¤ä»»åŠ¡
    pop(taskQueue);
    // æ‹¿å½“å‰ç­‰å¾…æ—¶é—´æœ€å°çš„ä»»åŠ¡
    currentTask = peek(taskQueue);
  }
}

function getCurrentTime() {
  // Date.now()ï¼šè¿”å›çš„æ—¶é—´æˆ³æ²¡æœ‰è¢«é™åˆ¶åœ¨ä¸€æ¯«ç§’çš„ç²¾ç¡®åº¦å†…ï¼Œå°äº 1ms çš„æµ‹è¯•ä¸å‡ºæ¥ç»“æœã€‚
  // performance.now()ï¼šè¿”å›çš„æ—¶é—´æˆ³ä»¥åŒç²¾åº¦æµ®ç‚¹æ•° double çš„å½¢å¼è¡¨ç¤ºæ—¶é—´ï¼Œç²¾åº¦æœ€é«˜å¯è¾¾å¾®ç§’çº§ã€‚ä¸å—ç³»ç»Ÿå½±å“ã€‚Date.now() çº¦ç­‰äº performance.timing.navigationStart + performance.now()
  return performance.now();
}
```

ï¼ˆè°ƒåº¦å™¨å®ç°ç»“æŸï¼‰

---

æ­¤æ—¶è°ƒåº¦å™¨å¤–è¾¹çš„ loop å‡½æ•°å°±å¯ä»¥ç²¾ç®€äº†ï¼š

```js
function workLoop() {
  while (wip) {
    performUnitOfWork();
  }

  // ç¡®ä¿è°ƒåº¦å™¨åœ¨è¿è¡Œ
  // requestIdleCallback(workLoop);

  if (!wip && wipRoot) {
    commitRoot();
  }
}
```

### ã€‡ æ”¹è¿›çš„æµç¨‹å›¾

![å›¾ç‰‡](/img/posts/react/fiber-3.png)

## 4. Hooks

å†™åœ¨å‰è¾¹ï¼šHooks ä¸¥æ ¼æ¥è¯´ä¹Ÿæ˜¯ fiber çš„ä¸€éƒ¨åˆ†ï¼Œä¹Ÿç‰µæ‰¯åˆ° diff å’Œè°ƒåº¦ï¼Œå•ç‹¬æ‹¿å‡ºæ¥æ˜¯å› ä¸ºä»–ç¡®å®æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„æ¦‚å¿µï¼ŒåŒæ—¶ä¹Ÿé¿å…ä¸Šä¸€ä¸ªç« èŠ‚å¤ªè¿‡è‡ƒè‚¿ã€‚

`Hooks` æœ¬è´¨å°±æ˜¯å¤„ç†å‡½æ•°å¼ç»„ä»¶çš„çŠ¶æ€çš„é›†åˆã€‚çŠ¶æ€ï¼Œæ˜¯ react vdom ä¸­è‡ªå®šä¹‰çš„ä¸€ä¸ªå±æ€§ï¼Œæˆ‘ä»¬åœ¨ fiber åŒ–ä¹‹åä¹Ÿåº”è¯¥æœ‰ï¼Œè¿™é‡ŒåŠ ä¸Šï¼š

```js
export function createFiber(vnode, returnFiber) {
  const fiber = {
    ...
    memorizedState: null
  }
}
```

memorizedState å±æ€§å¯¹äºç±»å¼ç»„ä»¶å­˜æ”¾çš„æ˜¯ state å¯¹è±¡ï¼Œå¯¹äºå‡½æ•°å¼ç»„ä»¶æ¯”è¾ƒéº»çƒ¦ï¼Œå› ä¸º hooks æ˜¯ä¸€ä¸ªä¸€ä¸ªçš„ï¼Œæ‰€ä»¥è¿™é‡Œåˆç”¨äº†é“¾å¼å­˜å‚¨ï¼ŒmemorizedState å­˜æ”¾ç¬¬ä¸€ä¸ª hooks æŒ‡é’ˆå³å¯ã€‚

å› ä¸º hooks æ˜¯å‡½æ•°å¼ç»„ä»¶ç‰¹æœ‰çš„ï¼Œæ‰€ä»¥åªä¼šåœ¨æ¸²æŸ“å‡½æ•°å¼ç»„ä»¶æ—¶ä½¿ç”¨ï¼š

```js
export function updateFunctionComponent(wip) {
  // è¿™é‡Œè°ƒç”¨
  renderWithHooks(wip);

  const { type, props } = wip;
  const children = type(props);
  reconcileChildren(wip, children);
}
```

æˆ‘ä»¬æ–°å»ºä¸€ä¸ª hooks.js æ–‡ä»¶æ¥åŒæ„å¤„ç† hookã€‚

å…ˆå¤„ç† hooks ä¸­çš„å…¨å±€å±æ€§ï¼š

```js
let currentlyRenderingFiber = null;
// è€hook, åœ¨useEffectä¸­ä½¿ç”¨
let currentHook = null;
// å½“å‰å·¥ä½œä¸­çš„hookï¼ŒåŒwipä¸€æ ·ï¼Œhooksä¹Ÿæ˜¯ä¸€ä¸ªé“¾è¡¨ï¼Œéœ€è¦ä¸€ä¸ªå½“å‰çš„æŒ‡é’ˆä½ç½®æ ‡è¯†
let workInProgressHook = null;

export function renderWithHooks(wip) {
  currentlyRenderingFiber = wip;
  currentlyRenderingFiber.memorizedState = null;
  workInProgressHook = null;
}
```

è¿™é‡Œç±»æ¯”å‰é¢çš„ fiber åº”è¯¥å¥½ç†è§£ï¼Œè®²å½“å‰ wip ä¼ å…¥å˜é‡ currentlyRenderingFiberï¼Œå¹¶åˆå§‹åŒ–ã€‚

æ¥ç€å†™ä¸€ä¸ªé€šç”¨çš„æ–¹æ³•æ¥æ„é€ å‡½æ•°å¼ç»„ä»¶ä¸­ hooks çš„é“¾è¡¨å…³ç³»ï¼š

```js
function updateWorkInProgressHook() {
  let hook;

  // æ‹¿åˆ°å½“å‰ fiber åœ¨ diff ä¸­çš„ old fiber
  const current = currentlyRenderingFiber.alternate;

  if (current) {
    // 2.æ›´æ–°
    currentlyRenderingFiber.memorizedState = current.memorizedState;

    if (workInProgressHook) {
      // å½“å‰ hook æŒ‡é’ˆçš„ä½ç½®
      workInProgressHook = hook = workInProgressHook.next;
      currentHook = currentHook.next;
    } else {
      // æ²¡æœ‰æŒ‡é’ˆï¼Œå°±ä» hook0 å¼€å§‹
      workInProgressHook = hook = currentlyRenderingFiber.memorizedState;
      currentHook = current.memorizedState;
    }
  } else {
    // currentHook åªæœ‰åœ¨ fiber å˜æ›´æ—¶æ‰èµ·ä½œç”¨ï¼Œä¸ç„¶ä¸€ç›´æ˜¯ null
    currentHook = null;

    // 1.åˆæ¬¡æ¸²æŸ“
    hook = {
      memorizedState: null, // state
      next: null, // ä¸‹ä¸€ä¸ªhook
    };

    if (workInProgressHook) {
      // å¦‚æœå·²ç»æœ‰hookï¼Œå°±æ‰¾é“¾è¡¨ä¸‹ä¸€ä¸ªï¼Œç§»åŠ¨æŒ‡é’ˆ
      workInProgressHook = workInProgressHook.next = hook;
    } else {
      // ä¸ç„¶å°±åˆå§‹åŒ–memorizedState
      workInProgressHook = currentlyRenderingFiber.memorizedState = hook;
    }
  }

  return hook;
}
```

åˆ°è¿™é‡Œï¼Œä¸€ä¸ªç®€å•çš„ Hooks å°±åˆå§‹åŒ–å®Œæˆå•¦ã€‚æ¥ä¸‹æ¥çœ‹çœ‹å…·ä½“çš„ hooks æ€ä¹ˆç”¨å§ã€‚

### â‘  useReducer

useReducer æ˜¯ useState çš„æ›¿ä»£å“ï¼Œä½¿ç”¨çš„æ–¹å¼å¦‚ä¸‹ï¼š

```js
// å£°æ˜
const initialState = 1;
const reducer = (state: number, action: any | { type: string, value: any }) => {
  return state + 1;
};

const [count, dispatch] = useReducer(reducer, initialState);

// è°ƒç”¨
dispatch('add');
```

åˆ†æä¸€ä¸‹ï¼ŒuseReducer ä¹Ÿæ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œæ¥å—ä¸€ä¸ªå¤„ç†å‡½æ•° reducer å’Œä¸€ä¸ªåˆå§‹å€¼ï¼›åŒäº‹è¿”å›ä¸€ä¸ªå½“å‰çš„æœ€æ–°å€¼å’Œè§¦å‘ reducer çš„å‡½æ•° dispatchï¼Œè¿™ä¸ª dispatch å¯ä»¥æ¥å—ä¸€ä¸ª action å‚æ•°ï¼Œaction å¯ä»¥æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ä¹Ÿå¯ä»¥æ˜¯ ä¸€ä¸ªå¯¹è±¡ï¼š`{ type, value }`ã€‚

æˆ‘ä»¬å®šä¹‰è¿™ä¸ªå‡½æ•°ï¼š

```js
export function useReducer(reducer, initalState) {
  // æ‹¿åˆ°å½“å‰çš„ workInProgressHook
  const hook = updateWorkInProgressHook();
  // ç»™åˆå§‹å€¼
  if (!currentlyRenderingFiber.alternate) {
    // å¦‚æœæ²¡æœ‰ç»è¿‡ diff æ ‡è®°èµ‹å€¼ alternateï¼Œè¯´æ˜è¿˜æ²¡æœ‰åˆå§‹åŒ–è¿‡ stateã€‚æ²¡æœ‰å¯¹æ¯”å°±ä¸ä¼šå­˜åœ¨ state æ”¹å˜
    hook.memorizedState = initalState;
  }

  ...
}
```

æ¥ä¸‹æ¥å°±æ˜¯å®ç° å°† reducer è½¬å˜ä¸º dispatch äº†ã€‚

æˆ‘ä»¬å£°æ˜ä¸€ä¸ªè½¬æ¢å‡½æ•°ï¼š

```js
function dispatchReducerAction(fiber, hook, reducer, action) {
  // hook.memorizedState = reducer ? reducer(hook.memorizedState) : action;
  if (reducer) {
    hook.memorizedState = reducer(hook.memorizedState, action);
  } else {
    // useState: setState(1);
    hook.memorizedState = action;
  }

  // æ›´æ–° alternateï¼Œ fiberå·²ç»æ”¹å˜
  fiber.alternate = { ...fiber };
  // å…„å¼ŸèŠ‚ç‚¹ç½®ç©ºï¼Œæ„æ€æ˜¯åªæ›´æ–°å½“å‰å‡½æ•°èŠ‚ç‚¹å³å¯ã€‚è¿™é‡Œä¸ç”¨æ‹…å¿ƒé“¾è¡¨æ–­æ‰ï¼ŒreconcileChildren ä¸­ä¼šé‡æ–°æ„é€ é“¾è¡¨å…³ç³»ã€‚hook æ›´æ–°åªæ˜¯æ®å±€éƒ¨æ›´æ–°
  fiber.sibling = null;
  scheduleUpdateOnFiber(fiber);
}
```

ç”±äº å‚æ•° fiber, hook, reducer æ˜¯æˆ‘ä»¬å†…éƒ¨å¤„ç†çš„ï¼Œåªæœ‰ action æ˜¯å¤–éƒ¨ä¼ çš„ï¼Œæ‰€ä»¥ï¼Œæˆ‘ä»¬åœ¨ useReducer è¿™é‡Œ bind ä¸€ä¸‹ï¼š

```js
// useReducer å‡½æ•°
...

// bind åˆ° null ä¸Šï¼Œæ˜¯ä¸ºäº†è®© currentlyRenderingFiber æ›´æ–°ï¼Œç›´æ¥è°ƒç”¨ dispatchReducerActionï¼Œå…¶æŒ‡é’ˆæŒ‡å‘æ²¡æœ‰å˜åŒ–ï¼Œæœ‰å¤šä¸ªå‡½æ•°å¼ç»„ä»¶æ—¶ï¼Œä¼šäº§ç”Ÿæ¸²æŸ“é”™ä¹±ã€‚
// currentlyRenderingFiber ä½œä¸ºä¸€ä¸ªå½¢å‚å­˜è¿›æ¥ï¼Œå½¢æˆäº†ä¸€ä¸ªé—­åŒ…ã€‚å¦‚æœæœ‰å¤šä¸ªå‡½æ•°å¼ç»„ä»¶éƒ½æœ‰hooksçš„è¯ï¼Œä»–ä»¬çš„currentlyRenderingFiberæ˜¯å„è‡ªçš„fiberï¼Œä¸ä¼šé€ æˆæŒ‡é’ˆæ··ä¹±ã€‚
const dispatch = dispatchReducerAction.bind(
  null,
  currentlyRenderingFiber,
  hook,
  reducer
);

return [hook.memorizedState, dispatch];
```

### â‘¡ useState

useState æ˜¯ useReducer çš„ä¸€ä¸ªç‰¹æ®Šå½¢æ€ï¼Œæ²¡æœ‰ reducerï¼Œæ¯æ¬¡åªè¿”å› action é‡Œçš„å€¼ã€‚

```js
// reducer ä¸º null
export function useState(initialState) {
  return useReducer(null, initialState);
}
```

### â‘¢ useEffect / useLayoutEffect

useEffect åœ¨é¡µé¢æ¸²æŸ“å®Œæˆåè¿›å…¥è°ƒåº¦é˜Ÿåˆ—æ‰§è¡Œï¼Œæ˜¯å¼‚æ­¥çš„ã€‚useLayoutEffect åˆ™æ˜¯åŒæ­¥æ‰§è¡Œå‰¯ä½œç”¨æ“ä½œï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå®ƒä¼šåœ¨æµè§ˆå™¨æ¸²æŸ“ä¹‹å‰è¿è¡Œã€‚

ç”±äº useEffect ä¹Ÿå¯ä»¥æœ‰å¤šä¸ªï¼Œæ‰€ä»¥ï¼Œä»ç„¶æ˜¯æŒ‰ç…§é“¾è¡¨çš„æ–¹å¼å­˜å‚¨çš„ï¼Œè¿™é‡Œä¸ºäº†ä¾¿äºå¤§å®¶ç†è§£ï¼Œæš‚æ—¶ç”¨æ•°ç»„ä»£æ›¿ï¼š

```js
export function renderWithHooks(wip) {
  // old
  currentlyRenderingFiber = wip;
  currentlyRenderingFiber.memorizedState = null;
  workInProgressHook = null;

  // ä¸ºäº†æ–¹ä¾¿ï¼ŒuseEffectä¸useLayoutEffectåŒºåˆ†å¼€ï¼Œå¹¶ä¸”ä»¥æ•°ç»„ç®¡ç†
  // æºç ä¸­æ˜¯æ”¾ä¸€èµ·çš„ï¼Œå¹¶ä¸”æ˜¯ä¸ªé“¾è¡¨
  currentlyRenderingFiber.updateQueueOfEffect = [];
  currentlyRenderingFiber.updateQueueOfLayout = [];
}
```

ç”±äº useEffect å’Œ useLayoutEffect éƒ½æ˜¯åœ¨ç»„ä»¶åŠ è½½çš„æŸä¸ªæ—¶æœºæ‰§è¡Œä¸€æ®µæ–¹æ³•ã€‚æˆ‘ä»¬æŠŠå…¬å…±çš„å®ç°æå–å‡ºæ¥ï¼š

```js
function updateEffectImp(hooksFlags, create, deps) {
  const hook = updateWorkInProgressHook();

  // åˆå§‹åŒ–æ—¶æ²¡æœ‰ currentHookï¼Œå¿…ç„¶ä¼šèµ°åˆ°ä¸‹è¾¹æ‰§è¡Œå‡½æ•°ï¼Œç»„ä»¶çŠ¶æ€å˜æ›´æ—¶ï¼Œä¼šèµ‹å€¼ currentHookï¼Œç”¨äºæ‹¦æˆªæ˜¯å¦è¦æ›´æ–°
  if (currentHook) {
    // ç”¨äºæ ¡éªŒä¸¤æ¬¡ ä¾èµ– æ˜¯å¦æœ‰å˜åŒ–
    const prevEffect = currentHook.memorizedState;
    if (deps) {
      const prevDeps = prevEffect.deps;
      if (areHookInputsEqual(deps, prevDeps)) {
        return;
      }
    }
  }

  const effect = { hooksFlags, create, deps };

  hook.memorizedState = effect;

  // useEffect
  if (hooksFlags & HookPassive) {
    currentlyRenderingFiber.updateQueueOfEffect.push(effect);
    // useLayoutEffect
  } else if (hooksFlags & HookLayout) {
    currentlyRenderingFiber.updateQueueOfLayout.push(effect);
  }
}

// ! HookFlags
export const HookLayout = /*    */ 0b010;
export const HookPassive = /*   */ 0b100;

export function areHookInputsEqual(nextDeps, prevDeps) {
  if (prevDeps == null) {
    return false;
  }

  // è¿™é‡Œåªæ˜¯ç®€å•çš„æŒ‰ä½ç½®ç´¢å¼•å¯¹æ¯”
  for (let i = 0; i < prevDeps.length && i < nextDeps.length; i++) {
    if (Object.is(nextDeps[i], prevDeps[i])) {
      continue;
    }
    return false;
  }

  return true;
}
```

æœ€å¤–å±‚çš„è°ƒç”¨å¯ä»¥è¿™æ ·å†™ï¼š

```js
export function useEffect(create, deps) {
  return updateEffectImp(HookPassive, create, deps);
}

export function useLayoutEffect(create, deps) {
  return updateEffectImp(HookLayout, create, deps);
}
```

ç»è¿‡ä¸Šé¢çš„å‡½æ•°åï¼Œç»„ä»¶å†…æ‰€æœ‰çš„ useEffect å°±éƒ½æ”¶é›†åœ¨æ•°ç»„ä¸­äº†ã€‚æ¥ä¸‹æ¥å°±æ˜¯æ‰¾ä¸ªæ—¶æœºè¿›åº¦è°ƒåº¦ã€‚åˆ†æä¸€ä¸‹ï¼Œä¼ é€’çš„å‡½æ•°éœ€è¦åœ¨ç•Œé¢æ¸²æŸ“å‰åè°ƒç”¨ï¼Œæ‰€ä»¥åº”è¯¥åœ¨ diff ä¹‹åï¼Œæˆ‘ä»¬å°±æŠŠå®ƒåŠ åœ¨ commit å‡½æ•°ä¸­ï¼š

```js
function commitWorker(wip) {
  // ...

  if (wip.tag === FunctionComponent) {
    invokeHooks(wip);
  }

  // 2. æäº¤å­èŠ‚ç‚¹
  commitWorker(wip.child);
  // 3. æäº¤å…„å¼Ÿ
  commitWorker(wip.sibling);
}
```

åœ¨å½“å‰èŠ‚ç‚¹å˜åŒ–æ›´æ–°å®Œä¹‹åï¼Œè¿˜æ²¡æœ‰æ¸²æŸ“å­èŠ‚ç‚¹ä¹‹å‰ï¼Œæ£€æŸ¥ä¸€ä¸‹æ˜¯å¦æœ‰ useEffect å’Œ useLayoutEffectï¼š

```js
// ä¹‹å‰å†™çš„è°ƒåº¦å‡½æ•°
import { scheduleCallback } from './scheduler';

// æ ¸å¿ƒè°ƒç”¨ä»£ç ç¤ºä¾‹
function invokeHooks(wip) {
  const { updateQueueOfEffect, updateQueueOfLayout } = wip;

  // åŒæ­¥ï¼Œé˜»å¡äº† commitWorker
  for (let i = 0; i < updateQueueOfLayout.length; i++) {
    const effect = updateQueueOfLayout[i];
    // æœªå¤„ç†å…¶è¿”å›å€¼
    effect.create();
  }

  // åŠ å…¥è°ƒåº¦ï¼Œä¸€èˆ¬ä¼šåœ¨æ¸²æŸ“ç»“æŸåæ‰§è¡Œ
  for (let i = 0; i < updateQueueOfEffect.length; i++) {
    const effect = updateQueueOfEffect[i];

    scheduleCallback(() => {
      effect.create();
    });
  }
}
```

> æ€è€ƒï¼šè¿˜è®°å¾— Effect çš„å‡½æ•°æœ‰ return ä¹ˆï¼Ÿåœ¨å‰¯ä½œç”¨æ¶ˆå¤±æ—¶è°ƒç”¨ã€‚è¿™é‡Œï¼Œeffect.create() çš„è¿”å›å€¼å°±æ˜¯é‚£ä¸ª return çš„å‡½æ•°ï¼Œæ‰€ä»¥ï¼Œè¿™é‡Œä¹Ÿåº”è¯¥åŠ å…¥è°ƒåº¦é˜Ÿåˆ—ï¼Œåªæ˜¯è¦æ§åˆ¶è°ƒç”¨æ—¶æœºï¼Œ**å› ä¸ºå…¶åªåœ¨ç»„ä»¶è¢« delete æ—¶è°ƒç”¨**ã€‚

### ã€‡ æ¸²æŸ“æµç¨‹å›¾

![å›¾ç‰‡](/img/posts/react/react-hooks-useReducer.jpg)

![å›¾ç‰‡](/img/posts/react/react-hooks-useEffect.png)

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æŠ›å¼€ fiberï¼Œç®€åŒ–ä¸€ä¸‹æºç é€»è¾‘ï¼ŒåŒæ—¶æ¢ä¸€ç§æ€è·¯æ¥çœ‹ hook æœ¬èº«ï¼Œä½¿ç”¨ preact ä¸­çš„å®ç°æ¥è®²è§£ï¼š

### â‘£ useMemo / useCallback

æˆ‘ä»¬æŠŠ react å†…ç½®çš„ hook éƒ½ç¼–ä¸Šå·ï¼Œä¾¿äº devtool è§£æï¼Œæ¯”å¦‚ useState æ˜¯ 1ï¼ŒuseCallback æ˜¯ 8ï¼ŒuseMemo æ˜¯ 7 ç­‰ç­‰ã€‚äºæ˜¯æœ‰äº†ä¸‹è¡¨ï¼š

| hook                | ç¼–å·ï¼ˆcurrentHookï¼‰ |
| ------------------- | ------------------- |
| useState            | 1                   |
| useReducer          | 2                   |
| useEffect           | 3                   |
| useLayoutEffect     | 4                   |
| useRef              | 5                   |
| useImperativeHandle | 6                   |
| useMemo             | 7                   |
| useCallback         | 8                   |
| useContext          | 9                   |
| useErrorBoundary    | 10                  |
| useId               | 11                  |

æˆ‘ä»¬å¯ä»¥é€šè¿‡ getHookState æ–¹æ³•è·å–åˆ°è¿™ä¸ª hook çš„çŠ¶æ€ï¼š

```js
function getHookState(index, type) {
  // é€šè¿‡ type è®°å½• state ç±»å‹ï¼Œä¾¿äº devTool è§£æ
  ...
  // é€šè¿‡ index è·å–å½“å‰ hook
  const hooks =
		currentComponent.__hooks ||
		(currentComponent.__hooks = {
			_list: [],
			_pendingEffects: []
		});

	if (index >= hooks._list.length) {
		hooks._list.push({ _pendingValue: EMPTY });
	}
	return hooks._list[index];
}
```

ç»™å½“å‰çš„ vnodeï¼ˆcurrentComponentï¼‰è®¾ç½®`__hooks`å±æ€§ï¼Œæ¯ä¸€ä¸ª hook å‘¢ï¼Œåˆæœ‰è‡ªå·±çš„`_list`æ¥æ”¾ç½® hook ä»¬çš„çŠ¶æ€ï¼Œä»¥ useMemo ä¸ºä¾‹ï¼š

```ts
export interface MemoHookState {
  _value?: any;
  _pendingValue?: any;
  _args?: any[];
  _pendingArgs?: any[];
  _factory?: () => any;
}
```

åŒæ—¶æ¯ä¸€ä¸ª hook è¿˜æœ‰è‡ªå·±çš„ \_pendingEffectsï¼š

```ts
export interface EffectHookState {
  _value?: Effect;
  _args?: any[];
  _pendingArgs?: any[];
  _cleanup?: Cleanup | void;
}
```

useMemo:

```js
// hookæŒ‰ç…§é€’å¢é¡ºåºï¼Œä¼šç»™ä¸€ä¸ªcurrentIndex
// factoryï¼šç”¨æˆ·ä¼ å…¥çš„ç¼“å­˜å‡½æ•°
// args: ä¾èµ–æ•°ç»„
export function useMemo(factory, args) {
  /** @type {import('./internal').MemoHookState} */
  const state = getHookState(currentIndex++, 7);
  if (argsChanged(state._args, args)) {
    state._pendingValue = factory();
    state._pendingArgs = args;
    state._factory = factory;
    return state._pendingValue;
  }

  return state._value;
}

// æ£€æµ‹ä¾èµ–æ›´æ–°
// è¿”å›trueçš„æƒ…å†µï¼šæ²¡æœ‰old depsã€ä¾èµ–é•¿åº¦å˜åŒ–ã€æ–°ä¾èµ–ä¸­æœ‰ä¸å’ŒåŸä¾èµ–ä¸€æ ·çš„å¯¹è±¡
function argsChanged(oldArgs, newArgs) {
  return (
    !oldArgs ||
    oldArgs.length !== newArgs.length ||
    newArgs.some((arg, index) => arg !== oldArgs[index])
  );
}
```

æ¥ä¸‹æ¥çœ‹ä¸€ä¸‹ useCallback:

```js
// currentHook å°±æ˜¯ç”¨äº devtool è§£æçš„å˜é‡ï¼Œè¿™é‡Œå¿½ç•¥
export function useCallback(callback, args) {
  currentHook = 8;
  return useMemo(() => callback, args);
}
```

### â‘¤ useDebounce

æ¥ä¸‹æ¥æˆ‘ä»¬æ¥å¼•ç”³ä¸€ä¸‹ç¬¬ä¸‰æ–¹ hook åº“`ahooks`ä¸­çš„ä¸€ä¸ªé˜²æŠ– hookã€‚

ä½¿ç”¨ï¼š

```jsx
import React, { useState } from 'react';
import { useDebounce } from 'ahooks';

export default () => {
  const [value, setValue] = useState<string>();
  const debouncedValue = useDebounce(value, { wait: 500 });

  return (
    <div>
      <input
        value={value}
        onChange={(e) => setValue(e.target.value)}
        placeholder="Typed value"
        style={{ width: 280 }}
      />
      <p style={{ marginTop: 16 }}>DebouncedValue: {debouncedValue}</p>
    </div>
  );
};
```

åŸç†ï¼š

```js
// å¤–å±‚å‡½æ•°å…¥å‚ï¼šfunc, wait, optionsï¼ˆmaxWaitç­‰å‚æ•°ï¼‰
// å†…å±‚å‡½æ•°
function debounced(...args) {
  const time = Date.now();
  const isInvoking = shouldInvoke(time);

  lastArgs = args;
  lastThis = this;
  lastInvokeTime = time;

  if (timerId) {
    cancelTimer();
  }

  if (isInvoking) {
    // é‡å¯å®šæ—¶å™¨å‡½æ•° timerExpired
    timerId = startTimer(timerExpired, wait);
    return invokeFunc(lastInvokeTime);
  }

  return result;
}

function invokeFunc(time) {
  const args = lastArgs;
  const thisArg = lastThis;

  lastArgs = lastThis = undefined;
  lastInvokeTime = time;
  result = func.apply(thisArg, args);
  return result;
}
```

å…¶ä¸­ï¼š

```js
function shouldInvoke(time) {
  const timeSinceLastInvoke = time - lastInvokeTime; // è·ç¦»ä¸Šä¸€æ¬¡è°ƒç”¨çš„æ—¶é—´å·®

  return (
    lastInvokeTime === undefined ||
    timeSinceLastInvoke >= wait ||
    timeSinceLastInvoke < 0 ||
    (maxing && timeSinceLastInvoke >= maxWait)
  );
}

// è¿™äº›éƒ½æ˜¯å†…éƒ¨å¯¹è±¡ï¼Œå…¼å®¹äº†jsä¸åŒè¿è¡Œæ—¶ç¯å¢ƒçš„å…¶é‚£å¥å¯¹è±¡
const root =
  freeGlobalThis || freeGlobal || freeSelf || Function('return this')();
const useRAF =
  !wait && wait !== 0 && typeof root.requestAnimationFrame === 'function';

function startTimer(pendingFunc, wait) {
  if (useRAF) {
    root.cancelAnimationFrame(timerId);
    return root.requestAnimationFrame(pendingFunc);
  }
  return setTimeout(pendingFunc, wait);
}
```

## 5. Diff ç®—æ³•é«˜çº§

è¿™é‡Œè®²è§£ä¸€ä¸‹é«˜é˜¶ç‰ˆ diff ç®—æ³•ã€‚

ä¸Šè¾¹çš„ diff ç®—æ³•ï¼ˆreconcileChildrenï¼‰é—®é¢˜ï¼š

- æŒ‰ä½ç½®å¯¹æ¯”ï¼Œé‡å¤ç»„ä»¶æ²¡åŠæ³•å¤ç”¨ï¼Œæ€§èƒ½è¾ƒä½

å› ä¸ºå¤§å¤šæ•°æƒ…å†µï¼Œé¡µé¢çš„å˜åŒ–éƒ½æ˜¯å¾ˆå°çš„ï¼Œå¤§éƒ¨åˆ† dom æ ‘éƒ½æ˜¯ä¸å˜çš„ï¼Œåªæœ‰ä¸ªåˆ«çš„å˜åŒ–ï¼Œä¹‹å‰çš„ç®—æ³•ä¸­ï¼Œå¦‚æœå¯¹åº”ä½ç½®ä¸ŠèŠ‚ç‚¹ä¸ä¸€æ ·å°±ç›´æ¥åˆ æ‰ï¼Œä¸‹è¾¹æœ‰éœ€è¦è¿™ä¸ªèŠ‚ç‚¹äº†ï¼Œåªå¥½å†åˆ›å»ºï¼Œæˆæœ¬é«˜äº†ä¸å°‘ã€‚

ç®—æ³•æ€è·¯ï¼š

- åˆ›å»ºä¸€ä¸ª hash è¡¨å­˜æ”¾ç¼“å­˜èŠ‚ç‚¹
- éœ€è¦åˆ é™¤çš„èŠ‚ç‚¹åˆ æ‰åå­˜åˆ° hash è¡¨ä¸­
- æ¯éœ€è¦æ–°å¢ä¸€ä¸ªä½ç½®çš„èŠ‚ç‚¹æ—¶ï¼Œä» hash è¡¨ä¸­è¯»å–
- ä¸€è½® diff åšå®Œä¹‹åï¼Œæ¸…ç©º hash è¡¨

è€ƒè™‘åˆ° fiber çš„å•é“¾è¡¨ç»“æ„ï¼Œå°±ä¸ä½¿ç”¨ vue çš„åŒæŒ‡é’ˆä»å‰ååŒæ­¥æŸ¥è¯¢ï¼Œè€Œæ˜¯ä»å·¦è¾¹å¾€å³éå†ï¼Œæ¯”è¾ƒæ–°è€èŠ‚ç‚¹ï¼Œå¦‚æœèŠ‚ç‚¹å¯ä»¥å¤ç”¨ï¼Œç»§ç»­å¾€å³ï¼Œå¦åˆ™å°±åœæ­¢ã€‚

### æµç¨‹å›¾

æ¸²æŸ“æ ‘ï¼ˆpfiber å°±æ˜¯ returnFiberï¼‰ï¼š
![å›¾ç‰‡](/img/posts/react/diff-1.png)

ç¬¬ä¸€æ­¥ï¼šä»å·¦å¾€å³éå†ï¼ŒæŸ¥æ‰¾ç›´æ¥èƒ½ç”¨çš„ï¼Œç›´åˆ°é‡åˆ°ä¸èƒ½ç”¨çš„ä¸ºæ­¢ï¼ˆä¸‹å›¾ä¸­çš„æ•°å­—ä»£è¡¨è¯¥ fiber çš„ indexï¼‰ï¼š

![å›¾ç‰‡](/img/posts/react/diff-2.png)

èƒ½å¤ç”¨çš„ï¼š

```js
const same = sameNode(newChild, oldFiber);

if (same) {
  const newFiber = createFiber(newChild, returnFiber);

  Object.assign(newFiber, {
    stateNode: oldFiber.stateNode,
    alternate: oldFiber,
    flags: Update,
  });
}

// newIndex æŒ‡é’ˆåç§»
// lastPlacedIndex æŒ‡å‘æœ€åæ”¾ç½®çš„ä½ç½®
```

åœæ­¢æ¡ä»¶ï¼š`!sameNode(newChild, oldFiber)`

ç¬¬äºŒæ­¥ï¼šå¦‚æ–°èŠ‚ç‚¹æ²¡æœ‰äº†ï¼ˆnewIndex === newChildren.lengthï¼‰ï¼š

![å›¾ç‰‡](/img/posts/react/diff-3.png)

è€èŠ‚ç‚¹å¾€åçš„åŠ å…¥åˆ é™¤é˜Ÿåˆ—ï¼š

```js
// éå†éšåçš„èŠ‚ç‚¹ï¼ŒåŠ å…¥çˆ¶èŠ‚ç‚¹çš„ deletions
returnFiber.deletions.push(...)
```

ç¬¬ä¸‰æ­¥ï¼šå¦‚æœè€èŠ‚ç‚¹æ²¡æœ‰äº†ï¼š

![å›¾ç‰‡](/img/posts/react/diff-4.png)

æ–°çš„èŠ‚ç‚¹ä¾æ¬¡æ„å»ºé“¾è¡¨ï¼š

```js
...
if (previousNewFiber == null) {
  returnFiber.child = newFiber;
} else {
  previousNewFiber.sibling = newFiber;
}
```

ç¬¬å››æ­¥ï¼šå…¶ä»–æƒ…å†µï¼Œä½¿ç”¨ hash è¡¨ç´¢å¼•

```js
// ä¸¾ä¾‹1
// 0 1 [2 3 4 5 6]
// 0 1 [3 4 5 6 7 2]

// ä¸¾ä¾‹2
// [0 1 2 3 4 5 6]
// [2 1 3 4 5]

// æŠŠè€èŠ‚ç‚¹åŠ å…¥Map
const existingChildren = mapRemainingChildren(oldFiber); // new Map()
// éå†æ–°èŠ‚ç‚¹ï¼Œé€šè¿‡æ–°èŠ‚ç‚¹çš„keyå»å“ˆå¸Œè¡¨ä¸­æŸ¥æ‰¾èŠ‚ç‚¹ï¼Œæ‰¾åˆ°å°±å¤ç”¨èŠ‚ç‚¹ï¼Œå¹¶ä¸”åˆ é™¤å“ˆå¸Œè¡¨ä¸­å¯¹åº”çš„èŠ‚ç‚¹
```

![å›¾ç‰‡](/img/posts/react/diff-5.png)

ç¬¬äº”æ­¥ï¼šæ–°èŠ‚ç‚¹éå†å®Œåï¼Œè‹¥ hash è¡¨ä¸­ä»ç„¶æœ‰èŠ‚ç‚¹ï¼Œåˆ™æŠŠè¿™äº›èŠ‚ç‚¹åŠ å…¥ returnFiber.deletions;

### ç¤ºæ„ä»£ç 

```js
// oldfiberçš„å¤´ç»“ç‚¹
let oldFiber = returnFiber.alternate?.child;
// ä¸‹ä¸€ä¸ªoldFiber | æš‚æ—¶ç¼“å­˜ä¸‹ä¸€ä¸ªoldFiber
let nextOldFiber = null;
// ç”¨äºåˆ¤æ–­æ˜¯returnFiberåˆæ¬¡æ¸²æŸ“è¿˜æ˜¯æ›´æ–°
let shouldTrackSideEffects = !!returnFiber.alternate;
let previousNewFiber = null;
let newIndex = 0;
// ä¸Šä¸€æ¬¡domèŠ‚ç‚¹æ’å…¥çš„æœ€è¿œä½ç½®
// old 0 1 2 3 4
// new 2 1 3 4
let lastPlacedIndex = 0;

// *1. ä»å·¦è¾¹å¾€å³éå†ï¼Œæ¯”è¾ƒæ–°è€èŠ‚ç‚¹ï¼Œå¦‚æœèŠ‚ç‚¹å¯ä»¥å¤ç”¨ï¼Œç»§ç»­å¾€å³ï¼Œå¦åˆ™å°±åœæ­¢
for (; oldFiber && newIndex < newChildren.length; newIndex++) {
  const newChild = newChildren[newIndex];
  if (newChild == null) {
    continue;
  }

  if (oldFiber.index > newIndex) {
    nextOldFiber = oldFiber;
    oldFiber = null;
  } else {
    nextOldFiber = oldFiber.sibling;
  }

  const same = sameNode(newChild, oldFiber);
  if (!same) {
    if (oldFiber == null) {
      oldFiber = nextOldFiber;
    }
    break;
  }
  const newFiber = createFiber(newChild, returnFiber);

  Object.assign(newFiber, {
    stateNode: oldFiber.stateNode,
    alternate: oldFiber,
    flags: Update,
  });

  // èŠ‚ç‚¹æ›´æ–°
  lastPlacedIndex = placeChild(
    newFiber,
    lastPlacedIndex,
    newIndex,
    shouldTrackSideEffects,
  );

  if (previousNewFiber == null) {
    returnFiber.child = newFiber;
  } else {
    previousNewFiber.sibling = newFiber;
  }

  previousNewFiber = newFiber;
  oldFiber = nextOldFiber;
}

// *2. æ–°èŠ‚ç‚¹æ²¡äº†ï¼Œè€èŠ‚ç‚¹è¿˜æœ‰
// 0 1 2
// 0
if (newIndex === newChildren.length) {
  deleteRemainingChildren(returnFiber, oldFiber);
  return;
}

// *3. åˆæ¬¡æ¸²æŸ“
// 1ï¼‰åˆæ¬¡æ¸²æŸ“
// 2ï¼‰è€èŠ‚ç‚¹æ²¡äº†ï¼Œæ–°èŠ‚ç‚¹è¿˜æœ‰
if (!oldFiber) {
  for (; newIndex < newChildren.length; newIndex++) {
    const newChild = newChildren[newIndex];
    if (newChild == null) {
      continue;
    }
    const newFiber = createFiber(newChild, returnFiber);

    lastPlacedIndex = placeChild(
      newFiber,
      lastPlacedIndex,
      newIndex,
      shouldTrackSideEffects,
    );

    if (previousNewFiber === null) {
      // head node
      returnFiber.child = newFiber;
    } else {
      previousNewFiber.sibling = newFiber;
    }

    previousNewFiber = newFiber;
  }
}

// *4 æ–°è€èŠ‚ç‚¹éƒ½è¿˜æœ‰
// å°è€Œä¹±
// old 0 1 [2 3 4]
// new 0 1 [3 4]
// !4.1 æŠŠå‰©ä¸‹çš„oldå•é“¾è¡¨æ„å»ºå“ˆå¸Œè¡¨
const existingChildren = mapRemainingChildren(oldFiber);

// !4.2 éå†æ–°èŠ‚ç‚¹ï¼Œé€šè¿‡æ–°èŠ‚ç‚¹çš„keyå»å“ˆå¸Œè¡¨ä¸­æŸ¥æ‰¾èŠ‚ç‚¹ï¼Œæ‰¾åˆ°å°±å¤ç”¨èŠ‚ç‚¹ï¼Œå¹¶ä¸”åˆ é™¤å“ˆå¸Œè¡¨ä¸­å¯¹åº”çš„èŠ‚ç‚¹
for (; newIndex < newChildren.length; newIndex++) {
  const newChild = newChildren[newIndex];
  if (newChild == null) {
    continue;
  }
  const newFiber = createFiber(newChild, returnFiber);

  // oldFiber
  const matchedFiber = existingChildren.get(newFiber.key || newFiber.index);
  if (matchedFiber) {
    // èŠ‚ç‚¹å¤ç”¨
    Object.assign(newFiber, {
      stateNode: matchedFiber.stateNode,
      alternate: matchedFiber,
      flags: Update,
    });

    existingChildren.delete(newFiber.key || newFiber.index);
  }

  lastPlacedIndex = placeChild(
    newFiber,
    lastPlacedIndex,
    newIndex,
    shouldTrackSideEffects,
  );

  if (previousNewFiber == null) {
    returnFiber.child = newFiber;
  } else {
    previousNewFiber.sibling = newFiber;
  }
  previousNewFiber = newFiber;
}

// *5 oldçš„å“ˆå¸Œè¡¨ä¸­è¿˜æœ‰å€¼ï¼Œéå†å“ˆå¸Œè¡¨åˆ é™¤æ‰€æœ‰old
if (shouldTrackSideEffects) {
  existingChildren.forEach((child) => deleteChild(returnFiber, child));
}
```

å…¶ä¸­å·¥å…·å‡½æ•°ï¼š

```js
// åˆæ¬¡æ¸²æŸ“ï¼Œåªæ˜¯è®°å½•ä¸‹æ ‡
// æ›´æ–°ï¼Œæ£€æŸ¥èŠ‚ç‚¹æ˜¯å¦ç§»åŠ¨
function placeChild(
  newFiber,
  lastPlacedIndex,
  newIndex,
  shouldTrackSideEffects,
) {
  newFiber.index = newIndex;
  if (!shouldTrackSideEffects) {
    // çˆ¶èŠ‚ç‚¹åˆæ¬¡æ¸²æŸ“
    return lastPlacedIndex;
  }
  // çˆ¶èŠ‚ç‚¹æ›´æ–°
  // å­èŠ‚ç‚¹æ˜¯åˆæ¬¡æ¸²æŸ“è¿˜æ˜¯æ›´æ–°å‘¢
  const current = newFiber.alternate;
  if (current) {
    const oldIndex = current.index;
    // å­èŠ‚ç‚¹æ˜¯æ›´æ–°
    // lastPlacedIndex è®°å½•äº†ä¸Šæ¬¡domèŠ‚ç‚¹çš„ç›¸å¯¹æ›´æ–°èŠ‚ç‚¹çš„æœ€è¿œä½ç½®
    // old 0 1 2 3 4
    // new 2 1 3 4
    // 2 1(6) 3 4
    if (oldIndex < lastPlacedIndex) {
      // move
      newFiber.flags |= Placement;
      return lastPlacedIndex;
    } else {
      return oldIndex;
    }
  } else {
    // å­èŠ‚ç‚¹æ˜¯åˆæ¬¡æ¸²æŸ“
    newFiber.flags |= Placement;
    return lastPlacedIndex;
  }
}

// hashè¡¨
function mapRemainingChildren(currentFirstChild) {
  const existingChildren = new Map();

  let existingChild = currentFirstChild;
  while (existingChild) {
    // key: value
    // key||index: fiber
    existingChildren.set(
      existingChild.key || existingChild.index,
      existingChild,
    );
    existingChild = existingChild.sibling;
  }

  return existingChildren;
}
```

åœ¨ commitWorker é‡ŒåŠ å…¥ï¼š

```js
if (flags & Placement && stateNode) {
  // 1
  // 0 1 2 3 4
  // 2 1 3 4
  const before = getHostSibling(wip.sibling);
  insertOrAppendPlacementNode(stateNode, before, parentNode);
  // parentNode.appendChild(stateNode);
}

...
function getHostSibling(sibling) {
  while (sibling) {
    if (sibling.stateNode && !(sibling.flags & Placement)) {
      return sibling.stateNode;
    }
    sibling = sibling.sibling;
  }
  return null;
}
function insertOrAppendPlacementNode(stateNode, before, parentNode) {
  if (before) {
    parentNode.insertBefore(stateNode, before);
  } else {
    parentNode.appendChild(stateNode);
  }
}
```

```jsx
/**
 * compact: true
 * inline: true
 */
import React from 'react';
import Giscus from '@giscus/react';
import { usePrefersColor } from 'dumi';

export default function Main() {
  const [color] = usePrefersColor();

  return (
    <section style={{ marginTop: '32px' }}>
      <Giscus
        id="comments"
        reactionsEnabled="1"
        emitMetadata="0"
        inputPosition="bottom"
        loading="lazy"
        src="https://giscus.app/client.js"
        repo="UMCloud-FE"
        repoId="R_kgDOIYRu5Q"
        category="Announcements"
        categoryId="DIC_kwDOIYRu5c4CU1sl"
        mapping="URL"
        strict="0"
        reactionsEnabled="1"
        emitMetadata="1"
        inputPosition="bottom"
        theme={color === 'dark' ? 'dark_tritanopia' : 'light_tritanopia'}
        lang="zh-CN"
        loading="lazy"
        crossorigin="anonymous"
        async={true}
        // theme={giscusTheme}
      />
    </section>
  );
}
```5:T163a,è€ç”Ÿå¸¸è°ˆçš„é—®é¢˜ï¼Œå›¾ç‰‡å¤ªå¤šå¤ªå¤§çš„ç½‘ç«™ï¼Œå¾€å¾€ç”±äºå›¾ç‰‡åŠ è½½è¿‡æ…¢è€Œå¯¼è‡´é¡µé¢ç™½å±æ—¶é—´è¿‡é•¿ã€‚æœ¬æ¬¡å¹´å‰æœ€åä¸€æ›´ï¼Œæ¥è®²ä¸€ä¸ªåŠ è½½æ–¹æ³•æ¥å¤„ç†è¿™ç§æƒ…å†µã€‚

> åœ¨ä½¿ç”¨ Next.js æ—¶ï¼Œå‘ç°å…¶æ”¯æŒæ¨¡ç³Šå›¾ç‰‡å ä½ç¬¦åŠ è½½çš„æ–¹å¼ï¼Œæœ¬æ–‡å°±æ‰‹åŠ¨å®ç°ä¸€ä¸ª


![ä¼ä¸šå¾®ä¿¡æˆªå›¾_0cbf1b0b-91ee-49ff-bb58-a0d390bc61a2.png](/img/posts/2024-2-7/2024-2-7-1.png)

*å›¾ç‰‡è§£é‡Šï¼šNextjs ä½¿ç”¨ placeholder="blur" æ¥æŒ‡å®šå½“å‰å›¾ç‰‡ä½¿ç”¨æ¨¡ç³Šå›¾ç‰‡å ä½ç¬¦åŠ è½½*

## 1. å‰ç½®å·¥ä½œ

é¦–å…ˆä½ å¾—å‡†å¤‡ä¸€å †å›¾ç‰‡ï¼Œéƒ¨ç½²ä¸€ä¸ªæµ‹è¯•çš„ç½‘é¡µã€‚

```html
<body class="p-12 m-auto">
  <div class="container flex justify-center">
    <img loading="lazy" alt="9" class="w-full object-cover rounded-lg"
      src="http://e.hiphotos.baidu.com/image/pic/item/a1ec08fa513d2697e542494057fbb2fb4316d81e.jpg" />
      ...
      ä¸‹é¢æ˜¯å¹¶åˆ—çš„ä¸€å † imgï¼Œæ•°é‡ 100+
  </div>
</body>
```

é¡µé¢é¢„è§ˆï¼š


![image.png](/img/posts/2024-2-7/2024-2-7-2.png)

ä½†æ˜¯ï¼Œå½“ç½‘é€Ÿæ…¢ä¸€ç‚¹ï¼Œæˆ–è€…å›¾ç‰‡å†é«˜æ¸…ä¸€ç‚¹æ—¶ï¼Œå›¾ç‰‡å°±ä¼šå‡ºç°åŠ è½½ç™½å±ï¼ˆä»ä¸Šå¾€ä¸‹çš„æ‰«æçº¿ï¼‰ã€‚

## 2. è®¾ç½®å»¶è¿ŸåŠ è½½

é¦–å…ˆï¼Œæˆ‘ä»¬åˆ©ç”¨ img æ ‡ç­¾çš„èƒ½åŠ›ï¼Œæ·»åŠ æ‡’åŠ è½½å±æ€§ï¼š

```html
<img loading="lazy" src="image.jpg" alt="..." />
```

å…¼å®¹æ€§ï¼š

![image.png](/img/posts/2024-2-7/2024-2-7-3.png)


è¿™ä¸ªç­–ç•¥æœ‰ä¸€ä¸ªåŠ¨æ€çš„åŸåˆ™ï¼š

1. *Lazy loadingåŠ è½½æ•°é‡ä¸å±å¹•é«˜åº¦æœ‰å…³ï¼Œé«˜åº¦è¶Šå°åŠ è½½æ•°é‡è¶Šå°‘ï¼Œä½†å¹¶ä¸æ˜¯çº¿æ€§å…³ç³»ã€‚4G ç½‘ç»œä¸‹çš„è§†å£è·ç¦»é˜ˆå€¼æ˜¯ 1250 åƒç´ ï¼Œ3G ç½‘ç»œä¸‹æ˜¯ 2500 åƒç´ ã€‚*
2. *Lazy loadingåŠ è½½æ•°é‡ä¸ç½‘é€Ÿæœ‰å…³ï¼Œç½‘é€Ÿè¶Šæ…¢ï¼ŒåŠ è½½æ•°é‡è¶Šå¤šï¼Œä½†å¹¶ä¸æ˜¯çº¿æ€§å…³ç³»*ã€‚
3. *æ»šåŠ¨ä¼šè§¦å‘å›¾ç‰‡æ‡’åŠ è½½ï¼Œä¸ä¼šè¯´æ»šåŠ¨ä¸€å±åå†å»åŠ è½½ã€‚*
4. *çª—å£resizeå°ºå¯¸å˜åŒ–ä¹Ÿä¼šè§¦å‘å›¾ç‰‡æ‡’åŠ è½½ã€‚*
5. *æ ¹æ®æ»šåŠ¨ä½ç½®ä¸åŒï¼ŒLazy loadingä¼šå¿½ç•¥å¤´å°¾çš„å›¾ç‰‡è¯·æ±‚ã€‚*

è¿™ä¸ªç­–ç•¥è·Ÿæµè§ˆå™¨ï¼Œç½‘é€Ÿå’Œè¿è¡Œç¯å¢ƒéƒ½æœ‰å…³ç³»ï¼Œæˆ‘å°±ä»¥æˆ‘æœ¬åœ°ä¸ºå‡†è¿›è¡Œæµ‹è¯•ã€‚ä¸ºäº†æ»¡è¶³æµè§ˆå™¨é˜ˆå€¼ï¼Œæˆ‘ä»¬æ”¾ç½®äº† 100+ çš„ç½‘ç»œå›¾ç‰‡ï¼Œè§ä¸Šé¢é¢„è§ˆå›¾ã€‚åœ¨åˆå§‹åŒ–åŠ è½½æ—¶åªåŠ è½½äº†ä¸€éƒ¨åˆ†ï¼Œç­‰å¾€ä¸‹æ»šåŠ¨ä¸€äº›ï¼Œçœ‹æ•ˆæœï¼š

![1.gif](/img/posts/2024-2-7/2024-2-7-4.gif)


> æ³¨æ„å›¾ç‰‡çš„åµŒå¥—å±‚çº§ï¼Œå¦‚æœ html ä¹¦å†™æœ‰è¯¯ï¼Œæˆ–è€…åµŒå¥—å±‚çº§è¿‡å¤šï¼Œæ‡’åŠ è½½å¯èƒ½ä¸ä¼šè¢«è§¦å‘

## 3. é…ç½®æ¨¡ç³Šå›¾ç‰‡

æˆ‘ä»¬å‡†å¤‡å¥½ä½åƒç´ çš„æ¨¡ç³Šå›¾ç‰‡ï¼Œå°†æ¯ä¸€ä¸ª img ç”¨ div åŒ…è£¹èµ·æ¥ï¼Œå¹¶ç»™ div åŠ ä¸Šé‚£ä¸ªæ¨¡ç³Šçš„èƒŒæ™¯å›¾ç‰‡ï¼ˆnext.js ä¹Ÿæ˜¯è¿™ä¹ˆåšçš„ï¼‰ï¼š
 
```html
<div class="blur-load" style="background-image: url(æ¨¡ç³Šå›¾ç‰‡)">
  <img ... loading="lazy" />
</div>
```

å…¶ä¸­æ¨¡ç³Šå›¾ç‰‡çš„æ ·å¼å¯ä»¥è¿™æ ·å®šä¹‰, ä¿è¯èƒŒæ™¯å›¾ç‰‡ä¸ img èƒ½å¤Ÿé‡åˆï¼š

```css
img {
  width: 100%;
  aspect-ratio: 1/1;
  object-fit: cover;
  object-position: center;
}

.blur-load {
  background-size: cover;
  background-position: center;
}
```

> è¿™ä¸ªæ–¹æ³•çš„åŸç†æ˜¯ img å›¾ç‰‡çš„å±‚çº§è¦é«˜äºå…¶æœ¬èº«æˆ–è€…çˆ¶çº§çš„èƒŒæ™¯å›¾ç‰‡ï¼Œå½“å›¾ç‰‡åŠ è½½å‡ºæ¥åè‡ªåŠ¨è¦†ç›–èƒŒæ™¯å›¾ç‰‡

åˆ¶ä½œæ¨¡ç³Šå›¾ç‰‡ï¼Œå¯ä»¥ä½¿ç”¨ [ffmpeg](https://ffmpeg.org/) å·¥å…·ï¼ˆè‡ªè¡Œè¿›å…¥å®˜ç½‘ä¸‹è½½å®‰è£…å³å¯ï¼‰ã€‚

> mac ç”µè„‘ç›´æ¥ä¸‹è½½ Unix å¯æ‰§è¡Œæ–‡ä»¶åˆ°æœ¬åœ°å°±å¯ä»¥ç”¨å®ƒæ‰§è¡ŒæŒ‡ä»¤äº†ï¼›windows ç”µè„‘ç›´æ¥ä¸‹è½½ build çš„ç›®å½•æ–‡ä»¶ï¼Œæ‰¾åˆ° bin ç›®å½•ä¸‹çš„ ffmpeg.exe å°±å¯ä»¥æ‰§è¡Œäº†ã€‚

è¿è¡ŒæŒ‡ä»¤ï¼š

```sh
# æˆ‘åšäº† 20 å€ç¼©æ”¾ï¼Œä½ å¯ä»¥è‡ªå·±å®šä¹‰ç¼©æ”¾æ¯”ä¾‹
ffmpeg -i 1.jpg -vf scale=20:-1 1-sm.png
```

è¿™æ ·ä¾¿ç”Ÿæˆäº†ä¸€ä¸ªå¾ˆå°çš„å›¾ç‰‡ï¼š


![image.png](/img/posts/2024-2-7/2024-2-7-5.png)

è°ƒæ•´ä»£ç ï¼š

```html
<div class="blur-load rounded-lg" style="background-image: url(./1-sm.png)">
<img loading="lazy" alt="9" class="w-full object-cover rounded-lg"
  src="http://e.hiphotos.baidu.com/image/pic/item/a1ec08fa513d2697e542494057fbb2fb4316d81e.jpg">
</div>
```

æˆ‘ä»¬å°†ç½‘é€Ÿè°ƒæ…¢çœ‹çœ‹æ•ˆæœï¼š


![image.png](/img/posts/2024-2-7/2024-2-7-6.png)

ä½†æ˜¯è¿™æ ·è¿˜æœ‰é—®é¢˜ï¼Œå°±æ˜¯å›¾ç‰‡æ˜¯ä»ä¸Šå¾€ä¸‹é€æ¸åŠ è½½çš„ï¼Œéƒ¨åˆ†åŠ è½½ä¹Ÿä¼šæ˜¾ç¤ºçš„é¡µé¢ä¸Šï¼š


![1.gif](/img/posts/2024-2-7/2024-2-7-7.gif)

æˆ‘ä»¬æƒ³è¦çš„æ•ˆæœæ˜¯å›¾ç‰‡å®Œå…¨åŠ è½½åå†è®©å›¾ç‰‡å‡ºæ¥ï¼Œè¿™è¦å€ŸåŠ© jsï¼š

```js
function loaded(div) {
  div.classList.add('loaded');
}

const blurDivs = document.querySelectorAll('.blur-load');
blurDivs.forEach(div => {
  const img = div.querySelector('img');
  
  // åœ¨åŠ è½½å®Œæˆçš„æ—¶å€™æ·»åŠ æ ·å¼
  if (img.complete) { loaded(div) }
  else { img.addEventListener('load', () => loaded(div)) }
})
```

è¿™æ ·ï¼Œåœ¨åŠ è½½å®Œæˆåæ‰ä¼šæœ‰ 'loaded' æ ·å¼åŠ è½½åœ¨å¤–å›´çš„ div ä¸Šã€‚æˆ‘ä»¬åªéœ€è¦ç»™ div æ·»åŠ æ ·å¼ï¼š

```css
.blur-load.loaded > img {
 opacity: 1;
}

/* åŠ è½½å®Œæˆä¹‹å‰ä¿æŒé€æ˜ */
.blur-load > img {
  opacity: 0;
  transition: opacity 200ms ease-in-out;
}
```

è¿™æ ·åœ¨åŠ è½½å®Œæˆåæ‰ä¼šæœ‰æ¨¡ç³Šå›¾ç‰‡è¿‡æ¸¡æ˜¾ç¤ºä¸ºåŸå›¾çš„æ•ˆæœäº†ï¼š


![1.gif](/img/posts/2024-2-7/2024-2-7-8.gif)

## 4. è‡ªå®šä¹‰ loading åŠ¨ç”»

å¦‚æœä½ è‡ªå·±è§‰å¾—è¿˜ä¸æ»¡æ„ï¼Œæƒ³è¦è‡ªå·±åŠ å…¥æƒ³è¦çš„åŠ¨ç”»æ•ˆæœï¼Œé‚£ä¹ˆä½ å¯ä»¥å­åœ¨è¿™ä¸ªdivä¸Šè‡ªå·±å®šä¹‰æ ·å¼ã€‚ä¸‹é¢ç»™å‡ºä¸€ç§è„‰å†²æ•ˆæœçš„å‚è€ƒæ ·ä¾‹ï¼š

```css
.blur-load {
  position: relative;
}
.blur-load::before {
  content: "";
  position: absolute;
  inset: 0;
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0% {
    background-color: rgba(255, 255, 255, 0);
  }
  
  50% {
    background-color: rgba(255, 255, 255, 0.4);
  }
  
  100% {
    background-color: rgba(255, 255, 255, 0);
  }
}

/* åŠ è½½å®Œæˆåå–æ¶ˆ */
.blur-load.loaded::before {
  content: none;
}
```
æ•ˆæœå›¾å¦‚ä¸‹ï¼š


![1.gif](/img/posts/2024-2-7/2024-2-7-9.gif)6:T812,## ä½¿ç”¨ CSS æ¡†æ¶

å¦‚æœä½ ä¸æƒ³è‡ªå·±é…ç½®è¿™äº›ä¹±ä¸ƒå…«ç³Ÿçš„é…ç½®ï¼Œåˆè‹¦äºä¸ä¼šè®¾è®¡ä¸»é¢˜é¢œè‰²ï¼Œé‚£ä¹ˆ [Tailwindcss](https://tailwindcss.com/docs/dark-mode) å°±å¯ä»¥å¸®ä½ å®Œæˆè¿™ä¸ªä»»åŠ¡ã€‚

> ä½¿ç”¨ css æ¡†æ¶ï¼ŒåŸåˆ™ä¸Šä¸ç®—æ˜¯ä¸€ä¸ªæ–°æŠ€æœ¯åˆ†ç±»ï¼Œä»–è¿˜æ˜¯ä¸Šé¢æ‰€è®²çš„æ–¹æ¡ˆä¸­çš„ä¸€ç§æˆ–å‡ ç§ï¼Œæ˜¯å¯¹è¿™äº›æ–¹æ¡ˆçš„ä¼ä¸šçº§å°è£…

æˆ‘ä»¬å€Ÿç”¨å®˜æ–¹çš„å¤œé—´ä¸»é¢˜çš„ä¾‹å­ï¼š

```js
<div class="bg-white dark:bg-slate-800 rounded-lg px-6 py-8 ring-1 ring-slate-900/5 shadow-xl">
  <div>
    <span class="inline-flex items-center justify-center p-2 bg-indigo-500 rounded-md shadow-lg">
      <svg class="h-6 w-6 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true"><!-- ... --></svg>
    </span>
  </div>
  <h3 class="text-slate-900 dark:text-white mt-5 text-base font-medium tracking-tight">Writes Upside-Down</h3>
  <p class="text-slate-500 dark:text-slate-400 mt-2 text-sm">
    The Zero Gravity Pen can be used to write in any orientation, including upside-down. It even works in outer space.
  </p>
</div>
```

ä½¿ç”¨ `dark:` æ¥å£°æ˜åœ¨ä¸»é¢˜ä¸ºå¤œé—´æ—¶çš„æ ·å¼ï¼Œå¯ä»¥é…ç½®ä¸ºè‡ªåŠ¨è¯†åˆ«ç³»ç»Ÿæ ·å¼æˆ–è€…æ˜¯å¯æ§çš„åˆ‡æ¢æ¨¡å¼ï¼Œåˆ‡æ¢ä¸ºå¤œé—´æ¨¡å¼åï¼Œä¼šåœ¨ html æ ¹å…ƒç´ ä¸Šæ·»åŠ ç±» `dark`ï¼š


![image.png](/img/posts/2024-1-25/2024-1-25-9.png)

è¿™æ ·ï¼ŒTailwind å°±èƒ½è¯†åˆ«å¹¶ä¿®æ”¹æ¸²æŸ“æ ·å¼äº†ï¼š

![image.png](/img/posts/2024-1-25/2024-1-25-10.png)

> è¿™ç§åˆ‡æ¢æ–¹å¼ï¼Œæœ¬è´¨ä¸Šè¿˜æ˜¯ç±»ååˆ‡æ¢æ¨¡å¼ï¼Œåªæ˜¯ä½¿ç”¨æ¡†æ¶æ›´åŠ æ–¹ä¾¿å¿«æ·ï¼Œæ”¯æŒçš„ç”Ÿæ€ä¹Ÿæ›´å¥½

> è¯¦ç»†çš„ Tailwindcss çš„ä½¿ç”¨ï¼Œå¯ä»¥è§ [å°è‚šå¸¦æ‚¨ Tailwind CSS å¿«é€Ÿå…¥é—¨](https://juejin.cn/post/7301910992312549376)

ä¼˜åŠ¿ï¼š

- å¤§åŠ¿æ‰€è¶‹ï¼Œå‰æ™¯å¹¿é˜”
- æ˜“äºç®¡ç†å’Œç»´æŠ¤ï¼Œä½¿å¾—å®šåˆ¶ä¸»é¢˜å˜å¾—éšå¿ƒæ‰€æ¬²
- ä»£ç å†—ä½™å°
- æ›´å¥½çš„æ€§èƒ½ä¸å¯æ‰©å±•æ€§

ä¸è¶³ï¼š

- æ¡†æ¶æœ¬èº«å¯èƒ½ä¼šä¸å·²æœ‰é¡¹ç›®æ¶æ„å†²çª
- æ¡†æ¶çº¦æŸäº†å¯å®šåˆ¶çš„çµæ´»æ€§
- å­¦ä¹ æˆæœ¬è¾ƒé«˜
- éœ€è¦æœ‰é¢å¤–çš„ç»´æŠ¤ç‰ˆæœ¬å‡çº§å·¥ä½œ7:T5d7,## CSS-IN-JS

ä½¿ç”¨è¿‡ React çš„æœ‹å‹åº”è¯¥å¬è¯´è¿‡ emotionï¼Œä»–çš„è®¾è®¡ç†å¿µæ˜¯ `All styles in Js`ï¼Œæˆ‘ä¹‹å‰è®²è¿‡çš„ UIç»„ä»¶åº“ å°±ç”¨çš„æ˜¯è¿™ä¸ªï¼š[æ‰‹æŠŠæ‰‹æ­å»ºåŸºäºReactçš„å‰ç«¯UIåº“ ï¼ˆäºŒï¼‰-- ä¸»é¢˜é…ç½®](https://juejin.cn/post/7076652936331280421).

ä»–ä¸ Antd çš„å®ç°ç†å¿µä¸€è‡´ï¼Œä¹Ÿæ˜¯ç»´æŠ¤ä¸€ä¸ª `ThemeProvider` æ¥å®Œæˆå¯é…ç½®çš„ä¸»é¢˜è®¾ç½®ï¼š

```js
import { ThemeProvider as EThemeProvider } from 'emotion-theming';

render() {
    const { theme: _theme, ...rest } = this.props;
    const { theme } = this.state;
    return <EThemeProvider theme={theme} {...rest} />;
}
```

> Antd æ˜¯åˆ‡æ¢åä½¿ç”¨ä¸åŒçš„ css æ–‡ä»¶ï¼Œemotion æ˜¯åˆ‡æ¢åä½¿ç”¨ä¸åŒçš„æ ·å¼ jsï¼Œæœ¬è´¨ä¸Šæ²¡æœ‰åŒºåˆ«

ä¸Šé¢çš„ theme ä¸»é¢˜å¯ä»¥ä½¿ç”¨ä¸€ä¸ª `designTokens.ts` é…ç½®å„ç§å°ºå¯¸ï¼Œé¢œè‰²ç­‰ï¼š


![image.png](/img/posts/2024-1-25/2024-1-25-8.png)

ç„¶åå°†æ–‡ä»¶å¯¼å‡ºåï¼Œå…¨å±€æ¥è®¿é—®ï¼š

```js
mport { useTheme } from 'emotion-theming';

import { defaultTheme } from '../../style';

const useDesignTokens = () => {
  // æ‹¿åˆ°Themeproviderçš„theme
  const theme = useTheme();
  if (!Object.keys(theme).length) return defaultTheme.designTokens;
  return theme.designTokens;
};

export default useDesignTokens;
```

ä¼˜ç‚¹ï¼š

- ä¸ä¼šå­˜åœ¨ css åŠ è½½éƒ¨ç½²çš„é—®é¢˜ï¼Œé€‚åˆå¾®å‰ç«¯è¿™ç§éœ€è¦éš”ç¦»æ ·å¼çš„åœºæ™¯
- ...\[Antd æ–¹æ¡ˆä¼˜ç‚¹]

ç¼ºç‚¹ï¼š

- å­¦ä¹ æ›²çº¿æ¯”è¾ƒé«˜
- å¢åŠ äº†è¿è¡Œæ—¶çš„å¼€é”€å’Œæ‰“åŒ…ä½“ç§¯
- æºç å¯è¯»æ€§å¯èƒ½ä¼šå˜å·®8:T573d,éšç€ Nextjs 13+ çš„æ¨å‡ºï¼Œå®˜æ–¹æ¨å‡ºäº†ä¸€ç§å¾ˆæ–°çš„è·¯ç”±æ¨¡å¼ï¼Œå« [App Router](https://nextjs.org/docs/app) çš„ï¼Œä»Šå¤©æ¥çœ‹çœ‹è¿™ç©æ„æ€ä¹ˆä½¿ç”¨å§ã€‚

ä»–ä¸åŒäºä¹‹å‰çš„ pages è·¯ç”±æœºåˆ¶ï¼Œè€Œæ˜¯ä»¥ app æ–‡ä»¶å¤¹ä¸ºæ ¹ç›®å½•ï¼Œä»¥ page.tsxï¼ˆjsxï¼‰ ä¸ºå…¥å£ï¼Œä»¥ layout.tsx (jsx) ä¸ºå¸ƒå±€ç»„ä»¶ï¼Œå‚æ•°è·å–ä¸ä¸€æ ·äº†ï¼ŒåŒæ—¶ä¹Ÿå¼•å…¥äº†ä¸å°‘æ–°çš„APIã€‚

P.S. æ–°ä¸œè¥¿å±‚å‡ºä¸ç©·ï¼ŒçœŸçš„å­¦ä¸åŠ¨äº†å•Š...

![ä¸æ•¢å­å£°.jpeg](/img/posts/2024-1-19/2024-1-19-1.png)

> Node >= v18.17

> ä»¥åå®˜æ–¹çš„æ›´æ–°æ–¹å‘å…¨åœ¨ next å’Œ turbopack äº†ï¼Œæ‰€ä»¥ä¼ ç»Ÿçš„ create-react-app å’Œ react-router æ¸æ¸è¢«æŠ›å¼ƒï¼Œå¦‚æœå°†æ¥ react-router å®˜æ–¹ä¹Ÿä¸æ›´æ–°äº†ï¼Œä¸çŸ¥é“ vite å°†æ¥è¦æ€ä¹ˆæ”¯æŒ react çš„åˆ›å»ºï¼Ÿ

----

## 0. åˆ›å»ºé¡¹ç›®

æ‰§è¡ŒæŒ‡ä»¤ï¼š

```shell
npx create-next-app nextjs-app-router-test
```

æœ€æ–°çš„ CLI ä¼šæœ‰å¾ˆå¤šæç¤ºé€‰é¡¹ï¼Œæˆ‘ä»¬æ˜¯ App router çš„è®²è§£ï¼Œå…¶ä»–æ— å…³çš„é€‰é¡¹å…³æ‰å³å¯ï¼š

```
âœ” Would you like to use TypeScript? â€¦ [No] / Yes  // ä¼ ç»Ÿ js
âœ” Would you like to use ESLint? â€¦ [No] / Yes
âœ” Would you like to use Tailwind CSS? â€¦ [No] / Yes  // ä¸ä½¿ç”¨ css æ¡†æ¶ï¼Œå°±ä¼šç”Ÿæˆ css module æ–‡ä»¶ï¼Œæ¯”å¦‚ page.module.css
âœ” Would you like to use `src/` directory? â€¦ [No] / Yes // æ‰å¹³åŒ–ç®¡ç†
âœ” Would you like to use App Router? (recommended) â€¦ No / [Yes] // å¼€å¯ App Router
âœ” Would you like to customize the default import alias (@/*)? â€¦ No / [Yes]
âœ” What import alias would you like configured? â€¦ [@]/*
```

ç”Ÿæˆåï¼Œå·¥ç¨‹ç›®å½•ä¸»è¦æ–‡ä»¶å¦‚ä¸‹ï¼š

```shell
./app
â”œâ”€â”€ favicon.ico
â”œâ”€â”€ globals.css
â”œâ”€â”€ layout.js
â”œâ”€â”€ page.js
â””â”€â”€ page.module.css
./public
â”œâ”€â”€ next.svg
â””â”€â”€ vercel.svg
next.config.js 
package.json
```

æˆ‘ä»¬å®‰è£…ä¾èµ–åå¯åŠ¨é¡¹ç›®ï¼š

![image.png](/img/posts/2024-1-19/2024-1-19-2.png)

## 1. è·¯ç”±

### è·¯ç”±ç»“æ„

æˆ‘ä»¬ä¿®æ”¹ä¸€ä¸‹ page.js:

```js
import styles from './page.module.css'

export default function Home() {
  return (
    <main className={styles.main}>
      Home
    </main>
  )
}
```

![image.png](/img/posts/2024-1-19/2024-1-19-3.png)

è€Œ layout.js ç»„ä»¶ï¼š

```js
export default function RootLayout({ children }) {
  return (
    <html lang="en">
      <body className={inter.className}>{children}</body>
    </html>
  )
}
```

å¯ä»¥çœ‹åˆ°ä»–æ˜¯é¡¹ç›®çš„ä¸»ä½“ç»“æ„ï¼Œä»–ä¼ å…¥çš„ children æ˜¯ page.js ä¸­çš„å†…å®¹ã€‚

ä»¥ä¸Šä¾¿æ˜¯ App Router çš„ä¸»ä½“ç»“æ„äº† ï¼ˆapp ç›®å½• + page.js + layout.jsï¼‰ã€‚å¯ä»¥å¯¹æ¯” pages è·¯ç”±ï¼ˆpages ç›®å½• + _app.js + _document.jsï¼‰.

æ­¤å¤–è¿˜æœ‰ä¸€ä¸ª public ç›®å½•ï¼Œå®ƒé‡Œè¾¹çš„æ–‡ä»¶æ˜¯å¯ä»¥è¢«ä½¿ç”¨ `/` ç›´æ¥å¼•ç”¨çš„ã€‚

app æ–‡ä»¶å¤¹ä¸­å¯ä»¥åˆ›å»ºå­æ–‡ä»¶å¤¹ç”¨äºåŒºåˆ†å­è·¯ç”±ï¼Œåœ¨appé¡¶å±‚çš„æ–‡ä»¶å°±è¡¨ç¤ºè·Ÿè·¯ç”±æ–‡ä»¶ã€‚æ¯ä¸ªé¡¹ç›®æ–‡ä»¶å¤¹å•å…ƒå¯ä»¥åŒ…å«çš„æ–‡ä»¶å¦‚ä¸‹ï¼š


|       æ–‡ä»¶å        |          å¯é€‰çš„åç¼€           |           åŠŸèƒ½                   |
| ------------------- | ------------------- | ---------------------------- |
| [`layout`](https://nextjs.org/docs/app/api-reference/file-conventions/layout)                     | `.js` `.jsx` `.tsx` | å¸ƒå±€çš„é¡¶å±‚ç»„ä»¶                       |
| [`page`](https://nextjs.org/docs/app/api-reference/file-conventions/page)                         | `.js` `.jsx` `.tsx` | é¡µé¢ä¸»ä½“                         |
| [`loading`](https://nextjs.org/docs/app/api-reference/file-conventions/loading)                   | `.js` `.jsx` `.tsx` | é¡µé¢åŠ è½½æ—¶çš„ loading                   |
| [`not-found`](https://nextjs.org/docs/app/api-reference/file-conventions/not-found)               | `.js` `.jsx` `.tsx` | é¡µé¢ 404 æ—¶æ˜¾ç¤ºï¼Œä»…åœ¨é¡¶å±‚ç”Ÿæ•ˆ            |
| [`error`](https://nextjs.org/docs/app/api-reference/file-conventions/error)                       | `.js` `.jsx` `.tsx` | é¡µé¢é”™è¯¯æ—¶æ˜¾ç¤ºï¼Œä»…åœ¨é¡¶å±‚ç”Ÿæ•ˆ              |
| [`global-error`](https://nextjs.org/docs/app/api-reference/file-conventions/error#global-errorjs) | `.js` `.jsx` `.tsx` | å…¨å±€é”™è¯¯æ—¶æ˜¾ç¤ºï¼Œä»…åœ¨é¡¶å±‚ç”Ÿæ•ˆ             |
| [`route`](https://nextjs.org/docs/app/api-reference/file-conventions/route)                       | `.js` `.ts`         | API è¯·æ±‚å®šåˆ¶æ–‡ä»¶                 |
| [`template`](https://nextjs.org/docs/app/api-reference/file-conventions/template)                 | `.js` `.jsx` `.tsx` | é‡æ¸²æŸ“æ—¶å®šåˆ¶ layout           |
| [`default`](https://nextjs.org/docs/app/api-reference/file-conventions/default)                   | `.js` `.jsx` `.tsx` | å¹³è¡Œè·¯ç”±å›è½é¡µé¢ï¼ˆå®˜æ–¹æ–‡æ¡£è¿˜åœ¨è¡¥å……ä¸­ã€‚ã€‚ã€‚ï¼‰|

> å¦‚æœæŸä¸€çº§ç›®å½•ä¸‹æ²¡æœ‰ layout å’Œ pageï¼Œåˆ™ä¸ä¼šè¢«è®¤ä¸ºæ˜¯ä¸€ä¸ªæ­£ç¡®çš„è·¯ç”±ç»“æ„

ä» app æ–‡ä»¶å¤¹å¼€å§‹å¾€ä¸‹ï¼Œéµä»ç›®å½•è·¯ç”±ç»“æ„ï¼š


![image.png](/img/posts/2024-1-19/2024-1-19-4.png)

æ¯”å¦‚æˆ‘åœ¨ app ä¸‹æ–°å»º dashboard ç›®å½•ï¼Œåœ¨ä¸‹è¾¹å†™ä¸Šè‡ªå·±çš„ layout.js å’Œ page.js æ–‡ä»¶ä»¬å°±å¯ä»¥è¿™æ ·è®¿é—®ï¼š`http://localhost:3000/dashboard` ï¼ˆ`<Link href="/dashboard">Dashboard</Link>`ï¼‰ã€‚æ­¤æ—¶ç›®å½•ç»“æ„å¯èƒ½æ˜¯è¿™ä¸ªæ ·å­çš„ï¼š


![image.png](/img/posts/2024-1-19/2024-1-19-5.png)

æˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨ template.js æ¥ä½œä¸ºä¸­é—´å±‚ï¼Œå®ƒä»‹äº layout.js å’Œå…¶å­©å­ç»„ä»¶ä¹‹é—´ï¼š

```js
// dashboard/template.js
import React from 'react'

export default function template({ children }) {
  return (
    <div>
      æ¥æ”¶æ¥è‡ª page.js çš„æ•°æ®ï¼š
      {children}
    </div>
  )
}
```

ç„¶åé¡µé¢æ˜¾ç¤ºï¼š

![image.png](/img/posts/2024-1-19/2024-1-19-6.png)

template å¯ç”¨äºé¡µé¢å¸ƒå±€ï¼Œæ‹†åˆ†é¡µé¢åŠŸèƒ½ç­‰ã€‚

### è·¯ç”±ç»„

æœ‰æ—¶å€™æˆ‘ä»¬æƒ³ç”¨ä¸€ä¸ªå¤§çš„æ–‡ä»¶å¤¹ç®¡ç†åˆ†ç»„æ–‡ä»¶ï¼Œä½†æ˜¯åˆä¸æƒ³ nextsjs å°†å…¶è¯†åˆ«ä¸ºè·¯ç”±ï¼Œé‚£ä¹ˆå¯ä»¥å°†æ–‡ä»¶å¤¹ç”¨å°æ‹¬å·åŒ…è£¹ï¼š


![image.png](/img/posts/2024-1-19/2024-1-19-7.png)

æ­¤æ—¶å°±å¯ä»¥è¿™æ ·è®¿é—®äº†ï¼š`http://localhost:3000/about`ã€‚

> éœ€æ³¨æ„ï¼Œæœ‰å¤šä¸ªè·¯ç”±ç»„æ—¶ï¼Œå†…éƒ¨çš„äºŒçº§ç›®å½•ï¼Œæ¯”å¦‚ about ä¸èƒ½é‡åï¼Œä¸ç„¶ä¼šè¯†åˆ«é”™è¯¯ã€‚

å½“ç„¶äº†ï¼Œå„ä¸ªè·¯ç”±ç»„é¡¶å±‚ä¹Ÿå¯ä»¥æœ‰è‡ªå·±çš„ layout.js ï¼Œæˆ–è€…å„ä¸ªäºŒçº§è·¯ç”±ï¼ˆæ¯”å¦‚ about æ–‡ä»¶å¤¹ï¼‰ä¸‹åˆ†åˆ«æ”¾ç½®è‡ªå·±çš„ layout.js ä¹Ÿå¯ä»¥ã€‚

### åŠ¨æ€è·¯ç”±

> ä»…åœ¨æœåŠ¡ç«¯ç»„ä»¶ä½¿ç”¨

å¯ä»¥å°†æ–‡ä»¶å¤¹åç§°ç”¨ä¸­æ‹¬å·æ‹¬èµ·æ¥è¡¨ç¤ºåŠ¨æ€è·¯ç”±ï¼š

```shell
./app/posts
â””â”€â”€ [id]
    â””â”€â”€ page.js
```

å…¶ä¸­ page.js:

```js
export default function Post({ params }) {
  return (
    <div>Post: {params.id}</div>
  )
}
```

æ­¤æ—¶å¯é€šè¿‡è·¯ç”± `http://localhost:3000/posts/1` æ¥è®¿é—®:


![image.png](/img/posts/2024-1-19/2024-1-19-8.png)

å½“ç„¶äº†ï¼Œå‚æ•°ä¸æ˜¯åªèƒ½ä¼ é€’ä¸€çº§å‚æ•°ï¼Œæˆ‘ä»¬å¦‚æœè¿™æ ·å®šä¹‰æ–‡ä»¶å¤¹ï¼š`[...ids]`ï¼š

```shell
./app/posts
â””â”€â”€ [...ids]
    â””â”€â”€ page.js
```

æ­¤æ—¶è®¿é—®ï¼š`http://localhost:3000/posts/12/56`ï¼Œæ­¤æ—¶åœ¨æœåŠ¡ç«¯å¯æ‰“å°æ‹¿åˆ°çš„å‚æ•°ï¼š

```js
{ params: { ids: [ '12', '56' ] }, searchParams: {} }
```

ä¸Šé¢çš„å†™æ³•è¿˜æœ‰ä¸€ç§å˜ä½“ï¼š`[[...ids]]`ï¼Œä½¿ç”¨åŒæ‹¬å·å’Œå•æ‹¬å·çš„åŠŸèƒ½æ˜¯ä¸€æ ·çš„ï¼Œè¯†åˆ«çš„åŸºæœ¬æ²¡æœ‰å·®åˆ«ï¼Œå”¯ä¸€çš„ä¸åŒæ˜¯ï¼Œä½¿ç”¨åŒæ‹¬å·å¯ä»¥è¯†åˆ«ä¸å¸¦å‚æ•°çš„è·¯å¾„ï¼š`http://localhost:3000/posts`ï¼Œè€Œå•æ‹¬å·çš„é…ç½®å°± 404 äº†ã€‚

### å¹³è¡Œè·¯ç”±

å¹³è¡Œè·¯ç”±çš„æ–‡ä»¶å¤¹ä»¥ `@` å¼€å¤´ï¼Œå…¶é»˜è®¤ä¹Ÿä¸ä¼šç”Ÿæˆåœ¨è·¯ç”±ä¸­ï¼Œä¸èƒ½ç›´æ¥è®¿é—®ã€‚


æ¯”å¦‚æˆ‘ä»¬æœ‰ä¸¤ä¸ªæ–‡ä»¶å¤¹ï¼š`@dashboard` å’Œ `@login` ï¼Œä¸€ä¸ªè¡¨ç¤ºç™»å½•åçš„æ¬¢è¿ç•Œé¢ï¼Œä¸€ä¸ªè¡¨ç¤ºæ²¡æœ‰æƒé™æ—¶çš„ç™»å½•é¡µé¢ï¼š


![image.png](/img/posts/2024-1-19/2024-1-19-9.png)


æˆ‘ä»¬é‡å†™ä¸€ä¸‹ `app/layout.js`:

```js
import { getUser } from '@/lib/auth'
 
export default function Layout({ dashboard, login }) {
  const isLoggedIn = getUser()
  return isLoggedIn ? dashboard : login
}
```

getUser æ˜¯è·å–å½“å‰ç”¨æˆ·çš„ï¼Œè¿™é‡Œå¿½ç•¥å…¶å®ç°ã€‚è¿™æ ·ï¼Œåœ¨æ ¹è·¯ç”±ä¸‹ï¼Œå°±å¯ä»¥é€šè¿‡æ¡ä»¶è¯­å¥åŠ¨æ€æŒ‚è½½å’Œåˆ é™¤è·¯ç”±ç»„ä»¶ï¼Œå½“ç„¶äº†ï¼Œä»–ä»¬ä¹Ÿå¯ä»¥åŒæ—¶è¢«æ¸²æŸ“åœ¨åŒä¸€ä¸ªé¡µé¢ä¸Šã€‚

### è·¯ç”±æ‹¦æˆª

è·¯ç”±æ‹¦æˆªä¸€èˆ¬é’ˆå¯¹å¼¹å‡ºå±‚ï¼Œåœ¨ nextjs ä¸­ï¼Œå¼¹å‡ºå±‚ modal ä¹Ÿæœ‰è‡ªå·±çš„è·¯ç”±ï¼Œåœ¨å¼¹å‡ºå±‚è·¯ç”±ä¸‹åŸåœ°åˆ·æ–°é¡µé¢ï¼Œä¸åº”è¯¥å†å‡ºç°æ¨¡æ€æ¡†ï¼Œè€Œæ˜¯ç›´æ¥å±•ç¤ºåŸæ¥å¼¹çª—é‡Œè¾¹çš„è¯¦æƒ…ï¼Œè¿™æ ·çš„ä¸€ä¸ªurlå±•ç¤ºä¸¤ç§å½¢æ€çš„è·¯ç”±ï¼Œå«åšæ‹¦æˆªè·¯ç”±ã€‚

è·¯ç”±æ‹¦æˆªï¼Œæ˜¯åœ¨è·¯ç”±ç›®å½•å‘½åå‰é¢åŠ ä¸Šå°æ‹¬å·è¡¨ç¤ºï¼š

-   `(.)`åŒ¹é…**åŒä¸€çº§åˆ«çš„æ®µ**
-   `(..)`åŒ¹é…**ä¸Šä¸€çº§çš„æ®µ**
-   `(..)(..)`åŒ¹é…**ä¸Šé¢ä¸¤çº§çš„æ®µ**
-   `(...)`åŒ¹é…**æ ¹** `app`ç›®å½•ä¸­çš„æ®µ

æˆ‘ä»¬ä¸¾ä¾‹æ¥è¯´æ˜ã€‚


![image.png](/img/posts/2024-1-19/2024-1-19-10.png)

ä¸Šé¢çš„å›¾ç‰‡ä¸­ï¼Œphotoç›®å½•ä¸‹æ”¾ç½®çš„æ˜¯è·¯ç”± `photo/id` è¦å±•ç¤ºçš„å›¾ç‰‡è¯¦æƒ…å†…å®¹ï¼Œ`@modal` ç›®å½•ç”¨äºå°† photo ç›®å½•æ‹¦æˆªå¹¶åŒ…è£¹åœ¨ä¸€ä¸ªæ¨¡æ€æ¡†ä¸­ã€‚è¿™é‡Œ `(..)`ä¼šä» `@modal` ä¸Šä¸€çº§ç›®å½•å¯¼å…¥åŒçº§ç›®å½•ä¸­å»æ‰¾ `photo` ç›®å½•æ¥åŒ¹é…ã€‚

æ­¤æ—¶ï¼Œå½“é€šè¿‡ ```<Link key={id} href={`/photos/${id}`}>``` æ¥è®¿é—®ç›®å½•æ—¶ï¼Œå°±ä¼šå‡ºç°ä¸»é¡µé¢ä¸Šå¼¹å‡ºçš„æ¨¡æ€æ¡†ã€‚

åœ¨åˆ—è¡¨é¡µç‚¹å‡» link è®¿é—®ï¼š


![image.png](/img/posts/2024-1-19/2024-1-19-11.png)

ç›´æ¥é€šè¿‡ url è®¿é—®ï¼š


![image.png](/img/posts/2024-1-19/2024-1-19-12.png)

demo åœ°å€ï¼š[è·¯ç”±æ‹¦æˆª](https://github.com/vercel-labs/nextgram/tree/main)

### è·¯ç”±å¤„ç†ç¨‹åº ï¼ˆAPIè·¯ç”±ï¼‰

æ¯ä¸€å¥—è·¯ç”±ï¼ŒåŒ…æ‹¬æ ¹è·¯ç”±ï¼Œéƒ½æ˜¯å¯ä»¥é…æœ‰ä¸€ä¸ª `route.js` (ts) æ–‡ä»¶ç”¨äºè‡ªå®šä¹‰å¤„ç†æ•°æ®å’Œè·¯ç”±è¿”å›å†…å®¹çš„ã€‚æˆ‘ä»¬çœ‹ä¸€ä¸‹å¦‚ä¸‹çš„è·¯ç”±ç›®å½•ï¼š

```shell
./posts
â””â”€â”€ [...ids]
    â”œâ”€â”€ page.js
    â””â”€â”€ route.js
```

åœ¨ route.js ä¸­æˆ‘ä»¬å†™å…¥ï¼š

```js
export async function GET(
  request,
  params
) {
  const ids = params.params.ids;
  console.log(ids)

  return new Response('Hello, Next.js!', {
    status: 200,
    headers: { 'Set-Cookie': `token=${ids}` },
  })
}
```

å¯ä»¥çœ‹åˆ°ï¼Œä»–æ¥å—äº†è·¯ç”±å‚æ•° idsï¼Œå¹¶ä¸”æ ¹æ®è‡ªå®šä¹‰çš„é€»è¾‘è¿”å›äº†é¡µé¢å“åº”ã€‚é¡µé¢è®¿é—® `http://localhost:3000/posts/111/122` æŸ¥çœ‹æ•ˆæœï¼š


![image.png](/img/posts/2024-1-19/2024-1-19-13.png)

è‡ªå®šä¹‰çš„ cookie è®¾ç½®è¿›å»äº†ã€‚

### è·¯ç”±ä¸­é—´ä»¶

åœ¨é¡¹ç›®ç›®å½•ä¸­æ”¾ç½®æ–‡ä»¶ `middleware.ts`ï¼ˆæˆ– .jsï¼‰æ¥å®šä¹‰ä¸­é—´ä»¶ã€‚æ”¾ç½®ç›®å½•ä¸`pages`æˆ–`app`åŒçº§ï¼Œæˆ–åœ¨å†…éƒ¨`src` é¡¶å±‚ï¼ˆå¦‚æœæœ‰ srcï¼‰ï¼Œnextjs ä¼šè‡ªåŠ¨è¯†åˆ«ä¸­é—´ä»¶æ–‡ä»¶ï¼Œå¹¶åœ¨å†…å®¹ç¼“å­˜å’Œè·¯ç”±åˆ‡æ¢ä¹‹å‰æ‰§è¡Œè¯¥æ–‡ä»¶ã€‚

ä¸¾ä¸€ä¸ªæˆ‘åœ¨é¡¹ç›®ä¸­é…ç½® i18n çš„ä¾‹å­ï¼š

```js
// src/middleware.js
export function middleware(req) {
  let lng
  if (req.cookies.has(cookieName)) {
    lng = acceptLanguage.get(req.cookies.get(cookieName).value)
    console.log('Cookie language:', lng)
  }
  if (!lng) {
    lng = acceptLanguage.get(req.headers.get('Accept-Language'))
    console.log('Accept-Language:', lng)
  }
  if (!lng || !languages.includes(lng)) lng = fallbackLng

  // Redirect if lng in path is not supported
  if (
    !languages.some(loc => req.nextUrl.pathname.startsWith(`/${loc}`)) &&
    !req.nextUrl.pathname.startsWith('/_next')
  ) {
    return NextResponse.redirect(new URL(`/${lng}${req.nextUrl.pathname}`, req.url))
  }

  return NextResponse.next()
}
```

ä¸Šé¢çš„ä»£ç ï¼Œæ‹¦æˆªè¯·æ±‚ reqï¼Œåˆ¤æ–­è¯·æ±‚çš„ cookie é‡Œæœ‰æ²¡æœ‰è¯­è¨€çš„é…ç½®ï¼Œå¦‚æœæ²¡æœ‰å°±ä½¿ç”¨ Accept-Language è·å–æµè§ˆå™¨æ¨èçš„è¯­è¨€ï¼Œå¦‚æœè¿˜æ²¡æœ‰å°±ä½¿ç”¨å›è½å…œåº•æ–¹æ¡ˆï¼›æœ€åä½¿ç”¨ `NextResponse.redirect` é‡å®šå‘åˆ°å¯¹åº”çš„è¯­è¨€è·¯å¾„ã€‚

## 2. æ•°æ®è·å–æ–¹å¼

Next.js ä¹Ÿå¯ä»¥è¯·æ±‚ç¬¬ä¸‰æ–¹çš„æœåŠ¡æ¥è·å–æ•°æ®ã€‚

### æœåŠ¡ç«¯

æœåŠ¡ç«¯ç»„ä»¶ä¸­ï¼Œå®˜æ–¹æ¨èä½¿ç”¨ fetchï¼š

```js
// page.js
async function getData() {
  const res = await fetch('https://api.example.com/...')
  // The return value is *not* serialized
  // You can return Date, Map, Set, etc.
 
  if (!res.ok) {
    // This will activate the closest `error.js` Error Boundary
    throw new Error('Failed to fetch data')
  }
 
  return res.json()
}
 
export default async function Page() {
  const data = await getData()
  console.log(data)
  return <main></main>
}
```
æ­¤å¤–ï¼Œfetch å¯ä»¥ä½¿ç”¨ `{ cache: 'force-cache' }` æ¥ç¼“å­˜æ•°æ®ã€‚

### å®¢æˆ·ç«¯

è¦å£°æ˜ä¸€ä¸ªç»„ä»¶æ˜¯å®¢æˆ·ç«¯ç»„ä»¶ï¼Œéœ€è¦è¿™æ ·å†™:

```js
'use client'
 
export default function ClientComponent({ updateItem }) {
  return <form action={updateItem}>{/* ... */}</form>
}
```

å®¢æˆ·ç«¯ç»„ä»¶å°±è·Ÿå¹³å¸¸çš„ react å¼€å‘ä¸€æ ·ï¼Œå¯ä»¥ä½¿ç”¨ React çš„å„ç§çŠ¶æ€ Hook å’Œ ç¬¬ä¸‰æ–¹å·¥å…·ï¼ˆæ¯”å¦‚ axiosï¼‰æ¥å¤„ç†æ•°æ®ã€‚

å®¢æˆ·ç«¯æˆ‘ä»¬è¿˜å¯ä»¥è¯·æ±‚å‰é¢çš„ API è·¯ç”±æ¥è·å–æ•°æ®ï¼ŒAPI è·¯ç”±ä¸­å¯ä»¥æ˜¯æœåŠ¡ç«¯è°ƒç”¨ç¬¬ä¸‰æ–¹æ¥å£è¯·æ±‚çš„æ•°æ®ã€‚

## 3. æœåŠ¡ç«¯æ¸²æŸ“ä¸å®¢æˆ·ç«¯æ¸²æŸ“

### æœåŠ¡ç«¯ç­–ç•¥

- é»˜è®¤ä¸ºé™æ€æ¸²æŸ“

è·¯ç”±å’ŒæœåŠ¡ç«¯æ•°æ®åœ¨ build æ—¶åŒæ­¥è·å–ï¼Œç»“æœä¼šå­˜åœ¨æœåŠ¡ç«¯ï¼Œæ”¯æŒç¼“å­˜ CDN ä¸­ï¼Œæ­¤æ—¶å°±æ˜¯æ ‡å‡†çš„åç«¯ç›´å‡ºçš„é™æ€é¡µé¢ã€‚

- åŠ¨æ€æ¸²æŸ“

è·¯ç”±åœ¨æ¯æ¬¡è®¿é—®æ—¶åŠ¨æ€è·å–é¡µé¢æ•°æ®ï¼Œé€‚ç”¨äºä¸€äº›éœ€è¦å±•ç¤ºå®æ—¶æ•°æ®çš„åœºæ™¯ï¼ˆæ¯”å¦‚ cookiesã€url paramsç­‰ï¼‰ã€‚

å¦‚æœé¡µé¢ä¸­æœ‰åŠ¨æ€å‡½æ•°æˆ–è€…æœªè¢«ç¼“å­˜çš„æ•°æ®ï¼Œåˆ™è‡ªåŠ¨è½¬æ¢ä¸ºåŠ¨æ€é¡µé¢æ¸²æŸ“ï¼š

Dynamic Functions | Data       | Route                |
| ----------------- | ---------- | -------------------- |
| No                | Cached     | Statically Rendered  |
| Yes               | Cached     | Dynamically Rendered |
| No                | Not Cached | Dynamically Rendered |
| Yes               | Not Cached | Dynamically Rendered|

å…³äºåŠ¨æ€å‡½æ•°ï¼ŒæŒ‡çš„æ˜¯åªæœ‰åœ¨è¯·æ±‚åæ‰çŸ¥é“è¿”å›ç»“æœçš„å‡½æ•°ï¼ŒåŠ¨æ€å‡½æ•°å¿…é¡»æ˜¯å†…ç½®çš„ï¼Œå› ä¸º fetch ä¼šè¢«ç¼“å­˜ï¼š

```js
import { cookies } from 'next/headers'
import { headers } from 'next/headers'
```

- æµå¼åŠ è½½

æ¸è¿›å¼çš„ UI æ¸²æŸ“ç­–ç•¥ï¼Œå¯ä»¥é€šè¿‡ loading.js æ–‡ä»¶ï¼Œæˆ–è€…ä½¿ç”¨ `React.Suspense` æ¥å¼€å¯ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œæµå¼åŠ è½½å†…ç½®äº Next.js App Router ä¸­ï¼ŒåŠ©äºæé«˜åˆå§‹é¡µé¢åŠ è½½æ€§èƒ½ï¼Œæ¯”å¦‚åŠ è½½å“ªäº› ä¾èµ–äºè¾ƒæ…¢æ•°æ®è·å–ï¼ˆä¼šé˜»æ­¢æ¸²æŸ“æ•´ä¸ªè·¯ç”±ï¼‰çš„ UIï¼ˆäº§å“é¡µé¢ä¸Šçš„è¯„è®ºç­‰ï¼‰:

```js
// page.js
import { Suspense } from 'react'
import { PostFeed, Weather } from './Components'
 
export default function Posts() {
  return (
    <section>
      <Suspense fallback={<p>Loading feed...</p>}>
        <PostFeed />
      </Suspense>
      <Suspense fallback={<p>Loading weather...</p>}>
        <Weather />
      </Suspense>
    </section>
  )
}
```

### å®¢æˆ·ç«¯ç­–ç•¥

å®¢æˆ·ç«¯ç»„ä»¶åœ¨ build æ—¶ä¸å‚ä¸è·å–æ•°æ®å’Œé¢„æ¸²æŸ“ï¼Œä»–åœ¨å®¢æˆ·æµè§ˆå™¨è¿è¡Œæ—¶æ‰å¼€å§‹æ‰§è¡Œå¹¶æ¸²æŸ“æ•°æ®ã€‚å®¢æˆ·ç«¯ç»„ä»¶å¯ä»¥ä½¿ç”¨çŠ¶æ€ã€æ•ˆæœå’Œäº‹ä»¶ä¾¦å¬å™¨ï¼Œå¾€å¾€ç”¨äºäº¤äº’ç›¸å¯¹å¤æ‚çš„åœºæ™¯ã€‚

åœ¨éœ€è¦å®¢æˆ·ç«¯æ¸²æŸ“çš„ä»£ç ç‰‡æ®µé¡¶å±‚å†™ä¸Šï¼š`"use client"` ä¾¿å¯ä»¥å£°æ˜å®¢æˆ·ç«¯ç»„ä»¶ï¼š

```js
'use client'
 
import { useState } from 'react'
 
export default function Counter() {
  const [count, setCount] = useState(0)
 
  return (
    <div>
      <p>You clicked {count} times</p>
      <button onClick={() => setCount(count + 1)}>Click me</button>
    </div>
  )
}
```

Next.js æ¸²æŸ“çš„ç­–ç•¥æ˜¯ï¼šåœ¨ç”¨æˆ·å®¢æˆ·ç«¯æ‹‰å–æœåŠ¡ç«¯ç»„ä»¶ä»£ç å’Œå®¢æˆ·ç«¯ç»„ä»¶ä»£ç ï¼Œå…ˆæ¸²æŸ“å‡ºæ— äº¤äº’çš„é¡µé¢ä¿¡æ¯ï¼Œå®Œæˆåˆå§‹é¡µé¢åŠ è½½ï¼Œä¹‹åä½¿ç”¨å®¢æˆ·ç«¯æ°´åˆæŠ€æœ¯ï¼Œæ›´æ–° DOM æ ‘ï¼Œæ¤å…¥äº¤äº’ä¿¡æ¯å’Œäº‹ä»¶ç›‘å¬ã€‚


## 4. å…³äºç¼“å­˜

### è¯·æ±‚ç¼“å­˜

ä¸ºäº†ä¸ç”¨æ¯æ¬¡éƒ½è°ƒç”¨æ¥å£è·å–é‡å¤çš„æ•°æ®ï¼ŒNext.js æ‰©å±•äº† fetch API å»è‡ªåŠ¨ç¼“å­˜è¯·æ±‚æ•°æ®ï¼Œç¼“å­˜å‘½ä¸­ç­–ç•¥æ˜¯ï¼š`ç›¸åŒçš„ urlã€åè®®å’Œè¯·æ±‚ä½“`ã€‚


![image.png](/img/posts/2024-1-19/2024-1-19-14.png)

åœ¨éœ€è¦æ•°æ®çš„åœ°æ–¹ï¼Œå¯ä»¥æ”¾å¿ƒçš„ç›´æ¥ä½¿ç”¨ fetch å³å¯ï¼ŒNext.js ä¼šè¿›è¡Œå…œåº•çš„ã€‚ç¼“å­˜ç­–ç•¥å·¥ä½œæµç¨‹å¦‚ä¸‹ï¼š

1. åœ¨ä¸€ä¸ª route åŠ è½½æ—¶ï¼Œç¬¬ä¸€æ¬¡è¯·æ±‚ï¼Œä¸è¿›è¡Œç¼“å­˜
2. ç¬¬äºŒæ¬¡è¯·æ±‚ï¼Œå¦‚æœæ»¡è¶³æˆ‘ä»¬ä¸Šé¢è¯´çš„æ¡ä»¶ï¼Œåˆ™å‘½ä¸­ç¼“å­˜ï¼Œè¿™æ¬¡è¯·æ±‚è¿”å›æ•°æ®å°±ä»ç¼“å­˜ä¸­å–
3. ä¸€æ—¦ route é‡æ¸²æŸ“äº†ï¼Œç¼“å­˜åˆ™ä¼šæ¸…é™¤ï¼Œé‚£ä¹ˆè°ƒç”¨å°±ä¼šå‘èµ· API è¯·æ±‚äº†ã€‚

å¦‚æœä¸æƒ³ç¼“å­˜è¿™ä¸ªè¯·æ±‚ï¼Œå¯ä»¥è¿™æ ·å†™ï¼š

```js
const { signal } = new AbortController()
fetch(url, { signal })
```

### æ•°æ®çš„ç¼“å­˜

**æ•°æ®ç¼“å­˜å’Œè¯·æ±‚è®°å¿†ä¹‹é—´çš„å·®å¼‚**

å®˜æ–¹è§£é‡Šï¼š

æ•°æ®ç¼“å­˜åœ¨ä¼ å…¥è¯·æ±‚å’Œéƒ¨ç½²ä¸­æ˜¯æŒä¹…çš„ï¼Œè€Œè¯·æ±‚ç¼“å­˜çš„ç”Ÿå‘½å‘¨æœŸä»…æŒç»­åœ¨è¯·æ±‚è¿‡ç¨‹ä¸­ã€‚

é€šè¿‡è¯·æ±‚ç¼“å­˜ï¼Œå¯ä»¥é¿å…é‡å¤è¯·æ±‚ç¼“å­˜æœåŠ¡å™¨ã€CDNç­‰çš„æ•°é‡ã€‚è€Œé€šè¿‡æ•°æ®ç¼“å­˜ï¼Œæˆ‘ä»¬å‡å°‘äº†å¯¹åŸå§‹æ•°æ®æºå‘å‡ºçš„è¯·æ±‚æ•°é‡ã€‚

åƒµå°¸æ ½èŠ±ï¼Œå…·ä½“çš„åŒºåˆ«æˆ‘ä¹Ÿç†è§£ä¸æ·±ï¼Œä¸ºå•¥è¦åšä¸¤å±‚~~ ğŸ˜“

æˆ‘ä»¬çœ‹å›¾ï¼š


![image.png](/img/posts/2024-1-19/2024-1-19-15.png)

è¯·æ±‚ç¼“å­˜æ˜¯åœ¨æ•°æ®ç¼“å­˜å‰è¾¹çš„ï¼Œè¯·æ±‚ç¼“å­˜æ²¡æœ‰å‘½ä¸­ï¼Œæ‰ä¼šå»æ‰¾æ•°æ®ç¼“å­˜ï¼Œè¿˜æ²¡æœ‰å‘½ä¸­æ‰ä¼šå»è¯·æ±‚åŸå§‹æ•°æ®æºã€‚

æˆ‘ä»¬å¯ä»¥è¿™æ ·è¯·æ±‚ï¼š

```js
fetch('https://...', { next: { revalidate: 3600 } })
```

è¡¨ç¤º 3600 ç§’ä¹‹å†…ï¼Œæ•°æ®æ˜¯ç¼“å­˜æœ‰æ•ˆçš„ã€‚3600 ç§’ä¹‹åä¼šè‡ªåŠ¨é‡æ–°éªŒè¯ï¼Œè‹¥æ²¡æœ‰å˜åŒ–åˆ™è¿˜æ˜¯ç”¨ç¼“å­˜ã€‚

æˆ‘ä»¬è¿˜å¯ä»¥ç¦ç”¨ç¼“å­˜:

```js
fetch(`https://...`, { cache: 'no-store' })
```

### å°ç»“

æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å…¨è·¯ç”±ç¼“å­˜çš„æµç¨‹å›¾ï¼š


![image.png](/img/posts/2024-1-19/2024-1-19-16.png)

1. è¿è¡Œæ—¶ï¼Œå®¢æˆ·ç«¯çš„è·¯ç”±ç¼“å­˜ï¼Œæ¯”å¦‚ Suspense.
2. ç¼–è¯‘æ—¶ï¼Œè·¯ç”±å·²ç»ç¡®å®šï¼Œè¯·æ±‚çš„è·¯ç”±å¦‚æœå‘½ä¸­ç¼“å­˜ï¼Œåˆ™ç›´æ¥è¿”å›ã€‚
3. ç¼–è¯‘æ—¶ï¼ŒAPI è¯·æ±‚å·²ç»ç¡®å®šï¼Œè¯·æ±‚çš„ API å¦‚æœå‘½ä¸­ç¼“å­˜ï¼Œåˆ™ç›´æ¥è¿”å›ç»“æœï¼Œä¸å¿…å†æ¬¡å‘èµ·å¯¹æ•°æ®ç¼“å­˜çš„è¯·æ±‚ã€‚
4. ç¼–è¯‘æ—¶ï¼ŒéåŠ¨æ€ API è¿”å›çš„ç»“æœå·²ç»ç¡®å®šï¼Œå¦‚æœè¯·æ±‚ç›¸åŒçš„æ•°æ®ï¼Œä¸”ç¼“å­˜ä¸è¿‡æœŸï¼Œåˆ™ä½¿ç”¨ç¼“å­˜ç»“æœï¼Œä¸å‘å…ƒæ•°æ®è¯·æ±‚ã€‚

## 5. å…³äºæ ·å¼ 

å¯ä»¥ä½¿ç”¨ css æ¨¡å—ï¼š

```js
import styles from './styles.module.css'
 
export default function DashboardLayout({
  children,
}: {
  children: React.ReactNode
}) {
  return <section className={styles.dashboard}>{children}</section>
}
```

ä¹Ÿå¯ä»¥ä½¿ç”¨ CSS-in-JSï¼Œæ¯”å¦‚ emotion ç­‰ï¼Œå½“ç„¶ä¸€äº›é¢„å¤„ç†å™¨ï¼Œæ¯”å¦‚ sassã€less ä¹Ÿå¯ä»¥ä½¿ç”¨ï¼Œä¸è¿‡è¦åœ¨é…ç½®é‡Œå¢åŠ é…ç½®é¡¹ï¼š

```js
const path = require('path')
 
module.exports = {
  sassOptions: {
    includePaths: [path.join(__dirname, 'styles')],
  },
}
```

å½“ç„¶ï¼Œå¯¹äºä¼ä¸šçº§å¤§å‹åº”ç”¨ï¼Œè¿˜æ˜¯æ¨èä½¿ç”¨ Tailwindcssï¼Œä¸‹ä¸€æœŸè®²å®æˆ˜ä¼šè®²è§£ã€‚


## 6. SEO é…ç½®


### meta 

åœ¨å„ä¸ª page.js æ–‡ä»¶ä¸­ï¼Œéƒ½å¯ä»¥é…ç½®å½“å‰é¡µé¢å¯¹åº”çš„ meta ä¿¡æ¯ï¼š

```js
import { Metadata } from 'next'

// ä½¿ç”¨ é™æ€ meta
export const metadata: Metadata = {
  title: '...',
}
 
// ä½¿ç”¨ åŠ¨æ€ meta
export async function generateMetadata({ params }) {
  return {
    title: '...',
  }
}

export default function Page() { return '...'}
```
å½“ç„¶ä½ ä¹Ÿå¯ä»¥ç›´æ¥åœ¨ layout ä¸­å†™å…¥ã€‚

### sitemap

æ¨èå®‰è£… `next-sitemap` åº“ï¼Œä½¿ç”¨æ—¶åªéœ€è¦åœ¨ package.json ä¸­å†™å…¥æŒ‡ä»¤å³å¯ï¼š`"postbuild": "next-sitemap"`ï¼Œè¿™æ ·åœ¨æ‰“åŒ…åå°±ä¼šåœ¨ public æ–‡ä»¶å¤¹ç”Ÿæˆ robots.txt å’Œ sitemap.xml æ–‡ä»¶ã€‚å½“ç„¶äº†ï¼Œå¦‚æœä½ æƒ³è‡ªå®šä¹‰é…ç½®ï¼Œå¯åœ¨æ ¹ç›®å½•åˆ›å»ºä¸€ä¸ªé…ç½®æ–‡ä»¶ `next-sitemap.config`:

```js
/** @type {import('next-sitemap').IConfig} */
module.exports = {
  siteUrl: process.env.SITE_URL || "https://xxx.com",
  generateIndexSitemap: false,
  generateRobotsTxt: true,
  robotsTxtOptions: {
    policies: [{ userAgent: '*', allow: '/' }],
  },
};
```

## 7. é™„å½•ï¼šNext.js 13+ æ–°åŠŸèƒ½ä¸€è§ˆ

### React æœåŠ¡å™¨ç»„ä»¶ ï¼ˆRSCï¼‰

RSCs å…è®¸åœ¨å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¸Šé‡‡ç”¨æ›´ç²¾ç»†çš„æ¸²æŸ“æ–¹å¼ã€‚React å…è®¸å¼€å‘è€…é€‰æ‹©ç»„ä»¶æ˜¯åœ¨æœåŠ¡å™¨ä¸Šè¿˜æ˜¯åœ¨å®¢æˆ·ç«¯æ¸²æŸ“ï¼Œè€Œä¸æ˜¯åœ¨ç”¨æˆ·è¯·æ±‚æ—¶è¢«è¿«å†³å®šåœ¨å®¢æˆ·ç«¯è¿˜æ˜¯æœåŠ¡å™¨ä¸Šæ¸²æŸ“æ•´ä¸ªé¡µé¢ã€‚è¿™å¯ä»¥è®©ä½ åœ¨æœç´¢å¼•æ“ç»“æœé¡µé¢ä¸­è·å¾—å·¨å¤§ä¼˜åŠ¿ã€‚

### Streaming UI

æµå¼ UIï¼ˆStreaming UIï¼‰ä»£ç å—æ˜¯ä¸€ä¸ªæ–°å…´çš„è®¾è®¡æ¨¡å¼ï¼Œç§°ä¸º`å²›å±¿æ¶æ„ï¼ˆthe island architectureï¼‰`ï¼Œæ—¨åœ¨é¦–æ¬¡åŠ è½½æ—¶å°½é‡å‘å®¢æˆ·ç«¯å‘é€æœ€å°‘çš„ä»£ç ã€‚

å…¶å®ç°ç›®æ ‡æ˜¯ï¼šå‘å®¢æˆ·ç«¯å‘é€ä¸€ä¸ªæ— éœ€ JavaScript çš„å®Œå…¨æ¸²æŸ“çš„é¡µé¢ï¼Œç„¶åå†å‘é€å‰©ä½™çš„å†…å®¹ã€‚

å½“ Next.js åœ¨æœåŠ¡å™¨ç«¯æ¸²æŸ“é¡µé¢æ—¶ï¼Œé€šå¸¸ä¼šå°†é¡µé¢çš„æ‰€æœ‰ JavaScript æ†ç»‘å¹¶ä¸ä¹‹ä¸€èµ·å‘é€ã€‚è€Œæµå¼ UI ä»£ç å—çš„å¼•å…¥æ¶ˆé™¤äº†è¿™ç§éœ€è¦ï¼Œå…è®¸å‘å®¢æˆ·ç«¯å‘é€ä¸€ä¸ªéå¸¸å°çš„é™æ€é¡µé¢ï¼Œæ˜¾è‘—æ”¹å–„äº†è¯¸å¦‚é¦–æ¬¡å†…å®¹å‘ˆç°æ—¶é—´å’Œæ•´ä½“é¡µé¢é€Ÿåº¦ç­‰æŒ‡æ ‡ã€‚

æµå¼ UI çš„æ­¥éª¤å¤§è‡´å¦‚ä¸‹ï¼š

-   ç”¨æˆ·å‘èµ·åˆå§‹è¯·æ±‚
-   æ¸²æŸ“å¹¶å‘é€åŸºæœ¬çš„ HTML é¡µé¢ç»™å®¢æˆ·ç«¯
-   æœåŠ¡å™¨å‡†å¤‡ JavaScript æ†ç»‘æ–‡ä»¶
-   åœ¨å®¢æˆ·ç«¯æµè§ˆå™¨ä¸­æ˜¾ç¤ºéœ€è¦ JavaScript çš„é¡µé¢éƒ¨åˆ†
-   ä»…å°†è¯¥ç»„ä»¶æ‰€éœ€çš„ JavaScript æ†ç»‘æ–‡ä»¶å‘é€ç»™å®¢æˆ·ç«¯

### App Router

app ç›®å½•ä¸‹çš„æ‰€æœ‰ä¸œè¥¿éƒ½æ˜¯é¢„å…ˆé…ç½®å¥½çš„ï¼Œä»¥å…è®¸ RSCs å’Œæµå¼ UI çš„å‡ºç°ã€‚ä½ åªéœ€è¦åˆ›å»ºä¸€ä¸ª[loading.js](https://beta.nextjs.org/docs/routing/loading-ui)ç»„ä»¶ï¼Œå®ƒå°†å®Œå…¨åŒ…ä½é¡µé¢ç»„ä»¶å’Œ suspense è¾¹ç•Œå†…çš„ä»»ä½•å­èŠ‚ç‚¹ã€‚

### å‡çº§çš„ Next Image ç»„ä»¶

åˆ©ç”¨äº†æµè§ˆå™¨åŸç”Ÿæ”¯æŒçš„æ‡’åŠ è½½ç­–ç•¥ï¼Œæ·»åŠ äº†ä¸€äº›å¯¹ SEO æœ‰å¾ˆå¤§å¸®åŠ©çš„æ”¹è¿›ï¼š

-   é»˜è®¤éœ€è¦ alt æ ‡ç­¾ã€‚
-   æ›´å¥½çš„éªŒè¯ï¼Œä»¥ç¡®å®šæ¶‰åŠæ— æ•ˆå±æ€§é”™è¯¯ã€‚
-   ç”±äºæœ‰äº†ä¸€ä¸ªæ›´åƒ HTML çš„ç•Œé¢ï¼Œæ›´å®¹æ˜“è¿›è¡Œæ ·å¼è®¾è®¡ã€‚

### Font ç»„ä»¶

ç½‘é¡µæ€§èƒ½ä¸­ï¼ŒCLS æ˜¯ä¸€ä¸ªé‡è¦çš„æŒ‡æ ‡ï¼ˆCLS æ˜¯ Cumulative Layout Shift çš„ç¼©å†™ï¼Œè¡¡é‡åœ¨ç½‘é¡µçš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸå†…å‘ç”Ÿçš„æ‰€æœ‰æ„å¤–å¸ƒå±€åç§»çš„å¾—åˆ†æ€»å’Œã€‚ï¼‰ï¼Œæ ¹æ®ä½ æ‰€ä½¿ç”¨çš„æ¡†æ¶ï¼ˆæ¯”å¦‚ Gatsbyï¼‰ï¼Œè®©å­—ä½“æœ‰æ•ˆåœ°é¢„åŠ è½½å¯èƒ½æ˜¯å¾ˆæ£˜æ‰‹çš„ã€‚ä¸€æ®µæ—¶é—´ä»¥æ¥ï¼Œå‘è°·æ­Œç­‰å­—ä½“åº“å‘å‡ºå¤–éƒ¨è¯·æ±‚æ˜¯ä¸€ä¸ªé¿å…ä¸äº†çš„è¡Œä¸ºï¼Œåœ¨è®¸å¤š SPA åº”ç”¨ç¨‹åºä¸­é€ æˆäº†ä¸€ä¸ªéš¾ä»¥ç®¡ç†çš„ç“¶é¢ˆï¼ˆé¡µé¢æ–‡å­—ä¼šé—ªçƒä¸€ä¸‹ï¼‰ã€‚

Next Font Component æ—¨åœ¨è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå®ƒåœ¨æ„å»ºæ—¶è·å–æ‰€æœ‰çš„å¤–éƒ¨å­—ä½“ï¼Œå¹¶ä»ä½ è‡ªå·±çš„åŸŸä¸­è‡ªæˆ‘æ‰˜ç®¡å®ƒä»¬ã€‚å­—ä½“ä¹Ÿè¢«è‡ªåŠ¨ä¼˜åŒ–ï¼Œå¹¶ä¸”é€šè¿‡è‡ªåŠ¨åˆ©ç”¨ CSS **size-adjustï¼ˆå¤§å°è°ƒæ•´ï¼‰**  å±æ€§å®ç°äº†é›¶ç´¯ç§¯çš„å¸ƒå±€è½¬ç§»ã€‚

æ¯”å¦‚è¿™æ ·ä½¿ç”¨ google å­—ä½“ï¼š

```js
import { Roboto } from 'next/font/google'

const roboto = Roboto({ weight: '400', subsets: ['latin'], display: 'swap',})

...
<html lang="en" className={roboto.className}> <body>{children}</body> </html>
```

å…³äºæ–°åŠŸèƒ½ App router å°±è®²è¿™ä¹ˆå¤šå•¦ï¼Œæ¬¢è¿å¤§å®¶ä¸€èµ·è®¨è®ºäº¤æµï¼Œä¸€èµ·å­¦ä¹ ã€‚9:T1b89,æœ¬èŠ‚ç»§ç»­ï¼Œä»‹ç»å¾®å‰ç«¯ä¸­ js éš”ç¦»çš„æ–¹æ¡ˆã€‚å‰ä¸€è®²çš„ iframe éš”ç¦»ï¼Œæœ¬è´¨ä¸Šæ˜¯åˆ©ç”¨äº† V8 å¼•æ“çš„éš”ç¦»æœºåˆ¶ï¼Œå€ŸåŠ© iframe å®ç°çš„ï¼›æœ¬èŠ‚è¯´çš„å¿«ç…§éš”ç¦»ï¼Œæœ¬è´¨ä¸Šè¿˜æ˜¯æŠŠå­åº”ç”¨æ‰§è¡Œåœ¨ä¸»åº”ç”¨ä¸Šä¸‹æ–‡ä¸­ï¼Œä½†æ˜¯å¯¹ä¸»åº”ç”¨çš„ winodw åšå¿«ç…§ï¼Œåœ¨å­åº”ç”¨å¸è½½çš„æ—¶å€™æ¢å¤å¿«ç…§å³å¯ã€‚

![image.png](/img/posts/2024-1-11/2024-1-11-1.png)

[ä»“åº“åœ°å€ï¼šsandbox/snapshot-script åˆ†æ”¯](https://github.com/heiheihoho1213/monto-app/tree/sandbox/snapshot-script)

## 2. ä¸»åº”ç”¨æœåŠ¡

æˆ‘ä»¬å¯åŠ¨ä¸»åº”ç”¨æœåŠ¡ï¼š

```js
app.listen(port.main, host);
```
å¹¶åœ¨ä¸»åº”ç”¨é‡Œå†™å…¥æ¥å£è¯·æ±‚ï¼š

```js
app.post("/microapps", function (req, res) {
  // è¿™é‡Œå¯ä»¥æ˜¯ç®¡ç†åå°æ–°å¢èœå•åå­˜å‚¨åˆ°æ•°æ®åº“çš„æ•°æ®
  // ä»è€Œå¯ä»¥é€šè¿‡ç®¡ç†åå°åŠ¨æ€é…ç½®å¾®åº”ç”¨çš„èœå•
  res.json([
    {
      name: "micro1",
      id: "micro1",
      // è¿™é‡Œæš‚æ—¶ä»¥ä¸€ä¸ªå…¥å£æ–‡ä»¶ä¸ºç¤ºä¾‹
      script: `http://${host}:${port.micro}/micro1.js`,
      style: `http://${host}:${port.micro}/micro1.css`,
      // æŒ‚è½½åˆ° window ä¸Šçš„å¯åŠ¨å‡½æ•° window.micro1_mount
      mount: "micro1_mount",
      // æŒ‚è½½åˆ° window ä¸Šçš„å¯åŠ¨å‡½æ•° window.micro1_unmount
      unmount: "micro1_unmount",
      prefetch: true,
    },
    {
      name: "micro2",
      id: "micro2",
      script: `http://${host}:${port.micro}/micro2.js`,
      style: `http://${host}:${port.micro}/micro2.css`,
      mount: "micro2_mount",
      unmount: "micro2_unmount",
      prefetch: true,
    },
  ]);
});
```

### å­åº”ç”¨è®¾ç½®

æˆ‘ä»¬åˆ†åˆ«åœ¨ä¸¤ä¸ªå­åº”ç”¨ä¸­å„è‡ªé…ç½®è‡ªå·±çš„æ‰§è¡Œä»£ç ï¼Œä»»åŠ¡è®¾ç½®å…¨å±€çš„å˜é‡æ¥éªŒè¯æ²™ç®±çš„éš”ç¦»æ•ˆæœï¼š

```js
// micro1.js
let root = document.createElement("h1");
root.textContent = "å¾®åº”ç”¨1";
root.id = 'micro1-dom';
root.onclick = () => {
  console.log("å¾®åº”ç”¨1 çš„ window.a: ", window.a);
};
document.body.appendChild(root);

window.a = 1;

// micro2.js
let root = document.createElement("h1");
root.textContent = "å¾®åº”ç”¨2";
root.id = 'micro2-dom';
root.onclick = () => {
  console.log("å¾®åº”ç”¨2 çš„ window.a: ", window.a);
};
document.body.appendChild(root);

window.a = 2;
```

## 3. ä¸»åº”ç”¨æ¸²æŸ“

æˆ‘ä»¬é…ç½®ä¸»åº”ç”¨çš„å…¥å£ï¼Œå¹¶è®¾ç½®ç”¨äºéªŒè¯çš„åŒåå…¨å±€å˜é‡ï¼š

```html
<!-- ä¸»åº”ç”¨å¯¼èˆª -->
<div id="nav"></div>

<!-- ä¸»åº”ç”¨å†…å®¹åŒº -->
<div id="container"></div>

<script>
  window.a = 3;
</script>
```

æ¥ç€åœ¨ä¸»åº”ç”¨å¯åŠ¨çš„è„šæœ¬å†™å…¥æ²™ç®±é…ç½®ã€‚

## 4. å®ç°æ²™ç®±

æ²™ç®±çš„å®ç°æ­¥éª¤å¯ä»¥å‚è§ iframe æ²™ç®±çš„æµç¨‹ï¼Œå”¯ä¸€ä¸åŒçš„æ˜¯ Sandbox ç±»çš„å®ç°ã€‚

æˆ‘ä»¬å®ç°æ²™ç®±ç±»æ„é€ å‡½æ•°ï¼š

```js
// ç±»ä¸»è¦æˆå‘˜å˜é‡
// å¾®åº”ç”¨ JS è¿è¡Œä¹‹å‰çš„ä¸»åº”ç”¨ window å¿«ç…§
mainWindow = {};
// å¾®åº”ç”¨ JS è¿è¡Œä¹‹åçš„ window å¯¹è±¡ï¼ˆç”¨äºç†è§£ï¼‰
microWindow = {};
// å¾®åº”ç”¨å¤±æ´»åå’Œä¸»åº”ç”¨çš„ window å¿«ç…§å­˜åœ¨å·®å¼‚çš„å±æ€§é›†åˆ
diffPropsMap = {};

constructor(options) {
  this.options = options;
  // é‡æ–°åŒ…è£…éœ€è¦æ‰§è¡Œçš„å¾®åº”ç”¨ JS è„šæœ¬
  this.wrapScript = this.createWrapScript();
}

createWrapScript() {
  // å¾®åº”ç”¨çš„ä»£ç è¿è¡Œåœ¨ç«‹å³æ‰§è¡Œçš„åŒ¿åå‡½æ•°ä¸­ï¼Œéš”ç¦»ä½œç”¨åŸŸ
  return `;(function(window){
    ${this.options.scriptText}
  })(window)`;
}
```

åŒæ ·æ˜¯é—­åŒ…æ‰§è¡Œè„šæœ¬ï¼Œä¸åŒçš„æ˜¯ä¸å†ä½¿ç”¨ window çš„ä»£ç†äº†ï¼Œè¿™é‡Œçš„ window æ˜¯ä¸»åº”ç”¨ window çš„å¿«ç…§ï¼Œä¸‹é¢ä¼šä»‹ç»å®ç°ã€‚

#### æ¿€æ´»

æ²™ç®±åˆ›å»ºå®Œæˆåï¼Œå°±æ˜¯æ¿€æ´»å’Œå¸è½½åŠŸèƒ½äº†ï¼Œå…ˆçœ‹æ¿€æ´»ï¼š

```js
active() {
  // è®°å½•å¾®åº”ç”¨ JS è¿è¡Œä¹‹å‰çš„ä¸»åº”ç”¨ window å¿«ç…§
  this.recordMainWindow();
  // æ¢å¤å¾®åº”ç”¨éœ€è¦çš„ window å¯¹è±¡
  this.recoverMicroWindow();
  if (this.exec) {
    return;
  }
  this.exec = true;
  // æ‰§è¡Œå¾®åº”ç”¨ï¼ˆæ³¨æ„å¾®åº”ç”¨çš„ JS ä»£ç åªéœ€è¦è¢«æ‰§è¡Œä¸€æ¬¡ï¼‰
  this.execWrapScript();
}
```

å…¶ä¸­ recordMainWindow ç”¨äºè®°å½•æŒ‚è½½ä¹‹å‰ä¸»åº”ç”¨çš„ window çŠ¶æ€ï¼š

```js
recordMainWindow() {
  for (const prop in window) {
    if (window.hasOwnProperty(prop)) {
      this.mainWindow[prop] = window[prop];
    }
  }
}
```

recoverMicroWindow æ˜¯æ¢å¤ä¸Šä¸€æ¬¡æŒ‚è½½å­åº”ç”¨æ—¶çš„ window çŠ¶æ€ï¼š

```js
recoverMicroWindow() {
  // å¦‚æœå¾®åº”ç”¨å’Œä¸»åº”ç”¨çš„ window å¯¹è±¡å­˜åœ¨å±æ€§å·®å¼‚
  // ä¸Šä¸€æ¬¡å¾®åº”ç”¨ window = ä¸»åº”ç”¨ window + å·®å¼‚å±æ€§ï¼ˆåœ¨å¾®åº”ç”¨å¤±æ´»å‰ä¼šè®°å½•è¿è¡Œè¿‡ç¨‹ä¸­æ¶‰åŠåˆ°æ›´æ”¹çš„ window å±æ€§å€¼ï¼Œå†æ¬¡è¿è¡Œä¹‹å‰éœ€è¦æ¢å¤ä¿®æ”¹çš„å±æ€§å€¼ï¼‰
  Object.keys(this.diffPropsMap).forEach((p) => {
    // æ›´æ”¹ JS è¿è¡Œä¹‹å‰çš„å¾®åº”ç”¨ window å¯¹è±¡ï¼Œæ³¨æ„å¾®åº”ç”¨æœ¬è´¨ä¸Šå…±äº«äº†ä¸»åº”ç”¨çš„ window å¯¹è±¡ï¼Œå› æ­¤ä¸€ä¸ªæ—¶åˆ»åªèƒ½è¿è¡Œä¸€ä¸ªå¾®åº”ç”¨
    window[p] = this.diffPropsMap[p];
  });

  this.microWindow = window;
}
```

ç„¶åå°±æ˜¯æ‰§è¡Œ è„šæœ¬ äº†ï¼š

```js
execWrapScript() {
  // åœ¨å…¨å±€ä½œç”¨åŸŸå†…æ‰§è¡Œå¾®åº”ç”¨ä»£ç 
  (0, eval)(this.wrapScript);
}
```

(0, eval) æ˜¯ä¸€ä¸ªé€—å·è¡¨è¾¾å¼ï¼Œå…¶è¿”å›æœ€å³è¾¹çš„å€¼ï¼Œç­‰ä»·äº evalï¼Œä¹‹æ‰€ä»¥è¿™ä¹ˆå†™ï¼Œæ˜¯å› ä¸ºé€—å·è¡¨è¾¾å¼ä¹‹åè¿”å›çš„æ˜¯ä¸€ä¸ªå¯¹ eval çš„é—´æ¥è°ƒç”¨ï¼Œè€Œé—´æ¥è°ƒç”¨è®¡ç®—å‡ºæ¥çš„æ˜¯ä¸€ä¸ªå€¼ï¼Œè€Œä¸æ˜¯å¼•ç”¨ï¼Œç›¸å½“äºæŠŠè¿™ä¸ªå‡½æ•°å•ç‹¬å£°æ˜å‡ºæ¥å†æ‰§è¡Œã€‚

ä¸Šé¢çš„ä»£ç  (0, eval)(this.wrapScript)ï¼Œç›¸å½“äºæ”¹å˜äº† eval æ‰§è¡Œå¯¹è±¡ä¸º wrapScriptï¼Œæ”¹å˜äº†å†…éƒ¨æ‰§è¡Œçš„ this æŒ‡é’ˆã€‚

#### å¤±æ•ˆ

æˆ‘ä»¬å†æ¥çœ‹çœ‹è§£é™¤æ¿€æ´»çŠ¶æ€çš„å®ç°ã€‚

```js
inactive() {
  // æ¸…ç©ºä¸Šä¸€æ¬¡è®°å½•çš„å±æ€§å·®å¼‚
  this.diffPropsMap = {};
  // è®°å½•å¾®åº”ç”¨è¿è¡Œåå’Œä¸»åº”ç”¨ Window å¿«ç…§å­˜åœ¨çš„å·®å¼‚å±æ€§
  this.recordDiffPropsMap();
  console.log(
    `${this.options.appId} diffPropsMap: `,
    this.diffPropsMap
  );
}
```

å…¶ä¸­ recordDiffPropsMapï¼š

```js
recordDiffPropsMap() {
  // è¿™é‡Œçš„ microWindow æ˜¯å¾®åº”ç”¨å¤±æ´»ä¹‹å‰çš„ windowï¼ˆåœ¨å¾®åº”ç”¨æ‰§è¡ŒæœŸé—´ä¿®æ”¹è¿‡ window å±æ€§çš„ windowï¼‰
  for (const prop in this.microWindow) {
    // å¦‚æœå¾®åº”ç”¨è¿è¡ŒæœŸé—´å­˜åœ¨å’Œä¸»åº”ç”¨å¿«ç…§ä¸ä¸€æ ·çš„å±æ€§å€¼
    if (
      window.hasOwnProperty(prop) &&
      this.microWindow[prop] !== this.mainWindow[prop]
    ) {
      // è®°å½•å¾®åº”ç”¨è¿è¡ŒæœŸé—´ä¿®æ”¹æˆ–è€…æ–°å¢çš„å·®å¼‚å±æ€§ï¼ˆä¸‹ä¸€æ¬¡è¿è¡Œå¾®åº”ç”¨ä¹‹å‰å¯ç”¨äºæ¢å¤å¾®åº”ç”¨è¿™ä¸€æ¬¡è¿è¡Œçš„ window å±æ€§ï¼‰
      this.diffPropsMap[prop] = this.microWindow[prop];
      // æ¢å¤ä¸»åº”ç”¨çš„ window å±æ€§å€¼
      window[prop] = this.mainWindow[prop];
    }
  }
}
```

å¤§è‡´æµç¨‹å°±æ˜¯è®°å½•ä¸€ä¸‹ä¸åŸæ¥ window çš„å·®å¼‚ï¼Œç„¶åæ¢å¤åŸæ¥è®°å½•çš„ä¸»åº”ç”¨çš„ windowã€‚

æˆ‘ä»¬å°†ä¸Šé¢çš„è®¾è®¡æ€è·¯æ€»ç»“å¦‚ä¸‹ï¼š

![image.png](/img/posts/2024-1-11/2024-1-11-2.png)

å…¶ä½™ç±»çš„å®ç°ä¸ iframe éš”ç¦»ä¸€è‡´ï¼Œå¯ä»¥å‚è§ï¼š[iframe sandbox](/posts/monto-app-sandbox-webcomponents-iframe)

## 5. å°ç»“

æœ¬éš”ç¦»æ–¹å¼å®é™…æ˜¯åŠ¨æ€ script çš„å˜ç§ï¼Œæ²¡æœ‰åˆ›å»º script æ ‡ç­¾ï¼Œè€Œæ˜¯ç›´æ¥åœ¨ window å¿«ç…§ä¸­æ‰§è¡Œå¾®åº”ç”¨çš„ jsï¼Œç¼ºç‚¹å¾ˆæ˜æ˜¾ï¼š

- ä¸èƒ½åŒæ—¶åŠ è½½å¤šä¸ªå­åº”ç”¨
- æ— æ³•å¤„ç†ä¸»å­åº”ç”¨åŒæ—¶æ“ä½œ window äº§ç”Ÿå†²çªçš„é—®é¢˜a:T386d,æœ¬èŠ‚å¼€å§‹ï¼Œä»‹ç»å¾®å‰ç«¯ä¸­ js éš”ç¦»çš„æ–¹æ¡ˆã€‚

## 1. iframeæ²™ç®±åŸç†

iframe ä¹‹æ‰€ä»¥æ”¯æŒ js éš”ç¦»ï¼Œæ˜¯å› ä¸ºåœ¨ V8 å¼•æ“é‡Œï¼Œæ¯ä¸€ä¸ª iframe éƒ½ç›¸å½“äºå¼€äº†ä¸€ä¸ªæ–°çš„ Isolate å¯¹è±¡ï¼Œæ‰€ä»¥å°±ç›¸å½“äºé—´æ¥ä½¿ç”¨äº† V8 éš”ç¦»ï¼Œä»–ä»¬æ˜¯ä¸åŒçš„ V8 ä¸Šä¸‹æ–‡ã€‚

æœ¬æ–‡ç»“åˆä¹‹å‰çš„ Web Components åŠ è½½æ–¹æ¡ˆå’Œ iframe å¤©ç„¶æ²™ç®±ï¼Œæ¥å®ç°ä¸€ä¸ªéš”ç¦»çš„æ–¹æ¡ˆã€‚ä½¿ç”¨ iframe çš„æœ€ä¸»è¦çš„é—®é¢˜å¦‚ä¸‹ï¼š

- ä¸»å­è·¯ç”±ä¸ç»Ÿä¸€
- å¼¹å‡ºå±‚ä¸ä¼šè‡ªåŠ¨å±…ä¸­
- æ•°æ®çŠ¶æ€åŒæ­¥é—®é¢˜

æˆ‘ä»¬è¿™é‡Œå…ˆè§£å†³ç¬¬ä¸€ä¸ªé—®é¢˜ï¼Œå°†ä¸»åº”ç”¨çš„ history å¯¹è±¡ä»£ç†ä¸€ä¸‹ä¼ é€’ç»™å­åº”ç”¨ï¼š

![image.png](/img/posts/2024-1-10/2024-1-10-1.png)

[ä»“åº“åœ°å€ï¼šsandbox/web-components-proxy åˆ†æ”¯](https://github.com/heiheihoho1213/monto-app/tree/sandbox/web-components-proxy)

æˆ‘ä»¬å®ç°çš„æ­¥éª¤å¦‚ä¸‹ï¼š

1. æ”¹é€ å­åº”ç”¨å…¥å£ï¼Œå£°æ˜è‡ªå·±çš„å®šåˆ¶å…ƒç´ ä¿¡æ¯
2. ä¸»åº”ç”¨å¯åŠ¨æ—¶ï¼Œè·å–å­åº”ç”¨ä¿¡æ¯
3. åˆ›å»º iframe å…ƒç´ 
4. iframeä¸­å­åº”ç”¨æŒ‚è½½æ—¶ï¼Œå°†ä¸»åº”ç”¨çš„ window ä»£ç†åä¼ é€’ç»™å­åº”ç”¨
5. å­åº”ç”¨å¼€å§‹æ¸²æŸ“ï¼Œæ‰§è¡Œè‡ªå·±çš„ jsï¼Œå¹¶æŒ‚è½½è‡ªå·±çš„å®šåˆ¶åŒ–å…ƒç´ 
6. å­åº”ç”¨å¸è½½æ—¶ï¼Œè®¾ç½® display ä¸º none å³å¯ï¼Œjs ä¸ç”¨åˆ é™¤

#### æ”¹é€ å­åº”ç”¨

```js
// æµ‹è¯•ä»£ç ï¼šå…¨å±€å˜é‡çš„æ±¡æŸ“æƒ…å†µ
this.a = 'a';
console.log('å¾®åº”ç”¨1 a: ', a);

var b = 'b';
console.log('å¾®åº”ç”¨1 b: ', window.b);

window.c = 'c';
console.log('å¾®åº”ç”¨1 c: ', window.c);

let root = document.createElement("button");
root.textContent = "å¾®åº”ç”¨ 1 æ›´æ”¹ history ä¸º micro1";
document.body.appendChild(root);

root.onclick = () => {
  // è¿™é‡Œæ¥è¯´æ˜ history ç”¨çš„æ˜¯ä¸»åº”ç”¨æ¥çš„ä»£ç†
  history.pushState({}, '', '/micro1');
}
// endï¼šæµ‹è¯•ä»£ç 

class MicroApp1Element extends HTMLElement {
  constructor() {
    super();
  }

  connectedCallback() {
    console.log(`[micro-app-1]ï¼šæ‰§è¡Œ connectedCallback ç”Ÿå‘½å‘¨æœŸå›è°ƒå‡½æ•°`);
    this.mount();
  }

  disconnectedCallback() {
    console.log(`[micro-app-1]ï¼šæ‰§è¡Œ disconnectedCallback ç”Ÿå‘½å‘¨æœŸå›è°ƒå‡½æ•°`);
    // å¸è½½å¤„ç†
    this.unmount();
  }

  // [ç”Ÿå‘½å‘¨æœŸå›è°ƒå‡½æ•°] å½“ custom element å¢åŠ . åˆ é™¤. ä¿®æ”¹è‡ªèº«å±æ€§æ—¶ï¼Œè¢«è°ƒç”¨
  attributeChangedCallback(attr, oldVal, newVal) {
    console.log(
      `[app:${this.name}]ï¼šæ‰§è¡Œ attributeChangedCallback ç”Ÿå‘½å‘¨æœŸå›è°ƒå‡½æ•°`
    );
    if (this[attr] !== newVal) {
      this[attr] = newVal;
      this.isConnected && this.mount();
    }
  }

  mount() {
    const $micro = document.createElement("h1");
    $micro.textContent = "å¾®åº”ç”¨1";
    // å°†å¾®åº”ç”¨çš„å†…å®¹æŒ‚è½½åˆ°å½“å‰è‡ªå®šä¹‰å…ƒç´ ä¸‹
    this.appendChild($micro);
  }

  unmount() {}
}

window.customElements.define("micro-app-1", MicroApp1Element);
```

åœ¨å­åº”ç”¨é‡Œå®šä¹‰äº† Web Components çš„å…ƒç´ å£°æ˜ï¼Œå…¶æ“ä½œçš„ document ç­‰å¯¹è±¡ï¼Œéƒ½æ˜¯ç›¸å¯¹äºè‡ªå·±çš„ iframe å†…éƒ¨è€Œè¨€çš„ã€‚

#### ä¸»åº”ç”¨é…ç½®å­åº”ç”¨åˆ—è¡¨ä¿¡æ¯

é¦–å…ˆå¯åŠ¨æœåŠ¡å™¨ï¼š

```html
<!-- ä¸»åº”ç”¨å¯¼èˆª -->
<div id="nav"></div>

<!-- ä¸»åº”ç”¨å†…å®¹åŒº -->
<div id="container"></div>
```

```js
app.use(express.static(path.join("public", "main")));
// ...
app.listen(port.main, host);
```

é…ç½®è¯·æ±‚æ¥å£ï¼ˆå­åº”ç”¨å„è‡ªçš„nodeæœåŠ¡éœ€è¦é…ç½®è·¨åŸŸï¼Œè¿™é‡Œç•¥å»ï¼‰ï¼š

```js
app.post("/microapps", function (req, res) {
  res.json([
    {
      name: "micro1",
      id: "micro1",
      // è‡ªå®šä¹‰å…ƒç´ åç§°
      customElement: "micro-app-1",
      // è¿™é‡Œæš‚æ—¶ä»¥ä¸€ä¸ªå…¥å£æ–‡ä»¶ä¸ºç¤ºä¾‹
      script: `http://${host}:${port.micro}/micro1.js`,
      style: `http://${host}:${port.micro}/micro1.css`,
      prefetch: true,
    },
    {
      name: "micro2",
      id: "micro2",
      customElement: "micro-app-2",
      script: `http://${host}:${port.micro}/micro2.js`,
      style: `http://${host}:${port.micro}/micro2.css`,
      prefetch: true,
    },
  ]);
});
```

#### åˆ›å»º iframe

æˆ‘ä»¬å£°æ˜ä¸€ä¸ª IframeSandbox ç±»:

```js
// IframeSandbox
constructor(options) {
  this.options = options;
  // åˆ›å»º iframe æ—¶æµè§ˆå™¨ä¼šåˆ›å»ºæ–°çš„å…¨å±€æ‰§è¡Œä¸Šä¸‹æ–‡ï¼Œç”¨äºéš”ç¦»ä¸»åº”ç”¨çš„å…¨å±€æ‰§è¡Œä¸Šä¸‹æ–‡
  this.iframe = this.createIframe();
  this.iframeWindow = this.iframe.contentWindow;
  // æ‰§è¡Œ history ä»£ç†
  this.proxyIframeWindow();
}
```

åœ¨å­åº”ç”¨æ¿€æ´»æ—¶å¯ä»¥è¿™ä¹ˆå†™ï¼š

```js
new IframeSandbox({
  rootElm: this.rootElm,  // æŒ‚è½½åº”ç”¨çš„æ ¹èŠ‚ç‚¹ï¼Œè¿™é‡Œæ˜¯ #container
  scriptText: this.scriptText,
  url: this.app.script,
  id: this.app.id,
  customElement: this.app.customElement
});
```

åœ¨ IframeSandbox ç±»é‡Œï¼Œæˆ‘ä»¬å¼€å§‹æ„é€ ä¸€ä¸ªå±€éƒ¨çš„ js sandboxã€‚

é¦–å…ˆï¼Œä½¿ç”¨ src = about:blank çš„ iframe å¯ä»¥ä¿è¯å…¶ä¸ä¸»åº”ç”¨åŒæºï¼š

```js
// IframeSandbox
createIframe() {
  const { rootElm, id, url } = this.options;
  const iframe = window.document.createElement("iframe");
  const attrs = {
    src: "about:blank",
    "app-id": id,
    "app-src": url,
    style: "border:none;width:100%;height:100%;",
  };
  Object.keys(attrs).forEach((name) => {
    iframe.setAttribute(name, attrs[name]);
  });
  rootElm?.appendChild(iframe);
  return iframe;
}
```
> app-src æ˜¯ä¸€ç§å®‰å…¨ç­–ç•¥ï¼ŒæŒ‡å®šäº†åªæœ‰å­åº”ç”¨è‡ªå·±çš„ url çš„èµ„æºå¯ä»¥è¢«åŠ è½½

#### åš history ä»£ç†

ç”±äº history æ˜¯åœ¨ window ä¸‹çš„ï¼Œdocument ä¹Ÿæ˜¯åœ¨ window ä¸‹çš„ï¼Œæˆ‘ä»¬å¹²è„†ç›´æ¥ä»£ç†ä¸»åº”ç”¨çš„ window å¯¹è±¡ï¼š

```js
// IframeSandboxï¼Œåœ¨ä¸»åº”ç”¨ä¸­æ‰§è¡Œçš„
proxyIframeWindow() {
  this.iframeWindow.proxy = new Proxy(this.iframeWindow, {
    get: (target, prop) => {
      // åªæ˜¯ç®€å•çš„ä»£ç†ï¼Œä¸»å­åº”ç”¨è·¯ç”±å†²çªæ²¡æœ‰è§£å†³
      // æ€è€ƒï¼šä¸ºäº†é˜²æ­¢ URL å†²çªé—®é¢˜ï¼Œæ˜¯å¦ä¹Ÿå¯ä»¥å½¢æˆè®¾è®¡è§„èŒƒï¼Œæ¯”å¦‚ä¸»åº”ç”¨é‡‡ç”¨ History è·¯ç”±ï¼Œå­åº”ç”¨é‡‡ç”¨ Hash è·¯ç”±ï¼Œä»è€Œç¡®ä¿ä¸»å­åº”ç”¨çš„è·¯ç”±ä¸ä¼šäº§ç”Ÿå†²çªçš„é—®é¢˜
      if (prop === "history" || prop === "location" || prop === "document") {
        // ä½¿ç”¨ä¸»åº”ç”¨ window
        return window[prop];
      }

      if (prop === "window" || prop === "self") {
        return this.iframeWindow.proxy;
      }

      // prop æ˜¯ä¿®æ­£è¿‡çš„æŒ‡å‘
      return this.getTargetValue(target, prop);
    },

    set: (target, prop, value) => {
      target[prop] = value;
      return true;
    },

    has: (target, prop) => !!target[prop],
  });
}
```
æ­¤æ—¶ï¼ŒåŸç”Ÿçš„ä¸€äº› API ä¼šæœ‰é—®é¢˜ï¼Œæ¯”å¦‚ window.alert å†…éƒ¨çš„ this ä¸æ˜¯æŒ‡å‘ iframe çš„ windowï¼Œè€Œæ˜¯æŒ‡å‘è¢«ä»£ç†åçš„ proxyï¼Œå› æ­¤åœ¨è°ƒç”¨ alert ç­‰åŸç”Ÿå‡½æ•°ä¼šæŠ¥é”™ Illegal invocationã€‚
åŒç±»å‹çš„æ–¹æ³•è¿˜æœ‰å¾ˆå¤šï¼Œæ¯”å¦‚ addEventListener. atob ç­‰ã€‚

è¿™é‡Œçš„ getTargetValueï¼Œç”¨äºé‡æ–°å°†è¿™äº›åŸç”Ÿ native api çš„ this ä¿®æ­£ä¸º iframe çš„ windowã€‚

æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å®ç°ï¼š

```js
getTargetValue(target, prop) {
  const value = target[prop];

  // è¿‡æ»¤å‡º window.alert. window.addEventListener ç­‰ API
  if (
    typeof value === "function" &&
    !this.isBoundedFunction(value) &&  // æ˜¯ç›´æ¥å®šä¹‰çš„ functionï¼Œä¸æ˜¯ bind çš„å‡½æ•°ï¼Œå› ä¸º å¦‚æœå‡½æ•°å·²ç»è¿›è¡Œäº† bindï¼Œé‚£ä¹ˆä¸åº”è¯¥è¿›è¡Œå†æ¬¡çš„ç»‘å®šæ“ä½œ
    !this.isConstructable(value) // è¿‡æ»¤æ‰æ„é€ å‡½æ•°ï¼šä¾‹å¦‚åŸç”Ÿçš„ Object. Array ä»¥åŠç”¨æˆ·è‡ªå·±åˆ›å»ºçš„æ„é€ å‡½æ•°ç­‰ã€‚ä¸€äº›æ„é€ å‡½æ•°ä¸éœ€è¦è¿›è¡Œ bind æ“ä½œï¼Œå› ä¸º bind ç”Ÿæˆçš„å‡½æ•°ä¼šå¤±å»åŸæœ‰å‡½æ•°çš„å±æ€§å’Œ prototype
  ) {
    console.log('ä¿®æ­£ this: ', prop);

    // ä¿®æ­£ value çš„ this æŒ‡å‘ä¸º target
    const boundValue = Function.prototype.bind.call(value, target);
    // é‡æ–°æ¢å¤ value åœ¨ bound ä¹‹å‰çš„å±æ€§å’ŒåŸå‹ï¼ˆbind ä¹‹åä¼šä¸¢å¤±ï¼‰
    for (const key in value) {
      boundValue[key] = value[key];
    }
    // å¦‚æœåŸæ¥çš„å‡½æ•°å­˜åœ¨ prototype å±æ€§ï¼Œè€Œ bound ä¹‹åä¸¢å¤±äº†ï¼Œé‚£ä¹ˆé‡æ–°è®¾ç½®å›æ¥
    if (
      value.hasOwnProperty("prototype") &&
      !boundValue.hasOwnProperty("prototype")
    ) {
      boundValue.prototype = value.prototye;
    }
    return boundValue;
  }
  return value;
}
```

å…¶ä¸­ä¸¤ä¸ªåˆ¤æ–­å‡½æ•°å¦‚ä¸‹ï¼š

```js
isBoundedFunction(fn) {
  return (
    // åœ¨ES6åŠä¹‹åçš„ç‰ˆæœ¬ä¸­ï¼Œæ¯ä¸ªå‡½æ•°éƒ½æœ‰ä¸€ä¸ª name å±æ€§, å¦‚æœå‡½æ•°æ˜¯é€šè¿‡ function å…³é”®å­—å®šä¹‰çš„ï¼Œé‚£ä¹ˆå®ƒçš„ name å±æ€§å€¼å°±æ˜¯è¿™ä¸ªå‡½æ•°åã€‚ä½†å¦‚æœå‡½æ•°æ˜¯é€šè¿‡å…¶ä»–æ–¹å¼ï¼ˆä¾‹å¦‚ä½¿ç”¨ Function æ„é€ å‡½æ•°æˆ– Function.prototype.bind æ–¹æ³•ï¼‰åˆ›å»ºçš„ï¼Œé‚£ä¹ˆå®ƒçš„ name å±æ€§å€¼å¯èƒ½ä¼šè¢«ä¿®æ”¹æˆ–æ·»åŠ å‰ç¼€ (æ¯”å¦‚ bound)
    // ä¾‹å­ï¼š
    /**
      let obj = {  
        x: 10,  
        getX: function() {  
          return this.x;  
        }  
      };
        
      let getXBoundToObj = obj.getX.bind(obj);  
      console.log(getXBoundToObj.name); // è¾“å‡º bound getX
    */
    
    // è¢«ç»‘å®šçš„å‡½æ•°æœ¬èº«æ²¡æœ‰ prototype
    fn.name.indexOf("bound ") === 0 && !fn.hasOwnProperty("prototype")
  );
}

isConstructable(fn) {
  // å¯ä»¥è¯†åˆ« Object. Array ç­‰åŸç”Ÿæ„é€ å‡½æ•°ï¼Œä¹Ÿå¯ä»¥è¯†åˆ«ç”¨æˆ·è‡ªå·±åˆ›å»ºçš„æ„é€ å‡½æ•°
  return (
    fn.prototype &&
    // é€šå¸¸æƒ…å†µä¸‹æ„é€ å‡½æ•°å’Œç±»çš„ prototype.constructor æŒ‡å‘æœ¬èº«
    fn.prototype.constructor === fn &&
    // é€šå¸¸æƒ…å†µä¸‹æ„é€ å‡½æ•°å’Œç±»éƒ½ä¼šå­˜åœ¨ prototype.constructorï¼Œå› æ­¤é•¿åº¦å¤§äºç­‰æ–¼ 1
    // éœ€è¦æ³¨æ„æ™®é€šå‡½æ•°ä¸­ä¹Ÿä¼šå­˜åœ¨ prototype.constructorï¼Œ
    // å› æ­¤å¦‚æœ prototypeä¸Š æœ‰è‡ªå®šä¹‰å±æ€§æˆ–è€…æ–¹æ³•ï¼Œé‚£ä¹ˆå¯ä»¥åˆ¤å®šä¸ºç±»æˆ–è€…æ„é€ å‡½æ•°ï¼Œå› æ­¤è¿™é‡Œçš„åˆ¤æ–­æ˜¯å¤§äº 1
    // è‡ªå»ºå‡½æ•°ï¼Œæ¯”å¦‚function Person {}; ï¼ŒåŸå‹é“¾ä¸Šæ²¡æœ‰æ–¹æ³•çš„ class è¯†åˆ«. function Person() {} è¯†åˆ«ç­‰ï¼Œå…¶é•¿åº¦ = 1
    // æ³¨æ„ä¸è¦ä½¿ç”¨ Object.keys è¿›è¡Œåˆ¤æ–­ï¼ŒObject.keys æ— æ³•è·å– Object.defineProperty å®šä¹‰çš„å±æ€§
    (Object.getOwnPropertyNames(fn.prototype).length > 1
      || (Object.getOwnPropertyNames(fn.prototype).length === 1 && Object.getOwnPropertyNames(fn.prototype)[0] === 'constructor'))
  );
  // TODO: æ²¡æœ‰ constructor çš„æ„é€ å‡½æ•°è¯†åˆ«
  // ä¾‹å¦‚ Person.prototype = {}; æ­¤æ—¶æ²¡æœ‰ prototype.constructor å±æ€§
}
```


#### æ¿€æ´»ä¸å¤±æ´»å‡½æ•°

æ¥ä¸‹æ¥åœ¨sandboxä¸­å®šä¹‰ä¸€ä¸‹æ¿€æ´»å­åº”ç”¨çš„å‡½æ•°ï¼š

```js
// IframeSandbox
async active() {
  this.iframe.style.display = "block";
  // å¦‚æœå·²ç»é€šè¿‡ Script åŠ è½½å¹¶æ‰§è¡Œè¿‡ JSï¼Œåˆ™æ— éœ€é‡æ–°åŠ è½½å¤„ç†
  if (this.execScriptFlag) return;
  this.execScript();
  this.mount();
  this.execScriptFlag = true;
}
```

å…¶ä¸­æ ¸å¿ƒçš„æ‰§è¡Œä»£ç å’ŒæŒ‚è½½å‡½æ•°å¦‚ä¸‹ï¼š

```js
execScript() {
  const scriptElement =
    this.iframeWindow.document.createElement("script");
  // ä½¿ç”¨åŒ¿åæ‰§è¡Œæ˜¯ä¸ºäº†ä¿è¯jsä½œç”¨åŸŸä¸ä¼šå¤–æ³„ï¼Œå¹¶ä¸”ä¾¿äºä½¿ç”¨ä»£ç†
  scriptElement.textContent = `
      (function(window) {
        with(window) {
          ${this.options.scriptText}
        }
      }).bind(window.proxy)(window.proxy);
      `;
  this.iframeWindow.document.head.appendChild(scriptElement);
}

mount() {
  if (!this.$webcomponent) {
    const $slot = this.iframeWindow.document.body;
    // åˆ›å»ºç»„ä»¶å…ƒç´ 
    this.$webcomponent = this.iframeWindow.document.createElement(
      this.options.customElement
    );
    this.$webcomponent.setAttribute("micro-id", this.options.id);
    $slot.appendChild(this.$webcomponent);
  }
}
```
ä¸Šé¢çš„å‡½æ•°ä¸­ï¼Œwith è¯­å¥ç”¨äºå°†å½¢å‚windowçš„æ‰€æœ‰å±æ€§å’Œæ–¹æ³•æ·»åŠ åˆ°è‡ªå·±çš„ä½œç”¨åŸŸä¸­ï¼Œå…¶è®¾è®¡çš„æœ¬æ„ç”¨äºç¼©çŸ­æŸ¥æ‰¾ä½œç”¨åŸŸé“¾ã€‚

å¤±æ´»æ¯”è¾ƒç®€å•ï¼š

```js
inactive() {
  this.iframe.style.display = "none";
}
```

æ­¤å¤–è¿˜æœ‰æ²™ç®±æœ¬èº«çš„é”€æ¯å‡½æ•°ï¼Œè¿™é‡Œä¹Ÿæä¸€ä¸‹ï¼š

```js
// IframeSandbox é”€æ¯æ²™ç®±
destroy() {
  this.options = null;
  this.exec = false;
  if (this.iframe) {
    this.iframe.parentNode?.removeChild(this.iframe);
  }
  this.iframe = null;
}
```

åˆ°è¿™é‡Œï¼Œæ²™ç®±çš„è®¾è®¡åŸºæœ¬å®Œæˆï¼

æ¥ä¸‹æ¥æˆ‘ä»¬æŒ‰ç…§åŠ è½½é¡ºåºï¼Œé¦–å…ˆåˆå§‹åŒ–ä¸»åº”ç”¨ï¼Œè·å–å¾®åº”ç”¨åˆ—è¡¨ï¼š

```js
async init() {
  this.microApps = await this.fetchMicroApps();
  this.createNav();
  this.navClickListener();
  this.hashChangeListener();
  // åˆ›å»ºå¾®å‰ç«¯ç®¡ç†å®ä¾‹
  this.microManager = new MicroManager(
    document.getElementById("container"),
    this.microApps
  );
}

// ä»ä¸»åº”ç”¨æœåŠ¡å™¨è·è¯·æ±‚å¾®åº”ç”¨åˆ—è¡¨ä¿¡æ¯
async fetchMicroApps() {
  try {
    const res = await window.fetch("/microapps", {
      method: "post",
    });
    return await res.json();
  } catch (err) {
    console.error(err);
  }
}

...
// åˆ›å»º nav å¯¼èˆªçš„ä»£ç ä¸æ˜¯æ ¸å¿ƒï¼Œç•¥å»
// hash è·¯ç”±å˜åŒ–çš„ç›‘å¬äº‹ä»¶
hashChangeListener() {
  // ç›‘å¬ Hash è·¯ç”±çš„å˜åŒ–ï¼Œåˆ‡æ¢å¾®åº”ç”¨ï¼ˆè¿™é‡Œè®¾å®šä¸€ä¸ªæ—¶åˆ»åªèƒ½åˆ‡æ¢ä¸€ä¸ªå¾®åº”ç”¨ï¼‰
  window.addEventListener("hashchange", () => {
    this.microApps?.forEach(async ({ id }) => {
      id === window.location.hash.replace("#", "")
        ? this.microManager.activeApp(id)
        : this.microManager.inactiveApp(id);
    });
  });
}
```

ä¸Šé¢ä»£ç æåˆ°ä¸€ä¸ª MicroManager ç±»ï¼Œç”¨äºç®¡ç†å¾®å‰ç«¯åº”ç”¨çš„æ¿€æ´»å’Œé”€æ¯ï¼š

```js
appsMap = new Map();

// æ”¾å…¥å…¨éƒ¨çš„å¾®åº”ç”¨åˆ°ä¸€ä¸ªmap
setAppMaps(apps) {
  apps.forEach((app) => {
    this.appsMap.set(app.id, new MicroAppManager(this.rootElm, app));
  });
}

// æ¿€æ´»å¾®åº”ç”¨
activeApp(id) {
  const current = this.appsMap.get(id);
  current && current.active();
}

// å¤±æ´»å¾®åº”ç”¨
inactiveApp(id) {
  const current = this.appsMap.get(id);
  current && current.inactive();
}
```

ä¸ºäº†ä¾¿äºç†è§£ï¼Œä¸Šé¢åˆå•ç‹¬å°è£…äº†ä¸€ä¸ª MicroAppManager ç±»ï¼Œç”¨äºç›´æ¥æ“ä½œæ²™ç®±ï¼š

```js
// è·å– JS æ–‡æœ¬ï¼ˆå¾®åº”ç”¨æœåŠ¡éœ€è¦æ”¯æŒè·¨åŸŸè¯·æ±‚ï¼‰
async fetchScript(src) {
  try {
    const res = await window.fetch(src);
    return await res.text();
  } catch (err) {
    console.error(err);
  }
}

// æ¿€æ´»
async active() {
  // ç¼“å­˜èµ„æºå¤„ç†
  if (!this.scriptText) {
    this.scriptText = await this.fetchScript(this.app.script);
  }

  // å¦‚æœæ²¡æœ‰åˆ›å»ºæ²™ç®±ï¼Œåˆ™å®æ—¶åˆ›å»º
  // éœ€è¦æ³¨æ„åªç»™æ¿€æ´»çš„å¾®åº”ç”¨åˆ›å»º iframe æ²™ç®±ï¼Œå› ä¸ºåˆ›å»º iframe ä¼šäº§ç”Ÿå†…å­˜æŸè€—
  if (!this.sandbox) {
    this.sandbox = new IframeSandbox({
      rootElm: this.rootElm,
      scriptText: this.scriptText,
      url: this.app.script,
      id: this.app.id,
      customElement: this.app.customElement
    });
  }

  this.sandbox.active();
}

// å¤±æ´»
inactive() {
  this.sandbox?.inactive();
}
```

## 2. demo æµ‹è¯•

![image.png](/img/posts/2024-1-10/2024-1-10-2.png)

## 3. å®æˆ˜æµ‹è¯•

#### é€‚é… Vueb:T1dba,æœ¬èŠ‚ç»§ç»­ä»‹ç»å¾®å‰ç«¯çš„å¦ä¸€ç§æ–¹æ¡ˆï¼šåŠ¨æ€ scriptã€‚é¡¾åæ€ä¹‰ï¼Œå°±æ˜¯å°†å½“å‰çš„å¾®åº”ç”¨æ‰“åŒ…åï¼Œå°†å…¥å£çš„ js æ–‡ä»¶é€šè¿‡ script åŠ è½½è¿›ä¸»åº”ç”¨ï¼Œä»è€Œè¾¾åˆ°å¾®å‰ç«¯çš„æ•ˆæœã€‚ä»–å¯èƒ½æ˜¯ç›®å‰å®ç°èµ·æ¥æœ€ç®€å•çš„ä¸€ç§æ–¹æ¡ˆã€‚

![image.png](/img/posts/2024-1-8/2024-1-8-3.png)

[ä»“åº“åœ°å€ï¼štutorial/dynamic-script åˆ†æ”¯](https://github.com/heiheihoho1213/monto-app/tree/tutorial/dynamic-script)

## 1. ä¸»åº”ç”¨

æˆ‘ä»¬ç”¨ node å¯åŠ¨ä¸€ä¸ªä¸»åº”ç”¨:

```js
app.listen(port.main, host);
```

å¹¶åœ¨ä¸»åº”ç”¨é‡Œå†™å…¥æ¥å£è¯·æ±‚ï¼š

```js
app.post("/microapps", function (req, res) {
  // è¿™é‡Œå¯ä»¥æ˜¯ç®¡ç†åå°æ–°å¢èœå•åå­˜å‚¨åˆ°æ•°æ®åº“çš„æ•°æ®
  // ä»è€Œå¯ä»¥é€šè¿‡ç®¡ç†åå°åŠ¨æ€é…ç½®å¾®åº”ç”¨çš„èœå•
  res.json([
    {
      name: "micro1",
      id: "micro1",
      // è¿™é‡Œæš‚æ—¶ä»¥ä¸€ä¸ªå…¥å£æ–‡ä»¶ä¸ºç¤ºä¾‹
      script: `http://${host}:${port.micro}/micro1.js`,
      style: `http://${host}:${port.micro}/micro1.css`,
      // æŒ‚è½½åˆ° window ä¸Šçš„å¯åŠ¨å‡½æ•° window.micro1_mount
      mount: "micro1_mount",
      // æŒ‚è½½åˆ° window ä¸Šçš„å¯åŠ¨å‡½æ•° window.micro1_unmount
      unmount: "micro1_unmount",
      prefetch: true,
    },
    {
      name: "micro2",
      id: "micro2",
      script: `http://${host}:${port.micro}/micro2.js`,
      style: `http://${host}:${port.micro}/micro2.css`,
      mount: "micro2_mount",
      unmount: "micro2_unmount",
      prefetch: true,
    },
  ]);
});
```

ä¸Šé¢é…ç½®çš„è¿™ä¸¤ä¸ªå­åº”ç”¨ï¼Œè‡ªå·±å„è‡ªå•ç‹¬åœ¨è‡ªå·±ç«¯å£å¯åŠ¨å³å¯ã€‚ï¼ˆè¿™é‡Œå…¬ç”¨äº†ä¸€ä¸ªå­åº”ç”¨ç«¯å£ï¼Œå®é™…æƒ…å†µå¯èƒ½å­åº”ç”¨ç«¯å£ä¸ä¸€æ ·ï¼‰


ç„¶åé…ç½®ä¸»åº”ç”¨çš„ htmlï¼Œå¹¶é…ç½®åŠ è½½åŠŸèƒ½ï¼š

```html
<div class="container">
  <!-- å¾®åº”ç”¨æ¸²æŸ“çš„æ’æ§½ -->
  <div id="micro-app-slot"></div>
</div>
```

```js
loadScript({ script, id }) {
  return new Promise((resolve, reject) => {
    const $script = document.createElement("script");
    $script.src = script;
    $script.setAttribute("micro-script", id);
    $script.onload = resolve;
    $script.onerror = reject;
    document.body.appendChild($script);
  });
}

loadStyle({ style, id }) {
  return new Promise((resolve, reject) => {
    const $style = document.createElement("link");
    $style.href = style;
    $style.setAttribute("micro-style", id);
    $style.rel = "stylesheet";
    $style.onload = resolve;
    $style.onerror = reject;
    document.head.appendChild($style);
  });
}

removeStyle({ id }) {
  const $style = document.querySelector(`[micro-style=${id}]`);
  $style && $style?.parentNode?.removeChild($style);
}

hasLoadScript({ id }) {
  const $script = document.querySelector(`[micro-script=${id}]`);
  return !!$script;
}

hasLoadStyle({ id }) {
  const $style = document.querySelector(`[micro-style=${id}]`);
  return !!$style;
}
```

ä¸»åº”ç”¨åˆå§‹åŒ–ï¼š

```js
init() {
  this.processMicroApps();
  this.navClickListener();
  this.hashChangeListener();
}

processMicroApps() {
  this.getMicroApps().then((res) => {
    this.microApps = res;
    this.prefetchMicroAppStatic();
    this.createMicroAppNav();
  });
}

prefetchMicroAppStatic() {
  const prefetchMicroApps = this.microApps?.filter(
    (microapp) => microapp.prefetch
  );
  prefetchMicroApps?.forEach((microApp) => {
    microApp.script && this.prefetchStatic(microApp.script, "script");
    microApp.style && this.prefetchStatic(microApp.style, "style");
  });
}

createMicroAppNav(microApps) {
  const fragment = new DocumentFragment();
  this.microApps?.forEach((microApp) => {
    // TODO: APP æ•°æ®è§„èŒƒæ£€æµ‹ (ä¾‹å¦‚æ˜¯å¦æœ‰ script. mount. unmount ç­‰ï¼‰
    const button = document.createElement("button");
    button.textContent = microApp.name;
    button.id = microApp.id;
    fragment.appendChild(button);
  });
  nav.appendChild(fragment);
}
```

å…¶ä¸­ getMicroApps æ˜¯æœåŠ¡è·å–å¾®åº”ç”¨åˆ—è¡¨ä¿¡æ¯ï¼Œä¸»åº”ç”¨å§‘ä¸”ä½¿ç”¨ hashchange é…ç½®è·¯ç”±æ£€æµ‹ï¼š

```js
hashChangeListener() {
  // ç›‘å¬ Hash è·¯ç”±çš„å˜åŒ–ï¼Œåˆ‡æ¢å¾®åº”ç”¨
  // è¿™é‡Œè®¾å®šä¸€ä¸ªæ—¶åˆ»é¡µé¢ä¸Šåªæœ‰ä¸€ä¸ªå¾®åº”ç”¨
  window.addEventListener("hashchange", () => {
    this.microApps?.forEach(async (microApp) => {
      // åŒ¹é…éœ€è¦æ¿€æ´»çš„å¾®åº”ç”¨
      if (microApp.id === window.location.hash.replace("#", "")) {
        console.time(`fetch microapp ${microApp.name} static`);
        // åŠ è½½ CSS æ ·å¼
        microApp?.style &&
          !this.hasLoadStyle(microApp) &&
          (await this.loadStyle(microApp));
        // åŠ è½½ Script æ ‡ç­¾
        microApp?.script &&
          !this.hasLoadScript(microApp) &&
          (await this.loadScript(microApp));
        console.timeEnd(`fetch microapp ${microApp.name} static`);
        window?.[microApp.mount]?.("#micro-app-slot");
        // å¦‚æœå­˜åœ¨å¸è½½ API åˆ™è¿›è¡Œåº”ç”¨å¸è½½å¤„ç†
      } else {
        this.removeStyle(microApp);
        window?.[microApp.unmount]?.();
      }
    });
  });
}
```

> è¿™é‡Œåœ¨å­åº”ç”¨å¸è½½æ—¶æ²¡æœ‰ç§»é™¤ jsï¼Œæ˜¯å› ä¸ºé‡æ–°åŠ è½½æ—¶é¡¶çº§ä½œç”¨åŸŸä¼šè¢«é‡æ–°æ‰§è¡Œï¼Œæ¯”å¦‚ let a = 1; è¿™æ ·åå¤å£°æ˜ä¼šæŠ¥é”™ã€‚
> åŒæ—¶ï¼Œä¸å†™ removeScriptï¼Œjs åœ¨ `window` ä¸ŠæŒ‚è½½äº†å­åº”ç”¨çš„ `mount` å’Œ `unmount` æ–¹æ³•ä¹Ÿä¸ä¼šé€ æˆæ±¡æŸ“ï¼Œæ²¡å¿…è¦åˆ é™¤ã€‚

## 2. å­åº”ç”¨æ”¹é€ 

å½“ç„¶ï¼Œå„ä¸ªå­åº”ç”¨å…¥å£æ–‡ä»¶è¦æ”¹é€ ï¼Œæš´éœ²é’©å­å‡½æ•°ï¼š

```js
// micro1.js
// ç«‹å³æ‰§è¡Œçš„åŒ¿åå‡½æ•°å¯ä»¥é˜²æ­¢å˜é‡ root äº§ç”Ÿå†²çª
(function () {
  let root;

  // è¦ä¿è¯å„ä¸ªå­åº”ç”¨åç§°ä¸ä¸€æ ·
  window.micro1_mount = function (slot) {
    // ä»¥ä¸‹å…¶å®å¯ä»¥æ˜¯ React æ¡†æ¶æˆ–è€… Vue æ¡†æ¶ç”Ÿæˆçš„ Document å…ƒç´ ï¼Œè¿™é‡Œåªæ˜¯åšä¸€ä¸ªç®€å•çš„ç¤ºä¾‹
    root = document.createElement("h1");
    root.textContent = "å¾®åº”ç”¨1";
    // åœ¨å¾®åº”ç”¨æ’æ§½ä¸ŠæŒ‚è½½ DOM å…ƒç´ 
    const $slot = document.querySelector(slot);
    $slot?.appendChild(root);
  };

  window.micro1_unmount = function () {
    if (!root) return;
    root.parentNode?.removeChild(root);
  };
})();


// micro1.css
h1 {
  color: green;
}
```

åŒæ—¶å­åº”ç”¨ä¹Ÿè¦å¯åŠ¨èµ·æ¥ï¼š

```js
app.listen(port.micro, host);
```
è¿™æ ·ï¼Œscript æ ‡ç­¾çš„ src æ‰èƒ½å¤Ÿå»æ‰¾åˆ°æœåŠ¡å™¨ä¸Šå­åº”ç”¨çš„ js å…¥å£æ–‡ä»¶ã€‚

> æœ¬æ–‡ç”¨äº†hashè·¯ç”±é…ç½®åˆ‡æ¢ï¼Œæœ¬èº«æœ‰è®¾è®¡ç¼ºé™·ï¼Œå®æˆ˜ä¸­éœ€è¦è‡ªå·±è®¾ç½®æ›´å®Œå–„çš„è·¯ç”±æ–¹æ¡ˆã€‚

åŸºäºä»¥ä¸Šæè¿°ï¼Œå…¶å…·æœ‰ä»¥ä¸‹ä¼˜ç‚¹ï¼š

- ä¸»åº”ç”¨å¯ä»¥åŠ¨æ€å¢å‡. æ›´æ–°å­åº”ç”¨çš„æ•°é‡ï¼Œå®ç°åŠ¨æ€éƒ¨ç½²ã€‚
- å¾®åº”ç”¨å¯ä»¥å¦‚æ­£å¸¸åº”ç”¨ä¸€æ ·è¿›è¡Œä¼˜åŒ–ï¼Œå¦‚ä»£ç åˆ†å‰²ï¼Œé™æ€èµ„æºåˆ†ç¦»ï¼ŒCDNåŠ é€Ÿç­‰ã€‚
- ä¸éœ€è¦å¦‚NPMåº“ä¸€æ ·ï¼Œé…ç½®é¢å¤–çš„é…ç½®æ–‡ä»¶ä½¿å…¶æ‰“åŒ…æˆä¾èµ–åº“ã€‚
- ä¸»å­åº”ç”¨å¤©ç„¶åŒåŸŸï¼ˆé™¤äº†åŠ è½½jsæ—¶è¦è·¨åŸŸï¼‰

å…¶é—®é¢˜ä¹Ÿæ˜¯ä¸npmæ–¹æ¡ˆä¸€æ ·ï¼š

- ä¸»åº”ç”¨ä¸å¾®åº”ç”¨çš„å…¨å±€å˜é‡. CSSæ ·å¼. æœ¬åœ°å­˜å‚¨çš„æ•°æ®æ— æ³•åšåˆ°å¾ˆå¥½çš„éš”ç¦»ã€‚
- å­åº”ç”¨éœ€è¦æ”¹é€ é€‚é…ï¼ŒåŒ NPM æ–¹æ¡ˆä¸€æ ·æ²¡åŠæ³•å®Œå…¨è§£è€¦åˆã€‚

ä¸ NPM æ–¹æ¡ˆå·®å¼‚ï¼š

- æœ¬æ–¹æ¡ˆä¸ç”¨å»é™¤ script
- æœ¬æ–¹æ¡ˆçš„ script å¯ä»¥åš chunkï¼Œè€ŒNPMæ–¹æ¡ˆåªèƒ½åšåˆ° Tree Shakingã€‚åŠ¨æ€ script åˆ†æˆäº†å¤šæ®µ chunkï¼Œä½“ç§¯æ›´å°‘äº†ï¼Œè€Œ NPM åˆ™æ˜¯å…¨é‡æ„å»ºåˆ°åŒ…é‡Œçš„ ï¼ˆä½¿ç”¨ require è‡ªåŠ¨å¼•å…¥å…¨éƒ¨åŒ…ï¼‰ï¼Œæ­¤æ—¶æ€§èƒ½ä¼˜åŒ–ä¸Šåº”è¯¥æ˜¯æœ‰å·®å¼‚çš„ã€‚

> ä½†æ˜¯æ„Ÿè§‰NPMæ–¹æ¡ˆï¼Œåªè¦æ”¾å…¥å…¥å£æ–‡ä»¶ï¼Œæ˜¯ä¸æ˜¯ä¹Ÿèƒ½åšåˆ°åˆ†chunkï¼Ÿæ¯”å¦‚è¿™ä¸ªä¸ä½¿ç”¨ require('react-micro-app')ï¼Œè€Œæ˜¯ä½¿ç”¨åŠ¨æ€å¼•å…¥ï¼š

```js
import("react-micro-app").then(chunk => {})
```

> æ‰“ chunk æ˜¯å°†æ‡’åŠ è½½. å…¬å…±ä¾èµ–åˆ†ç¦»ï¼Œæ˜¯ webpack è‡ªåŠ¨åŒ–å¤„ç†çš„è¿‡ç¨‹ã€‚äº²æµ‹ä¼šæŠ¥é”™ï¼Œç›®å‰è¿˜ä¸çŸ¥é“å¯ä¸å¯è¡Œã€‚c:T1a00,æœ¬èŠ‚ç»§ç»­ä»‹ç»å¾®å‰ç«¯çš„å¦ä¸€ç§æ–¹æ¡ˆï¼šWeb Componentsã€‚å®ƒæ˜¯æ ¹æ®æµè§ˆå™¨åŸç”Ÿæ”¯æŒçš„ç»„ä»¶åŒ–æ–¹æ¡ˆæ¥å°è£…çš„å¾®åº”ç”¨ã€‚å…¶å®ç°æ–¹å¼ç±»ä¼¼äºåŠ¨æ€ script æ–¹æ¡ˆï¼Œ

![image.png](/img/posts/2024-1-8/2024-1-8-4.png)

[ä»“åº“åœ°å€ï¼štutorial/web-components-cookie åˆ†æ”¯](https://github.com/heiheihoho1213/monto-app/tree/tutorial/web-components-cookie)

## 1. ä¸»åº”ç”¨

è¿˜æ˜¯è€æ ·å­ï¼Œå¯åŠ¨ä¸€ä¸ªnodeæœåŠ¡ï¼š

```js
app.listen(port.main, host);
```

ç„¶åé…ç½®è¯·æ±‚å¾®æœåŠ¡åˆ—è¡¨çš„æ¥å£ï¼š

```js
app.post("/microapps", function (req, res) {

  console.log("main cookies: ", req.cookies);

  // è®¾ç½®ä¸€ä¸ªå“åº”çš„ Cookie æ•°æ®
  res.cookie("main-app", true);

  // è¿™é‡Œå¯ä»¥æ˜¯ç®¡ç†åå°æ–°å¢èœå•åå­˜å‚¨åˆ°æ•°æ®åº“çš„æ•°æ®
  // ä»è€Œå¯ä»¥é€šè¿‡ç®¡ç†åå°åŠ¨æ€é…ç½®å¾®åº”ç”¨çš„èœå•
  res.json([
    {
      name: "micro1",
      id: "micro1",
      // è‡ªå®šä¹‰å…ƒç´ åç§°
      customElement: "micro-app-1",
      // è¿™é‡Œæš‚æ—¶ä»¥ä¸€ä¸ªå…¥å£æ–‡ä»¶ä¸ºç¤ºä¾‹
      script: `http://${host}:${port.micro}/micro1.js`,
      style: `http://${host}:${port.micro}/micro1.css`,
      prefetch: true,
    },
    {
      name: "micro2",
      id: "micro2",
      customElement: "micro-app-2",
      script: `http://${host}:${port.micro}/micro2.js`,
      style: `http://${host}:${port.micro}/micro2.css`,
      prefetch: true,
    },
  ]);
});
```

ä¸»åº”ç”¨çš„ html é¡µé¢ä¸ åŠ¨æ€ script åŸºæœ¬é¡µé¢ä¸€è‡´ï¼Œè¿™é‡Œåªå±•ç¤ºä¸åŒä¹‹å¤„ï¼š

```js
hashChangeListener() {
  // Web Components æ–¹æ¡ˆ
  // å¾®åº”ç”¨çš„æ’æ§½
  const $slot = document.getElementById("micro-app-slot");

  window.addEventListener("hashchange", () => {
    this.microApps?.forEach(async (microApp) => {
      // Web Components æ–¹æ¡ˆ
      const $webcomponent = document.querySelector(
        `[micro-id=${microApp.id}]`
      );

      if (microApp.id === window.location.hash.replace("#", "")) {
        console.time(`fetch microapp ${microApp.name} static`);
        // åŠ è½½ CSS æ ·å¼
        microApp?.style &&
          !this.hasLoadStyle(microApp) &&
          (await this.loadStyle(microApp));
        // åŠ è½½ Script æ ‡ç­¾
        microApp?.script &&
          !this.hasLoadScript(microApp) &&
          (await this.loadScript(microApp));
        console.timeEnd(`fetch microapp ${microApp.name} static`);

        // åŠ¨æ€ Script æ–¹æ¡ˆ
        // window?.[microApp.mount]?.("#micro-app-slot");

        // Web Components æ–¹æ¡ˆ
        // å¦‚æœæ²¡æœ‰åœ¨ DOM ä¸­æ·»åŠ è‡ªå®šä¹‰å…ƒç´ ï¼Œåˆ™å…ˆæ·»åŠ å¤„ç†
        if (!$webcomponent) {
          // Web Components æ–¹æ¡ˆ
          // è‡ªå®šä¹‰å…ƒç´ çš„æ ‡ç­¾æ˜¯å¾®åº”ç”¨å…ˆå®šä¹‰å‡ºæ¥çš„ï¼Œç„¶ååœ¨æœåŠ¡ç«¯çš„æ¥å£é‡Œé€šè¿‡ customElement å±æ€§è¿›è¡Œçº¦å®š
          const $webcomponent = document.createElement(
            microApp.customElement
          );
          $webcomponent.setAttribute("micro-id", microApp.id);
          $slot.appendChild($webcomponent);
        // å¦‚æœå·²ç»å­˜åœ¨è‡ªå®šä¹‰å…ƒç´ ï¼Œåˆ™è¿›è¡Œæ˜¾ç¤ºå¤„ç†
        } else {
          $webcomponent.style.display = "block";
        }
      } else {
        this.removeStyle(microApp);
        // åŠ¨æ€ Script æ–¹æ¡ˆ
        // window?.[microApp.unmount]?.();

        // Web Components æ–¹æ¡ˆ
        // å¦‚æœå·²ç»æ·»åŠ äº†è‡ªå®šä¹‰å…ƒç´ ï¼Œåˆ™éšè—è‡ªå®šä¹‰å…ƒç´ 
        if ($webcomponent) {
          $webcomponent.style.display = "none";
        }
      }
    });
  });
}
```

## 2. å­åº”ç”¨æ”¹é€ 

å­åº”ç”¨ä¹Ÿå¯åŠ¨ä¸€ä¸‹ï¼š

```js
// è¿™é‡Œæå¸¦æ‰‹é…ç½®å­åº”ç”¨ ajax è¯·æ±‚çš„è·¨åŸŸ
app.use((req, res, next) => {
  // è·¨åŸŸè¯·æ±‚ä¸­æ¶‰åŠåˆ° Cookie ä¿¡æ¯ä¼ é€’ï¼Œå€¼ä¸èƒ½ä¸º *ï¼Œå¿…é¡»æ˜¯å…·ä½“çš„åœ°å€ä¿¡æ¯
  res.header("Access-Control-Allow-Origin", `http://ä½ çš„åŸŸå.com:${port.main}`);
  res.header("Access-Control-Allow-Methods", "GET, POST, OPTIONS");
  res.header("Allow", "GET, POST, OPTIONS");
  // å…è®¸è·¨åŸŸè¯·æ±‚æ—¶æºå¸¦ Cookie
  res.header("Access-Control-Allow-Credentials", true);
  next();
});

app.use(
  express.static(path.join("public", "micro"), {
    etag: true,
    lastModified: true,
  })
);

app.post("/cors", function (req, res) {
  console.log("micro cookies: ", req.cookies);

  // å¢åŠ  SameSite å’Œ Secure å±æ€§ï¼Œä»è€Œä½¿æµè§ˆå™¨æ”¯æŒ iframe å­åº”ç”¨çš„è·¨ç«™æºå¸¦ Cookie
  // æ³¨æ„ Secure éœ€è¦ HTTPS åè®®çš„æ”¯æŒ
  const cookieOptions = { sameSite: "none", secure: true };

  // è®¾ç½®ä¸€ä¸ªå“åº”çš„ Cookie æ•°æ®
  res.cookie("micro-app", true, cookieOptions);
  res.json({
    hello: "true",
  });
});

app.listen(port.micro, host);
```

å­åº”ç”¨çš„å…¥å£jsè¦æ”¹é€ ä¸€ä¸‹ï¼Œæš´éœ²å‡ºæ¥ç”Ÿå‘½å‘¨æœŸé’©å­ï¼š

```js
class MicroApp2Element extends HTMLElement {
  constructor() {
    super();
  }

  // [ç”Ÿå‘½å‘¨æœŸå›è°ƒå‡½æ•°] å½“ custom element è‡ªå®šä¹‰æ ‡ç­¾é¦–æ¬¡è¢«æ’å…¥æ–‡æ¡£ DOM æ—¶ï¼Œè¢«è°ƒç”¨
  connectedCallback() {
    console.log(`[micro-app-2]: æ‰§è¡Œ connectedCallback ç”Ÿå‘½å‘¨æœŸå›è°ƒå‡½æ•°`);
    // æŒ‚è½½åº”ç”¨
    // ç›¸å¯¹æ¯”åŠ¨æ€ Scriptï¼Œç»„ä»¶å†…éƒ¨å¯ä»¥è‡ªåŠ¨è¿›è¡Œ mount æ“ä½œï¼Œä¸éœ€è¦å¯¹å¤–æä¾›æ‰‹åŠ¨è°ƒç”¨çš„ mount å‡½æ•°ï¼Œä»è€Œé˜²æ­¢ä¸å¿…è¦çš„å…¨å±€å±æ€§å†²çª
    this.mount();
  }

  // [ç”Ÿå‘½å‘¨æœŸå›è°ƒå‡½æ•°] å½“ custom element ä»æ–‡æ¡£ DOM ä¸­åˆ é™¤æ—¶ï¼Œè¢«è°ƒç”¨
  disconnectedCallback() {
    console.log(
      `[micro-app-2]: æ‰§è¡Œ disconnectedCallback ç”Ÿå‘½å‘¨æœŸå›è°ƒå‡½æ•°`
    );
    // å¸è½½å¤„ç†
    this.unmount();
  }

  mount() {
    const $micro = document.createElement("h1");
    $micro.textContent = "å¾®åº”ç”¨2";
    // å°†å¾®åº”ç”¨çš„å†…å®¹æŒ‚è½½åˆ°å½“å‰è‡ªå®šä¹‰å…ƒç´ ä¸‹
    this.appendChild($micro);

    // æ–°å¢ Ajax è¯·æ±‚ï¼Œç”¨äºè¯·æ±‚ micro1.js æ‰€åœ¨çš„æœåŠ¡
    // éœ€è¦æ³¨æ„ micro1.js åŠ¨æ€åŠ è½½åœ¨ä¸»åº”ç”¨ localhost:4000 ä¸‹ï¼Œå› æ­¤è¯·æ±‚æ˜¯è·¨åŸŸçš„
    window
      .fetch("http://30.120.112.54:3000/cors", {
        method: "post",
        credentials: "include"
      })
      .then((res) => res.json())
      .catch((err) => {
        console.error(err);
      });
  }
}

window.customElements.define("micro-app-2", MicroApp2Element);
```

å¯¹æ¯”äºåŠ¨æ€Scriptæ–¹æ¡ˆï¼ŒWeb Componentsæ–¹æ¡ˆæœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š

- ä¸éœ€è¦å¯¹å¤–æŠ›å‡ºå…¨å±€APIï¼ˆæŒ‚è½½ä¸å¸è½½ï¼‰ï¼ŒWeb Components å¤©ç„¶æ”¯æŒï¼Œå¯å¤ç”¨æ€§æ›´å¼ºã€‚
- æ›´æ ‡å‡†åŒ–ï¼ŒWeb Componentsçš„èƒ½åŠ›åç»­ä¼šéšç€w3cæ ‡å‡†é€æ­¥æå‡ã€‚
- ä¹Ÿæ˜¯åŠ¨æ€ script çš„ä¼˜ç‚¹ï¼šå¯ä»¥éå¸¸ä¾¿æ·çš„è¿›è¡Œç§»æ¤å’Œç»„ä»¶æ›¿æ¢

å½“ç„¶ï¼ŒWeb Componentsè¿˜æ˜¯å­˜åœ¨ä¸€äº›ä¸è¶³ï¼š

- å…¼å®¹æ€§é—®é¢˜ã€‚å¯¹æ—§ç‰ˆæœ¬æµè§ˆå™¨å…¼å®¹æ€§ä¸å¥½ã€‚
- æœ‰ä¸€å®šä¸Šæ‰‹éš¾åº¦ï¼Œéœ€è¦é¢å¤–å­¦ä¹ Web Componentsç›¸å…³çŸ¥è¯†ã€‚
- å­åº”ç”¨æ˜¯ä¾µå…¥å¼çš„d:T2106,æœ¬èŠ‚ç»§ç»­ä»‹ç»å¾®å‰ç«¯çš„å¦ä¸€ç§æ–¹æ¡ˆï¼šNPM

NPM åŒ…æ˜¯å¾®å‰ç«¯è®¾è®¡æ–¹æ¡ˆä¹‹ä¸€ï¼Œåœ¨è®¾è®¡æ—¶éœ€è¦å°†å¾®åº”ç”¨æ‰“åŒ…æˆç‹¬ç«‹çš„ NPM åŒ…ï¼Œç„¶ååœ¨ä¸»åº”ç”¨ä¸­å¼•å…¥å’Œä½¿ç”¨ã€‚

## 1. èƒŒæ™¯çŸ¥è¯†

æˆ‘ä»¬ä¸€èˆ¬è¿™æ ·åœ¨é¡¹ç›®ä¸­å¼•å…¥ jsï¼š

```html
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
  </head>
  <body>
    <script src="a.js"></script>
    <script src="b.js"></script>
    <script src="c.js"></script>
    <script src="d.js"></script>
  </body>
</html>
```

å¦‚æœæœ‰ç¬¬ä¸‰æ–¹ä¾èµ–ï¼Œé‚£ä¹ˆéœ€è¦æŒ‰ç…§é¡ºåºæ¥åŠ è½½ï¼š

```html
<body>
  <script>
    // æœªåŠ è½½ lodash æ—¶ï¼Œæ— æ³•è·å– _ å˜é‡
    // Uncaught ReferenceError: _ is not defined
    console.log(_); 
  </script>

  <script src="https://cdn.bootcdn.net/ajax/libs/lodash.js/4.17.21/lodash.min.js"></script>
  
  <script>
    // åŠ è½½ lodash ä¹‹åï¼Œå¯ä»¥è·å– _ å˜é‡
    // Æ’ Mc(n,t,r){var e=null==n?X:_e(n,t);return e===X?r:e}
    console.log(_.get); 
  </script>
</body>
```

ä½†æ˜¯è¿™æ ·åŠ è½½æœ‰ä¸ªé—®é¢˜ï¼Œä¼šé€ æˆå˜é‡æ±¡æŸ“ï¼š

```html
<body>
  <script>
    const _ = 111;
  </script>
  
  <script>
    console.log(_); // 111
  </script>
  
  <script src="https://cdn.bootcdn.net/ajax/libs/lodash.js/4.17.21/lodash.min.js"></script>
  
  <script>
    console.log(_); // 111
    console.log(_.get); // undefined
  </script>
</body>
```

## 2. NPM åŠ è½½

ä¸Šé¢çš„ä¾‹å­ï¼Œå…¨å±€åŠ è½½çš„ lodash å°±å¤±æ•ˆäº†ã€‚å¦‚æœé¡¹ç›®å¾ˆå¤æ‚ï¼Œä¸Šè¿°çš„æƒ…å†µå°±å¾ˆä¸å¥½å¤„ç†äº†ã€‚ä¸ºäº†è§£å†³ä¸Šè¿°é—®é¢˜ï¼ŒJavaScript å¼€å§‹æä¾›ä¸€ç§å°†ç¨‹åºæ‹†åˆ†ä¸ºå¯æŒ‰éœ€å¯¼å…¥çš„å•ç‹¬æ¨¡å—ï¼Œæˆ‘ä»¬å°±ä½¿ç”¨ç›®å‰é€šç”¨çš„ ESModule æ¨¡å—æ¥è¿›è¡Œæ‹†åˆ†ã€‚

[ä»“åº“åœ°å€ï¼štutorial/npm-esmodule åˆ†æ”¯](https://github.com/heiheihoho1213/monto-app/tree/tutorial/npm-esmodule)

é¡¹ç›®ç»“æ„ï¼š

```shell
â”œâ”€â”€ public                 # æ‰˜ç®¡çš„é™æ€èµ„æºç›®å½•
â”‚   â”œâ”€â”€ custom_modules/    # è‡ªå®šä¹‰æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ add.js                         
â”‚   â”‚   â””â”€â”€ conflict.js                                        
â”‚   â”œâ”€â”€ node_modules/      # ä¸‰æ–¹æ¨¡å—
â”‚   â”‚   â””â”€â”€ lodash-es/        
â”‚   â””â”€â”€ index.html         # åº”ç”¨é¡µé¢
â””â”€â”€ app.js
```

custom_modules ä¸­æˆ‘ä»¬å†™å…¥å‡ ä¸ªè‡ªå®šä¹‰çš„ä¾èµ–æ–¹æ³•ï¼š

```js
// add.js
export function add(a, b) {
  return a + b;
}

// conflict.js
const _ = 111;
console.log('conflict.js --> ', _)
```

æˆ‘ä»¬å¯åŠ¨ä¸€ä¸ªæœ¬åœ°çš„ node æœåŠ¡æ¥è®¿é—® js æ–‡ä»¶ã€‚åœ¨ index.html ä¸­å†™å…¥ï¼š

```html
<script type="importmap">
  {
    "imports": {
      "custom_modules/": "/custom_modules/",
      "lodash/": "/node_modules/lodash-es/",
      "lodash": "/node_modules/lodash-es/lodash.js"
    }
  }
</script>
```

> import-maps å­˜åœ¨æµè§ˆå™¨å…¼å®¹æ€§é—®é¢˜ï¼Œå¯ä»¥æ‰¾ç›¸åº”çš„ polyfill è¿›è¡Œå…¼å®¹æ€§å¤„ç†ã€‚

å…ˆå£°æ˜ npm åŒ…çš„æ˜ å°„å…³ç³»ã€‚

ç„¶åæŒ‰ç…§æ¨¡å—ä½ å¼•å…¥ï¼š

```html
<script type="module">
  // è‡ªå®šä¹‰æ¨¡å— - add å‡½æ•°
  import { add } from "custom_modules/add.js";
  // è‡ªå®šä¹‰æ¨¡å— - é˜²å†²æ’æµ‹è¯• (_ å˜é‡)
  import "custom_modules/conflict.js";
  // ä¸‰æ–¹æ¨¡å— - æŒ‰éœ€å¼•å…¥ lodash
  import isNull from "lodash/isNull.js";

  console.log(isNull);  // Function
  console.log(add(1, 2)); // 3

  // åœ¨ confilict.js ä¸­å£°æ˜çš„ const _ = 111; ä¸ä¼šä½œç”¨åœ¨å½“å‰è„šæœ¬ä¸­
  console.log(_);  // Uncaught ReferenceError: _ is not defined
</script>
```

æ­¤æ—¶å°±ä¸ä¼šæœ‰å…¨å±€æ±¡æŸ“äº†ï¼Œè‡ªå·±çš„å˜é‡åªåœ¨è‡ªå·±çš„npmä½œç”¨èŒƒå›´å†…ç”Ÿæ•ˆï¼Œç¬¬ä¸‰æ–¹åŒ…ä½¿ç”¨æŒ‰éœ€åŠ è½½å³å¯ã€‚æ­¤æ—¶å°±ä¸ç”¨è€ƒè™‘åŠ è½½é¡ºåºäº†ã€‚

![image.png](/img/posts/2024-1-8/2024-1-8-1.png)

ESM åŠ è½½æ–¹å¼æœ‰å¦‚ä¸‹ä¼˜ç‚¹ï¼š

- ä¸éœ€è¦æ„å»ºå·¥å…·è¿›è¡Œæ‰“åŒ…å¤„ç†ï¼›
- å¤©ç„¶æŒ‰éœ€å¼•å…¥ï¼Œå¹¶ä¸”ä¸éœ€è¦è€ƒè™‘æ¨¡å—çš„åŠ è½½é¡ºåºï¼›
- æ¨¡å—åŒ–ä½œç”¨åŸŸï¼Œä¸éœ€è¦è€ƒè™‘å˜é‡åå†²çªé—®é¢˜ã€‚

## 3. NPM å¾®æœåŠ¡æ–¹æ¡ˆ

åº”ç”¨çš„æ„å»ºéœ€è¦ç”Ÿæˆ HTML æ–‡ä»¶å¹¶æ‰“åŒ… JS. CSS ä»¥åŠå›¾ç‰‡ç­‰é™æ€èµ„æºï¼Œä¸šåŠ¡ç»„ä»¶çš„æ„å»ºæ›´å¤šçš„æ˜¯æ‰“åŒ…æˆåº”ç”¨éœ€è¦é€šè¿‡æ¨¡å—åŒ–æ–¹å¼å¼•å…¥ä½¿ç”¨çš„ JavaScript åº“ã€‚

åº”ç”¨åœ¨æ„å»ºæ—¶ä¸ºäº†æå‡æ„å»ºé€Ÿåº¦ï¼ŒåŒæ—¶ä¹Ÿä¸ºäº†ç®€åŒ–æ„å»ºé…ç½®ï¼Œé€šå¸¸åœ¨ä½¿ç”¨ babel-loader ï¼ˆè½¬è¯‘å·¥å…·ï¼‰è¿›è¡Œè½¬è¯‘æ—¶ ï¼Œ ä¼šå±è”½ node_modules ç›®å½•ä¸‹çš„ NPM åŒ…ï¼Œå› æ­¤éœ€è¦å°†å‘å¸ƒçš„ NPM ç»„ä»¶è½¬è¯‘æˆå¤§å¤šæ•°æµè§ˆå™¨èƒ½å¤Ÿå…¼å®¹çš„ ES5 æ ‡å‡†ã€‚

![image.png](/img/posts/2024-1-8/2024-1-8-2.png)

NPM çš„å¾®å‰ç«¯è®¾è®¡æ–¹æ¡ˆä¸­ï¼Œå„ä¸ªå¾®åº”ç”¨å¯ä»¥é‡‡ç”¨ä¸åŒçš„æŠ€æœ¯æ ˆï¼Œä½†æ˜¯æ„å»ºæ—¶éœ€è¦åƒå‘å¸ƒä¸šåŠ¡ç»„ä»¶ä¸€æ ·è¾“å‡º ES5 & æ¨¡å—åŒ–æ ‡å‡†çš„ JavaScript åº“ï¼ˆå°½ç®¡å¼€å‘çš„æ˜¯åº”ç”¨ï¼Œä½†æ˜¯æ„å»ºçš„ä¸æ˜¯åº”ç”¨ç¨‹åºï¼Œä¸éœ€è¦é¢å¤–ç”Ÿæˆ HTMLï¼‰ï¼Œä»è€Œä½¿ä¸»åº”ç”¨å®‰è£…å„è‡ªçš„ä¾èµ–æ—¶ï¼Œå¯ä»¥é€šè¿‡æ¨¡å—åŒ–çš„æ–¹å¼å¼•å…¥å¾®åº”ç”¨ã€‚ä¸»åº”ç”¨ä¸éœ€è¦å…³å¿ƒå¾®åº”ç”¨çš„æŠ€æœ¯æ ˆï¼Œä¸éœ€è¦å…³å¿ƒå¾®åº”ç”¨çš„æ„å»ºé…ç½®é¡¹ã€‚

æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ª [demo](https://github.com/heiheihoho1213/monto-app/tree/tutorial/npm-micro)

ä¸»åº”ç”¨æˆ‘ä»¬å‡è®¾ä½¿ç”¨ vueï¼Œè®¾ç½®å­åº”ç”¨çš„è·¯ç”±ï¼š

```js
import ReactApp from "./React";
import VueApp from "./Vue";
const router = createBrowserRouter([
  {
    path: "/",
    element: <App />,
    children: [
      {
        path: "react",
        element: <ReactApp />,
      },
      {
        path: "vue",
        element: <VueApp />,
      },
    ],
  },
]);
```

å„ä¸ªå­åº”ç”¨çš„å…¥å£éœ€è¦æ”¹é€ ï¼Œæˆ‘ä»¬ä»¥ react ä¸ºä¾‹ï¼š

```js
// package.json åç§°ï¼šreact-micro-app
let root;

export function mount(containerId) {
  console.log("react app mount");
  root = ReactDOM.createRoot(document.getElementById(containerId));
  root.render(
    <React.StrictMode>
      <App />
    </React.StrictMode>
  );
}

export function unmount() {
  console.log("react app unmount: ", root);
  root && root.unmount();
}
```

å­åº”ç”¨éƒ¨ç½²ä¸º npm å¹¶å‘å¸ƒåï¼Œä¸»åº”ç”¨ç›´æ¥å¼•å…¥ï¼ˆè¿™é‡Œä½¿ç”¨ lernaï¼‰ç®¡ç†ï¼š

```js
// ä¸»åº”ç”¨å¼•å…¥
// React.js
const { mount, unmount } = require("react-micro-app");
import React, { useEffect } from "react";

const containerId = 'react-app';

function ReactApp() {
  useEffect(() => {
    mount(containerId);
    return () => {
      unmount();
    };
  }, []);
  return <div id={containerId}></div>;
}

export default React.memo(ReactApp);
```
å¦‚æœä¸æƒ³é¢å¤–å¼•å…¥å¾®åº”ç”¨çš„ CSS æ ·å¼ï¼Œé‚£ä¹ˆå¯ä»¥å°†æ ·å¼å†…è”åˆ° JS ä¸­ï¼Œå½“ç„¶å…¶å®ƒçš„ä¸€äº›é™æ€èµ„æºä¹Ÿéœ€è¦å†…è”åˆ° JS ä¸­ï¼Œé€šè¿‡ Webpack å¯ä»¥è¿›è¡Œå¾ˆå¥½çš„å¤„ç†ã€‚
ç”±äºéœ€è¦æ„å»ºæˆç±»ä¼¼äºåº“åŒ…çš„æ¨¡å—åŒ–è§„èŒƒï¼Œå­åº”ç”¨éœ€è¦æ›´æ”¹ Webpack çš„é…ç½® (ä»¥ vue ä¸ºä¾‹)ï¼š

```js
module.exports = defineConfig({
  transpileDependencies: true,
  // å†…è” CSS æ ·å¼å¤„ç†
  css: { extract: false }
});
```

> æ€è€ƒï¼šæœ‰æ²¡æœ‰æ–¹æ³•å¯ä»¥åšåˆ°ä¸»åº”ç”¨å¼•å…¥æ–¹å¼ä¸å˜çš„æƒ…å†µä¸‹ï¼Œåœ¨å¼€å‘æ€å¼•å…¥çš„æ˜¯å¾®åº”ç”¨çš„æºç ï¼ˆä¿®æ”¹å¾®åº”ç”¨çš„ä»£ç åä¸éœ€è¦æ„å»ºï¼Œç›´æ¥åœ¨ä¸»åº”ç”¨ä¸­ä¼šçƒ­æ›´æ–°å˜æ›´ï¼‰ï¼Œè€Œåœ¨ç”Ÿäº§æ€å¼•å…¥çš„æ˜¯å¾®åº”ç”¨æ„å»ºåå‘å¸ƒçš„ NPM åŒ…ï¼Œè¿™ç§é…ç½®åœ¨å•ä¸ªä¸šåŠ¡ç»„ä»¶çš„å¼€å‘ä¸­å°¤ä¸ºé‡è¦ ?

> å¼€å‘æ—¶å°†ä¾èµ–çš„åº”ç”¨æ‹‰ä¸‹æ¥åˆ°æœ¬åœ°ï¼Œå¹¶åšå…³è”ï¼ˆæ¯”å¦‚ lernaï¼‰åå¯åŠ¨å¼€å‘åº”ç”¨ã€‚å¯åŠ¨å™¨ä¸­æ£€æµ‹æœ¬åœ°æœ‰å°±ä½¿ç”¨æœ¬åœ°ï¼Œæ²¡æœ‰å°±ä½¿ç”¨ npm ä¸‹è½½ä½¿ç”¨ï¼Ÿ

NPM æ–¹æ¡ˆä¼˜ç‚¹ï¼š

- å¯ä»¥æŒ‰ç…§ UMD. CommonJS æˆ–è€… ESM ç­‰ä¸åŒè§„èŒƒè¿›è¡Œå¼•å…¥ï¼Œä¸åŒä¾èµ–åº“é—´ä¹Ÿæ²¡æœ‰å¼ºä¾èµ–
- ä¸éœ€è¦å•ç‹¬çš„æœåŠ¡å™¨è¿›è¡Œéƒ¨ç½²ä»¥åŠèµ„æºæ‰˜ç®¡ï¼Œåªéœ€è¦å‘å¸ƒåˆ°npmä»“åº“å³å¯ã€‚
- å¤ç”¨æ€§å¥½ï¼Œå¯ä»¥ä»»æ„ç»„åˆæˆä¸åŒçš„å¾®å‰ç«¯ç³»ç»Ÿã€‚
- å¯ä»¥å…±äº«åŒä¸€ä¸ªæ¸²æŸ“è¿›ç¨‹ï¼Œå¤©ç„¶å…±äº« windowï¼Œä¸Šä¸‹æ–‡åŠå†…å­˜æ•°æ®ã€‚
- ä¸»å­åº”ç”¨å¤©ç„¶åŒåŸŸ


ç¼ºç‚¹ï¼š

- ä¸»åº”ç”¨éœ€è¦ä¸€ä¸ªå¸¦è·¯ç”±çš„æ¡†æ¶ï¼Œæ— æ³•åšåˆ°æŠ€æœ¯æ— å…³ã€‚
- æ— æ³•å¤„ç†ä¸»å­åº”ç”¨æ ·å¼å†²çª
- å¾®åº”ç”¨çš„æ„å»ºéœ€è¦åšé¢å¤–çš„é…ç½®ï¼Œå› ä¸ºæ„å»ºçš„ä¸æ˜¯åº”ç”¨ï¼Œè€Œæ˜¯ä¾èµ–åº“ã€‚
- å¾®åº”ç”¨å‘å¸ƒæ–°ç‰ˆæœ¬åï¼Œä¸»åº”ç”¨éƒ½éœ€è¦é‡æ–°å®‰è£…å¹¶æ„å»ºéƒ¨ç½²ï¼Œæ— æ³•åšåˆ°å­åº”ç”¨ç‹¬ç«‹å¯åŠ¨å’Œéƒ¨ç½²ã€‚
- ä¾èµ– webpack ç­‰æ‰“åŒ…å·¥å…·
- å½“å¾®åº”ç”¨è¿‡å¤šï¼Œè¿˜éœ€è¦è€ƒè™‘ä½“ç§¯è¿‡å¤§çš„ä¼˜åŒ–é—®é¢˜ï¼Œæ¯”å¦‚å…¬å…±æ¡†æ¶æŠ½ç¦»ï¼Œä»£ç åˆ†å‰²ç­‰ã€‚
- å­åº”ç”¨æ— æ³•ç‹¬ç«‹éƒ¨ç½²å’Œå¼€å‘

é—ç•™é—®é¢˜ï¼š

- ä¸»åº”ç”¨ä¸å­åº”ç”¨å…¨å±€å˜é‡æ±¡æŸ“
- CSS æ ·å¼å†²çª
- å­˜å‚¨æ•°æ®å†²çªe:T2645,æœ¬èŠ‚å¼€å§‹å¾®å‰ç«¯é¡¹ç›®çš„ä»‹ç»ã€‚

## 1. èƒŒæ™¯çŸ¥è¯†

ä¸€ä¸ªå¥½çš„å¾®å‰ç«¯æ¶æ„ï¼Œåº”è¯¥å…·å¤‡å¦‚ä¸‹ç‰¹ç‚¹ï¼š

- SPA ä½“éªŒï¼šå¾®å‰ç«¯å¯ä»¥ä½¿æ‰€æœ‰çš„åº”ç”¨ä¿æŒåŸæœ‰çš„ SPA ä½“éªŒï¼Œç»Ÿä¸€å“ç‰Œè®¤çŸ¥ï¼›
- æŠ€æœ¯æ ˆæ— å…³ï¼šå¯ä»¥ä½¿ç”¨ä¸åŒçš„æŠ€æœ¯æ ˆï¼ˆä¾‹å¦‚ React. Vue. Svelte ï¼‰å¼€å‘ï¼Œæ”¯æŒç‹¬ç«‹éƒ¨ç½²ï¼›
- æ€§èƒ½ä¼˜åŒ–ï¼š åœ¨ MPA å’Œ iframe ä¸­å¦‚æœæƒ³è¦åšæ€§èƒ½ä¼˜åŒ–ï¼Œå¾€å¾€éœ€è¦ä¾èµ–æµè§ˆå™¨å’Œ HTTP çš„èƒ½åŠ›ï¼Œè€Œåœ¨å¾®å‰ç«¯ä¸­å¯ä»¥å¤„ç†åº”ç”¨èµ„æºçš„å»é‡. åº”ç”¨è‡ªèº«çš„é¢„åŠ è½½. é¢„æ¸²æŸ“å’Œç¼“å­˜å¤„ç†ï¼Œä¹Ÿå¯ä»¥å¯¹å·²åŠ è½½çš„é¡µé¢è¿›è¡Œä¿æ´»å¤„ç†ï¼Œå¢åŠ äº†æ€§èƒ½ä¼˜åŒ–çš„æ‰‹æ®µï¼›
- è§£è€¦é‡æ„ï¼šéƒ¨åˆ†ä½ä»£ç é¡µé¢æ— æ³•æ»¡è¶³æ€§èƒ½è¦æ±‚æ—¶ï¼Œå¯ä»¥é€šè¿‡æ–°çš„æŠ€æœ¯æ ˆå°†é¡µé¢è¿›è¡Œé‡æ„ï¼Œä¸å½±å“å…¶ä»–ä½ä»£ç é¡µé¢çš„è¿è¡Œï¼Œä»è€Œå¯ä»¥å‡å°‘é‡æ„å¸¦æ¥çš„å½±å“é¢ã€‚
- ç‹¬ç«‹æ€§ï¼šç‹¬ç«‹å¼€å‘. ç‹¬ç«‹éƒ¨ç½²å’Œç‹¬ç«‹è¿è¡Œ

**ä¸ºä»€ä¹ˆä½¿ç”¨å¾®å‰ç«¯**ï¼šå¾®å‰ç«¯å¯ä»¥é™ä½å¤§å‹å¤æ‚åº”ç”¨çš„å¼€å‘. å‡çº§. ç»´æŠ¤ä»¥åŠå›¢é˜Ÿåä½œçš„æˆæœ¬ã€‚å½“ç„¶ï¼Œè§£å†³å†å²é—ç•™çš„éš¾ä»¥å¼€å‘. å‡çº§å’Œç»´æŠ¤çš„å¤§å‹åº”ç”¨ï¼Œä¹Ÿæ˜¯ä½¿ç”¨å¾®å‰ç«¯çš„ä¸€ä¸ªé‡è¦åŸå› ã€‚

web æ¶æ„æ¼”è¿›ï¼š

![image.png](/img/posts/2024-1-3/2024-1-3-2.png)

ä½¿ç”¨å¾®å‰ç«¯ï¼š

![image.png](/img/posts/2024-1-3/2024-1-3-3.png)

å…¶åœ¨ä¼ä¸šä¸­çš„ä¸šåŠ¡åœºæ™¯ï¼š

![image.png](/img/posts/2024-1-3/2024-1-3-4.png)

ç„¶è€Œå¾®å‰ç«¯ä¸æ˜¯ä¸‡èƒ½çš„ï¼Œä¾‹å¦‚ä»¥ä¸‹åœºæ™¯å¯èƒ½å¹¶ä¸éœ€è¦å¾®å‰ç«¯ï¼š

- åº”ç”¨çš„ä¸šåŠ¡å•ä¸€ï¼Œä¸å­˜åœ¨å¤šä¸ªå›¢é˜Ÿå¹¶è¡Œå¼€å‘çš„æƒ…å†µï¼Œä¸éœ€è¦å…¼å®¹ä¸åŒçš„æŠ€æœ¯æ ˆï¼›
- åº”ç”¨çš„åŠŸèƒ½å·²ç»éå¸¸å®Œå–„ï¼Œä¸å­˜åœ¨å¤§é‡æ–°éœ€æ±‚å¼€å‘çš„å¯èƒ½æ€§ï¼›
- é¡¹ç›®ç»„ä¸æƒ³èŠ±è´¹å¤§é‡çš„æ—¶é—´åœ¨åº”ç”¨çš„æ”¹é€ ä¸Šï¼Œä»¥ç°æœ‰åº”ç”¨çš„ç¨³å®šæ€§ä¸ºä¸»ï¼›
- åº”ç”¨è¿›è¡Œå¾®å‰ç«¯æ”¹é€ çš„æˆæœ¬è¿˜ä¸å¦‚ç›´æ¥æ”¹é€ å½“å‰å­˜é‡åº”ç”¨å¸¦æ¥çš„æ”¶ç›Šå¤§ï¼›
- å›¢é˜Ÿå†…å¼€å‘äººå‘˜ä¸ç†Ÿæ‚‰å¾®å‰ç«¯ï¼Œæ— æ³•åº”å¯¹å¾®å‰ç«¯æ¶æ„çš„å¤æ‚æ€§ã€‚

## 2. æµè§ˆå™¨éš”ç¦»

æµè§ˆå™¨æ˜¯å¤šè¿›ç¨‹æ¶æ„ï¼Œåœ¨æ¸²æŸ“é¡µé¢æ—¶ï¼Œç†è®ºä¸Šä¸åŒçš„ç«™ç‚¹ä¼šå¯ç”¨ä¸åŒçš„æ¸²æŸ“è¿›ç¨‹ï¼ˆRendererï¼‰ï¼Œä»–ä»¬ä¹‹é—´æ˜¯ç›¸äº’éš”ç¦»çš„ã€‚Chrome æµè§ˆå™¨åœ¨è¿›è¡Œæ²™ç®±è®¾è®¡æ—¶ï¼Œä¼šå°½å¯èƒ½çš„å¤ç”¨ç°æœ‰æ“ä½œç³»ç»Ÿçš„æ²™ç®±æŠ€æœ¯ï¼Œä¾‹å¦‚ä»¥ Windows æ“ä½œç³»ç»Ÿçš„æ²™ç®±æ¶æ„ä¸ºä¾‹ï¼Œæ‰€æœ‰çš„æ²™ç®±éƒ½ä¼šåœ¨è¿›ç¨‹ç²’åº¦è¿›è¡Œæ§åˆ¶ï¼Œæ‰€æœ‰çš„è¿›ç¨‹éƒ½é€šè¿‡ IPC è¿›è¡Œé€šä¿¡ã€‚

![image.png](/img/posts/2024-1-3/2024-1-3-5.png)

åœ¨ Chrome æµè§ˆå™¨ä¸­æ²™ç®±éš”ç¦»ä»¥ Renderer è¿›ç¨‹ä¸ºå•ä½ï¼Œè€Œåœ¨æ—§ç‰ˆçš„æµè§ˆå™¨ä¸­ä¼šå­˜åœ¨å¤šä¸ª **Web åº”ç”¨å…±äº«åŒä¸€ä¸ª Renderer è¿›ç¨‹**çš„æƒ…å†µï¼Œæ­¤æ—¶æµè§ˆå™¨ä¼šä¾é åŒæºç­–ç•¥æ¥é™åˆ¶ä¸¤ä¸ªä¸åŒæºçš„æ–‡æ¡£è¿›è¡Œäº¤äº’ï¼Œå¸®åŠ©éš”ç¦»æ¶æ„æ–‡æ¡£æ¥å‡å°‘å®‰å…¨é£é™©ã€‚

ä½†æ˜¯è€å¼æµè§ˆå™¨æœªå¯ç”¨ç«™ç‚¹éš”ç¦»ï¼Œæ ‡ç­¾é¡µåº”ç”¨å’Œå†…éƒ¨çš„ iframe åº”ç”¨ä¼šå¤„äºåŒä¸€ä¸ª Renderer è¿›ç¨‹ï¼ŒWeb åº”ç”¨æœ‰å¯èƒ½å‘ç°å®‰å…¨æ¼æ´å¹¶ç»•è¿‡åŒæºç­–ç•¥çš„é™åˆ¶ï¼Œè®¿é—®åŒä¸€ä¸ªè¿›ç¨‹ä¸­çš„å…¶ä»– Web åº”ç”¨ï¼Œå› æ­¤å¯èƒ½äº§ç”Ÿå¦‚ä¸‹å®‰å…¨é£é™©ï¼š

- è·å–è·¨ç«™ç‚¹ Web åº”ç”¨çš„ Cookie å’Œ HTML 5 å­˜å‚¨æ•°æ®ï¼›
- è·å–è·¨ç«™ç‚¹ Web åº”ç”¨çš„ HTML. XML å’Œ JSON æ•°æ®ï¼›
- è·å–æµè§ˆå™¨ä¿å­˜çš„å¯†ç æ•°æ®ï¼›
- å…±äº«è·¨ç«™ç‚¹ Web åº”ç”¨çš„æˆæƒæƒé™ï¼Œä¾‹å¦‚åœ°ç†ä½ç½®ï¼›
- ç»•è¿‡ X-Frame-Options åŠ è½½ iframe åº”ç”¨ï¼ˆä¾‹å¦‚ç™¾åº¦çš„é¡µé¢è¢« iframe åµŒå¥—ï¼‰ï¼›
- è·å–è·¨ç«™ç‚¹ Web åº”ç”¨çš„ DOM å…ƒç´ ã€‚

## 3. iframe æ–¹æ¡ˆ

[ä»“åº“åœ°å€ï¼šdemo/iframe-isolate åˆ†æ”¯](https://github.com/heiheihoho1213/monto-app/tree/tutorial/iframe-isolate)

åœ¨ Chrome 67 ç‰ˆæœ¬ä¹‹åï¼Œä¸ºäº†é˜²å¾¡å¤šä¸ªè·¨ç«™çš„ Web åº”ç”¨å¤„äºåŒä¸€ä¸ª Renderer è¿›ç¨‹è€Œå¯èƒ½äº§ç”Ÿçš„å®‰å…¨é£é™©ï¼Œ**æµè§ˆå™¨ä¼šç»™æ¥è‡ªä¸åŒç«™ç‚¹çš„ Web åº”ç”¨åˆ†é…ä¸åŒçš„ Renderer è¿›ç¨‹**ã€‚ä¾‹å¦‚å½“å‰æ ‡ç­¾é¡µåº”ç”¨ä¸­åŒ…å«äº†å¤šä¸ªä¸åŒç«™ç‚¹çš„ iframe åº”ç”¨ï¼Œé‚£ä¹ˆæµè§ˆå™¨ä¼šä¸ºå„è‡ªåˆ†é…ä¸åŒçš„ Renderer è¿›ç¨‹ï¼Œä»è€Œå¯ä»¥åŸºäºæ²™ç®±ç­–ç•¥è¿›è¡Œåº”ç”¨çš„è¿›ç¨‹éš”ç¦»ï¼Œç¡®ä¿æ”»å‡»è€…éš¾ä»¥ç»•è¿‡å®‰å…¨æ¼æ´ç›´æ¥è®¿é—®è·¨ç«™ Web åº”ç”¨ã€‚

ä¸»åº”ç”¨é‡Œå®šä¹‰ï¼š

```html
<body>
  <h1>main åº”ç”¨</h1>
  <button onclick="javascript:window.open('<%= iframeUrl %>')">åœ¨æ–°çš„æ ‡ç­¾é¡µæ‰“å¼€ iframe åº”ç”¨</button>
  <br>
  <!-- åŒç«™åº”ç”¨ï¼šiframe.html -->
  <iframe src="<%= iframeUrl %>"></iframe>
  <!-- è·¨ç«™åº”ç”¨: -->
  <iframe src="https://nextjs.org/"></iframe>
</body>
```

å­åº”ç”¨é‡Œå®šä¹‰ï¼š

```html
<body>
  <h1>åŒç«™çš„ iframe åº”ç”¨</h1>
  <button onclick="javascript:alert('æˆ‘æ˜¯å¼¹çª—')">ç‚¹æˆ‘æœ‰å¼¹çª—</button>
</body>
```

ç„¶ååœ¨ä¸»æœåŠ¡é‡Œå†™å…¥å­åº”ç”¨çš„åœ°å€ï¼š

```js
app.get("/", function (req, res) {
  // ä½¿ç”¨ ejs æ¨¡ç‰ˆå¼•æ“å¡«å……ä¸»åº”ç”¨ views/main.html ä¸­çš„ iframeUrl å˜é‡ï¼Œå¹¶å°†å…¶æ¸²æŸ“åˆ°æµè§ˆå™¨
  res.render("main", {
    // å¡«å…… iframe åº”ç”¨çš„åœ°å€ï¼Œåªæœ‰ç«¯å£ä¸åŒï¼Œiframe åº”ç”¨å’Œ main åº”ç”¨è·¨åŸŸä½†æ˜¯åŒç«™ï¼Œå¯ä»¥ä½¿ç”¨ åŒç«™åº”ç”¨é€šè¿‡ä¿®æ”¹ document.domain è¿›è¡Œé€šä¿¡
    iframeUrl: `http://${host}:${port.micro}`
  });
});
```

å­åº”ç”¨ä¹Ÿä½¿ç”¨å•ç‹¬çš„æœåŠ¡å¯åŠ¨å³å¯ï¼š

![image.png](/img/posts/2024-1-3/2024-1-3-1.png)

## 4. iframe æµè§ˆä¸Šä¸‹æ–‡

åˆ¤æ–­ä¸€ä¸ªé¡µé¢æ˜¯ä¸æ˜¯åœ¨ iframe ä¸­è¢«æ‰“å¼€ï¼Œå¯ä»¥é€šè¿‡å¦‚ä¸‹ä»£ç ï¼š

```js
// é€šè¿‡è®¿é—® window.top å¯ä»¥è·å–å½“å‰æµè§ˆä¸Šä¸‹æ–‡çš„é¡¶çº§æµè§ˆä¸Šä¸‹æ–‡ window å¯¹è±¡ï¼Œé€šè¿‡è®¿é—® window.parent å¯ä»¥è·å–çˆ¶æµè§ˆä¸Šä¸‹æ–‡çš„ window å¯¹è±¡ã€‚
if(window.top !== window) {}
```

å¦‚æœä¸»åº”ç”¨æ˜¯åœ¨ç©ºç™½çš„æ ‡ç­¾é¡µæ‰“å¼€ï¼Œé‚£ä¹ˆä¸»åº”ç”¨æ˜¯ä¸€ä¸ªé¡¶çº§æµè§ˆä¸Šä¸‹æ–‡ï¼Œé¡¶çº§æµè§ˆå™¨ä¸Šä¸‹æ–‡æ—¢ä¸æ˜¯åµŒå¥—çš„æµè§ˆä¸Šä¸‹æ–‡ï¼Œè‡ªèº«ä¹Ÿæ²¡æœ‰çˆ¶æµè§ˆä¸Šä¸‹æ–‡ã€‚

**iframe æœ‰å¾ˆå¤šä¼˜ç‚¹ï¼š**

- å¤©ç„¶çš„ js. css éš”ç¦»ï¼Œçœçš„å†™ sandbox äº†
- ç§»æ¤æ€§å’Œå¤ç”¨æ€§å¥½ï¼ŒæŠ€æœ¯æ ˆç‹¬ç«‹ï¼Œå¯ä»¥ä¾¿æ·åœ°åµŒåœ¨ä¸åŒçš„ä¸»åº”ç”¨ä¸­
- å¯ä»¥åœ¨è¿è¡Œæ—¶åšåˆ°åŠ¨æ€åŒ–ä¿®æ”¹
- åˆ‡æ¢å¾®åº”ç”¨ä¸éœ€è¦åˆ·æ–°ä¸»åº”ç”¨
- å¤©ç„¶çš„åº”ç”¨é—´èµ„æºæ‡’åŠ è½½ï¼Œæ²¡æœ‰åŠ è½½å­åº”ç”¨ï¼Œå…¶èµ„æºä¹Ÿä¸ä¼šè¢«åŠ è½½ã€‚

> ç„¶è€Œ iframe æ–¹æ¡ˆæœ‰å“ªäº›é—®é¢˜å‘¢ï¼Ÿ

**ä¸è¶³ï¼š**

- é¦–æ¬¡åŠ è½½ iframe åº”ç”¨æ—¶ï¼Œä¼šå› ä¸ºæœåŠ¡ç«¯è¯·æ±‚è€Œå¯¼è‡´å†…å®¹åŒºå¸¦æ¥çŸ­æš‚çš„ç™½å±æ•ˆæœ
- ä¸»åº”ç”¨åˆ·æ–°æ—¶ï¼Œiframe æ— æ³•ä¿æŒ URL çŠ¶æ€ï¼ˆä¼šé‡æ–°åŠ è½½ src å¯¹åº”çš„åˆå§‹ URLï¼‰ï¼›
- ä¸»åº”ç”¨å’Œ iframe å¤„äºä¸åŒçš„æµè§ˆä¸Šä¸‹æ–‡ï¼Œæ— æ³•ä½¿ iframe ä¸­çš„æ¨¡æ€æ¡†ç›¸å¯¹äºä¸»åº”ç”¨å±…ä¸­ï¼›
- ä¸»åº”ç”¨å’Œ iframe å¾®åº”ç”¨çš„æ•°æ®çŠ¶æ€åŒæ­¥é—®é¢˜ï¼šæŒä¹…åŒ–æ•°æ®å’Œé€šä¿¡ã€‚
- å¯¹äºéåå°ç®¡ç†ç³»ç»Ÿè€Œè¨€ï¼Œä½¿ç”¨ iframe è¿˜éœ€è¦è€ƒè™‘ SEO. ç§»åŠ¨ç«¯å…¼å®¹æ€§. åŠ è½½æ€§èƒ½ç­‰é—®é¢˜ã€‚
- ä¸»/å­åº”ç”¨ cookie å…±äº«é—®é¢˜ï¼ˆæ¯”å¦‚å…ç™»ï¼‰

## 5. iframe æ–¹æ¡ˆ cookie å…±äº«

> å…¶ä»–æ–¹æ¡ˆçš„ cookie å…±äº«ä¹Ÿç±»ä¼¼

#### åŒåŸŸ

```js
app.get("/", function (req, res) {
  // è®¾ç½®ä¸»åº”ç”¨çš„ cookie æ ‡è¯†
  res.cookie("cookie-test", "123");
  // ä½¿ç”¨ ejs æ¨¡ç‰ˆå¼•æ“å¡«å……ä¸»åº”ç”¨ public/main.html ä¸­çš„ micro å˜é‡ï¼Œå¹¶å°†å…¶æ¸²æŸ“åˆ°æµè§ˆå™¨
  res.render("main", {
    // micro æŒ‡å‘å¾®åº”ç”¨çš„æ‰“å¼€åœ°å€
    micro: `http://${host}:${port.main}/micro`,
  });
});

// å¾®åº”ç”¨å’Œä¸»åº”ç”¨åŒåŸŸï¼Œåªæ˜¯æœåŠ¡è·¯ç”±ä¸åŒ
app.get("/micro", function (req, res) {
  // è®¾ç½® iframe å¾®åº”ç”¨çš„ cookie æ ‡è¯†ï¼Œé¡ºä¾¿è§‚å¯Ÿèƒ½å¦è¦†ç›–ä¸»åº”ç”¨çš„ cookie æ ‡è¯†
  // åŒåŸŸæ—¶å…±äº«cookieï¼Œå­åº”ç”¨ä¼šæ”¹åŠ¨ä¸»åº”ç”¨çš„cookie
  res.cookie("micro-app", "true").cookie("cookie-test", "456");
  // æ¸²æŸ“ views/micro.html
  res.render("micro");
});
```

ç»“è®ºï¼šä¸»å­åº”ç”¨å¯ä»¥å…±äº« Cookie æ•°æ®ï¼Œä½†æ˜¯å­˜åœ¨åŒåå±æ€§å€¼è¢«è¦†ç›–çš„é£é™©

#### åŒç«™ä¸åŒåŸŸ

ä¸»åº”ç”¨ï¼š

```js
// ä½¿ç”¨ iHosts é…ç½® example.com æŒ‡å‘æœ¬æœºçš„ ip åœ°å€ï¼Œæ¨¡æ‹ŸåŒç«™
// ä¸»åº”ç”¨è®¿é—®åœ°å€ï¼šhttp://example.com:4000
app.get("/", function (req, res) {
  res.cookie("cookie-test", "456");
  // ä½¿å­åŸŸçš„å¾®åº”ç”¨å¯ä»¥å…±äº« Cookie
  // åœ¨è®¾ç½® Cookie æ—¶ï¼Œå¯ä»¥ä½¿ç”¨ Domainå’Œ Path æ¥æ ‡è®°ä½œç”¨åŸŸ
  // é»˜è®¤ä¸æŒ‡å®šçš„æƒ…å†µä¸‹ï¼ŒDomain å±æ€§ä¸ºå½“å‰åº”ç”¨çš„ hostï¼Œç”±äº xiaodududududuo.example.com å’Œ example.com ä¸åŒ
  // å› æ­¤é»˜è®¤æƒ…å†µä¸‹ä¸¤è€…ä¸èƒ½å…±äº« Cookieï¼Œå¯ä»¥é€šè¿‡è®¾ç½® Domain ä½¿å…¶ä¸ºå­åŸŸè®¾ç½® Cookieï¼Œä¾‹å¦‚ Domain=example.comï¼Œåˆ™ Cookie ä¹ŸåŒ…å«åœ¨å­åŸŸ xiaodududududuo.example.com ä¸­
  res.cookie("main-cookie-test", "true", { domain: "example.com" }); // æ ¸å¿ƒä»£ç 
  res.render("main", {
    // ä½¿ç”¨ iHosts é…ç½® xiaodududududuo.example.com æŒ‡å‘æœ¬æœºçš„ ip åœ°å€
    // å­åº”ç”¨è®¿é—®åœ°å€ï¼š http://xiaodududududuo.example.com:3000
    micro: `http://xiaodududududuo.example.com:${port.micro}`,
  });
});
```

å­åº”ç”¨ï¼š

```js
app.get("/", function (req, res) {
  // è®¾ç½® iframe å¾®åº”ç”¨çš„ cookie æ ‡è¯†ï¼Œé¡ºä¾¿è§‚å¯Ÿèƒ½å¦è¦†ç›–ä¸»åº”ç”¨çš„ cookie æ ‡è¯†
  res.cookie("micro-app", "true").cookie("cookie-test", "123");
  res.render("micro");
});
```

ç»“è®ºï¼šé»˜è®¤æƒ…å†µæ— æ³•å…±äº«ï¼Œä½†æ˜¯é€šè¿‡è®¾ç½® Domain ä½¿å¾—ä¸¤ä¸ªåº”ç”¨å¯ä»¥å…±äº«å½¼æ­¤çš„ Cookieã€‚

#### è·¨ç«™

ä»£ç å°±ä¸ç”¨æ¼”ç¤ºäº†ï¼Œä¸¤ä¸ªå®Œå…¨ä¸åŒçš„åœ°å€ä½œä¸ºä¸»/å­æœåŠ¡ï¼Œç›´æ¥è¯´ç»“è®ºï¼šå­åº”ç”¨é»˜è®¤æ— æ³•æºå¸¦ Cookieï¼ˆé˜²æ­¢ CSRF æ”»å‡»ï¼‰ï¼Œéœ€è¦ä½¿ç”¨ HTTPS åè®®å¹¶è®¾ç½®æœåŠ¡ç«¯ Cookie çš„ SameSite å’Œ Secure è®¾ç½®æ‰è¡Œï¼Œå¹¶ä¸”å­åº”ç”¨æ— æ³•å’Œä¸»åº”ç”¨å½¢æˆ Cookie å…±äº«

> æœ¬åœ°å¯ä»¥ä½¿ç”¨ ngrok æ¨¡æ‹Ÿè·¨ç«™

## 6. å‰©ä½™ç¼ºç‚¹

- é¦–æ¬¡åŠ è½½ç™½å±æ•ˆæœï¼ˆå¯ä»¥ä½¿ç”¨é¢„åŠ è½½. é¢„æ¸²æŸ“ç­‰ä¼˜åŒ–æªæ–½ï¼‰
- iframe æ— æ³•ä¿æŒ URL çŠ¶æ€ï¼ˆä¸»å­åº”ç”¨éœ€è¦åš history çš„ä»£ç†ï¼Œå…¨å±€ä½¿ç”¨ä¸€ä¸ªå•ä¾‹ï¼‰
- æ¨¡æ€æ¡†ç›¸å¯¹äºä¸»åº”ç”¨å±…ä¸­é—®é¢˜ï¼ˆåŒä¸Šï¼Œä¸»å­åº”ç”¨éœ€åš window å¯¹è±¡ä»£ç†ï¼Œå¼¹çª—ç›¸å¯¹äº body ç½®äºé¡¶å±‚ï¼‰
- æ•°æ®çŠ¶æ€åŒæ­¥é—®é¢˜ï¼ˆåŒä¸Šï¼Œä¸»å­åº”ç”¨éœ€åš window å¯¹è±¡ä»£ç†ï¼Œä¸»å­åº”ç”¨è®¾ç½®é€šä¿¡æœºåˆ¶ä¼ é€’äº‹ä»¶å¯¹è±¡ç­‰ï¼‰
- SEO. ç§»åŠ¨ç«¯å…¼å®¹æ€§. åŠ è½½æ€§èƒ½ï¼š ï¼Ÿ

----f:T17d8,äºŒå‰æ ‘æ˜¯ä¸€ç§è®¡ç®—æœºåŸºç¡€æ•°æ®ç»“æ„ï¼Œæœ€è¿‘åœ¨å†™æ ‘ç»„ä»¶çš„æ—¶å€™æœ‰ç”¨åˆ°äº†è¿™ä¸ªåŸºæœ¬çŸ¥è¯†ï¼Œè¿™é‡Œæ€»ç»“ä¸€ä¸‹ã€‚

## 1. å¼•

å®ƒçš„å®é™…ä½¿ç”¨åœºæ™¯éå¸¸å¹¿æ³›ã€‚ä»¥ä¸‹æ˜¯ä¸€äº›å¸¸è§çš„äºŒå‰æ ‘åº”ç”¨åœºæ™¯ï¼š

*   æ–‡ä»¶ç³»ç»Ÿï¼šæ–‡ä»¶ç³»ç»Ÿçš„ç›®å½•ç»“æ„å¯ä»¥ä½¿ç”¨äºŒå‰æ ‘è¡¨ç¤ºï¼Œæ¯ä¸ªèŠ‚ç‚¹ä»£è¡¨ä¸€ä¸ªæ–‡ä»¶æˆ–ç›®å½•ï¼Œé€šè¿‡å·¦å­èŠ‚ç‚¹å’Œå³å­èŠ‚ç‚¹è¿æ¥å½¢æˆå±‚çº§ç»“æ„ã€‚
*   æ•°æ®åº“ç´¢å¼•ï¼šæ•°æ®åº“ç´¢å¼•é€šå¸¸ä½¿ç”¨äºŒå‰æ ‘å®ç°ï¼Œæ¯”å¦‚äºŒå‰æœç´¢æ ‘ï¼ˆBSTï¼‰ç”¨äºå¿«é€Ÿæœç´¢å’Œæ£€ç´¢æ•°æ®ã€‚
*   è¡¨è¾¾å¼è§£æå’Œè®¡ç®—ï¼šäºŒå‰æ ‘å¯ä»¥ç”¨äºè§£æå’Œè®¡ç®—è¡¨è¾¾å¼ï¼Œå¦‚æ•°å­¦è¡¨è¾¾å¼. å¸ƒå°”è¡¨è¾¾å¼ç­‰ã€‚
*   å›¾åƒå¤„ç†ï¼šåœ¨å›¾åƒå¤„ç†ä¸­ï¼ŒäºŒå‰æ ‘å¸¸ç”¨äºå›¾åƒå‹ç¼©ç®—æ³•ï¼ˆå¦‚å“ˆå¤«æ›¼ç¼–ç ï¼‰å’Œå›¾åƒæ¸è¿›å¼åŠ è½½ã€‚
*   è·¯ç”±ç®—æ³•ï¼šåœ¨ç½‘ç»œè·¯ç”±ä¸­ï¼ŒäºŒå‰æ ‘å¯ä»¥ç”¨äºæ„å»ºè·¯ç”±è¡¨ï¼Œå¸®åŠ©ç¡®å®šæ•°æ®åŒ…çš„ä¼ è¾“è·¯å¾„ã€‚
*   è§£ææ ‘ï¼šäºŒå‰æ ‘å¯ä»¥ç”¨äºæ„å»ºè§£ææ ‘ï¼Œç”¨äºè§£æå’Œç†è§£è‡ªç„¶è¯­è¨€. ç¼–ç¨‹è¯­è¨€ç­‰ç»“æ„åŒ–æ•°æ®ã€‚
*   äººå·¥æ™ºèƒ½å’Œå†³ç­–æ ‘ï¼šå†³ç­–æ ‘æ˜¯ä¸€ç§ç‰¹æ®Šçš„äºŒå‰æ ‘ï¼Œå¸¸ç”¨äºäººå·¥æ™ºèƒ½ä¸­çš„åˆ†ç±»å’Œå†³ç­–é—®é¢˜ã€‚
*   å †å’Œä¼˜å…ˆé˜Ÿåˆ—ï¼šäºŒå‰å †æ˜¯ä¸€ç§ç‰¹æ®Šçš„äºŒå‰æ ‘ç»“æ„ï¼Œç”¨äºå®ç°ä¼˜å…ˆé˜Ÿåˆ—å’Œå †æ’åºç®—æ³•ã€‚
*   ç¼–è¯‘å™¨å’Œè§£é‡Šå™¨ï¼šåœ¨ç¼–è¯‘å™¨å’Œè§£é‡Šå™¨ä¸­ï¼ŒäºŒå‰æ ‘å¸¸ç”¨äºè¯­æ³•åˆ†æå’Œæ„å»ºæŠ½è±¡è¯­æ³•æ ‘ï¼ˆASTï¼‰ã€‚
*   æ•°æ®å‹ç¼©ï¼šäºŒå‰æ ‘å¸¸ç”¨äºæ•°æ®å‹ç¼©ç®—æ³•ï¼Œå¦‚éœå¤«æ›¼ç¼–ç ï¼ˆHuffman Codingï¼‰ï¼Œé€šè¿‡æ ‘çš„æ„å»ºå’Œè·¯å¾„ç¼–ç æ¥å®ç°æ•°æ®çš„é«˜æ•ˆå‹ç¼©å’Œè§£å‹ç¼©ã€‚
*   çº¿æ®µæ ‘ï¼šçº¿æ®µæ ‘æ˜¯ä¸€ç§ç‰¹æ®Šçš„äºŒå‰æ ‘ï¼Œç”¨äºå¤„ç†åŒºé—´æŸ¥è¯¢é—®é¢˜ï¼Œå¦‚åŒºé—´æœ€å°å€¼. åŒºé—´å’Œç­‰ã€‚
*   ç´¢å¼•ç»“æ„ï¼šäºŒå‰æ ‘å¯ç”¨äºæ„å»ºå„ç§ç´¢å¼•ç»“æ„ï¼Œå¦‚Bæ ‘å’ŒB+æ ‘ï¼Œç”¨äºå¿«é€Ÿçš„æ•°æ®åº“æŸ¥è¯¢å’Œç´¢å¼•æ“ä½œã€‚
*   çº¿ç´¢äºŒå‰æ ‘ï¼šçº¿ç´¢äºŒå‰æ ‘æ˜¯ä¸€ç§ä¼˜åŒ–çš„äºŒå‰æ ‘ç»“æ„ï¼Œé€šè¿‡æ·»åŠ é¢å¤–çš„çº¿ç´¢ä¿¡æ¯ï¼Œå¯ä»¥å¿«é€Ÿè¿›è¡Œä¸­åºéå†. å‰åºéå†ç­‰æ“ä½œã€‚
*   ç¼“å­˜å®ç°ï¼šLRU Cacheï¼ˆæœ€è¿‘æœ€å°‘ä½¿ç”¨ç¼“å­˜ï¼‰å¸¸ä½¿ç”¨åŒå‘é“¾è¡¨å’ŒäºŒå‰æ ‘ï¼ˆå¦‚çº¢é»‘æ ‘ï¼‰ç›¸ç»“åˆçš„æ–¹å¼å®ç°ï¼Œä»¥å¿«é€Ÿæ’å…¥. åˆ é™¤å’ŒæŸ¥æ‰¾æœ€è¿‘ä½¿ç”¨çš„æ•°æ®ã€‚

äºŒå‰æ ‘ä¸€ä¸ªé‡è¦çš„ç®—æ³•å°±æ˜¯ä»–çš„çš„éå†ï¼Œåœ¨ASTç¼–è¯‘å™¨å¼€å‘. è·¯ç”±å¯¼èˆª. æ–‡ä»¶ç³»ç»Ÿç­‰ç­‰ä¸šåŠ¡åœºæ™¯ä¸­éƒ½åœ¨å¹¿æ³›çš„ä½¿ç”¨ã€‚

## 2. æ„å»ºä¸€ä¸ªäºŒå‰æ ‘

äºŒå‰æ ‘æœ‰ä¸€ä¸ªæ ¹èŠ‚ç‚¹ï¼Œæ‰€æœ‰çš„çˆ¶èŠ‚ç‚¹æœ€å¤šåªèƒ½æœ‰ä¸¤ä¸ªå­©å­ã€‚æˆ‘ä»¬å¯ä»¥æ„é€ ä¸€ä¸ªäºŒå‰æ ‘å¦‚ä¸‹ï¼š

![image.png](/img/posts/2023-12-6/2023-12-6-1.png)

ä»£ç ç»“æ„å¦‚ä¸‹ï¼š

```js
const tree = {
  name: 1,
  children: [
    {
      name: 2,
      children: [
        {
          name: 4,
          children: [{ name: 8 }],
        },
        { name: 5 },
      ],
    },
    {
      name: 3,
      children: [{ name: 6 }, { name: 7 }],
    },
  ],
};
```

æ¥ä¸‹æ¥ç»“åˆå›¾å½¢ï¼Œç”¨ä»£ç æ¥å®ç°ä¸€ä¸‹ä»–çš„éå†ï¼š

## 3. éå†

### å±‚æ¬¡éå†

æŒ‰ç…§å±‚çº§éå†

ç®—æ³•æ€è·¯ï¼š

*   å»ºç«‹ä¸€ä¸ªé˜Ÿåˆ—ï¼Œä»æ ¹èŠ‚ç‚¹å¼€å§‹ï¼Œå°†å…¶å­èŠ‚ç‚¹çš„å­èŠ‚ç‚¹ä»å·¦è‡³å³å…¥é˜Ÿ
*   éå†é˜Ÿåˆ—å¹¶å‡ºé˜Ÿï¼Œé‡å¤ç¬¬äºŒæ­¥ååŠéƒ¨åˆ†
*   é˜Ÿåˆ—ä¸ºç©ºåˆ™éå†ç»“æŸ


![image.png](/img/posts/2023-12-6/2023-12-6-2.png)

```js
function traverse(node) {
  if (!node) {
    return;
  }

  const queue = [];
  queue.unshift(node);

  while (queue.length > 0) {
    const printNode = queue.pop();
    console.log(printNode.name);
    if (printNode.children && printNode.children.length > 0) {
      queue.unshift(...printNode.children.slice().reverse());
    }
  }
}
```

### å…ˆåºéå†

é€’å½’å®ç°

*   ä»æ ¹èŠ‚ç‚¹å¼€å§‹
*   å°†å·¦å³èŠ‚ç‚¹å½“åšå­æ ‘ï¼Œå…ˆéå†å·¦èŠ‚ç‚¹ï¼Œå†éå†å³èŠ‚ç‚¹
*   ç›´åˆ°å½“å‰èŠ‚ç‚¹æ²¡æœ‰å­èŠ‚ç‚¹ä¸ºæ­¢

```js
function preOrderTraverse(root) {
  if (root != null) {
    const children = root.children || [];
    console.log(root.name);
    preOrderTraverse(children[0]);
    preOrderTraverse(children[1]);
  }
}
```

éé€’å½’å®ç°

*   å»ºç«‹ä¸€ä¸ªæ ˆï¼Œå…¥æ ˆæ ¹èŠ‚ç‚¹
*   å‡ºæ ˆå½“å‰èŠ‚ç‚¹ï¼Œå°†å½“å‰èŠ‚ç‚¹å­èŠ‚ç‚¹é›†åˆé€†å‘å…¥æ ˆ
*   é‡å¤ç¬¬äºŒæ­¥ï¼Œç›´åˆ°æ ˆç©º


![image.png](/img/posts/2023-12-6/2023-12-6-3.png)

```js
function preOrderTraverse(node) {
  if (!node) return;

  const track = [];
  track.push(node);

  while (track.length > 0) {
    const node = track.pop();
    console.log(node.name);
    const children = node.children;
    if (children && children.length > 0) {
      track.push(...children.reverse());
    }
  }
}
```

> æ€è€ƒï¼šå­¦ä¼šäº†å…ˆåºéå†ï¼Œç›¸ä¿¡ä½ åº”è¯¥èƒ½å¤Ÿå¾ˆå®¹æ˜“çš„å†™å‡ºååºéå†çš„å®ç°ï¼

### ä¸­åºéå†

éé€’å½’å®ç°

*   å»ºç«‹ä¸€ä¸ªæ ˆï¼Œå…¥æ ˆæ ¹èŠ‚ç‚¹
*   è‹¥æœ‰å·¦å­èŠ‚ç‚¹ï¼Œåˆ™å…¥æ ˆï¼Œç›´åˆ°æ²¡æœ‰å·¦å­èŠ‚ç‚¹æ—¶å‡ºæ ˆæ ˆé¡¶å…ƒç´ å¹¶æ‰“å°ï¼Œå…¥æ ˆæ ˆé¡¶å…ƒç´ çš„å³å­èŠ‚ç‚¹
*   é‡å¤ç¬¬äºŒæ­¥ï¼Œç›´åˆ°æ²¡æœ‰å¯ç”¨å…ƒç´ ä¸”æ ˆç©ºä¸ºæ­¢


![image.png](/img/posts/2023-12-6/2023-12-6-4.png)

```js
function middleOrderTraverse(node) {
  if (!node) return;

  const stack = [];
  let currentNode = node;
  while (currentNode || stack.length > 0) {
    if (currentNode) {
      stack.push(currentNode);
      currentNode =
        currentNode && currentNode.children ? currentNode.children[0] : null;
    } else {
      const poped = stack.pop();
      console.log(poped.name);
      currentNode = poped.children ? poped.children[1] : null;
    }
  }
}
```

### é“¾è¡¨å®ç°

é“¾è¡¨ä¸é€‚åˆåšå¹¿åº¦ä¼˜å…ˆéå†ï¼Œä¸‹é¢ç¤ºæ„å›¾ä¸­ï¼Œæ·±åº¦ä¼˜å…ˆä¼šéå¸¸çš„æ–¹ä¾¿ã€‚æˆ‘ä»¬æ‹¿ react fiber çš„ç»“æ„æ¥ä¸¾ä¾‹ã€‚


![image.png](/img/posts/2023-12-6/2023-12-6-5.png)

*   éå†æ€è·¯ï¼šä»æ ¹èŠ‚ç‚¹å¼€å§‹ï¼Œä»¥æ­¤éå†æ¯ä¸€ä¸ªç»è¿‡çš„èŠ‚ç‚¹çš„ child å’Œ sibling

ä¼ªä»£ç å®ç°ï¼š

```js
function linkedListTraverse(root) {
  let wip = root;

  while (wip) {
    console.log(wip);

    if (wip.child) {
      temp = wip.child;
      wip.child = null; // éå†è¿‡å°±å‰”é™¤
      wip = temp;
      continue;
    }

    if (wip.sibling) {
      temp = wip.sibling;
      wip.sibling = null; // éå†è¿‡å°±å‰”é™¤
      wip = temp;
      continue;
    }

    wip = wip.return;
  }
}
```10:T68a2,2023 å¹´ï¼Œ CSS é¢†åŸŸæœ‰äº†æ–°çš„å˜åŒ–ï¼Œæ•´ä½“è¶‹åŠ¿æ˜¯æ›´åŠ çš„æ˜“ç”¨ï¼Œå¹¶è´´åˆæµè¡Œçš„æ¡†æ¶åšäº†æ‰©å±•ã€‚Chrome çš„å¼€å‘è€… blog å’Œ MDN é‡Œæ›´æ–°äº†ä¸€äº›æ¯”è¾ƒæœ‰æ„æ€çš„ CSS 2023 åŠ¨å‘çš„å†…å®¹ï¼Œæ–‡ç« æ¯”è¾ƒé•¿ï¼Œå†…å®¹æœ‰ç‚¹ä¹±ï¼Œè¿™é‡Œæ€»ç»“åˆ†äº«ä¸€ä¸‹ç»™å¤§å®¶ã€‚

## 1. æ‘˜è¦

æœ¬æ–‡æ˜¯ â€œ2023 å¹´åº¦æŠ€æœ¯ç›˜ç‚¹â€ ç³»åˆ—æ–‡ç« ï¼Œä¸»è¦ä»‹ç»å‰ç«¯ CSS é¢†åŸŸåœ¨ 2023 å¹´çš„é‡è¦è¿›å±•ã€‚æœ¬æ–‡ä» CSS åŸºç¡€åŠŸèƒ½ã€æ’ç‰ˆã€é¢œè‰²ã€è‡ªé€‚åº”è®¾è®¡ã€äº¤äº’å’Œç»„ä»¶ç­‰æ–¹é¢è¿›è¡Œç›˜ç‚¹ã€‚

> å¯ä»¥æŸ¥çœ‹æ–‡ç« ç›®å½•ä»¥é€‰æ‹©æŸ¥çœ‹è‡ªå·±æ„Ÿå…´è¶£çš„æ›´æ–°

## 2. åŸºç¡€åŠŸèƒ½

css æ–°å¢äº†ä¸‰è§’å‡½æ•°ç›¸å…³å‡½æ•°ï¼š`sin()`ã€`cos()`ã€`tan()`ã€`asin()`ã€`acos()`ã€`atan()` å’Œ `atan2()`ã€‚

ä¸‰è§’å‡½æ•°çš„ä½¿ç”¨è¦å’Œ `calc` ç»“åˆæ‰èƒ½å‡ºæ•ˆæœã€‚

#### ä¸‰è§’å‡½æ•°

![image.png](/img/posts/2024-1-2/2024-1-2-1.png)

-   `cos()`ï¼šè¿”å›è§’åº¦çš„ä½™å¼¦å€¼ï¼Œè¯¥å€¼ä»‹äºÂ `-1`Â å’ŒÂ `1`Â ä¹‹é—´ã€‚
-   `sin()`ï¼šè¿”å›è§’åº¦çš„æ­£å¼¦å€¼ï¼Œè¯¥å€¼ä»‹äºÂ `-1`Â å’ŒÂ `1`Â ä¹‹é—´ã€‚
-   `tan()`ï¼šè¿”å›è§’åº¦çš„æ­£åˆ‡å€¼ï¼Œå–å€¼ä»‹äºÂ `âˆ’âˆ`Â å’ŒÂ `+âˆ`Â ä¹‹é—´ã€‚

ä»¥æ­£å¼¦ä¸ºä¾‹ï¼Œä½ å¯ä»¥è¿™ä¹ˆå†™ï¼š`width: calc(sin(var(--angle)) * 200px);` æ¥è®¡ç®—å®½åº¦å€¼ã€‚

æˆ‘ä»¬å®ç°ä¸€ä¸ªè®¡ç®—è§’åº¦å‚çº¿é•¿åº¦çš„é—®é¢˜æ¥è¯´æ˜ sin çš„ç”¨æ³•ã€‚ä¸‹é¢çš„ä¾‹å­é‡Œï¼Œç»¿è‰²è™šçº¿çš„é•¿åº¦å°±æ˜¯ `æ–œè¾¹ï¼ˆ200pxï¼‰* sin(è§’åº¦)` è®¡ç®—å‡ºæ¥çš„ï¼š

[å®ç° sin è®¡ç®—ä¸‰è§’å½¢è¾¹é•¿](https://code.juejin.cn/pen/7317184041529114662)

> ç”±äº chrome çš„ css ä¸æ”¯æŒ rem() å’Œ mod() ç­‰å–æ¨¡å‡½æ•°ï¼Œæ‰€ä»¥ç”¨äº†ä¸¤ä¸ª css å˜é‡è¡¨ç¤º 180deg å‰åçš„è§’åº¦

> ç ä¸Šæ˜é‡‘æ€ä¹ˆä¸æ”¯æŒç›´æ¥é¢„è§ˆäº†ï¼Œæˆ‘æ”¾ä¸ªæˆªå›¾å§...


![image.png](/img/posts/2024-1-2/2024-1-2-2.png)


åŒç†ï¼Œcos å’Œ tan å¯ä»¥å¦‚ä¸‹ä½¿ç”¨ï¼š

```css
transform: scaleX(cos(var(--angle)))
transform: scaleX(tan(var(--angle)));
```

å®˜æ–¹demoï¼šhttps://codepen.io/web-dot-dev/pen/NWLxROo

#### åä¸‰è§’å‡½æ•°

åä¸‰è§’å‡½æ•°æ˜¯ä¸‰è§’å‡½æ•°çš„é€†è¿ç®—ï¼ŒåŒ…å«ï¼š`asin()`ã€`acos()`ã€`atan()`Â å’ŒÂ `atan2()`ã€‚å‰ä¸‰ä¸ªæ¥å—ä¸€ä¸ªæ•°å€¼ï¼Œè¿”å›å¯¹åº”çš„è§’åº¦å€¼ã€‚

ç¬¬å››ä¸ª `atan2()`ï¼Œæ¥å—ä¸¤ä¸ªå‚æ•°Â `A`Â å’ŒÂ `B`ã€‚è¿”å› X è½´æ­£è½´ä¸Â `(B, A)`Â ç‚¹ä¹‹é—´çš„è§’åº¦ã€‚

> atan2å¯¹è±¡é™æ•æ„Ÿï¼Œæ ¹æ®ä¸¤ä¸ªå‚æ•°åˆ¤æ–­å®ƒæ˜¯å±äºå“ªä¸ªè±¡é™å¹¶ç»™å‡ºå¯¹åº”çš„è§’åº¦å€¼ï¼Œå€¼åŸŸèŒƒå›´[-pi, pi]ï¼›atanå¯¹è±¡é™ä¸æ•æ„Ÿï¼Œå€¼åŸŸèŒƒå›´ä¸º[-pi/2, pi/2]

ä¸‹é¢è¿˜æ˜¯ä¸¾ä¸ªä¾‹å­æ¥è¯´æ˜ `atan()`Â å’ŒÂ `atan2()` çš„åŒºåˆ«ã€‚

[åä¸‰è§’å‡½æ•°ç¤ºä¾‹](https://code.juejin.cn/pen/7317462707643351092)

ä¸‹ä¸€ä¸ªæ–°åŠŸèƒ½æ˜¯ `n-*` çš„é€‰æ‹©å™¨ã€‚å¤§å®¶ä¹‹å‰ä¹Ÿéƒ½ç”¨è¿‡è¯¸å¦‚ :nth-of-type è¿™æ ·çš„ä¼ªç±»æ¥å®ç°å…ƒç´ é€‰æ‹©ï¼Œç°åœ¨å®˜æ–¹å¢å¼ºäº†è¿™ä¸ªåŠŸèƒ½ï¼Œä½¿ç”¨ S è¯­æ³•æ¥æ›´å¥½åœ°æ§åˆ¶ :nth-child() é€‰æ‹©ï¼š `:nth-child()`Â å’ŒÂ `:nth-last-child()`ã€‚

#### n-* é€‰æ‹©å™¨ ä¸ S è¯­æ³•


![image.png](/img/posts/2024-1-2/2024-1-2-3.png)

ä½¿ç”¨ä¾‹å­ï¼š

-   `:nth-child(2)`ï¼šé€‰æ‹©ç¬¬äºŒä¸ªå­çº§ã€‚
-   `:nth-child(2n)`ï¼šé€‰æ‹©æ‰€æœ‰å¶æ•°å­é¡¹ï¼ˆä¾‹å¦‚ 2ndã€4thã€6thã€8th ç­‰ï¼‰ã€‚**
-   `:nth-child(2n+1)`ï¼šé€‰æ‹©æ‰€æœ‰å¥‡æ•°å­é¡¹ï¼ˆç¬¬ 1ã€3ã€5ã€7ï¼Œä¾æ­¤ç±»æ¨ï¼‰ã€‚**
-   `:nth-child(5n+1)`ï¼šé€‰æ‹©ç¬¬ 1 ä¸ªÂ  *(=(5Ã—0)+1)* ã€ç¬¬ 6 ä¸ªÂ  *(=(5Ã—1)+1)* ã€ç¬¬ 11 ä¸ªÂ  *(=(5Ã—2)+1)* ...å­çº§ã€‚
-   `:nth-child(5n+2)`ï¼šé€‰æ‹©ç¬¬ 2 ä¸ªÂ  *(=(5Ã—0)+2)* ã€ç¬¬ 7 ä¸ªÂ  *(=(5Ã—1)+2)* ã€ç¬¬ 12 ä¸ªÂ  *(=(5Ã—2)+2)* ... å­é¡¹ã€‚

é‡Œè¾¹çš„é€‰æ‹©é¡¹å¯ä»¥æ˜¯ç­‰å·®æ•°åˆ—ï¼Œç­‰æ¯”æ•°åˆ—ï¼Œæˆ–è€…æ˜¯è‡ªå®šä¹‰çš„ä»»æ„æ•°åˆ—ï¼Œç”šè‡³å¯ä»¥ç»„åˆä½¿ç”¨ï¼š

-   `:nth-child(n+3)`ï¼šé€‰æ‹©ä»ç¬¬ 3 ä¸ªå¼€å§‹çš„æ¯ä¸ªå­çº§ã€‚
-   `:nth-child(-n+5)`ï¼šé€‰æ‹©ä¸è¶…è¿‡ç¬¬ 5 ä¸ªå­çº§ï¼ˆç¬¬ 1 ä¸ªã€ç¬¬ 2 ä¸ªã€ç¬¬ 3 ä¸ªã€ç¬¬ 4 ä¸ªã€ç¬¬ 5 ä¸ªã€‚
-   `:nth-child(n+3):nth-child(-n+5)`ï¼šé€‰æ‹©ç¬¬ 3 ä¸ªåˆ°ç¬¬ 5 ä¸ªï¼ˆç¬¬ 3 ä¸ªã€ç¬¬ 4 ä¸ªã€ç¬¬ 5 ä¸ªï¼‰çš„æ¯ä¸ªå­çº§ã€‚

åŒç†ï¼Œ`:nth-last-child()`Â ï¼Œä¹Ÿå¯ä»¥è¿›è¡Œç±»ä¼¼çš„é€‰æ‹©ï¼Œä½†ä¸æ˜¯ä»å¤´å¼€å§‹è®¡æ•°ï¼Œè€Œæ˜¯ä»å¤´å¼€å§‹è®¡æ•°ã€‚

ä¸‹é¢ç»™ä¸€ä¸ªåˆ›å»ºæ–‘é©¬çº¹ç¤ºä¾‹ï¼š

```css
tr:nth-child(even) {
Â  background-color: #E9E9E9;
}

// å¦ä¸€ç§å†™æ³•
tr:nth-of-type(even){ 
  background: #E9E9E9;
}
```

> â€œnth-of-typeâ€å’Œâ€œnth-childâ€çš„åŒºåˆ«ï¼šp:nth-of-type(7)é€‰æ‹©çš„på…ƒç´ æ‰€åœ¨çš„çˆ¶å…ƒç´ ä¸‹çš„ç¬¬7ä¸ªPå…ƒç´ å³ï¼šç¬¬7ä¸ªpï¼›p:nth-child(6)é€‰æ‹©çš„på…ƒç´ æ‰€åœ¨çš„çˆ¶å…ƒç´ ä¸‹çš„ç¬¬6ä¸ªå­å…ƒç´ ï¼Œä¸”è¯¥å…ƒç´ æ˜¯På…ƒç´ ã€‚

nth-child è¿˜å¯ä»¥ç»“åˆ S è¯­æ³•ä½¿ç”¨ï¼š

```css
:nth-child(An+B [of S]?)
:nth-last-child(An+B [of S]?)
```
æŒ‡å®šÂ `of S`Â åï¼Œ`An+B`Â é€»è¾‘ä»…åº”ç”¨äºä¸ç»™å®šé€‰æ‹©å™¨åˆ—è¡¨Â `S`Â åŒ¹é…çš„å…ƒç´ ã€‚è¿™å®é™…ä¸Šæ„å‘³ç€ï¼Œæ‚¨å¯ä»¥åœ¨Â `An+B`Â æ‰§è¡Œæ“ä½œä¹‹å‰é¢„å…ˆè¿‡æ»¤å­é¡¹ï¼š

```css
:nth-child(2 of .highlight) {
  /* = Select the 2nd child element that has the class .highlight applied to it */
  outline: 0.3rem dashed hotpink;
  outline-offset: 0.7rem;
}
```
ä¸Šé¢çš„ä¾‹å­ï¼Œé€‰æ‹©äº†çˆ¶å…ƒç´ ç›’å­ä¸­ï¼Œç±»åå« highlight ä¸­çš„ç¬¬äºŒä¸ªå­å…ƒç´ ï¼ˆæ³¨æ„ä¸æ˜¯ç‰©ç†é¡ºåºçš„ç¬¬äºŒä¸ªï¼‰æ¥èµ‹å€¼æ ·å¼ã€‚

å†ä¸¾ä¸ªä¾‹å­ï¼Œä¸Šé¢çš„æ–‘é©¬çº¹è¿˜å¯ä»¥å¢å¼ºï¼š

```css
// ç­›é€‰æ²¡æœ‰ hidden å±æ€§çš„åˆ—ï¼Œç„¶åå†è®¡ç®—æ–‘é©¬çº¹
tr:nth-child(even of :not([hidden])) {
Â  background-color: lightgrey;
}
```

#### `@scope`

![image.png](/img/posts/2024-1-2/2024-1-2-4.png)

Chrome 118+ å¢åŠ äº†å¯¹Â `@scope`Â çš„æ”¯æŒï¼Œè¿™æ˜¯ä¸€é¡¹ @ è§„åˆ™ï¼Œå¯å°†é€‰æ‹©å™¨çš„èŒƒå›´é™å®šä¸ºæ–‡æ¡£çš„ç‰¹å®šå­æ ‘ï¼Œä»è€Œæ§åˆ¶ css ä½œç”¨åŸŸï¼Œè¿™å¯¹äºå°†æ¥éœ€è¦åš css éš”ç¦»çš„ä¸šåŠ¡åœºæ™¯æœ‰å¤§ç”¨å¤„ï¼š

```css
@scope (html) {
  .warning {
    display: none;
  }
}

/* Only match elements in the card component, but donâ€™t target those in nested components */
@scope (.card) to ([data-component]) {
  img {
    border: 0.25em solid #6300ff;
    border-radius: 0.5em;
  }
}
```

ä¸Šé¢çš„ç¬¬äºŒä¸ªä¾‹å­ï¼Œåªä½œç”¨äº card ç±»ï¼Œè€Œä¸ä½œç”¨äºå…¶åŒ…å«data-componentå±æ€§çš„å­å…ƒç´ ï¼Œå³ cardç±» å’Œ \[data-component] ä¹‹é—´çš„å…ƒç´ ã€‚


å®˜ç½‘demoï¼šhttps://codepen.io/web-dot-dev/pen/YzdOydZ

#### `@layer åµŒå¥—`


![image.png](/img/posts/2024-1-2/2024-1-2-5.png)

> å…¶å®è¿™ä¸ªç‰¹æ€§22å¹´å°±æœ‰äº†

å®˜æ–¹ css æ˜¾ç„¶æ˜¯å¸å–äº†å„ä¸ªå‰ç«¯æ¡†æ¶å’Œé¢„å¤„ç†å™¨çš„ç»éªŒï¼Œå¹¶è¿›è¡Œäº†å‡çº§ï¼Œç°åœ¨ css ä¹Ÿè¦æ”¯æŒåµŒå¥—äº†ã€‚


ä¹‹å‰è¿™æ ·çš„å†™æ³•ï¼š

```css
ul li {}
ul li .child {
  color: red;
}
```

ç°åœ¨å¯ä»¥è¿™æ ·å†™äº†ï¼š

```css
@layer test {
    ul {
      li {
        & .child {
          color: red;
        }
      }
    }
    
    .card {
      &--header {
        /* is not equal to ".card--header" */
      }
    }
}
```

> å½“ç„¶ç›´æ¥åµŒå¥—ï¼Œä¸ä½¿ç”¨ @layer ä¹Ÿæ˜¯å¯ä»¥çš„

ä½¿ç”¨å…·å `@layer` åŒ…è£¹çš„ css ç‰‡æ®µå¯ä»¥æ”¯æŒåµŒå¥—ä¼˜å…ˆçº§é…ç½®ã€‚

```css
@layer base, special;

@layer special {
  .item {
    color: red;
  }
}

@layer base {
  .item {
    color: green;
    border: 5px solid green;
    font-size: 1.5em;
    padding: 0.5em;
  }
}
```
é¢„å…ˆå®šä¹‰å„ä¸ªå…·ålayerçš„ä¼˜å…ˆçº§ï¼Œä»å·¦åˆ°å³ä¾æ¬¡é™ä½ï¼Œä¸Šé¢çš„ item ç±»å…ƒç´ ï¼Œæœ€åä¼šè¢«åŠ ä¸Šçº¢è‰²çš„é¢œè‰²ï¼Œè€Œä¸æ˜¯ç»¿è‰²ã€‚

#### å­ç½‘æ ¼å¸ƒå±€

![image.png](/img/posts/2024-1-2/2024-1-2-6.png)

æˆ‘ä»¬éƒ½çŸ¥é“æœ‰ grid å¸ƒå±€ï¼Œç°åœ¨è¿æ¥äº†å¢å¼ºï¼ŒåŠ å…¥äº† subgrid å¸ƒå±€ã€‚

æˆ‘ä»¬è¿™ä¹ˆå®šä¹‰ä¸€ä¸ªç½‘æ ¼å¸ƒå±€ï¼š

```css
.container {
Â  display: grid;
Â  gap: 1rem;
Â  grid-template-columns: [column-1] 20ch [column-2] 1fr;
}
```
ç½‘æ ¼æœ‰ä¸¤åˆ—ï¼Œä¸€åˆ—ç»™20chï¼Œä¸€åˆ—å é¢†å‰©ä½™ç©ºé—´ï¼š


![image.png](/img/posts/2024-1-2/2024-1-2-7.png)

æˆ‘ä»¬ç°åœ¨å®šä¹‰å­ç½‘æ ¼ï¼š

```css
.container > div {
Â  grid-column: span 2;

Â  display: grid;
Â  grid-template-columns: subgrid; /* 20ch 1fr */
}
```

![image.png](/img/posts/2024-1-2/2024-1-2-8.png)

è¿™æ ·ä¸€æ¥ï¼Œå­ div è™½ç„¶è¿˜æ˜¯å äº†ä¸€è¡Œï¼Œä½†æ˜¯ä»–ç»§æ‰¿äº†çˆ¶å…ƒç´ çš„ç½‘æ ¼å¸ƒå±€ï¼Œå³çˆ¶ç½‘æ ¼çš„åˆ—å·²ç»æœ‰æ•ˆå‘ä¸‹ä¼ é€’åˆ°å­ç½‘æ ¼ï¼Œåœ¨å„ä¸ªå­ div å†…éƒ¨å†å®ç°å¸ƒå±€æ—¶å°±å¯ä»¥ç›´æ¥ä½¿ç”¨ã€‚æœ€æ–°çš„æµè§ˆå™¨ä¸­ä¹Ÿæ ‡æ˜äº†è¿™ç§å¸ƒå±€ï¼š


![image.png](/img/posts/2024-1-2/2024-1-2-9.png)

demo å¦‚ä¸‹ï¼š[å­ç½‘æ ¼å¸ƒå±€ demo](https://code.juejin.cn/pen/7317532251985313830)

çœ‹çœ‹ä½ çš„æµè§ˆå™¨æ”¯ä¸æ”¯æŒï¼Œå¯ä»¥è¿™æ ·ï¼š

```css
@supports (grid-template-columns: subgrid) {
  /* safe to enhance to */
}
```

å®˜æ–¹demoï¼šhttps://codepen.io/web-dot-dev/pen/MWLENzm

## 3. æ’ç‰ˆ

2023 å¹´ï¼Œcss ä¹Ÿå¼€å§‹é’ˆå¯¹æ’ç‰ˆæ›´æ–°äº†ï¼Œå¯èƒ½æ˜¯å€Ÿé‰´äº† Tailwind çš„ç»éªŒ...

#### é¦–å­—æ¯

![image.png](/img/posts/2024-1-2/2024-1-2-10.png)

Chrome 110 ä¸­æ¨å‡ºäº†Â `initial-letter`Â å±æ€§ï¼Œå¯ä»¥å°†é¦–å­—æ¯æŠ¬èµ·æˆ–é™ä½ã€‚

ç¤ºä¾‹ï¼š`<p>Lorem ipsum dolor ...</p>`

```css
p {
  &::first-letter {
    initial-letter: 3 2;
    color: green;
  }
}
```

æ ¸å¿ƒç‚¹æ˜¯ `first-letter` ä¼ªå…ƒç´ ï¼Œä»–åœ¨ DOM ç»“æ„æ ‘ä¸­ä¸ä¼šä½“ç°å‡ºæ¥ï¼ˆæ‰€ä»¥æœ‰äº›è¿·ï¼Œè°ƒè¯•æœ‰å›°éš¾ï¼Œå¹½çµå…ƒç´ ï¼Ÿï¼‰ï¼Œå…¶ä¸­å¯é€‰é¡¹ initial-letter å¯ä»¥è®¾ç½®å…¶åç§»é‡ï¼Œä¸Šé¢çš„ä¾‹å­è¡¨ç¤ºé¦–å­—æ¯é«˜åº¦å ç”¨ 3 è¡Œï¼Œä¸‹æ²‰ 2 è¡Œï¼š


![image.png](/img/posts/2024-1-2/2024-1-2-11.png)

> é¦–å­—æ¯å±æ€§åŒæ ·æ”¯æŒä¸­æ–‡

#### æ–‡å­—æŠ˜è¡Œä¼˜åŒ–

![image.png](/img/posts/2024-1-2/2024-1-2-12.png)

æ–°å¢ä¸¤ç§å†™æ³• `text-wrap: balance` å’Œ `text-wrap: pretty`ï¼Œå®˜æ–¹è§£é‡Šè¯·ç§»æ­¥ï¼šhttps://www.w3.org/TR/css-text-4/#text-wrapã€‚

å‰è€…æ˜¯æµè§ˆå™¨ä¸ºæ–‡æœ¬æ‰¾å‡ºæœ€ä½³çš„å‡è¡¡æ¢è¡Œè§£å†³æ–¹æ¡ˆï¼š


![image.png](/img/posts/2024-1-2/2024-1-2-13.png)

emmï¼Œæ€ä¹ˆæ„Ÿè§‰è¿˜ä¸å¦‚åŸæ¥ã€‚ã€‚ã€‚æ¨èä½¿ç”¨ prettyï¼Œè‡³å°‘èƒ½å·¦å³å¯¹é½ã€‚

## 4. é¢œè‰²

é¢œè‰²æ–¹é¢æ˜¯å·²æœ‰é¢œè‰²åº“çš„æ‰©å……ï¼Œå¢åŠ äº†æ›´å¤šçš„é¢œè‰²å’Œå¯é€‰é¡¹ã€‚å®˜æ–¹çš„è¯´æ³•æ˜¯ï¼ŒåŸæ¥çš„ CSS ä¸æ”¯æŒé«˜æ¸…ç”»è´¨ï¼Œè€Œå¤§å¤šæ•°äººæ”¾åœ¨å£è¢‹é‡Œã€æ”¾åœ¨èº«ä¸Šæˆ–å®‰è£…åœ¨å¢™ä¸Šçš„æ˜¾ç¤ºå±å…·æœ‰å¹¿è‰²åŸŸå’Œé«˜æ¸…è‰²å½©ã€‚æ˜¾ç¤ºå±çš„é¢œè‰²å¤„ç†é€Ÿåº¦æ¯” CSS å¿«ï¼Œç°åœ¨ CSS çš„æ›´æ–°å¯ä»¥ä¸ä¹‹ä¸€è¾ƒé«˜ä½äº†ã€‚

#### é«˜æ¸… CSS

CSSÂ [Color Level 4](https://www.w3.org/TR/css-color-4) æå‡ºäº†é«˜æ¸… CSS æ–¹æ¡ˆï¼Œä» Chrome 111 å¼€å§‹æ”¯æŒè‰²å½©ç©ºé—´å’Œè‰²åŸŸï¼Œä»–æ˜¯åœ¨å·²æœ‰è‰²åŸŸçš„åŸºç¡€ä¸Šçš„é¢œè‰²æ‰©å……ï¼Œä»¥é€‚åº”ç°åœ¨æ›´åŠ é«˜æ¸…æ˜¾ç¤ºçš„æ˜¾ç¤ºè®¾å¤‡ã€‚

å®˜æ–¹æ¨å‡º 7 ä¸­è‰²åŸŸï¼š

-   [sRGB](https://developer.chrome.com/docs/css-ui/high-definition-css-color-guide?hl=zh-cn#srgb)
-   [RGB 98](https://developer.chrome.com/docs/css-ui/high-definition-css-color-guide?hl=zh-cn#a98-rgb)
-   [Display p3](https://developer.chrome.com/docs/css-ui/high-definition-css-color-guide?hl=zh-cn#display-p3)
-   [Rec2020](https://developer.chrome.com/docs/css-ui/high-definition-css-color-guide?hl=zh-cn#rec2020)
-   [ProPhoto](https://developer.chrome.com/docs/css-ui/high-definition-css-color-guide?hl=zh-cn#prophoto-rgb)
-   [ç¾å›½å•†ä¸šè¡Œä¸šä¿¡æ¯ç½² (CIE)](https://en.wikipedia.org/wiki/CIE_1931_color_space)
-   [HVS](https://www.cs.rochester.edu/courses/572/colorvis/gamutvis.html)ï¼ˆäººåƒè‰²åŸŸï¼‰

é¢œè‰²ç©ºé—´æ˜¯è‰²åŸŸçš„æ’åˆ—ï¼Œå®ƒå»ºç«‹äº†å½¢çŠ¶ä»¥åŠè·å–é¢œè‰²çš„æ–¹æ³•ã€‚é¢œè‰²çº§åˆ« 4 å¼•å…¥äº† 12ä¸­é¢œè‰²ç©ºé—´ç”¨äºä»è‰²åŸŸä¸­æŸ¥æ‰¾é¢œè‰²ï¼š

-   [sRGB çº¿æ€§](https://developer.chrome.com/docs/css-ui/high-definition-css-color-guide?hl=zh-cn#linear-srgb)
-   [LCH](https://developer.chrome.com/docs/css-ui/high-definition-css-color-guide?hl=zh-cn#lch)
-   [okLCH](https://developer.chrome.com/docs/css-ui/high-definition-css-color-guide?hl=zh-cn#oklch)
-   [å®éªŒ](https://developer.chrome.com/docs/css-ui/high-definition-css-color-guide?hl=zh-cn#lab)
-   [okLAB](https://developer.chrome.com/docs/css-ui/high-definition-css-color-guide?hl=zh-cn#oklab)
-   [Display p3](https://developer.chrome.com/docs/css-ui/high-definition-css-color-guide?hl=zh-cn#display-p3)
-   [Rec2020](https://developer.chrome.com/docs/css-ui/high-definition-css-color-guide?hl=zh-cn#rec2020)
-   [a98 RGB](https://developer.chrome.com/docs/css-ui/high-definition-css-color-guide?hl=zh-cn#a98-rgb)
-   [ProPhoto RGB](https://developer.chrome.com/docs/css-ui/high-definition-css-color-guide?hl=zh-cn#prophoto-rgb)
-   [XYZ](https://developer.chrome.com/docs/css-ui/high-definition-css-color-guide?hl=zh-cn#xyz-xyz-d50-xyz-d65)
-   [XYZ d50](https://developer.chrome.com/docs/css-ui/high-definition-css-color-guide?hl=zh-cn#xyz-xyz-d50-xyz-d65)
-   [XYZ d65](https://developer.chrome.com/docs/css-ui/high-definition-css-color-guide?hl=zh-cn#xyz-xyz-d50-xyz-d65)

ä¹‹å‰åªæœ‰å››ç§é¢œè‰²ç©ºé—´ï¼š

-   [Hex](https://developer.chrome.com/docs/css-ui/high-definition-css-color-guide?hl=zh-cn#hex), å³ 16è¿›åˆ¶é¢œè‰²
-   [RGB](https://developer.chrome.com/docs/css-ui/high-definition-css-color-guide?hl=zh-cn#rgb)
-   [HSL](https://developer.chrome.com/docs/css-ui/high-definition-css-color-guide?hl=zh-cn#hsl)
-   [HWB](https://developer.chrome.com/docs/css-ui/high-definition-css-color-guide?hl=zh-cn#hwb)

çŸ¥é“äº†æ¦‚å¿µï¼Œæˆ‘ä»¬æ¥çœ‹å‡ ç§æ–°çš„é¢œè‰²å®šä¹‰ã€‚

###### HWB


![image.png](/img/posts/2024-1-2/2024-1-2-14.png)

HWBï¼ˆè‰²ç›¸ã€ç™½åº¦ã€é»‘åº¦ï¼‰æ˜¯é¢å‘äººç±»æè¿°é¢œè‰²çš„ sRGB è‰²åŸŸé¢œè‰²ç©ºé—´ï¼š

```css
--modern: hwb(200deg 25% 25%);
```

###### `color()`Â å‡½æ•°


![image.png](/img/posts/2024-1-2/2024-1-2-15.png)

color() æ˜¯ä¸€ä¸ªæ ‡å‡†åŒ–ç©ºé—´ï¼Œç”¨äºè®¿é—®ä½¿ç”¨ RGB é€šé“çš„é¢œè‰²ç©ºé—´ã€‚è€Œä¸”å¯æ‰©å®¹è‡³åŸºäº RGB çš„ä»»ä½•å¹¿è‰²åŸŸè‰²å½©ç©ºé—´ã€‚ä½¿ç”¨ä¸¾ä¾‹ï¼š

```css
--display-p3: color(display-p3 1 1 1);
--srgb: color(srgb 1 1 1);
```

ç”šè‡³ä¹‹å‰çš„ rgb ä¹Ÿå¯ä»¥è¿™ä¹ˆç»Ÿä¸€æ¥å†™ï¼š

```css
--rgb: color(rgb 25 25 25)
```

###### å…¶ä»–

æ­¤å¤–è¿˜æœ‰ lch / lab / oklch / OKLAB / dispaly-p3 ç­‰é¢œè‰²ç©ºé—´ï¼Œç”±äºä¸œè¥¿å¤ªå¤šäº†ï¼Œå°±ä¸ä¸€æ ·åˆ—å‡ºï¼Œä¸Šé¢æœ‰é“¾æ¥ï¼Œå¯ä»¥è‡ªè¡Œç‚¹å‡»æŸ¥çœ‹ã€‚è¿™ç±»CIE ç©ºé—´é¢œè‰²éƒ½èƒ½å¤Ÿæ›´å¥½çš„è¡¨ç¤ºæ•´ä¸ªäººç±»å¯è§çš„è‰²è°±ã€‚ä½¿ç”¨æ–°çš„é¢œè‰²ç©ºé—´è¿˜ä¼šå½±å“é¢œè‰²æ¸å˜å’Œæ’å€¼ç­‰åŠŸèƒ½ã€‚

#### color-mix()

![image.png](/img/posts/2024-1-2/2024-1-2-16.png)

ä»–æ˜¯ç”¨äºé¢œè‰²æ··æ·†çš„å‡½æ•°ï¼Œçµæ„Ÿå¯èƒ½ä¹Ÿæ˜¯æ¥è‡ªcssé¢„å¤„ç†å™¨ã€‚

å®˜æ–¹demoï¼šhttps://codepen.io/web-dot-dev/pen/JjBZLrm

ä¸ºäº†ä¾¿äºç†è§£ï¼Œæˆ‘ä»¬è¿™é‡Œå®ç°ä¸€ä¸ªç®€å•çš„åˆ‡æ¢é¢œè‰²çš„ä¾‹å­ï¼š

[ä¸»é¢˜é¢œè‰²åˆ‡æ¢](https://code.juejin.cn/pen/7317573307016806435)

ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œå„ä¸ªä¸»é¢˜çš„é¢œè‰²ï¼Œé€šè¿‡æ··æ·†å¾—æ¥ã€‚æˆ‘ä»¬æ‹¿ä¸€ä¸ªæ¥è¯´æ˜ä½¿ç”¨æ–¹å¼ã€‚

`color-mix(in oklab, #0af 25%, black)`ï¼šåœ¨ oklab è‰²åŸŸç©ºé—´å†…ï¼Œå°†å¤©è“è‰²çš„25%ä¸é»‘è‰²æ··åˆã€‚æ­¤æ—¶æ–‡å­—çš„é¢œè‰²å¦‚ä¸‹ï¼š


![image.png](/img/posts/2024-1-2/2024-1-2-17.png)

çœ‹ç€æ˜¯é»‘è‰²çš„ï¼Œå…¶å®æœ‰ç‚¹è“éŸµã€‚å¦‚æœå°† 25% è°ƒæ•´åˆ° 75% å°±ä¼šæ˜æ˜¾äº†ï¼š


![image.png](/img/posts/2024-1-2/2024-1-2-18.png)

#### from å…³é”®å­—

å¯ä»¥çœ‹åšæ˜¯ color-mix çš„æ‰©å±•å¢å¼ºï¼š

`color: rgb(from green r g b)`

ç­‰ä»·äº ` color: rgb(0 128 0)`ï¼Œæ„æ€æ˜¯ä» green å¼€å§‹ï¼Œæ‹¿åˆ° rgb çš„å€¼ï¼Œå¹¶åœ¨ä¹‹åçš„å‚æ•°ä¸­ä½¿ç”¨ï¼Œä»–è®¡ç®—çš„æ˜¯è½¬æ¢åçš„ç›¸å¯¹é¢œè‰²ã€‚äºæ˜¯ä¼šæœ‰å¦‚ä¸‹å†™æ³•ï¼š

```css
// r g b æ˜¯ä¸‰ä¸ªå˜é‡ï¼Œå¯ä»¥æ¢é¡ºåºä½¿ç”¨
rgb(from green g g g) /* rgb(128 128 128) */
rgb(from green b r g) /* rgb(0 0 128) */
rgb(from green 0 0 g) /* rgb(0 0 128) */
```
å½“ç„¶èªæ˜çš„ä½ ä¹Ÿèƒ½çŒœåˆ°ï¼Œé€æ˜åº¦ä¹Ÿèƒ½å½“åšå˜é‡ï¼š

```css
rgb(from rgba(0, 128, 0, .5) r g b / alpha) /* alpha=50% */
```
ä¸Šé¢å°±ç›¸å½“äºå°†é¢œè‰²æ‰“æˆå„ä¸ªé€šé“åˆ†é‡æ¥å®ç°æ··æ·†ã€‚æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªï¼š`background: hsl(from blue calc(h + 180) s l)`.

è¿™ä¸ªæ˜¯ hsl çš„è½¬å˜ï¼Œå…¶ä¸­ç¬¬ä¸€ä¸ªé€šé“åˆ†é‡åŠ äº† 180 åè¿”å›ï¼Œå…¶å®æ˜¯æ±‚è“è‰²çš„äº’è¡¥è‰²ï¼š


![image.png](/img/posts/2024-1-2/2024-1-2-19.png)

## 5. å“åº”å¼è®¾è®¡

æ–°çš„ä¸€å¹´ï¼Œå“åº”å¼å¸ƒå±€åˆæœ‰äº†æ–°çš„å†™æ³•ã€‚

#### æŸ¥è¯¢å®¹å™¨å¤§å°


![image.png](/img/posts/2024-1-2/2024-1-2-20.png)

ç›¸æ¯”äºä¼ ç»Ÿçš„åª’ä½“æŸ¥è¯¢ï¼Œå®¹å™¨æŸ¥è¯¢æ›´åŠ ç»†ç²’åº¦ï¼Œä»–å¯ä»¥åº”ç”¨åœ¨å±€éƒ¨å®¹å™¨æˆ–è€…æŒ‡å®šå®¹å™¨å†…:

```css
container: card / inline-size;
```

è¿™æ ·å°±åˆ›å»ºäº†ä¸€ä¸ªå«åš card çš„é€‚åº”å†…åµŒå¤§å°çš„å“åº”å¼å®¹å™¨ï¼Œå¯ä»¥è¿™æ ·ä½¿ç”¨æŸ¥è¯¢ï¼š

```css
/* åªæœ‰ä¸€ä¸ªå®¹å™¨æ—¶ï¼Œåå­— card å¯ä»¥çœç•¥ */
@container card (max-width: 400px) {

}
```

æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªä¾‹å­ï¼š[å“åº”å¼å®¹å™¨](https://code.juejin.cn/pen/7317593902143012902)

#### å®¹å™¨æ ·å¼

æ­¤å¤–ï¼Œåœ¨ Chrome 111 ä¸­ï¼Œæ ·å¼æŸ¥è¯¢å·²éƒ¨åˆ†å®ç°ï¼šå¯ä»¥ä½¿ç”¨Â `@container style()`Â æŸ¥è¯¢çˆ¶å…ƒç´ ä¸Šçš„è‡ªå®šä¹‰å±æ€§çš„å€¼ã€‚æˆ‘ä»¬æ¥çœ‹ä¸ªä¾‹å­ï¼ˆå…¼å®¹æ€§ä¸å¥½ï¼‰ï¼š


![image.png](/img/posts/2024-1-2/2024-1-2-21.png)

```css
@container style(--theme: pink) {
  .demo-btn {
    background: linear-gradient(45deg, pink, violet);
    border: 4px double #f452dc;
  }
}
```
ä¸Šé¢çš„ä¾‹å­ï¼Œæ ¹æ®å˜é‡ theme çš„å€¼åŠ¨æ€æ·»åŠ æ ·å¼ï¼Œå®Œæ•´ demo å¦‚ä¸‹ï¼š

https://codepen.io/web-dot-dev/pen/GRXZLvW


#### :has()


![image.png](/img/posts/2024-1-2/2024-1-2-22.png)

å­—é¢æ„æ€å°±æ˜¯è¯´é€‰ä¸­æ‹¥æœ‰æŸä¸ªå±æ€§çš„å…ƒç´ ï¼š

```css
.card:has(.card__media) {
  --color: #6300ff;
}
```
ä¸Šé¢çš„ä»£ç ï¼Œæ˜¯é€‰ä¸­æ‹¥æœ‰ä¸€ä¸ªç±»å« card__media çš„ card å…ƒç´ ã€‚ä»–å¯ä»¥è®©ä½ åœ¨ä¼—å¤šç›¸åŒçš„ç±»åå« card çš„å…ƒç´ ä¸­é€‰ä¸­ä½ æƒ³è¦çš„ã€‚

å…¶ä¸ä½†å¯ä»¥åœ¨ DOM æ ‘ä¸­å‘ä¸Šé€‰æ‹©çˆ¶çº§å…ƒç´ ï¼Œä¹Ÿå¯ä»¥è¿›è¡Œæ¨ªå‘é€‰æ‹©ã€‚

æ¯”å¦‚æœ‰ä¸ªåˆ—è¡¨ï¼š

```html
<ul class="dock">
  <li></li>
  ...
  <li></li>
</ul>
```
æ¯ä¸€ä¸ª li é‡Œæ˜¯ä¸€ä¸ªåˆ—è¡¨å›¾ç‰‡ï¼Œæˆ‘ä»¬æƒ³å®ç°é¼ æ ‡æ»‘åŠ¨å˜å¤§ï¼Œè¿™ä¹ˆå†™ï¼š

```css
.dock li:hover {
  width: 3em;
}
.dock li:hover img {
  translate: 0% -15%;
}
```


![image.png](/img/posts/2024-1-2/2024-1-2-23.png)

å¦‚æœæƒ³å®ç° mac ç³»ç»Ÿé‚£ç§ï¼Œå·¦å³å›¾ç‰‡ä¹Ÿä¼šå˜å¤§çš„åŠ¨ç”»ï¼Œå¯ä»¥è¿™ä¹ˆå†™ï¼š

```css
.dock li:hover + li,
.dock li:has(+ li:hover) {
  width: 2.5em;
}
```
ä¸ä½†é€‰æ‹©å…¶ä¸‹ä¸€ä¸ªå…„å¼ŸèŠ‚ç‚¹ï¼Œè¿˜ä½¿ç”¨ has é€‰æ‹©å…¶ä¸Šä¸€ä¸ªå…„å¼ŸèŠ‚ç‚¹ï¼š


![image.png](/img/posts/2024-1-2/2024-1-2-24.png)

#### åª’ä½“æŸ¥è¯¢æœ‰äº†æ–°åŠŸèƒ½

åŸæ¥å·²æœ‰çš„åª’ä½“æŸ¥è¯¢åŠŸèƒ½å¾—åˆ°äº†å²è¯—çº§åŠ å¼ºã€‚

###### é€‚åº”è®¾å¤‡åˆ·æ–°ç‡

![image.png](/img/posts/2024-1-2/2024-1-2-25.png)

æ–°å¢å¦‚ä¸‹å†™æ³•ï¼š

```css
@media (update: none) {

}
```

å¯¹äºå¤§å¤šæ•°æ–°ç‰ˆè®¾å¤‡ï¼Œå…¶æ›´æ–°ä¸€èˆ¬æ˜¯ fastï¼Œä½†æ˜¯é’ˆå¯¹ç”µå­é˜…è¯»å™¨ä»¥åŠä½èƒ½è€—ä»˜æ¬¾ç³»ç»Ÿç­‰è®¾å¤‡ï¼Œå…¶åˆ·æ–°ç‡å¯èƒ½è¾ƒæ…¢ï¼Œå¯ä»¥ä½¿ç”¨ slow é€‚é…ï¼Œå…¶ä½™çš„åƒæ‰“å°æœºä¸€ç±»çš„ï¼Œå¯ä»¥è®¾ç½®ä¸º noneã€‚[demo](https://codepen.io/web-dot-dev/pen/PoyPMBw)

æ ¹æ®ä¸åŒçš„è®¾å¤‡åˆ·æ–°ç‡é‡‡ç”¨ä¸åŒçš„ CSS è¡¨ç°å½¢å¼ï¼Œæ„å‘³ç€æ‚¨å¯ä»¥èŠ‚çœç”µæ± ç”µé‡æˆ–å‡å°‘é”™è¯¯çš„è§†å›¾æ›´æ–°ã€‚ç”±äºä½“éªŒè€…ä¸å¯èƒ½å‡‘é½åˆ·æ–°ç‡ä¸åŒçš„è®¾å¤‡ä¸å¤ªå®¹æ˜“ï¼Œè¿™é‡Œä½¿ç”¨jsæ¥æ¨¡æ‹Ÿè¯´æ˜ï¼š

[å®˜æ–¹demoï¼šå°é¸­å­æ‘‡å¤´](https://code.juejin.cn/pen/7319044288761823258)

> demo æ˜¯ä½¿ç”¨jsæ¨¡æ‹Ÿåˆ·æ–°ç‡ä¸åŒçš„è®¾å¤‡ï¼Œå¹¶ä¸æ˜¯å¯¹ update çš„ä½¿ç”¨è¯´æ˜

###### åª’ä½“æŸ¥è¯¢æ£€æŸ¥jsè„šæœ¬


![image.png](/img/posts/2024-1-2/2024-1-2-26.png)

è„šæœ¬åª’ä½“æŸ¥è¯¢å¯ç”¨äºæ£€æŸ¥ JavaScript æ˜¯å¦å¯ç”¨ã€‚è¿™å¯¹äºæ¸è¿›å¼å¢å¼ºéå¸¸æœ‰ç”¨ã€‚åœ¨æ­¤åª’ä½“æŸ¥è¯¢æ¨å‡ºä¹‹å‰ï¼Œä¸€ä¸ªç”¨äºæ£€æµ‹ JavaScript æ˜¯å¦å¯ç”¨çš„ç­–ç•¥æ˜¯åœ¨ HTML ä¸­æ”¾ç½®ä¸€ä¸ªÂ `nojs`Â ç±»ï¼Œç„¶åä½¿ç”¨ JavaScript å°†å…¶ç§»é™¤ã€‚ç°åœ¨å¯ä»¥ä½¿ç”¨ css æ¥æ£€æµ‹äº†ï¼š

```css
@media (scripting: enabled) {
  .steam {
    opacity: 1;
  }
}
```

###### ç”¨äºå‡ä½é€æ˜åº¦çš„åª’ä½“æŸ¥è¯¢


![image.png](/img/posts/2024-1-2/2024-1-2-27.png)

éä¸é€æ˜ç•Œé¢å¯èƒ½ä¼šå¼•èµ·å¤´ç—›ï¼Œæˆ–è€…è®©å„ç±»è§†åŠ›ç¼ºé™·äººç¾¤é€ æˆè§†è§‰éšœç¢ã€‚å› æ­¤ï¼ŒWindowsã€macOS å’Œ iOS è®¾æœ‰ç³»ç»Ÿåå¥½è®¾ç½®ï¼Œå¯ä»¥é™ä½æˆ–ç§»é™¤ç•Œé¢çš„é€æ˜åº¦ã€‚è¿™ä¸ªé’ˆå¯¹Â `prefers-reduced-transparency`Â çš„åª’ä½“æŸ¥è¯¢éå¸¸é€‚åˆä½¿ç”¨å…¶ä»–åå¥½è®¾ç½®åª’ä½“æŸ¥è¯¢ï¼š

```css
svg {
    --transparency: 50%;
    
    @media (prefers-reduced-transparency: reduce) {
      --transparency: 95%;
    }
}
```

## 6. äº¤äº’

#### è§†å›¾è½¬æ¢ API


![image.png](/img/posts/2024-1-2/2024-1-2-28.png)

å®˜æ–¹è¯´æ˜æ˜¯å¢å¼ºcssè¿‡æ¸¡ï¼Œæ›´å¥½çš„å‡å°‘å¡é¡¿å’Œå›¾å½¢äº¤å ã€‚

ä½¿ç”¨ï¼š`const viewTransition = document.startViewTransition(updateCallback)`

ä½¿ç”¨æ–¹å¼å¾ˆåƒ requestAnimationFrameï¼Œè¿™ä¸ªæ˜¯åœ¨å½“å‰äº‹ä»¶å¾ªç¯ç»“æŸå‰æ‰§è¡Œå›è°ƒï¼Œè€Œæˆ‘ä»¬ä»Šå¤©çš„è¿™ä¸ª APIï¼Œä¼šæ•è·ç½‘é¡µçš„å½“å‰çŠ¶æ€ã€‚è¿™åŒ…æ‹¬æˆªå–å±å¹•æˆªå›¾ã€‚å®Œæˆåï¼Œç³»ç»Ÿä¼šè°ƒç”¨ä¼ é€’ç»™Â `.startViewTransition()`Â çš„å›è°ƒ updateCallbackã€‚è¿™æ­£æ˜¯ DOM å‘ç”Ÿå˜åŒ–çš„åœ°æ–¹ã€‚ç„¶åï¼ŒAPI ä¼šæ•è·ç½‘é¡µçš„æ–°çŠ¶æ€ã€‚

å®˜æ–¹è¯´æ˜å¦‚ä¸‹ï¼š[startViewTransition](https://developer.chrome.com/docs/web-platform/view-transitions/?hl=zh-cn#why_do_we_need_this_feature)ï¼Œ æœ‰å…´è¶£çš„å¯ä»¥è‡ªè¡ŒæŸ¥çœ‹ã€‚

#### linear()


![image.png](/img/posts/2024-1-2/2024-1-2-29.png)

è¯¥å‡½æ•°ç”¨äºæ¨¡æ‹Ÿçº¿æ€§æ’å€¼æ¥è¿‘ä¼¼è®¡ç®—åŠ /å‡é€Ÿç±»å‹çš„åŠ¨ç”»ã€‚ä½¿ç”¨æ–¹å¼å¦‚ä¸‹ï¼š

```css
:root {
  --custom-easing: linear(
    0,
    0.06,
    0.25 18%,
    1 36%,
    0.81,
    0.75,
    0.81,
    1,
    0.94,
    1,
    1
  );
}
```
å¯ä»¥æŸ¥çœ‹åœ¨çº¿ [demo](https://linear-easing-generator.netlify.app/) æ¥åˆ›å»ºä¸€ä¸ªä½¿ç”¨æ¡ˆä¾‹ã€‚

#### Scroll End API


![image.png](/img/posts/2024-1-2/2024-1-2-30.png)

å®˜æ–¹å¯¹æ»šåŠ¨äº‹ä»¶çš„å¢å¼ºï¼Œç»ˆäºæœ‰äº†è‡ªå·±çš„æ»šåŠ¨åˆ°åº•çš„æ£€æµ‹äº†ï¼Œè¿™å¯¹äºé•¿åˆ—è¡¨æ¸²æŸ“å¾ˆæœ‰å¸®åŠ©ï¼š

```js
document.onscrollend = event => {
  Toast('scroll end')
}
```

#### æ»šåŠ¨æ¡é©±åŠ¨åŠ¨ç”»

è¿™ä¸ªæ˜¯æ¯”è¾ƒæƒŠè‰³çš„æ›´æ–°äº†ï¼Œå¤§å¤šæ•°é—¨æˆ·ç½‘ç«™éƒ½æœ‰æ»šåŠ¨æ‡’åŠ è½½æˆ–è€…æ·¡å…¥æ·¡å‡ºçš„åŠ¨ç”»æ•ˆæœï¼Œè¿™æ¬¡æ”¹åŠ¨è¡¥å…¨äº†ä¹‹å‰åŸç”Ÿ css æ²¡æœ‰æ»šåŠ¨æ£€æµ‹çš„ç©ºç™½ã€‚

å®˜æ–¹æ¼”ç¤º demoï¼š[Scroll-driven Animations (scroll-driven-animations.style)](https://scroll-driven-animations.style/)

å…¶ä¸»è¦æ˜¯é€šè¿‡ `animation-timeline` å±æ€§è®¾ç½®é©±åŠ¨ï¼Œå¯é€‰çš„é©±åŠ¨æ–¹å¼æœ‰ `scoll` å’Œ `view`ã€‚æˆ‘ä»¬çœ‹ä¸‹é¢çš„ä¾‹å­ï¼š[æ»šåŠ¨åŠ¨ç”»](https://code.juejin.cn/pen/7319093484529877007)

`animation: text steps(var(--chars)) forwards;` æ¥æ£€æµ‹æ»šåŠ¨çš„åç§»é‡ï¼Œå¹¶ä¼ ç»™å˜é‡ --charsmï¼Œç„¶åå¯ä»¥é€šè¿‡åç§»é‡è®¾ç½®æ–‡å­—èƒŒæ™¯è‰²çš„å®½åº¦ï¼š

![image.png](/img/posts/2024-1-2/2024-1-2-31.png)

å¦ä¸€ç§é©±åŠ¨æ–¹å¼ view è¿™ä¹ˆå®šä¹‰ï¼š`animation-timeline: view();`ï¼Œå¯é€šè¿‡ animation-range è®¾ç½®å˜åŒ–èŒƒå›´ï¼Œç”¨äºç›‘æµ‹å½“å‰å…ƒç´ æ˜¯å¦åœ¨å¯è§†åŒºåŸŸï¼Œå®˜æ–¹ demoï¼š[CSS Wrapped 2023: Scroll-Driven Animations: View Timeline #CSSWrapped2023 (codepen.io)](https://codepen.io/web-dot-dev/pen/XWOqovr)

#### ç»™ display: none æ·»åŠ åŠ¨ç”»


![image.png](/img/posts/2024-1-2/2024-1-2-32.png)

chrome æ–°å¢åŠŸèƒ½ï¼š`transition-behavior`ï¼Œæ¥å—ä¸¤ä¸ªå€¼ï¼š`normal`Â å’ŒÂ `allow-discrete`ï¼Œå…¶ä¸­ `allow-discrete`Â æ¨¡å¼å¯å®ç°ç¦»æ•£è½¬æ¢ã€‚ä½¿ç”¨æ–¹å¼ï¼š

```css
.card {
  transition: opacity 0.25s, display 0.25s;
  transition-behavior: allow-discrete;
}
```

demo: [åˆ é™¤å¡ç‰‡](https://codepen.io/web-dot-dev/pen/poQMLrN)

#### `@starting-style`


![image.png](/img/posts/2024-1-2/2024-1-2-33.png)

`@starting-style`Â CSS è§„åˆ™ä»¥æ–°çš„ Web åŠŸèƒ½ä¸ºåŸºç¡€ï¼Œç”¨äºåœ¨Â `display: none`Â ä¹‹é—´æ·»åŠ åŠ¨ç”»æ•ˆæœï¼Œä½†ä¹Ÿå¯ä»¥ç”¨äºå…¶ä»–çš„ transitionã€‚å¯ä»¥çœ‹è¿™ä¸ª [demo](https://codepen.io/web-dot-dev/pen/OJdjjdX)

å¼¹çª—é»˜è®¤æ˜¯éšè—åœ¨å±å¹•ä¹‹ä¸‹çš„ï¼š

```css
dialog {
  transition: translate 0.7s ease-out, overlay 0.7s ease-out, display 0.7s ease-out allow-discrete;
  translate: 0 100vh;
}
```

è®¾ç½®å¼€å…³ï¼š

```css
dialog[open] {
  translate: 0 0;
}
```

ä½†æ˜¯è¿™ä¸ªæ˜¯çªç„¶å‡ºç°çš„ï¼Œæ˜æ˜è®¾ç½®äº† transition: translateï¼Œè¿‡æ¸¡å´æ²¡å‡ºæ¥ï¼Œåº”è¯¥æ˜¯ h5 çš„ dialog çš„ open çœ‹åš display çš„ä¿®æ”¹äº†å§ã€‚æˆ‘ä»¬è®¾ç½®è¿‡æ¸¡ï¼š

```css
@starting-style {
  dialog[open] {
    translate: 0 100vh;
  }
}
```
æ­¤æ—¶å°±æœ‰åŠ¨ç”»äº†ã€‚

#### overlayÂ ã€:popover-open ä¸Â ::backdrop

![image.png](/img/posts/2024-1-2/2024-1-2-34.png)

css åŸç”Ÿä¹Ÿå¼€å§‹æ”¯æŒå¼¹å‡ºå±‚äº†ï¼Œé™¤äº†ä¸Šé¢ h5 çš„ dialogï¼Œè¿™é‡Œè¿˜æœ‰ popover çš„ css å±æ€§ã€‚

å®˜æ–¹ demoï¼š[CSSWrapped2023 Overlay (codepen.io)](https://codepen.io/web-dot-dev/pen/zYeJbgw)

## 7. ç»„ä»¶

#### popover


![image.png](/img/posts/2024-1-2/2024-1-2-35.png)

è¯¥ç»„ä»¶æœ‰å¦‚ä¸‹ç‰¹ç‚¹ï¼š

-   **æ™‹å‡åˆ°é¡¶å±‚**ã€‚å¼¹å‡ºå¼çª—å£ä¼šæ˜¾ç¤ºåœ¨ç½‘é¡µå…¶ä½™éƒ¨åˆ†ä¹‹ä¸Šçš„å•ç‹¬å›¾å±‚ä¸Šï¼Œå› æ­¤æ— éœ€è°ƒæ•´ z-indexã€‚
-   **è½»å…³é—­åŠŸèƒ½**ã€‚ç‚¹å‡»å¼¹å‡ºçª—å£åŒºåŸŸä»¥å¤–çš„ä½ç½®å°†å…³é—­å¼¹å‡ºçª—å£å¹¶è¿”å›ç„¦ç‚¹ã€‚
-   **é»˜è®¤ç„¦ç‚¹ç®¡ç†**ã€‚æ‰“å¼€å¼¹å‡ºå¼çª—å£ä¼šä½¿ä¸‹ä¸€ä¸ªæ ‡ç­¾é¡µåœæ­¢åœ¨å¼¹å‡ºå¼çª—å£å†…æ˜¾ç¤ºã€‚
-   **æ— éšœç¢é”®ç›˜ç»‘å®šã€‚** ç‚¹æŒ‰Â `esc`Â é”®æˆ–åŒé‡åˆ‡æ¢æŒ‰é’®ä¼šå…³é—­å¼¹å‡ºå¼çª—å£å¹¶è¿”å›ç„¦ç‚¹ã€‚
-   **å¯è®¿é—®çš„ç»„ä»¶ç»‘å®š**ã€‚ä»è¯­ä¹‰ä¸Šå°†å¼¹å‡ºå¼çª—å£å…ƒç´ è¿æ¥åˆ°å¼¹å‡ºå¼çª—å£è§¦å‘å™¨ã€‚

åªéœ€è¦ç»™ä¸€ä¸ªæ™®é€šçš„ div åŠ ä¸Š `popover` å±æ€§ï¼Œç„¶åç»™æŒ‰é’®å‘¢åŠ ä¸Š `popovertarget` å¯¹åº”è¿™ä¸ª div çš„ id å³å¯ã€‚è¯¦æƒ…å¯ä»¥æŸ¥çœ‹ [demo](https://code.juejin.cn/pen/7319331878450757670):


![image.png](/img/posts/2024-1-2/2024-1-2-36.png)

#### hr æ ‡ç­¾ç„•å‘æ–°æ˜¥

ä¹‹å‰å¯¹ hr æ ‡ç­¾çš„ç†è§£å°±æ˜¯å¾ˆä¸‘çš„æ¨ªçº¿ï¼Œæ¯”è¾ƒé¸¡è‚‹ï¼ŒUIåº“éƒ½ä¼šå»è‡ªå·±å®ç°åˆ†å‰²çº¿ï¼Œè¿™ä¸ H5 çš„åˆè¡·ç›¸è¿èƒŒï¼Œåˆ¶å®šæ ‡å‡†çš„äººéƒ½å¸Œæœ›è‡ªå·±çš„ç»„ä»¶èƒ½è¢«å„ä¸ªä¸»æµ UI åº“ä½¿ç”¨æ¥è¿›è¡ŒäºŒæ¬¡å¼€å‘ã€‚

> ä½†ç°åœ¨è·¯è¿˜å¾ˆé•¿ï¼Œselect ç»„ä»¶è¿˜æ˜¯åŠŸèƒ½æ¬ ç¼ºï¼Œå„ä¸ªUIåº“ä¸å¾—ä¸è‡ªå·±å®ç°

ç°åœ¨ hr å¯ä»¥å’Œ select ç»“åˆä½¿ç”¨äº†ï¼š

```html
<select name="majors" id="major-select">
  <option value="">Select a favorite feature</option>
  <hr>
  <optgroup label="Foundations">
    <option value="trig">Trigonometric functions</option>
    <option value="nth">Complex nth-* selection</option>
    <option value="nesting">Nesting</option>
    <option value="subgrid">Subgrid</option>
    <option value="mq-ranges">Media query range syntax</option>
  </optgroup>
  ...
```

æ„Ÿè§‰è¿˜ä¸é”™ï¼ˆä½†æ˜¯åŸç”Ÿ select è¿æœç´¢éƒ½ä¸æ”¯æŒï¼Œå¯èƒ½ä¼ä¸šçº§è½åœ°è¿˜æœ‰äº›å›°éš¾ï¼‰ï¼š


![image.png](/img/posts/2024-1-2/2024-1-2-37.png)

#### `:user-valid`Â å’ŒÂ `:user-invalid`

![image.png](/img/posts/2024-1-2/2024-1-2-38.png)

è¿™ä¸¤ä¸ªä¼ªç±»æ˜¯ç”¨äºç”¨æˆ·ä¸è¾“å…¥å†…å®¹æ ¡éªŒçš„ï¼Œåœ¨è¿›è¡Œæ˜æ˜¾äº’åŠ¨åæ ¡éªŒè¡¨å•æ˜¯å¦æ— æ•ˆã€‚

ä¸‹é¢æ˜¯ä¸ªä¾‹å­ï¼ˆæ ¡éªŒåŸç”Ÿ h5 è¡¨å•çš„è§„åˆ™ï¼‰ï¼Œå¯ç”¨äºè¯´æ˜ä¸ :valid çš„åŒºåˆ«ï¼š[è¡¨å•æ ¡éªŒ](https://code.juejin.cn/pen/7319341325450412067)

#### æ‰‹é£ç´ç»„ä»¶


![image.png](/img/posts/2024-1-2/2024-1-2-39.png)

è¿™ä¸ªç»„ä»¶ç”¨çš„è¿˜æ˜¯ h5 çš„ details æ ‡ç­¾ï¼Œä¸æ˜¯ä¸ªæ–°ä¸œè¥¿äº†ï¼Œä½†æ˜¯å…¶å¢åŠ äº†`name`Â å±æ€§çš„æ”¯æŒã€‚ä½¿ç”¨æ­¤å±æ€§æ—¶ï¼Œå…·æœ‰ç›¸åŒÂ `name`Â å€¼çš„å¤šä¸ªÂ `<details>`Â å…ƒç´ ä¼šå½¢æˆè¯­ä¹‰ç»„ã€‚

æˆ‘ä»¬æ¥çœ‹ [demo](https://code.juejin.cn/pen/7319383154270142479)

----

## 8. æ€»ç»“

å‰ç«¯ CSS çš„å‘å±•è¶‹åŠ¿æ˜¯ç´§è´´ç”¨æˆ·ä¸»æµä½¿ç”¨ä¹ æƒ¯ï¼Œå¹¶å€Ÿé‰´å„ä¸ª UI åº“å’Œæ¡†æ¶çš„ä½¿ç”¨æ–¹å¼æ”¹é€ ï¼Œä¸ H5 æ ‡ç­¾ç»“åˆï¼ŒåŠ›å›¾å®Œå–„è‡ªå·±çš„ç»„ä»¶ä½“ç³»ï¼Œè·Ÿä¸Šæ—¶ä»£çš„å˜åŒ–æ½®æµã€‚æ•´ä½“æ–¹å‘å¦‚ä¸‹ï¼š

- å“åº”å¼å’Œç§»åŠ¨ä¼˜å…ˆè®¾è®¡
- CSS å˜é‡ä¸æµç¨‹æ§åˆ¶æ“ä½œè¶Šæ¥è¶Šå¤šï¼Œæ‰“é€šä¸ js çš„å±éšœ
- åŠ¨ç”»ä¸è¿‡æ¸¡ä¼˜åŒ–
- é¢œè‰²ç©ºé—´æ‰©å……
- æ˜“ç”¨æ€§å¢å¼ºï¼Œå‡½æ•°æ‰©å……
- æ€§èƒ½ä¼˜åŒ–11:T6237,Tailwind CSSæ˜¯ä¸€ä¸ªåŠŸèƒ½ç±»ä¼˜å…ˆçš„CSSæ¡†æ¶ï¼Œå¸®åŠ©å¼€å‘è€…å¿«é€Ÿå¼€å‘ CSSï¼Œçµæ´»å¯å®šåˆ¶ã€‚é‰´äºå®˜ç½‘çš„æè¿°æ¯”è¾ƒæ™¦æ¶©ï¼Œæ–°æ‰‹ä¸Šæ‰‹æ¯”è¾ƒéš¾ï¼Œæœ‰å„ç§å‘éœ€è¦è¸©ï¼Œå®æ“æ€§ä¸å¼ºï¼Œæœ¬æœŸå°±å¸¦å¤§å®¶äº†è§£ä¸€ä¸‹è¿™ä¸ª CSS å¿«é€Ÿå¼€å‘æ¡†æ¶çš„ä½¿ç”¨ä»¥åŠä¸€äº›å¸¸ç”¨çš„é…ç½®ã€‚

> æœ¬æ–‡å†™ç»™æ²¡æ—¶é—´æŸ¥é˜…æ–‡æ¡£ï¼Œä½†åˆæƒ³å¿«é€Ÿä¸Šæ‰‹çš„å¼€å‘è€…ã€‚æœ¬æ–‡æ¶‰åŠåˆ°çš„çŸ¥è¯†ï¼Œè¦†ç›–äº†å¹³æ—¶ä¸šåŠ¡å¼€å‘çš„å¤§å¤šæ•°åœºæ™¯ï¼Œå¯ä¾›å‚è€ƒæŸ¥é˜…
>  
> å¼€å‘ç¯å¢ƒï¼šnode16+ | VS Code
> 
> [å®˜ç½‘ä¸­æ–‡é•œåƒ](https://tailwind.nodejs.cn/)

å¦‚æœæ‚¨å·²ç»æŒæ¡äº† Tailwind çš„åŸºæœ¬åŸç†ï¼Œåªæƒ³çŸ¥é“å…·ä½“æ¡†æ¶å¦‚ä½•é…ç½®ï¼Œå¯ä»¥ç›´æ¥è·³è½¬åˆ°ä¸‹é¢å¯¹åº”ç« èŠ‚æŸ¥é˜…ã€‚


----

## 1. VS Code æ’ä»¶


![image.png](/img/posts/2023-11-11/2023-11-11-1.png)

å®‰è£…å¥½åå°±å¯ä»¥æœ‰è‡ªåŠ¨æç¤ºäº†ï¼š

![image.png](/img/posts/2023-11-11/2023-11-11-2.png)

æ’ä»¶è¿˜å¯ä»¥é«˜äº®é”™è¯¯. é¢„è§ˆå†…ç½®cssæ ·å¼. è®¾ç½®è¯­è¨€ç¯å¢ƒç­‰ï¼Œæ¨è VS Code ç”¨æˆ·ä½¿ç”¨ã€‚


## 2. Tailwind CLI

æ–°å»ºä¸€ä¸ªæ–‡ä»¶å¤¹ï¼Œåœ¨æ–‡ä»¶å¤¹æ ¹ç›®å½•ä¸‹ï¼š

```shell
yarn add --dev tailwindcss
npx tailwindcss init
```

æˆ‘ä»¬ä¼šçœ‹åˆ°ä¸€ä¸ªé…ç½®æ–‡ä»¶ `tailwind.config.js` åœ¨æ ¹ç›®å½•ä¸‹ç”Ÿæˆï¼Œæˆ‘ä»¬æ·»åŠ è¦æ£€ç´¢çš„æ–‡ä»¶ï¼š

```js
/** @type {import('tailwindcss').Config} */
module.exports = {
  content: ['./index.html'],
  theme: {
    extend: {},
  },
  plugins: [],
}
```

è¿™æ ·ï¼ŒTailwind å°±åªä¼šæ£€æµ‹ index.html ä¸­æ˜¯å¦ä½¿ç”¨äº† tailwindcssï¼Œå¹¶å£°ç§°æœ€å° css é›†åˆã€‚æˆ‘ä»¬å†™ä¸€ä¸‹è¿™ä¸ª index.html:

```html
<!doctype html>
<html>
<head>
  <title>hello</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="/dist/output.css" rel="stylesheet">
</head>
<body>
  <h1 class="text-3xl font-bold underline">
    Hello world!
  </h1>
  <button class="underline bg-violet-500 hover:bg-violet-600 active:bg-violet-700 focus:outline-none focus:ring focus:ring-violet-300 ...">
    Save changes
  </button>
</body>
</html>
```
ç„¶ååœ¨ src ç›®å½•ä¸‹å†™ä¸€ä¸ª input.css æ–‡ä»¶ï¼š

```js
@tailwind base;  // å¼•å…¥åŸºç¡€æ ·å¼ï¼Œæ¯”å¦‚ bodyçš„margin. æ ·å¼ç»§æ‰¿è§„åˆ™ç­‰
@tailwind components;  // å¼•å…¥å¸¸ç”¨çš„ç»„ä»¶æ ·å¼ï¼Œä¸€èˆ¬åœ¨å…¶ä»–å‰ç«¯æ¡†æ¶ä¸­ä½¿ç”¨
@tailwind utilities; // å·¥å…·æ ·å¼ï¼Œæ¯”å¦‚ä¸‹åˆ’çº¿. å­—ä½“é¢œè‰²ç­‰
```

æ‰§è¡Œ cliï¼š

```shell
npx tailwindcss -i ./src/input.css -o ./dist/output.css --watch --config ./tailwind.config.js
```

è¿™é‡Œçš„ `--config ./tailwind.config.js` å¯ä»¥ä¸å†™ï¼Œé»˜è®¤ä¼šæ£€ç´¢æ ¹ç›®å½•ä¸‹çš„åŒåæ–‡ä»¶ã€‚


> è¿™é‡Œæœ‰ä¸€ä¸ªå‘ï¼Œå¦‚ä¸‹å›¾

![image.png](/img/posts/2023-11-11/2023-11-11-3.png)

å¦‚æœä½ æ‰§è¡ŒæŒ‡ä»¤åå‡ºç° cliï¼Œæœ‰å¯èƒ½æ˜¯è¾“å…¥è¾“å‡ºçš„æ–‡ä»¶è·¯å¾„ä¸å¯¹ï¼Œä¹Ÿæœ‰å¯èƒ½æ˜¯ç›®æ ‡é…ç½®æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè¿˜æœ‰å¯èƒ½æ˜¯ä½ é…ç½®æ–‡ä»¶æ£€æµ‹çš„ content ä¸å­˜åœ¨æˆ–æ²¡æœ‰ä½¿ç”¨ tailwincssã€‚æˆ‘ç¬¬ä¸€æ¬¡å‡ºç°è¿™ä¸ªé”™è¯¯ï¼Œæ˜¯è¯¯æŠŠ `--config` å†™æˆäº† `--content`...

åˆ°æ­¤ä¸ºæ­¢ï¼Œå°±ç”Ÿæˆä¸€ä¸ªè¾“å‡ºæ–‡ä»¶ï¼Œå·¥ç¨‹ç›®å½•å¦‚ä¸‹ï¼š


![image.png](/img/posts/2023-11-11/2023-11-11-4.png)
 
ç”±äº tailwindcss åªèƒ½è¿è¡Œåœ¨æœåŠ¡å™¨ç¯å¢ƒï¼Œæˆ‘ä»¬è¿™é‡Œå°±æ­å»ºä¸€ä¸ªå¼€å‘æœåŠ¡å™¨æ¥è¯´æ˜é—®é¢˜ï¼š

```shell
yarn add --dev http-server

npx http-server
```
æœåŠ¡è·‘èµ·æ¥ï¼š


![image.png](/img/posts/2023-11-11/2023-11-11-5.png)

æˆ‘ä»¬æ‰“å¼€ 8080 ç«¯å£æŸ¥çœ‹ï¼š


![image.png](/img/posts/2023-11-11/2023-11-11-6.png)

æ ·å¼å·²ç»ä¸Šå»äº†ã€‚

## 3. ä¸ postcss å’Œ sass ç»“åˆä½¿ç”¨

postcss ç”¨äºæ ¼å¼åŒ–æ ·å¼ï¼Œä½¿çš„æ ·å¼æ›´åŠ è§„èŒƒç»Ÿä¸€ï¼Œä¸ä¼šæ ·å¼æ±¡æŸ“ã€‚æˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ªä¾èµ– postcss çš„ autoprefixer ä¸ºæ ·å¼è‡ªåŠ¨å¢åŠ å‰ç¼€ï¼Œæ‰§è¡Œå¦‚ä¸‹æŒ‡ä»¤ï¼š

```shell
yarn add --dev postcss autoprefixer postcss-nesting postcss-import
```
åä¸¤ä¸ªä¾èµ–æ˜¯å®ç°çº§è” css çš„è§£æ å’Œ è§£æ @import è¯­å¥çš„ã€‚æˆ‘ä»¬åœ¨æ ¹ç›®å½•ä¸‹æ–°å»ºæ–‡ä»¶ `postcss.config.js`ï¼Œä»¥æ’ä»¶çš„å½¢å¼å¼•å…¥ä¾èµ–:

```js
module.exports = {
  plugins: {
    'postcss-import': {},
    'tailwindcss/nesting': 'postcss-nesting',
    tailwindcss: {},
    autoprefixer: {},
  }
}
```

å°† input.css æ”¹ä¸º input.scssï¼Œå¹¶ä¿®æ”¹æ–‡ä»¶ï¼š

```scss
@tailwind base;
@tailwind components;
@tailwind utilities;

body {
  h1 {
    font-size: 64px !important;
  }
}

@media (min-resolution: 2dppx) {
  .image {
    background-image: url(image@2x.png);
  }
}
```

ç„¶åæ‰§è¡Œ cli æŒ‡ä»¤ï¼ŒæŒ‡æ˜è¿™ä¸ªé…ç½®æ–‡ä»¶ï¼š

```shell
npx tailwindcss -i ./src/input.scss -o ./dist/output.css --watch --postcss postcss.config.js
```

æˆ‘ä»¬çœ‹çœ‹è¾“å‡ºçš„ output.cssï¼š

```css
body h1 {
  font-size: 64px !important;
}

@media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 2dppx) {
  .image {
    background-image: url(image@2x.png);
  }
}
```
å¯ä»¥çœ‹åˆ°å·²ç»è§£æä¸ºæ™®é€šçš„ cssï¼Œå¹¶æ·»åŠ äº†å…¼å®¹æ€§å‰ç¼€å’Œè‡ªåŠ¨è®¡ç®—å…¼å®¹æ€§å•ä½ã€‚

## 4. å†…ç½®æ ·å¼ç±»é€ŸæŸ¥è¡¨

> å¦‚æœä¸æƒ³çœ‹é€ŸæŸ¥ï¼Œç›´æ¥è°ƒåˆ°åè¾¹æ¡†æ¶ä½¿ç”¨å³å¯

æœ‰ä¸€ä¸ªåˆæ­¥è®¤è¯†åï¼Œæˆ‘ä»¬è¿™é‡Œæ¥åˆ†ç±»æ€»ç»“ä¸€ä¸‹ tailwindcss çš„å¸¸ç”¨æ ·å¼ç±»ï¼Œå¦‚æœæƒ³è¦çœ‹å…¨éƒ¨çš„æ ·å¼ï¼Œå‚è§ï¼š[tailwind](https://tailwind.nodejs.cn/docs/preflight)ã€‚

#### ï¼ˆ1. é¢„æ£€æ ·å¼

`@tailwind base;`

ä»–å¼•å…¥åï¼Œè‡ªåŠ¨è®¾ç½®é»˜è®¤è¾¹è·æ˜¯0. æ‰€æœ‰çš„æ ‡é¢˜æ ‡ç­¾çš„å­—ä½“å¤§å°å’Œæƒé‡ç»§æ‰¿ä»–çš„åŒ…å«å—. åˆ—è¡¨æ ·å¼æ¸…é™¤. å›¾ç‰‡. iframeç­‰å¤šåª’ä½“æ ‡ç­¾è‡ªåŠ¨ä¸ºå—çº§. å›¾ç‰‡è§†é¢‘è‡ªåŠ¨è¢«é™åˆ¶ä¸ºæœ€å¤§çˆ¶çº§å®½åº¦. é‡å†™é»˜è®¤è¾¹æ¡†æ ·å¼ç­‰ã€‚

å½“ç„¶ä½ ä¹Ÿå¯ä»¥æ‰©å±•é¢„æ£€èŒƒå›´ï¼š

```css
@tailwind base;
@layer base { h1 { @apply text-2xl; } }
```

é¢„æ£€æ ·å¼è¡¨å¦‚ä¸‹ï¼šhttps://unpkg.com/tailwindcss@3.3.5/src/css/preflight.css

#### ï¼ˆ2. å¸ƒå±€

çºµæ¨ªæ¯”ï¼š

Class         | Properties            |
| ------------- | --------------------- |
| aspect-auto   | aspect-ratio: auto;   |
| aspect-square | aspect-ratio: 1 / 1;  |
| aspect-video  | aspect-ratio: 16 / 9;|

å“åº”å¼å®¹å™¨ï¼š

Class        | Breakpoint         | Properties   |
| ------------ | ------------------ | ------------ |
| container    | None               | width: 100%; |
|| smÂ (640px)   | max-width: 640px;  |            
|| mdÂ (768px)   | max-width: 768px;  |            
|| lgÂ (1024px)  | max-width: 1024px; |             
|| xlÂ (1280px)  | max-width: 1280px; |             
|| 2xlÂ (1536px) | max-width: 1536px;|

ä½¿ç”¨ä¸¾ä¾‹ï¼š


![image.png](/img/posts/2023-11-11/2023-11-11-7.png)

#### ï¼ˆ3. åˆ—å¸ƒå±€

Class     | Properties  | note |
| --------- | ----------- | -- |
| columns-`{num}` | columns: 1; | numå¯å–ï¼š `[1-12]` |
| columns-auto | columns: auto; |  |
columns-3xs | columns: 16rem; /* 256px */ ||
| columns-2xs | columns: 18rem; /* 288px */||
columns-xs | columns: 20rem; /* 320px */ ||
| columns-sm | columns: 24rem; /* 384px */ ||
| columns-md | columns: 28rem; /* 448px */ ||
| columns-lg | columns: 32rem; /* 512px */ ||
| columns-xl | columns: 36rem; /* 576px */||
| columns-`{num}`xl | columns: 36rem çš„ num å€ |numå¯å–ï¼š `[2-7]` |

æ–‡ç« æœ€åæˆ‘ä»¬ä¼šæœ‰ä¸€ä¸ªå®æˆ˜è¯´æ˜

#### ï¼ˆ4. æº¢å‡ºå¤„ç†

Class              | Properties           |
| ------------------ | -------------------- |
| overflow-auto      | overflow: auto;      |
| overflow-hidden    | overflow: hidden;    |
| overflow-clip      | overflow: clip;      |
| overflow-visible   | overflow: visible;   |
| overflow-scroll    | overflow: scroll;    |
| overflow-x-auto    | overflow-x: auto;    |
| overflow-y-auto    | overflow-y: auto;    |
| overflow-x-hidden  | overflow-x: hidden;  |
| overflow-y-hidden  | overflow-y: hidden;  |
| overflow-x-clip    | overflow-x: clip;    |
| overflow-y-clip    | overflow-y: clip;    |
| overflow-x-visible | overflow-x: visible; |
| overflow-y-visible | overflow-y: visible; |
| overflow-x-scroll  | overflow-x: scroll;  |
| overflow-y-scroll  | overflow-y: scroll;|

#### ï¼ˆ5. å®šä½

| Class    | Properties          |
| -------- | ------------------- |
| static   | position: static;   |
| fixed    | position: fixed;    |
| absolute | position: absolute; |
| relative | position: relative; |
| sticky   | position: sticky;|

#### ï¼ˆ6. display

Class        | Properties             |
| ------------ | ---------------------- |
| block        | display: block;        |
| inline-block | display: inline-block; |
| inline       | display: inline;       |
| flex         | display: flex;|
|...||

flex å¯¹å…¶æ–¹å¼ï¼š

justify-center  | justify-content: center;        |
| --------------- | ------------------------------- |
| justify-between | justify-content: space-between; |
| justify-around  | justify-content: space-around;|
| items-start  | align-items: flex-start; |
| items-end    | align-items: flex-end;   |
| items-center | align-items: center;|


#### ï¼ˆ7. è¾¹è·

Class | Properties                             |
| ----- | -------------------------------------- |
| p-0   | padding: 0px;                          |
| px-0  | padding-left: 0px; padding-right: 0px; |
| py-0  | padding-top: 0px; padding-bottom: 0px;|
|...||

Class | Properties                           |
| ----- | ------------------------------------ |
| m-0   | margin: 0px;                         |
| mx-0  | margin-left: 0px; margin-right: 0px; |
| my-0  | margin-top: 0px; margin-bottom: 0px;|
|...||

å¦‚æœè®¾ç½®å•ä¸ªè¾¹è·ï¼Œå¯ä½¿ç”¨ç¼©å†™ï¼špl-1ï¼špadding-left: 1pxï¼Œä»¥æ­¤ç±»æ¨

#### ï¼ˆ8. æ–‡æœ¬ç±»

| Class         | Properties                                                      |
| ------------- | --------------------------------------------------------------- |
| truncate      | overflow: hidden; text-overflow: ellipsis; white-space: nowrap; |
| text-ellipsis | text-overflow: ellipsis;                                        |
| text-clip     | text-overflow: clip;|
|...||

#### ï¼ˆ9. è¾¹æ¡†

Class    | Properties         |
| -------- | ------------------ |
| border-0 | border-width: 0px; |
| border-2 | border-width: 2px; |
| border-4 | border-width: 4px; |
| border-8 | border-width: 8px; |
| border   | border-width: 1px;|
| rounded-md| border-radius: 0.375rem |
...

#### ï¼ˆ10. åŠ¨ç”»

Class          | Properties                                                                                                                                                                                                                                     |
| -------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| animate-none   | animation: none;                                                                                                                                                                                                                               |
| animate-spin   | animation: spin 1s linear infinite; `@keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }`                                                                                                                    |
| animate-ping   | animation: ping 1s cubic-bezier(0, 0, 0.2, 1) infinite; `@keyframes ping { 75%, 100% { transform: scale(2); opacity: 0; } }    `                                                                                                                 |
| animate-pulse  | animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; `@keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } } `                                                                                                                 |
| animate-bounce | animation: bounce 1s infinite; `@keyframes bounce { 0%, 100% { transform: translateY(-25%); animation-timing-function: cubic-bezier(0.8, 0, 1, 1); } 50% { transform: translateY(0); animation-timing-function: cubic-bezier(0, 0, 0.2, 1); } }`|


#### ï¼ˆ11. é¢œè‰²

- bg å¼€å¤´ (css ä¸­ theme(textColor.) æˆ– theme(colors.) å¼€å¤´) è¡¨ç¤ºèƒŒæ™¯è‰²ï¼Œé€šè¿‡æ’ä»¶å¯ä»¥è‡ªå·±é€‰æ‹©ï¼š


![image.png](/img/posts/2023-11-11/2023-11-11-8.png)

- text (css ä¸­ theme(textColor.) æˆ– theme(colors.)) å¼€å¤´è¡¨ç¤ºæ–‡å­—é¢œè‰²ï¼š


![image.png](/img/posts/2023-11-11/2023-11-11-9.png)

#### ï¼ˆ12. äº‹ä»¶

- snap æˆ– scroll å¼€å¤´ï¼šç›‘å¬æ»šåŠ¨äº‹ä»¶ï¼Œå‚è€ƒ [æ»šåŠ¨](https://tailwind.nodejs.cn/docs/scroll-snap-align)
- hover: å¼€å¤´ï¼šç›‘å¬é¼ æ ‡æ‚¬æµ®äº‹ä»¶
- active: å’Œ focus: å¼€å¤´ï¼šæ•è·æ¿€æ´»çš„å’Œèšç„¦çš„å…ƒç´ 
- first: æ•è·ç¬¬ä¸€ä¸ªå…ƒç´ 
- odd: å’Œ even: æ•è·å¥‡å¶å…ƒç´ 
- è¿˜å¯ä»¥æ•è·ä¼ªå…ƒç´ ï¼šafter: ç­‰ï¼š[ä¼ªå…ƒç´ ](https://tailwind.nodejs.cn/docs/hover-focus-and-other-states#pseudo-elements)

#### ï¼ˆæ’ä»¶

[æ’ç‰ˆæ’ä»¶](https://tailwind.nodejs.cn/docs/typography-plugin)ï¼š

```
yarn add --dev @tailwindcss/typography
```

æ·»åŠ é…ç½®æ–‡ä»¶ï¼š

```js
plugins: [ require('@tailwindcss/typography') ],
```

ä½¿ç”¨ï¼š

```html
<article class="prose lg:prose-xl">
```

[è¡¨å•æ’ä»¶](https://github.com/tailwindlabs/tailwindcss-forms):

```shell
yarn add --dev @tailwindcss/forms
```

é…ç½®ï¼š

```js
plugins: [
  require('@tailwindcss/forms'),
  // ...
],
```

ä½¿ç”¨ï¼š

```html
<input type="email" class="form-input px-4 py-3 rounded-full">

<select class="form-select px-4 py-3 rounded-full">
<!-- ... -->
</select>
```

å¯ç”¨æ ·å¼ï¼š

|å…ƒç´ |class|
| ------------------- | ------------------ |
|`input`     | `form-input`       |
| `textarea`          | `form-textarea`    |
| `select`            | `form-select`      |
| `select[multiple]`  | `form-multiselect` |
| `[type='checkbox']` | `form-checkbox`    |
| `[type='radio']`    | `form-radio`|


## 5. è‡ªå®šä¹‰æ ·å¼

åœ¨é…ç½®æ–‡ä»¶ä¸­å¯ä»¥è¿™æ ·å†™ï¼š

```js
theme: {
    extend: {
      spacing: {
        '8xl': '96rem',
        '9xl': '128rem',
      },
    },
    screens: {
        'sm': '640px', // => @media (min-width: 640px) 
        ...
    },
    colors: {
      'text-blue': '#4848ff'
    }
  },
```

è¿™æ ·å°±å¯ä»¥ä½¿ç”¨äº†ã€‚

åœ¨ css ä¸­ä½¿ç”¨ï¼š

```css
color: theme('colors.text-blue');
max-width: theme('spacing.8xl');
@media (min-width: theme('screens.sm')) {}
```

åœ¨ html ä¸­ä½¿ç”¨ï¼š

```html
<p class="text-text-blue">
<div class="mb-8xl"> <!-- mb æ˜¯ margin bottom -->
<div class="sm:flex"> <!-- è¿™ä¸ªå…ƒç´ åœ¨å±å¹•å®½åº¦å¤§äºç­‰äº 'md' æ—¶å°†ä½¿ç”¨ flex å¸ƒå±€ -->
```

> ç±»åä¸­ï¼Œé¢œè‰²ä¼šè‡ªåŠ¨åŠ å…¥ text å‰ç¼€ã€‚ç”±äºç±»åæ²¡æœ‰è§„åˆ™ï¼Œä¸å¤ªå¥½è®°ï¼Œæ¨èæ–°æ‰‹ä½¿ç”¨ css æ¥å¼•å…¥è‡ªå·±çš„è‡ªå®šä¹‰ä¸»é¢˜

## 6. Nextjs ä¸­ä½¿ç”¨

æ‰§è¡Œå‘½ä»¤è¡Œï¼š

```sh
npx create-next-app@latest
```

å¯é€‰æ‹©é¡¹é€‰æ‹©å¦‚ä¸‹ï¼š

![image.png](/img/posts/2023-11-11/2023-11-11-10.png)

> App router æ˜¯å¦ä¸€ç§è·¯ç”±æ–¹å¼ï¼Œæ¯ä¸€ä¸ªæ–‡ä»¶å¤¹æ˜¯ä¸€ä¸ªé¡µé¢ï¼Œå…¥å£æ–‡ä»¶éƒ½æ˜¯ page.tsxï¼Œå¯å‚è€ƒï¼šhttps://nextjs.org/docs/app/building-your-application/routing/route-groups

å·¥ç¨‹ç›®å½•ç”Ÿæˆåï¼Œé¡¹ç›®ä¼šè‡ªåŠ¨åœ¨æ ¹ç›®å½•ä¸‹å»ºç«‹ postcss.config.js å’Œ tailwind.config.jsã€‚

é¡¹ç›®ç›®å½•å¦‚ä¸‹ï¼š

![image.png](/img/posts/2023-11-11/2023-11-11-11.png)

æˆ‘ä»¬é…ç½®å…¥å£ page.tsx:

```tsx
export default function Home() {
  return (
    <main className="flex min-h-screen flex-col items-center justify-between p-24">
      <h1 className="text-3xl font-bold underline">
        Hello world!
      </h1>
    </main>
  )
}
```
é¡µé¢ä¸ŠæŸ¥çœ‹ï¼š


![image.png](/img/posts/2023-11-11/2023-11-11-12.png)

#### åœ¨ css module ä¸­ä½¿ç”¨

æˆ‘ä»¬åœ¨ dashboard/index.module.css ä¸­å†™å…¥ï¼š

```css
.container {
  color: theme(textColor.purple.400);
}
```
åœ¨ dashboard/page.tsx ä¸­å¼•å…¥ï¼š

```tsx
import styles from './index.module.css';

export default function Page() {
  return <h1 className={`${styles['container']}`}>Hello, Dashboard page!</h1>
}
```

æˆ‘ä»¬è®¿é—®é¡µé¢æŸ¥çœ‹ï¼š


![image.png](/img/posts/2023-11-11/2023-11-11-13.png)

#### åœ¨ mdx æ–‡ä»¶ä¸­ä½¿ç”¨

è‹¥è¦åœ¨ mdx æ–‡ä»¶ä¸­ä½¿ç”¨ï¼ŒApp Router éœ€è¦å¦‚ä¸‹é…ç½®ï¼š

å®‰è£…ä¾èµ–ï¼š

```sh
yarn add  @next/mdx @mdx-js/loader @mdx-js/react @types/mdx
```

åœ¨ src ç›®å½•ä¸‹é…ç½® mdx-components.tsxï¼š

```tsx
import type { MDXComponents } from 'mdx/types'
 
export function useMDXComponents(components: MDXComponents): MDXComponents {
  return {
    ...components,
  }
}
```
ç„¶åæ–°å»ºä¸€ä¸ªåŒ…å« mdx æ–‡ä»¶çš„ç›®å½•ï¼š


![image.png](/img/posts/2023-11-11/2023-11-11-14.png)

page.mdx å†™é“ï¼š

```mdx
<div className="bg-blue-500 p-4">
  This is a styled div.
</div>

Hello Mdx
```

é¡µé¢æŸ¥çœ‹ï¼š


![image.png](/img/posts/2023-11-11/2023-11-11-15.png)

æ ·å¼ç”Ÿæ•ˆäº†ï¼


## 7. vite é¡¹ç›®ä¸­ä½¿ç”¨

æˆ‘ä»¬å…ˆé€šè¿‡ vite åˆ›å»ºä¸€ä¸ª vue é¡¹ç›®ï¼š

```sh
npm create vite@latest my-project -- --template vue
```

ç„¶åè¿›å…¥å·¥ç¨‹æ ¹ç›®å½•ä¸‹ï¼Œå®‰è£…ä¾èµ–å’Œåˆå§‹åŒ–é…ç½®ï¼š

```sh
yarn add --dev tailwindcss postcss autoprefixer
npx tailwindcss init -p
```

é…ç½®æ–‡ä»¶ tailwind.config.js ä¸­å†™å…¥ä½ è¦æ‹¦æˆªçš„ä½¿ç”¨äº†cssèµ„æºçš„æ–‡ä»¶å†…å®¹ï¼š

```js
export default {
  content: [
    "./index.html",
    "./src/**/*.{vue,js,ts,jsx,tsx}",
  ],
  theme: {
    extend: {},
  },
  plugins: [],
}
```

åœ¨ style.css ä¸­å¼•å…¥ï¼š

```css
@tailwind base;
@tailwind components;
@tailwind utilities;
```

æˆ‘ä»¬æŠŠ App.vue ä¸­è‡ªå¸¦çš„æ‰€æœ‰æ ·å¼æ¸…ç©ºï¼Œå†™ä¸‹å¦‚ä¸‹çš„æµ‹è¯•ä»£ç ï¼š

```vue
// æ–‡å­—ç²—ä½“. å¸¦ä¸‹åˆ’çº¿. 3xlå¤§å°
<h1 class="text-3xl font-bold underline"> Hello world! </h1>
```

è¿è¡ŒæœåŠ¡ï¼Œå¯ä»¥çœ‹åˆ°æ•ˆæœå·²ç»å‡ºæ¥ï¼š


![image.png](/img/posts/2023-11-11/2023-11-11-16.png)


## 8. Nuxtjs é¡¹ç›®ä¸­ä½¿ç”¨

nuxtjs æ¨èä½¿ç”¨æ”¯æŒ vue3 çš„æ¨¡å—åŒ–æ–¹æ¡ˆ nuxiã€‚æˆ‘ä»¬å…ˆåˆå§‹åŒ–é¡¹ç›®ï¼š

```sh
npx nuxi init my-project
```

ç„¶åè¿›å…¥æ ¹ç›®å½•ä¸‹å®‰è£…ä¾èµ–ï¼š

```sh
yarn
npx nuxi module add @nuxtjs/tailwindcss
npx tailwindcss init
```
è¿™é‡Œä¸éœ€è¦æ‰‹åŠ¨ä¿®æ”¹ tailwin.config.jsï¼Œä½¿ç”¨é»˜è®¤å€¼å°±å¯ä»¥ï¼Œçœ‹æ¥ nuxt çš„é›†æˆåº¦è¿˜æŒºé«˜çš„ã€‚ç›´æ¥å¯åŠ¨é¡¹ç›®ï¼Œä¿®æ”¹ app.vue:

```vue
<template>
<h1 class="text-3xl font-bold underline">
  Hello world!
</h1>
</template>
```

æŸ¥çœ‹æ•ˆæœï¼š


![image.png](/img/posts/2023-11-11/2023-11-11-17.png)

## 9. å®æˆ˜

#### ï¼ˆ1. åˆ‡æ¢ä¸»é¢˜

tailwindcss å†…ç½®äº† dark å¤œé—´æ¨¡å¼ï¼Œå¯ä»¥æ”¯æŒç™½å¤©å’Œé»‘å¤œçš„åˆ‡æ¢ã€‚æ¯”å¦‚ä½¿ç”¨å®˜æ–¹çš„è¿™ä¸ªä¾‹å­ï¼Œä½¿ç”¨æµè§ˆå™¨Â `prefers-color-scheme` åª’ä½“åŠŸèƒ½è¿›è¡Œå˜æ¢ï¼š

```html
<div class="bg-white dark:bg-slate-800 rounded-lg px-6 py-8 ring-1 ring-slate-900/5 shadow-xl">
  <div>
    <span class="inline-flex items-center justify-center p-2 bg-indigo-500 rounded-md shadow-lg">
      <svg class="h-6 w-6 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true"><!-- ... --></svg>
    </span>
  </div>
  <h3 class="text-slate-900 dark:text-white mt-5 text-base font-medium tracking-tight">Writes Upside-Down</h3>
  <p class="text-slate-500 dark:text-slate-400 mt-2 text-sm">
    The Zero Gravity Pen can be used to write in any orientation, including upside-down. It even works in outer space.
  </p>
</div>
```

ä»–ä¼šè‡ªåŠ¨è¯†åˆ«æ“ä½œç³»ç»Ÿæ˜¯å¦æ˜¯å¤œé—´æ¨¡å¼ï¼Œå¹¶åº”ç”¨ dark:åè¾¹çš„å±æ€§ã€‚

å¦‚æœæƒ³è¦æ‰‹åŠ¨åˆ‡æ¢å¤œé—´æ¨¡å¼ï¼Œå¯ä»¥åœ¨é…ç½®æ–‡ä»¶é‡Œè¿™æ ·é…ç½®ï¼š

```js
module.exports = {
  darkMode: 'class', // media æ˜¯è‡ªåŠ¨è¯†åˆ«
}
```

æ­¤æ—¶å°† html è®¾ç½®ä¸ºå¤œé—´æ¨¡å¼å³å¯ï¼š

```html
<html class="dark">
```

> æ³¨æ„ï¼šé…ç½®é¡¹ä¸­ä½¿ç”¨äº† darkMode åï¼Œä¸èƒ½å†å‡ºç° theme å­—æ®µï¼Œå¦åˆ™ä¸‹é¢çš„ä¼šè¦†ç›–ä¸Šé¢çš„é…ç½®


![image.png](/img/posts/2023-11-11/2023-11-11-18.png)

ä½ å¯ä»¥ä½¿ç”¨ç”¨æˆ·çš„ç³»ç»Ÿåå¥½ï¼ˆé¡µé¢ä¸Šæ”¾ç½®å¼€å…³æ§åˆ¶ localStorage é‡Œ theme å˜åŒ–ï¼‰æˆ–ä½¿ç”¨Â [`Window.matchMedia()`Â API](https://developer.mozilla.org/en-US/docs/Web/API/Window/matchMedia) æ¥è·å–å½“å‰æ“ä½œç³»ç»Ÿæ˜¯å¦ä¸ºå¤œé—´æ¨¡å¼ï¼š

```js
window.matchMedia('(prefers-color-scheme: dark)').matches
```
æ£€æµ‹åˆ°å½“å‰ä¸ºå¤œé—´æ¨¡å¼æ—¶ï¼Œä¿®æ”¹ html æ ‡ç­¾çš„ classï¼Œæ·»åŠ  `dark` å³å¯ã€‚

è¿™é‡Œæœ‰ä¸ªé—®é¢˜ï¼Œå°±æ˜¯ä¸¤ç§æ¨¡å¼æ¯ä¸€ä¸ªæ–‡å­—. èƒŒæ™¯éƒ½è¦æŒ‡å®šé¢œè‰²ï¼Œè¿™ä¸ªå¯ä»¥æå‡ºåˆ°å…¬å…±æ ·å¼ä¸­ä½¿ç”¨ï¼š

```scss
.box {
  @apply bg-white text-black;
}

html.dark {
  .box {
    @apply bg-slate-800 text-white;
  }
}
```

è¿™æ ·åœ¨å®šä¹‰ç±»çš„æ—¶å€™ï¼Œå°±ä¼šå®¹æ˜“ä¸€äº›ï¼š

```html
// ç™½å¤©
<html>
  <div class="box"></box>
</html>

// å¤œæ™š
<html class="dark">
  <div class="box"></box>
</html>
```

#### ï¼ˆ2. ç€‘å¸ƒæµå¸ƒå±€

> è¿™æ˜¯å®˜ç½‘æ ·ä¾‹

ç€‘å¸ƒæµçš„ç²¾é«“åœ¨äºå„ç§ä¸åŒå°ºå¯¸çš„å›¾ç‰‡èƒ½å¤Ÿå®Œç¾çš„è®¡ç®—é«˜åº¦å¹¶é€æ¬¡æ’é˜Ÿã€‚æˆ‘ä»¬å‡è®¾è¦æ˜¾ç¤ºä¸‰åˆ—å›¾ç‰‡ï¼Œæˆ‘ä»¬å°±è®¾ç½®ä¸€ä¸ªå“åº”å¼çš„åˆ—å¸ƒå±€ç›’å­å®¹å™¨ï¼š

```html
<div class="columns-2 sm:columns-3 gap-8">
```
æ­¤æ—¶ï¼Œæ ·å¼å¦‚ä¸‹ï¼š

![image.png](/img/posts/2023-11-11/2023-11-11-19.png)

è¡¨ç¤ºåœ¨ å¤§äº sm å°ºå¯¸ä¸‹ï¼Œä½¿ç”¨ 3åˆ—å¸ƒå±€ï¼Œå¦åˆ™ä½¿ç”¨ 2åˆ—å¸ƒå±€ã€‚gap è¡¨ç¤ºæ¯ä¸€åˆ—ä¹‹é—´çš„é—´è·ï¼Œä¸è®¾ç½®çš„è¯é»˜è®¤ 16px (ç»§æ‰¿å±æ€§ï¼Œchrome æ˜¯ 16px)ã€‚

å®¹å™¨å†…æ”¾ç½®ä¸€ä¸ªä¸€ä¸ªçš„å›¾ç‰‡ã€‚æˆ‘ä»¬åˆ†åˆ«ä½¿ç”¨ div æ¥åŒ…è£¹å›¾ç‰‡ï¼š

```html
<div class="aspect-w-16 aspect-h-9">
  <img class="w-full object-cover rounded-lg" src="">
</div>
```
-   `aspect-w-16`: è¿™ä¸ªç±»è¡¨ç¤ºè®¾ç½®ä¸€ä¸ªå…ƒç´ çš„å®½åº¦ï¼Œä½¿å…¶å®½åº¦ä¸ºé«˜åº¦çš„16å€ã€‚
-   `aspect-h-9`: è¿™ä¸ªç±»è¡¨ç¤ºè®¾ç½®ä¸€ä¸ªå…ƒç´ çš„é«˜åº¦ï¼Œä½¿å…¶é«˜åº¦ä¸ºå®½åº¦çš„9å€ã€‚

å½“ç„¶è¿™ä¸¤ä¸ªç±»æ˜¯å·²çŸ¥å›¾ç‰‡é•¿å®½æ¯”æ—¶å¯ä»¥è¿™ä¹ˆå†™ï¼Œä¸çŸ¥é“çš„è¯å°±ä¸å†™ã€‚.w-full è¡¨ç¤ºå®½åº¦æ’‘æ»¡è¯¥åˆ—ï¼Œobject-cover å…ƒç´ è¢«ç¼©æ”¾ä»¥è¦†ç›–æ•´ä¸ªå®¹å™¨æ¡†ï¼Œä½†å¯èƒ½ä¼šè¢«è£å‰ªã€‚

å› ä¸ºæ˜¯åˆ—å¼å¸ƒå±€ï¼Œæ˜¯ä»å·¦å¼€å§‹ï¼Œä»ä¸Šå¾€ä¸‹å¸ƒå±€çš„ï¼Œæ‰€ä»¥ä¹‹åçš„å…ƒç´ éƒ½éœ€è¦åŠ ä¸Š marginï¼š

```html
<div class="aspect-w-1 aspect-h-1 mt-8">
```
ç„¶åæˆ‘ä»¬å†åŠ ä¸Šå¤–è¾¹æ¡†å’Œå±…ä¸­æ ·å¼ç¾åŒ–ï¼Œå…¨éƒ¨ä»£ç å¦‚ä¸‹ï¼š

```html
<body class="p-12 m-auto">
  <div class="container flex justify-center">
    <div class="columns-2 sm:columns-3 gap-8">
      <div>
        <img class="w-full object-cover rounded-lg" src="https://images.unsplash.com/photo-1454496522488-7a8e488e8606?ixlib=rb-1.2.1&amp;ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&amp;auto=format&amp;fit=crop&amp;w=2952&amp;q=80">
      </div>
      <div class=" aspect-w-1 aspect-h-1 mt-8">
        <img class="w-full object-cover rounded-lg" src="https://images.unsplash.com/photo-1434394354979-a235cd36269d?ixlib=rb-1.2.1&amp;ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&amp;auto=format&amp;fit=crop&amp;w=2902&amp;q=80">
      </div>
      <div class="aspect-w-1 aspect-h-1 mt-8">
        <img class="w-full object-cover rounded-lg" src="https://images.unsplash.com/photo-1491904768633-2b7e3e7fede5?ixlib=rb-1.2.1&amp;ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&amp;auto=format&amp;fit=crop&amp;w=3131&amp;q=80">
      </div>
      <div class="sm:block  aspect-w-1 aspect-h-1 mt-8">
        <img class="w-full object-cover rounded-lg" src="https://images.unsplash.com/photo-1463288889890-a56b2853c40f?ixlib=rb-1.2.1&amp;ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&amp;auto=format&amp;fit=crop&amp;w=3132&amp;q=80">
      </div>
      <div class="sm:block  aspect-w-16 aspect-h-9 mt-8">
        <img class="w-full object-cover rounded-lg" src="https://images.unsplash.com/photo-1611605645802-c21be743c321?ixlib=rb-1.2.1&amp;ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&amp;auto=format&amp;fit=crop&amp;w=2940&amp;q=80">
      </div>
      <div class="sm:block  aspect-w-1 aspect-h-1 mt-8">
        <img class="w-full object-cover rounded-lg" src="https://images.unsplash.com/photo-1498603993951-8a027a8a8f84?ixlib=rb-1.2.1&amp;ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&amp;auto=format&amp;fit=crop&amp;w=2936&amp;q=80">
      </div>
      <div class="sm:block  aspect-w-1 aspect-h-1 mt-8">
        <img class="w-full object-cover rounded-lg" src="https://images.unsplash.com/photo-1526400473556-aac12354f3db?ixlib=rb-1.2.1&amp;ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&amp;auto=format&amp;fit=crop&amp;w=2940&amp;q=80">
      </div>
      <div class="sm:block  aspect-w-1 aspect-h-1 mt-8">
        <img class="w-full object-cover rounded-lg" src="https://images.unsplash.com/photo-1617369120004-4fc70312c5e6?ixlib=rb-1.2.1&amp;ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&amp;auto=format&amp;fit=crop&amp;w=1587&amp;q=80">
      </div>
      <div class="sm:block  aspect-w-16 aspect-h-9 mt-8">
        <img class="w-full object-cover rounded-lg" src="https://images.unsplash.com/photo-1518892096458-a169843d7f7f?ixlib=rb-1.2.1&amp;ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&amp;auto=format&amp;fit=crop&amp;w=2940&amp;q=80">
      </div>
    </div>
  </div>
</body>
```

æ•ˆæœå›¾ï¼š

å¤§å±ï¼š


![image.png](/img/posts/2023-11-11/2023-11-11-20.png)

å°å±ï¼š


![image.png](/img/posts/2023-11-11/2023-11-11-21.png)

#### ï¼ˆ3. å†™ä¸€ä¸ªå¸¦åŠ¨ç”»çš„ç»„ä»¶

tailwindcss å†…ç½®äº†ä¸€ä¸ªå°å‹çš„åŠ¨ç”»åº“ï¼Œå¯ä»¥ä½¿ç”¨ç±»æ¥æ§åˆ¶ã€‚ä¸‹é¢çš„ä»£ç æ˜¯ä¸€ä¸ªå¼¹è·³çš„æŒ‰é’®ï¼š

```html
<button type="button" class="animate-bounce bg-indigo-500 text-white p-2 rounded-md">
  Hello World
</button>
```

æ•ˆæœå¦‚ä¸‹ï¼š

![å±å¹•å½•åˆ¶2023-11-16-ä¸‹åˆ2.37.29.gif](/img/posts/2023-11-11/2023-11-11-22.gif)


-----

å¤§è‡´è®²è§£å°±è¿™ä¹ˆå¤šå•¦ï¼Œå€ºè§ï¼12:T3797,## 1. Hooks

### use

`use` æ˜¯ä¸€ä¸ªå¯ä»¥åœ¨åˆ†æ”¯è·Ÿå¾ªç¯ä¸­ä½¿ç”¨çš„ React Hookï¼Œå®ƒå¯ä»¥è®©ä½ è¯»å–ç±»ä¼¼äº [Promise](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Promise) æˆ– [context](https://zh-hans.react.dev/learn/passing-data-deeply-with-context) çš„èµ„æºçš„å€¼ã€‚

> `use` Hook ç›®å‰ä»…åœ¨ canary ä¸ experimental æ¸ é“ä¸­å¯ç”¨

- ä½¿ç”¨ use è¯»å– context çš„å€¼

```js
const theme = use(ThemeContext);
```
æ­¤æ—¶ç±»ä¼¼äº useContextï¼Œä¸è¿‡ use æ›´åŠ çµæ´»ã€‚React ä¼šæœç´¢ç»„ä»¶æ ‘å¹¶æ‰¾åˆ° æœ€æ¥è¿‘çš„ context provider ä»¥ç¡®å®šéœ€è¦è¿”å›çš„ context å€¼ã€‚å®ƒå‘ä¸Šæœç´¢å¹¶å¿½ç•¥è°ƒç”¨ `use(context)` çš„ç»„ä»¶æœ¬èº«ä¸­çš„ context providerã€‚

- ä¼ é€’ promise çš„å€¼

å¦‚æœä½ ä½¿ç”¨äº†æœåŠ¡ç«¯æ¸²æŸ“ API æ¥æ‰‹åŠ¨é…ç½® SSRï¼Œä½ å¯èƒ½ä¼šåœ¨æœåŠ¡ç«¯æ¨é€ä¸€ä¸ªæµå¼ï¼ˆstreamï¼‰æ•°æ®ï¼Œåœ¨å®¢æˆ·ç«¯å¯ä»¥ä½¿ç”¨ use æ¥å—ã€‚

```js
// æ ¹ç»„ä»¶é€šè¿‡ fetchMessage è·å–æµï¼ŒåŒ…è£…ä¸º promise ç»™åˆ° Messageç»„ä»¶
export default function App() {
  const messagePromise = fetchMessage();
  return (
    <Suspense fallback={<p>waiting for message...</p>}>
      <Message messagePromise={messagePromise} />
    </Suspense>
  );
}
```

Messageç»„ä»¶ä¸­ï¼š

```js
// message.js
'use client';

import { use } from 'react';

export function Message({ messagePromise }) {
  const messageContent = use(messagePromise);
  return <p>Here is the message: {messageContent}</p>;
}
```

use å¯ä»¥å’Œ Suspense è”åŠ¨ï¼Œå½“ä¼ é€’çš„ promise æ²¡æœ‰ fullfill æ—¶ï¼Œloading ä¸€ç›´ç”Ÿæ•ˆï¼Œå½“ promise æˆåŠŸä»¥åï¼Œæ˜¾ç¤º resolve çš„å€¼ã€‚

> å°†æ¥è‡ªæœåŠ¡å™¨ç»„ä»¶çš„ Promise ä¼ é€’è‡³å®¢æˆ·ç«¯ç»„ä»¶æ—¶ï¼Œå…¶è§£æå€¼å¿…é¡»å¯åºåˆ—åŒ–ä»¥åœ¨æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯ä¹‹é—´ä¼ é€’ã€‚åƒå‡½æ•°è¿™æ ·çš„æ•°æ®ç±»å‹ä¸å¯åºåˆ—åŒ–ï¼Œä¸èƒ½æˆä¸ºè¿™ç§ Promise çš„è§£æå€¼ã€‚

- å¤„ç† promise é”™è¯¯è¾¹ç•Œ

å½“ promise æŠ¥é”™æ—¶ï¼Œuse éœ€è¦æ‰‹åŠ¨è®¾ç½®æ•è·é”™è¯¯ï¼š

```js
import { ErrorBoundary } from "react-error-boundary";

<ErrorBoundary fallback={<p>âš ï¸Something went wrong</p>}>
  <Suspense fallback={<p>âŒ›Downloading message...</p>}>
    <Message messagePromise={messagePromise} />
  </Suspense>
</ErrorBoundary>
```

ä¸Šé¢çš„ç¤ºä¾‹ä½¿ç”¨äº†ç¬¬ä¸‰æ–¹åº“ï¼Œå¦‚æœä¸ä½¿ç”¨ ErrorBoundary åŒ…è£¹ï¼Œè¿˜å¯ä»¥è¿™æ ·å†™ï¼š

```js
  const messagePromise = new Promise((resolve, reject) => {
    reject();
  }).catch(() => {
    return "no new message found.";
  });
```
ä½¿ç”¨ promise è‡ªå¸¦çš„ catch æ•è·é”™è¯¯ã€‚catch ä¸­ return çš„å†…å®¹ï¼Œä¼šè¢«è§†ä½œæ­£å¸¸çš„è¿”å›ã€‚

> ä¸èƒ½åœ¨ React ç»„ä»¶æˆ– Hook å‡½æ•°ä¹‹å¤–è°ƒç”¨ `use`ï¼Œæˆ–è€…åœ¨ try-catch å—ä¸­è°ƒç”¨ `use`

### useOptimistic

> `useOptimistic`Â Hook ç›®å‰ä»…åœ¨ canary ä¸ experimental æ¸ é“ä¸­å¯ç”¨

è¿™ä¸ª hook ç”¨äºä¼˜åŒ– UI çš„æ›´æ–°ã€‚

è€ƒè™‘ä¸‹é¢çš„åœºæ™¯ï¼Œç•Œé¢ä¸Šä¸€ä¸ªæŒ‰é’®ï¼Œç‚¹å‡»å¯ä»¥å¼‚æ­¥è°ƒç”¨å‘é€æ¥å£ï¼š

```js
<form action={formAction} ref={formRef}>
  <input type="text" name="message" placeholder="Hello!" />
  <button type="submit">Send</button>
</form>
```

è¡¨å•å“åº”ï¼Œåœ¨å‘é€å®Œæ•°æ®åæ˜¾ç¤ºå‘é€çš„æ•°æ®ï¼š

```js
async function formAction(formData) {
  // è¿™ä¸€æ¡ç°åœ¨æ²¡æœ‰ï¼Œä¸‹é¢å¼•å…¥ä¹è§‚æ¶ˆæ¯æ—¶åŠ å…¥
  addOptimisticMessage(formData.get("message"));
  formRef.current.reset();
  await sendMessage(formData);
}

async function sendMessage(formData) {
  // deliverMessage æ˜¯ API çš„è°ƒç”¨
  const sentMessage = await deliverMessage(formData.get("message"));
  setMessages([...messages, { text: sentMessage }]);
}
```
è¿™é‡Œæœ‰ä¸ªé—®é¢˜ï¼ŒsendMessage æ˜¯ä¸ªå¼‚æ­¥ä»»åŠ¡ï¼Œåœ¨å‘é€å®Œæˆåï¼Œè°ƒç”¨ setMessages æ”¹å˜ state çš„å€¼ï¼Œè¿™æ—¶åœ¨å‘é€è®°å½•åˆ—è¡¨é‡Œå°±ä¼šæœ‰ä¸€æ¡è®°å½•ã€‚ä½†æ˜¯åœ¨å‘é€è¿‡ç¨‹ä¸­ï¼Œè¯¥è®°å½•æ˜¯ä¸ä¼šå‡ºç°çš„ã€‚

æ­¤æ—¶ï¼Œæˆ‘ä»¬å£°æ˜ä¸€ä¸ªä¹è§‚çŠ¶æ€ï¼š

```js
 const [optimisticMessages, addOptimisticMessage] = useOptimistic(
    messages,
    (state, newMessage) => [
      ...state,
      {
        text: newMessage,
        sending: true
      }
    ]
  );
```
ä»–ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯åˆšåˆšçš„ stateï¼šmessagesï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯ä¸€ä¸ªå›è°ƒï¼Œå®æ—¶æ¥å—æœ€æ–°çš„çŠ¶æ€å¹¶è¿”å›è‡ªå®šä¹‰çš„ç»“æ„ã€‚

æˆ‘ä»¬åœ¨åˆ—è¡¨æ¸²æŸ“çš„åœ°æ–¹å°±å¯ä»¥è¿™æ ·å†™äº†ï¼š

```js
{optimisticMessages.map((message, index) => (
    <div key={index}>
      {message.text}
      {!!message.sending && <small> (Sending...)</small>}
    </div>
))}
```
è¿™æ ·ï¼Œåœ¨å‘é€çš„è¿‡ç¨‹ä¸­ï¼ŒaddOptimisticMessage è¢«è°ƒç”¨äº†ï¼Œæ•°ç»„è¿½åŠ çš„é‚£ä¸ªå…ƒç´ å¤„äº sending ä¸­ï¼Œå°±ä¼šæ˜¾ç¤º sending çš„æ–‡æœ¬ï¼›åœ¨æ¥å£è¯·æ±‚æˆåŠŸåï¼ŒoptimisticMessages ä¼šæ£€æµ‹åˆ°è¯·æ±‚å®Œæ¯•ï¼Œè‡ªåŠ¨ç¦»åœºã€‚æˆ‘ä»¬å®éªŒä¸¤æ¬¡ï¼Œæ‰“å°ä¸€ä¸‹è¿™ä¸ª optimisticMessages çŠ¶æ€çš„å€¼ï¼š


![image.png](/img/posts/2023-11-9/2023-11-9-1.png)

å½“æ¥å£è°ƒç”¨å®Œæ¯•åï¼Œå› ä¸ºè°ƒç”¨äº† sendMessageï¼Œæ‰€ä»¥ addOptimisticMessages å’Œ messages ä¸¤ä¸ªçŠ¶æ€å°±è¶‹äºä¸€è‡´äº†ã€‚

> **useOptimistic** æ˜¯ä¸€ç§ä¹è§‚æ›´æ–°æœºåˆ¶ï¼Œä¸»è¦åº”ç”¨äºéœ€è¦ä¸æœåŠ¡å™¨è¿›è¡Œå¼‚æ­¥äº¤äº’çš„åœºæ™¯ï¼Œå¦‚æ¶ˆæ¯å‘é€ã€‚åœ¨è¿™ç§æœºåˆ¶ä¸‹ï¼Œé€šå¸¸å¸Œæœ›ä¼˜å…ˆæ˜¾ç¤ºæ–°æ•°æ®æˆ–æ–°çŠ¶æ€ï¼Œè€Œä¸æ˜¯ç­‰å¾…æœåŠ¡å™¨è¿”å›å“åº”åå†è¿›è¡Œæ›´æ–°ï¼›
> 
> **useTransition** ä¸»è¦è§£å†³çš„æ˜¯åœ¨ç•Œé¢åˆ‡æ¢è¿‡ç¨‹ä¸­å¯èƒ½å‡ºç°çš„å†…å®¹åŠ è½½é—®é¢˜ã€‚å®ƒå…è®¸ç»„ä»¶åœ¨åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªç•Œé¢ä¹‹å‰ç­‰å¾…å†…å®¹åŠ è½½ï¼Œä»è€Œé¿å…å‡ºç°ä¸å¿…è¦çš„åŠ è½½çŠ¶æ€ã€‚

### useFormState

> `useFormState` Hook ç›®å‰ä»…åœ¨ canary ä¸ experimental æ¸ é“ä¸­å¯ç”¨

`useFormState` æ˜¯ react-dom åº“ä¸‹çš„ hookï¼Œå…è®¸æ ¹æ®è¡¨å•æ“ä½œçš„ç»“æœæ›´æ–°çŠ¶æ€ã€‚æˆ‘ä»¬å¯ä»¥è¿™æ ·ä½¿ç”¨ï¼š

```js
function AddToCartForm({itemID, itemTitle}) {
  const [message, formAction] = useFormState(addToCart, null);
  return (
    <form action={formAction}>
      <h2>{itemTitle}</h2>
      <input type="hidden" name="itemID" value={itemID} />
      <button type="submit">Add to Cart</button>
      {message}
    </form>
  );
}
```
å…¶ä¸­ action.js

```js
"use server";

// æ¨¡æ‹ŸæœåŠ¡ç«¯å…¥åº“å“åº”
export async function addToCart(prevState, queryData) {
  const itemID = queryData.get('itemID');
  if (itemID === "1") {
    return "Added to cart";
  } else {
    return "Couldn't add to cart: the item is sold out.";
  }
}
```

useFormState ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯actionè§¦å‘å‡½æ•°ï¼Œç¬¬äºŒä¸ªæ˜¯ åˆå§‹å€¼ã€‚å½“è§¦å‘ action æäº¤æ—¶ï¼Œç¬¬ä¸€ä¸ªå‚æ•°ä¼šè¢«è°ƒç”¨ï¼ŒaddToCart æ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªæ˜¯å˜åŒ–å‰ message çš„å€¼ï¼Œç¬¬äºŒä¸ªæ˜¯ formData å¯¹è±¡ï¼Œå…¶è¿”å›çš„å€¼ä¼šå¤åˆ¶åˆ° message é‡Œï¼Œå¹¶æ˜¾ç¤ºåœ¨ç•Œé¢ä¸Šã€‚
 
message å¯ä»¥ç†è§£ä¸ºéªŒè¯è¡¨å•åçš„è¿”å›å€¼ã€‚

ä¸Šé¢ä»£ç æ‰§è¡Œæµç¨‹ï¼š

ç‚¹å‡»æäº¤ ==> è§¦å‘ addToCart ==> è¿”å›è¡¨å•å¤„ç†çš„ç»“æœï¼Œè‡ªåŠ¨èµ‹å€¼ç»™ message

> è¿™ä¸ª hook å¯ä»¥ç”¨äºè¡¨å•æ ¡éªŒåçš„é”™è¯¯/ä¿¡æ¯å±•ç¤ºï¼Œåªæ”¯æŒåœ¨å®¢æˆ·ç«¯ä½¿ç”¨

### useFormStatus

> `useFormStatus`Â Hook ç›®å‰ä»…åœ¨ canary ä¸ experimental æ¸ é“ä¸­å¯ç”¨

ä¸ useFormState éƒ½æ˜¯ react-dom åº“ä¸‹çš„ hookï¼Œä½†æ˜¯ä¸å‰è€…ç»Ÿä¸€æ”¶é›†è¡¨å•æ ¡éªŒçŠ¶æ€ä¸åŒï¼Œ`useFormStatus` æ˜¯ä¸€ä¸ªæä¾›è¡¨å•æäº¤åçŠ¶æ€ä¿¡æ¯çš„ Hookã€‚

å…¶ä½¿ç”¨åœ¨è¡¨å•å†…éƒ¨ï¼š

```js
<form action={submitForm}>
  <UsernameForm />
</form>

...

export async function submitForm(query) {
  await new Promise((res) => setTimeout(res, 1000));
}
```
æˆ‘ä»¬åœ¨ UsernameForm ä¸­å®šä¹‰ä¸€ä¸ªï¼š

```js
const {pending, data} = useFormStatus();

...
<button type="submit" disabled={pending}>
  {pending ? 'æäº¤ä¸­â€¦â€¦' : 'æäº¤'}
</button>
{showSubmitted ? (
  <p>æäº¤è¯·æ±‚ç”¨æˆ·åï¼š{submittedUsername.current}</p>
) : null}
```

è¡¨å•çš„æäº¤ action æ˜¯ä¸€ä¸ªå¼‚æ­¥è¯·æ±‚ï¼Œæ¯”å¦‚ Promiseï¼Œå½“å¼‚æ­¥è¯·æ±‚æ²¡æœ‰ç»“æŸæ—¶ï¼Œpending å°±ä¼šæ˜¯ trueï¼Œè¯¥è¿‡ç¨‹ä¸­ data ä¾¿æ˜¯æ•´ä¸ªè¡¨å•æäº¤çš„æ•°æ®ä¿¡æ¯ã€‚è¿™ä¸ª hook ç›¸å½“äºåœ¨æäº¤è¿‡ç¨‹ä¸­å°†è¡¨å•æ•°æ®å’Œæäº¤è¿›åº¦æš´éœ²äº†å‡ºæ¥ï¼Œä¾¿äºå‰ç«¯å±•ç¤ºå¯¹åº”çš„å“åº”å¼é¡µé¢ã€‚

## 2. APIs

### cache

`cache` å…è®¸ç¼“å­˜æ•°æ®è·å–æˆ–è®¡ç®—çš„ç»“æœã€‚ä»–å¯ä»¥åœ¨**ä»»ä½•ç»„ä»¶ä¹‹å¤–**è°ƒç”¨ï¼Œæ˜¯ç¼“å­˜ hook çš„é€šç”¨å½¢å¼ã€‚

> `cache` ä»…åœ¨ React çš„ [Canary](https://zh-hans.react.dev/community/versioning-policy#canary-channel) å’Œ [experimental](https://zh-hans.react.dev/community/versioning-policy#experimental-channel) æ¸ é“ä¸­å¯ç”¨

- ç¼“å­˜é‡å¤è®¡ç®—

æ¯”å¦‚æˆ‘ä»¬æœ‰ä¸€ä¸ªå¾ˆå¤æ‚çš„è®¡ç®—ï¼š

```js
import calculateUserMetrics from 'lib/user';

const getUserMetrics = cache(calculateUserMetrics);
```
ä½¿ç”¨ cache ç¼“å­˜ä»¥åï¼Œåœ¨å‡½æ•°é‡Œç›´æ¥å¼•ç”¨å³å¯ï¼š

```js
function TeamReport({users}) {
  for (let user in users) {
    const metrics = getUserMetrics(user);
    // ...
  }
  // ...
}
```

cache æ¥å—ä¸€ä¸ªå‡½æ•°å½“åšè®¡ç®—å‡½æ•°ï¼Œcache è¿”å›çš„å€¼ä¸ºä¸€ä¸ªå•ä¾‹å‡½æ•°ï¼Œå†³å®šè¿™ä¸ªå‡½æ•°æ˜¯å¦è·å–ç¼“å­˜çš„å”¯ä¸€æŒ‡æ ‡å°±æ˜¯ä¼ å…¥çš„å€¼æ˜¯å¦ä¸€è‡´ï¼Œå¦‚æœä¸¤æ¬¡æ¢å…¥çš„å‚æ•°ï¼ˆä¸Šé¢çš„ä¾‹å­æ˜¯ user å¯¹è±¡ï¼‰å¼•ç”¨ç›¸åŒï¼Œåˆ™ç¬¬äºŒæ¬¡ä½¿ç”¨ç¼“å­˜ã€‚

- ç¼“å­˜ API æ•°æ®

```js
const getTemperature = cache(async (city) => {
	return await fetchTemperature(city);
});

// ä½¿ç”¨
async function AnimatedWeatherCard({city}) {
	const temperature = await getTemperature(city);
	// ...
}
```

ç±»ä¼¼åœ°ï¼Œä»–å¯ä»¥æ¥å—å¼‚æ­¥å‡½æ•°ä½œä¸ºè®¡ç®—å‡½æ•°ä¼ å…¥ï¼Œä¼ å…¥çš„ city ä¸ºç›¸åŒçš„å€¼æ—¶ï¼Œç›´æ¥å–ç¼“å­˜ã€‚

- é¢„åŠ è½½æ•°æ®

å¯ä»¥ç”¨ cache æ‰‹åŠ¨é…ç½®é¢„åŠ è½½ï¼Œåœ¨é¡µé¢åˆå§‹åŒ–æ—¶é¢„å…ˆè·å–æ•°æ®ï¼š

```js
const getUser = cache(async (id) => {
  return await db.user.query(id);
})
...
function Home({id}) {
  // âœ… æ­£ç¡®ç¤ºä¾‹ï¼šå¼€å§‹è·å–ç”¨æˆ·æ•°æ®ã€‚
  getUser(id);
  // â€¦â€¦ä¸€äº›è®¡ç®—å·¥ä½œ
  return (
    <>
      <Profile id={id} />
    </>
  );
}
```
è¿™æ ·ï¼Œåœ¨æ”¹ç™»å½•ç”¨æˆ·çš„ä»»æ„é¡µé¢ï¼Œéƒ½å¯ä»¥æˆ‘å»¶æ—¶è·å–ç”¨æˆ·ä¿¡æ¯ï¼š

```js
const user = await getUser(id);
```

### experimental_taintObjectReference

è¿™ä¸ª API è¿˜ä¸ç¨³å®šï¼Œè¿˜åœ¨å¼€å‘ä¸­ï¼Œç”¨äºé˜»æ­¢ç‰¹å®šç”¨æˆ·æ•°æ®å¯¹è±¡å®ä¾‹è¢«ä¼ é€’ç»™å®¢æˆ·ç«¯ç»„ä»¶ï¼Œä¾‹å¦‚ `user` å¯¹è±¡ã€‚

```js
import {experimental_taintObjectReference} from 'react';

export async function getUser(id) {
  const user = await db`SELECT * FROM users WHERE id = ${id}`;
  experimental_taintObjectReference(
    'Do not pass the entire user object to the client. ' +
      'Instead, pick off the specific properties you need for this use case.',
    user,
  );
  return user;
}
```
ä»–çš„å­—é¢æ„æ€æ˜¯æ±¡æŸ“å¯¹è±¡å¼•ç”¨ï¼Œå°±æ˜¯è¯´å°† user åŠ«æŒäº†ï¼Œä¸ç»™ä½ å®¢æˆ·ç«¯ç”¨äº†ã€‚ç›®å‰è½åœ°å®ç°è¿˜ä¸æ˜ç¡®ï¼ŒæœŸå¾…æ­£å¼ç‰ˆæœ¬ã€‚

### experimental_taintUniqueValue

è¿™ä¸ª API è¿˜ä¸ç¨³å®šï¼Œè¿˜åœ¨å¼€å‘ä¸­ï¼Œç”¨äºé˜²æ­¢å°†å”¯ä¸€å€¼ä¼ é€’ç»™å®¢æˆ·ç«¯ç»„ä»¶ï¼Œä¾‹å¦‚å¯†ç ã€å¯†é’¥æˆ–ä»¤ç‰Œã€‚

```js
import {experimental_taintUniqueValue} from 'react';

export async function getUser(id) {
  const user = await db`SELECT * FROM users WHERE id = ${id}`;
  experimental_taintUniqueValue(
    'Do not pass a user session token to the client.',
    user,
    user.session.token
  );
  return user;
}
```

å®˜æ–¹åªç»™äº†è¿™ä¹ˆä¸ªä¾‹å­ï¼Œå…·ä½“ä½¿ç”¨ç»†èŠ‚è¿˜æœ‰å¾…è€ƒè¯ã€‚

## 3. æŒ‡ä»¤

æŒ‡ä»¤è¿™ä¸ªæ¦‚å¿µåœ¨ react ä¸­ç®—æ˜¯ä¸€ä¸ªç¨€å¥‡äº‹ï¼Œvue ä¸­æœ‰ v-ifï¼Œng ä¸­å¤©ç„¶å†…ç½® Directiveï¼Œreact ä¸­è¿™ä¹Ÿå¼€å§‹å¼•å…¥æŒ‡ä»¤çš„æ¦‚å¿µäº†ã€‚

### use client

ç”¨äºæœåŠ¡ç«¯æ¸²æŸ“ä»£ç é‡Œã€‚React æœåŠ¡ç«¯ç»„ä»¶é»˜è®¤æ˜¯èµ° SSR çš„ï¼Œä½¿ç”¨è¿™ä¸ªæŒ‡ä»¤æŒ‡å®šå½“å‰æ–‡ä»¶æ˜¯å±äºå®¢æˆ·ç«¯çš„ã€‚

å¯ä»¥è¿™æ ·ä½¿ç”¨ï¼š

```js
'use client';

import { useState } from 'react';
import inspirations from './inspirations'; // å­—åº“ï¼Œè¿™é‡Œå¯å¿½ç•¥
import FancyText from './FancyText';  // å±•ç¤ºæ–‡å­—çš„ç»„ä»¶

export default function InspirationGenerator({children}) {
  const [index, setIndex] = useState(0);
  const quote = inspirations[index];
  const next = () => setIndex((index + 1) % inspirations.length);

  return (
    <>
      <p>Your inspirational quote is:</p>
      <FancyText text={quote} />
      <button onClick={next}>Inspire me again</button>
      {children}
    </>
  );
}
```
ä¸Šé¢çš„ç»„ä»¶æ˜¯ä¸€ä¸ªå°è£…çš„æ–‡å­—ç”Ÿæˆå™¨ç»„ä»¶ï¼Œæˆ‘ä»¬åœ¨å…¥å£æ–‡ä»¶ä¸­å¼•å…¥ï¼š

```js
import FancyText from './FancyText';
import InspirationGenerator from './InspirationGenerator';
import Copyright from './Copyright';

export default function App() {
  return (
    <>
      <FancyText title text="Get Inspired App" />
      <InspirationGenerator>
        <Copyright year={2004} />
      </InspirationGenerator>
    </>
  );
}
```
è¿™å°±åšäº†éš”ç¦»äº†ï¼Œæ€»çš„ä»£ç éƒ½æ˜¯æœåŠ¡ç«¯ç›´å‡ºçš„ï¼Œä½†æ˜¯ InspirationGenerator æ ‡è®°äº†ä½¿ç”¨åœ¨å®¢æˆ·ç«¯ã€‚æˆ‘ä»¬å€Ÿç”¨å®˜ç½‘çš„è°ƒç”¨æ ‘è¯´æ˜ç°åœ¨çš„å¼•ç”¨å…³ç³»ï¼š



![image.png](/img/posts/2023-11-9/2023-11-9-2.png)

InspirationGenerator æ ‡è®°äº†ä¸ºå®¢æˆ·ç«¯æ¸²æŸ“ï¼Œåˆ™å…¶ä½œä¸ºå…¶å®èŠ‚ç‚¹çš„æ‰€æœ‰å¶å­èŠ‚ç‚¹éƒ½ä¼šé‡‡ç”¨å®¢æˆ·ç«¯æ¸²æŸ“äº†ã€‚

æˆ‘ä»¬å†æ¥çœ‹ä¸€ä¸‹æ¸²æŸ“å…³ç³»ï¼š


![image.png](/img/posts/2023-11-9/2023-11-9-3.png)

å¯ä»¥çœ‹åˆ°ï¼ŒCopyright è™½ç„¶æ˜¯ InspirationGenerator ç»„ä»¶å†…éƒ¨çš„ childrenï¼Œä½†æ˜¯ä»å¼•ç”¨å…³ç³»æ¥çœ‹ï¼Œæ²¡æœ‰è¢« 'use client' æ ‡è®°ï¼Œæ‰€ä»¥å°±èµ°æœåŠ¡ç«¯æ¸²æŸ“ã€‚

### use server

ç”¨äºæœåŠ¡ç«¯æ¸²æŸ“ä»£ç é‡Œã€‚React æœåŠ¡ç«¯ç»„ä»¶é»˜è®¤æ˜¯èµ° SSR çš„ï¼Œä½¿ç”¨è¿™ä¸ªæŒ‡ä»¤æŒ‡å®šå½“å‰æ–‡ä»¶æ˜¯å±äºæœåŠ¡ç«¯çš„ã€‚

è¿™å°±ç±»ä¼¼äº next.js é‡Œè¾¹çš„ getServerSidePropsï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹ç¤ºä¾‹ä»£ç ï¼š

```js
// App.js

async function requestUsername(formData) {
  'use server';
  const username = formData.get('username');
  // ...
}

export default App() {
  <form action={requestUsername}>
    <input type="text" name="username" />
    <button type="submit">Request</button>
  </form>
}
```

åœ¨æœåŠ¡ç«¯æ¸²æŸ“æ—¶ï¼Œæˆ‘ä»¬äººä¸ºæ ‡è®° requestUsername å‡½æ•°æ˜¯å±äºæœåŠ¡ç«¯çš„ï¼Œè¿™æ ·åœ¨é¡¹ç›®ä»£ç æ‰“åŒ…ä¸º bundle æ—¶å°±ä¼šç›´æ¥é¢„å…ˆè°ƒç”¨ requestUsernameï¼Œç›¸å½“äºé»˜è®¤æäº¤äº†ä¸€æ¬¡è¡¨å•ã€‚

è€Œä¸”ï¼Œæ ‡è®°ä¸ºæœåŠ¡ç«¯çš„å‡½æ•°å¯ä»¥è®¾ç½®ä¸ºå¼‚æ­¥ï¼š

```js
// actions.js
'use server';

let likeCount = 0;
export default async incrementLike() {
  likeCount++;
  return likeCount;
}
```

è¿™æ ·åœ¨å®¢æˆ·ç«¯ä»£ç ä¸­å°±å¯ä»¥å¼‚æ­¥æ¥æ”¶äº†ï¼š


```js
startTransition(async () => {
  const currentCount = await incrementLike();
});
```

> å…³äº use client å’Œ use serverï¼Œå®˜æ–¹çš„ä½¿ç”¨æ¡ˆä¾‹è¾ƒå°‘ï¼Œä¹Ÿæ²¡æœ‰å¦å¤–çš„å‚è€ƒã€‚å¦‚æœåæœŸè¿™ä¸ª API è¾ƒä¸ºæˆç†Ÿåï¼Œæˆ‘ä¼šè¡¥å……ä½¿ç”¨æ¡ˆä¾‹
-----13:T4fa4,## 1. æœåŠ¡ç«¯æ¸²æŸ“

æœåŠ¡ç«¯æ¸²æŸ“æ˜¯æœåŠ¡ç«¯è¿”å›æ¸²æŸ“å‡ºçš„ html å­—ç¬¦ä¸²ï¼ˆæˆ–æ•°æ®æµï¼‰ï¼Œæµè§ˆå™¨æ¥è§£æ html ä»¥æ„å»ºé¡µé¢ã€‚åœ¨ React å¼€å‘ä¸­ï¼Œè¦æƒ³ä½¿ç”¨ SSRï¼Œæœ‰ä¸¤ç§æ–¹å¼ï¼š

1. ä½¿ç”¨ Nextjs
2. æ‰‹åŠ¨æ­å»ºæœåŠ¡ç«¯æ¸²æŸ“

å®˜ç½‘æåˆ°çš„æœåŠ¡ç«¯ API å°±æ˜¯ React æä¾›çš„æ”¯æŒæ‰‹åŠ¨æ­å»ºæœåŠ¡ç«¯æ¸²æŸ“çš„ã€‚å…¶**æœ¬è´¨æ˜¯æœåŠ¡ç«¯ç›´æ¥å°†ä¸€ä¸ªç”Ÿæˆå¥½çš„ HTML ç»™åˆ°å‰ç«¯ï¼Œå‰ç«¯ä¸€æ¬¡æ€§æ¸²æŸ“**ï¼Œä¾¿äºåŠ é€Ÿé¦–å±åŠ è½½å’Œè¿›è¡Œ SEOã€‚è¿™é‡Œæœ‰ä¸ªé—®é¢˜ï¼Œå®¢æˆ·ç«¯å·¥ä½œå¹¶ä¸ä»…ä»…æ˜¯æ¸²æŸ“æœåŠ¡å™¨è¿”å›çš„ htmlï¼Œä¸ºäº†ä¿è¯æœåŠ¡ç«¯è¿”å›çš„ html åœ¨å®¢æˆ·ç«¯èƒ½å¤Ÿå¤„ç†äº‹ä»¶å’Œäº¤äº’ï¼Œå®¢æˆ·ç«¯è¦é‡æ–°è¿›è¡Œ vdom çš„æ„å»ºå’Œäº‹ä»¶ç»‘å®šï¼Œå³ï¼Œ**åœ¨æ¸²æŸ“å‡º html åï¼ŒæŠŠç›¸åº”ç»„ä»¶å…³è”åˆ°å…¶å¯¹åº”çš„ç»„ä»¶ä¸Šï¼Œå¹¶æ·»åŠ äº¤äº’é€»è¾‘å’Œç®¡ç†ä¹‹åçš„æ¸²æŸ“ï¼ˆhtml æ˜ å°„ä¸º React æ ‘ï¼‰**ã€‚

ä¹Ÿå°±æ˜¯è¯´ï¼Œå‰ç«¯ç»„ä»¶é€»è¾‘åœ¨æœåŠ¡ç«¯æ¸²æŸ“ä¸€æ¬¡åï¼Œåœ¨å®¢æˆ·ç«¯ä¹Ÿè¦é’ˆå¯¹æ€§çš„æ¸²æŸ“ä¸€æ¬¡ï¼Œè¿™ä¸ªè¿‡ç¨‹å«æ°´åˆï¼ˆhydrateï¼‰ï¼Œè¿™ä¸¤æ¬¡æ¸²æŸ“å«åšåŒæ„æ¸²æŸ“ã€‚

> å°½ç®¡æœåŠ¡ç«¯æ¸²æŸ“ï¼ˆSSRï¼‰å¹¶ hydrate çš„è¿‡ç¨‹æ¯”çº¯ç²¹çš„å®¢æˆ·ç«¯æ¸²æŸ“ï¼ˆCSRï¼‰çœ‹èµ·æ¥æ›´ç¹çï¼Œä½†æ˜¯å®ƒå®é™…ä¸Šå¯ä»¥èŠ‚çœæ¸²æŸ“æ—¶é—´ï¼Œç‰¹åˆ«æ˜¯åœ¨å¤æ‚çš„ React åº”ç”¨ä¸­ã€‚

### SSR vs CSR

æœåŠ¡ç«¯ç”¨æ¥å­˜å‚¨å’Œå“åº”æ•°æ®ï¼Œå®¢æˆ·ç«¯ç”¨äºè¯·æ±‚å’Œå±•ç¤ºæ•°æ®ï¼Œä»–ä»¬éƒ½æœ‰è‡ªå·±çš„æ¸²æŸ“æ–¹å¼ã€‚å°½ç®¡è¿™ä¸¤ç§æ–¹æ³•éƒ½æ¶‰åŠåˆ°ä»æœåŠ¡å™¨è·å– HTML å¹¶åœ¨æµè§ˆå™¨ä¸­è§£æï¼Œä½†å®ƒä»¬ä¹‹é—´å­˜åœ¨ä¸€äº›é‡è¦çš„åŒºåˆ«ã€‚

1.  åˆå§‹æ¸²æŸ“ï¼šSSR ç³»ç»Ÿä¸­ï¼ŒæœåŠ¡ç«¯å·²ç»è¿”å›äº†å®Œæ•´çš„é¡µé¢ï¼Œå®¢æˆ·ç«¯åªéœ€è¦åšå°‘é‡çš„æ°´åˆæ“ä½œå³å¯ï¼›CSR ç³»ç»Ÿä¸­ï¼ŒæœåŠ¡å™¨è¿”å›çš„æ˜¯å…¥å£çš„æœ€å°åŒ–çš„ html (index.html)ï¼Œå®¢æˆ·ç«¯éœ€è¦é€šè¿‡ä¸‹è½½å¥½çš„ cssã€js æ–‡ä»¶é€è¡Œè§£æå¹¶æ„å»º DOM å’Œ CSSOMï¼Œæœ€ç»ˆç”Ÿæˆå®Œæ•´çš„ htmlã€‚
2.  äº¤äº’æ€§ï¼šåœ¨ SSR ä¸­ï¼Œç”±äº HTML æ˜¯åœ¨æœåŠ¡å™¨ä¸Šé¢„å…ˆæ¸²æŸ“çš„ï¼Œæ‰€ä»¥ä»ä¸€å¼€å§‹å°±å…·æœ‰äº¤äº’æ€§ã€‚è¿™æ„å‘³ç€ç”¨æˆ·å¯ä»¥åœ¨é¡µé¢åŠ è½½åç«‹å³çœ‹åˆ°æ‰€æœ‰çš„åŠŸèƒ½å’Œå†…å®¹ï¼Œè€Œä¸éœ€è¦ç­‰å¾…å®¢æˆ·ç«¯ JavaScript ä»£ç æ‰§è¡Œã€‚è€Œåœ¨ CSR ä¸­ï¼Œç”¨æˆ·å¯èƒ½éœ€è¦ç­‰å¾…ä¸€æ®µæ—¶é—´ï¼ˆjsæ‰§è¡Œï¼ŒDOMæ„å»ºç­‰è€—æ—¶æ“ä½œï¼‰æ‰èƒ½çœ‹åˆ°äº¤äº’åŠŸèƒ½ã€‚
3.  SEOï¼šç”±äºæœç´¢å¼•æ“é€šå¸¸æ›´æ“…é•¿è§£æ HTMLï¼Œè€Œä¸æ˜¯ JavaScriptï¼Œå› æ­¤ SSR å¯ä»¥æé«˜æœç´¢å¼•æ“ä¼˜åŒ–ï¼ˆSEOï¼‰ã€‚æœç´¢å¼•æ“å¯ä»¥æ›´å®¹æ˜“åœ°è¯»å–å’Œç†è§£ SSR ç”Ÿæˆçš„ HTML ä¸­çš„å†…å®¹ã€‚è€Œ CSR åˆå§‹åŒ–çš„ html ä»…ä»…æ˜¯ä¸€ä¸ªå…¥å£æ–‡ä»¶ï¼Œæ²¡æœ‰çˆ¬å–çš„æ„ä¹‰ã€‚å¯ä»¥å‚è§è¿™ç¯‡ä¼˜åŒ– [SEO ä¼˜åŒ–](https://juejin.cn/post/7295651353854132239)
4.  æ€§èƒ½ï¼šSSR åœ¨æœåŠ¡å™¨ä¸Šå®Œæˆæ¸²æŸ“ï¼Œè¿™æ„å‘³ç€æœåŠ¡å™¨éœ€è¦æ›´å¤šçš„è®¡ç®—èµ„æºã€‚è€Œ CSR å°†æ¸²æŸ“å·¥ä½œè½¬ç§»åˆ°äº†å®¢æˆ·ç«¯ï¼Œè¿™å¯ä»¥å‡è½»æœåŠ¡å™¨çš„è´Ÿæ‹…ã€‚ç„¶è€Œï¼Œéšç€ç¡¬ä»¶æ€§èƒ½çš„æé«˜å’Œä¼˜åŒ–æŠ€æœ¯çš„è¿›æ­¥ï¼Œè¿™ç§å·®å¼‚å˜å¾—è¶Šæ¥è¶Šå°ã€‚
5.  å¤æ‚æ€§ï¼šSSR éœ€è¦æ›´å¤šçš„å¼€å‘å·¥ä½œï¼Œå› ä¸ºå®ƒæ¶‰åŠåˆ°åœ¨æœåŠ¡å™¨ç«¯å¤„ç†æ¸²æŸ“å’Œåœ¨å®¢æˆ·ç«¯å¤„ç† hydrateï¼ˆå°† HTML è½¬æ¢ä¸º React ç»„ä»¶ï¼‰ã€‚è€Œ CSR æ›´ç®€å•ï¼Œå› ä¸ºå®ƒåªéœ€è¦åœ¨å®¢æˆ·ç«¯å¤„ç†æ¸²æŸ“ã€‚

æ€»çš„æ¥è¯´ï¼Œè™½ç„¶ SSR å’Œ CSR åœ¨æŠ€æœ¯ä¸Šæœ‰ä¸€äº›åŒºåˆ«ï¼Œä½†å®ƒä»¬éƒ½å¯ä»¥æœ‰æ•ˆåœ°æ¸²æŸ“ React åº”ç”¨ã€‚é€‰æ‹©å“ªç§æ–¹æ³•å–å†³äºå…·ä½“çš„åº”ç”¨éœ€æ±‚å’Œåœºæ™¯ã€‚

ä¸‹é¢å›¾è§£è¯´æ˜ä¸€ä¸‹ï¼š

SSR:


![æ— æ ‡é¢˜-2023-10-11-1617.png](/img/posts/2023-11-3/2023-11-3-1.png)

----

CSR:

![æ— æ ‡é¢˜-2023-10-11-1617.png](/img/posts/2023-11-3/2023-11-3-2.png)

### SSR é€‚ç”¨çš„åœºæ™¯

- éœ€è¦ SEO ä¼˜åŒ–çš„åœºæ™¯
- éœ€è¦æ›´å¿«çš„é¦–å±æ—¶é—´
- é™æ€é¡µé¢æˆ–è€…blogç±»å†…å®¹å±•ç¤ºç±»ç½‘é¡µ
- éœ€è¦å¢å¼ºç”¨æˆ·å¯è®¿é—®æ€§çš„é¡µé¢ï¼šèƒ½å¤Ÿå¿«é€Ÿè·å–é¡µé¢å†…å®¹å¹¶è¿›è¡Œæµè§ˆ

### CSR é€‚ç”¨çš„åœºæ™¯

- é«˜äº¤äº’æ€§ã€å®æ—¶æ›´æ–°çš„åœºæ™¯ï¼š
- å¤æ‚å‰ç«¯é€»è¾‘åœºæ™¯ï¼šCSR å¯¹äºå¤æ‚çš„äº¤äº’å’ŒåŠ¨æ€æ•ˆæœçš„æ”¯æŒè¾ƒå¥½ï¼Œå¼€å‘ä¹Ÿç›¸å¯¹ç®€å•ã€‚
- APIé©±åŠ¨çš„åº”ç”¨ç¨‹åºï¼šCSR å…è®¸å®¢æˆ·ç«¯è·å–æ•°æ®æ¥å¤„ç†ï¼Œå¯ä»¥å‡å°‘æœåŠ¡å™¨è´Ÿè½½å¹¶æä¾›å“åº”å¼ä½“éªŒã€‚

## 2. React SSR çš„å‡ ç§ API

å®˜ç½‘æä¾›äº†è¿™ä¹ˆå‡ ä¸ª API ç”¨äºåœ¨æœåŠ¡ç«¯æ¸²æŸ“ React ç»„ä»¶ï¼š

### renderToString

å®ƒå¯ä»¥å°† React ç»„ä»¶æ¸²æŸ“æˆå­—ç¬¦ä¸²ï¼Œæœ€å¸¸ç”¨çš„ SSR APIã€‚å®ƒè¿”å›ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œå…¶ä¸­åŒ…å« HTML å’Œ React ç»„ä»¶çš„æ ‡è®°ã€‚è¿™ä¸ª API å¯ä»¥åœ¨æœåŠ¡å™¨ç«¯ä½¿ç”¨ï¼Œå°† React ç»„ä»¶æ¸²æŸ“æˆ HTMLï¼Œç„¶åå°† HTML å‘é€åˆ°å®¢æˆ·ç«¯ã€‚

æœåŠ¡ç«¯è¿™æ ·å†™ï¼ˆnodejsä¸ºä¾‹ï¼‰


```js
import { renderToString } from 'react-dom/server';

app.use('/', (request, response) => {
  const html = renderToString(<App />);
  response.send(html);
});
```

åœ¨å®¢æˆ·ç«¯æµè§ˆå™¨æ¥æ”¶åˆ°å®ƒåï¼Œè¦ä½¿ç”¨ React è¯­è¨€æ¸²æŸ“å‡ºæ¥ï¼š


```js
import { hydrateRoot } from 'react-dom/client';

hydrateRoot(document.getElementById('root'), <App/>);
```

hydrate ä¼šåœ¨æ¸²æŸ“çš„è¿‡ç¨‹ä¸­ï¼Œä¸åˆ›å»º html æ ‡ç­¾ï¼Œè€Œæ˜¯ç›´æ¥å…³è”å·²æœ‰çš„ã€‚è¿™æ ·å°±é¿å…äº†æ²¡å¿…è¦çš„æ¸²æŸ“ã€‚

### renderToPipeableStream

å®ƒå¯ä»¥å°† React ç»„ä»¶æ¸²æŸ“ä¸ºå¯è¯»çš„ Streamã€‚ä½¿ç”¨æ–¹å¼æœ‰ç•¥å¾®ä¸åŒï¼š

```js
import { renderToPipeableStream } from 'react-dom/server';

const stream = renderToPipeableStream(<App />);  
response.set('Content-Type', 'text/html');  
stream.pipe(res);  
```

ä¸åŒäº renderToStringï¼Œä»–å¯ä»¥ä½œä¸ºä¸€ä¸ªç®¡é“ä¸æ–­å¾€æœåŠ¡å™¨å“åº”é‡Œè¾“å‡ºå†…å®¹ã€‚`renderToPipeableStream`æä¾›äº†æ›´é«˜çº§çš„ç‰¹æ€§ï¼Œä¾‹å¦‚è·¯ç”±æ§åˆ¶ã€å¼‚æ­¥æ•°æ®åŠ è½½ç­‰ã€‚å®ƒè¿”å›ä¸€ä¸ªå¯è¯»çš„Streamå¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡å¯ä»¥ç”¨äºå°†Reactç»„ä»¶æ¸²æŸ“ä¸ºHTMLæ–‡æ¡£çš„æµå¼ä¼ è¾“ã€‚ä½¿ç”¨`renderToPipeableStream`å¯ä»¥åœ¨æœåŠ¡å™¨ç«¯å®ç°æ›´å¤æ‚çš„æ¸²æŸ“é€»è¾‘ï¼Œä¾‹å¦‚**æ ¹æ®è·¯ç”±è·¯å¾„åŠ¨æ€åŠ è½½ç»„ä»¶ã€æŒ‰éœ€åŠ è½½æ•°æ®**ç­‰ã€‚

### renderToReadableStream

ä»–æ˜¯ renderToPipeableStream çš„ä¸€ç§æ›¿ä»£æ–¹æ¡ˆã€‚

ä½¿ç”¨æ–¹å¼ï¼š

```js
import { renderToReadableStream } from 'react-dom/server';

async function handler(request) {
  const stream = await renderToReadableStream(<App />, {
    bootstrapScripts: ['/main.js']
  });
  return new Response(stream, {
    headers: { 'content-type': 'text/html' },
  });
}
```
è¿™ä¸ª API è¿”å›çš„æ˜¯ä¸€ä¸ª Promiseï¼Œä¾èµ– web æµï¼Œç›®å‰çš„å…¼å®¹æ€§å­˜åœ¨é—®é¢˜ã€‚å¯ä»¥å‚è€ƒ web æµçš„æ¦‚å¿µï¼š[Stream API](https://developer.mozilla.org/en-US/docs/Web/API/Streams_API)

### renderToStaticMarkup

`renderToStaticMarkup` ä¼šå°†éäº¤äº’çš„ React ç»„ä»¶æ ‘æ¸²æŸ“æˆ HTML å­—ç¬¦ä¸²ã€‚å…¶è¾“å‡ºæ— æ³•è¿›è¡ŒäºŒæ¬¡æ¸²æŸ“ï¼Œä¸”å¯¹ Suspense çš„æ”¯æŒæœ‰é™ã€‚ä¸å»ºè®®åœ¨å®¢æˆ·ç«¯ä»£ç ä¸­ä½¿ç”¨å®ƒã€‚

ä½¿ç”¨æ–¹å¼ï¼š

```js
import { renderToStaticMarkup } from 'react-dom/server';

// è·¯ç”±å¤„ç†ç¨‹åºè¯­æ³•å–å†³äºä½ çš„åç«¯æ¡†æ¶
app.use('/', (request, response) => {
  const html = renderToStaticMarkup(<Page />);
  response.send(html);
});
```

å¦‚æœè¦æ¸²æŸ“çš„æ˜¯çº¯é™æ€å†…å®¹ï¼Œåˆ™éå¸¸åˆé€‚ã€‚


### renderToStaticNodeStream

`renderToStaticNodeStream` å¯ä»¥ä¸º [Node.js åªè¯»æµ](https://nodejs.org/api/stream.html#readable-streams) æ¸²æŸ“éäº¤äº’å¼ React æ ‘ã€‚

å…¶ä½¿ç”¨ä¹Ÿæ˜¯ä¸€ä¸ªç®¡é“ï¼Œå¹¶å£°ç§°é™æ€çš„éäº¤äº’å¼ç½‘é¡µã€‚ä¸åŒçš„æ˜¯ï¼Œä»–éœ€è¦ç­‰å¾…æ‰€æœ‰ [Suspenseè¾¹ç•Œ](https://zh-hans.react.dev/reference/react/Suspense) å®Œæˆåæ‰è¿”å›è¾“å‡ºï¼Œä¸”è¿”å›ç»™å®¢æˆ·ç«¯çš„è¾“å‡ºç»“æœä¸æ”¯æŒ hydrateã€‚è¿™ä¸ªæ–¹æ³•çš„ä½œç”¨åœ¨äºç¼“å†²æ‰€æœ‰è¾“å‡ºï¼Œè¿™ä¸ªè¾“å‡ºæ˜¯ä¸€ä¸ªutf-8 ç¼–ç çš„å­—èŠ‚æµï¼Œ

----

ä¸Šé¢çš„ API ç”¨äºåœ¨è‡ªå®šä¹‰çš„æœåŠ¡å™¨ä¸­æ‰‹åŠ¨éƒ¨ç½² SSRï¼Œä½†æ˜¯ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæ¨èä½¿ç”¨ Nextjs éƒ¨ç½²ä¸€ä¸ª SSR åº”ç”¨ã€‚

## 3. React SSR/SSG æœ€ä½³å®è·µæ–¹æ¡ˆ - Next

å®˜æ–¹æ–‡æ¡£æ¨èä½¿ç”¨ Nextjs æ¥é…ç½® SSR é¡µé¢ï¼Œæœ€æ–°ç‰ˆçš„ React ä¹Ÿæ¨èä½¿ç”¨ [Nextjs](https://www.nextjs.cn/learn/basics/create-nextjs-app/setup) æ¥åˆ›å»º React Appã€‚æˆ‘ä»¬æ¥å®æˆ˜ä¸€ä¸‹ã€‚

> Node >= v18ï¼Œï¼Œæœ€æ–°ç‰ˆçš„ next éœ€è¦ node18+

### â‘ . æ–°å»ºä¸€ä¸ªç©ºçš„ npm ä»“åº“

```shell
npm init
```

### â‘¡. å®‰è£…ä¾èµ–

```shell
yarn add next react react-dom
```

### â‘¢. ä¿®æ”¹ `package.json`

```json
"scripts": {
  "dev": "next dev",
  "build": "next build",
  "start": "next start",
  "lint": "next lint"
}
```

### â‘£. åˆ›å»ºé¡µé¢æ–‡ä»¶

- é¡¹ç›®ä¸­åˆ›å»ºä¸€ä¸ªÂ `pages`Â ç›®å½•
- ç›®å½•ä¸­å†™ä¸€ä¸ª index.js


```js
function HomePage() {
  return <div>Welcome to Next.js!</div>
}

export default HomePage
```

- ç›®å½•ä¸­å†å†™ä¸€ä¸ªé¡µé¢ about.js


```js
function AboutPage() {
  return <div>Welcome to My blog!</div>
}

export default AboutPage
```

- å¯åŠ¨é¡¹ç›® `yarn dev`
- é€šè¿‡è·¯ç”±è®¿é—®é¡µé¢çœ‹çœ‹ï¼š`localhost:3000/about`


### â‘¤. æ·»åŠ åŠ¨æ€è·¯ç”±

pages ç›®å½•ä¸­åˆ›å»ºä¸€ä¸ªæ–‡ä»¶å¤¹å« postsï¼Œåœ¨ä¸‹é¢åˆ›å»ºåŠ¨æ€è·¯ç”±é¡µé¢ \[pid].js

```js
import { useRouter } from 'next/router'

const Post = () => {
  const router = useRouter()
  const { pid } = router.query

  return <p>Post: {pid}</p>
}

export default Post
```

ä½¿ç”¨ `localhost:3000/post/abc` è®¿é—®æŸ¥çœ‹é¡µé¢æ•ˆæœ


![image.png](/img/posts/2023-11-3/2023-11-3-3.png)

### â‘¥. é…ç½®é¢„æ¸²æŸ“

- SSG

å¦‚æœä½ çš„é¡µé¢æ˜¯çº¯é™æ€é¡µï¼Œä½¿ç”¨ SSG æ—¶ï¼ŒHTML æ–‡ä»¶å°†åœ¨æ¯ä¸ªé¡µé¢è¯·æ±‚æ—¶è¢«é‡ç”¨ï¼Œè¿˜å¯ä»¥è¢« CDN ç¼“å­˜ã€‚å¦‚æœä½ çš„é¡µé¢ä¸éœ€è¦è·å–å¤–éƒ¨æ•°æ®ï¼Œå¯ä»¥è¿™ä¹ˆå†™ï¼Œposts ä¸‹æ–°å»ºä¸€ä¸ª blog.jsï¼š


```js
function Blog() {
  const posts = [...];
  return (
    <ul>
      {posts.map((post) => (
        <li>{post.title}</li>
      ))}
    </ul>
  )
}

export default Blog
```

åšå®¢æ¸²æŸ“è‡ªç„¶ä¼šä¾èµ–å¤–éƒ¨æ¥å£ï¼Œå¯ä»¥è¿™ä¹ˆé…ç½®ï¼Œåœ¨åŒæ–‡ä»¶ï¼ˆblog.jsï¼‰ä¸­å¯¼å‡ºä¸€ä¸ªasyncå‡½æ•°ï¼š

```js
// posts æ˜¯å¤–éƒ¨æ¥å£è·å–åˆ°åï¼Œ getStaticProps ä¼ å…¥çš„
function Blog({ posts }) {...}

export async function getStaticProps() {
  // è°ƒç”¨å¤–éƒ¨ API è·å–åšæ–‡åˆ—è¡¨ (ç¼–è¯‘å’Œæ‰“åŒ…æ—¶å°±ä¼šè°ƒç”¨)
  const res = await fetch('https://.../posts')
  const posts = await res.json()

  // é€šè¿‡è¿”å› { props: { posts } } å¯¹è±¡ï¼ŒBlog ç»„ä»¶
  // åœ¨æ„å»ºæ—¶å°†æ¥æ”¶åˆ° `posts` å‚æ•°
  return {
    props: {
      posts,
    },
  }
}
```
> getStaticProps å‡½æ•°ï¼Œåœ¨é¡µé¢æ‰“åŒ…æ—¶å°±ä¼šæ‰§è¡Œå¹¶ç¼“å­˜ï¼Œåœ¨çº¿ä¸Šæ¨¡å¼ä¾¿ä¸ä¼šåå¤æ‰§è¡Œã€‚è€Œåœ¨å¼€å‘ç¯å¢ƒï¼Œæ¯æ¬¡åˆ·æ–°é¡µé¢æ—¶ï¼Œæ•´ä¸ªé¡µé¢ä¼šç­‰å¾… fetch è¿”å›æ•°æ®åæ‰åŠ è½½ã€‚


æ­¤å¤–ï¼ŒåŠ¨æ€è·¯ç”±é¡µ \[pid].js çš„æ¸²æŸ“ï¼Œä¹Ÿä¼šä¾èµ–å¤–éƒ¨åŠ¨æ€æ¥å£ï¼Œä¼ å…¥ abcï¼Œå°±è¡¨ç¤ºå±•ç¤º abc è¿™ä¸€ç¯‡æ–‡ç« çš„ä¿¡æ¯ï¼Œç°åœ¨æ¥é…ç½®è·¯å¾„é¢„æ¸²æŸ“ï¼ˆpages/posts/\[pid].js ä¸­ï¼‰ï¼š


```js
// æ­¤å‡½æ•°åœ¨æ„å»ºæ—¶è¢«è°ƒç”¨
export async function getStaticPaths() {
  // è°ƒç”¨å¤–éƒ¨ API è·å–åšæ–‡åˆ—è¡¨
  const res = await fetch('https://.../posts')
  const posts = await res.json()

  // æ®åšæ–‡åˆ—è¡¨ç”Ÿæˆæ‰€æœ‰éœ€è¦é¢„æ¸²æŸ“çš„è·¯å¾„
  const paths = posts.map((post) => ({
    params: { pid: post.id },
  }))

  // We'll pre-render only these paths at build time.
  // { fallback: false } means other routes should 404.
  return { paths, fallback: false }
}

// åœ¨æ„å»ºæ—¶ä¹Ÿä¼šè¢«è°ƒç”¨
export async function getStaticProps({ params }) {
  // params åŒ…å«æ­¤ç‰‡åšæ–‡çš„ `pid` ä¿¡æ¯ã€‚
  // å¦‚æœè·¯ç”±æ˜¯ /posts/1ï¼Œé‚£ä¹ˆ params.pid å°±æ˜¯ 1
  const res = await fetch(`https://.../posts/${params.pid}`)
  const post = await res.json()

  // é€šè¿‡ props å‚æ•°å‘é¡µé¢ä¼ é€’åšæ–‡çš„æ•°æ®
  return { props: { post } }
}
```

ä¸Šé¢çš„ä»£ç ï¼ŒgetStaticPaths è¿”å›å…è®¸è®¿é—®çš„ pid é›†åˆï¼Œæ¯”å¦‚æ¥å£è¿”å›äº†æ•°æ® paths: \[1,2,3,4], é‚£ä¹ˆä½ è¯·æ±‚ `localhost:3000/posts/5` å°±ä¼š 404; getStaticProps çš„é€»è¾‘ä¸ä¸Šé¢ä¸€æ ·ï¼Œå®é™…è®¿é—®äº† pid=1çš„è·¯å¾„ï¼Œé‚£ä¹ˆ params å°±æ˜¯ `{pid: 1}`ï¼Œç„¶åé˜»å¡é¡µé¢å»è·å–æ•°æ®ã€‚

- SSR

å¦‚æœä½ è¦ä½¿ç”¨Â **æœåŠ¡å™¨ç«¯æ¸²æŸ“**ï¼Œåˆ™ä¼šåœ¨Â **æ¯æ¬¡é¡µé¢è¯·æ±‚æ—¶**Â é‡æ–°ç”Ÿæˆé¡µé¢çš„ HTMLï¼Œè™½ç„¶é€Ÿåº¦ä¸åŠå‰è€…ï¼Œä½†æ˜¯é¢„æ¸²æŸ“çš„é¡µé¢å°†å§‹ç»ˆæ˜¯æœ€æ–°çš„ã€‚

ç±»ä¼¼åœ°ï¼Œä¹Ÿåœ¨é¡µé¢æ–‡ä»¶å¯¼å‡ºä¸€ä¸ªasyncå‡½æ•°ï¼š


```js
function Blog({ data }) {
  // Render data...
}

// This gets called on every request
export async function getServerSideProps() {
  // Fetch data from external API
  const res = await fetch(`https://.../data`)
  const data = await res.json()

  // Pass data to the page via props
  return { props: { data } }
}
```
æ‰§è¡Œè¿‡ç¨‹å¤§åŒå°å¼‚ï¼Œä¸åŒçš„æ˜¯æ¯æ¬¡çº¿ä¸Šè¯·æ±‚é¡µé¢éƒ½ä¼šå»è°ƒç”¨ getServerSideProps æ¥è¯·æ±‚æ¥å£ã€‚

### â‘¦. é…ç½®å…¥å£ç»„ä»¶

åœ¨ pages ç›®å½•ä¸‹é…ç½®ä¸€ä¸ªæ–‡ä»¶ _app.js:

```js
// å¦‚æœæœ‰ css å°±å¼•å…¥
import '../styles.css'

// æ–°åˆ›å»ºçš„ `pages/_app.js` æ–‡ä»¶ä¸­å¿…é¡»æœ‰æ­¤é»˜è®¤çš„å¯¼å‡ºï¼ˆexportï¼‰å‡½æ•°
export default function MyApp({ Component, pageProps }) {
  return <Component {...pageProps} />
}
```
_app.js é»˜è®¤æ˜¯æ‰€æœ‰é¡µé¢æ–‡ä»¶çš„æ€»å…¥å£ï¼Œä»–å¯ä»¥æ¥å—ä¸¤ä¸ªå‚æ•°ï¼ŒComponent æ˜¯å½“å‰çš„ç»„ä»¶ï¼ŒpageProps æ˜¯è¿™ä¸ªç»„ä»¶çš„ propsã€‚ä½œä¸ºç»Ÿä¸€çš„å…¥å£ï¼Œåœ¨è¿™é‡Œä½ å°±å¯ä»¥é…ç½®å¾ˆå¤šå‚æ•°äº†ï¼Œæ¯”å¦‚ seoé…ç½®ã€å…¬å…±æ ·å¼ã€å¸ƒå±€èœå•ç­‰ã€‚

### â‘§. é…ç½®æ ·å¼

åœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»º style.cssï¼Œå¹¶åœ¨ _app.js ä¸­å¼•å…¥ï¼š


```css
body {
  font-family: 'SF Pro Text', 'SF Pro Icons', 'Helvetica Neue', 'Helvetica',
    'Arial', sans-serif;
  margin: 0 auto;
}
```

å¦‚æœè¦ä½¿ç”¨ sassï¼Œå¯ä»¥å…ˆå®‰è£…ä¾èµ–ï¼š

```
yarn add sass
```

åœ¨é¡¹ç›®ä¸­å¼•å…¥ sass æ¨¡å—ï¼š

```js
import variables from '../styles/variables.module.scss'
```

### â‘¨. é¡µé¢å¸ƒå±€

åœ¨ _app.js ä¸­å¼•å…¥è‡ªå®šä¹‰çš„å¸ƒå±€ç»„ä»¶ï¼š

```js
import Layout from '../components/layout'

export default function MyApp({ Component, pageProps }) {
  return (
    <Layout>
      <Component {...pageProps} />
    </Layout>
  )
}
```

Layout å¯ä»¥æ˜¯ä¸‹é¢çš„å½¢å¼ï¼š

```js
import useSWR from 'swr'
import Navbar from './navbar'
import Footer from './footer'

export default function Layout({ children }) {
  const { data, error } = useSWR('/api/navigation', fetcher)

  if (error) return <div>Failed to load</div>
  if (!data) return <div>Loading...</div>

  return (
    <>
      <Navbar links={data.links} />
      <main>{children}</main>
      <Footer />
    </>
  )
}
```

è¿™é‡Œç”¨äº†ç¬¬ä¸‰æ–¹åº“æ¥è¯·æ±‚ï¼Œå…¶ä¸­çš„ fetcher å¯ä»¥è¿™ä¹ˆå†™ï¼š

```js
const fetcher = (url) => fetch(url).then((res) => res.json());
```

### â‘©. é…ç½®é™æ€èµ„æº

åœ¨æ ¹ç›®å½•ä¸‹æ–°å»º public ç›®å½•ã€‚

- å¼•å…¥æœ¬åœ°å›¾ç‰‡

```js
import Image from 'next/image'
import profilePic from '../public/me.png'

<Image
    src={profilePic}
    alt="Picture of the author"
/>
```
- åŠ è½½è¿œç¨‹å›¾ç‰‡

```js
<Image
    src="/me.png"
    alt="Picture of the author"
    width={500}
    height={500}
    priority
/>
```
è¿œç¨‹èµ„æºåŸŸåé…ç½®æœ‰ä¸¤ç§æ–¹å¼ï¼Œåœ¨æ ¹ç›®å½•ä¸‹æ–°å»ºé…ç½®æ–‡ä»¶ next.config.js:

ç¬¬ä¸€ç§ï¼š
```js
module.exports = {
  images: {
    domains: ['example.com', 'example2.com'],
  },
}
```
è¿™ä¸ªé…ç½®ä¸“é—¨ç”¨äºåŠ è½½å›¾ç‰‡ï¼Œè®¾ç½®åŸŸååªæ˜¯å…¶ä¸­ä¸€ä¸ªé€‰æ‹©é¡¹ï¼Œé»˜è®¤ä½¿ç”¨æ•°ç»„ç¬¬ä¸€ä¸ªåŸŸåï¼Œåœ¨å…·ä½“ä½¿ç”¨æ—¶ï¼Œå¯ä»¥æ‰‹åŠ¨æŒ‡å®šæ•°ç»„ä¸­çš„æšä¸¾é¡¹ï¼š`<Image src="my-image.jpg?domain=https://example2.com" alt="My Image" />`

ç¬¬äºŒç§ï¼š

```js
async rewrites() {
    return {
      fallback: [
        {
          source: '/home/:image*',
          destination: `https://${isProd ? CDNPath : filePath}/home/:image*`
        }
      ]
    }
}
```
è¿™ä¸ªé…ç½®ç”¨äºé‡å†™è§„åˆ™ï¼Œä½œç”¨åŸŸæ¯”è¾ƒå¹¿ï¼Œè¿˜å¯ä»¥ç”¨æ¥æ‹¦æˆª API è¯·æ±‚ç­‰ã€‚

- ä½¿ç”¨å¤–æŒ‚å­—ä½“

åœ¨ pages æ–°å»ºä¸€ä¸ª _document.js æ–‡ä»¶ï¼š

```js
import Document, { Html, Head, Main, NextScript } from 'next/document'

class MyDocument extends Document {
  render() {
    return (
      <Html>
        <Head>
          <link
            href="https://fonts.googleapis.com/css2?family=Inter&display=optional"
            rel="stylesheet"
          />
        </Head>
        <body>
          <Main />
          <NextScript />
        </body>
      </Html>
    )
  }
}

export default MyDocument
```

> _document.js ç”¨äºè‡ªå®šä¹‰ \<head> æ ‡ç­¾ã€å®šä¹‰ CSS æ ·å¼ã€æ·»åŠ å…ƒæ•°æ®ï¼ˆmetadataï¼‰ç­‰

- ä½¿ç”¨å¤–éƒ¨è„šæœ¬

```js
class MyDocument extends Document {
...
    <Head>
        <Script src="https://connect.facebook.net/en_US/sdk.js" strategy="lazyOnload" />
    </Head>
    <body>
      <Main />
      <NextScript />
    </body>
}
```

### â‘ª. ç¯å¢ƒå˜é‡é…ç½®

Next.js å†…ç½®æ”¯æŒå°†ç¯å¢ƒå˜é‡ä»Â `.env.local`Â åŠ è½½åˆ°Â `process.env`Â ä¸­ã€‚ä½ å¯ä»¥åœ¨æœ¬åœ°æ ¹ç›®å½•æ–‡ä»¶ `.env.local` ä¸­å†™å…¥è‡ªå®šä¹‰çš„å˜é‡ï¼š

```
environment=development
```

ç„¶åå¯ä»¥åœ¨é…ç½®æ–‡ä»¶ä¸­è·å–ï¼š`process.env.environment`

ä½ ä¹Ÿå¯ä»¥ç›´æ¥åŠ ä¸Šå‰ç¼€ï¼šNEXT_PUBLIC

```
NEXT_PUBLIC_ANALYTICS_ID=abcdefghijk
```
è¿™æ ·çš„å˜é‡ä¼šåŠ è½½åœ¨nodejsä¸­ï¼Œä½ åœ¨jsæ–‡ä»¶é‡Œä¹Ÿå¯ä»¥é€šè¿‡ process æ¥è®¿é—®äº†ã€‚

### â‘«. é…ç½®i18n

å®‰è£…ä¾èµ–ï¼š`yarn add react-i18next i18next next-i18next`

åœ¨ _app.js ä¸­å¼•å…¥ï¼š

```js
import { appWithTranslation } from 'next-i18next';

...
export default memo(appWithTranslation(MyApp));
```

åœ¨ public æ–‡ä»¶å¤¹é‡Œå†™å…¥ä¸­è‹±æ–‡æ–‡æ¡ˆï¼š

![image.png](/img/posts/2023-11-3/2023-11-3-4.png)

![image.png](/img/posts/2023-11-3/2023-11-3-5.png)

![](/img/posts/2023-11-3/2023-11-3-6.png)

æ ¹ç›®å½•ä¸‹æ·»åŠ é…ç½®æ–‡ä»¶ next-i18next.config.jsï¼š

```js
module.exports = {
  i18n: {
    localeDetection: false, // ä¸æ£€æµ‹æµè§ˆå™¨è¯­è¨€ç¯å¢ƒ
    defaultLocale: 'en',
    locales: ['en' , 'zh']
  },
  localePath: typeof window === 'undefined'
    ? require('path').resolve('./public/locales')
    : require('path').resolve('./public/locales'),
  reloadOnPrerender: process.env.NEXT_PUBLIC_DOMAIN_ENV === 'development',
};
```
å¹¶åœ¨ next-config.js ä¸­å¼•å…¥ï¼š

```js
const { i18n } = require('./next-i18next.config');

module.exports = () => {

  return {
    i18n,
  }
}
```

åœ¨ç»„ä»¶ä¸­ä½¿ç”¨ï¼š

```js
import { serverSideTranslations } from 'next-i18next/serverSideTranslations';
import { useTranslation } from 'next-i18next';

const { t } = useTranslation(['common']);

...
// æ¸²æŸ“æ—¶ä½¿ç”¨
<button className={`${Style['btn-link']} mr-16 primary button-outlined`}>
  {t('login')}
</button>
...

export const getStaticProps = async ({
  locale,
}) => {
  return {
    props: {
      ...(await serverSideTranslations(locale ?? 'en', [
        'common'
      ])),
    },
  }
}

```
i18n ä¼šåœ¨é¢„ç¼–è¯‘çš„æ—¶å€™ï¼Œå¾€ getStaticProps ä¼ å…¥å›½é™…åŒ–æ–‡æ¡ˆå‚æ•°ã€‚æ§åˆ¶æ˜¾ç¤ºå“ªä¸€ä¸ªæ–‡æ¡ˆï¼Œæ˜¯æ ¹æ®é…ç½®çš„ç›®å½•å’Œè®¿é—®è·¯å¾„æ¥çš„ï¼Œæ¯”å¦‚è¦æ˜¾ç¤ºä¸­æ–‡ï¼Œlocalesä¸‹æœ‰ä¸ªzhæ–‡ä»¶å¤¹ï¼Œä½ çš„è®¿é—®è·¯å¾„ä¹Ÿåº”è¯¥å¯¹åº”ï¼š


![image.png](/img/posts/2023-11-3/2023-11-3-12.png)

æ‰€ä»¥å¯ä»¥å†™ä¸€ä¸ªå…¨å±€çš„åˆ‡æ¢æŒ‰é’®ï¼Œæ¥æ§åˆ¶è·¯ç”±å˜åŒ–ï¼š`window.location.href = '/zh';`


### â‘¬. è‡ªå®šä¹‰é…ç½®

nextjs æä¾›è‡ªå®šä¹‰é…ç½®æ–‡ä»¶ next.config.js (æˆ– mjsï¼Œä½¿ç”¨ ESM) ç”¨äºé«˜çº§é…ç½®:

```js
// å¸¸ç”¨é…ç½®
const { PHASE_DEVELOPMENT_SERVER } = require('next/constants')

module.exports = (phase, { defaultConfig }) => {
  // å¼€å‘ç¯å¢ƒé…ç½®
  if (phase === PHASE_DEVELOPMENT_SERVER) {
    return {
        env: {
          env: 'dev', // å¯åœ¨é¡µé¢ä½¿ç”¨ï¼š<h1>env is: {process.env.env}</h1>
        },
        basePath: '/docs', // åŸºç¡€è·¯å¾„ï¼Œæ‰€æœ‰çš„Linkè·³è½¬ä¼šä»¥è¿™ä¸ªä¸ºåŸºç¡€
        compress: false, // å‹ç¼©ä»£ç 
        generateEtags: false, // ç¦ç”¨ ETag ï¼Ÿ
        distDir: 'build', // è‡ªå®šä¹‰è¾“å‡ºç›®å½•
        async redirects() {  // é‡å®šå‘
          return [
            {
              source: '/about',
              destination: '/',
              permanent: true,
            },
          ]
        },
        async rewrites() { // é‡å†™èµ„æºè·¯å¾„ï¼Œé»˜è®¤æ˜¯åœ¨æ£€æŸ¥æ–‡ä»¶ç³»ç»Ÿï¼ˆé¡µé¢å’Œ`/public`æ–‡ä»¶ï¼‰ä¹‹åã€åŠ¨æ€è·¯ç”±ä¹‹å‰åº”ç”¨çš„ï¼›ä½¿ç”¨ fallback è¡¨ç¤ºæ¯æ¬¡æ£€æŸ¥æ–‡ä»¶å’ŒåŠ¨æ€è·¯ç”±ä¹‹åè§¦å‘
          return {
            fallback: [
              {
                source: '/home/:image*',
                destination: `https://${isProd ? CDNPath : filePath}/home/:image*`
              },
            ]
          }
        },
      }
  }

  return {
    // åŒä¸Š...
  }
}
```
### â‘­. éƒ¨ç½²

- å°†ä»£ç æ¨é€åˆ° github
- æ³¨å†Œä¸€ä¸ª vercelè´¦å·ï¼šhttps://vercel.com/signup
- é€‰æ‹©å…³è”ä»“åº“ï¼Œé€‰ä¸­ä½ çš„ä»“åº“


![image.png](/img/posts/2023-11-3/2023-11-3-7.png)


![image.png](/img/posts/2023-11-3/2023-11-3-8.png)

- ç‚¹å‡»éƒ¨ç½²åä¼šè‡ªåŠ¨éƒ¨ç½²


![image.png](/img/posts/2023-11-3/2023-11-3-9.png)

- ç„¶ååœ¨ github ä»“åº“å³ä¾§ä¼šå‡ºç°é“¾æ¥ï¼š


![image.png](/img/posts/2023-11-3/2023-11-3-10.png)ã€

- æŸ¥çœ‹åšå®¢


![image.png](/img/posts/2023-11-3/2023-11-3-11.png)14:T391a,ç°ä»£æµè§ˆå™¨çš„åº•å±‚åŸç†ç‰¹åˆ«çš„å¤æ‚ï¼Œå¯ä»¥è¯´æ˜¯ä¸€ä¸ªå°å‹çš„æ“ä½œç³»ç»Ÿã€‚ä»¥ chrome ä¸ºä¾‹ï¼Œä»–æ˜¯å¤šè¿›ç¨‹çš„æµè§ˆå™¨ï¼Œå…¶ä¸­æ¸²æŸ“é¡µé¢æ˜¯ä¸€ä¸ªå•ç‹¬çš„è¿›ç¨‹ï¼Œå«åšæ¸²æŸ“è¿›ç¨‹ã€‚ç›®å‰ç”¨çš„æœ€å¤šçš„æ–¹å¼æ˜¯ä¸€ä¸ª tab é¡µå•ç‹¬åˆ†é…ä¸€ä¸ªæ¸²æŸ“è¿›ç¨‹æ¥ç»´æŠ¤ã€‚æ¯ä¸€ä¸ªæ¸²æŸ“è¿›ç¨‹ä¸­ï¼Œæœ‰ä¸€ä¸ªæ¸²æŸ“ä¸»çº¿ç¨‹ç”¨äºæ— é˜»å¡åœ°æ‰§è¡Œæ¸²æŸ“ä»»åŠ¡ã€‚

æ¸²æŸ“ï¼Œé€šä¿—çš„è§£é‡Šå°±æ˜¯**å°† html å­—ç¬¦ä¸²è§£æä¸ºå›¾å½¢åƒç´ ä¿¡æ¯**çš„è¿‡ç¨‹ã€‚ä½ è¾“å…¥ä¸€ä¸ª url åœ°å€åï¼Œä¼šé€šè¿‡ä¸€ç³»åˆ—è§£æï¼Œä»ç›®æ ‡æœåŠ¡å™¨ç›´æ¥æˆ–é—´æ¥è·å–åˆ°è¿™ä¸ª html å­—ç¬¦ä¸²ï¼Œè€Œæ¸²æŸ“è¿›ç¨‹è¦åšçš„å°±æ˜¯è¿™ä¸ªç¿»è¯‘ä¸ºåƒç´ ä¿¡æ¯çš„è¿‡ç¨‹ã€‚

æœ¬æ–‡å°±é€šè¿‡å›¾è§£æ¥è®²è¿°æµè§ˆå™¨çš„æ¸²æŸ“ä¸»çº¿ç¨‹çš„å·¥ä½œè¿‡ç¨‹ã€‚

[chromium å†…æ ¸æºç ](https://github.com/chromium/chromium)

----

## 0. æ¸²æŸ“æµæ°´çº¿

ä¾æ®æ¶ˆæ¯å¾ªç¯çš„æ¦‚å¿µï¼Œæµè§ˆå™¨æ¸²æŸ“ä¸»çº¿ç¨‹æŒ‰ç…§å„ä¸ªä»»åŠ¡é˜Ÿåˆ—ï¼ˆå¾®ä»»åŠ¡é˜Ÿåˆ—ã€äº¤äº’é˜Ÿåˆ—ï¼Œå»¶æ—¶é˜Ÿåˆ—ç­‰ï¼‰ä¼˜å…ˆçº§ï¼Œå–ç”¨ä»»åŠ¡åŒ…å¹¶æ‰§è¡Œã€‚é‚£ä¹ˆï¼Œæ‰§è¡Œçš„è¿™äº›åŒ…åçš„å˜æ›´ï¼Œä½•æ—¶ä¼šçœŸæ­£å‘ˆç°åœ¨é¡µé¢ä¸Šå‘¢ï¼Ÿæˆ‘ä»¬çœ‹å›¾ï¼š


![æ— æ ‡é¢˜-2023-10-06-1925.png](/img/posts/2023-10-26/2023-10-26-1.png)

åœ¨æµè§ˆå™¨å‘å‰ç«¯æœåŠ¡å™¨è¯·æ±‚åˆ° html å­—ç¬¦ä¸²åï¼Œå°±æ‰“åŒ…ä¸ºä¸€ä¸ªæ¶ˆæ¯å¾ªç¯ä¸­çš„ä¸€ä¸ªæ¸²æŸ“ä»»åŠ¡ï¼Œäº¤ç”±æ¸²æŸ“ä¸»çº¿ç¨‹æ‰§è¡Œæ¸²æŸ“å·¥ä½œã€‚

é‚£ä¹ˆæµè§ˆå™¨æ˜¯å¦‚ä½•è§£æè¿™ä¸ª html å­—ç¬¦ä¸²çš„å‘¢ï¼Ÿæˆ‘ä»¬å…ˆæ¥æ€»è§ˆä¸€ä¸‹ä»–çš„è§£ææµæ°´çº¿ï¼Œä¹‹åçš„å°èŠ‚å†åˆ†æ­¥æ¥è®²è§£ï¼š


![æ— æ ‡é¢˜-2023-10-06-1925.png](/img/posts/2023-10-26/2023-10-26-2.png)

## 1. è§£æ HTML

æˆ‘ä»¬è·å–ä¸€ä¸ªé¡µé¢ï¼Œä¸€èˆ¬éƒ½æ˜¯é€šè¿‡ç½‘ç»œè¯·æ±‚æ‹¿åˆ° html å­—ç¬¦ä¸²æœ¬èº«çš„ï¼š


![image.png](/img/posts/2023-10-26/2023-10-26-3.png)

æˆ‘ä»¬ä¹Ÿå¯ä»¥åŠ ä¸Š `view-source` å‰ç¼€æ¥è®¿é—®è¿™ä¸ªå­—ç¬¦ä¸²ï¼š`view-source:https://www.ucloud.cn`


![image.png](/img/posts/2023-10-26/2023-10-26-4.png)

ä»–ä¸éšåè·å–åˆ°çš„ cssã€js æ–‡ä»¶å…±åŒå½±å“äº†é¡µé¢çš„æ¸²æŸ“ã€‚

æµè§ˆå™¨è·å–åˆ° HTMLåï¼Œäº§ç”Ÿæ¸²æŸ“ä»»åŠ¡ï¼Œäº¤ç»™æ¸²æŸ“ä¸»çº¿ç¨‹çš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚éšåçš„æ¸²æŸ“è§£æå™¨ä¼šå°†è¿™ä¸ªç»“æ„è§£æä¸º DOM æ ‘ å’Œ CSSOM æ ‘ã€‚

å…ˆè§£é‡Šæ¦‚å¿µï¼š

- DOMæ ‘ï¼šæ–‡æ¡£å¯¹è±¡æ¨¡å‹ï¼Œæ˜¯ç½‘é¡µä¸­ htmlå…ƒç´ ä¸ºæ ¹èŠ‚ç‚¹çš„ä¸€é¢—å…ƒç´ å…³è”å…³ç³»çš„é›†åˆ


![æ— æ ‡é¢˜-2023-10-06-1925.png](/img/posts/2023-10-26/2023-10-26-5.png)

- CSSOMæ ‘: æ˜¯ç½‘é¡µCSSå¯¹è±¡æ¨¡å‹ï¼Œæè¿°é¡µé¢DOMç»“æ„å±‚é›†ä¸­çš„cssæ ·å¼


![æ— æ ‡é¢˜-2023-10-06-1925.png](/img/posts/2023-10-26/2023-10-26-6.png)

å…¶ä¸­ï¼š

- StyleSheetList æ˜¯é¡µé¢ CSSOM æ ¹èŠ‚ç‚¹ï¼Œä»£è¡¨é¡µé¢æ‰€æœ‰çš„æ ·å¼è¡¨ï¼Œå…¶åŒ…å«å¤šå¥—ä¸åŒä¼˜å…ˆçº§çš„æ ·å¼è¡¨ 
- CSSStyleSheet æ˜¯é¡µé¢æ ·å¼è¡¨ï¼Œæœ‰è¿™å‡ ç§ï¼šå†…è”ï¼ˆ`<div style="">`ï¼‰ã€å¤–éƒ¨ï¼ˆ`<link>`ï¼‰ã€å†…éƒ¨ï¼ˆ`<style>`ï¼‰å’Œé»˜è®¤æ ·å¼è¡¨ ï¼ˆä¹Ÿå«ç”¨æˆ·ä»£ç†æ ·å¼è¡¨ï¼Œæ¯ä¸ªæµè§ˆå™¨å†…ç½®æ ·å¼ï¼‰ï¼Œé€šè¿‡ `document.styleSheets` å¯ä»¥è·å–ä¸Šä¸‹æ–‡ä¸­æ‰€æœ‰çš„æ ·å¼è¡¨ã€‚
- CSSStyleRuleï¼šcss è§„åˆ™ï¼Œæ¯”å¦‚ï¼š`body { margin: 0 }` å°±æ˜¯ä¸€ä¸ªè§„åˆ™

> æµè§ˆå™¨çš„ API ä½¿ç”¨ C++ å®ç°ï¼Œå…¶ä½¿ç”¨ js è¿›è¡Œäº†å°è£…ï¼Œä½¿å¾— DOM æ“ä½œå¯ä»¥ä½¿ç”¨ js å®Œæˆ

çŸ¥é“äº†ä¸Šè¿°æ¦‚å¿µï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹æµè§ˆå™¨è§£æ html çš„è¿‡ç¨‹ï¼š


![æ— æ ‡é¢˜-2023-10-06-1925.png](/img/posts/2023-10-26/2023-10-26-7.png)

æˆ‘ä»¬æ¥çœ‹å›¾è¯´è¯ï¼š

1. æ¸²æŸ“ä¸»çº¿ç¨‹æ— é˜»å¡çš„è¯»å– html å­—ç¬¦ä¸²
2. é‡åˆ°cssï¼Œäº¤ç”±é¢„è§£æçº¿ç¨‹çº¿ç¨‹å‡†å¤‡cssèµ„æºï¼Œå‡†å¤‡å¥½åæ— é˜»å¡è§£æï¼Œå¹¶æ¨é€ä»»åŠ¡ã€‚æ¸²æŸ“ä¸»çº¿ç¨‹é€šè¿‡cssæ„é€ CSSOM
3. é‡åˆ°jsï¼Œäº¤ç”±é¢„è§£æçº¿ç¨‹å‡†å¤‡jsèµ„æºï¼Œå‡†å¤‡å¥½åå¼€å§‹æ‰§è¡Œjsï¼Œjsä¼šå½±å“CSSOM/DOMæ ‘çš„ç»“æ„ï¼Œæ‰€ä»¥ä¸»çº¿ç¨‹éœ€è¦é˜»å¡ç­‰å¾…ï¼Œæ‰§è¡Œå®Œæ¯•åï¼Œé‡æ–°æ„å»ºCSSOM/DOMæ ‘
4. æ¸²æŸ“ä¸»çº¿ç¨‹ç»§ç»­å‘ä¸‹æ‰§è¡Œï¼Œé‡å¤ä¸Šé¢çš„æ­¥éª¤ï¼Œç›´åˆ°ç»“æŸã€‚

è¿™ä¸€æ­¥çš„äº§å‡ºï¼šDOM/CSSOM

## 2. æ ·å¼è®¡ç®—

è¿™ä¸€æ­¥çš„ç›®çš„æ˜¯éå† DOMæ ‘ï¼Œæ‰¾åˆ°é¡µé¢å„ä¸ªå…ƒç´ çš„æœ€ç»ˆè®¡ç®—æ ·å¼ï¼ˆComputed Styleï¼‰ï¼š


![image.png](/img/posts/2023-10-26/2023-10-26-8.png)

åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼š

- é¢„è®¾å€¼ä¼šå˜ä¸ºç»å¯¹å€¼ã€‚æ¯”å¦‚ 100% -> pxï¼Œ0.125rem -> pxï¼Œred -> rgb(255, 0, 0)ç­‰
- åŒä¸€å…ƒç´ æŒ‰ç…§ä¼˜å…ˆçº§å±‚å ã€ç»§æ‰¿ç­‰å„ç§å› ç´ å†³å®šæœ€ç»ˆçš„æ ·å¼
- è®¡ç®—æ ·å¼ä¼šå±•ç¤ºæ‰€æœ‰çš„å¯èƒ½æ ·å¼ï¼Œå³ä½¿æ²¡æœ‰è®¾ç½®è¿‡ï¼Œä¹Ÿä¼šæ˜¯ none æˆ–è€… unset

è·å–è®¡ç®—æ ·å¼æœ‰å“ªäº›ï¼Œå¯ä»¥ä½¿ç”¨ APIï¼š`getComputedStyle`


![image.png](/img/posts/2023-10-26/2023-10-26-9.png)

## 3. å¸ƒå±€

å¸ƒå±€çš„è¿‡ç¨‹ï¼Œå°±æ˜¯é€šè¿‡ CSSOM/DOM æ ‘ç”ŸæˆçœŸæ­£åœ¨é¡µé¢å±•ç¤ºçš„ç»“æ„å¸ƒå±€æ ‘ã€‚æˆ‘ä»¬çœ‹å›¾ï¼š


![æ— æ ‡é¢˜-2023-10-06-1925.png](/img/posts/2023-10-26/2023-10-26-10.png)

ä¸Šå›¾è¿™ä¸ªä¾‹å­å°±å¾ˆå¥½çš„è¯´æ˜äº† DOM æ ‘å’Œå¸ƒå±€æ ‘çš„åŒºåˆ«ã€‚å¸ƒå±€æ ‘ä¸­çš„å„ä¸ªèŠ‚ç‚¹éƒ½æ˜¯ä¼šæœ‰è‡ªå·±çš„åŒ…å«å—çš„ã€‚

> åŒ…å«å—ï¼š100% è®¡ç®—çš„ç›¸å¯¹å°ºå¯¸å°±æ˜¯è¯¥å…ƒç´ çš„åŒ…å«å—ã€‚å¦‚æœæ˜¯ absolute å®šä½å…ƒç´ ï¼Œå…¶åŒ…å«å—æ˜¯ç¦»ä»–æœ€è¿‘çš„è®¾ç½®äº†é static å®šä½çš„ç¥–å…ˆå…ƒç´ 


å…¶å®åœ¨ chrome æºç ä¸­ä¹Ÿè§„å®šäº†å„ä¸ªæ ‡ç­¾çš„å†…ç½®æ ·å¼ï¼Œä»–ä»¬éƒ½ä¼šåœ¨å¸ƒå±€é˜¶æ®µè¿›è¡Œåˆ¤æ–­ï¼š

![image.png](/img/posts/2023-10-26/2023-10-26-11.png)

å¦å¤–ä¸€ä¸ªå¸ƒå±€ä¸ DOM ä¸ä¸€æ ·çš„æ˜¯ï¼šæ–‡æœ¬å†…å®¹å¿…é¡»åœ¨è¡Œç›’ä¸­ï¼Œå…·åçš„è¡Œç›’å’Œå—ç›’åœ¨å¸ƒå±€æ ‘ä¸­ä¸èƒ½ç›¸é‚»ï¼Œæ¯”å¦‚ä¸€ä¸ª `inline-block` å’Œä¸€ä¸ª `flex`ï¼Œä»–ä»¬è‚¯å®šæ˜¯åˆ†ä¸¤è¡Œæ˜¾ç¤ºçš„ï¼Œæµè§ˆå™¨ä¸€ç§å¤„ç†æ–¹å¼æ˜¯æ’å…¥ä¸€ä¸ªæˆ–å¤šä¸ªåŒ¿åçš„ç›’å­æ¥åšé—´éš”ï¼š


![æ— æ ‡é¢˜-2023-10-06-1925.png](/img/posts/2023-10-26/2023-10-26-12.png)

> å¸ƒå±€éœ€è¦è€ƒè™‘çš„å› ç´ æœ‰å¾ˆå¤šï¼Œå®šä½ã€æ ·å¼ã€ BFC ç­‰ï¼›åŒæ—¶åœ¨å¸ƒå±€æ ‘é‡Œä¹Ÿä¼šæš´éœ²ä¸€äº›å¸¸ç”¨ä¿¡æ¯ï¼Œæ¯”å¦‚ clientHeightã€offsetHeight ç­‰

> å¸ƒå±€çš„ä¾‹å­è¿˜æœ‰å¾ˆå¤šï¼Œä¸Šé¢çš„ä¾‹å­æ—¨åœ¨è¯´æ˜ DOM æ ‘ï¼ˆjsonï¼‰å’Œ å¸ƒå±€æ ‘çš„ç»“æ„ï¼ˆc++ å¯¹è±¡ï¼‰å¾€å¾€æ˜¯ä¸ä¸€æ ·çš„

## 4. åˆ†å±‚

ç°ä»£æµè§ˆå™¨ä¸ºäº†æå‡æ¸²æŸ“æ•ˆç‡ï¼Œå°†äºŒç»´æå‡åˆ°ä¸‰ç»´ï¼Œå¢åŠ ç»´åº¦ï¼Œå¼€è¾Ÿæ–°çš„ç©ºé—´ã€‚ç±»ä¼¼äº PS ä¸­çš„å›¾å±‚ï¼Œä¾¿äºå±€éƒ¨æ¸²æŸ“ã€‚

åœ¨å¸ƒå±€ç¡®å®šäº†å…ƒç´ çš„ä½ç½®å’Œæ ·å¼ä»¥åï¼Œæµè§ˆå™¨ä¼šæ ¹æ®æ¸²æŸ“å¼•æ“çš„ä¸åŒé‡‡ç”¨ä¸åŒçš„åˆ†å±‚æ–¹å¼ã€‚



![å±å¹•å½•åˆ¶2023-10-26 ä¸‹åˆ4.29.57 (2).gif](/img/posts/2023-10-26/2023-10-26-13.gif)

> ä¸Šå›¾ä¸­å¯ä»¥çœ‹åˆ°ï¼Œæ˜¯æœ‰åˆ†å±‚çš„ã€‚è‡³å°‘æ»šåŠ¨æ¡æ˜¯é»˜è®¤å±‚çº§é«˜äºé¡µé¢çš„ã€‚

åˆ†å±‚ä¸€èˆ¬æ˜¯è·Ÿ css å±æ€§æœ‰å…³ç³»ï¼Œä¸€èˆ¬åœ°ï¼Œå †å ä¸Šä¸‹æ–‡ç›¸å…³çš„å±æ€§ä¼šå½±å“åˆ†å±‚ã€‚ æ¯”å¦‚ z-index å¼ºåˆ¶æé«˜å±‚çº§ï¼›whil-change åˆ™é€‚ç”¨äºåˆ†å±‚æ¸²æŸ“çš„æµè§ˆå™¨ï¼Œå‘Šè¯‰æµè§ˆå™¨ï¼Œæ ¹æ®å®é™…æƒ…å†µå°†å…¶å•ç‹¬åˆ†å±‚ã€‚

åˆ†å±‚çš„ä½œç”¨ï¼š

- æé«˜æ¸²æŸ“æ•ˆç‡ï¼šé€‚ç”¨äºä½ç½®åå¤å˜åŒ–çš„å…ƒç´ ï¼Œå›æµé‡ç»˜åªåœ¨åŒå±‚å‡ºç°ï¼Œè®¡ç®—é‡ä¼šå‡å°‘

åˆ†å±‚ä¸èƒ½æ»¥ç”¨ï¼š

- åˆ†å±‚ä¼šå¢åŠ å†…å­˜æ¶ˆè€—ï¼Œè¿‡å¤šçš„åˆ†å±‚ä¼šå¯¼è‡´æµè§ˆå™¨éå†å’Œè®¡ç®—çš„è€—æ—¶å˜é•¿ã€‚æ‰€ä»¥åº”è¯¥é¿å…æ— æ„ä¹‰çš„åˆ†å±‚æˆ–è€…ä¸åˆç†çš„åˆ†å±‚


## 5. ç»˜åˆ¶æŒ‡ä»¤

è¿™ä¸€æ­¥æ˜¯æ¸²æŸ“ä¸»çº¿ç¨‹çš„æœ€åä¸€æ­¥æ“ä½œï¼Œ**ä»–é’ˆå¯¹æ¯ä¸€å±‚å…ƒç´ ï¼Œç”Ÿæˆå¯¹åº”çš„ç»˜åˆ¶æŒ‡ä»¤ï¼šæ¯”å¦‚å°†ç¬”ç§»åŠ¨åˆ° (x, y)ï¼Œç»˜åˆ¶å®½åº¦100pxçš„é»‘è‰²ç›´çº¿...**ï¼ˆç±»ä¼¼ canvasï¼‰ã€‚

ä»è¿™ä¸€æ­¥å¾€åï¼Œæ¸²æŸ“ä¸»çº¿ç¨‹çš„å·¥ä½œå°±å®Œæˆäº†ï¼Œæ¸²æŸ“ä¸»çº¿ç¨‹ä¼šå¸¦ç€æ‰€æœ‰ç”Ÿæˆçš„ç»˜åˆ¶æŒ‡ä»¤é›†ï¼Œå°†ä»»åŠ¡äº¤ç»™å…¶ä»–çº¿ç¨‹å®Œæˆã€‚

![æ— æ ‡é¢˜-2023-10-11-1617.png](/img/posts/2023-10-26/2023-10-26-14.png)


## 6. åˆ†å—ï¼ˆtilingï¼‰

åˆ°äº†è¿™ä¸€æ­¥ï¼Œæµè§ˆå™¨ä¼šå°†æ¯ä¸€å±‚ä¸Šçš„å…ƒç´ åˆ†æˆä¸åŒçš„å—ï¼Œç¡®å®šå„ä¸ªå—çš„ä¼˜å…ˆçº§ã€‚ä¸€èˆ¬é è¿‘è§†å£çš„å—ä¼˜å…ˆçº§ä¼šç›¸å¯¹è¾ƒé«˜ã€‚


![æ— æ ‡é¢˜-2023-10-11-1617.png](/img/posts/2023-10-26/2023-10-26-15.png)

åˆ†å—ä¸€èˆ¬æ˜¯äº¤ç»™åˆ†å—çº¿ç¨‹æ¥å®Œæˆçš„ï¼Œä»–ä¼šç»´æŠ¤å¾ˆå¤šä¸ªåˆæˆå™¨æ¥ç®¡ç†è¿™äº›å—çš„åˆå¹¶å’Œå±•å¼€ã€‚


## 7. å…‰æ …åŒ–ï¼ˆGPUè®¡ç®—ä¸ºä¸»ï¼‰

å…‰æ …åŒ–ï¼ˆRasterï¼‰æ˜¯å›¾åƒå¤„ç†çš„ä¸€ä¸ªæ¦‚å¿µï¼Œä»–å°†æŒ‰ç…§æ¯ä¸€ä¸ªå—çš„ä¼˜å…ˆçº§ï¼Œå°†å„ä¸ªå—å…ƒç´ è§£æä¸ºä½å›¾æ ¼å¼ã€‚å¦‚å›¾å±•ç¤ºäº†ä¸€ä¸ªåƒç´ ç‚¹åŠå…¶å‘¨è¾¹è¿é€šåŒºåŸŸåƒç´ ç‚¹çš„ç¤ºæ„å›¾ï¼š


![æ— æ ‡é¢˜-2023-10-11-1617.png](/img/posts/2023-10-26/2023-10-26-16.png)

æˆ‘ä»¬æ‰€è¯´çš„ GPUè®¡ç®—ä¸»è¦å°±æ˜¯åœ¨è¿™ä¸€ä¸ªç¯èŠ‚ï¼ŒGPU æ¯” CPU æ›´æ“…é•¿å…‰æ …åŒ–è®¡ç®—ï¼Œå…¶æœ¬è´¨æ˜¯çŸ©é˜µçš„è¿ç®—ã€‚åœ¨æµè§ˆå™¨ä¸­ï¼Œè¿™ä¸€è¿‡ç¨‹å°†åˆ†é…ç»™ GPU è¿›ç¨‹æ¥å¤„ç†ã€‚

## 8. æœ€ç»ˆç»˜åˆ¶ï¼ˆGPUè®¡ç®—ä¸ºä¸»ï¼‰

åˆæˆçº¿ç¨‹è´Ÿè´£è®¡ç®—å‡ºæ¯ä¸€ä¸ªä½å›¾åœ¨å±å¹•ä¸Šçš„ä½ç½®ï¼Œäº¤ç»™ GPU è¿›è¡Œæœ€ç»ˆå‘ˆç°ã€‚


è¿™é‡Œæ¥è§£é‡Šä¸€ä¸‹ï¼Œæ¸²æŸ“è¿›ç¨‹å®é™…ä¸Šæ˜¯åœ¨æ²™ç›’é‡Œè¾¹è¿è¡Œçš„ï¼Œå…¶æ²¡æœ‰æ“ä½œç¡¬ä»¶çš„èƒ½åŠ›ï¼Œæ‰€ä»¥è¿™é‡Œå¿…é¡»è¦äº¤ç»™ GPU è¿›ç¨‹è¿‡æ¸¡ã€‚

æ¯”è¾ƒç¥å¥‡çš„æ˜¯ï¼Œcss æ ·å¼ **transform** å¹¶ä¸æ˜¯åœ¨å…‰æ …åŒ–ä¸­ç”Ÿæˆåƒç´ ç‚¹ï¼Œè€Œæ˜¯åœ¨è¿™ä¸€æ­¥çœŸæ­£è¦ç”»çš„æ—¶å€™å†³å®šçš„ï¼Œå°±æ˜¯åœ¨ GPU åšä¸€ä¸ªçŸ©é˜µå˜æ¢ã€‚

æˆ‘ä»¬ä¸¾ä¸€ä¸ªçŸ©é˜µä¹˜æ³• åš **skewX** çš„ä¾‹å­ã€‚æˆ‘ä»¬å°† google é¦–é¡µçš„ logo æ¨ªå‘æ‰­æ›²ä¸€ä¸‹ï¼š


![image.png](/img/posts/2023-10-26/2023-10-26-17.png)


æˆ‘ä»¬ç”¨ä¸€ä¸ªç‚¹ P(x, y, 1) æ¥è¯´æ˜é—®é¢˜ï¼Œå°†å…¶è¡¨ç¤ºä¸ºé½æ¬¡åæ ‡å½¢å¼ [x, y, 1]ã€‚ï¼ˆæ¨¡å‹å‚è€ƒï¼š[skewX() - CSSï¼šå±‚å æ ·å¼è¡¨ | MDN (mozilla.org)](https://developer.mozilla.org/zh-CN/docs/Web/CSS/transform-function/skewX)ï¼‰

```
P = [x, y, 1] 
```

ä½¿ç”¨ä¹˜æ³•ç®—å­ T è¡¨ç¤ºè½¬æ¢çŸ©é˜µï¼š 

```
T = \begin{bmatrix}  
1 &  tan(25deg) & 0 \\  
0 & 1 & 0 \\  
0 & 0 & 1  \\  
\end{bmatrix}
```
![image.png](/img/posts/2023-10-26/1.png)


ç°åœ¨ï¼Œæˆ‘ä»¬è¦å°†è¿™ä¸ªç‚¹åº”ç”¨Â `transform: skewX(25deg)`Â å˜æ¢ã€‚

```
P' = T * P^{\text{T}} = [x', y', z']
```
![image.png](/img/posts/2023-10-26/2.png)

è®¡ç®—åå¾—ï¼š

```
x' = x + tan(25deg) * y  
```
```
y' = y  
```
```
z' = z = 1
```
![image.png](/img/posts/2023-10-26/3.png)


å¯ä»¥çœ‹åˆ°ï¼ŒskewX åï¼Œçºµåæ ‡æ²¡æœ‰å˜ï¼Œæ¨ªåæ ‡æ•´ä½“å‘å³ç§»åŠ¨äº† `tan(25deg) * y` çš„è·ç¦»ï¼Œæ ¹æ®ä¸‰è§’å‡½æ•°å…¬å¼å¯ä»¥çœ‹å‡ºï¼Œç¡®å®æ˜¯å‘å³å€¾æ–œäº† 25 åº¦ã€‚

> skewX å€¾æ–œæ˜¯æ ¹æ®å›¾å½¢çš„ä¸­å¿ƒç‚¹è¿›è¡Œçš„ï¼Œä¸‹åŠéƒ¨åˆ†å‘å³å¹³ç§»ï¼Œä¸ŠåŠéƒ¨åˆ†å‘å·¦å¹³ç§»ï¼›ä¸Šé¢çš„ä¾‹å­åªä¸¾ä¾‹äº†ä¸‹åŠéƒ¨åˆ†çš„æƒ…å†µã€‚

> åŒç±»å‹çš„æ“ä½œè¿˜æœ‰ ç¼©æ”¾(`scale`)ï¼Œæ—‹è½¬(`rotate`)ä»¥åŠä½ç§»(`translate`) ç­‰

--------------
å†æ¥çœ‹ä¸€ä¸‹å®Œæ•´çš„è¿‡ç¨‹ï¼Œå¸®åŠ©å›å¿†ï¼š


![æ— æ ‡é¢˜-2023-10-06-1925.png](/img/posts/2023-10-26/2023-10-26-18.png)

-----

## 9. Q & A

#### ä»€ä¹ˆæ˜¯ reflow ï¼Ÿ

å›æµçš„æœ¬è´¨æ˜¯é‡æ–°è®¡ç®—å¸ƒå±€æ ‘ã€‚æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å›æµçš„æ‰§è¡Œè¿‡ç¨‹ï¼š


![æ— æ ‡é¢˜-2023-10-11-1617.png](/img/posts/2023-10-26/2023-10-26-19.png)

å½“è¿›è¡Œäº†å½±å“å¸ƒå±€çš„æ“ä½œåï¼ˆcssomæ”¹å˜ï¼‰ï¼Œä¼šå¼•å‘ä¸€æ¬¡ layoutã€‚

æµè§ˆå™¨æœ‰è‡ªå·±çš„ä¼˜åŒ–ç­–ç•¥ï¼Œå¾€å¾€å°†å¤šæ¬¡å›æµåˆå¹¶æ‰§è¡Œï¼ˆæµè§ˆå™¨ä¼šåœ¨æ¶ˆæ¯é˜Ÿåˆ—åšä¼˜åŒ–ï¼‰ï¼Œæ¯”å¦‚åœ¨ js ä»£ç å…¨éƒ¨æ‰§è¡Œå®Œæ¯•åè¿›è¡Œç»Ÿä¸€æ‰§è¡Œï¼Œæ‰€ä»¥ reflow æ˜¯å¼‚æ­¥æ‰§è¡Œçš„ã€‚æ‰€ä»¥ï¼Œåœ¨æŸç§åœºæ™¯ä¸‹ï¼Œjs å¯èƒ½ä¸èƒ½å®æ—¶è·å–ï¼ˆåŒæ­¥è·å–ï¼‰æœ€æ–°çš„å¸ƒå±€ä¿¡æ¯ã€‚ï¼ˆå¯ä»¥é€šè¿‡ç›´æ¥åŒæ­¥è¯»å–å±æ€§æ¥å¼ºåˆ¶è§¦å‘å›æµï¼‰

> å¼€å‘è¿‡ç¨‹ä¸­ï¼Œä»£ç åº”è¯¥é¿å…é¢‘ç¹ä¿®æ”¹å¸ƒå±€æ ‘ï¼ˆheight/width/margin/padding...ï¼‰

#### ä»€ä¹ˆæ˜¯ repaint ï¼Ÿ

é‡ç»˜çš„æœ¬è´¨æ˜¯é‡æ–°æ ¹æ®åˆ†å±‚ä¿¡æ¯è®¡ç®—ç»˜åˆ¶çš„æŒ‡ä»¤ã€‚ä»–å¼€å§‹çš„èŠ‚ç‚¹ä¸€èˆ¬æ˜¯ paintï¼ŒæŸç§æƒ…å†µä¹Ÿä¼šå¼•èµ·åˆ†å±‚å˜åŒ–ã€‚

å›æµä¸€å®šä¼šå¼•èµ·é‡ç»˜ã€‚


![æ— æ ‡é¢˜-2023-10-11-1617.png](/img/posts/2023-10-26/2023-10-26-20.png)

#### ä¸ºä»€ä¹ˆ transform æ•ˆç‡é«˜ ï¼Ÿ

å› ä¸ºè®¡ç®— transform æ˜¯åœ¨æœ€åä¸€æ­¥ï¼ˆdrawï¼‰æ—¶ï¼Œé’ˆå¯¹æœ¬å±‚çº§çš„å…ƒç´ ï¼Œåœ¨ GPU ä¸­æ‰§è¡Œå˜æ¢çš„ï¼Œä¸ä¼šå¼•èµ·å›æµå’Œé‡ç»˜ã€‚


![æ— æ ‡é¢˜-2023-10-11-1617.png](/img/posts/2023-10-26/2023-10-26-21.png)

ä¸Šå›¾å¯ä»¥çœ‹åˆ°ï¼Œtransform ä¸åœ¨æ¸²æŸ“ä¸»çº¿ç¨‹ä¸­æ‰§è¡Œä»»åŠ¡ï¼Œæ‰€ä»¥ï¼Œå³ä½¿é¡µé¢ js è¿›å…¥äº†æ­»å¾ªç¯ï¼ŒåŠ¨ç”»ä¹Ÿå¯ä»¥æ­£ç¡®æ‰§è¡Œã€‚


## 10. é™„ï¼šrequestAnimationFrame ä¸ requestIdleCallback

#### æ¸²æŸ“ä»»åŠ¡å‡ºç°çš„æ—¶æœº

è§†å…·ä½“æƒ…å†µè€Œå®šï¼Œå¹¶ä¸æ˜¯æ¯ä¸€è½®æ¶ˆæ¯å¾ªç¯ç»“æŸæ—¶éƒ½ä¼šäº§ç”Ÿä¸€ä¸ª**æ¸²æŸ“ä»»åŠ¡**ã€‚è¿™è¦æ ¹æ®å±å¹•åˆ·æ–°ç‡ã€é¡µé¢æ€§èƒ½ã€é¡µé¢æ˜¯å¦åœ¨åå°è¿è¡Œç­‰æ¥å…±åŒå†³å®šï¼Œé€šå¸¸æ¥è¯´è¿™ä¸ªæ¸²æŸ“é—´éš”æ˜¯å›ºå®šçš„ã€‚é€šå¸¸å†³å®šæ¸²æŸ“æ—¶æœºçš„å› ç´ æœ‰å¦‚ä¸‹å‡ ç‚¹ï¼š

1. æ˜¾ç¤ºå™¨ä¸€èˆ¬å¸§ç‡ä¸º 60fpsï¼ˆæ¯ 16.66ms æ¸²æŸ“ä¸€æ¬¡ï¼‰ï¼Œå¦‚æœé¡µé¢æ€§èƒ½ç»´æŒä¸äº† 60fpsï¼Œæµè§ˆå™¨ä¼šé™åˆ° 30fps ä»¥ä¿è¯æ¸²æŸ“èƒ½å¤Ÿè¿›è¡Œä¸‹å»ã€‚
2. å¦‚æœæµè§ˆå™¨ä¸Šä¸‹æ–‡ä¸å¯è§ï¼Œé‚£ä¹ˆé¡µé¢ä¼šé™ä½åˆ° 4fps å·¦å³ç”šè‡³æ›´ä½ã€‚
3. å¦‚æœæµè§ˆå™¨åˆ¤å®šå½“å‰æ”¹åŠ¨ä¸ä¼šå¼•èµ·è§†è§‰å˜åŒ–æˆ–è€… **`requestAnimationFrame`** å›è°ƒä¸ºç©ºæ—¶ï¼Œåˆ™ä¼šè·³è¿‡æ¸²æŸ“ã€‚
4. åœ¨é¡µé¢ resizeã€é¡µé¢ scrollã€**`requestAnimationFrame`** è°ƒç”¨ã€IntersectionObserver è§¦å‘æ˜¾ç¤ºã€å…ƒç´ æ˜¾ç¤ºã€éšè—æˆ–ç»“æ„å˜åŒ–æ—¶ï¼Œä¸€èˆ¬åœ¨æ¸²æŸ“é—´éš”åˆ°æ¥æ—¶ä¼šæ¨é€ä¸€ä¸ªæ¸²æŸ“ä»»åŠ¡ã€‚

#### requestAnimationFrame

requestAnimationFrame çš„å›è°ƒæœ‰ä¸¤ä¸ªç‰¹ç‚¹ï¼š

1.  åœ¨é‡æ–°æ¸²æŸ“å‰è°ƒç”¨ã€‚
2.  å›è°ƒåˆå¹¶æ‰§è¡Œã€‚

ç¬¬ä¸€æ¡ï¼Œä¿è¯äº†åœ¨æ¸²æŸ“ä»»åŠ¡æ‰§è¡Œä¹‹å‰æ‰§è¡Œå®Œæƒ³è¦æ”¹å˜çš„å…ƒç´ ï¼Œä¿è¯äº†åŠ¨ç”»çš„æµç•…ï¼Œä¸ä¼šæ‹–å»¶åˆ°ä¸‹ä¸€å¸§å†æ¸²æŸ“ã€‚ç¬¬äºŒæ¡æˆ‘ä»¬å¯ä»¥çœ‹ä¸€æ®µä»£ç ï¼š

```js
// requestAnimationFrame åœ¨æ¸²æŸ“ä»»åŠ¡æ‰§è¡Œä¹‹å‰æ‰§è¡Œ
setTimeout(() => {
  console.log(1)
  requestAnimationFrame(() => console.log(2))
})
setTimeout(() => {
  console.log(3)
  requestAnimationFrame(() => console.log(4))
})

queueMicrotask(() => console.log(5))
queueMicrotask(() => console.log(6))

/** è¾“å‡º
5
6
1
3
2
4
*/
```

> queueMicrotask æ˜¯ web APIï¼Œç”¨äºåˆ›å»ºä¸€ä¸ªå¾®ä»»åŠ¡

#### requestIdleCallback

requestIdleCallback æ˜¯ç©ºé—²è°ƒåº¦ç®—æ³•ï¼ŒæŠŠä¸€äº›è®¡ç®—é‡è¾ƒå¤§ä½†æ˜¯åˆæ²¡é‚£ä¹ˆç´§æ€¥ï¼ˆä»»åŠ¡é˜Ÿåˆ—çš„ä¼˜å…ˆçº§å†³å®šï¼‰çš„ä»»åŠ¡æ”¾åˆ°ç©ºé—²æ—¶é—´å»æ‰§è¡Œã€‚ä¸è¦å»å½±å“æµè§ˆå™¨ä¸­ä¼˜å…ˆçº§è¾ƒé«˜çš„ä»»åŠ¡ï¼Œæ¯”å¦‚åŠ¨ç”»ç»˜åˆ¶ã€ç”¨æˆ·è¾“å…¥ã€å¾®ä»»åŠ¡ç­‰ç­‰ã€‚


```js
// å®šä¹‰ä½ çš„è®¡ç®—å¯†é›†å‹ä»»åŠ¡  
function computeIntensiveTask() {  
  // æ‰§è¡Œä¸€äº›å¤æ‚çš„è®¡ç®—...  
}  
  
// ä½¿ç”¨ requestIdleCallback åœ¨ç©ºé—²æ—¶æ‰§è¡Œä»»åŠ¡  
requestIdleCallback(function() {  
  computeIntensiveTask();  
}, {  
  timeout: 1000, // è®¾ç½®è¶…æ—¶æ—¶é—´ï¼Œå¦‚æœåœ¨è¿™æ®µæ—¶é—´å†…æ²¡æœ‰ç©ºé—²æ—¶é—´ï¼Œå›è°ƒå‡½æ•°å°†è¢«å–æ¶ˆ  
  dependencies: [] // å¯ä»¥è®¾ç½®ä¾èµ–é¡¹ï¼Œå½“æ‰€æœ‰ä¾èµ–é¡¹éƒ½å®Œæˆæ—¶ï¼Œæ‰ä¼šæ‰§è¡Œå›è°ƒå‡½æ•°  
});
```

ä½†æ˜¯ï¼Œå…¶å…¼å®¹æ€§è¿˜ä¸å¥½ï¼Œå¯¼è‡´ React çš„ fiber ä¸å¾—ä¸è‡ªå·±å®ç°äº†ä¸€å¥—è¿™ä¸ª APIã€‚


![image.png](/img/posts/2023-10-26/2023-10-26-22.png)


## 11. æ€»ç»“

#### æµè§ˆå™¨æ˜¯å¦‚ä½•æ¸²æŸ“é¡µé¢çš„ï¼Ÿ

1. æ¥å— HTMLï¼Œäº§ç”Ÿæ¸²æŸ“ä»»åŠ¡ï¼Œäº¤ç»™æ¸²æŸ“ä¸»çº¿ç¨‹çš„æ¶ˆæ¯é˜Ÿåˆ—
2. åœ¨æ¶ˆæ¯å¾ªç¯æœºåˆ¶ä¸‹ï¼Œæ¸²æŸ“ä¸»çº¿ç¨‹ä¾æ¬¡å–å‡ºä»»åŠ¡å¹¶å¼€å§‹æ¸²æŸ“
3. æ¸²æŸ“ä»»åŠ¡åˆ†ä¸ºå¤šä¸ªé˜¶æ®µä¸²è¡Œæµæ°´æ‰§è¡Œ:

```js
1. htmlè§£æ
2. æ ·å¼è®¡ç®—
3. å¸ƒå±€
4. åˆ†å±‚
5. ç»˜åˆ¶æŒ‡ä»¤
6. åˆ†å—
7. å…‰æ …åŒ–
8. ç”»å‡ºåƒç´ ç‚¹ã€‚
```15:T2812,äº‹ä»¶å¾ªç¯ ï¼ˆEvent loopï¼Œåˆå«æ¶ˆæ¯å¾ªç¯ Message loopï¼‰æ˜¯æµè§ˆå™¨çš„æ ¸å¿ƒæ¦‚å¿µä¹‹ä¸€ï¼Œæ˜¯å‰ç«¯å­¦ä¹ å’ŒæŠ€æœ¯æå‡ç»•ä¸è¿‡å»çš„çŸ¥è¯†ã€‚æœ¬æ–‡é€šè¿‡å›¾è§£çš„æ–¹å¼ï¼Œè®²è¿°ä¸€ä¸‹ç°ä»£æµè§ˆå™¨äº‹ä»¶å¾ªç¯çš„è¿è¡ŒåŸç†ã€‚

## 1. æµè§ˆå™¨çš„è¿›ç¨‹ä¸çº¿ç¨‹

è¿›ç¨‹æ˜¯è®¡ç®—æœºæ“ä½œç³»ç»Ÿèµ„æºåˆ†é…çš„æœ€å°å•ä½ã€‚ç°ä»£æµè§ˆå™¨ï¼Œä»¥ chrome ä¸ºä¾‹ï¼Œå¹¿æ³›é‡‡ç”¨çš„æ˜¯å¤šè¿›ç¨‹æ¶æ„ã€‚ä¸ºäº†å‡å°‘è¿ç¯å´©æºƒçš„å‡ ç‡ï¼Œå¯åŠ¨æµè§ˆå™¨åï¼Œä¼šå°†å„ä¸ªä»»åŠ¡æ‹†åˆ†ä¸ºå¤šä¸ªè¿›ç¨‹ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š


![è¿›ç¨‹.png](/img/posts/2023-10-12/2023-10-12-1.png)

chrome å°†æµè§ˆå™¨ä»»åŠ¡æ‹†åˆ†ä¸ºå¤šä¸ªè¿›ç¨‹ï¼š

- æµè§ˆå™¨è¿›ç¨‹ï¼ˆBrowser processï¼‰ï¼šæˆ‘è´Ÿè´£ç•Œé¢æ˜¾ç¤ºã€ç”¨æˆ·äº¤äº’ã€å­è¿›ç¨‹ç®¡ç†ç­‰ä¸šåŠ¡ã€‚
- ç½‘ç»œè¿›ç¨‹ï¼ˆNetwork processï¼‰ï¼šæˆ‘è´Ÿè´£åŠ è½½ç½‘ç»œèµ„æºä¸šåŠ¡ã€‚
- æ¸²æŸ“è¿›ç¨‹ï¼ˆRendering processï¼‰ï¼šæˆ‘æ˜¯æ¸²æŸ“çš„ä¸»è§’ï¼Œè´Ÿè´£æ‰§è¡Œ HTMLã€cssã€js ä»£ç ã€‚é»˜è®¤æƒ…å†µï¼Œæµè§ˆå™¨ä¼šä¸ºæ¯ä¸€ä¸ª tab é¡µç­¾å¼€å¯ä¸€ä¸ªæ¸²æŸ“è¿›ç¨‹ï¼Œä»¥ç¡®ä¿ç›¸äº’ä¸å½±å“ã€‚
- ...

> é¢‘ç¹å¼€å¯è¿›ç¨‹ä¼šé€ æˆå†…å­˜å ç”¨è¿‡å¤šçš„æƒ…å†µï¼Œchrome åç»­ä¼šè¿›è¡Œæ”¹è¿›ï¼Œè€ƒè™‘ç›¸åŒç«™ç‚¹ï¼ˆç›¸åŒé¡¶çº§åŸŸåå’ŒäºŒçº§åŸŸåï¼‰å…±ç”¨ä¸€ä¸ªæ¸²æŸ“è¿›ç¨‹ã€‚

![æ— æ ‡é¢˜-2023-10-06-19251.png](/img/posts/2023-10-12/2023-10-12-2.png)


æ¸²æŸ“è¿›ç¨‹ä¼šå¼€å¯ä¸€ä¸ªæ¸²æŸ“ä¸»çº¿ç¨‹ï¼Œç”¨äºæ— é˜»å¡æ¸²æŸ“ä»»åŠ¡ã€‚å…¶ä½™çº¿ç¨‹ååŠ©ä¸»çº¿ç¨‹å®Œæˆä»»åŠ¡ã€‚

**æ¸²æŸ“ä¸»çº¿ç¨‹ï¼ˆMain threadï¼‰** è´Ÿè´£æ‰§è¡Œä»£ç ã€æ ·å¼ä¸å¸ƒå±€ï¼ˆé€šè¿‡ä¼˜å…ˆçº§ã€ç™¾åˆ†æ¯”æ¢ç®—ã€å®½é«˜ç­‰å‡ ä½•ä¿¡æ¯é«˜åŠ¨æ€è®¡ç®—ã€ç›¸å¯¹ä½ç½®ç­‰è®¡ç®—æœ€ç»ˆæ ·å¼è¡¨ï¼‰ã€å¤„ç†å›¾å±‚ã€æ§åˆ¶60å¸§åˆ·æ–°ã€æ‰§è¡Œå„ç§å›è°ƒå‡½æ•°ç­‰ï¼Œæ˜¯æœ€å¿™çš„ä¸€ä¸ªï¼Œä¸€åˆ»ä¹Ÿæ²¡æœ‰åœæ­‡ã€‚


![æ— æ ‡é¢˜-2023-10-06-19252.png](/img/posts/2023-10-12/2023-10-12-3.png)

æ­¤æ—¶å°±æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œä¸»æ¸²æŸ“ä»»åŠ¡éƒ½äº¤ç»™ä¸€ä¸ªçº¿ç¨‹ï¼Œæ•ˆç‡ä¼šé«˜å—ï¼Ÿä¸ºä»€ä¹ˆä¸å¤šçº¿ç¨‹ä¸€èµ·æ¸²æŸ“ï¼Ÿ

è¿™æ˜¯å› ä¸ºæµè§ˆå™¨æ¸²æŸ“å’Œ JavaScript æ‰§è¡Œå…±ç”¨ä¸€ä¸ªçº¿ç¨‹ï¼Œè€Œé»˜è®¤æƒ…å†µä¸‹ï¼Œ JavaScript æ‰§è¡Œåˆä¼šå½±å“ CSSOM/DOM æ ‘çš„æ¸²æŸ“å’Œç»“æ„ï¼Œæ‰€ä»¥å¿…é¡»é˜»å¡æ¸²æŸ“ï¼Œä»–ä»¬ä¹Ÿå¿…é¡»æ˜¯å•çº¿ç¨‹æ“ä½œã€‚åœ¨æ„å»º DOM æ—¶ï¼ŒHTML è§£æå™¨è‹¥é‡åˆ°äº† JavaScriptï¼Œå®ƒä¼šæš‚åœæ„å»ºDOMï¼Œå°†æ§åˆ¶æƒç§»äº¤ç»™ JavaScript å¼•æ“ï¼Œç­‰ JavaScript å¼•æ“è¿è¡Œå®Œæ¯•ï¼Œæµè§ˆå™¨å†ä»ä¸­æ–­çš„åœ°æ–¹æ¢å¤ DOM æ„å»ºã€‚å¦‚æœä½¿ç”¨å¤šçº¿ç¨‹å¤„ç†å¯èƒ½ä¼šå¯¼è‡´æ¸²æŸ“DOMçš„å†²çªï¼Œå¤æ‚åº¦ä¼šå¤§å¹…åº¦æå‡ï¼š


![æ— æ ‡é¢˜-2023-10-06-19254.png](/img/posts/2023-10-12/2023-10-12-4.png)

## 2. æ¶ˆæ¯å¾ªç¯

ä¸Šé¢ä½¿ç”¨å•çº¿ç¨‹ï¼Œä½¿å¾—åœ¨ç¼–å†™ä»£ç æ—¶æ— éœ€è€ƒè™‘å¤æ‚çš„çº¿ç¨‹åŒæ­¥å’Œäº’æ–¥é—®é¢˜ï¼Œä»è€Œé™ä½äº†å¼€å‘çš„å¤æ‚æ€§ï¼Œä½†æ˜¯ç»ˆå½’æ•ˆç‡æ˜¯ä¸Šä¸å»çš„ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œè¿™é‡Œå·§å¦™åœ°å¼•å…¥äº†æ¶ˆæ¯å¾ªç¯æ¥ç»Ÿä¸€è§£å†³è¿™ä¸ªé—®é¢˜ã€‚

**æ ¸å¿ƒæ€æƒ³**ï¼šæ¸²æŸ“ä¸»çº¿ç¨‹æ°¸ä¹…è½®è¯¢æ‰§è¡Œä»»åŠ¡ï¼›å•ç‹¬å¼€è¾Ÿä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ï¼ˆMessage queueï¼‰ç©ºé—´ç”¨äºå­˜æ”¾å„ä¸ªçº¿ç¨‹åŠ å…¥çš„ä»»åŠ¡ï¼›æ¸²æŸ“ä¸»çº¿ç¨‹åªæ˜¯ç®€å•çš„æ‹¿å–ä»»åŠ¡æ‰§è¡Œï¼Œè€Œä¸ç”¨æ“å¿ƒè¿™ä¸ªä»»åŠ¡æ˜¯è°é€è¿‡æ¥çš„ã€‚åœ¨ Chrome çš„æºç ä¸­ï¼Œä½¿ç”¨çš„æ˜¯ä¸€ä¸ªæ­»å¾ªç¯æ¥å®Œæˆçš„ï¼š

```cpp
for(;;) {}
```

> æ¶ˆæ¯é˜Ÿåˆ—çš„æ— é™è½®è¯¢å°±å«æ¶ˆæ¯å¾ªç¯ï¼Œæ¶ˆæ¯å¾ªç¯å°±å‘ç”Ÿåœ¨æ¸²æŸ“ä¸»çº¿ç¨‹é‡Œ

![æ— æ ‡é¢˜-2023-09-15-1456.png](/img/posts/2023-10-12/2023-10-12-5.png)

1. æœ€å¼€å§‹ï¼Œæ¸²æŸ“ä¸»çº¿ç¨‹å¼€å§‹è½®è¯¢
2. æ¯ä¸€æ¬¡å‘¢å¾ªç¯æ£€æŸ¥æ¶ˆæ¯é˜Ÿåˆ—æ˜¯å¦æœ‰ä»»åŠ¡ï¼Œæœ‰åˆ™å–å‡ºç¬¬ä¸€ä¸ªä»»åŠ¡æ‰§è¡Œã€‚
3. å…¶ä»–æ‰€æœ‰çº¿ç¨‹éƒ½å¯ä»¥è¿½åŠ ä»»åŠ¡è¿›æ¶ˆæ¯é˜Ÿåˆ—çš„æœ«å°¾ã€‚

### å¼‚æ­¥

åœ¨æ¶ˆæ¯å¾ªç¯ä¸­ï¼Œè‚¯å®šä¼šå­˜åœ¨ä¸€äº›éœ€è¦å»¶æ—¶æ‰§è¡Œçš„ä»£ç ï¼Œjsåœ¨æ‰§è¡Œåˆ°ä»–ä»¬æ—¶ä¸ä¼šç«‹å³è§¦å‘å›è°ƒï¼Œè€Œæ˜¯éœ€è¦æŸç§è®¡æ—¶æœºåˆ¶æˆ–è€…è§¦å‘æœºåˆ¶æ¥å®šæ—¶è§¦å‘ï¼Œä»–ä»¬ä¸€èˆ¬æ˜¯é€šè¿‡å›è°ƒå‡½æ•°æ¥è¿”å›æ‰§è¡Œçš„ç»“æœï¼Œå¤§è‡´åˆ†ç±»å¦‚ä¸‹ï¼š

1. å‰ç«¯APIè®¡æ—¶å™¨ï¼šsetTimeoutã€setInterval
2. å‰ç«¯å¼‚æ­¥ APIï¼šPromiseç­‰
3. ç½‘ç»œé€šä¿¡ï¼šXHRã€fetchç­‰
4. ç”¨æˆ·äº¤äº’å›è°ƒï¼šaddEventListener

> å¼‚æ­¥ä¸åŒæ­¥æœ€å¤§çš„ä¸åŒæ˜¯ï¼Œå¼‚æ­¥å›è°ƒè§¦å‘å‰çš„å»¶æ—¶å¯¹ç”¨æˆ·æ˜¯æ²¡æœ‰å¿…è¦çš„ã€‚è®¾è®¡æµè§ˆå™¨æ—¶ï¼Œå¼‚æ­¥è§¦å‘å‰çš„é‚£æ®µå»¶æ—¶åº”è¯¥å¦å¤–å¼€è¾Ÿçº¿ç¨‹ï¼ˆæ¯”å¦‚è®¡æ—¶çº¿ç¨‹ï¼‰å•ç‹¬è®¡æ•°ï¼Œè€Œä¸é˜»å¡æ¸²æŸ“ä¸»çº¿ç¨‹

å¼‚æ­¥çš„æ¸²æŸ“è¿‡ç¨‹å¦‚ä¸‹ï¼š


![æ— æ ‡é¢˜-2023-09-15-1456.png](/img/posts/2023-10-12/2023-10-12-6.png)

å¯ä»¥çœ‹åˆ°ï¼Œå¼‚æ­¥ä»»åŠ¡åœ¨æ‰§è¡Œå®Œæ¯•åè¿›å…¥æ¶ˆæ¯é˜Ÿåˆ—æœ«å°¾æ’é˜Ÿå³å¯ï¼ä¸»çº¿ç¨‹åªç®¡æ‹¿æ¶ˆæ¯ä»»åŠ¡ï¼Œè€Œä¸ç”¨ç®¡è®¡æ—¶ä»»åŠ¡æ˜¯å¦å®Œæˆã€‚

> è®¡æ—¶çº¿ç¨‹å…¶å®ä½¿ç”¨çš„æ˜¯æ“ä½œç³»ç»Ÿåº•å±‚çš„é€»è¾‘ï¼Œè¿™é‡Œä¸åšæ·±ç©¶ã€‚


#### å¼‚æ­¥æ¡ˆä¾‹

çœ‹ä¸‹é¢çš„ä»£ç ï¼š

```js
function delay(duration) { /* æ­»å¾ªç¯ duration ç§’ */ }

const btn = document.querySelector('button');
const h1 = document.querySelector('h1');

btn.onclick = function() {
    h1.textContent = 'hello message queue !'
    delay(3000)
}
```
ä»–æ‰§è¡Œåä¼šæœ‰ä»€ä¹ˆè¡¨ç°ï¼Ÿæ˜¯é¡µé¢æ ‡é¢˜å˜ä¸º 'hello message queue !' åå‡æ­»3ç§’é’Ÿå—ï¼Ÿæˆ‘ä»¬ç”¨å›¾è§£æ¥åˆ†æä¸€ä¸‹ï¼š


![æ— æ ‡é¢˜-2023-09-15-1456.png](/img/posts/2023-10-12/2023-10-12-7.png)

æˆ‘ä»¬æ¥çœ‹å›¾è¯´è¯ï¼š

1. ç”¨æˆ·ç‚¹å‡»ï¼Œç‚¹å‡»çš„å›è°ƒè¿›å…¥æ¶ˆæ¯é˜Ÿåˆ—
2. è¿™ä¸ªå›è°ƒäº‹ä»¶åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼ŒåŒæ­¥ä»£ç  `h1.textContent = 'hello message queue !'` ç«‹å³æ‰§è¡Œï¼Œå»¶æ—¶ä»£ç å¼€å§‹æ‰§è¡Œè¿›å…¥æ­»å¾ªç¯
3. æœ€åå…¥é˜Ÿä¸€ä¸ªç»˜åˆ¶ä»»åŠ¡ï¼Œåœ¨å…¶ä»–ä»£ç æ‰§è¡Œå®Œæ¯•åå¼€å§‹ç»˜åˆ¶

æ˜¯ä¸æ˜¯çœ‹å‡ºé—®é¢˜æ¥å•¦ï¼Ÿæµè§ˆå™¨å®é™…æ•ˆæœæ˜¯å…ˆå‡æ­»3ç§’é’Ÿå†æ”¹å˜æ ‡é¢˜æ–‡å­—ï¼

> ç»˜åˆ¶ä»»åŠ¡ä¾§é‡äºæ¸²æŸ“åŸç†ï¼Œä¸æ˜¯æœ¬æ–‡é‡ç‚¹ï¼Œä¸åšèµ˜è¿°ã€‚ä»–å‡ºç°åœ¨å¾ªç¯çš„æ¯ä¸€æ¬¡è¿­ä»£ä¹‹åã€‚åœ¨æ¯ä¸€ä¸ªäº‹ä»¶å¾ªç¯çš„è¿­ä»£ä¸­ï¼Œæµè§ˆå™¨ä¼šå…ˆå¤„ç†æ‰€æœ‰çš„åŒæ­¥ä»»åŠ¡ï¼ˆä¾‹å¦‚ï¼šè§£æHTMLï¼Œå¤„ç†DOMæ“ä½œç­‰ï¼‰ï¼Œç„¶åå¤„ç†å¼‚æ­¥ä»»åŠ¡ï¼ˆä¾‹å¦‚ï¼šç½‘ç»œè¯·æ±‚ï¼Œå®šæ—¶å™¨å›è°ƒç­‰ï¼‰ã€‚åœ¨è¿™ä¸ªå¼‚æ­¥ä»»åŠ¡å®Œæˆåï¼Œæµè§ˆå™¨ä¼šè¿›å…¥ä¸‹ä¸€ä¸ªäº‹ä»¶å¾ªç¯è¿­ä»£ã€‚

#### ç†è§£å¼‚æ­¥

å…³äºå¼‚æ­¥ï¼Œæˆ‘ä»¬æ˜¯æ€ä¹ˆç†è§£çš„å‘¢ï¼Ÿ

ä¸€èˆ¬æ¥è¯´ï¼Œå•çº¿ç¨‹è¯­è¨€æ˜¯æ²¡æœ‰ä¸¥æ ¼æ„ä¹‰çš„å¼‚æ­¥çš„ï¼Œä»£ç æ˜¯ä»ä¸Šè‡³ä¸‹ä¾æ¬¡æ‰§è¡Œçš„ã€‚ä¸Šé¢è®²çš„å¼‚æ­¥ï¼Œæ˜¯åœ¨æµè§ˆå™¨ç»´åº¦æ¥è®²çš„ï¼Œjsæ²¡æœ‰å¤šçº¿ç¨‹ï¼Œä½†æ˜¯æµè§ˆå™¨å¯ä»¥å¼€è¾Ÿå¤šä¸ªçº¿ç¨‹æ¥ç»´æŠ¤å¼‚æ­¥çš„ä»»åŠ¡ã€‚

æ¸²æŸ“ä¸»çº¿ç¨‹æ‰§è¡Œ js ä»»åŠ¡ï¼ˆjsçº¿ç¨‹é˜»å¡æ‰§è¡Œï¼‰ï¼Œä¸»çº¿ç¨‹æœ‰æ‰¿æ‹…æ¸²æŸ“çš„å…¶ä»–ä»»åŠ¡ï¼Œå¦‚æœéƒ½åŒæ­¥æ‰§è¡Œï¼Œä¸»çº¿ç¨‹å°±ä¼šç™½ç™½æ¶ˆè€—æ—¶é—´ï¼Œé¡µé¢ç»å¸¸æ€§å‡æ­»ã€‚

é‡‡ç”¨æ¶ˆæ¯å¾ªç¯+å¼‚æ­¥æ—¶ï¼Œåœ¨å¼‚æ­¥ä»»åŠ¡å‘ç”Ÿæ—¶ï¼Œä¸»çº¿ç¨‹å°†è¿™ä¸ªä»»åŠ¡äº¤ç»™å…¶ä»–çº¿ç¨‹æ¥æ‰§è¡Œï¼Œè·³è¿‡è¿™ä¸ªä»»åŠ¡å¾€åæ‰§è¡Œï¼›å…¶ä»–çº¿ç¨‹æ‰§è¡Œå®Œæ¯•åå°†å›è°ƒåŒ…è£…æˆä»»åŠ¡æ”¾å…¥æ¶ˆæ¯é˜Ÿåˆ—æœ«å°¾ï¼Œç­‰å¾…ä¸»çº¿ç¨‹è°ƒç”¨ã€‚

è¿™å°±ä¿è¯äº†å•çº¿ç¨‹æ¸²æŸ“æ—¶ï¼Œæ°¸ä¸é˜»å¡æ¸²æŸ“ã€‚æœ€å¤§é™åº¦ä¿è¯ä¸»çº¿ç¨‹æµç•…ã€‚


### ä¼˜å…ˆçº§

ä»»åŠ¡æœ¬èº«æ²¡æœ‰ä¼˜å…ˆçº§ï¼Œæ¸²æŸ“ä¸»çº¿ç¨‹ä¾æ¬¡ä»å¯¹å¤´æ‹¿å–ä»»åŠ¡æ‰§è¡Œã€‚æœ‰ä¼˜å…ˆçº§çš„æ˜¯æ¶ˆæ¯é˜Ÿåˆ—ã€‚

åœ¨æœ€æ–°ç‰ˆçš„ chrome ä¸­ï¼Œæ¶ˆæ¯é˜Ÿåˆ—å…¶å®ä¸æ˜¯ä¸€ä¸ªé˜Ÿåˆ—ï¼Œè€Œæ˜¯å¤šä¸ªï¼Œä»–ä»¬æœ‰ä¼˜å…ˆçº§ï¼Œè¿™ä¸ªä¼˜å…ˆçº§å†³å®šäº†è°å…ˆè¿›å…¥æ¸²æŸ“ä¸»çº¿ç¨‹è¢«æ‰§è¡Œï¼š

- å»¶æ—¶é˜Ÿåˆ—ï¼ˆDelay queueï¼‰ï¼šè®¡æ—¶å™¨å›è°ƒä»»åŠ¡é˜Ÿåˆ—ï¼Œä¼˜å…ˆçº§ã€ä¸­ã€‘
- äº¤äº’é˜Ÿåˆ—ï¼ˆInteractive queueï¼‰ï¼šç”¨æˆ·äº¤äº’åå›è°ƒäº‹ä»¶é˜Ÿåˆ—ï¼Œä¼˜å…ˆçº§ã€é«˜ã€‘
- å¾®ä»»åŠ¡é˜Ÿåˆ—ï¼ˆMicro queueï¼‰ï¼šç”¨æˆ·æ•°æ®æœ€å¿«æ‰§è¡Œé˜Ÿåˆ—ï¼Œä¾‹å¦‚ Promiseã€MutationObserver ç­‰ï¼Œå…¶ä¼˜å…ˆçº§ã€æœ€é«˜ã€‘
- ...


> æ ¹æ® W3C æœ€æ–°æ ‡å‡†ï¼Œç°ä»£æµè§ˆå™¨å°†å®ä»»åŠ¡é˜Ÿåˆ—çš„æ¦‚å¿µè¿›ä¸€æ­¥åšäº†ç»†åˆ†ã€‚åŸæ¥çš„å®ä»»åŠ¡ä¸»è¦åŒ…å«ï¼š`script(æ•´ä½“ä»£ç )ã€setTimeoutã€setIntervalã€I/Oã€UIäº¤äº’äº‹ä»¶ã€postMessageã€MessageChannelã€setImmediate(Node.js ç¯å¢ƒ)`ç­‰ã€‚

#### ä¼˜å…ˆçº§æ¡ˆä¾‹

æˆ‘ä»¬ç”¨ä¸€ä¸ªä¾‹å­æ¥è§£é‡Šï¼š

```js
setTimeout(function() {
  console.log(1);
}, 0);

console.log(2);

Promise.resolve().then(function() {
  console.log(3);
});

console.log(4);
```

æˆ‘ä»¬å°†ä»£ç æ‹†åˆ†å‡ å—æ¥åˆ†æï¼š


![æ— æ ‡é¢˜-2023-10-11-1617.png](/img/posts/2023-10-12/2023-10-12-8.png)

js ä»£ç æ˜¯åŒæ­¥æ‰§è¡Œçš„ï¼Œæ‰€ä»¥è¿™ 4 å—ä¼šè¢« js æ‰§è¡Œå¼•æ“å¿«é€Ÿæ‰«æåˆ°å¹¶åŠ å…¥å“åº”çš„é˜Ÿåˆ—é‡Œï¼š


![æ— æ ‡é¢˜-2023-10-11-1617.png](/img/posts/2023-10-12/2023-10-12-9.png)

ç„¶åæ¸²æŸ“ä¸»çº¿ç¨‹ä¼šæŒ‰ç…§é˜Ÿåˆ—çš„ä¼˜å…ˆçº§æ‹¿å–ä»»åŠ¡ï¼Œç”±äº 2 å’Œ 4 å·ä»»åŠ¡æ˜¯åŒæ­¥ä»£ç ï¼Œç›´æ¥å…¥æ¸²æŸ“ä¸»çº¿ç¨‹ï¼Œå¯ç›´æ¥æ‰§è¡Œï¼Œæ‰“å° 2 å’Œ 4ï¼›æ¥ä¸‹æ¥æ‹¿å–ä¼˜å…ˆçº§æœ€é«˜çš„å¾®å¯¹åˆ—çš„ä»»åŠ¡ 3 å¹¶æ‰§è¡Œï¼Œè¾“å‡º 3ï¼Œæ¥ä¸‹æ¥æ‹¿äº¤äº’é˜Ÿåˆ—ï¼Œæ²¡æœ‰ä»»åŠ¡ï¼›æœ€åè·å–å»¶æ—¶é˜Ÿåˆ—çš„ä»»åŠ¡ï¼Œå¹¶ä¾æ¬¡æ‰§è¡Œã€‚

æ³¨æ„ï¼Œè¿™é‡Œ 1 å·å»¶æ—¶ä»»åŠ¡æ‰§è¡Œæ—¶ï¼Œä¼šå¼€è¾Ÿè®¡æ—¶çº¿ç¨‹æ¥è®¡æ•°ï¼Œè®¡æ•°å®Œæˆåï¼Œå°†é‡Œè¾¹çš„åŒæ­¥ä»£ç  `console.log(1);` åŠ å…¥åŒæ­¥çš„æ¶ˆæ¯é˜Ÿåˆ— (è¿™é‡Œå°±æ˜¯ç›´æ¥åŠ å…¥æ¸²æŸ“ä¸»çº¿ç¨‹ï¼‰åŒæ­¥æ‰§è¡Œï¼Œå°±å¯ä»¥è¾“å‡º 1 äº†ã€‚æ‰€ä»¥è¾“å‡ºç»“æœæ˜¯ï¼š`2 4 3 1`

----

## 3. æ€»ç»“

**æ¦‚å¿µä¸€**ï¼šæ¶ˆæ¯å¾ªç¯åˆå«äº‹ä»¶å¾ªç¯ï¼Œæ˜¯æµè§ˆå™¨å¤„ç†å¼‚æ­¥çš„ä¸€ç§è°ƒåº¦ç­–ç•¥ã€‚

**æ¦‚å¿µäºŒ**ï¼šæ¸²æŸ“ä¸»çº¿ç¨‹ä¼šåå¤è½®è¯¢ï¼ˆforå¾ªç¯ï¼‰ï¼Œä¸æ–­æ‹¿å–æ¶ˆæ¯é˜Ÿåˆ—çš„ä»»åŠ¡æ¥æ‰§è¡Œï¼›å…¶ä»–çº¿ç¨‹è·å–åˆ°ä»»åŠ¡åï¼Œåœ¨åˆé€‚çš„æ—¶æœºå°†å…¶è¿½åŠ åœ¨æ¶ˆæ¯é˜Ÿåˆ—æœ«å°¾ã€‚

**æ¦‚å¿µä¸‰**ï¼šä»»åŠ¡é˜Ÿåˆ—åˆ†ä¸º å»¶æ—¶é˜Ÿåˆ—ã€äº¤äº’é˜Ÿåˆ—ã€å¾®ä»»åŠ¡é˜Ÿåˆ—ï¼›ä¸åŒä»»åŠ¡é˜Ÿåˆ—æœ‰ä¸åŒçš„ä¼˜å…ˆçº§ã€‚

### Q&A

#### å»¶æ—¶é˜Ÿåˆ—æ˜¯æ€ä¹ˆè®¡æ—¶çš„ï¼Ÿæ—¶é—´ç²¾ç¡®å—ï¼Ÿ

å»¶æ—¶é˜Ÿåˆ—è°ƒç”¨çš„æ˜¯æ“ä½œç³»ç»Ÿçš„åŠŸèƒ½ï¼Œè€Œè®¡ç®—æœºç¡¬ä»¶å¹¶æ²¡æœ‰ç±»ä¼¼åŸå­é’Ÿçš„è®¾å¤‡ï¼ˆä½¿ç”¨çš„æ˜¯CPUå¯„å­˜å™¨è®¡æ—¶ï¼‰ï¼Œæ²¡æœ‰åŠæ³•åšåˆ°ç™¾åˆ†ç™¾ç²¾å‡†ã€‚

æŒ‰ç…§ W3C æ ‡å‡†ï¼Œæµè§ˆå™¨å®ç°è®¡æ—¶å™¨æ—¶ï¼Œå¦‚æœåµŒå¥—å±‚çº§è¶…è¿‡ 5 å±‚ï¼Œåˆ™ä¼šå¸¦æœ‰ 4 æ¯«ç§’çš„æœ€å°é—´éš”æ—¶é—´ï¼Œè¿™åˆè¿›ä¸€æ­¥åŠ å¤§äº†å»¶æ—¶çš„è¯¯å·®ã€‚è€Œä¸”è®¡æ—¶å™¨å›è°ƒä¹Ÿåªä¼šåœ¨æ¸²æŸ“ä¸»çº¿ç¨‹ç©ºé—²æ—¶æ‰§è¡Œï¼Œå¦‚æœå»¶æ—¶ä»»åŠ¡ä¹‹å‰æœ‰ä¸€ä¸ªå¾ˆé•¿çš„ js åŒæ­¥é˜»å¡ï¼Œä¹Ÿä¼šé€ æˆå®šæ—¶ä¸å‡†ç¡®ã€‚


Chrome å…³äºæœ€å°å»¶æ—¶çš„æºç ï¼š

![image.png](/img/posts/2023-10-12/2023-10-12-10.png)



----

## 4. ç»ƒä¸€ç»ƒ

ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—çš„ç†å¿µï¼Œå£ç®—ä¸€ä¸‹è¾“å‡ºæ˜¯ä»€ä¹ˆå§ï¼


```js
function test() {
  console.log(1);
  Promise.resolve().then(function() {
    console.log(2);  
  });
}

setTimeout(function() {
  console.log(3);
  Promise.resolve().then(test);
});

Promise.resolve().then(function() {
  console.log(4);
  setTimeout(() => {
    console.log(5);
  });
});

console.log(6);
```16:T12d6,æœ¬æœŸæ¥è®²è§£ä¸€ä¸‹ react-dom åº“ä¸­ç”¨äºå®¢æˆ·ç«¯æ¸²æŸ“çš„ API ä»¬ã€‚

## 1. çº¯å®¢æˆ·ç«¯æ¸²æŸ“ createRoot

createRoot ç”¨äºå®¢æˆ·ç«¯åˆ›å»º React æ¸²æŸ“çš„æ ¹èŠ‚ç‚¹ã€‚ï¼ˆæœåŠ¡ç«¯æ¸²æŸ“æ— æ•ˆï¼‰

è¿™é‡Œä¸»è¦ä»‹ç»ä½¿ç”¨æ–¹å¼ã€‚

### ä½¿ç”¨æ–¹å¼ 

1. åˆå§‹åŒ–ä¸€ä¸ª React é¡¹ç›®

```js
import { createRoot } from 'react-dom/client';
import App from './App.js';
import './styles.css';

const root = createRoot(document.getElementById('root'));
root.render(<App />);
```

ä¸Šé¢çš„äººä»£ç ï¼ŒcreateRoot è·å–ä¸€ä¸ªçœŸå®çš„ DOM å…ƒç´ å¯¹è±¡æœ¬èº«ä½œä¸ºå…¥å‚ï¼Œè¿”å› React æ¸²æŸ“æ ‘çš„æ ¹èŠ‚ç‚¹ï¼Œä»–æœ‰ `render` å’Œ `unmount` ä¸¤ä¸ªæ–¹æ³•ã€‚ä»–ä½œä¸ºé¡¹ç›®çš„å…¥å£ï¼Œåªå»ºè®®ä½¿ç”¨ä¸€æ¬¡ã€‚

å…¶æ‰§è¡Œæµç¨‹å¦‚ä¸‹ï¼š

- æŸ¥æ‰¾ HTML ä¸­ä¼ å…¥çš„ DOM node.
- åœ¨è¯¥ DOM ä¸­æ”¾ç½®ç»„ä»¶ App ï¼ˆä¼šæ¸…ç©ºå·²æœ‰å…ƒç´ ï¼‰

2. é¡¹ç›®ä¸­éƒ¨åˆ†æ¸²æŸ“

æ¯”å¦‚é¡¹ç›®ä¸­æœ‰ä¸€ä¸ª html é¡µé¢ï¼š

```html
<nav id="navigation"></nav>
<main>
  <p>This paragraph is not rendered by React (open index.html to verify).</p>
  <section id="comments"></section>
</main>
```

æˆ‘ä»¬å¼•å…¥ä¸€ä¸ªjsæ–‡ä»¶ï¼š

```js
const navDomNode = document.getElementById('navigation');
const navRoot = createRoot(navDomNode); 
navRoot.render(<Navigation />);

const commentDomNode = document.getElementById('comments');
const commentRoot = createRoot(commentDomNode); 
commentRoot.render(<Comments />);
```
è¿™æ ·ï¼Œåœ¨ nav å’Œ main ä¸­å°±å„è‡ªäº§ç”Ÿäº†ä¸€ä¸ª React çš„æ¸²æŸ“æ ‘ï¼š


![image.png](/img/posts/2023-9-17/2023-9-17-1.png)

å¦‚æœä½ æƒ³è¦æ’¤é”€ä¸Šè¿°æ¸²æŸ“å·¥ä½œï¼Œå¯ä»¥è¿™æ ·å†™ï¼š

```js
root.unmount();
```

3. æ›´æ–°å·²ç»æ¸²æŸ“è¿‡çš„Reactæ ‘

å·²ç»åˆ›å»ºå‡ºæ¥çš„ rootï¼Œå¦‚æœæƒ³è¦æ›¿æ¢å…¶æ¸²æŸ“å†…å®¹ï¼Œå¯ä»¥è¿™æ ·ï¼š

```js
root.render(<App counter={i} />);
```

è¿™ä¼šé”€æ¯åŸæ¥çš„æ¸²æŸ“ï¼Œè€Œé‡æ–°å»ºç«‹æ–°çš„æ¸²æŸ“æ ‘ã€‚ä¸‹é¢çš„ä¾‹å­å°±æ˜¯åˆ©ç”¨è¿™ç§åŸç†å®ç°çš„é¡µé¢è®¡æ—¶å™¨ï¼š

```js
setInterval(() => {
  root.render(<App counter={i} />);
  i++;
}, 1000);
```
æ¯è¿‡ä¸€ç§’å°±åˆ·æ–°ä¸€ä¸‹é¡µé¢æ¸²æŸ“çš„ç»„ä»¶ã€‚


## 2. æ°´åˆæœåŠ¡ç«¯æ¸²æŸ“ä»£ç  hydrateRoot

`hydrate`Â çš„ä¸»è¦ä½œç”¨æ˜¯åœ¨å®¢æˆ·ç«¯æ¥ç®¡ä»æœåŠ¡å™¨ç«¯æ¸²æŸ“çš„åº”ç”¨ç¨‹åºï¼Œå¹¶å°†åº”ç”¨ç¨‹åºçš„çŠ¶æ€ä¸æœåŠ¡å™¨ç«¯ä¿æŒä¸€è‡´ã€‚

åœ¨ä¼ ç»Ÿçš„ SSR è¿‡ç¨‹ä¸­ï¼ŒæœåŠ¡å™¨ç«¯ä¼šæ¸²æŸ“å‡º HTML å­—ç¬¦ä¸²ï¼Œå¹¶å°†å…¶å‘é€ç»™å®¢æˆ·ç«¯ã€‚ç„¶åï¼Œå®¢æˆ·ç«¯çš„ JavaScript ä»£ç ä¼šæ¥ç®¡è¿™ä¸ªå·²ç»æ¸²æŸ“å¥½çš„é¡µé¢ï¼Œå¹¶å¯¹å…¶è¿›è¡Œäº¤äº’å¤„ç†ã€‚ä½†æ˜¯ï¼Œåœ¨å®¢æˆ·ç«¯æ¥ç®¡é¡µé¢ä¹‹å‰ï¼Œç”¨æˆ·å¯èƒ½ä¼šçœ‹åˆ°ä¸€ä¸ªç©ºç™½å±å¹•æˆ–è€…ä¸å®Œå…¨æ¸²æŸ“çš„é¡µé¢ï¼Œè¿™è¢«ç§°ä¸ºâ€œé—ªçƒâ€ç°è±¡ã€‚

`hydrate`Â æ–¹æ³•å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚å®ƒå…è®¸åœ¨æœåŠ¡å™¨ç«¯æ¸²æŸ“çš„ HTML ä¸­æ’å…¥ä¸€äº›ç‰¹æ®Šçš„æ³¨é‡Šï¼ˆç§°ä¸ºâ€œhydration markersâ€ï¼‰ï¼Œè¿™äº›æ³¨é‡ŠåŒ…å«äº†å®¢æˆ·ç«¯ JavaScript éœ€è¦çš„ä¸€äº›ä¿¡æ¯ï¼Œä¾‹å¦‚åº”ç”¨ç¨‹åºçš„çŠ¶æ€ã€ç»„ä»¶çš„ç±»å‹ç­‰ç­‰ã€‚å½“å®¢æˆ·ç«¯åŠ è½½é¡µé¢æ—¶ï¼Œå®ƒä¼šæŸ¥æ‰¾è¿™äº›æ³¨é‡Šï¼Œå¹¶ä½¿ç”¨è¿™äº›ä¿¡æ¯æ¥æ¢å¤åº”ç”¨ç¨‹åºçš„çŠ¶æ€ï¼Œä»è€Œå¿«é€Ÿæ¥ç®¡é¡µé¢ï¼Œå¹¶å‡å°‘â€œé—ªçƒâ€ç°è±¡ã€‚

ä½¿ç”¨Â `hydrate`ï¼ˆæ°´åˆï¼‰Â æ–¹æ³•ï¼Œå¯ä»¥ä½¿ SSR çš„åº”ç”¨ç¨‹åºæ›´åŠ æµç•…åœ°è¿‡æ¸¡åˆ°å®¢æˆ·ç«¯ï¼Œæé«˜ç”¨æˆ·ä½“éªŒã€‚

### ä½¿ç”¨æ–¹å¼

1. æ¥æ”¶æœåŠ¡ç«¯è¿‡æ¥çš„ html

æˆ‘ä»¬å‡è®¾ä¸€æ®µæœåŠ¡ç«¯è¿‡æ¥çš„ä»£ç ï¼š

```html
<!--
  HTML content inside <div id="root">...</div>
  was generated from App by react-dom/server.
-->
<div id="root"><h1>Hello, world!</h1><button>You clicked me <!-- -->0<!-- --> times</button></div>
```

å¯ä»¥çœ‹åˆ°ï¼Œæœ‰ä¸ª id å«åš root çš„æ ¹å…ƒç´ ï¼Œæˆ‘ä»¬å°±åœ¨å…¥å£æ–‡ä»¶ä¸­æ¸²æŸ“ï¼š

```js
import { hydrateRoot } from 'react-dom/client';
import App from './App.js';

hydrateRoot(
  document.getElementById('root'),
  <App />
);
```

è¿™é‡Œ App è¿™ä¸ªç»„ä»¶åœ¨ æœåŠ¡ç«¯è¿”å›çš„ html ä¸­å°±æœ‰æ¸²æŸ“å¥½çš„ç‰ˆæœ¬ï¼ŒReact ä¼šæ ¹æ®ä¼ è¿›æ¥çš„ç¬¬äºŒä¸ªå‚æ•°ï¼ˆAppæºç ï¼‰é‡æ„æ¸²æŸ“æ ‘è¿›è¡Œæ¸²æŸ“ã€‚

2. å¤„ç†æ°´åˆæ—¶çš„å·®å¼‚é”™è¯¯

å¦‚æœå•ä¸ªå…ƒç´ çš„å±æ€§æˆ–æ–‡æœ¬å†…å®¹åœ¨æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯ä¹‹é—´ä¸å¯é¿å…åœ°å­˜åœ¨å·®å¼‚ï¼ˆä¾‹å¦‚æ—¶é—´æˆ³ï¼‰ï¼Œæ‚¨å¯ä»¥ç¦æ­¢æ°´åˆä¸åŒ¹é…çš„è­¦å‘Šã€‚è¦ç¦æ­¢æŸä¸ªå…ƒç´ çš„æ°´åˆè­¦å‘Šï¼Œè¯·æ·»åŠ  `suppressHydrationWarning={true}`ï¼š

```js
hydrateRoot(document.getElementById('root'), <App />);
```

3. åŒºåˆ†æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯çš„ä¸åŒ

å¦‚æœä½ ç¡®å®éœ€è¦åœ¨å®¢æˆ·ç«¯æ¸²æŸ“ä¸€äº›ä¸æœåŠ¡ç«¯ä¸åŒçš„ä¸œè¥¿ã€‚ å¯ä»¥åœ¨å®¢æˆ·ç«¯é‡Œè¿™æ ·å†™ï¼š

```js
export default function App() {
  const [isClient, setIsClient] = useState(false);

  useEffect(() => {
    setIsClient(true);
  }, []);

  return (
    <h1>
      {isClient ? 'Is Client' : 'Is Server'}
    </h1>
  );
}
```

è¿™æ ·ï¼Œåœ¨æ°´åˆçš„è¿‡ç¨‹ä¸­ï¼Œå°±ä¼šé’ˆå¯¹æ€§çš„æ¸²æŸ“äº†ã€‚è¿™ç§æ–¹å¼å°±æ˜¯è¯´å¯ä»¥åœ¨ SSR çš„åŸºç¡€ä¸Šï¼Œå®¢æˆ·ç«¯å†å¢é‡æ›´æ–°åªéœ€è¦å®¢æˆ·ç«¯æ¸²æŸ“çš„å†…å®¹ï¼Œæ¯”å¦‚ä¸Šé¢æåˆ°çš„è®¡æ•°å™¨ç­‰ã€‚17:T1a16,## 1. createPortal

createPortal ç”¨äºæ‰‹åŠ¨æ¸²æŸ“åŠ¨æ€ç»„ä»¶ã€‚

### æ¥å—å‚æ•°

-   `children`: ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªå¯ä»¥è¢« render çš„ React DOM.
-   `domNode`: ç¬¬äºŒä¸ªå‚æ•°æ˜¯ä¸€ä¸ªçœŸå®çš„ DOM èŠ‚ç‚¹ï¼Œç”¨äºå½“åšæ¸²æŸ“çš„çˆ¶å®¹å™¨.
-   å¯é€‰é¡¹ `key`: ç¬¬ä¸‰ä¸ªå‚æ•°å¯é€‰ï¼Œä½œä¸ºåŠ¨æ€ç»„ä»¶çš„ key.

### è¿”å›å€¼

`createPortal`è¿”å›ä¸€ä¸ª React node. åœ¨æ¸²æŸ“æ—¶ï¼ŒReact ä¼šå°†æŒ‡å®šçš„æ¸²æŸ“ç»„ä»¶æ”¾ç½®åœ¨æŒ‡å®šçš„ DOM å®¹å™¨ï¼ˆdomNodeï¼‰å†…ã€‚

### æ³¨æ„äº‹é¡¹

-   ä½¿ç”¨ createPortal æ˜¯ä¼šäº‹ä»¶å†’æ³¡çš„. ä¸¾ä¸ªä¾‹å­ï¼Œå¦‚æœä½ åœ¨ portal å†…éƒ¨ç‚¹å‡»é¼ æ ‡, è¿™ä¸ª portal åˆè¢« `<div onClick>` åŒ…è£¹, åˆ™ `onClick` äº‹ä»¶ä¹Ÿä¼šè¢«è§¦å‘. 

### ä½¿ç”¨æ¡ˆä¾‹

1. å¾€åˆ«çš„ div é‡Œæ¸²æŸ“ä¸€ä¸ªç»„ä»¶

```jsx
export default function MyComponent() {
  return (
    <div style={{ border: '2px solid black' }}>
      <p>This child is placed in the parent div.</p>
      {createPortal(
        <p>This child is placed in the document body.</p>,
        document.body
      )}
    </div>
  );
}
```
çœ‹çœ‹ç•Œé¢ï¼Œç¡®å®æ¸²æŸ“åœ¨ body ä¸‹ï¼ŒåŸæ¥çš„ä½ç½®ç©ºç©ºå¦‚ä¹Ÿï¼š


![image.png](/img/posts/2023-9-15/2023-9-15-1.png)

2. å®ç°ä¸€ä¸ªå¼¹çª—

å¦‚æœä½ å†™è¿‡ UI åº“ï¼Œä¸Šé¢çš„ DOM ç»“æ„ä½ å¯èƒ½ä¼šæ¯”è¾ƒç†Ÿæ‚‰ï¼Œè¿™å°±æ˜¯å¼¹å‡ºå±‚ç»„ä»¶å¸¸ç”¨çš„æ’å…¥æ–¹å¼ã€‚æˆ‘ä»¬å°±ç”¨ä¸Šé¢çš„åŸç†ï¼Œå®ç°ä¸€ä¸ªç®€å•çš„å¼¹çª—ï¼Œ

```js
export default function PortalExample() {
  const [showModal, setShowModal] = useState(false);
  return (
    <>
      <button onClick={() => setShowModal(true)}>
        Show modal using a portal
      </button>
      {showModal && createPortal(
        <ModalContent onClose={() => setShowModal(false)} />,
        document.body
      )}
    </>
  );
}
```
å¦‚æœä¸ä½¿ç”¨ createPortalï¼Œåœ¨ showModal æ—¶ï¼ŒModalContent ç»„ä»¶ä¼šè¿½åŠ åœ¨æŒ‰é’®ä¸‹é¢ï¼Œå¦‚æœè®¾ç½®äº†ç»å¯¹å®šä½åï¼Œä¹Ÿåªæ˜¯é’ˆå¯¹ä¸Šä¸€çº§ç»„ä»¶çš„åç§»ï¼Œè€Œå¼¹çª—ç†åº”æ˜¯ä¸ªå…¨å±€æ€§çš„ç»„ä»¶ã€‚æˆ‘ä»¬çœ‹çœ‹è¿è¡Œæ•ˆæœï¼š


![image.png](/img/posts/2023-9-15/2023-9-15-2.png)


3. æœåŠ¡ç«¯æ¸²æŸ“æ—¶ï¼Œå¾€ç‹¬ç«‹çš„ html ä¸­æ¸²æŸ“

æœåŠ¡ç«¯æ¸²æŸ“æ—¶ï¼Œä¼šå­˜åœ¨è„±ç¦» React ç¯å¢ƒçš„é¡µé¢ (æ¯”å¦‚ React root åªä½œä¸º web é¡¹ç›®çš„ä¸€éƒ¨åˆ†æ—¶)ï¼Œä½¿ç”¨è¿™ä¸ªæ–¹æ³•å°±å¯ä»¥å®ç°æ¸²æŸ“ï¼š

```js
const sidebarContentEl = document.getElementById('sidebar-content');

...
<>
  <MainContent />
  {createPortal(
    <SidebarContent />,
    sidebarContentEl
  )}
</>
```

4. **å°†åªæ”¯æŒ js å¼•å…¥æ–¹å¼çš„ç¬¬ä¸‰æ–¹åº“æ¸²æŸ“ä¸º React ç»„ä»¶**

æœ‰çš„ç¬¬ä¸‰æ–¹åº“åªæä¾›äº† js å¼•å…¥æ–¹å¼ï¼Œæ¯”å¦‚ åœ°å›¾ç»„ä»¶ leafletï¼š

```js
// map-widget.js
import 'leaflet/dist/leaflet.css';
import * as L from 'leaflet';

export function createMapWidget(containerDomNode) {
  const map = L.map(containerDomNode);
  map.setView([0, 0], 0);
  L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: 'Â© OpenStreetMap'
  }).addTo(map);
  return map;
}

export function addPopupToMapWidget(map) {
  const popupDiv = document.createElement('div');
  L.popup()
    .setLatLng([0, 0])
    .setContent(popupDiv)
    .openOn(map);
  return popupDiv;
}
```

ä¸Šé¢çš„ä¸¤ä¸ªå‡½æ•°éƒ½ä¸æ˜¯ç»„ä»¶ï¼Œæˆ‘ä»¬ä¸èƒ½åœ¨Reactç»„ä»¶ä¸­ç›´æ¥å¼•ç”¨ã€‚

çœ‹ä¸‹é¢çš„å¤„ç†ï¼š

```js
import { useRef, useEffect, useState } from 'react';
import { createPortal } from 'react-dom';
import { createMapWidget, addPopupToMapWidget } from './map-widget.js';

export default function Map() {
  const containerRef = useRef(null);
  const mapRef = useRef(null);
  const [popupContainer, setPopupContainer] = useState(null);

  useEffect(() => {
    if (mapRef.current === null) {
      const map = createMapWidget(containerRef.current);
      mapRef.current = map;
      const popupDiv = addPopupToMapWidget(map);
      setPopupContainer(popupDiv);
    }
  }, []);

  return (
    <div style={{ width: 250, height: 250 }} ref={containerRef}>
      {popupContainer !== null && createPortal(
        <p>Hello from React!</p>,
        popupContainer
      )}
    </div>
  );
}
```

ä¸Šé¢çš„ä»£ç ï¼Œä½¿ç”¨ React çŠ¶æ€ popupContainer æ¥å—äº†åœ°å›¾è¿”å›çš„å®¹å™¨ divï¼Œå¹¶åŒ…è£¹åœ¨ç»„ä»¶ Map ä¸­è¿”å›ã€‚å¦‚æ­¤ï¼Œè¿™ä¸ªç»„ä»¶å°±å¯ä»¥è¢«å¤–éƒ¨ç»„ä»¶è°ƒç”¨äº†ã€‚

## 2. flushSync

flushSync ç”¨äºå¼ºåˆ¶åˆ·æ–° React æ‰€æœ‰å·²ç»æŒ‚èµ·çš„æ¸²æŸ“å·¥ä½œï¼Œå¹¶åŒæ­¥æ›´æ–°ç»„ä»¶æ ‘ã€‚

åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼ŒReact ä½¿ç”¨å¼‚æ­¥æ›´æ–°ç­–ç•¥ï¼Œè¿™æ„å‘³ç€åœ¨è°ƒç”¨ `setState` æˆ– `forceUpdate` ç­‰æ›´æ–°æ–¹æ³•åï¼ŒReact å°†åœ¨äº‹ä»¶å¾ªç¯çš„å½“å‰è¿­ä»£ä¸­æ‰¹é‡æ›´æ–°ç»„ä»¶ï¼Œè€Œä¸æ˜¯ç«‹å³æ›´æ–°ï¼ˆå¯ä»¥äº†è§£ä¸€ä¸‹ fiber çš„è°ƒåº¦åŸç†ï¼‰ã€‚è¿™ç§å¼‚æ­¥æ›´æ–°ç­–ç•¥å¯ä»¥æé«˜æ€§èƒ½ï¼Œä½†æœ‰æ—¶å€™æˆ‘ä»¬éœ€è¦ç«‹å³æ›´æ–°ç»„ä»¶ï¼Œè¿™å°±æ˜¯ `flushSync` çš„ç”¨é€”ã€‚

`flushSync` æ–¹æ³•å¯ä»¥å¼ºåˆ¶ React ç«‹å³æ‰§è¡Œå½“å‰æ‰¹æ¬¡çš„æ‰€æœ‰æ›´æ–°ï¼Œè€Œä¸æ˜¯ç­‰å¾…äº‹ä»¶å¾ªç¯çš„ä¸‹ä¸€ä¸ªè¿­ä»£ã€‚

> æ»¥ç”¨ä¼šæŸå®³æ€§èƒ½ï¼Œæœ€å¥½ä¸ç”¨ã€‚

### æ¥å—å‚æ•°

-   `callback`: æ¥å—ä¸€ä¸ªå‡½æ•°ã€‚ä¼šç«‹å³è¢«è°ƒç”¨ï¼Œå¹¶åˆ·æ–°çŠ¶æ€ã€‚åŒæ—¶ä¹Ÿä¼šåˆ·æ–°é˜»å¡çš„æ›´æ–°ä»»åŠ¡ã€å‰¯ä½œç”¨ç­‰ã€‚

### æ³¨æ„äº‹é¡¹

-   `flushSync`Â ä¼šæ˜¾è‘—å½±å“æ€§èƒ½.
-   `flushSync`Â å¯èƒ½å¼ºåˆ¶é˜»å¡ Suspense ç»„ä»¶ï¼Œä»¥è‡³äº fallback æ— æ³•æ˜¾ç¤º.

### ä½¿ç”¨æ¡ˆä¾‹

1. åŒä¸€å‘¨æœŸå†…æ¸²æŸ“çš„é—®é¢˜

æœ‰æ—¶å€™æƒ³è¦åœ¨åŒä¸€ä¸ªæ¸²æŸ“å‘¨æœŸå†…è·å–åˆ°æœ€æ–°çš„ state çš„å€¼ï¼Œæ¯”å¦‚ä¸‹é¢çš„æ‰“å°æœºçš„ä¾‹å­ï¼š

```js
import { useState, useEffect } from 'react';

export default function PrintApp() {
  const [isPrinting, setIsPrinting] = useState(false);

  useEffect(() => {
    function handleBeforePrint() {
      setIsPrinting(true);
    }

    function handleAfterPrint() {
      setIsPrinting(false);
    }

    window.addEventListener('beforeprint', handleBeforePrint);
    window.addEventListener('afterprint', handleAfterPrint);
    return () => {
      window.removeEventListener('beforeprint', handleBeforePrint);
      window.removeEventListener('afterprint', handleAfterPrint);
    }
  }, []);

  return (
    <>
      <h1>isPrinting: {isPrinting ? 'yes' : 'no'}</h1>
      <button onClick={() => window.print()}>
        Print
      </button>
    </>
  );
}
```
beforeprint äº‹ä»¶åœ¨è°ƒç”¨æ‰“å°é¡µé¢æ—¶ä¼šè¢«ç«‹å³è°ƒç”¨ï¼Œä½†æ˜¯ä½ ä¼šå‘ç°ï¼Œåœ¨ç•Œé¢ä¸Šï¼ŒisPrinting å´æ˜¯ noã€‚è¿™æ˜¯å› ä¸ºæ›´æ–° state çš„ä»»åŠ¡æ”¾å…¥é˜Ÿåˆ—åï¼Œæ‰“å°å¼¹çª—æ‰“å¼€äº†ï¼Œé˜»å¡äº†ä»»åŠ¡ã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦å¼ºåˆ¶æ¸²æŸ“ï¼š

```js
function handleAfterPrint() {
  flushSync(() => {
    setIsPrinting(false);
  })
}
```

è¿™æ ·ï¼Œå°±ä¼šåœ¨æ‰“å°å¼¹çª—æ‰“å¼€çš„åŒæ—¶ï¼ŒåŒæ­¥æ¸²æŸ“ UI äº†ã€‚

----

åˆ°è¿™é‡Œï¼Œå¸¸è§„çš„ API å°±ä»‹ç»å®Œäº†ï¼Œä¹‹åçš„ç³»åˆ—æ–‡ç« å°±å¼€å§‹ä»‹ç»å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯æ¸²æŸ“çš„ç›¸å…³APIäº†ï¼Œæ•¬è¯·æœŸå¾…~~18:T1a9d,å®˜ç½‘åœ°å€ï¼š[React](https://react.dev/)

## 1. memo

ç»„ä»¶çº§åˆ«çš„ç¼“å­˜å‡½æ•°ï¼Œä½¿ç”¨å®ƒåŒ…è£¹çš„ç»„ä»¶ç»„æˆçš„æ–°ç»„ä»¶å¯ä»¥åœ¨ props æ²¡æœ‰å˜åŒ–æ—¶é˜»æ­¢é‡æ¸²æŸ“ï¼Œä»è€Œæé«˜æ€§èƒ½ã€‚ç±»ä¼¼äºVueçš„ keepAliveã€‚

### æ¥å—å‚æ•°

- æ¥å—ä¸€ä¸ª react ç»„ä»¶ã€‚`memo` ä¸ä¼šæ”¹å˜è¿™ä¸ªç»„ä»¶æœ¬èº«çš„å±æ€§ï¼Œä»»ä½•æœ‰æ•ˆçš„ React ç»„ä»¶ï¼ŒåŒ…æ‹¬å‡½æ•°å’Œ `forwardRef` ç»„ä»¶ï¼Œéƒ½å¯ä»¥è¢«æ¥å—ã€‚
- ç¬¬äºŒä¸ªå‚æ•°æ˜¯å¯é€‰å‚æ•°ï¼šç»„ä»¶ä»¥å‰çš„ props å’Œå®ƒçš„æ–° propsã€‚

### è¿”å›å€¼

`memo` è¿”å›ä¸€ä¸ªæ–°çš„ React ç»„ä»¶ã€‚å®ƒçš„è¡Œä¸ºä¸æä¾›ç»™çš„ç»„ä»¶ç›¸åŒï¼Œåªæ˜¯ React ä¸ä¼šæ€»æ˜¯åœ¨å…¶çˆ¶çº§è¢«é‡æ–°æ¸²æŸ“æ—¶æ‰§è¡Œé‡æ–°æ¸²æŸ“ï¼Œé™¤éå®ƒçš„ props å‘ç”Ÿäº†å˜åŒ–ï¼ˆObject.is æ¯”è¾ƒï¼‰ã€‚

### æ³¨æ„äº‹é¡¹

**memo ä¸æ˜¯ä¸‡èƒ½çš„ï¼š**

1.  å½“ä¸€ä¸ªç»„ä»¶åœ¨åŒ…è£…å…¶ä»–ç»„ä»¶æ—¶ï¼Œè®©å®ƒæ¥å— JSX ä½œä¸ºå­ç»„ä»¶ã€‚è¿™æ ·ï¼Œå½“çˆ¶ç»„ä»¶æ›´æ–°è‡ªå·±çš„çŠ¶æ€æ—¶ï¼Œéœ€è¦è®© React çŸ¥é“å®ƒçš„å­ç»„ä»¶æ˜¯å¦ä¸éœ€è¦é‡æ–°æ¸²æŸ“æ—¶ï¼Œä½ æ‰è¦è€ƒè™‘ä½¿ç”¨ memoã€‚
2. æ›´æ¨èä½¿ç”¨ç»„ä»¶çº§åˆ«çš„ stateï¼Œè€Œä¸è¦æŠŠæ‰€æœ‰çŠ¶æ€éƒ½ç»´æŠ¤åœ¨é¡¶çº§ç»„ä»¶ï¼Œå†å¤§é‡ä½¿ç”¨ memo æ¥æŒ½å›æ€§èƒ½ã€‚
3. ä¿æŒç»„ä»¶çš„çº¯å‡€æ€§ã€‚å¦‚æœä½ çš„ç»„ä»¶å¤šæ¬¡æ¸²æŸ“è¿”å›çš„ä¸åŒçš„çŠ¶æ€ï¼Œä½ åº”è¯¥è®¸ä¿®å¤ä½ ç»„ä»¶çš„ bugï¼Œè€Œä¸æ˜¯åŠ ä¸€ä¸ª memoã€‚
4. é¿å…ä¸å¿…è¦çš„çŠ¶æ€æ›´æ–°ï¼Œè¿™äº›æ›´æ–°æœ‰æ—¶å€™ä¼šé€ æˆå­ç»„ä»¶åå¤æ¸²æŸ“ã€‚
5. åˆ é™¤ useEffect ä¸­ä¸å¿…è¦çš„ä¾èµ–é¡¹ï¼Œä»–æœ‰æ—¶å€™ä¹Ÿä¼šé€ æˆè¿‡å¤šçš„æ¸²æŸ“ã€‚
6. props å¦‚æœæ˜¯å‡½æ•°ï¼Œçˆ¶ç»„ä»¶åº”å°†è¯¥å‡½æ•°ç¼“å­˜ï¼ˆuseCallbackç­‰ï¼‰ï¼Œå¦åˆ™çˆ¶ç»„ä»¶æ¸²æŸ“ï¼Œè¯¥å‡½æ•°å¼•ç”¨ä¼šå˜åŒ–ï¼Œå¯¼è‡´å­ç»„ä»¶çš„ memo å¤±æ•ˆã€‚

### ä½¿ç”¨æ¡ˆä¾‹

1. éƒ¨åˆ†å±æ€§å˜åŒ–æ›´æ–°ç»„ä»¶

React ç»„ä»¶éƒ½æ˜¯çº¯å‡½æ•°ï¼Œæˆ–è€…è¯´åº”è¯¥æ˜¯çº¯å‡½æ•°ï¼Œæ‰€ä»¥å¯ä»¥è®¤ä¸º props æ²¡æœ‰å˜åŒ–çš„æ—¶å€™ï¼Œå…¶è¾“å‡ºä¹Ÿä¸åº”è¯¥å˜åŒ–ã€‚è¿™å°±æ˜¯ memo èƒ½å¤Ÿç¼“å­˜è€Œä¸é€ æˆé”™ä¹±çš„ç†è®ºåŸºç¡€ã€‚ 

ä¸‹é¢çš„ä¾‹å­ï¼Œåªè¦å…¥å‚ name æ²¡æœ‰å˜åŒ–ï¼ŒGreeting ç»„ä»¶å†…éƒ¨æ˜¯ä¸ä¼šé‡æ–°æ¸²æŸ“çš„ã€‚

```js
const Greeting = memo(function Greeting({ name }) {
  return <h1>Hello, {name}!</h1>;
});

export default Greeting;

// å…¶ä»–ç»„ä»¶å¼•ç”¨
<Greeting name={name} />
```

2. ä¸ context ç»“åˆçš„ç¼“å­˜

ä¸‹é¢çš„ä¾‹å­ï¼Œå­ç»„ä»¶ Greeting æ˜¯ä¸€ä¸ªä½¿ç”¨äº†memåŒ…è£¹çš„ç»„ä»¶ï¼Œä½†æ˜¯å½“çˆ¶ç»„ä»¶å±æ€§ theme å˜åŒ–æ—¶ï¼Œè¿˜æ˜¯ä¼šå¼•èµ·å­ç»„ä»¶é‡æ¸²æŸ“ã€‚ 

```js
export default function MyApp() {
  const [theme, setTheme] = useState('dark');

  function handleClick() {
    setTheme(theme === 'dark' ? 'light' : 'dark'); 
  }

  return (
    <ThemeContext.Provider value={theme}>
      <button onClick={handleClick}>
        Switch theme
      </button>
      <Greeting name="Taylor" />
    </ThemeContext.Provider>
  );
}
```
è‹¥è¦ä½¿ç»„ä»¶ä»…åœ¨æŸäº› context å±æ€§æ”¹å˜æ—¶é‡æ–°æ¸²æŸ“ï¼Œè¯·å°†ç»„ä»¶ä¸€åˆ†ä¸ºäºŒã€‚ä»å¤–éƒ¨ç»„ä»¶çš„ context ä¸­è¯»å–æ‚¨éœ€è¦çš„å†…å®¹ï¼Œå¹¶å°†å…¶ä½œä¸º props ä¼ é€’ç»™è®°å¿†çš„å­ç»„ä»¶ã€‚

3. ç»„ä»¶è§„èŒƒï¼šå°½é‡å‡å°‘ç»„ä»¶æˆå‘˜çš„åå¤å˜åŒ–

React çš„é‡æ¸²æŸ“åˆ¤æ–­éƒ½æ˜¯ä½¿ç”¨ Object.is æ¥åˆ¤æ–­çš„ï¼Œä½†æ˜¯ `Object.is({}, {})` å¯æ˜¯ä¼šè¿”å› false çš„ã€‚æ‰€ä»¥ç»„ä»¶çš„äººæˆå‘˜æ–¹æ³•åº”è¯¥åšå¿…è¦çš„ç¼“å­˜ï¼Œè®©ç»„ä»¶åœ¨é‡æ¸²æŸ“æ—¶è¿™ä¸ªæ–¹æ³•è¿˜èƒ½ä¿æŒè¿‡å»çš„å†…å­˜å¼•ç”¨ã€‚

```js
function Page() {
  const [name, setName] = useState('Taylor');
  const [age, setAge] = useState(42);

  const person = useMemo(
    () => ({ name, age }),
    [name, age]
  );

  return <Profile person={person} />;
}

const Profile = memo(function Profile({ person }) {
  // ...
});
```
ä¸Šé¢çš„ä¾‹å­ï¼Œperson è¢«ç¼“å­˜äº†ï¼Œå½“Pageç»„ä»¶é‡æ¸²æŸ“æ—¶ï¼Œä¸ä¼šå› ä¸º person çš„å†…å­˜å¼•ç”¨å˜åŒ–äº†è€Œå¯¼è‡´ Profile ä¸å¿…è¦çš„æ¸²æŸ“ã€‚

4. ä½¿ç”¨ç¬¬äºŒä¸ªå‚æ•°æ¥æ¯”å¯¹ props

æˆ‘ä»¬å†™ä¸ªè‡ªå®šä¹‰çš„å‡½æ•°æ¥æ¯”å¯¹ propsï¼Œä»è€Œå†³å®šæ˜¯å¦è¦é‡æ¸²æŸ“ã€‚æ­¤å‡½æ•°ä½œä¸ºç¬¬äºŒä¸ªå‚æ•°ä¼ é€’ç»™å­ç»„ä»¶ã€‚ä»…å½“è¿”å› true æ—¶ä¸åšé‡æ¸²æŸ“ï¼Œå¦åˆ™å°±è¿›è¡Œé‡æ¸²æŸ“ã€‚

```js
const Chart = memo(function Chart({ dataPoints }) {
  // ...
}, arePropsEqual);

function arePropsEqual(oldProps, newProps) {
  return (
    oldProps.dataPoints.length === newProps.dataPoints.length &&
    oldProps.dataPoints.every((oldPoint, index) => {
      const newPoint = newProps.dataPoints[index];
      return oldPoint.x === newPoint.x && oldPoint.y === newPoint.y;
    })
  );
}
```
å½“ç”¨åˆ°è‡ªå®šä¹‰å‡½æ•°æ—¶ï¼Œä¸€å®šè¦æµ‹è¯•ä¸€ä¸‹æ˜¯å¦æ€§èƒ½æ¯”é»˜è®¤çš„æ¯”å¯¹æ–¹å¼æ›´å¥½ã€‚è¿™é‡Œè¾¹å‘æ¯”è¾ƒå¤šï¼Œå°½é‡é¿å…æ·±åº¦æ£€æŸ¥ï¼Œ**æ·±åº¦ç›¸ç­‰æ€§æ£€æŸ¥å¯èƒ½ä¼šä½¿ç»„ä»¶å˜å¾—éå¸¸æ…¢**ã€‚

## 2. forwardRef

forwardRef ä½¿ç»„ä»¶å‘çˆ¶ç»„ä»¶æš´éœ²å‡ºè‡ªå·±çš„ DOM ç»“æ„ã€‚

### æ¥æ”¶å‚æ•°

-  å‡½æ•°å¼ç»„ä»¶ã€‚React ä¼šåœ¨çˆ¶ç»„ä»¶ä¸­å¸¦ç€ props å’Œ ref è°ƒç”¨è¿™ä¸ªå‡½æ•°ã€‚

### è¿”å›å€¼

- `forwardRef` è¿”å›åŸå‡½æ•°å¼ç»„ä»¶ï¼Œä¸è¿‡ä¼šåœ¨ props ä¸­å¸¦å…¥ ref ä¿¡æ¯ã€‚

### ä½¿ç”¨æ¡ˆä¾‹

1. çˆ¶ç»„ä»¶è·å–å­ç»„ä»¶ DOM å®ä¾‹

```js
// å­ç»„ä»¶
const MyInput = forwardRef(function MyInput(props, ref) {
  const { label, ...otherProps } = props;
  return (
    <label>
      {label}
      <input {...otherProps} ref={ref} />
    </label>
  );
});

// çˆ¶ç»„ä»¶
function Form() {
  const ref = useRef(null);

  function handleClick() {
    ref.current.focus();
  }

  return (
    <form>
      <MyInput label="Enter your name:" ref={ref} />
      <button type="button" onClick={handleClick}>
        Edit
      </button>
    </form>
  );
}
```
ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œå­ç»„ä»¶å°† ref æ‰“åœ¨ input æ ‡ç­¾ä¸­ï¼Œå¹¶æš´éœ²å‡ºå»ï¼›çˆ¶ç»„ä»¶ä¸­ï¼ŒåŒæ ·ä½¿ç”¨ ref å±æ€§æ¥å—ã€‚`useRef` çš„ä½¿ç”¨ï¼Œå¯ä»¥å‚çœ‹ä¹‹å‰çš„æ–‡ç« ï¼š[useRef](https://juejin.cn/post/7249607108044357690#heading-14)

> ä½¿ç”¨ forwardRef å°±ç›¸å½“äº ref é€ä¼ ã€‚çˆ¶ç»„ä»¶ä¸­çš„ useRef ç›´æ¥æ‰“åœ¨å­ç»„ä»¶ä¸­çš„ input

2. æ’­æ”¾å™¨æ§åˆ¶

ä¸Šé¢æ˜¯æ§åˆ¶æ–‡æœ¬æ¡†èšç„¦ï¼Œä¸‹é¢æ˜¯å¦å¤–çš„ H5 API çš„è°ƒç”¨ä¾‹å­ï¼Œçˆ¶ç»„ä»¶ä¸­æ§åˆ¶æ’­æ”¾å™¨ï¼š

```js
// å­ç»„ä»¶
<video width={width} ref={ref}>
  <source
    src={src}
    type={type}
  />
</video>

// çˆ¶ç»„ä»¶
<button onClick={() => ref.current.play()}>
    Play
</button>
```

3. æš´éœ²å­ç»„ä»¶æˆå‘˜æ–¹æ³•

useImperativeHandle çš„ä½¿ç”¨å¯ä»¥å‚è§ [useImperativeHandle](https://juejin.cn/post/7249607108044357690#heading-21)

```js
const MyInput = forwardRef(function MyInput(props, ref) {
  const inputRef = useRef(null);

  useImperativeHandle(ref, () => {
    return {
      focus() {
        inputRef.current.focus();
      },
      scrollIntoView() {
        inputRef.current.scrollIntoView();
      },
      handleClick() {
        handleClick();
      }
    };
  }, []);
  
  function handleClick() {
    // è‡ªå®šä¹‰çš„æˆå‘˜æ–¹æ³•
    alert('click');
  }

  return <input {...props} ref={inputRef} />;
});
```
è¿™æ ·åœ¨çˆ¶ç»„ä»¶ä¸­å°±å¯ä»¥è¿™æ ·è°ƒç”¨äº†ï¼š`ref.current.scrollIntoView();`


----
å®Œ ï¼ï¼19:T1449,å®˜ç½‘åœ°å€ï¼š[React](https://react.dev/)

## 1. startTransition

æˆ‘ä»¬åœ¨è®² [useTransition](https://juejin.cn/post/7268530145202700303) çš„ä¸€èŠ‚æˆ‘ä»¬è®²è¿‡ï¼Œé€šè¿‡ hook å¯ä»¥è·å–åˆ°è¿™ä¸ª APIï¼Œæ¨èç»“åˆ hook ä¸€èµ·ä½¿ç”¨ã€‚

å½“ç„¶ä¹Ÿå¯ä»¥ç›´æ¥å¼•å…¥ï¼š

```js
import { startTransition } from 'react';

function TabContainer() {
  const [tab, setTab] = useState('about');

  function selectTab(nextTab) {
    startTransition(() => {
      setTab(nextTab);
    });
  }
  // ...
}
```
ä»–çš„ä½œç”¨æ˜¯é˜²æ­¢ UI é˜»å¡ï¼Œåšåˆ°å‰ç«¯å¼‚æ­¥éé˜»å¡æ¸²æŸ“ã€‚å…·ä½“ä½¿ç”¨æ–¹å¼è§ useTransitionã€‚

### æ³¨æ„äº‹é¡¹

-  `startTransition` ä¸ä¼šè¿½è¸ªæ¸²æŸ“ pending çš„çŠ¶æ€. æƒ³è¦è·å–æ¸²æŸ“å®æ—¶çŠ¶æ€ï¼Œè¯·ä½¿ç”¨ [`useTransition`](https://juejin.cn/post/7268530145202700303) .
-  ä½¿ç”¨å®ƒåŒ…è£¹ state çš„ `set` å‡½æ•°æ¥å®ç°è·Ÿè¯¥ state ç›¸å…³çš„æ¸²æŸ“è¿‡æ¸¡ã€‚ å¦‚æœæƒ³è¦å“åº” props å˜åŒ–æ¥å®ç°æ¸²æŸ“è¿‡æ¸¡ï¼Œè¯·ä½¿ç”¨ [`useDeferredValue`](https://juejin.cn/post/7268530145202700303).
-  `startTransition` å†…éƒ¨å‡½æ•°å¿…é¡»æ˜¯åŒæ­¥çš„.
-  æ ‡è®°ä¸º transition çš„ state æ›´æ–°ä¼šè¢«å…¶ä»– state çš„æ›´æ–°æ‰“æ–­æ¸²æŸ“ï¼Œåœ¨å…¶ä»–æ¸²æŸ“è°ƒåº¦ç»“æŸåå†æ¬¡æƒ³é‡æ–°æ‰§è¡Œè¯¥æ¸²æŸ“.
-  ä¸èƒ½ç”¨äºæ§åˆ¶æ–‡æœ¬è¾“å…¥ç»„ä»¶.
-  å¦‚æœåŒæ—¶æœ‰å¤šä¸ªåœ¨è¿è¡Œçš„è¿‡æ¸¡ï¼ŒReact ä¼šæŠŠä»–ä»¬åˆå¹¶ä¸€èµ·å¤„ç†ã€‚è¿™ä¸ªæ–¹æ¡ˆä¼¼ä¹æ˜¯ä¸ªæ€§èƒ½ç¼ºé™·ï¼Œéšåçš„ç‰ˆæœ¬å¯èƒ½ä¼šä¿®å¤å®ƒã€‚

## 2. createContext

é¡¾åæ€ä¹‰ï¼Œå°±æ˜¯åˆ›å»ºä¸€ä¸ª context å¯¹è±¡ï¼Œä¸€èˆ¬ç»“åˆ hook ä¸€èµ·ä½¿ç”¨ï¼Œå¯ä»¥å‚è€ƒæˆ‘ [useContext](https://juejin.cn/post/7249607108044357690) çš„æ–‡ç« ã€‚

å®˜ç½‘çš„éƒ¨åˆ†æè¿°ä¸ useContext æœ‰é‡å¤ï¼Œè¿™é‡ŒåŠç›´æ¥è®²ä½¿ç”¨æ¡ˆä¾‹ã€‚

### ä½¿ç”¨æ¡ˆä¾‹

1. é…ç½®å…¨å±€å˜é‡

```js
// æ”¾åœ¨å…¨å±€ï¼Œåˆ›å»ºæ—¶çš„é»˜è®¤å€¼ä¸€èˆ¬å¯ä»¥ä¸ç”¨ä¼ é€’ï¼Œåœ¨ provider æ—¶ä¼šé…ç½®åˆå§‹å€¼çš„
const ThemeContext = createContext();  
const AuthContext = createContext();
```
æˆ‘ä»¬å®šä¹‰ä¸»é¢˜ä¿¡æ¯å’Œè®¤è¯ä¿¡æ¯ï¼Œç”¨å®ƒåŒ…è£¹æ ¹ç»„ä»¶ï¼š

```jsx
const [theme, setTheme] = useState('dark');
const [currentUser, setCurrentUser] = useState({ id: 1 });

<ThemeContext.Provider value={theme}>
  <AuthContext.Provider value={currentUser}>
    <Page />
  </AuthContext.Provider>
</ThemeContext.Provider>
```

åœ¨åŒ…è£¹çš„å†…éƒ¨ç»„ä»¶ä¸­ï¼Œæ— è®ºå¤šæ·±çš„å±‚çº§ï¼Œéƒ½å¯ä»¥è¿™æ ·ä½¿ç”¨æ¥è·å– value å€¼ï¼š

```js
const theme = useContext(ThemeContext); // dark
```

> ç¡®ä¿ ThemeContext æ˜¯ä¸€å¼€å§‹å®šä¹‰çš„é‚£ä¸ªå•ä¾‹

ä»–è¸¢åŠ¨äº†ä¸€ä¸ªå•å‘æ•°æ®æµï¼Œå¯ä»¥ä»é¡¶å‘ä¸‹ä¼ é€’åŠ¨æ€å“åº”å¼æ•°æ®ã€‚å¦‚æœåœ¨å…¥å£å¤„ç»´æŠ¤ä¸€äº› stateï¼Œæš´éœ²å‡ºäº‹ä»¶æ¥ç»™å„ä¸ªä¸šåŠ¡æ¨¡å—è°ƒç”¨ï¼Œå°±å¯ä»¥å®ç°ä¸€ä¸ªç±»ä¼¼ redux çš„åŠŸèƒ½ã€‚

2. å±€éƒ¨å¼•ç”¨

```js
// Button.js  
import { ThemeContext } from './Contexts.js';
```

æ¯”å¦‚ä¸Šé¢çš„ä¾‹å­ï¼Œæˆ‘ä»¬å…¨å±€é…ç½®äº†ä¸»é¢˜ä¸º darkï¼Œä½†æ˜¯æœ‰ä¸€ä¸ª Button ç»„ä»¶ï¼Œå…¶éœ€è¦ç‰¹æ®Šå¤„ç†ï¼Œå°±å¯ä»¥è¿™æ ·å†™ï¼Œåœ¨ Button å†…éƒ¨å†æ¬¡ Provider è‡ªå·±æƒ³è¦çš„ä¸»é¢˜å³å¯ï¼Œç›¸åŒçš„ context éµå¾ªå°±è¿‘åŸåˆ™ã€‚

## 3. lazy

å»¶è¿ŸåŠ è½½ç»„ä»¶çš„å·¥å…·ï¼Œå¾€å¾€ä¸ [\<Suspense>](https://juejin.cn/post/7270648629378252840#heading-4) ç»„ä»¶ä¸€èµ·ä½¿ç”¨ã€‚


ç®€å•ä½¿ç”¨ï¼š

```js
const MarkdownPreview = lazy(() => import('./MarkdownPreview.js'));
```

### æ¥å—å‚æ•°

æ¥å—ä¸€ä¸ªå‡½æ•°ï¼Œè¿”å› Promise æˆ–è€… å…¶ä»–ç±» *thenable* çš„å¼‚æ­¥å‡½æ•°ã€‚React é»˜è®¤ä¸ä¼šå»åŠ è½½ lazy åŒ…è£¹çš„ç»„ä»¶ï¼Œé™¤éæ˜ç¡®çš„åœ¨ç•Œé¢ä¸Šéœ€è¦æ¸²æŸ“ä»–ã€‚å½“å¼€å§‹åŠ è½½æ—¶ï¼ŒReact ä¼šç­‰å¾…å…¶è§£æï¼Œè§£æè¿‡ç¨‹ä¸­ç”± Suspense æä¾›è¿‡æ¸¡å“åº”ï¼Œè§£æå®Œæ¯•åå³å¯æ¸²æŸ“ã€‚è¿”å›çš„ Promise å’Œ Promise ä¸­ resolve çš„å€¼éƒ½ä¼šè¢«ç¼“å­˜ï¼ˆæ¯”å¦‚æ‰“åŒ…çš„jsæ–‡ä»¶ï¼‰ï¼Œå†æ¬¡æ¸²æŸ“å°±ä¸ä¼šé‡å¤è¯·æ±‚èµ„æºã€‚ä½†æ˜¯è¿™ä¸ªç»„ä»¶æœ¬èº«çš„é‡æ¸²æŸ“è¿˜æ˜¯ä¼šè¢«è§¦å‘ã€‚å¦‚æœè¯¥ Promise reject è¯·æ±‚ï¼Œå¼‚å¸¸ä¼šå†’æ³¡è‡³æœ€è¿‘çš„å¤„ç†å‡½æ•°ï¼ˆError Boundaryï¼‰æŠ›å‡ºã€‚

### è¿”å›å€¼

è¿”å›ä¸€ä¸ªå¯ä»¥æ¸²æŸ“åœ¨ fiber æ ‘ä¸­çš„ç»„ä»¶ã€‚

### æ³¨æ„äº‹é¡¹

- lazy è¦åœ¨ js æ¨¡å—é¡¶å±‚ä½¿ç”¨ï¼Œä¸è¦åœ¨ç»„ä»¶å†…éƒ¨ä½¿ç”¨
- 

### ä½¿ç”¨æ¡ˆä¾‹

1. åŠ¨æ€å¼•å…¥åŠ è½½

```js
const MarkdownPreview = lazy(() => import('./MarkdownPreview.js'));

<Suspense fallback={<Loading />}>
  <h2>Preview</h2>
  <MarkdownPreview />
</Suspense>
```
æ•ˆæœï¼š

åŠ è½½ä¸­ï¼š


![image.png](/img/posts/2023-9-6/2023-9-6-1.png)

åŠ è½½åï¼š

![image.png](/img/posts/2023-9-6/2023-9-6-2.png)

åŠ è½½ä¸€æ¬¡åä¾¿ä¸ä¼šå†å‡ºç° loading

2. è·¯ç”±æ‡’åŠ è½½

ä»‹ç»ä½œè€…åœ¨å·¥ä½œä¸­ç”¨è¿‡çš„ä¸€ä¸ªä½¿ç”¨ js æ•°ç»„é…ç½®è·¯ç”±æ‡’åŠ è½½çš„æ¡ˆä¾‹ï¼š

```jsx
// route.js
const Loadable = (Component) => (props) => (
    <Suspense fallback={<Loader />}>
      <Component {...props} />
    </Suspense>
);

const Home = Loadable(lazy(() => import('views/pages')));
const User = Loadable(lazy(() => import('views/pages/common/user')));

const routes = [
    {
      path: 'home',
      children: [
        {
          path: '/',
          element: <Home />
        }
      ]
    },
    {
      path: 'setting',
      children: [
        {
          path: 'user-setting',
          element: <User />
        }
      ]
    }
]

useRoutes(routes);

// ä½¿ç”¨
import Routes from 'route.js';

<Routes />
```
---

å®Œ ï¼1a:T18ef,æ–‡ç« ç»§æ‰¿è‡ª [è®°ä¸€æ¬¡å‰ç«¯åº”ç”¨éƒ¨ç½²åï¼Œåˆ·æ–°é™æ€èµ„æºä¸¢å¤±é—®é¢˜](https://juejin.cn/post/7269694294597287971) çš„æ–¹æ¡ˆï¼Œè¿™é‡Œæ¢ä¸€ç§å†™æ³•é‡æ–°é˜è¿°ï¼ŒåŠ ä¸Šä¸€äº›è‡ªå·±çš„æ€è€ƒå’Œå›¾æ–‡è§£é‡Šã€‚

## 1. åœºæ™¯é‡ç°

å‰ç«¯å®ç°ä¸€ä¸ªè·¯ç”±æ‡’åŠ è½½æ—¶ï¼Œç‚¹å‡» menu åˆ‡æ¢é¡µé¢æ—¶å‡ºç°èµ„æº 404 é—®é¢˜ï¼š

![image.png](/img/posts/2023-8-27/2023-8-27-1.png)

é¡¹ç›®ä¾‹å­å¦‚ä¸‹ï¼š

```js
const AFunction = lazy(() => import('./page/a.js'))
const BFunction = lazy(() => import('./page/b.js'))

function App() {

  return (
    <div className="App">
        <HashRouter basename="/">
          <Link style={{marginRight: 20}} to="/">Home</Link>
          <Link to="/about">About</Link>
          <Suspense fallback={<div>Loading...</div>}>
            <Routes>
              <Route path="/" element={<AFunction />}></Route>
              <Route path="/about" element={<BFunction />} />
            </Routes>
          </Suspense>
        </HashRouter>
    </div>
  );
}
```

ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œè®¿é—® `/` è·¯å¾„æ—¶ï¼Œ`BFunction` ç»„ä»¶æ˜¯ä¸ä¼šè¢«åŠ è½½çš„ï¼Œåªä¼šåŠ è½½ webpack å¯¹åº”è·¯ç”±çš„ chunkï¼š


![image.png](/img/posts/2023-8-27/2023-8-27-2.png)

åœ¨åˆ‡æ¢è·¯ç”±åˆ° `/about` æ—¶ï¼Œä¼šåŠ è½½è¿™ä¸ªè·¯ç”±å¯¹åº”çš„ chunk æ–‡ä»¶ï¼Œåå¤åˆ‡æ¢åˆ™ä¸ä¼šé‡å¤åŠ è½½ã€‚

é¡¹ç›®ä¸ä½¿ç”¨åœºæ™¯æè¿°å®Œæ¯•ï¼

## 2. é—®é¢˜åˆ†æ

ç†è®ºä¸Šï¼Œåˆ‡æ¢èµ„æºæ˜¯ä¼šå»æœåŠ¡å™¨è·å–åˆ°å¯¹åº” chunk çš„ js èµ„æºçš„ï¼Œå‡ºç° 404ï¼Œè¦ä¹ˆæ˜¯æœåŠ¡å™¨æ–‡ä»¶è¢«åˆ é™¤ï¼Œè¦ä¹ˆæ˜¯æ–‡ä»¶è¢«é‡æ–°æ‰“åŒ…ï¼Œhash å€¼è¢«æ”¹å˜äº†ã€‚

ç¬¬ä¸€ç§æƒ…å†µï¼Œèµ„æºè¢«åˆ é™¤æˆ‘ä»¬ä¸è€ƒè™‘ï¼Œä¸å¯æ§å› ç´ ï¼Œæˆ‘ä»¬è‡ªå·±ä¹Ÿä¸ä¼šæ²¡äº‹å»åˆ é™¤è¿˜åœ¨ä½¿ç”¨çš„èµ„æºçš„ã€‚ç¬¬äºŒç§æƒ…å†µå°±æœ‰å¯èƒ½äº†ï¼Œæˆ‘ä»¬æœ¬åœ°æ‰“äº†åŒ…ï¼Œæ›¿æ¢äº†èµ„æºæ–‡ä»¶ï¼Œæ˜¯ä¼šé€ æˆ hash å˜åŒ–çš„ï¼Œæ¯æ¬¡æ‰“åŒ…éƒ½ä¼šé’ˆå¯¹ä¸åŒçš„åˆ†åŒ… chunk æ‰“ä¸åŒçš„ hash å€¼ã€‚

## 3. é—®é¢˜åŸç†

çŸ¥é“é—®é¢˜åï¼Œæˆ‘ä»¬å°±æ¥çœ‹ä¸€ä¸‹æ‰“åŒ…éƒ¨ç½²æµç¨‹å‡ºç°äº†é‚£äº›çº°æ¼ã€‚

å‰ç«¯é¡¹ç›®ç®€æ˜“éƒ¨ç½²æµç¨‹å¦‚ä¸‹ï¼š

```mermaid
graph TD
CIæ‰“åŒ… --> æœåŠ¡å™¨èµ„æºæ–‡ä»¶æ›¿æ¢
æœåŠ¡å™¨èµ„æºæ–‡ä»¶æ›¿æ¢ --> æµè§ˆå™¨è·å–èµ„æº
```

![](/img/posts/2023-8-27/2023-8-27-3.png)

è€Œæ‰“åŒ…åç›®å‰åœ¨èµ„æºæœåŠ¡å™¨å­˜æ”¾ç›®å½•å¦‚ä¸‹ï¼š

```shell
â”œâ”€console-fe
â”‚  â”œâ”€bundle
â”‚  â”œâ”€static
â”‚  â”œâ”€main.sdf67hda.js
â”‚  â””â”€index.html
```

`index.html` é‡Œå¼•å…¥äº†è¯¥æ¬¡æ‰“åŒ…çš„å…¥å£æ–‡ä»¶ï¼š`main.[hash].js`ï¼Œstatic æ˜¯é™æ€èµ„æºæ–‡ä»¶å¤¹ï¼Œbundle æ˜¯æ‰“åŒ…å¥½çš„ js æ–‡ä»¶å¤¹ã€‚

ç”±äº æµè§ˆå™¨æœ‰ç¼“å­˜ï¼Œåœ¨ç”¨æˆ·å·²ç»æ¸²æŸ“å‡º index.html åä¼šäº§ç”Ÿç¼“å­˜ï¼ˆæ¯”å¦‚å…¥å£ main.28cb0dcd.jsï¼‰ï¼Œç”¨æˆ·æ™®é€šåˆ·æ–°é¡µé¢æ—¶ï¼Œæµè§ˆå™¨é»˜è®¤å»æ‹¿ç¼“å­˜çš„ å…¥å£ jsï¼Œè€Œåˆ†å‘çš„å„ä¸ª chunk è·¯å¾„æ˜¯å†™åœ¨ å…¥å£ js æ–‡ä»¶çš„ï¼Œæ‰€ä»¥å°±æ‹¿ä¸åˆ°äº†ã€‚


ç”¨æµç¨‹å›¾æè¿°å¦‚ä¸‹ï¼š

```mermaid
journey
title  å‰ç«¯èµ„æºéƒ¨ç½²ä¸ç”¨æˆ·è®¿é—®ä¸åŒæ­¥
section å‘å¸ƒé˜¶æ®µ
æ‰“åŒ…: 5: æ—§ç‰ˆæœ¬
èµ„æºæ›¿æ¢: 5: æ—§ç‰ˆæœ¬
æ›´æ–°æœåŠ¡å™¨: 3: å¯èƒ½å‡ºç°é—®é¢˜
section å‘å¸ƒå®Œæˆå
ç”¨æˆ·åˆ·æ–°é¡µé¢: 3: å¼ºåˆ·æ­£å¸¸
ç”¨æˆ·ä¸åˆ·æ–°ï¼ŒåŸåœ°ç‚¹å‡»è·¯ç”±èµ„æº: 1: ç‰ˆæœ¬ä¸¢å¤± 404
```

![](/img/posts/2023-8-27/2023-8-27-4.png)

## 4. è§£å†³æ–¹æ¡ˆ

1. å–æ¶ˆç¼“å­˜ index.html


æˆ‘ä»¬è¯•ç€ä»æœåŠ¡ç«¯æç¤ºé˜»æ­¢ index.html ç¼“å­˜ï¼š

```shell
# nginx
location ~ \.html$ { add_header Cache-Control "no-cache, no-store, must-revalidate"; }
```

å†æ¬¡éƒ¨ç½²åï¼Œå‘ç°åˆ·æ–°é¡µé¢çš„æƒ…å†µå¯ä»¥æ‹¿åˆ°æ–°çš„èµ„æºäº†ï¼Œä½†æ˜¯å¦‚æœç”¨æˆ·åœç•™åœ¨è€é¡µé¢ï¼ŒåŸåœ°ç‚¹å‡»è·¯ç”±è·³è½¬è¿˜æ˜¯ä¸è¡Œã€‚è¿™ä¸ªæƒ³æƒ³ä¹Ÿæ˜¯å¯ä»¥ç†è§£çš„ï¼Œæ²¡æœ‰åˆ·æ–°ï¼Œå…¥å£ main.js æ²¡æœ‰æ”¹å˜ï¼Œæ‰€ä»¥è¿˜éœ€è¦ç‰¹æ®Šå¤„ç†ã€‚

2. å‰åç«¯ç»Ÿä¸€ç‰ˆæœ¬å·ï¼Œè·³è½¬æ—¶æç¤ºéœ€è¦æ›´æ–°

åç«¯è¿”å›çš„ API ä¸­ä¼šå¸¦ç€çº¦å®šå¥½çš„é€‚ç”¨äºå‰ç«¯çš„ç‰ˆæœ¬å·ï¼Œè€Œå‰ç«¯æ‰“åŒ…æ—¶ä¹Ÿä¼šé€šè¿‡ CI å†™å…¥è¯¥ç‰ˆæœ¬ï¼ˆå¯ä»¥æ˜¯ reduxã€ cookie æˆ–è€… æœ¬åœ°å­˜å‚¨ç­‰ï¼‰ï¼Œåœ¨ä»»ä¸€è¯·æ±‚ API çš„åœ°æ–¹ï¼Œå‰ç«¯ç»Ÿä¸€æ‹¦æˆªæ¯”å¯¹ä¸¤ä¸ªç‰ˆæœ¬å·æ˜¯å¦ç»Ÿä¸€ï¼Œè‹¥ä¸ç»Ÿä¸€åˆ™è‡ªåŠ¨åˆ·æ–°é¡µé¢ï¼Œæµç¨‹å›¾å¦‚ä¸‹ï¼š


```mermaid
graph TD
å‰ç«¯æ‰“åŒ…å†™å…¥ç‰ˆæœ¬ --> ç”¨æˆ·ç‚¹å‡»åˆ‡æ¢è·¯ç”±æ—¶è·å–APIå®æ—¶ç‰ˆæœ¬å·
ç”¨æˆ·ç‚¹å‡»åˆ‡æ¢è·¯ç”±æ—¶è·å–APIå®æ—¶ç‰ˆæœ¬å· --> ä¸å‰ç«¯ç‰ˆæœ¬å·ä¸ç›¸åŒæ—¶æç¤ºåˆ·æ–°
```
![](/img/posts/2023-8-27/2023-8-27-5.png)

è¿™ç§æ–¹æ¡ˆå°±æ˜¯ç»å¸¸è¦æç¤ºç”¨æˆ·ï¼Œåœ¨å¤šæ¬¡å‘å¸ƒæ–°ç‰ˆæœ¬æ—¶å¯¹ç”¨æˆ·ä½“éªŒä¸å¤ªå‹å¥½ï¼Œä½†æ˜¯å¯ä»¥ä¿è¯ç”¨æˆ·å§‹ç»ˆæ‹¿åˆ°æƒ³è¦çš„ç‰ˆæœ¬ã€‚

3. æœåŠ¡å™¨æ‰“åŒ…å­˜æ”¾å†å²èµ„æº

å°±åƒæ–‡ç« å¼€å¤´å¼•ç”¨æ–‡ç« æ‰€è¯´ï¼Œèµ„æºæœåŠ¡å™¨å¯ä»¥è¿™æ ·å­˜æ”¾èµ„æºï¼š

```shell
â”€console-fe
â”‚  â”œâ”€20230101
â”‚  â”‚  â”œâ”€bundle
â”‚  â”‚  â”œâ”€static
â”‚  â”‚  â””â”€main.sdf67hda.js
â”‚  â”œâ”€20230302
â”‚  â”‚  â”œâ”€bundle
â”‚  â”‚  â”œâ”€static
â”‚  â”‚  â””â”€main.qd52s5f7.js
â”‚  â”œâ”€index.html
...
```
åœ¨éƒ¨ç½²æ—¶ï¼ŒCI æ‰“åŒ…æ—¶è®¾ç½®ä¸€ä¸ªç‰ˆæœ¬ï¼š`BUILD_PATH = "20230101"`ï¼Œåœ¨é¡¹ç›®ä¸­ï¼Œåªæœ‰ä¸€ä¸ªç»Ÿä¸€çš„ `index.html`ï¼ŒCI éƒ¨ç½²æ—¶ï¼Œåœ¨è¯¥æ–‡ä»¶å†™å…¥åˆ¶å®šç›®å½•ä¸‹çš„è„šæœ¬å…¥å£ï¼š

```js
<script src="/20230302/main.qd52s5f7.js"></script>
```
è¿™æ ·ï¼Œå°±ç®—ç”¨æˆ·ä¸åˆ·æ–°é¡µé¢ï¼Œæ–°éƒ¨ç½²çš„èµ„æºä¸ä¼šå½±å“æ—§çš„èµ„æºï¼Œåªè¦æ§åˆ¶å¥½æ‰“åŒ…çš„å¤§å°ï¼Œå®šæœŸæ¸…ç†è€æ—§ç‰ˆæœ¬æ–‡ä»¶å°±å¯ä»¥äº†ã€‚

è¿™ä¸ªæ–¹æ¡ˆçš„ç¼ºç‚¹æ˜¯ç”¨æˆ·ä¾§ç‰ˆæœ¬å¯èƒ½ä¸ç»Ÿä¸€ï¼Œç”¨æˆ·å¯èƒ½ä¼šçœ‹åˆ°æ—§çš„ç‰ˆæœ¬ã€‚ä½†æ˜¯æ¥å…¥ç°åº¦ç³»ç»Ÿå°±ä¼šæ¯”è¾ƒæ–¹ä¾¿ï¼Œæœ‰åˆ©æœ‰å¼Šã€‚


**ç»¼åˆæ–¹æ¡ˆ**

ç»¼ä¸Šæ‰€è¿°ï¼Œæˆ‘ä»¬å¯ä»¥æ€»ç»“ä¸Šè¿°æ–¹æ¡ˆçš„ä¼˜ç‚¹ï¼Œæå‡ºä¸€ä¸ªç»¼åˆæ–¹æ¡ˆï¼š

- è®¾ç½®ä¸ç¼“å­˜ index.html
- CI æ‰“åŒ…æ—¶æŒ‰ç…§æ–¹æ¡ˆ3ï¼Œå®ç°å†å²èµ„æºå…±å­˜
- æ¥å…¥ç°åº¦ç³»ç»Ÿï¼Œå®ç°æ¥å£è·å–å½“å‰ç”¨æˆ·å‰ç«¯èµ„æºç›®å½•ï¼Œæ¯”å¦‚ï¼š`/20230302/main.qd52s5f7.js`
- å‰åç«¯çº¦å®šå¥½å½“å‰ç™»å½•çš„ç°åº¦ç”¨æˆ·çš„ç‰ˆæœ¬ï¼ŒAPI è¿”å›ç‰ˆæœ¬ä¿¡æ¯ã€‚

è¿™æ ·ï¼Œåœ¨ç”¨æˆ·ç¬¬ä¸€æ¬¡è¯·æ±‚é¡µé¢æ—¶ï¼Œå‰ç½®è°ƒç”¨ç°åº¦ APIï¼Œ[ç°åº¦ç³»ç»Ÿ](https://juejin.cn/post/7212054600162132029)å‘ŠçŸ¥ nginx æœåŠ¡å™¨è½¬å‘ç»™å‰ç«¯é¡µé¢ã€‚

åœ¨ç”¨æˆ·åˆ·æ–°é¡µé¢æ—¶ï¼Œä¼šå†æ¬¡è°ƒç”¨ç°åº¦ API å¹¶æ›´æ–°å‰ç«¯ç¼“å­˜ï¼Œæ‹¿åˆ°æœ€æ–°çš„èµ„æºã€‚åœ¨ç”¨æˆ·åŸåœ°ç‚¹å‡» menu è·³è½¬è·¯ç”±æ—¶ï¼Œèµ„æºä¹Ÿä¸ä¼šä¸¢å¤±ï¼Œåœ¨ API ä¸­è·å–ç°åº¦ç³»ç»Ÿä¸­ç™»å½•ç”¨æˆ·ç‰ˆæœ¬å·ï¼Œè¿”å›ç»™å‰ç«¯è¯¥çº¦å®šå¥½çš„ç‰ˆæœ¬ï¼ˆBUILD_PATHï¼‰ï¼Œå‰ç«¯åˆ¤æ–­ç‰ˆæœ¬ä¸ä¸€è‡´æ—¶æç¤ºç”¨æˆ·åˆ·æ–°æˆ–è€…è‡ªè¡Œåˆ·æ–°é¡µé¢å³å¯ã€‚

----

ä¸çŸ¥é“å¤§å®¶è¿˜æœ‰ä»€ä¹ˆæ›´å¥½çš„æ–¹æ¡ˆå—ï¼Ÿæ¬¢è¿ä¸€èµ·å­¦ä¹ äº¤æµï¼1b:T2f67,å®˜ç½‘åœ°å€ï¼š[React](https://react.dev/)


## 1. \<Profiler>
  

`<Profiler>` å¸®åŠ©å¼€å‘è€…ç¨‹å¼åŒ–åœ°è®¡ç®—æ¸²æŸ“æ€§èƒ½ã€‚

### æ¥å— props

-   `id`: æƒ³è¦æµ‹é‡æ€§èƒ½çš„ç»„ä»¶çš„å”¯ä¸€æ ‡è¯†ç¬¦
-   `onRender`: ç»„ä»¶æ ‘æ›´æ–°æ—¶è°ƒç”¨ï¼Œä¼ é€’çš„æ“¦å‡€ä¹¦ä¸­åŒ…å«æµ‹è¯•ç»„ä»¶ä¿¡æ¯å’Œæ€§èƒ½ä¿¡æ¯ã€‚å‚æ•°ä¿¡æ¯å¦‚ä¸‹ï¼š

|å‚æ•°|æè¿°|
|-|-|
|id|è¯¥æ¸²æŸ“å…ƒç´ çš„å”¯ä¸€æ ‡è¯†ï¼Œå°±æ˜¯ä½ è‡ªå·±åœ¨Profilerä¸­æ‰“çš„id|
|phase|æšä¸¾ï¼š `mount`, `update` or `nested-update`ã€‚æ ‡è¯†æ¸²æŸ“ç»„ä»¶æ¸²æŸ“çš„ç±»å‹|
|actualDuration|æ¸²æŸ“åŒ…è£¹ç»„ä»¶åŠå…¶å­ç»„ä»¶æ‰€èŠ±è´¹çš„æ¯«ç§’æ•°ã€‚è¿™å¯ä»¥æµ‹è¯•å­æ ‘åˆ©ç”¨è®°å¿†å‡½æ•°ï¼ˆä¾‹å¦‚ memo å’Œ useMemoï¼‰çš„ä½¿ç”¨æƒ…å†µã€‚ç†æƒ³æƒ…å†µä¸‹ï¼Œæ­¤å€¼åœ¨åˆå§‹æŒ‚è½½ååº”æ˜¾è‘—é™ä½ï¼Œå› ä¸ºè®¸å¤šåä»£èŠ‚ç‚¹åªéœ€è¦åœ¨å…¶ç‰¹å®šä¾èµ–å‘ç”Ÿå˜åŒ–æ—¶æ‰éœ€è¦é‡æ–°æ¸²æŸ“ã€‚|
|baseDuration|ä¼°è®¡åœ¨æ²¡æœ‰ä»»ä½•ä¼˜åŒ–çš„æƒ…å†µä¸‹é‡æ–°å‘ˆç°æ•´ä¸ªå­æ ‘æ‰€éœ€çš„æ—¶é—´çš„æ¯«ç§’æ•°ã€‚å®ƒæ˜¯é€šè¿‡æ±‡æ€»æ ‘ä¸­æ¯ä¸ªç»„ä»¶çš„æœ€æ–°æ¸²æŸ“æŒç»­æ—¶é—´æ¥è®¡ç®—çš„ã€‚æ­¤å€¼ä¼°è®¡æ¸²æŸ“çš„æœ€åæƒ…å†µæˆæœ¬ï¼ˆä¾‹å¦‚ï¼Œåˆå§‹æŒ‚è½½æˆ–æ²¡æœ‰è®°å¿†å‡½æ•°çš„æ ‘ï¼‰ã€‚å°†å®é™…æŒç»­æ—¶é—´ä¸å®ƒè¿›è¡Œæ¯”è¾ƒï¼Œçœ‹çœ‹è®°å¿†å‡½æ•°æ˜¯å¦æœ‰æ•ˆã€‚|
|startTime|react å¼€å§‹æ¸²æŸ“æ—¶çš„æ—¶é—´æˆ³|
|endTime|React å½“å‰æ›´æ–°ç»„ä»¶è¢« commit ï¼ˆç†è§£ä¸º fiber è°ƒåº¦ç»Ÿä¸€æ›´æ–°çœŸå® domï¼‰æ—¶çš„æ—¶é—´æˆ³ã€‚æ­¤å€¼åœ¨ commit ä¸­çš„æ‰€æœ‰ profiler ä¹‹é—´å…±äº«ï¼Œä»¥ä¾¿åœ¨éœ€è¦æ—¶å¯¹å®ƒä»¬è¿›è¡Œåˆ†ç»„ã€‚|

### æ³¨æ„äº‹é¡¹

æ€§èƒ½åˆ†æä¼šå¢åŠ ä¸€äº›é¢å¤–çš„å¼€é”€ï¼Œå› æ­¤é»˜è®¤æƒ…å†µä¸‹åœ¨ç”Ÿäº§ç‰ˆæœ¬ä¸­ä¼šç¦ç”¨å®ƒã€‚

### ä½¿ç”¨æ¡ˆä¾‹

1. è®¡ç®—å•ä¸ªç»„ä»¶æ¸²æŸ“æ€§èƒ½

```js
<App>
  <Profiler id="Sidebar" onRender={onRender}>
    <Sidebar />
  </Profiler>
  <PageContent />
</App>
```
æ­¤æ—¶ï¼Œä½ è¿˜å¯ä»¥åœ¨ [React Developer Tools](https://react.dev/learn/react-developer-tools) ä¸­æŸ¥çœ‹ Profiler é¡µç­¾ï¼Œé‡Œè¾¹æœ‰å…·ä½“ä¿¡æ¯ï¼š


![image.png](/img/posts/2023-8-24/2023-8-24-1.png)

2. å¤šä¸ªç»„ä»¶æ€§èƒ½æµ‹è¯•

```js
<App>
  <Profiler id="Sidebar" onRender={onRender}>
    <Sidebar />
  </Profiler>
  <Profiler id="Content" onRender={onRender}>
    <Content>
      <Profiler id="Editor" onRender={onRender}>
        <Editor />
      </Profiler>
      <Preview />
    </Content>
  </Profiler>
</App>
```
å¯ä»¥çœ‹åˆ°ï¼Œä½¿ç”¨åŒä¸€ä¸ªå‡½æ•°å°±è¡Œã€‚

> Profiler ä¼šå½±å“æ€§èƒ½ï¼Œä¸è¦åœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨


## 2. \<Suspense>

`<Suspense>` åŒ…è£¹ä¸€ä¸ªéœ€è¦æ‡’åŠ è½½çš„ç»„ä»¶ã€‚

### æ¥æ”¶ props

- `children`: æ‡’åŠ è½½çš„ç»„ä»¶ã€‚åœ¨æ¸²æŸ“è¿‡ç¨‹ä¸­ä¼šç”¨ fallback å‡½æ•°å¡«å……ç©ºç™½åŒºåŸŸ.
- `fallback`: æ‡’åŠ è½½ç»„ä»¶æ¸²æŸ“è¿‡ç¨‹ä¸­çš„æ›¿ä»£å“ï¼ˆplaceholderï¼‰ï¼Œæ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå…¶è¿”å›å€¼å¯ä»¥æ¥å—ä»»ä½•æœ‰æ•ˆçš„ React Nodeï¼Œæ¯”å¦‚ loading å›¾æ ‡æˆ–è€…éª¨æ¶å±ç­‰ã€‚å½“ ç»„ä»¶å»¶è¿ŸåŠ è½½è¿‡ç¨‹ä¸­ï¼ŒSuspense ä¼šè‡ªåŠ¨åˆ‡æ¢åˆ°Â fallbackï¼ŒåŠ è½½ç»“æŸåè‡ªåŠ¨æ¢å›åˆ° childrenã€‚å¤šå±‚ Suspense åŒ…è£¹çš„æƒ…å†µæ—¶ï¼Œä¼šå›è½åˆ°æœ€è¿‘çš„ä¸€å±‚ fallbackã€‚

### æ³¨æ„äº‹é¡¹

- React ä¸ä¼šä¸ºåœ¨é¦–æ¬¡æŒ‚è½½ä¹‹å‰è¢« Suspense çš„æ¸²æŸ“ä¿ç•™ä»»ä½•çŠ¶æ€ã€‚å½“ç»„ä»¶åŠ è½½å®Œæ¯•åï¼ŒReact å°†ä»å¤´å¼€å§‹é‡è¯•æ¸²æŸ“æŒ‚èµ·çš„æ¸²æŸ“æ ‘ã€‚
- å¦‚æœ Suspense æ¸²æŸ“æ ‘çš„å†…å®¹å·²ç»æ˜¾ç¤ºåå†æ¬¡æŒ‚èµ·ï¼Œåˆ™â€œfallbackâ€å°†å†æ¬¡æ˜¾ç¤ºï¼Œé™¤éå¯¼è‡´å®ƒçš„æ›´æ–°æ˜¯ç”±startTransition å¼•èµ·çš„ã€‚
- å¦‚æœ React éœ€è¦éšè—å·²ç»å¯è§çš„å†…å®¹ï¼Œç”±äºå®ƒå†æ¬¡æŒ‚èµ·äº†ï¼Œæ‰€ä»¥ä¼šæ¸…ç†æ¸²æŸ“æ ‘ä¸­çš„å¸ƒå±€æ•ˆæœã€‚å½“å†…å®¹å‡†å¤‡å¥½å†æ¬¡æ˜¾ç¤ºæ—¶ï¼ŒReact å°†å†æ¬¡è§¦å‘å¸ƒå±€é‡ç»˜ã€‚è¿™æ ·ï¼Œåœ¨ç»„ä»¶éšè—æ—¶å°±ä¸ä¼šå†åšå¸ƒå±€é‡ç»˜çš„è®¡ç®—äº†ã€‚
- React åœ¨ Suspense ä¸­é›†æˆäº†ä¸€äº›åº•å±‚ä¼˜åŒ–ï¼Œå¦‚*æµæœåŠ¡å™¨æ¸²æŸ“*å’Œ*é€‰æ‹©æ€§æ°´åˆ*ï¼ˆHydrationï¼‰ã€‚åœ¨æœåŠ¡ç«¯æ¸²æŸ“æ—¶å¯ä»¥ç”¨åˆ°ã€‚

> Suspense **ä¸åœ¨** Effect å‰¯ä½œç”¨ æˆ–è€… event handler ä¸­ç›‘æµ‹

### ä½¿ç”¨æ¡ˆä¾‹

1. ä½¿ç”¨ fallback çš„ loading æ•ˆæœ

```js
const [show, setShow] = useState(false);

<button onClick={() => setShow(true)}></button>
...

if (show) {
    return (
        <Suspense fallback={<Loading />}>
          <Albums artistId={artist.id} />
        </Suspense>
    )
}

...
function Loading() {
  return <h2>ğŸŒ€ Loading...</h2>;
}
```

2. ä¸€æ¬¡æ€§æ‡’åŠ è½½å¤šä¸ªç»„ä»¶

```js
<Suspense fallback={<Loading />}>
    <Biography artistId={artist.id} />
    <Panel>
      <Albums artistId={artist.id} />
    </Panel>
</Suspense>
```

è¢« Suspense åŒ…è£¹çš„èŒƒå›´è§†ä¸ºä¸€ä¸ªç»Ÿä¸€çš„æ›´æ–°å•å…ƒã€‚ä¸¤ä¸ªç»„ä»¶åªæœ‰ä¸€ä¸ªå¤„äºåŠ è½½ä¸­æ—¶ï¼Œæ•´ä¸ªæ˜¾ç¤ºéƒ½ä¼šå˜ä¸ºæŒ‡ç¤ºå™¨ fallbackã€‚åœ¨æ‰€æœ‰ç»„ä»¶å‡†å¤‡å®Œæ¯•åï¼Œä¼šä¸€æ¬¡æ€§æ¸²æŸ“å‡ºæ¥ã€‚

æ¢ç§æ€è€ƒæ–¹æ¡ˆï¼Œä¸Šé¢çš„ä»£ç æ˜¯æœ‰é—®é¢˜çš„ï¼Œå¤šä¸ªå¼‚æ­¥ç»„ä»¶ä¸å»ºè®®åˆ†å¼€å†™ï¼Œåº”è¯¥æŒ‰ç…§ä¸šåŠ¡åŒºåˆ†ï¼Œç»Ÿä¸€ä½¿ç”¨ Details ç»„ä»¶å°è£…ï¼š

```js
<Suspense fallback={<Loading />}>
  <Details artistId={artist.id} />
</Suspense>
```

3. ä½¿ç”¨åµŒå¥— Suspense

```js
<Suspense fallback={<BigSpinner />}>
    <Biography artistId={artist.id} />
    <Suspense fallback={<AlbumsGlimmer />}>
      <Panel>
        <Albums artistId={artist.id} />
      </Panel>
    </Suspense>
</Suspense>
```

ä¸Šé¢çš„ Biography ç»„ä»¶çš„åŠ è½½ä¸ä¼šå—åˆ° Albums åŠ è½½çš„å½±å“ã€‚sequence çš„è¿ä½œæµç¨‹ï¼š

- å½“ `Biography` æœªåŠ è½½æ—¶,Â ç»Ÿä¸€æ˜¾ç¤º `BigSpinner` æ–¹æ¡ˆã€‚
- ä¸€æ—¦Â `Biography`Â åŠ è½½ç»“æŸ,Â `BigSpinner`Â å°±ä¼šè¢«æ›¿æ¢æ‰ã€‚
- æ­¤æ—¶ `Albums` å¼€å§‹åŠ è½½Â `AlbumsGlimmer`Â æ˜¾ç¤ºåœ¨å¯¹åº”åŒºåŸŸã€‚
- ä¸€æ—¦Â `Albums`Â åŠ è½½ç»“æŸï¼Œåˆ™ç»“æŸæ¸²æŸ“ã€‚

Suspense è¾¹ç•Œè®¾ç½®å°±ç±»ä¼¼äºå †æ ˆçš„ pop æ“ä½œï¼Œæ˜¯æœ‰å±‚çº§å…³ç³»çš„ï¼Œæœ€ä¸Šå±‚çš„æœ€å…ˆåŠ è½½ã€‚ç†è®ºä¸Š Suspense å¯ä»¥ç”¨åœ¨ä»»ä¸€ä¸ªç»„ä»¶çš„ä»»ä½•ä¸€ä¸ªåœ°æ–¹ï¼Œä½†æ˜¯ä¸å»ºè®®åœ¨å„ä¸ªä¸šåŠ¡ç»„ä»¶å¹¿æ³›çš„ä½¿ç”¨ï¼Œå…·ä½“çš„ç”¨æˆ·ä½“éªŒè®¾è®¡ä¸­çš„æ¸²æŸ“é¡ºåºåº”è¯¥ç»†ç²’åº¦åˆ°å…·ä½“çš„ç»„ä»¶æ§åˆ¶å‡½æ•°ï¼ˆusetate/useEffect ç­‰ï¼‰ï¼Œè€Œä¸æ˜¯ä½¿ç”¨æ‡’åŠ è½½æŠ€æœ¯ã€‚

4. è¾“å…¥æ¡†è¾“å…¥æ—¶ï¼Œå‰ç«¯æ¨¡æ‹Ÿå¼‚æ­¥æŸ¥è¯¢æœç´¢ç»“æœ

å¦‚ä¸‹ï¼š

```js
const [query, setQuery] = useState('');
...
<>
  <label>
    Search albums:
    <input value={query} onChange={e => setQuery(e.target.value)} />
  </label>
  <Suspense fallback={<h2>Loading...</h2>}>
    <SearchResults query={query} />
  </Suspense>
</>
```
ä¸Šé¢çš„ä¾‹å­ï¼ŒsetQuery è§¦å‘äº†ç»„ä»¶çš„é‡æ¸²æŸ“ï¼ŒSearchResults å°±ä¼šå‡ºç°åŠ è½½ç•Œé¢ã€‚è¿™å¯ä»¥ç”¨æ¥åœ¨å‰ç«¯æœç´¢çš„ç»„ä»¶ä¸­æ¨¡æ‹ŸåŠ è½½åŠ¨ç”»ã€‚

å½“ç„¶ï¼Œä½ è¿˜å¯ä»¥ä½¿ç”¨ useDeferredValue æ¥sä½¿UIæ¸²æŸ“æ›´æµç•…ï¼š

```js
const deferredQuery = useDeferredValue(query);

...
// ä¸€ä¸ªåŠé€æ˜çš„åŠ è½½åŠ¨ç”»
<div style={{
  opacity: query !== deferredQuery ? 0.5 : 1 
}}>
    <SearchResults query={deferredQuery} />
</div>
```

5. é˜»æ­¢å·²æ¸²æŸ“å…ƒç´ è¢«éšè— [ä¾‹å­](https://codesandbox.io/s/s5tn9m?file=%2FApp.js&utm_medium=sandpack)

æˆ‘ä»¬å¯ä»¥è¿™æ ·å†™æ¥æ‡’åŠ è½½ä¸€ä¸ªè·¯ç”± ï¼š

```js
export default function App() {
  return (
    <Suspense fallback={<BigSpinner />}>
      <Router />
    </Suspense>
  );
}

function Router() {
  const [page, setPage] = useState('/');
  const [isPending, startTransition] = useTransition();

  function navigate(url) {
    startTransition(() => {
      setPage(url);
    });
  }

  let content;
  
  // å¤„ç†æ¨¡æ‹Ÿè·¯ç”±é€»è¾‘èµ‹å€¼å¹¶contentçš„æ“ä½œçœç•¥
  
  return (
    <Layout isPending={isPending}>
      {content}
    </Layout>
  );
}
``` 

ä¸Šé¢çš„ä¾‹å­ï¼Œä½ å¯èƒ½ä¼šè®¤ä¸ºç»„ä»¶åŠ è½½æ—¶ï¼Œ Layout ç»„ä»¶ä¹Ÿä¼šæ¶ˆå¤±å¹¶æ›¿æ¢ä¸º BigSpinnerã€‚ ä½†æ˜¯ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œè¢«åŒ…è£¹çš„ç»„ä»¶ä½¿ç”¨äº† `startTransition`ï¼Œè¿™å‘Šè¯‰ Reactï¼Œ Router ç»„ä»¶çš„æ¸²æŸ“ä¸æ˜¯ç´§æ€¥çš„ï¼Œå¯ä»¥ç¼“ä¸€ç¼“ï¼Œæ­¤æ—¶ï¼Œåœ¨ä¸‹ä¸€æ¬¡æ¸²æŸ“ç»“æŸä¹‹å‰ï¼Œç•Œé¢ä¼šä¿ç•™ä¸Šä¸€æ¬¡æ¸²æŸ“çš„å›¾å½¢ã€‚æ‰€ä»¥å³ä½¿ Suspense åŒ…è£¹äº†æœ€å¤–å±‚ï¼Œä½† Layout ç»„ä»¶å¹¶ä¸ä¼šé‡æ¸²æŸ“ï¼Œç›´åˆ°ä¸‹ä¸€æ¬¡æ¸²æŸ“ç»“æŸåæ‰å˜åŒ–ã€‚

6. åœ¨ navigate æ—¶é‡ç½® Suspense

ä¸Šé¢çš„ä¾‹å­æˆ‘ä»¬çŸ¥é“ï¼Œåœ¨ transition æ¸²æŸ“é˜¶æ®µï¼ŒUI ä¼šé¿å…éšè—æ‰å·²ç»æ¸²æŸ“å‡ºæ¥çš„æ•°æ®ï¼Œä½†æ˜¯åœ¨è·¯ç”±å¯¼èˆªæ—¶ï¼Œæ°æ°éœ€è¦å‘Šè¯‰ React ç»™æˆ‘ç«‹å³é”€æ¯åŸæ¥çš„æ•°æ®å¹¶å±•ç¤ºä½ å‡†å¤‡å¥½çš„ fallbackã€‚ä½ å¯ä»¥è¿™æ ·åšï¼š

```jsx
<ProfilePage key={queryParams.id} />
```

æˆ‘ä»¬ä¸¾ä¸€ä¸ªä½¿ç”¨åœºæ™¯ä¾‹å­ï¼Œä¸€ä¸ªç”¨æˆ·çš„ ProfilePage ä¸å¦ä¸€ä¸ªç”¨æˆ·çš„ ProfilePage å†…å®¹ä¸åŒã€‚é€šè¿‡æŒ‡å®šä¸€ä¸ªé”®ï¼Œä½ å¯ä»¥ç¡®ä¿ React å°†ä¸åŒç”¨æˆ·çš„ ProfilePage è§†ä¸ºä¸åŒçš„ç»„ä»¶ï¼Œå¹¶åœ¨å¯¼èˆªè¿‡ç¨‹ä¸­é‡ç½® Suspense è¾¹ç•Œã€‚

> ä¸Šé¢æ˜¯å®˜ç½‘çš„è§£é‡Šï¼Œç”¨äººè¯è¯´ï¼Œå°±æ˜¯ key å˜åŒ–äº†ï¼Œtransition ä¸ä¼šç¼“å­˜åŸæ¥æ¸²æŸ“çš„ UI äº†ï¼Œè€Œæ˜¯éšç€è·¯ç”±åˆ‡æ¢è¿›å…¥æ‡’åŠ è½½çš„ fallback

7. æ˜¾ç¤ºæœåŠ¡å™¨é”™è¯¯

å¦‚æœä½ ä½¿ç”¨äº†æœåŠ¡ç«¯æ¸²æŸ“ï¼Œå¹¶ä¸”ä¸€ä¸ªç»„ä»¶åœ¨æœåŠ¡ç«¯æŠ¥äº†é”™åï¼ŒReact ä¸ä¼šç»ˆæ­¢æœåŠ¡ç«¯çš„æ¸²æŸ“ï¼Œè€Œæ˜¯å¾€ä¸Šå±‚æ‰¾æœ€è¿‘çš„\<Suspense>ï¼Œä½¿ç”¨å…¶ fallback è¿›è¡Œæ›¿æ¢é”™è¯¯åŒºåŸŸï¼›å¦ä¸€æ–¹é¢ï¼Œåœ¨å®¢æˆ·ç«¯å‡ºç°é”™è¯¯åï¼Œå®¢æˆ·ç«¯ä¼šç›´æ¥æŠ›å‡ºé”™è¯¯ï¼Œå¦‚æœå®¢æˆ·ç«¯å¹¶æœªå‡ºç°é”™è¯¯ï¼Œåˆ™ç”¨æˆ·æ— æ³•æ„ŸçŸ¥æœåŠ¡ç«¯å‡ºé”™äº†ã€‚

å¯ä»¥åœ¨æœåŠ¡ç«¯ä½¿ç”¨å¦‚ä¸‹ä»£ç ï¼š

```js
<Suspense fallback={<Loading />}>
  <Chat />
</Suspense>

function Chat() {
  if (typeof window === 'undefined') {
    throw Error('Chat should only render on the client.');
  }
  // ...
}
```
æ­¤æ—¶ï¼Œåœ¨æœåŠ¡ç«¯åˆ™ä¼šæŠ›å‡ºé”™è¯¯ï¼Œåœ¨å®¢æˆ·ç«¯åˆ™æ­£å¸¸æ˜¾ç¤º Chatã€‚

8. åšå…¨å±€è·¯ç”±æ‡’åŠ è½½

å¯ä»¥ç»“åˆ lazy ä½¿ç”¨ï¼Œåšè·¯ç”±çš„æ‡’åŠ è½½æ¥æé«˜é¡µé¢æ€§èƒ½ï¼š

```js
const container = document.getElementById('root');
const root = createRoot(container); // createRoot(container!) if you use TypeScript

root.render(
  <BrowserRouter basename={config.basename}>
    <CustomRoutes />
  </BrowserRouter>
);
```

åœ¨ `<CustomRoutes />` ä¸­ï¼š

```js
const Home = lazy(() => import('./Home'))
const About = lazy(() => import('./About'))

<Routes>
  <Suspense fallback={<Loading type="home" />}>
    <Route path="/" element={<Home />} />
  </Suspense>
  <Suspense fallback={<Loading type="about" />}>
    <Route path="about" element={<About />} /> 
  </Suspense>
</Routes>
```
ä¸Šé¢çš„ä¾‹å­ï¼Œåœ¨ location pathname åˆ‡æ¢æ—¶ï¼Œä¼šåŠ è½½ä¸åŒçš„ fallback åŠ è½½åŠ¨ç”»ï¼ŒåŠ è½½ç»“æŸåï¼Œæ˜¾ç¤ºå¯¹åº”çš„æ¸²æŸ“å…ƒç´ ã€‚

----

æ­¤å¤–ï¼Œ react ä¸­è¿˜æœ‰ä¸¤ä¸ªç»„ä»¶ï¼š`<Fragment>`,`<StrictMode>`ï¼Œå› ä¸ºåŠŸèƒ½æ¯”è¾ƒå•ä¸€ï¼ŒèŒ„ä½¿ç”¨è¾ƒä¸ºç®€å•ï¼Œè¿™é‡Œåšç®€å•æè¿°ã€‚

## 3. \<Fragment>

ç”±äº react æ¸²æŸ“å¿…é¡»æœ‰ä¸€ä¸ªæ ¹ç»„ä»¶ï¼Œä½†æ˜¯åˆä¸æƒ³ç ´ååŸæ¥çš„ dom ç»“æ„ï¼Œreact å®ç°äº†è¿™ä¹ˆä¸ªè™šæ‹Ÿçš„å®¹å™¨ã€‚ä½¿ç”¨æ–¹å¼å¦‚ä¸‹ï¼š

```js
function Post() {
  return (
    <>
      <PostTitle />
      <PostBody />
    </>
  );
}
```
åœ¨ fiber å®é™…æ¸²æŸ“çœŸå® dom æ—¶ï¼ŒFragment ä¼šè¢«æ¸…é™¤æ‰ï¼Œä¸ä¼šå ç”¨ dom æ ‘ç©ºé—´ã€‚å½“éœ€è¦å†å¾ªç¯åˆ—è¡¨ä¸­ä½¿ç”¨æ—¶ï¼Œå¾€å¾€éœ€è¦æ·»åŠ å…ƒç´ çš„ key å±æ€§ï¼Œè¿™å°±ä¸èƒ½ä½¿ç”¨åŒ¿åæ ‡ç­¾ï¼Œè€Œè¦ä½¿ç”¨å…¨åï¼š

```js
function Blog() {
  return posts.map(post =>
    <Fragment key={post.id}>
      <PostTitle title={post.title} />
      <PostBody body={post.body} />
    </Fragment>
  );
}
```

> Fragment æ²¡æœ‰ä»»ä½•å±æ€§ï¼Œæ·»åŠ æ ·å¼ä¹Ÿæ˜¯ä¸ä¼šç”Ÿæ•ˆçš„ã€‚ä¸€çº§ Fragment çš„æ¸²æŸ“ä¸ä¼šè§¦å‘ç»„ä»·é‡æ¸²æŸ“ï¼Œä½†æ˜¯å¤šçº§ Fragment åˆ™ä¼šå¯¼è‡´é‡æ¸²æŸ“ï¼Œä¾‹å¦‚ä» `<><><Child /></></>` åˆ° `<Child />`ï¼Œå­ç»„ä»¶ state ä¼šé‡ç½®ã€‚

## 4. \<StrictMode>

å¸®åŠ©åœ¨å¼€å‘æ¨¡å¼å‘ç°æ›´å¤šçš„æ½œåœ¨ bugã€‚ä½¿ç”¨æ–¹å¼ï¼š

```js
const root = createRoot(document.getElementById('root'));
root.render(
  <StrictMode>
    <App />
  </StrictMode>
);
```

ä¸¥æ ¼æ¨¡å¼ä¸‹ï¼Œå¼€å‘ç¯å¢ƒä¼šæœ‰å¦‚ä¸‹å˜åŒ–ï¼š

-   ç»„ä»¶éƒ½ä¼šè¢«æ¸²æŸ“ä¸¤æ¬¡ï¼Œä»¥å‘ç°ä¸€äº›éçº¯å‡½æ•°ã€‚ä¾‹å¦‚ï¼š

```js
// é”™è¯¯å†™æ³•
export default function StoryTray({ stories }) {
  const items = stories;
  items.push({ id: 'create', label: 'Create Story' });
  return (
    <ul>
      {items.map(story => (
        <li key={story.id}>
          {story.label}
        </li>
      ))}
    </ul>
  );
}
```
-   å‰¯ä½œç”¨å‡½æ•°ä¼šè¢«æ‰§è¡Œä¸¤éï¼Œä»¥å‘ç°æ²¡æœ‰è¢«æ¸…ç†ï¼ˆclean upï¼‰çš„å‰¯ä½œç”¨è®¢é˜…ã€‚
-   ä¼šæ£€æŸ¥æ˜¯å¦ç”¨äº†ä¸€äº›ä¸åˆé€‚çš„ APIï¼Œæ¯”å¦‚ findDOMNode

å½“ç„¶ï¼Œä¸¥æ ¼æ¨¡å¼ä¹Ÿå¯ä»¥éƒ¨åˆ†åŠ åœ¨å±€éƒ¨ç»„ä»¶ä¸Šï¼š

```js
<StrictMode>
    <main>
      <Sidebar />
      <Content />
    </main>
</StrictMode>
```
----

å®Œï¼ï¼1c:T2df4,å®˜ç½‘åœ°å€ï¼š[React](https://react.dev/)


## 1. useTransition

useTransition å¯ä»¥è®©ä½ ä¸é˜»å¡ UI æ¸²æŸ“æ¥æ›´æ–° state çš„å€¼ã€‚å¯ä»¥ç†è§£ä¸ºå®ç°æ›´æµç•…çš„é¡µé¢è¿‡æ¸¡ã€‚ä½¿ç”¨æ–¹å¼ä¸ºï¼š

```js
// ä¸€ä¸ªåˆ‡æ¢ tab é¡µç­¾çš„ä¾‹å­
function TabContainer() {
  const [isPending, startTransition] = useTransition();
  const [tab, setTab] = useState('about');

  function selectTab(nextTab) {
    startTransition(() => {
      setTab(nextTab);
    });
  }
  // ...
}
```

å…¶ä¸­ï¼š

- isPendingï¼šä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºå½“å‰æ˜¯å¦é˜»å¡
- startTransitionï¼šå¼€å¯è¿‡æ¸¡ï¼Œå¹¶å¯ä¿®æ”¹ state

### æ³¨æ„äº‹é¡¹

- ä½œä¸ºä¸€ä¸ª hookï¼Œåªèƒ½åœ¨å‡½æ•°å¼ç»„ä»¶æˆ–è€…è‡ªå®šä¹‰ hook é‡Œè¢«è°ƒç”¨ï¼Œå¦‚æœæƒ³è¦å•ç‹¬ä½œä¸º API è°ƒç”¨ï¼Œå¯ä½¿ç”¨ [`startTransition`](https://react.dev/reference/react/startTransition)
- ä»…ä»…å¯ä»¥åœ¨ setState ä¸­è§¦å‘ï¼Œè‹¥æƒ³è¦åœ¨ props å˜åŒ–åè§¦å‘ï¼Œéœ€ä½¿ç”¨ [`useDeferredValue`](https://react.dev/reference/react/useDeferredValue)
- startTransition é‡Œçš„æ–¹æ³•ä¸èƒ½æœ‰å¼‚æ­¥å‡½æ•°ï¼Œè®¾ç½®å¼‚æ­¥ä¼šæ‰“ä¹±æ¸²æŸ“é¡ºåºï¼Œè¿™ä¸ªæ¸²æŸ“å°±å¤±å»ä½œç”¨äº†ã€‚
- æ ‡è®°ä¸º transition çš„ state ä¼šè¢«å…¶ä»– state çš„æ›´æ–°æ‰“æ–­ã€‚å¦‚æœæ‚¨åœ¨ transition ä¸­æ›´æ–°å›¾è¡¨ç»„ä»¶ï¼Œä½†åœ¨å›¾è¡¨å¤„äºé‡æ–°æ¸²æŸ“è¿‡ç¨‹ä¸­å¼€å§‹åœ¨å¦å¤–çš„ input ä¸­é”®å…¥è¾“å…¥ï¼Œåˆ™ React å°†åœ¨å¤„ç†è¾“å…¥æ›´æ–°åé‡æ–°å¯åŠ¨å›¾è¡¨ç»„ä»¶çš„æ¸²æŸ“å·¥ä½œã€‚
- ä¸èƒ½ç”¨äºæ§åˆ¶æ–‡æœ¬è¾“å…¥
- å¦‚æœæœ‰å¤šä¸ªæ­£åœ¨è¿›è¡Œçš„ transitionï¼ŒReact ç›®å‰ä¼šå°†å®ƒä»¬æ‰¹å¤„ç†åœ¨ä¸€èµ·ã€‚æ­¤åŠŸèƒ½å¯èƒ½ä¼šåœ¨å°†æ¥çš„ç‰ˆæœ¬ä¸­åˆ é™¤

### ä½¿ç”¨æ¡ˆä¾‹

1. åˆ‡æ¢ tab å¡é¡¿é—®é¢˜ï¼š

è¿™é‡Œæœ‰å‡ ä¸ªtabï¼Œtabå†…å®¹å¦‚ä¸‹ï¼š

```js
// tab 1 ä¸€ä¸ªæŒ‰é’®
<button onClick={() => {
  onClick();
}}>
  {children}
</button>

// tab 2 ä¸€ä¸ª p
return (
    <p>Welcome to my profile!</p>
);

// tab 3 ä¸€ä¸ªå¤æ‚åˆ—è¡¨
let items = [];
for (let i = 0; i < 500; i++) {
    items.push(<SlowPost key={i} index={i} />);
}
return (
    <ul className="items">
      {items}
    </ul>
);

function SlowPost({ index }) {
  let startTime = performance.now();
  while (performance.now() - startTime < 1) {
    // äººä¸ºæ¨¡æ‹Ÿçš„å¡é¡¿
  }

  return (
    <li className="item">
      Post #{index + 1}
    </li>
  );
}
```

å¯ä»¥çœ‹åˆ°ï¼Œtab3åŒ…å« 500 ä¸ªå…ƒç´ ï¼Œé¡µé¢æ¸²æŸ“åŠ¿å¿…ä¼šå¡é¡¿1-2ç§’ï¼Œæˆ‘ä»¬å†™ä¸€ä¸ª tab åˆ‡æ¢ç»„ä»¶ï¼š

```js
export default function TabContainer() {
  const [isPending, startTransition] = useTransition();
  const [tab, setTab] = useState(1);

  function selectTab(nextTab) {
    setTab(nextTab);      
  }

  return (
    <>
      <TabButton
        isActive={tab === 1}
        onClick={() => selectTab(1)}
      >
        About
      </TabButton>
      ...
      <TabButton
        isActive={tab === 3}
        onClick={() => selectTab(3)}
      >
        Posts (slow)
      </TabButton>
      ...
    </>
  );
}
```
ä¸Šé¢çš„ä¾‹å­ï¼ŒTabButton æ˜¯ä¸€ä¸ªå…¬å…±å­ç»„ä»¶ï¼Œæ˜¯å‡ ä¸ªé¡¶éƒ¨çš„æŒ‰é’®ï¼Œç”¨äºæ¥å—äº‹ä»¶åˆ‡æ¢ tabï¼š

```js
<button onClick={() => {
  // è°ƒç”¨çˆ¶ç»„ä»¶TabContainerçš„ selectTab æ–¹æ³•
  onClick();
}}>
  {children}
</button>
```

Posts é¡µç­¾ï¼ˆtab3ï¼‰åœ¨ active çš„æ—¶å€™å°±ä¼šåŠ è½½æ¸²æŸ“ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹é¡µé¢çš„ååº”ï¼š


![image.png](/img/posts/2023-8-18/2023-8-18-1.png)

æˆ‘ä»¬æ¥å…¥ useTransition è¯•è¯•ï¼š

```js
const [isPending, startTransition] = useTransition();
  const [tab, setTab] = useState('about');

  function selectTab(nextTab) {
    startTransition(() => {
      setTab(nextTab);      
    });
  }
```

å†æ¬¡åˆ‡æ¢ tab çœ‹çœ‹æ•ˆæœï¼š

![image.png](/img/posts/2023-8-18/2023-8-18-2.png)

æˆªå›¾çœ‹çš„ä¸æ˜æ˜¾ï¼Œæˆ‘åœ¨å›¾ä¸ŠæŠŠæ•ˆæœç”¨æ–‡å­—æ ‡è¯†å‡ºæ¥äº†ã€‚ä¹Ÿå°±æ˜¯è¯´è·Ÿ startTransition ç›¸å…³çš„ state çš„å˜åŒ–å¼•èµ·çš„æ¸²æŸ“éƒ½ä¼šè¿›å…¥è¿‡æ¸¡ä¸­ã€‚

2. å­ç»„ä»¶æ›´æ”¹çˆ¶ç»„ä»¶ state

ä¸Šé¢çš„ä¾‹å­ï¼Œä½ ä¹Ÿå¯ä»¥å°†æ›´æ”¹ state çš„æ“ä½œæ”¾åœ¨å­ç»„ä»¶ä¸­ï¼Œæ•ˆæœæ˜¯ä¸€æ ·çš„ã€‚æˆ‘ä»¬æ”¹å†™ tabButton ç»„ä»¶ï¼š

```js
<button onClick={() => {
  startTransition(() => {
    // è°ƒç”¨çˆ¶ç»„ä»¶TabContainerçš„ selectTab æ–¹æ³•
    onClick();
  });
}}>
  {children}
</button>
```
è€Œåœ¨çˆ¶ç»„ä»¶ä¸­ï¼Œå°±å¯ä»¥ç›´æ¥è®¾ç½® state äº†ï¼š

```js
function selectTab(nextTab) { 
  setTab(nextTab); 
}
```

3. é¡µé¢ä¸Šæ˜¾ç¤ºé˜»å¡æ¸²æŸ“æ—¶çš„è¿›åº¦

è¿™ä¸ªå°±æ˜¯ useTransition çš„è¿”å›å€¼ isPending çš„åº”ç”¨ï¼Œä»–ä¸º true æ—¶è¡¨ç¤ºè¿™ä¸ªè¿‡æ¸¡åŠ¨ç”»è¿˜åœ¨è¿›è¡Œä¸­ã€‚

```js
const [isPending, startTransition] = useTransition();
 
if (isPending) {
  return <b className="pending">{children}</b>;
}
```

4. ä¸ Suspends ç»“åˆï¼Œåšç»„ä»¶æ‡’åŠ è½½

æ²¿ç”¨ç¬¬äºŒä¸ªä¾‹å­çš„ä»£ç ï¼Œå­ç»„ä»¶tabButtonå®ç°useTransitionï¼Œæˆ‘ä»¬åªæ”¹çˆ¶ç»„ä»¶ï¼š

```js
<Suspense fallback={<h1>ğŸŒ€ Loading...</h1>}>
  <TabButton
    isActive={tab === 'about'}
    onClick={() => setTab('about')}
  >
    About
  </TabButton>
  ...
</Suspense>
```
è¿™æ ·åœ¨ç¬¬ä¸€æ¬¡åŠ è½½æ—¶å°±ä¼šå‡ºç° fallbackæç¤ºï¼š


![image.png](/img/posts/2023-8-18/2023-8-18-3.png)

ä½¿ç”¨ Suspense çš„å¥½å¤„åœ¨äºï¼Œå¤æ‚ç»„ä»¶åªéœ€åŠ è½½ä¸€æ¬¡ï¼Œç¬¬äºŒæ¬¡åˆ‡æ¢åŠ è½½æ—¶å°±è¢«ç¼“å­˜äº†ï¼Œå¯ä»¥å¾ˆå¿«çš„æ¸²æŸ“.

5. è‡ªå®šä¹‰ä¸€ä¸ªè‡ªå·±çš„ react è·¯ç”±ï¼ï¼ˆå½“ç„¶ä¸æ˜¯çœŸçš„è·¯ç”±ï¼‰


æˆ‘ä»¬å¯ä»¥åƒä¸‹é¢è¿™æ ·å®šä¹‰ä¸€ä¸ª Router å‡½æ•°ï¼š

```js
function Router() {
  const [page, setPage] = useState('/');
  const [isPending, startTransition] = useTransition();

  function navigate(url) {
    startTransition(() => {
      setPage(url);
    });
  }

  let content;
  if (page === '/') {
    content = (
      <IndexPage navigate={navigate} />
    );
  } else if (page === '/the-beatles') {
    content = (
      <ArtistPage
        artist={{
          id: 'the-beatles',
          name: 'The Beatles',
        }}
      />
    );
  }
  return (
    <Layout isPending={isPending}>
      {content}
    </Layout>
  );
}
```
æ¥åˆ†æä¸€ä¸‹ï¼Œä¸Šé¢ Layout ç»„ä»¶æ˜¯è‡ªå·±å®šä¹‰çš„ä¸€ä¸ªå®¹å™¨ç»„ä»¶ï¼Œå†…éƒ¨ç›´æ¥æŠ›å‡º children å±æ€§å³å¯ï¼›ä¸Šé¢åˆ¤æ–­å½“å‰çš„çŠ¶æ€ page æ˜¯ `'/the-beatles'` å’Œ `'/'` æ—¶ï¼Œè‡ªåŠ¨æ¸²æŸ“ä¸åŒçš„ç»„ä»¶ï¼›å…¶ä¸­ï¼Œ`navigate` å‡½æ•°ç”¨äºå¯¼èˆªè·³è½¬ï¼Œä»–å…¶å®æ“ä½œçš„å°±æ˜¯ä¸€ä¸ªå¸¦ Transition çš„ setPageï¼Œè¿™æ ·å°±å®ç°äº†ä¸€ä¸ªå¹³æ»‘çš„è·¯ç”±åˆ‡æ¢ã€‚


### Q&A

1. ä¸ºå•¥æˆ‘çš„ input ä¸­ useTransition ä¸ç”Ÿæ•ˆï¼Ÿï¼Ÿ

å› ä¸ºä½ è¯•å›¾ç”¨ä»–æ¥æ§åˆ¶è¾“å…¥æ¡†ï¼Œè¿™æ˜¯ä¸æ”¯æŒçš„ï¼š

```js
const [text, setText] = useState('');
// ...
function handleChange(e) {
  // âŒ Can't use transitions for controlled input state
  startTransition(() => {
    setText(e.target.value);
  });
}
// ...
return <input value={text} onChange={handleChange} />;
```
è¿™æ˜¯å› ä¸º useTransition æ˜¯éé˜»å¡æ¸²æŸ“çš„ï¼Œä½†æ˜¯è¾“å…¥æ¡†æ¯”è¾ƒç‰¹æ®Šï¼Œä»–çš„ change äº‹ä»¶å¿…é¡»æ˜¯åŒæ­¥æ›´æ–°çš„ï¼Œå¦‚æœä½ éè¦ä½¿ç”¨å¹³æ»‘è¿‡æ¸¡æ¥æ§åˆ¶è¾“å…¥ç»„ä»¶ï¼Œæœ‰å¦‚ä¸‹ä¸¤ç§æ–¹æ¡ˆï¼š

- å®šä¹‰ä¸¤ä¸ª stateï¼Œä¸€ä¸ªç”¨äºæ§åˆ¶è¾“å…¥ï¼Œä¸€ä¸ªç”¨äºç›‘å¬è¾“å…¥å€¼å˜åŒ–ååŒæ­¥æ›´æ–°
- ä½¿ç”¨ [`useDeferredValue`](https://react.dev/reference/react/useDeferredValue) æ¥ä»£æ›¿

2. æˆ‘çš„ state å˜åŒ–ä¼¼ä¹æ²¡æœ‰å®ç°è¿‡æ¸¡ï¼Œè¿˜æ˜¯è¢«é˜»å¡äº†ï¼Ÿ

å› ä¸ºä½ åœ¨ startTransition ä½¿ç”¨å¼‚æ­¥äº†ï¼š

```js
// æ¡ˆä¾‹1
startTransition(() => {
  // âŒ Setting state *after* startTransition call
  setTimeout(() => {
    setPage('/about');
  }, 1000);
});

// æ¡ˆä¾‹2
startTransition(async () => {
  await someAsyncFunction();
  // âŒ Setting state *after* startTransition call
  setPage('/about');
});
```
å¦‚æœéå¾—ä½¿ç”¨ setTimeoutï¼Œå¯ä»¥è¿™æ ·ï¼š

```js
// æ¡ˆä¾‹1
setTimeout(() => {
  startTransition(() => {
    // âœ… Setting state *during* startTransition call
    setPage('/about');
  });
}, 1000);

// æ¡ˆä¾‹2
await someAsyncFunction();
startTransition(() => {
  // âœ… Setting state *during* startTransition call
  setPage('/about');
});
```

3. æˆ‘çš„ä»£ç æ‰§è¡Œé¡ºåºä¸å¤ªå¯¹ï¼šit will print 1, 2, 3:

```js
console.log(1);
startTransition(() => {
  console.log(2);
  setPage('/about');
});
console.log(3);
```
ä½†æ˜¯ï¼Œ1 2 3 å°±åº”è¯¥æ˜¯æœŸæœ›çš„é¡ºåºï¼Œä¸åŒäº setTimeoutï¼ŒstartTransition è¿˜æ˜¯ç«‹å³æ‰§è¡Œå‡½æ•°çš„ï¼Œåªæ˜¯æ¸²æŸ“ä¸åŒæ­¥è€Œå·²ï¼Œä»–çš„ç®€å•å®ç°ç±»ä¼¼äºï¼š

```js
let isInsideTransition = false;

function startTransition(scope) {
  isInsideTransition = true;
  scope();
  isInsideTransition = false;
}

function setState() {
  if (isInsideTransition) {
    // ... schedule a transition state update ...
  } else {
    // ... schedule an urgent state update ...
  }
}
```
å…¶å®šä¹‰ä¸€ä¸ªå…¨å±€å˜é‡ isInsideTransition = trueï¼Œåœ¨æ‰§è¡Œå®Œå›è°ƒå‡½æ•°åï¼Œç½®ä¸º falseï¼›è®¾ç½® state æ—¶åˆ¤æ–­ä¸º true æ—¶è¡¨ç¤ºåœ¨è¿‡æ¸¡ä¸­ï¼Œæ­¤æ—¶æ‰§è¡Œè¿‡æ¸¡çš„æ“ä½œã€‚æ‰€ä»¥å¯ä»¥çœ‹åˆ°ï¼Œä»–å¹¶ä¸é˜»å¡ scope çš„æ‰§è¡Œã€‚


## 2. useDeferredValue

ä¸€ä¸ªå¯ä»¥è®©ä½ å»¶è¿Ÿï¼ˆdeferï¼‰æ›´æ–°UIçš„ hookã€‚

- æ¥æ”¶å‚æ•° valueï¼šä½ æƒ³è¦å»¶è¿Ÿçš„å€¼ï¼Œå¯ä»¥æ˜¯ä»»ä½•ç±»å‹ã€‚
- è¿”å›å€¼ï¼šåœ¨åˆå§‹æ¸²æŸ“æœŸé—´ï¼Œè¿”å›çš„å»¶è¿Ÿå€¼å°†ä¸ä½ æä¾›çš„å€¼ç›¸åŒã€‚åœ¨æ›´æ–°æœŸé—´ï¼ŒReact å°†é¦–å…ˆå°è¯•ä½¿ç”¨æ—§å€¼é‡æ–°æ¸²æŸ“ï¼ˆå› æ­¤å®ƒå°†è¿”å›æ—§å€¼ï¼‰ï¼Œç„¶åå°è¯•ä½¿ç”¨æ–°å€¼åœ¨åå°é‡æ–°æ¸²æŸ“ï¼ˆå› æ­¤å®ƒå°†è¿”å›æ›´æ–°çš„å€¼ï¼‰ã€‚

### ä½¿ç”¨æ¡ˆä¾‹

1. å¼¥è¡¥useTransitionä¸è¶³ï¼šç›‘å¬inputè¾“å…¥å¹¶å¹³æ»‘è¿‡æ¸¡

```js
import { Suspense, useState } from 'react';
import SearchResults from './SearchResults.js';

export default function App() {
  const [query, setQuery] = useState('');
  const deferredQuery = useDeferredValue(query);
  
  return (
    <>
      <label>
        Search albums:
        <input value={query} onChange={e => setQuery(e.target.value)} />
      </label>
      <Suspense fallback={<h2>Loading...</h2>}>
        <SearchResults query={deferredQuery} />
      </Suspense>
    </>
  );
}
```
ä¸Šé¢çš„ä¾‹å­ï¼Œæ¯å½“è¾“å…¥æ¡†è¾“å…¥æ—¶ï¼ŒSuspense çš„ fallback å°†ä¸å†æ¸²æŸ“ï¼Œè€Œæ˜¯ç›´æ¥å¹³æ»‘è¿‡æ¸¡æ˜¾ç¤ºæœ€æ–°çš„å€¼ï¼Œè¿™å°±ä½¿å¾—æ˜¾ç¤ºæ›´åŠ ç¨³å®šï¼Œä¸ä¼šæŠ–åŠ¨ã€‚


![image.png](/img/posts/2023-8-18/2023-8-18-4.png)

ä¸Šå›¾ä¸­ï¼Œè¾“å…¥å€¼ï¼Œè¾“å…¥æ¡†ç«‹é©¬å˜åŒ–ï¼Œä¸‹é¢æ˜¾ç¤ºåŒºåŸŸæ¼”ç¤ºå˜åŒ–ï¼Œä½†ä¸ä¼šæ˜¾ç¤º fallback çš„ loadingã€‚

2. æ·»åŠ æ¸²æŸ“è¿‡åº¦åŠ¨ç”»

åœ¨ä¸Šé¢ä¾‹å­çš„åŸºç¡€ä¸Šï¼Œæ·»åŠ ä¸€ä¸ªé€æ˜æ•ˆæœï¼š

```js
 // æ—§å€¼å’Œæ–°å€¼ä¸ä¸€æ ·ï¼Œè¡¨ç¤ºåœ¨è¿‡æ¸¡ä¸­ï¼Œè¿‡æ¸¡å®Œæ¯•å query ä¼šå˜ä¸ºä¸ deferredQuery ä¸€æ ·
 const isStale = query !== deferredQuery;
 ...
 <Suspense fallback={<h2>Loading...</h2>}>
    <div style={{
      opacity: isStale ? 0.5 : 1,
      transition: isStale ? 'opacity 0.2s 0.2s linear' : 'opacity 0s 0s linear'
    }}>
      <SearchResults query={deferredQuery} />
    </div>
</Suspense>
```
å¦‚å›¾ï¼Œåœ¨è¾“å…¥è¿‡ç¨‹ä¸­ï¼Œç»“æœæ–‡å­—å˜ä¸ºåŠé€æ˜ï¼š

![image.png](/img/posts/2023-8-18/2023-8-18-5.png)

3. ä¼˜åŒ–é•¿åˆ—è¡¨æ¸²æŸ“

SlowList å¯ä»¥ç†è§£ä¸ºä¸€ä¸ªè‚¥è‚ å¤šæ•°æ®çš„é•¿åˆ—è¡¨ï¼Œæ¯ä¸€ä¸ªåˆ—è¡¨éƒ½æœ‰ä¸€ä¸ªå…¬å…±çš„å€¼è¦æ§åˆ¶ï¼Œå«åš deferredTextï¼Œæˆ‘ä»¬è¿™æ ·å®ç°ï¼š

```js
export default function App() {
  const [text, setText] = useState('');
  const deferredText = useDeferredValue(text);
  return (
    <>
      <input value={text} onChange={e => setText(e.target.value)} />
      <SlowList text={deferredText} />
    </>
  );
}

```
è¿™æ ·è¿‡æ¸¡æ˜¯å°±ä¸ä¼šå‡ºç°çŸ­æ—¶é—´ç•Œé¢å¡é¡¿ä¸å¯äº¤äº’çš„æƒ…å†µï¼Œä¸ç„¶å°±ä¼šè¿™æ ·ï¼š

![image.png](/img/posts/2023-8-18/2023-8-18-6.png)

ä¸Šå›¾ä¸ä½¿ç”¨useDeferredValueï¼Œæ²¡è¾“å…¥ä¸€ä¸‹ï¼Œå°±ä¼šå¡ä¸€ä¸‹ï¼Œé¡µé¢é˜»å¡ã€‚ä½¿ç”¨äº† useDeferredValue å°±ä¼šä¸€æ­¥æ¸²æŸ“ï¼Œä¸ä¼šé˜»å¡ä½ è¾“å…¥å•¦ï¼å¯ä»¥å»å®˜ç½‘ä¾‹å­è¯•è¯•ï¼š[codesandbox.io/s/r6hcz2?file=%2FApp.js&utm_medium=sandpack](https://codesandbox.io/s/r6hcz2?file=%2FApp.js&utm_medium=sandpack)

> `SlowList` ç»„ä»¶åº”è¯¥æ”¾åœ¨ memo é‡Œï¼Œä¸ç„¶ä¼˜åŒ–ä¼šå¤±æ•ˆã€‚æ¯æ¬¡deferredTextå˜åŒ–æ—¶ï¼ŒAppç»„ä»·ç”±äºçŠ¶æ€å˜åŒ–äº†ï¼Œä¼šé‡æ–°æ¸²æŸ“ï¼Œå¯¼è‡´ SlowList å˜ä¸ºäº†æ–°çš„ç»„ä»¶äº†ã€‚

-----
å®Œï¼1d:T1850,å®˜ç½‘åœ°å€ï¼š[React](https://react.dev/)

## 1. useId

`useId` æ˜¯ä¸€ä¸ªç”Ÿæˆå”¯ä¸€Idçš„hookã€‚

å…¶ä¸æ¥æ”¶å‚æ•°ï¼Œè¿”å›å€¼å°±æ˜¯ç”Ÿæˆçš„Idï¼Œè¿™ä¸ªIdå¯ä»¥ä¿è¯åœ¨å½“å‰çš„ç»„ä»¶å†…éƒ¨ä¸é‡å¤ï¼Œä¸ç®¡ç»„ä»¶åå¤æ¸²æŸ“å¤šå°‘æ¬¡ã€‚

> æ³¨æ„ï¼Œè¿™å¯æ˜¯ä¸€ä¸ª hookï¼Œä¸èƒ½åœ¨ for å¾ªç¯ä¸­ä½¿ç”¨ï¼Œè¿™å°±å¼ºåˆ¶ä½ å…»æˆå¥½ä¹ æƒ¯ï¼šé¢å‘ç»„ä»¶ç¼–ç¨‹ã€‚

#### ä½¿ç”¨æ¡ˆä¾‹

ä¸€ä¸ªå¯†ç æ¡†ç»„ä»¶ï¼š

```jsx
import { useId } from 'react';

function PasswordField() {
  const passwordHintId = useId();
  return (
    <>
      <label>
        Password:
        <input
          type="password"
          aria-describedby={passwordHintId}
        />
      </label>
      <p id={passwordHintId}>
        The password should contain at least 18 characters
      </p>
    </>
  );
}
```

ä¸Šé¢ä¾‹å­ä¸­ï¼Œaria-describedby æ˜¯ [HTML accessibility](https://developer.mozilla.org/en-US/docs/Web/Accessibility/ARIA)å±æ€§ï¼Œç”¨äºå’Œå…¶ä»–å…ƒç´ å…³è”ä»¥æ–¹ä¾¿é˜…è¯»å™¨è¯»å–ã€‚
 
> ç¬”è€…è®¤ä¸º React ä¸­ useId å¾ˆé¸¡è‚‹ï¼Œä¸èƒ½ç”¨äºå¾ªç¯æ¸²æŸ“åˆ—è¡¨ï¼Œå¤§å¤šæ•°åœºæ™¯éƒ½ä¸å¤ªç”¨çš„ä¸Šï¼Œè‡³å°‘ç›®å‰æ˜¯è¿™æ ·ã€‚

## 2. useSyncExternalStore

ç”¨äºè®¢é˜…ç¬¬ä¸‰æ–¹ store çš„hookã€‚è¿™ä¸ª hook å¯ä»¥è®©æˆ‘ä»¬ä¸ä½¿ç”¨ redux/useReducer/useState æ¥è·å¾—å­˜å‚¨çŠ¶æ€çš„èƒ½åŠ›ã€‚

ä½¿ç”¨æ–¹å¼ï¼š

```js
const snapshot = useSyncExternalStore(subscribe, getSnapshot, getServerSnapshot)
```

å…¶ä¸­ï¼š

- `subscribe`ï¼šè®¢é˜…çš„å›è°ƒå‚æ•°ï¼Œå¯ç”¨äºå­˜å‚¨ storeã€‚å…¶å¿…é¡»è¿”å›ä¸€ä¸ª å–æ¶ˆè®¢é˜…çš„æ¸…ç†å‡½æ•°ã€‚
- `getSnapshot`ï¼šç”¨äºè¿”å›ç»„ä»¶æ‰€éœ€çš„å­˜å‚¨åŒºä¸­çš„æ•°æ®å¿«ç…§çš„å‡½æ•°ã€‚å½“å­˜å‚¨æœªæ›´æ”¹æ—¶ï¼Œå¯¹ getSnapshot çš„é‡å¤è°ƒç”¨å¿…é¡»è¿”å›ç›¸åŒçš„å€¼ã€‚å¦‚æœå­˜å‚¨æ›´æ”¹å¹¶ä¸”è¿”å›å€¼ä¸åŒï¼ˆObject.is ï¼‰ï¼Œå³ä¸æ˜¯çº¯å‡½æ•°ï¼ŒReact å°†é‡æ–°æ¸²æŸ“ç»„ä»¶
- `getServerSnapshot`ï¼šå¯é€‰å‚æ•°ã€‚è¿”å›å­˜å‚¨ä¸­æ•°æ®çš„åˆå§‹å¿«ç…§çš„å‡½æ•°ã€‚ä»…åœ¨ æœåŠ¡ç«¯æ¸²æŸ“æœŸé—´æˆ–è€…å®¢æˆ·ç«¯ hydration æ—¶ä½¿ç”¨ã€‚å¦‚æœçœç•¥æ­¤å‚æ•°ï¼ŒSSRåº”ç”¨ä¸­ï¼ŒæœåŠ¡å™¨ä¸Šå‘ˆç°ç»„ä»¶å°†å¼•å‘é”™è¯¯ã€‚
- `snapshot`: å½“å‰ store çš„å¿«ç…§ (æ˜¯ store çš„æ·±æ‹·è´)

### ä½¿ç”¨æ¡ˆä¾‹

- 1ã€è‡ªå®šä¹‰ store å®ç° todoListï¼š

```js
import { useSyncExternalStore } from 'react';
import { todosStore } from './todoStore.js';

export default function TodosApp() {
  const todos = useSyncExternalStore(todosStore.subscribe, todosStore.getSnapshot);
  return (
    <>
      <button onClick={() => todosStore.addTodo()}>Add todo</button>
      <hr />
      <ul>
        {todos.map(todo => (
          <li key={todo.id}>{todo.text}</li>
        ))}
      </ul>
    </>
  );
}

// todoStore.js
let nextId = 0;
let todos = [{ id: nextId++, text: 'Todo #1' }];
let listeners = [];

export const todosStore = {
  addTodo() {
    todos = [...todos, { id: nextId++, text: 'Todo #' + nextId }]
    emitChange();
  },
  subscribe(listener) {
    listeners = [...listeners, listener];
    return () => {
      listeners = listeners.filter(l => l !== listener);
    };
  },
  getSnapshot() {
    return todos;
  }
};

function emitChange() {
  for (let listener of listeners) {
    listener();
  }
}
```

ä¸Šé¢çš„ä¾‹å­ï¼Œè‡ªå®šä¹‰çš„ subscribe è¯»å–äº†æ‰€æœ‰ç›‘å¬å™¨å‡½æ•°ï¼Œä½¿ç”¨æ•°ç»„æ¥ç»´æŠ¤ã€‚æ¸…ç†å‡½æ•°ä¸­ï¼Œè¿‡æ»¤æ‰äº†å½“å‰çš„ç›‘å¬å™¨ï¼› getSnapshot åˆ™è¿”å›äº† storeã€‚

> ä¸€èˆ¬ä¸Šï¼Œ`useSyncExternalStore` API é€šå¸¸ç”¨äºé›†æˆ non-React ä»£ç .

- 2,ã€ä¼ é€’ä¸€ä¸ªç›‘å¬äº‹ä»¶ï¼Œåˆ¤æ–­å½“å‰ç½‘ç»œè¿æ¥çŠ¶æ€ï¼š

```js
import { useSyncExternalStore } from 'react';

export default function ChatIndicator() {
  const isOnline = useSyncExternalStore(subscribe, getSnapshot);
  return <h1>{isOnline ? 'âœ… Online' : 'âŒ Disconnected'}</h1>;
}

function getSnapshot() {
  return navigator.onLine;
}

function subscribe(callback) {
  window.addEventListener('online', callback);
  window.addEventListener('offline', callback);
  return () => {
    window.removeEventListener('online', callback);
    window.removeEventListener('offline', callback);
  };
}
```
ä¸Šé¢çš„è®¢é˜…äº‹ä»¶ä¸­ï¼Œç›‘å¬äº†åŸç”Ÿ online äº‹ä»¶ï¼Œå°†ç›‘å¬å™¨å½“åšå›è°ƒ callbackï¼Œè¿™æ ·ï¼Œå½“ navigator.onLine å˜åŒ–æ—¶ï¼ŒisOnline å°±ä¼šæ”¹å˜ã€‚

- 3ã€ä¸è‡ªå®šä¹‰ hook ç»„åˆ

ä¸Šé¢çš„ä¾‹å­ï¼Œæˆ‘ä»¬å°†è¿™ä¸ªå°è£…åœ¨ä¸€ä¸ª hook é‡Œï¼š

```js
export function useOnlineStatus() {
  const isOnline = useSyncExternalStore(subscribe, getSnapshot);
  return isOnline;
}

...
```
ç°åœ¨å°±å¯ä»¥åœ¨å…¶ä»–ç»„ä»¶ä¸­ä½¿ç”¨äº†ï¼š

```js
function StatusBar() {
  const isOnline = useOnlineStatus();
  return <h1>{isOnline ? 'âœ… Online' : 'âŒ Disconnected'}</h1>;
}
```

- 4ã€æœåŠ¡ç«¯æ¸²æŸ“æ—¶é…ç½®

å¦‚æœä½¿ç”¨äº†æœåŠ¡ç«¯æ¸²æŸ“ï¼Œè¿™å°±æ„å‘³ç€ä½ ä¸èƒ½å†ä½¿ç”¨æµè§ˆå™¨è‡ªå¸¦çš„APIï¼Œä¸Šé¢åˆ¤æ–­æ˜¯å¦åœ¨çº¿çš„ä¾‹å­å°±ä¸æˆç«‹äº†ã€‚æˆ‘ä»¬å¯ä»¥å¦‚ä¸‹å†™ï¼š

```js
import { useSyncExternalStore } from 'react';

export function useOnlineStatus() {
  const isOnline = useSyncExternalStore(subscribe, getSnapshot, getServerSnapshot);
  return isOnline;
}

function getSnapshot() {
  return navigator.onLine;
}

function getServerSnapshot() {
  return true; // Always show "Online" for server-generated HTML
}

function subscribe(callback) {
  // ...
}
```
ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œé€šè¿‡ç¬¬ä¸‰ä¸ªå‚æ•° getServerSnapshot é…ç½®SSRï¼Œreturn å€¼å°±æ˜¯æ¸²æŸ“æ—¶è·å–åˆ°çš„ store çš„å€¼ã€‚

getServerSnapshot å‡½æ•°ç±»ä¼¼äº getSnapshotï¼Œä½†å®ƒä»…åœ¨ä¸¤ç§æƒ…å†µä¸‹æ‰§è¡Œï¼š

1. ç”Ÿæˆ HTML æ—¶ï¼Œåœ¨æœåŠ¡å™¨ä¸Šè¿è¡Œã€‚
2. å®ƒåœ¨ [hydration](https://react.dev/reference/react-dom/client/hydrateRoot) æœŸé—´åœ¨å®¢æˆ·ç«¯ä¸Šè¿è¡Œï¼Œå³å½“ React è·å–æœåŠ¡å™¨ HTML å¹¶ä½¿å…¶äº¤äº’æ—¶ã€‚

ä»–æä¾›ä¸€ä¸ªåœ¨é¡µé¢å¯äº¤äº’ä¹‹å‰çš„åˆå§‹å¿«ç…§å€¼ã€‚å¦‚æœæœåŠ¡å™¨å‘ˆç°æ²¡æœ‰æœ‰æ„ä¹‰çš„åˆå§‹å€¼ï¼Œåˆ™ä¼šå¿½ç•¥æ­¤å‚æ•°å¹¶å¼ºåˆ¶åœ¨å®¢æˆ·ç«¯ä¸Šæ¸²æŸ“ã€‚

> ä½¿ç”¨æ—¶éœ€ç¡®ä¿ getServerSnapshot åœ¨åˆå§‹å®¢æˆ·ç«¯æ¸²æŸ“ä¸Šè¿”å›çš„æ•°æ®ä¸åœ¨æœåŠ¡å™¨ä¸Šè¿”å›çš„æ•°æ®å®Œå…¨ç›¸åŒã€‚

> ä¾‹å¦‚ï¼Œå¦‚æœ getServerSnapshot åœ¨æœåŠ¡å™¨ä¸Šè¿”å›äº†ä¸€äº›é¢„å¡«å……çš„å­˜å‚¨å†…å®¹ï¼Œåˆ™éœ€è¦å°†æ­¤å†…å®¹ä¼ è¾“åˆ°å®¢æˆ·ç«¯ã€‚ä¸€ç§æ–¹æ³•æ˜¯åœ¨æœåŠ¡å™¨æ¸²æŸ“æœŸé—´æ‰“ä¸€ä¸ª\<script>æ ‡ç­¾ï¼Œç”¨äºè®¾ç½®å…¨å±€å˜é‡ï¼Œç±»ä¼¼ `window.MY_STORE_DATA`ï¼Œç„¶ååœ¨ getServerSnapshot ä¸­ä»å®¢æˆ·ç«¯ä¸Šå…¨å±€è¯»å–ã€‚

----
å®Œï¼1e:T2984,- å®˜ç½‘åœ°å€ï¼š[React](https://beta.reactjs.org/)

## 1. useContext

`useContext` æ˜¯ä¸€ä¸ªä¼ é€’ç»„ä»¶ä¸Šä¸‹æ–‡çš„é’©å­ï¼Œæä¾›è¯»å–å’Œè®¢é˜…åŠŸèƒ½ã€‚


### æ¥æ”¶å‚æ•°

- contextï¼šæ˜¯ [`createContext`](https://react.dev/reference/react/createContext) åˆ›å»ºå‡ºæ¥çš„å¯¹è±¡ï¼Œä»–ä¸ä¿æŒä¿¡æ¯ï¼Œä»–æ˜¯ä¿¡æ¯çš„è½½ä½“ã€‚å£°æ˜äº†å¯ä»¥ä»ç»„ä»¶è·å–æˆ–è€…ç»™ç»„ä»¶æä¾›ä¿¡æ¯ã€‚åœ¨ provider ä¸­å¯ä»¥ä¼ é€’å…·ä½“çš„å€¼ã€‚

### è¿”å›å€¼

- contextValueï¼šè¿”å›ä¼ é€’çš„åªè¯»contextè½½ä½“çš„å€¼ã€‚æ˜¯è°ƒç”¨å †æ ˆä¸­ç»„ä»¶ä¸Šæ–¹æœ€è¿‘çš„ SomeContext.Provider å‡ºæ¥çš„å€¼ã€‚å¦‚æœæ²¡æœ‰è¿™æ ·çš„Providerï¼Œåˆ™è¿”å›çš„å€¼å°†æ˜¯ä¼ é€’ç»™è¯¥contextçš„ createContext çš„ defaultValueã€‚å…¶è¿”å›çš„å€¼å§‹ç»ˆæ˜¯æœ€æ–°çš„ã€‚å¦‚æœä¸Šä¸‹æ–‡å‘ç”Ÿå˜åŒ–ï¼ŒReact ä¼šè‡ªåŠ¨é‡æ–°æ¸²æŸ“è¯»å–contextçš„ç»„ä»¶ã€‚

### æ³¨æ„äº‹é¡¹

- useContext() ä¸å—åŒä¸€ç»„ä»¶å†…`<Context.Provider>`çš„å½±å“ã€‚useContext è¦æƒ³æ‹¿åˆ° provideræä¾›çš„ä¸Šä¸‹æ–‡ï¼Œä¸€å®šæ”¾åœ¨`<Context.Provider>`å†…éƒ¨åµŒå¥—çš„ç»„ä»¶ä¸­ã€‚
- `<Context.Provider>`ä¼ é€’çš„contextçš„å€¼ï¼Œå¦‚æœå€¼å˜åŒ–äº†ï¼ˆObject.is åˆ¤æ–­æ³•ï¼‰ï¼Œå…¶ä¸‹å„çº§ç»„ä»¶å°±ä¼šè§¦å‘é‡æ–°æ¸²æŸ“ã€‚å¯ä½¿ç”¨ memo è¿™ä¸ªAPIæ¥é˜»æ­¢é‡æ¸²æŸ“ã€‚
- ç¡®ä¿ä¼ é€’contextçš„å¯¹è±¡å’Œè¯»å–contextçš„å¯¹è±¡æ˜¯åŒä¸€ä¸ªcontextï¼Œæœ€å¥½æå–ä¸ºå…¬å…±ç»„ä»¶ï¼Œä½¿ç”¨æ—¶å¼•ç”¨è¿™ä¸ªå•ä¾‹å³å¯ã€‚

> useContext() æ€»æ˜¯åœ¨è°ƒç”¨å®ƒçš„ç»„ä»¶ä¸Šçº§å¯»æ‰¾æœ€æ¥è¿‘çš„Providerã€‚å®ƒé€çº§å‘ä¸Šæœç´¢ï¼Œå¹¶ä¸”æ’é™¤æ‰ ä½¿ç”¨ useContext() çš„åŒçº§ç»„ä»¶ä¸­çš„Providerã€‚

### å„ç§å‚è€ƒæ¡ˆä¾‹

#### 1. ä¼ é€’ä¸»é¢˜é¢œè‰²

åˆ›å»ºä¸€ä¸ª contextï¼š

```js
const ThemeContext = createContext(null);
```

å®šä¹‰æ ¹ç»„ä»¶ï¼š

```js
export default function MyApp() {
  return (
    <ThemeContext.Provider value="dark">
      <Form />
    </ThemeContext.Provider>
  )
}
```
ä»–å¾€ä¸‹æä¾›äº†ä¸€ä¸ª context çš„åˆå§‹å€¼ï¼Œå« darkã€‚åœ¨å­ç»„ä»¶ä¸­ï¼Œä½¿ç”¨ useContext å¼•å…¥ ThemeContextï¼Œè·å–åˆ°è¿™ä¸ªcontextè½½ä½“å…·ä½“çš„å€¼ï¼š

```js
function Panel({ title, children }) {
  const theme = useContext(ThemeContext);
  const className = 'panel-' + theme;
  return (
    <section className={className}>
      <h1>{title}</h1>
      {children}
    </section>
  )
}
```

#### 2. åˆ‡æ¢ä¸»é¢˜é¢œè‰²

åœ¨ä¸Šé¢çš„åŸºç¡€ä¸Šï¼Œæˆ‘ä»¬æ·»åŠ æ›´æ–°ä¸»é¢˜é¢œè‰²çš„åŠŸèƒ½ã€‚é¦–å…ˆåœ¨æ ¹ç»„ä»¶åŠ å…¥ä¸»é¢˜çš„stateå’Œæ”¹å˜çš„è¡¨å•å…ƒç´ ï¼š

```js
// MyApp
const [theme, setTheme] = useState('light');

// ...
<ThemeContext.Provider value={theme}>
   // ...
   <input
      type="checkbox"
      checked={theme === 'dark'}
      onChange={(e) => {
        setTheme(e.target.checked ? 'dark' : 'light')
      }}
    />
// ...
</ ThemeContext.Provider>
```

ç”±äº context æ˜¯åªè¯»çš„ï¼Œæ‰€ä»¥å­ç»„ä»¶ä¸éœ€è¦ä»»ä½•ä¿®æ”¹ã€‚æ ¹ç»„ä»¶ä¸­ç‚¹å‡» checkbox å°±å¯ä»¥æ”¹å˜å­ç»„ä»¶ä¸­çš„ classname äº†ã€‚


#### 3. å¤šcontextåµŒå¥—çš„æƒ…å†µ

æˆ‘ä»¬åœ¨æ ¹ç»„ä»¶ä¸­å®šä¹‰ä¸¤ä¸ª Providerï¼š

```js
const ThemeContext = createContext(null);
const CurrentUserContext = createContext(null);

// ...

<ThemeContext.Provider value={theme}>
  <CurrentUserContext.Provider
    value={{
      currentUser,
      setCurrentUser
    }}
  >
    <WelcomePanel />
// ...
  </ CurrentUserContext.Provider>
</ ThemeContext.Provider>
```

è¿™æ ·åœ¨å­ç»„ä»¶ WelcomePanel ä¸­å°±å¯ä»¥è·å–ï¼š

```js
const {currentUser} = useContext(CurrentUserContex);
const {theme} = useContext(ThemeContext);
```
å¯ä»¥çœ‹åˆ°ï¼Œé€šè¿‡ä¸åŒçš„ context è½½ä½“ï¼Œå¯ä»¥è·å–åˆ°ä¸åŒä½œç”¨åŸŸçš„å€¼ã€‚

#### 4. å°è£…ä¸ºé«˜é˜¶ç»„ä»¶ï¼

ä¸Šé¢çš„ä»£ç ï¼Œcontext éƒ½äº¤ç»™æ ¹ç»„ä»¶ç»´æŠ¤ï¼Œä»£ç è€¦åˆæ€§æ¯”è¾ƒé«˜ï¼Œå¯ä»¥ç»Ÿä¸€æå‡ºæ¥ä¸€ä¸ªæ–°ç»„ä»¶MyProvidersï¼š

```js
function MyProviders({ children, theme }) {
  const [currentUser, setCurrentUser] = useState(null);
  return (
    <ThemeContext.Provider value={theme}>
      <CurrentUserContext.Provider
        value={{
          currentUser,
          setCurrentUser
        }}
      >
        {children}
      </CurrentUserContext.Provider>
    </ThemeContext.Provider>
  );
}
```

è¿™æ ·å†åº”ç”¨è¿™ä¸ªç»„ä»¶å°±ä¼šæ–¹ä¾¿å¾ˆå¤šï¼š

```js
<MyProviders theme={theme} setTheme={setTheme}>
  // ...
</MyProviders>
```

> P.S. ä¸Šé¢çš„ä¾‹å­æœ‰æ²¡æœ‰æ³¨æ„åˆ°ï¼Œä¸€ä¸ªå…¨å±€çš„ Contextï¼ŒåŠ ä¸Š useReducerï¼ˆuseStateï¼‰ å°±æ˜¯ä¸€ä¸ªå°å‹çš„ reduxï¼Œæ¯”å¦‚ä¸‹é¢çš„[ä¾‹å­](https://codesandbox.io/s/3pzgg8?file=/AddTask.js&utm_medium=sandpack)ï¼š

```js
export function TasksProvider({ children }) {
  const [tasks, dispatch] = useReducer(
    tasksReducer,
    initialTasks
  );

  return (
    <TasksContext.Provider value={tasks}>
      <TasksDispatchContext.Provider value={dispatch}>
        {children}
      </TasksDispatchContext.Provider>
    </TasksContext.Provider>
  );
}
```

#### 5. åŒä¸€ä¸ªcontextï¼Œå±€éƒ¨ä¿®æ”¹çŠ¶æ€

æ¯”å¦‚åœ¨å…¨å±€ç™½è‰²èƒŒæ™¯ä¸‹ï¼Œæƒ³è¦åœ¨å±€éƒ¨çš„ç»„ä»¶ä¸­ä½¿ç”¨å…¶ä»–ä¸»é¢˜è‰²ï¼Œå¯ä»¥è¿™æ ·å®šä¹‰ï¼š

```js
<ThemeContext.Provider value="light">
  ...
  <ThemeContext.Provider value="dark">
    <Footer />
  </ThemeContext.Provider>
  ...
</ThemeContext.Provider>
```

#### 6. æ€§èƒ½ä¼˜åŒ–ï¼šåœ¨ä¼ å€¼æ—¶é¿å…ä¸å¿…è¦çš„é‡æ¸²æŸ“

è€ƒè™‘ä¸‹é¢çš„ä¾‹å­ï¼š

```js
<AuthContext.Provider value={{ currentUser, login }}></ AuthContext.Provider>
```

ä¼ é€’çš„contextæ˜¯ä¸€ä¸ªå¯¹è±¡(currentUser)å’Œä¸€ä¸ªå‡½æ•°(login)ï¼Œåœ¨é¡¶å±‚ç»„ä»¶é‡æ¸²æŸ“æ—¶ï¼Œä»–ä»¬å¯èƒ½ä¼šè¢«é‡æ–°åˆ›å»ºï¼Œè¿›è€Œé€ æˆcontexté‡æ¸²æŸ“ã€‚æ‰€ä»¥è¿™é‡Œå¯¹æ³¨å…¥çš„è¢«å­—é¢é‡å€¼ä¹Ÿè¦åšç¼“å­˜ï¼š

```js
const login = useCallback((response) => {...})

const contextValue = useMemo(() => ({  
  currentUser,  
  login  
}), [currentUser, login]);

// ä½¿ç”¨
<AuthContext.Provider value={contextValue}></ AuthContext.Provider>
// ...
```

### Q&A

#### 1. æˆ‘çš„ç»„ä»¶ä¸ºä»€ä¹ˆæ‹¿ä¸åˆ°contextæä¾›çš„æ•°æ®

æ’æŸ¥å¯èƒ½çš„åŸå› ï¼š

- ä½ åœ¨ `<SomeContext.Provider>` åŒä¸€çº§ç»„ä»¶ä¸­ä½¿ç”¨äº† useContext() 
- ä½ æ²¡æœ‰ç”¨ `<SomeContext.Provider>` åŒ…è£¹ä¸Šçº§ç»„ä»¶
- ç”±äºæ‰“åŒ…é—®é¢˜æˆ–è€…ä»£ç å¼•å…¥çš„é—®é¢˜ï¼Œä½ æä¾›contextçš„åœ°æ–¹å’Œä½¿ç”¨contextçš„åœ°æ–¹ï¼Œå¼•ç”¨çš„ä¸æ˜¯ä¸€ä¸ªContextå¯¹è±¡ã€‚æ¯”å¦‚ä½ ä½¿ç”¨å…¨å±€å˜é‡æŒ‚è½½äº†å¤šä¸ª contextï¼š`window.SomeContext1`Â andÂ `window.SomeContext2`ï¼Œä½ éœ€è¦ä½¿ç”¨ `===` æå‰åˆ¤æ–­æ˜¯å¦ç›¸åŒã€‚


#### 2. å³ä½¿æˆ‘è®¾ç½®äº†åˆå§‹å€¼ï¼Œä½†æ˜¯æ€»æ˜¯åœ¨è·å–å€¼çš„æ—¶å€™æ‹¿åˆ° `undefined`

ä½ åœ¨ Provider æ—¶å¿˜è®°ä¼ é€’ value å±æ€§äº†ã€‚

## 2. useRef

ç”¨äºè®¾ç½®ä¸€ä¸ªå¯å˜çš„å¼•ç”¨å€¼ï¼Œä¸éšç»„ä»¶æ¸²å˜åŒ–ã€‚ä¸ `useState` ä¸åŒï¼Œ`useRef` è¿”å›çš„å¼•ç”¨å¯¹è±¡åœ¨ç»„ä»¶é‡æ–°æ¸²æŸ“æ—¶ä¿æŒä¸å˜ï¼Œè®¾ç½®å¼•ç”¨å€¼ä¹Ÿä¸ä¼šè§¦å‘ç»„ä»¶çš„é‡æ–°æ¸²æŸ“ã€‚

> P.S. ç”±äº useRef æ˜¯ä¸€ä¸ªå¼•ç”¨ï¼Œå…¶å†…éƒ¨çš„å€¼æ˜¯ä¸€ä¸ª current å¯¹è±¡æ¥æ¥å—çš„ï¼Œæ‰€ä»¥æœ‰äº›ä¸ç¡®å®šæ˜¯å¦æœ‰åˆå§‹å€¼çš„æƒ…å†µä¸‹ï¼Œéœ€è¦åˆ¤æ–­ ref.current æ˜¯å¦ä¸ºç©ºã€‚

### å‚è€ƒæ¡ˆä¾‹

###### 1. ç‚¹å‡»è®¡æ•°å™¨

æ³¨æ„ï¼Œè¿™ä¸ªè®¡æ•°å€¼çš„å˜åŒ–ï¼Œä¸ä¼šå¼•èµ·ç»„ä»¶é‡æ¸²æŸ“ï¼Œåœ¨ä¸éœ€è¦æ¸²æŸ“çš„åœºåˆé€‚ç”¨ã€‚æ‰€ä»¥åœ¨jsxä¸­è¿™ä¹ˆå†™æ˜¯ä¸ä¼šèµ·ä½œç”¨çš„ âŒï¼š`<span>{ref.current}</span>`

```js
let ref = useRef(0);

function handleClick() {
  ref.current = ref.current + 1;
  alert('You clicked ' + ref.current + ' times!');
}
```

###### 2. è·å–inputçš„ç„¦ç‚¹

useRef å¯ä»¥æŒ‚è½½åœ¨åŸç”Ÿå…ƒç´ ä¸Šæ¥è·å–å…¶DOMå¯¹è±¡æœ¬èº«ã€‚

```js
const inputRef = useRef(null);

function handleClick() {
  inputRef.current.focus();
}

<input ref={inputRef} />
```

###### 3. æ§åˆ¶å…ƒç´ æ»šåŠ¨

H5 æœ‰ä¸ªAPIå« `scrollIntoView`, è·å–åˆ° DOM å…ƒç´ åå¯ä»¥æ§åˆ¶å°†å…¶æ»šåŠ¨åˆ°ç‰¹å®šçš„ä½ç½®ï¼š

```js
const listRef = useRef(null);

function scrollToIndex(index) {
    const listNode = listRef.current;
    // This line assumes a particular DOM structure:
    const imgNode = listNode.querySelectorAll('li > img')[index];
    imgNode.scrollIntoView({
      behavior: 'smooth',
      block: 'nearest',
      inline: 'center'
    });
}

// ...
<ul ref={listRef}>
  <li onClick={scrollToIndex(0)}><img ... /></li>
  <li onClick={scrollToIndex(1)}><img ... /></li>
  <li onClick={scrollToIndex(2)}><img ... /></li>
</ul>
```

###### 4. æ§åˆ¶ video æ’­æ”¾

```js
// æ§åˆ¶æ–¹æ³•ä»£ç ç‰‡æ®µ
if (!isPlaying) {
  ref.current.play();
} else {
  ref.current.pause();
}

...
// dom å®šä¹‰
<video
    width="250"
    ref={ref}
    onPlay={() => setIsPlaying(true)}
    onPause={() => setIsPlaying(false)}
  >
    <source
      src="https://interactive-examples.mdn.mozilla.net/media/cc0-videos/flower.mp4"
      type="video/mp4"
    />
</video>
```

###### 5. è‡ªå®šä¹‰ç»„ä»¶è®¾ç½® ref å±æ€§

å› ä¸ºé»˜è®¤å‡½æ•°å¼ç»„ä»¶ä¸ä¼šå¾€å¤–æš´éœ² refs å±æ€§ï¼Œæ‰€ä»¥æˆ‘ä»¬é¦–å…ˆè¦ç”¨ `forwardRef` å°†æˆ‘ä»¬çš„è‡ªå®šä¹‰ç»„ä»¶åŒ…è£¹åå¯¼å‡ºï¼š

```js
// å°† ref ç»™åˆ° input
const MyInput = forwardRef((props, ref) => {
  return <input {...props} ref={ref} />;
});
```
æ¥ç€åœ¨çˆ¶ç»„ä»¶ä¸­ä½¿ç”¨åŒ…è£¹å¥½çš„ç»„ä»¶ï¼š

```js
<MyInput ref={inputRef} />
```
ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œæƒ³è¦æ‹¿åˆ°å­ç»„ä»¶å†…éƒ¨çš„ input å…ƒç´ å®ä¾‹ï¼Œåªéœ€ï¼š

```js
inputRef.current.focus();
```

## 3. useImperativeHandle

è¿™ä¸ª hook éœ€è¦ç»“åˆ ref ä½¿ç”¨ï¼Œç”¨äºæ§åˆ¶åœ¨è‡ªå®šä¹‰ç»„ä»¶ä¸­å‘å¤–æš´éœ²å“ªäº›ç»„ä»¶å±æ€§æˆ–æ–¹æ³•ã€‚

ä¸Šé¢çš„ useRef åªèƒ½æ§åˆ¶è‡ªå®šä¹‰ç»„ä»¶æœ¬èº«çš„ DOMï¼Œå¦‚æœæƒ³è¦åœ¨çˆ¶ç»„ä»¶è°ƒç”¨å­ç»„ä»¶æœ¬èº«çš„æˆå‘˜æ–¹æ³•ï¼Œå°±éœ€è¦ç»“åˆ `useImperativeHandle` æ¥ä½¿ç”¨äº†ã€‚

### æ¥æ”¶å‚æ•°

- refï¼šç»„ä»¶forwardRefåŒ…è£¹åæš´éœ²å‡ºæ¥çš„ref
- æ§åˆ¶å‡½æ•°ï¼šå…¶è¿”å›å€¼æ˜¯ä¸ªå¯¹è±¡ï¼Œåˆ—ä¸¾äº†æš´éœ²çš„æ–¹æ³•çš„å˜é‡

### å‚è€ƒæ¡ˆä¾‹

###### 1. å°è£…ä¸€ä¸‹ä¸Šé¢èšç„¦inputçš„åŠŸèƒ½

æˆ‘ä»¬å°†ä¸Šé¢åœ¨çˆ¶ç»„ä»¶ä¸­ä½¿ç”¨ `inputRef.current.focus();` çš„è¿‡ç¨‹ï¼Œåœ¨å­ç»„ä»¶ä¸­æš´éœ²æˆä¸€ä¸ªæ–¹æ³•ï¼š

```js
// MyInput
useImperativeHandle(ref, () => {
    return {
      focus() {
        inputRef.current.focus();
      },
    }
})
```

åœ¨çˆ¶ç»„ä»¶ä¸­ä½¿ç”¨ï¼š

```jsx
ref.current.focus();

...
<MyInput label="Enter your name:" ref={ref} />
```

###### 2. æš´éœ²å­ç»„ä»¶çš„æ–¹æ³•ç»™çˆ¶ç»„ä»¶

å­ç»„ä»¶ï¼š

```js
useImperativeHandle(ref, () => ({
  getData: () => getData(filter),
  refreshTable: () => refreshTable()
}));
```

çˆ¶ç»„ä»¶ï¼š

```js
tableRef.current && tableRef.current.refreshTable();

...
<CommonTable loading={loading} ref={tableRef}>...</CommonTable>
```

ä¸Šé¢çš„ä»£ç ï¼Œå®ç°äº†åœ¨è‡ªå®šä¹‰è¡¨æ ¼ç»„ä»¶æ—¶ï¼Œé€šè¿‡çˆ¶ç»„ä»¶æ¥è°ƒç”¨è¡¨æ ¼ç»„ä»¶å†…éƒ¨æ–¹æ³•é‡æ–°è·å–æ•°æ®å’ŒåŸåœ°åˆ·æ–°çš„åŠŸèƒ½ã€‚

> P.S. ä¸è¦è¿‡åº¦ä½¿ç”¨ refs åŠŸèƒ½ã€‚ä»…ä»…éœ€è¦åœ¨ä¸€äº›èšç„¦ã€æ»šåŠ¨ã€åŠ¨ç”»å’Œé€‰ä¸­ç­‰ç­‰ä¸èƒ½é€šè¿‡propsä¼ é€’çš„å‘½ä»¤å¼çš„è¡Œä¸ºä¸Šä½¿ç”¨å³å¯ã€‚ä¸Šé¢çš„çˆ¶ç»„ä»¶è°ƒç”¨å­ç»„ä»¶çš„ä¾‹å­ï¼Œå®Œå…¨å¯ä»¥ç”¨ useEffect + props æˆ–è€… Events è§£å†³ã€‚1f:T3fca,- å®˜ç½‘åœ°å€ï¼š[React](https://beta.reactjs.org/)

## 1. ä½¿ç”¨åœºæ™¯å¯¹æ¯”

- `useEffect`: ç”¨äºå‰¯ä½œç”¨æ•è·ï¼Œåœ¨ dom å…ƒç´ æ¸²æŸ“ä¹‹åè°ƒç”¨ï¼Œå¸¸ç”¨äºé¡µé¢æ•°æ®å¤„ç†å·¥ä½œã€‚
- `useLayoutEffect`: useEffect çš„ä¸€ä¸ªç‰ˆæœ¬ï¼Œåœ¨ DOM æ›´æ–°ä¹‹ååŒæ­¥æ‰§è¡Œï¼Œä½†åœ¨æµè§ˆå™¨ç»˜åˆ¶ä¹‹å‰æ‰§è¡Œï¼Œå¸¸ç”¨äºé¡µé¢å…ƒç´ å¸ƒå±€å·¥ä½œï¼Œå¯èƒ½ä¼šé˜»å¡é¡µé¢æ¸²æŸ“ã€‚
- `useInsertionEffect`: useEffect çš„ä¸€ä¸ªç‰ˆæœ¬ï¼Œåœ¨ DOM æ›´æ–°å‰æ‰§è¡Œã€‚å¸¸ç”¨äº CSS-in-JS æ’å…¥åŠ¨æ€æ ·å¼ã€‚


## 2. useEffect

useEffect æ˜¯ä¸€ä¸ªæ•è·å‰¯ä½œç”¨çš„å‡½æ•°ï¼Œç”¨æ¥ä»£æ›¿ç±»å¼ç»„ä»¶ä¸­ç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸå‡½æ•°ã€‚å£°æ˜æ–¹å¼å¦‚ä¸‹ï¼š

```js
useEffect(setup, dependencies)
```

### å‚è€ƒèŒƒä¾‹

æ³¨æ„éœ€åœ¨ç»„ä»¶é¡¶å±‚ä½¿ç”¨

```js
function ChatRoom({ roomId }) {
  const [serverUrl, setServerUrl] = useState('https://localhost:1234');

  useEffect(() => {
    const connection = createConnection(serverUrl, roomId);
    connection.connect();
    return () => {
      connection.disconnect();
    };
  }, [serverUrl, roomId]);
  // ...
}
```

### æ¥æ”¶å‚æ•°

1. setupï¼šå…·æœ‰ Effect é€»è¾‘çš„è®¾ç½®å‡½æ•°ã€‚å½“ä½ çš„ç»„ä»¶è¢«æ·»åŠ åˆ° DOM æ—¶ï¼ŒReact å°†è¿è¡Œä½ çš„è®¾ç½®å‡½æ•°ã€‚åœ¨æ¯æ¬¡ä½¿ç”¨æ›´æ”¹çš„ä¾èµ–é¡¹é‡æ–°æ¸²æŸ“åï¼ŒReact å°†é¦–å…ˆä½¿ç”¨æ—§å€¼è¿è¡Œæ¸…ç†å‡½æ•°ï¼ˆå¦‚æœä½ æä¾›äº†å®ƒï¼‰ï¼Œç„¶åä½¿ç”¨æ–°å€¼è¿è¡Œä½ çš„è®¾ç½®å‡½æ•°ã€‚åœ¨ä½ çš„ç»„ä»¶ä» DOM ä¸­ç§»é™¤åï¼ŒReact å°†è¿è¡Œä½ çš„æ¸…ç†å‡½æ•°ã€‚

å…¶ä¸­æ¸…ç†å‡½æ•°èŒƒä¾‹å¦‚ä¸‹ï¼š

```js
useEffect(
    // è®¾ç½®å‡½æ•°
    () => {
        const connection = createConnection(serverUrl, roomId);
        connection.connect();

        // æ¸…ç†å‡½æ•°
        return () => {
            connection.disconnect();
        };
    },
    // ä¾èµ–
    [serverUrl, roomId]
);
```
2. ä¾èµ–é¡¹ï¼ˆå¯é€‰ï¼‰ï¼šæ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œé€šè¿‡ `Object.is` æ¥ä¾æ¬¡åˆ¤æ–­å„ä¸ªä¾èµ–é¡¹æ˜¯å¦å˜åŒ–ï¼Œè‹¥æœ‰è‡³å°‘ä¸€ä¸ªå‘ç”Ÿå˜åŒ–ï¼Œåˆ™æ‰§è¡Œè®¾ç½®å‡½æ•°å’Œæ¸…ç†å‡½æ•°ã€‚å¦‚æœæœ‰å¤šä¸ªä¾èµ–é¡¹æ›´æ–°ï¼Œåœ¨ä¸€ä¸ªfiberæ›´æ–°å‘¨æœŸå†…ï¼Œè®¾ç½®å‡½æ•°å’Œæ¸…ç†å‡½æ•°ä¹Ÿ**åªä¼šæ‰§è¡Œä¸€æ¬¡**ã€‚è‹¥çœç•¥æ­¤å‚æ•°ï¼Œè®¾ç½®å‡½æ•°å’Œæ¸…ç†å‡½æ•°å°†åœ¨æ¯æ¬¡ç»„ä»¶æ¸²æŸ“æ—¶æ‰§è¡Œã€‚

### è¿”å›å‚æ•°

undefined

### æ³¨æ„äº‹é¡¹

1. ä»–æ˜¯ä¸€ä¸ªhookï¼Œåªèƒ½åœ¨å‡½æ•°å¼ç»„ä»¶æœ€å¤–å±‚ä½¿ç”¨ï¼Œä¸”ä¸èƒ½æ”¾åœ¨å¾ªç¯å’Œæ¡ä»¶è¯­å¥ä¸­ã€‚
2. ä»–çš„ä½œç”¨æ˜¯æ£€æµ‹ä¾èµ–é¡¹å˜åŒ–åæ‰§è¡Œï¼Œè‹¥ä¸ºç©ºæ•°ç»„ä¾èµ–ï¼Œåˆ™é»˜è®¤åœ¨ç»„ä»¶æŒ‚è½½æ—¶æ‰§è¡Œä¸€æ¬¡ã€‚
3. ä¸¥æ ¼æ¨¡å¼ä¸‹ `useEffect` æœ‰ä¸€ç§ç‰¹æ®Šè¡Œä¸ºï¼Œå³åœ¨ç¬¬ä¸€æ¬¡æ¸²æŸ“ä¹‹å‰ä¼šè¿è¡Œä¸€ä¸ªé¢å¤–çš„è®¾ç½®å’Œæ¸…ç†å¾ªç¯ï¼Œè¿™ä¸ªå¾ªç¯çš„ç›®çš„æ˜¯ä¸ºäº†éªŒè¯è®¾ç½®é€»è¾‘å’Œæ¸…ç†é€»è¾‘æ˜¯å¦ç›¸äº’åŒ¹é…ï¼Œä»¥åŠæ¸…ç†é€»è¾‘æ˜¯å¦èƒ½å¤Ÿæ­£ç¡®åœ°åœæ­¢æˆ–æ’¤é”€è®¾ç½®é€»è¾‘æ‰€åšçš„æ“ä½œã€‚å¦‚æœä½ åœ¨ä¸¥æ ¼æ¨¡å¼ä¸‹é‡åˆ°äº†ä¸ `setup å’Œ cleanup` ç›¸å…³çš„é—®é¢˜ï¼Œå®˜æ–¹å»ºè®®ä½ å®ç°é€‚å½“çš„æ¸…ç†å‡½æ•°æ¥è§£å†³ã€‚è¿™æ ·å¯ä»¥ç¡®ä¿åœ¨ç»„ä»¶å¸è½½æˆ–é‡æ–°æ¸²æŸ“æ—¶è¿›è¡Œå¿…è¦çš„æ¸…ç†æ“ä½œï¼Œé¿å…æ½œåœ¨çš„é—®é¢˜å’Œé”™è¯¯ã€‚
4. å¦‚æœä¾èµ–é¡¹ä¸­çš„éƒ¨åˆ†å˜é‡æˆ–è€…å‡½æ•°å®šä¹‰åœ¨äº†ç»„ä»¶å†…éƒ¨ï¼Œå°±ä¼šæœ‰é£é™©ï¼šç»„ä»¶æ¯æ¬¡æ¸²æŸ“å¯¼è‡´è¿™ä¸ªå‡½æ•°æˆ–è€…å˜é‡é‡æ–°åŠ è½½ï¼Œè¿›è€Œå¯¼è‡´ `useEffect` æ¯æ¬¡éƒ½æ‰§è¡Œã€‚è€ƒè™‘æå–ä¿®æ”¹é€»è¾‘ä»£ç æˆ–è€…ä½¿ç”¨ `useCallback` æŠ€æœ¯ã€‚
5. `useEffect` æ˜¯åœ¨ dom æµç»˜åˆ¶å®Œæˆåæ‰§è¡Œçš„ï¼Œå¦‚æœä½ æƒ³è¦é¡µé¢åˆå§‹åŒ–è¿‡ç¨‹ä¸­åœ¨è¯¥å‡½æ•°ä¸­å¤„ç† dom ç»“æ„ï¼Œå¯ä»¥è€ƒè™‘æ”¾åœ¨ useLayoutEffect ä¸­ã€‚
6. `useEffect` ä»…åœ¨å®¢æˆ·ä¾§èƒ½ä½¿ç”¨ï¼ŒæœåŠ¡ä¾§ä½¿ç”¨è¯¦è§æˆ‘ä¹‹åçš„æ–‡ç« ã€‚

### è¿è¡Œæµç¨‹

æˆ‘ä»¬ä½¿ç”¨ä¸Šé¢çš„èŠå¤©å®¤çš„ä¾‹å­æ¥è§£é‡Šä¸€ä¸‹ `useEffect` è¿è¡Œæµç¨‹ã€‚React ä¼šåœ¨å¿…è¦æ—¶è°ƒç”¨ä¸€æ¬¡æˆ–å¤šæ¬¡ä½ çš„è®¾ç½®å’Œæ¸…ç†å‡½æ•°ã€‚

1. ç»„ä»¶åˆå§‹åŒ–æ—¶ï¼ŒuseEffect çš„è®¾ç½®å‡½æ•°æ‰§è¡Œä¸€æ¬¡
2. ä¾èµ–é¡¹æ›´æ–°æ—¶ï¼š
- ä½¿ç”¨æ—§çš„propså’Œstateï¼Œæ¸…ç†å‡½æ•°æ‰§è¡Œä¸€æ¬¡
- ä½¿ç”¨æ–°çš„propså’Œstateï¼Œè®¾ç½®å‡½æ•°æ‰§è¡Œä¸€æ¬¡
3. ç»„ä»¶é”€æ¯æˆ–è€…é‡æ¸²æŸ“æ—¶ï¼Œæ¸…ç†å‡½æ•°ä¼šæ‰§è¡Œä¸€æ¬¡

> useEffect çš„ä½œç”¨åœ¨äºæä¾›ä¸€ç§å°† `React`éå—æ§çš„ç³»ç»Ÿä¸ `React` çš„çŠ¶æ€é“¾æ¥çš„ä¸€ä¸ªåª’ä»‹ã€‚`React`éå—æ§ç³»ç»Ÿæ¯”å¦‚ setIntervalã€addEventListenerã€animation.start() ç­‰ã€‚å¦‚æœæ²¡æœ‰éå—æ§ç³»ç»Ÿå‚ä¸ï¼ŒuseEffect å¾€å¾€ä¸æ˜¯å¿…é¡»çš„ã€‚

### å„ç§ä½¿ç”¨ä¾‹å­

#### 1. ç›‘å¬é¼ æ ‡äº‹ä»¶

ä¸‹é¢çš„ä¾‹å­ï¼Œç›‘å¬äº†é¼ æ ‡æŒ‡é’ˆæ»‘åŠ¨äº‹ä»¶ï¼Œå¹¶åœ¨é¼ æ ‡æŒ‡é’ˆä¸‹æ–¹è®¾ç½®è·Ÿéšçš„åœ†å½¢é˜´å½±è£…é¥°ï¼š

```js
import { useState, useEffect } from 'react';

export default function App() {
  const [position, setPosition] = useState({ x: 0, y: 0 });

  useEffect(() => {
    function handleMove(e) {
      setPosition({ x: e.clientX, y: e.clientY });
    }
    window.addEventListener('pointermove', handleMove);
    return () => {
      window.removeEventListener('pointermove', handleMove);
    };
  }, []);

  return (
    <div style={{
      position: 'absolute',
      backgroundColor: 'pink',
      borderRadius: '50%',
      opacity: 0.6,
      transform: `translate(${position.x}px, ${position.y}px)`,
      pointerEvents: 'none',
      left: -20,
      top: -20,
      width: 40,
      height: 40,
    }} />
  );
}
```

#### 2. è®¾ç½®ä¸€æ®µåŠ¨ç”»ï¼ˆéƒ¨åˆ†ä»£ç ï¼‰

ç‚¹å‡»æŒ‰é’®ï¼Œåœ¨é¡µé¢æ¸å˜çš„æ˜¾ç¤ºä¸€ä¸ªå—çº§å…ƒç´ ï¼ˆ[å®Œæ•´ä»£ç ](https://codesandbox.io/s/ld0mxv?file=/animation.js:463-472&utm_medium=sandpack)ï¼‰ï¼š

```js
useEffect(() => {
    const animation = new FadeInAnimation(ref.current);
    animation.start(1000);
    return () => {
      animation.stop();
    };
  }, []);
```

#### 3. è¿½è¸ªå…ƒç´ ç»è¿‡å¯è§†åŒºåŸŸï¼ˆéƒ¨åˆ†ä»£ç ï¼‰

ä¸‹é¢çš„ä»£ç ï¼Œåœ¨æ‰“äº† ref çš„ div è¿›å…¥å¯è§†åŒºåŸŸåï¼Œæ·»åŠ èƒŒæ™¯è‰²å’Œå­—ä½“è‰²ï¼Œç¦»å¼€å¯è§†åŒºåŸŸåæ ·å¼å¤åŸï¼š

```js
useEffect(() => {
    const div = ref.current;
    const observer = new IntersectionObserver(entries => {
      const entry = entries[0];
      if (entry.isIntersecting) {
        document.body.style.backgroundColor = 'black';
        document.body.style.color = 'white';
      } else {
        document.body.style.backgroundColor = 'white';
        document.body.style.color = 'black';
      }
    });
    observer.observe(div, {
      threshold: 1.0
    });
    return () => {
      observer.disconnect();
    }
  }, []);
```

#### 4. åœ¨è‡ªå®šä¹‰ Hook ä¸­ä½¿ç”¨

æˆ‘ä»¬è¿˜ä»¥ä¸Šé¢èŠå¤©å®¤çš„ä¾‹å­åšè¯´æ˜ã€‚ä¸Šé¢çš„åŠŸèƒ½æ˜¯ roomId å’Œ service åˆ‡æ¢å°±è‡ªåŠ¨å…³é—­æ—§çš„é“¾æ¥ï¼Œæ‰“å¼€æ–°çš„é“¾æ¥ï¼Œæ‰€æœ‰çš„èŠå¤©é“¾æ¥åŠ¨ä½œéƒ½ä¸€æ ·ï¼Œå¯ä»¥æå–æˆå…¬å…±ç»„ä»¶æ¥ä½¿ç”¨ï¼š

```js
function useChatRoom({ serverUrl, roomId }) {
  useEffect(() => {
    const options = {
      serverUrl: serverUrl,
      roomId: roomId
    };
    const connection = createConnection(options);
    connection.connect();
    return () => connection.disconnect();
  }, [roomId, serverUrl]);
}
```

è¿™æ ·ï¼Œåªéœ€è¦ä½¿ç”¨è¿™ä¸ªå‡½æ•°å°±èƒ½å®ŒæˆèŠå¤©å®¤çš„é“¾æ¥å·¥ä½œï¼š

```js
useChatRoom({  
    roomId: roomId,  
    serverUrl: serverUrl  
});
```

å½“ç„¶äº†ï¼Œ[å…¨å±€éå—æ§äº‹ä»¶ï¼ˆaddEventListenerï¼‰](https://codesandbox.io/s/b006ec?file=/useWindowListener.js&utm_medium=sandpack)ã€[å¯è§†åŒºåŸŸç›‘å¬](https://codesandbox.io/s/m9drvd?file=/useIntersectionObserver.js&utm_medium=sandpack)ä¹Ÿå¯ä»¥å°è£…ä¸ºä¸€ä¸ªç‹¬ç«‹çš„ Hook æ¥ä½¿ç”¨ã€‚

#### 5. ä½¿ç”¨å®šæ—¶å™¨æ“ä½œ state

å¦‚æœæƒ³è¦åœ¨ `useState` é‡Œä½¿ç”¨å®šæ—¶å™¨æ“ä½œçŠ¶æ€å€¼ï¼Œä½ å¯èƒ½ä¼šè¿™æ ·å†™ï¼š

```js
unction Counter() {  
    const [count, setCount] = useState(0);  

    useEffect(() => {  
        const intervalId = setInterval(() => {  
            setCount(count + 1); // You want to increment the counter every second...  
        }, 1000)  

        return () => clearInterval(intervalId);  
    }, [count]); // ğŸš© ... but specifying `count` as a dependency always resets the interval.  
    // ...  
}
```

ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œcount æ˜¯ä¸€ä¸ªå“åº”å€¼ï¼Œåœ¨ useEffect ä¸­å¼•å…¥äº†ä»–çš„ä¾èµ–ï¼ŒåŒæ—¶ï¼Œè¿™æ˜¯å‡½æ•°ä¸­åˆæ”¹å˜äº†ä»–çš„å€¼ï¼Œè¿™å°±å¯¼è‡´äº† setInterval å‡½æ•°ä¼šè¢«åå¤çš„æ‰§è¡Œï¼Œå®šæ—¶å™¨æ¯æ¬¡éƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„å‡ºæ¥ã€‚ä»£ç é€»è¾‘å‡ºç°é”™è¯¯ä¸è¯´ï¼Œä¹Ÿæµªè´¹äº†å†…å­˜ç©ºé—´ã€‚

è§£å†³æ–¹æ¡ˆå…¶å®å¾ˆç®€å•ï¼Œä¸Šä¸€ç¯‡æ–‡ç« è®² `useState` çš„æ—¶å€™æåˆ°è¿‡ï¼ŒuseState å†…éƒ¨å¯ä»¥ä¼ ä¸€ä¸ªå‡½æ•°ï¼Œä»–çš„å‚æ•°å°±æ˜¯ä¸Šä¸€æ¬¡æ›´æ–°å®Œä¹‹åçš„çŠ¶æ€å€¼ï¼Œæ‰€ä»¥è¿™é‡Œå¹¶ä¸éœ€è¦å»æ‹¿ count è¿™ä¸ªå˜é‡ï¼š

```js
useEffect(() => {
  const intervalId = setInterval(() => {
    setCount(c => c + 1); // âœ… Pass a state updater
  }, 1000);
  return () => clearInterval(intervalId);
}, []); // âœ… Now count is not a dependency
```

### å…³äºä¾èµ–

ä¸æ¨èä¸å¼•å…¥å¿…é¡»çš„ä¾èµ–æˆ–è€…æ·»åŠ é¢å¤–çš„ä¸éœ€è¦çš„ä¾èµ–é¡¹ã€‚ä½ çš„ä¾èµ–é¡¹çš„é€‰æ‹©å–å†³äº `useEffect` åŒ…è£¹çš„ä»£ç ã€‚

ä¾èµ–çš„é€‰æ‹©ä¸ä»…åŒ…æ‹¬è®¾ç½®å‡½æ•°å†…æ‰€åº”ç”¨çš„å˜é‡ã€å‡½æ•°ï¼Œè¿˜åº”è€ƒè™‘åˆ°å„ä¸ªå˜é‡ã€å‡½æ•°å„è‡ªçš„å¼•ç”¨ä¾èµ–ã€‚å¦‚æœå¼•ç”¨çš„å‡½æ•°å†…çš„å˜é‡å˜åŒ–å¼•èµ·äº†è¯¥å‡½æ•°é‡æ–°è®¾ç½®ï¼Œè¿›è€Œä¾¿ä¼šè§¦å‘ `useEffec` æ‰§è¡Œã€‚

åœ¨ä¸Šé¢çš„èŠå¤©å®¤ä¾‹å­ä¸­ï¼ŒrootId æ˜¯é€šè¿‡ç”¨æˆ·ä¸‹æ‹‰åˆ‡æ¢å¾—æ¥çš„ï¼Œå¯ä»¥çœ‹åšæ˜¯ä¸€ä¸ªå“åº”å¼æ•°æ®ï¼›ä½†æ˜¯ serverUrl æ˜¯ä¸€ä¸ªå¸¸é‡å­—ç¬¦ä¸²ï¼Œå®Œå…¨ä¸éœ€è¦æ”¾åœ¨ state é‡Œï¼Œè¿›è€Œä¹Ÿå¯ä»¥ç§»å‡ºä¾èµ–é¡¹ï¼š

```js
useEffect(() => {  
    const connection = createConnection(serverUrl, roomId);  
    connection.connect();  

    return () => connection.disconnect();  
}, [roomId]); // âœ… All dependencies declared
```

å¦‚æœåŒ…è£¹çš„å‡½æ•°æ²¡æœ‰ä»»ä½•å¯å“åº”çš„æ•°æ®ï¼Œé‚£ä¹ˆå°±ç”¨ä¸€ä¸ªç©ºæ•°ç»„å³å¯ã€‚

### é£é™©é¡¹

å¯ä»¥é€šè¿‡ä¸€å®šçš„æ³¨é‡Šæ¬ºéª—ä¾èµ–é¡¹æ£€æŸ¥ï¼Œæ¯”å¦‚ï¼š

```js
useEffect(() => {
  // ...
  // ğŸ”´ Avoid suppressing the linter like this:
  // eslint-ignore-next-line react-hooks/exhaustive-deps
}, []);
```

è¿™ç§æƒ…å†µåœ¨ä½ è‚¥è‚ æ˜ç¡®åŒ…è£¹å‡½æ•°çš„ä¾èµ–å…³ç³»æ—¶æ‰å¯ä½¿ç”¨ï¼Œä½†æ˜¯è¿™åŒæ ·ä¸åˆ©äºå›¢é˜Ÿåˆä½œä¸­çš„ä»£ç ç»´æŠ¤ã€‚å¦‚æœåŒ…è£¹å‡½æ•°ä¸­çš„å˜é‡æˆ–è€…å‡½æ•°åœ¨ä»£ç è¿­ä»£ç»´æŠ¤è¿‡ç¨‹ä¸­å˜æˆäº†å“åº”å¼çš„ï¼Œä½†æ˜¯è¿™é‡ŒåˆæŠ‘åˆ¶äº†å‘Šè­¦æç¤ºï¼Œå¯èƒ½ä¼šå‡ºç°éš¾ä»¥æ’æŸ¥çš„é—®é¢˜ã€‚

> P.S. å¯èƒ½ä½ ä¼šè§‰å¾—: æˆ‘ä½¿ç”¨ç©ºæ•°ç»„å°±æ˜¯è¡¨ç¤ºç»„ä»¶åˆå§‹åŒ–åŠ è½½æ—¶è°ƒç”¨çš„å•Šï¼Œä¸ºä»€ä¹ˆè¿˜è¦ç»™æˆ‘å¼¹è­¦å‘Šï¼Ÿè¿™é‡Œï¼Œä½œè€…å»ºè®®ï¼Œä¸è¦åœ¨å‡½æ•°å¼ç»„ä»¶é‡Œè°ˆç”Ÿå‘½å‘¨æœŸï¼Œè¿™é‡Œåªæœ‰å“åº”å¼å‰¯ä½œç”¨å’Œå¸¸é‡ã€‚

## 3. å®éªŒæ€§APIï¼šuseEffectEvent

> è¯¥APIè¿˜å¤„äºè¯•éªŒé˜¶æ®µï¼Œæ­£å¼releaseç‰ˆå°šæœªå‘å¸ƒã€‚

ç†è®ºä¸Šï¼Œä¾èµ–æ›´æ–°äº†ï¼Œè®¾ç½®å‡½æ•°å°±ä¼šé‡æ–°æ‰§è¡Œï¼Œè€ƒè™‘ä¸‹é¢è®°å½•é¡µé¢è®¿é—®é‡çš„ä»£ç ï¼š

```js
function Page({ url, shoppingCart }) {  
    useEffect(() => { 
        // ...
        logVisit(url, shoppingCart.length);  
    }, [url, shoppingCart]); // âœ… All dependencies declared  
    // ...  
}
```
urlå’ŒshoppingCartå˜åŒ–ï¼Œéƒ½ä¼šé‡æ–°è°ƒç”¨logVisitå‡½æ•°æ¥å¢åŠ è®¿é—®è®¡æ•°ã€‚ä½†æ˜¯ï¼Œä½ åªå¸Œæœ›è®¿é—®urlå˜åŒ–æ—¶æ‰å¢åŠ è®¿é—®é‡ï¼ŒshoppingCartå˜åŒ–æ—¶logVisitä¸è¦é‡æ–°æ‰§è¡Œï¼Œä½†æ˜¯åœ¨æ‰§è¡Œæ—¶ï¼Œè´­ç‰©è½¦åˆå¾—æ˜¯æœ€æ–°çš„æ•°æ®ï¼Œæ€ä¹ˆåšå‘¢ï¼Ÿ

ç›´æ¥ç§»é™¤ä¾èµ–å¯èƒ½ä¼šå½±å“å‡½æ•°å†…éƒ¨å…¶ä»–åœ°æ–¹çš„å˜åŒ–ã€‚æ­¤æ—¶å¯ä»¥ä½¿ç”¨ `useEffectEvent`:

```js
function Page({ url, shoppingCart }) {
  const onVisit = useEffectEvent(visitedUrl => {
    // éå“åº”å¼çš„ï¼Œå³å¯ä»¥æ‹¿åˆ°å®æ—¶å…¶ä»–å“åº”å¼æ•°æ®ï¼Œåˆé¿å…äº†ä»–çš„å˜åŒ–å¼•èµ·å¤–éƒ¨æ›´æ–°
    logVisit(visitedUrl, shoppingCart.length)
  });

  useEffect(() => {
    onVisit(url);
  }, [url]); // âœ… All dependencies declared
  // ...
}
```
ä¸Šé¢çš„ä»£ç ï¼Œåœ¨urlå˜åŒ–åï¼Œä¼šæ‰§è¡ŒonVisit -> logVisitå‡½æ•°ï¼Œè¢« `useEffectEvent` åŒ…è£¹çš„å‡½æ•°ä¸æ˜¯å“åº”å¼çš„ï¼Œæ‰€ä»¥è¿™é‡Œä½¿ç”¨äº†å“åº”å€¼shoppingCartï¼Œæ—¢å¯ä»¥åŠæ—¶æ‹¿åˆ°æœ€æ–°çš„è´­ç‰©è½¦ä¿¡æ¯ï¼Œåˆé¿å…äº†è´­ç‰©è½¦å˜åŒ–å¼•èµ·åŒ…è£¹onVisitå‡½æ•°çš„ç»„ä»¶çš„å˜åŒ–ã€‚

> P.S. ä»–çš„ä½¿ç”¨æ–¹å¼åŒ useEvent

## 4. useLayoutEffect

`useLayoutEffect` æ˜¯ `useEffect` çš„ä¸€ä¸ªç‰ˆæœ¬ã€‚ä¸€èˆ¬ç”¨åœ¨æ§åˆ¶é¡µé¢æ¸²æŸ“çš„å·¥ä½œä¸­ï¼Œå…¶åœ¨é¡µé¢æ¸²æŸ“è¿‡ç¨‹ä¹‹å‰è°ƒç”¨ã€‚ï¼ˆä¼šå½±å“æ€§èƒ½ï¼‰

### ä½¿ç”¨åœºæ™¯

#### 1.é¡µé¢åˆå§‹åŒ–æ—¶è·å–çŸ©å½¢çš„é«˜åº¦

åœ¨å…ƒç´ æ¸²æŸ“ä¹‹å‰ï¼Œè·å–ä¸€ä¸ª ref æŒ‡å‘å…ƒç´ çš„é«˜åº¦ï¼Œå¹¶è®¾ç½®ç»™ç»„ä»¶çš„stateï¼š

```js
import { useState, useRef, useLayoutEffect } from 'react';

function Tooltip() {
  const ref = useRef(null);
  const [tooltipHeight, setTooltipHeight] = useState(0);

  useLayoutEffect(() => {
    const { height } = ref.current.getBoundingClientRect();
    setTooltipHeight(height);
  }, []);
  // ...
}
```

#### 2. åœ¨é¡µé¢é‡ç»˜ä¹‹å‰æ”¹åŠ¨å¸ƒå±€

ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œtooltip ç»„ä»¶éœ€è¦åœ¨é¡µé¢æ¸²æŸ“æ—¶è·å–æŒ‚è½½å…ƒç´ çš„é«˜åº¦ï¼Œè¿›è€Œç¡®è®¤åœ¨å“ªä¸ªæ–¹å‘ä¸Šæ¸²æŸ“ï¼š

```js
useLayoutEffect(() => {
    const { height } = ref.current.getBoundingClientRect();
    setTooltipHeight(height);
    console.log('Measured tooltip height: ' + height);
  }, []);

  let tooltipX = 0;
  let tooltipY = 0;
  if (targetRect !== null) {
    tooltipX = targetRect.left;
    tooltipY = targetRect.top - tooltipHeight;
    if (tooltipY < 0) {
      // It doesn't fit above, so place below.
      tooltipY = targetRect.bottom;
    }
  }
  
  // ...
  
  return createPortal(
    <TooltipContainer x={tooltipX} y={tooltipY} contentRef={ref}>
      {children}
    </TooltipContainer>,
    document.body
  );
```
å®Œæ•´ä¾‹å­è§[å®˜ç½‘demo](https://codesandbox.io/s/bj8hpt?file=/TooltipContainer.js&utm_medium=sandpack)

### æ³¨æ„äº‹é¡¹

åœ¨ä½¿ç”¨react SSRæ—¶ï¼Œåˆå§‹çš„ HTMLæ¸²æŸ“ä¼šæ—©äº js è„šæœ¬ï¼Œä½†æ˜¯åœ¨æœåŠ¡ç«¯æ²¡æœ‰å¸ƒå±€ä¿¡æ¯ï¼Œæ‰€ä»¥åœ¨ js è„šæœ¬åŠ è½½å®Œæ¯•åï¼Œé¡µé¢å¯èƒ½ä¼šå‡ºç°é—®é¢˜ï¼Œæ±‡æ€»å¦‚ä¸‹ï¼š

1.  ä¸ä¸€è‡´çš„æ¸²æŸ“ç»“æœï¼šç”±äºæœåŠ¡ç«¯æ¸²æŸ“å’Œå®¢æˆ·ç«¯æ¸²æŸ“çš„æ‰§è¡Œç¯å¢ƒä¸åŒï¼Œ`useLayoutEffect` åœ¨æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯å¯èƒ½ä¼šäº§ç”Ÿä¸ä¸€è‡´çš„ç»“æœã€‚è¿™å¯èƒ½å¯¼è‡´åœ¨æœåŠ¡ç«¯æ¸²æŸ“æ—¶å‡ºç°é—ªçƒã€å¸ƒå±€é”™ä¹±æˆ–ä¸ç¬¦åˆé¢„æœŸçš„è¡Œä¸ºã€‚
2.  æ— æ•ˆçš„ DOM æ“ä½œï¼š`useLayoutEffect` åœ¨æœåŠ¡ç«¯æ‰§è¡Œæ—¶ï¼Œæ— æ³•ç›´æ¥è®¿é—®åˆ°çœŸå®çš„ DOMã€‚å› æ­¤ï¼Œåœ¨è¿™ä¸ªé˜¶æ®µå¯¹ DOM è¿›è¡Œçš„æ“ä½œå¯èƒ½ä¼šå¯¼è‡´é”™è¯¯æˆ–æ— æ•ˆçš„ç»“æœã€‚
3.  æ€§èƒ½é—®é¢˜ï¼šç”±äº `useLayoutEffect` çš„æ‰§è¡Œæ˜¯åŒæ­¥çš„ï¼Œå¹¶ä¸”åœ¨æ¯ä¸ªæ¸²æŸ“å‘¨æœŸéƒ½ä¼šè¢«è°ƒç”¨ï¼Œå¯èƒ½ä¼šå¯¹æœåŠ¡å™¨çš„æ€§èƒ½äº§ç”Ÿè´Ÿé¢å½±å“ã€‚åœ¨å¤§è§„æ¨¡çš„ SSR é¡¹ç›®ä¸­ï¼Œé¢‘ç¹çš„åŒæ­¥ DOM æ“ä½œå¯èƒ½ä¼šå¯¼è‡´æ€§èƒ½ä¸‹é™å’Œå“åº”æ—¶é—´å»¶é•¿ã€‚

> å»ºè®®ï¼šæœåŠ¡ç«¯æ¸²æŸ“çš„é¡¹ç›®ä¸­ä½¿ç”¨ `useEffect` æ›¿ä»£ï¼Œå¹¶ä½¿ç”¨ [`<Suspense>`](https://react.dev/reference/react/Suspense) æ‡’åŠ è½½ç»„ä»¶ï¼Œæˆ–è€…ä½¿ç”¨ hydration æ¨¡å¼å¼€å‘ã€‚

## 5. useInsertionEffect

`useInsertionEffect` æ˜¯ `useEffect` çš„ä¸€ä¸ªç‰ˆæœ¬ã€‚å…¶åœ¨ DOM å˜æ›´ä¹‹å‰è§¦å‘ï¼Œæ˜¯ä¸€ä¸ªç»“åˆ CSS-in-JS çš„æ ·å¼ä¿®æ”¹çš„è‡ªå®šä¹‰ hookã€‚

### ä½¿ç”¨åœºæ™¯

###### ä» CSS-in-JS åº“ä¸­æ’å…¥åŠ¨æ€æ ·å¼

åœ¨è¿è¡Œä¸­çš„ä»£ç ä¸­ï¼ŒåŠ¨æ€æ’å…¥ style æ ·å¼ï¼Œæœ‰ä¸¤ä¸ªå¼Šç«¯ï¼š

1. è¿«ä½¿æµè§ˆå™¨æ›´é¢‘ç¹åœ°é‡æ–°è®¡ç®—æ ·å¼ã€‚
2. å¦‚æœè¿è¡Œæ—¶æ³¨å…¥å‘ç”Ÿåœ¨ React ç”Ÿå‘½å‘¨æœŸçš„é”™è¯¯æ—¶é—´ï¼Œå®ƒå¯èƒ½ä¼šéå¸¸æ…¢ã€‚

ä½¿ç”¨ useInsertionEffect å¯ä»¥ä¸ºæˆ‘ä»¬æä¾›ä¸€ç§æ–¹æ¡ˆï¼Œè§£å†³ä¸Šé¢ç¬¬äºŒä¸ªé—®é¢˜ã€‚ï¼ˆç¬¬ä¸€ä¸ªé—®é¢˜ç›®å‰ä¸å¯è§£ï¼‰ï¼š

```js
let isInserted = new Set();
function useCSS(rule) {
  useInsertionEffect(() => {
    // As explained earlier, we don't recommend runtime injection of <style> tags.
    // But if you have to do it, then it's important to do in useInsertionEffect.
    if (!isInserted.has(rule)) {
      isInserted.add(rule);
      document.head.appendChild(getStyleForRule(rule));
    }
  });
  return rule;
}

function Button() {
  const className = useCSS('...');
  return <div className={className} />;
}
```

useInsertionEffect åŒæ ·ä¸é€‚ç”¨äºæœåŠ¡ç«¯æ¸²æŸ“ï¼Œåœ¨ä¹¦å†™æ—¶éœ€è¦é¢å¤–åˆ¤æ–­ï¼š

```js
let collectedRulesSet = new Set();

function useCSS(rule) {
  if (typeof window === 'undefined') {
    collectedRulesSet.add(rule);
  }
  useInsertionEffect(() => {
    // ...
  });
  return rule;
}
```

> P.S. ä»–æ˜¯å¦‚ä½•è§£å†³ç¬¬äºŒæ¡é—®é¢˜çš„ï¼šå¦‚æœåœ¨æ¸²æŸ“æœŸé—´æ’å…¥æ ·å¼å¹¶ä¸” React æ­£åœ¨å¤„ç†éé˜»å¡æ›´æ–°ï¼Œåˆ™æµè§ˆå™¨å°†åœ¨æ¸²æŸ“ç»„ä»¶æ ‘æ—¶æ¯å¸§é‡æ–°è®¡ç®—æ ·å¼ï¼Œè¿™å¯èƒ½ä¼šéå¸¸æ…¢ã€‚useInsertionEffect æ¯”åœ¨ useLayoutEffect æˆ– useEffect ä¸­æ’å…¥æ ·å¼è¦å¥½ï¼Œå› ä¸ºå®ƒç¡®ä¿å½“å…¶ä»– Effects åœ¨ç»„ä»¶ä¸­è¿è¡Œæ—¶ï¼Œ\<style\> æ ‡ç­¾å·²ç»è¢«æ’å…¥ã€‚å¦åˆ™ï¼Œå¸¸è§„ Effects ä¸­çš„å¸ƒå±€è®¡ç®—å°†ç”±äºè¿‡æ—¶çš„æ ·å¼è€Œå‡ºé”™ã€‚

----

æœ¬æœŸå®Œäº†ï¼Œå€ºè§ï¼20:T3988,å®˜ç½‘åœ°å€ï¼š[React](https://beta.reactjs.org/)

## 1. useState

useState å¯ä»¥è¯´æ˜¯ä½¿ç”¨çš„æœ€é¢‘ç¹çš„ä¸€ä¸ª hook äº†ã€‚æ¥ä¸‹æ¥çœ‹çœ‹å®˜ç½‘æ€ä¹ˆè§£é‡Šä»–çš„ç”¨æ³•ã€‚ä»–æ˜¯ä¸€ä¸ªåœ¨å‡½æ•°å¼ç»„ä»¶å†…æ·»åŠ æš‚å­˜çŠ¶æ€çš„å‡½æ•°ï¼Œåœ¨ç»„ä»¶æ›´æ–°æ¸²æŸ“æ—¶ï¼Œèƒ½å¤Ÿä¿ç•™stateé‡Œå˜é‡çš„çŠ¶æ€ä¸è¢«åˆå§‹åŒ–ã€‚

åŒå…¶ä»– hook ä¸€æ ·ï¼Œä¸èƒ½åœ¨å¾ªç¯å’Œåˆ¤æ–­æ¡ä»¶é‡Œä½¿ç”¨ï¼Œå®˜æ–¹æ¨èåœ¨ç»„ä»¶é¡¶éƒ¨ä½¿ç”¨ï¼š

```js
import { useState } from 'react';  

function MyComponent() {  
    const [age, setAge] = useState(28);  
    const [name, setName] = useState('Taylor');  
    const [todos, setTodos] = useState(() => createTodos());  
    // ...
}
```

### æ¥å—å‚æ•°ï¼šinitialState

æ¥å—ä¸€ä¸ªåˆå§‹åŒ–çš„å€¼ã€‚åœ¨stateåˆ›å»ºæ—¶ï¼Œä¼šå°†å€¼è®°å½•ä¸ºè¿™ä¸ªåˆå§‹åŒ–çš„å€¼ï¼Œä¸ä¼ é»˜è®¤æ˜¯ `undefined`ã€‚

> P.S. å¦‚æœåˆå§‹åŒ–å€¼ä¼ ä¸ºä¸€ä¸ªå‡½æ•°ï¼Œå®ƒå°†è¢«ä½œä¸ºåˆå§‹åŒ–å‡½æ•°ã€‚è¦æ±‚å¿…é¡»æ˜¯çº¯å‡½æ•°ï¼Œä¸å¸¦ä»»ä½•å‚æ•°ï¼Œå¹¶ä¸”åº”è¯¥æœ‰è¿”å›å€¼ã€‚åˆå§‹åŒ–å‡½æ•°çš„è¿”å›å°†è¢«è®°å½•ä¸ºåˆå§‹çŠ¶æ€ã€‚è¯¥åˆå§‹åŒ–å‡½æ•°åªä¼šåŠ è½½ä¸€æ¬¡ï¼Œåœ¨ä¸‹ä¸€ä¸ªç»„ä»¶æ¸²æŸ“æ—¶ï¼Œä¸ä¼šè¢«é‡æ–°æ‰§è¡Œ

### è¿”å›å€¼

ä»–çš„è¿”å›å€¼æ˜¯ä¸€ä¸ªæ•°ç»„è§£æ„çš„å˜é‡ã€‚

- çŠ¶æ€

ç¬¬ä¸€ä¸ªå˜é‡æ˜¯çŠ¶æ€å˜é‡æœ¬èº«

- è®¾ç½®çŠ¶æ€å‡½æ•°

ç¬¬äºŒä¸ªå˜é‡æ˜¯è®¾ç½®çŠ¶æ€çš„å‡½æ•°ï¼Œè°ƒç”¨è¿™ä¸ªå‡½æ•°ä¼šé‡æ–°è®¾ç½®stateå€¼å¹¶è§¦å‘ç»„ä»¶çš„ re-render.

è®¾ç½®çŠ¶æ€çš„å‡½æ•°ä½¿ç”¨èŒƒä¾‹ï¼š

```js
const [name, setName] = useState('Edward');  

function handleClick() {  
    setName('Taylor');  
    setAge(a => a + 1);  
    // ...
}
```

### å…³äºè®¾ç½®å‡½æ•°ï¼ˆæ¯”å¦‚ setNameï¼‰

- å…¥å‚

å‚æ•°æ˜¯è¦è®¾ç½®çš„æ–°çŠ¶æ€çš„å€¼ï¼Œå¯ä»¥æ˜¯ä»»ä½•ç±»å‹ã€‚

> P.S. å¦‚æœä½ ä¼ äº†ä¸€ä¸ªå‡½æ•°è¿›å»ï¼ˆæ¯”å¦‚ä¸Šé¢çš„ setNameï¼‰ï¼Œè¿™ä¸ªå‡½æ•°ä¼šè¢«ä½œä¸ºæ›´æ–°å‡½æ•°å¯¹å¾…ã€‚åŒæ ·å¿…é¡»æ˜¯çº¯å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°çš„å‚æ•°æ˜¯æ›´æ–°ä¹‹å‰çš„çŠ¶æ€å€¼ï¼Œå‡½æ•°çš„è¿”å›å€¼ä¼šè¢«ä½œä¸ºæ–°çš„çŠ¶æ€å€¼ã€‚React ä¼šæŠŠä½ çš„æ›´æ–°å‡½æ•°æ”¾åˆ°ä¸€ä¸ªä»»åŠ¡é˜Ÿåˆ—é‡Œï¼ˆfiberè°ƒåº¦å™¨ï¼‰ï¼Œåœ¨ä¸‹ä¸€ä¸ªæ¸²æŸ“å‘¨æœŸåˆ°æ¥æ—¶ï¼Œfiberä¼šéå†é˜Ÿåˆ—ï¼ŒæŒ‰ç…§ä¸€å®šçš„ä¼˜å…ˆçº§æ‰§è¡Œå‡½æ•°å¹¶æ¸…ç©ºå¯¹åˆ—ã€‚

- è¿”å›å€¼

### æ–°çš„çŠ¶æ€å€¼

- â­ï¸ è®¾ç½®çŠ¶æ€å‡½æ•°çš„æ³¨æ„äº‹é¡¹

1. çŠ¶æ€åªåœ¨ä¸‹æ¬¡æ›´æ–°æ—¶å¼‚æ­¥å˜åŒ–ï¼Œå¦‚æœåœ¨è®¾ç½®çŠ¶æ€åç«‹å³è¯»å–çŠ¶æ€å€¼ï¼Œè¯»å–åˆ°çš„è¿˜æ˜¯è€çš„çŠ¶æ€ã€‚
2. å¦‚æœæä¾›çš„æ–°å€¼ä¸å½“å‰çŠ¶æ€ç›¸åŒï¼ˆç”± Object.is æ¯”è¾ƒç¡®å®šï¼‰ï¼Œ`React` å°†è·³è¿‡é‡æ–°æ¸²æŸ“ç»„ä»¶åŠå…¶å­ç»„ä»¶ã€‚
3. `React` æ˜¯æ‰¹é‡åˆå¹¶æ›´æ–° state çš„ã€‚å¤šä¸ªçŠ¶æ€æ›´æ–°æ“ä½œä¼šè¢«æ”¾å…¥ä¸€ä¸ªé˜Ÿåˆ—ä¸­ï¼Œç„¶ååœ¨é€‚å½“çš„æ—¶æœºè¿›è¡Œåˆå¹¶å’Œæ‰¹é‡å¤„ç†ã€‚è¿™å¯ä»¥é˜²æ­¢åœ¨å•ä¸ªäº‹ä»¶æœŸé—´å¤šæ¬¡é‡æ–°æ¸²æŸ“ã€‚åœ¨æå°‘æ•°æƒ…å†µä¸‹ï¼Œéœ€è¦å¼ºåˆ¶ `React` æå‰æ›´æ–°ç•Œé¢ï¼Œä¾‹å¦‚è®¿é—® DOMï¼Œå¯ä»¥ä½¿ç”¨ flushSyncã€‚
4. åœ¨æ¸²æŸ“æœŸé—´è°ƒç”¨ set å‡½æ•°åªå…è®¸åœ¨å½“å‰æ¸²æŸ“ç»„ä»¶ä¸­ã€‚ `React` å°†ä¸¢å¼ƒå…¶è¾“å‡ºå¹¶ç«‹å³ä½¿ç”¨æ–°çŠ¶æ€å†æ¬¡æ¸²æŸ“ã€‚ï¼ˆä¸‹è¾¹æœ‰åœ¨æ¸²æŸ“æ—¶è®¾ç½®çŠ¶æ€å€¼çš„ä¾‹å­ï¼‰
5. åœ¨ä¸¥æ ¼æ¨¡å¼ + å¼€å‘ç¯å¢ƒä¸‹ï¼Œåˆå§‹åŒ–å‡½æ•°ä¼šè¢«è°ƒç”¨ä¸¤æ¬¡æ¥å¸®åŠ©ä½ è°ƒè¯•é”™è¯¯ã€‚å¦‚æœä½ ä½¿ç”¨çš„æ˜¯çº¯å‡½æ•°ï¼Œç¬¬äºŒæ¬¡ç»“æœä¼šè¢«å¿½ç•¥æ‰ã€‚

### æ³¨æ„äº‹é¡¹

1. ä½œä¸ºä¸€ä¸ªhookï¼Œä»–åœ¨å‡½æ•°å¼ç»„ä»¶å†…æ˜¯å•å‘é“¾è¡¨å­˜å‚¨çš„ï¼Œæ‰€ä»¥å¿…é¡»æ”¾åœ¨ç»„ä»¶é¡¶å±‚ä½¿ç”¨ã€‚å¦‚æœä½ éœ€è¦åœ¨å¾ªç¯æˆ–è€…æ¡ä»¶è¯­å¥é‡Œä½¿ç”¨ï¼Œå°±æå–æˆå•ç‹¬çš„ç»„ä»¶ä½¿ç”¨ã€‚
2. åœ¨ä¸¥æ ¼æ¨¡å¼ + å¼€å‘ç¯å¢ƒä¸‹ï¼Œåˆå§‹åŒ–å‡½æ•°ä¼šè¢«è°ƒç”¨ä¸¤æ¬¡æ¥å¸®åŠ©ä½ è°ƒè¯•é”™è¯¯ã€‚å¦‚æœä½ ä½¿ç”¨çš„æ˜¯çº¯å‡½æ•°ï¼Œç¬¬äºŒæ¬¡ç»“æœä¼šè¢«å¿½ç•¥æ‰ã€‚

### å„ç§ä½¿ç”¨ä¾‹å­

#### 1. åœ¨è®¾ç½®çŠ¶æ€åç«‹å³è¯»å–çŠ¶æ€å€¼

```js
function handleClick() {
    const [name, setName] = useState('Taylor');
    //...
    setName('Robin');  
    console.log(name); // Still "Taylor"!  
}
```

å¦‚æœæƒ³è¦è·å–åˆ°å˜åŒ–åçš„å€¼ï¼Œå¯ä»¥ä½¿ç”¨ `useEffect`

#### 2. åŸºç¡€ä½¿ç”¨ï¼šå¤šçŠ¶æ€ä¸è¡¨å•ç»“åˆ

```jsx
import { useState } from 'react';

export default function Form() {
  const [name, setName] = useState('Taylor');
  const [age, setAge] = useState(42);

  return (
    <>
      <input
        value={name}
        onChange={e => setName(e.target.value)}
      />
      <button onClick={() => setAge(age + 1)}>
        Increment age
      </button>
      <p>Hello, {name}. You are {age}.</p>
    </>
  );
}
```

#### 3. åœ¨å®šæ—¶å™¨ä¸­ä½¿ç”¨

åœ¨å®šæ—¶å™¨å›è°ƒå‡½æ•°ä¸­ä½¿ç”¨ç»„ä»¶ï¼š

```js
const [count, setCount] = useState(0);

const counterIntervalFunction = () => {
  console.log(count);
  setCount(count + 1)
};

// ...
const interval = setInterval(counterIntervalFunction, 1000);
```

ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œå®šæ—¶å™¨ä¸­è¯•å›¾ä¿®æ”¹stateçš„å€¼ï¼Œä½†æ˜¯ï¼Œå› ä¸ºé—­åŒ…çš„åŸå› ï¼ŒcounterIntervalFunctionä¸­æ‰“å°çš„ç»“æœæ¯æ¬¡éƒ½æ˜¯ 1ï¼Œå¹¶æ²¡æœ‰å®ç°ç´¯åŠ çš„æ•ˆæœã€‚

æ­¤æ—¶å¯ä»¥ä½¿ç”¨ç¬¬äºŒç§å†™æ³•ï¼š

```js
setCount(prev => prev + 1)
```

ä¹Ÿå¯ä»¥å€ŸåŠ© useRefï¼š

```js
const ref = useRef({ count });
useEffect(() => { 
    ref.current = { count }
}, [count]);
```
è¿™æ ·ï¼Œåœ¨ counterIntervalFunction é‡Œæ‹¿ ref.current.count å°±å¯ä»¥å•¦ã€‚å½“ç„¶äº†ï¼Œä½ ä¹Ÿå¯ä»¥æŠŠæ•´ä¸ªå®šæ—¶å™¨éƒ½æ”¾åœ¨åŸºäºcountçš„ `useEffect` ä¸­ï¼Œä¸€æ ·å¯ä»¥å®ç°ç›¸åŒçš„åŠŸèƒ½ã€‚

#### 4. åŸºäºä¸Šä¸€æ¬¡çŠ¶æ€æ›´æ–°çŠ¶æ€å€¼

```js
function handleClick() {  
    // é”™è¯¯å†™æ³•
    setAge(age + 1); // setAge(42 + 1)  
    setAge(age + 1); // setAge(42 + 1)  
    setAge(age + 1); // setAge(42 + 1)  
    
    // æ­£ç¡®å†™æ³• âœ…
    setAge(a => a + 1); // setAge(42 => 43)  
    setAge(a => a + 1); // setAge(43 => 44)  
    setAge(a => a + 1); // setAge(44 => 45)
}
```

#### 5. stateæ˜¯ä¸€ä¸ªå¯¹è±¡æ—¶ï¼Œä¿®æ”¹stateéœ€è¦æ”¹å˜å¼•ç”¨

```js
// ä¸ç”Ÿæ•ˆ
form.firstName = 'Taylor';

// æ¨è
setForm({  
    ...form,  
    firstName: 'Taylor'  
});
```

#### 6. é¿å…åˆå§‹åŒ–å‡½æ•°é‡å¤æ‰§è¡Œ

è€ƒè™‘ä¸‹é¢çš„ä¾‹å­ï¼š

```js
function TodoList() {  
    const [todos, setTodos] = useState(createInitialTodos());  
    // ...
}
```

è™½ç„¶createInitialTodosæœ‰æ•ˆæ‰§è¡Œåªæœ‰ç»„ä»¶æŒ‚è½½æ—¶ä¸€æ¬¡ï¼Œä½†åœ¨ä¹‹åç»„ä»¶å†æ¬¡re-renderæ—¶éƒ½ä¼šè¢«æ‰§è¡Œï¼Œè¿™å°±é€ æˆäº†èµ„æºæµªè´¹ã€‚å…¶å®ä½ åªéœ€è¦ä¼ é€’åˆå§‹åŒ–å‡½æ•°å£°æ˜å°±è¡Œäº†ï¼š

```js
function TodoList() {  
    const [todos, setTodos] = useState(createInitialTodos);  
    // ...
}
```

#### 7. é‡ç½®çŠ¶æ€å€¼

å¯ä»¥å€ŸåŠ© `React` æœ€å¸¸è§çš„ key å€¼æ¥é‡ç½®çŠ¶æ€ï¼š

```js
import { useState } from 'react';

export default function App() {
  const [version, setVersion] = useState(0);

  function handleReset() {
    setVersion(version + 1);
  }

  return (
    <>
      <button onClick={handleReset}>Reset</button>
      <Form key={version} />
    </>
  );
}

function Form() {
  const [name, setName] = useState('Taylor');

  return (
    <>
      <input
        value={name}
        onChange={e => setName(e.target.value)}
      />
      <p>Hello, {name}.</p>
    </>
  );
}
```

ä¸Šé¢çš„ä¾‹å­ä¸­ï¼ŒæŠŠä¸€ä¸ª state å½“åškeyä¼ é€’ç»™è¡¨å•ç»„ä»¶ï¼Œå½“éœ€è¦é‡ç½®è¡¨å•ç»„ä»¶æ—¶ï¼Œæ”¹å˜è¿™ä¸ªkeyå€¼ï¼ŒReactç»„ä»¶å°±ä¼šè‡ªè‡ªåŠ¨ re-create ä¸€æ¬¡è¡¨å•ï¼Œè¾¾åˆ°äº†é‡ç½®çš„ç›®çš„ï¼Œé‡ç½®åï¼Œè¡¨å•ç»„ä»¶é‡Œçš„æ‰€æœ‰stateéƒ½ä¼šé‡ç½®ã€‚

#### 8. ç»„ä»¶æ¸²æŸ“æœŸé—´ æ”¹å˜ state

ä¸€èˆ¬ä¸Šï¼ŒçŠ¶æ€å€¼çš„ä¿®æ”¹éƒ½ä¼šæ”¾åœ¨ä¸€ä¸ªäº‹ä»¶çš„handleBaré‡Œï¼Œä½†æ˜¯ï¼Œæœ‰æ—¶å€™ä½ æƒ³è¦åœ¨é™¤äº†äº‹ä»¶ä»¥å¤–çš„å“åº”ä¸­æ”¹å˜çŠ¶æ€å€¼ ï¼ˆæ¯”å¦‚ props æ”¹å˜çš„æ—¶å€™ï¼‰ï¼Œåº”è¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿä¸‹é¢ç»™å‡ºä¸€ä¸ªèŒƒä¾‹ï¼š

```js
import { useState } from 'react';

export default function CountLabel({ count }) {
  const [prevCount, setPrevCount] = useState(count);
  const [trend, setTrend] = useState(null);
  if (prevCount !== count) {
    setPrevCount(count);
    setTrend(count > prevCount ? 'increasing' : 'decreasing');
  }
  return (
    <>
      <h1>{count}</h1>
      {trend && <p>The count is {trend}</p>}
    </>
  );
}
```
ä¸Šé¢çš„ä¾‹å­ä½¿ç”¨èµ·æ¥éœ€æ³¨æ„ï¼Œ`prevCount !== count`çš„åˆ¤æ–­æ¡ä»¶ä¸èƒ½çœå»ï¼Œä¸ç„¶å°±ä¼šé™·å…¥åå¤ set çŠ¶æ€çš„æ­»å¾ªç¯é‡Œã€‚

å½“ç„¶äº†ï¼Œä½ ä¹Ÿå¯ä»¥åƒä¸Šä¸€ç¯‡æ–‡ç« é‚£æ ·ï¼Œä½¿ç”¨ useMemo è·å¾—è®¡ç®—å±æ€§ã€‚

### Q&A

#### 1. æˆ‘å·²ç»æ›´æ–°äº†çŠ¶æ€ï¼Œä½†æ˜¯console.logæ‰“å°äº†æ—§çš„å€¼

```js
function handleClick() {  
    console.log(count); // 0  
    setCount(count + 1); // Request a re-render with 1  
    console.log(count); // Still 0!  
    
    setTimeout(() => {  
        console.log(count); // Also 0!  
    }, 5000);  
}
```

å› ä¸ºReact çš„stateç±»ä¼¼äºå¿«ç…§ï¼Œæ›´æ–°äº†çŠ¶æ€åï¼Œå¹¶ä¸å½±å“ä¹‹å‰å·²ç»åœ¨fiberä»»åŠ¡äº‹ä»¶å¾ªç¯é‡Œçš„çŠ¶æ€ã€‚å¦‚æœéœ€è¦ç«‹å³ä½¿ç”¨ï¼Œå¯ä»¥å€ŸåŠ©ä¸´æ—¶å˜é‡ï¼š

```js
const nextCount = count + 1;  

setCount(nextCount);  

console.log(count); // 0  

console.log(nextCount); // 1
```

#### 2. æˆ‘å·²ç»æ›´æ–°äº†çŠ¶æ€ï¼Œä½†æ˜¯ç•Œé¢ä¸å˜åŒ–

å‰åä¸¤æ¬¡ä¿®æ”¹çš„çŠ¶æ€ï¼Œå¦‚æœç›¸ç­‰ï¼ˆObject.isï¼‰çš„è¯ï¼Œå°±ä¸ä¼šå»è§¦å‘æ¸²æŸ“ã€‚é”™è¯¯ç¤ºèŒƒï¼š

```js
obj.x = 10; // ğŸš© Wrong: mutating existing object  
setObj(obj); // ğŸš© Doesn't do anything
```

æ­£ç¡®ä½¿ç”¨æ–¹å¼ï¼š

```js
// âœ… Correct: creating a new object
setObj({
  ...obj,
  x: 10
});
```

#### 3. æ§åˆ¶å°æŠ¥é”™ â€œToo many re-renders. React limits the number of renders to prevent an infinite loop.â€

ä¸€èˆ¬è¿™ç§æƒ…å†µå°±æ˜¯ç»„ä»¶æ¸²æŸ“è¿›å…¥äº†æ­»å¾ªç¯ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªå¯èƒ½çš„ä¾‹å­åŠè§£å†³æ–¹æ¡ˆï¼š

```js
// ğŸš© Wrong: calls the handler during render
return <button onClick={handleClick()}>Click me</button>

// âœ… Correct: passes down the event handler
return <button onClick={handleClick}>Click me</button>

// âœ… Correct: passes down an inline function
return <button onClick={(e) => handleClick(e)}>Click me</button>
```

#### 4. æˆ‘æƒ³è¦æŠŠä¸€ä¸ªå‡½æ•°ä½œä¸º stateï¼Œä½†æ˜¯å´å½“æˆäº†åˆå§‹å‡½æ•°æ‰§è¡Œäº†

ä¸Šé¢çš„è®²è¿‡ï¼ŒuseState çš„å…¥å‚å¦‚æœæ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œåˆ™ä¼šå°†å‡½æ•°æ‰§è¡Œç»“æœä½œä¸ºåˆå§‹å‡½æ•°ã€‚å¦‚æœä¸€å®šè¦ä¼ ä¸€ä¸ªå‡½æ•°ä½œä¸ºçŠ¶æ€ï¼Œå¯ä»¥ä½¿ç”¨é«˜é˜¶å‡½æ•°ï¼š

```js
const [fn, setFn] = useState(() => someFunction);

function handleClick() {
  setFn(() => someOtherFunction);
}
```

## 2. useReducer

useReducer æ˜¯ä¸€ä¸ªä¸€èˆ¬åŒ–çš„ useStateï¼Œæ¯” useState å¤šäº†ä¸€ä¸ªå¤„ç†å‡½æ•°ï¼Œè¯¥å‡½æ•°å¯ä»¥æ ¹æ®ä¸åŒçš„åˆ†å‘çŠ¶æ€æ¥ç›¸åº”çš„æ”¹å˜çŠ¶æ€ã€‚å¯ä»¥è¿™ä¹ˆç†è§£ï¼ŒuseReducer æ˜¯ä¸€ä¸ªæå‰å†™å¥½äº†æ€ä¹ˆå¤„ç† state çš„å‡½æ•°çš„ useStateã€‚

å£°æ˜æ ¼å¼ï¼š

```js
const [state, dispatch] = useReducer(reducer, initialArg, init)
```

### æ¥æ”¶å‚æ•°

1. reducer

reducer å‡½æ•°æŒ‡å®šå¦‚ä½•æ›´æ–°çŠ¶æ€ï¼Œå¿…é¡»æ˜¯ä¸€ä¸ªçº¯å‡½æ•°ã€‚

2. initialArg

çŠ¶æ€çš„åˆå§‹å€¼

3. init

å¯é€‰åˆå§‹åŒ–å¤„ç†å‡½æ•°ã€‚å¦‚æœæœªæŒ‡å®šï¼Œåˆ™åˆå§‹çŠ¶æ€è®¾ç½®ä¸º initialArgã€‚å¦åˆ™ï¼Œåˆå§‹çŠ¶æ€è®¾ç½®ä¸ºè°ƒç”¨ `init(initialArg)` çš„ç»“æœã€‚

### è¿”å›å€¼

1. state ä¸ºå½“å‰çš„çŠ¶æ€å€¼
2. dispatch å‡½æ•°ï¼Œç”¨äºæ›´æ–°çŠ¶æ€

### æ³¨æ„äº‹é¡¹

ä½¿ç”¨æ–¹å¼åŒ useState

### åŸºæœ¬ä½¿ç”¨

```js
import { useReducer } from 'react';

function reducer(state, action) {
  // ...
}

const [state, dispatch] = useReducer(reducer, { age: 42 });

function handleClick() {
  dispatch({ type: 'incremented_age' });
  // ...
}
```

#### dispatch å‡½æ•°

æ¥å—ä¸€ä¸ª state å’Œ actionã€‚action å¯ä»¥æ˜¯ä»»æ„ç±»å‹çš„å€¼ï¼Œå¯ä»¥æ˜¯ä¸€ä¸ªæ ‡å¿—ä½ + payload çš„å½¢å¼ï¼›åŒæ—¶ï¼Œdispatch å‡½æ•°æ²¡æœ‰è¿”å›å€¼ã€‚

### ä½¿ç”¨ä¾‹å­

###### 1. ä¸formè¡¨å•ç»“åˆ

```jsx
import { useReducer } from 'react';

function reducer(state, action) {
  switch (action.type) {
    case 'incremented_age': {
      return {
        ...state,
        age: state.age + 1
      };
    }
    case 'changed_name': {
      return {
        name: action.nextName,
        age: state.age
      };
    }
  }
  
  // è¿™é‡Œå¤„ç†æœªçŸ¥æƒ…å†µï¼Œå¯ä»¥è¿”å›ä¸€ä¸ªè‡ªå®šä¹‰å¯¹è±¡ï¼Œä¹Ÿå¯ä»¥æŠ›å‡ºé”™è¯¯
  throw Error('Unknown action: ' + action.type);
}

const initialState = { name: 'Taylor', age: 42 };

export default function Form() {
  const [state, dispatch] = useReducer(reducer, initialState);

  function handleButtonClick() {
    dispatch({ type: 'incremented_age' });
  }

  function handleInputChange(e) {
    dispatch({
      type: 'changed_name',
      nextName: e.target.value
    }); 
  }

  return (
    <>
      <input
        value={state.name}
        onChange={handleInputChange}
      />
      <button onClick={handleButtonClick}>
        Increment age
      </button>
      <p>Hello, {state.name}. You are {state.age}.</p>
    </>
  );
}
```

è¡¨å•å…ƒç´ çš„ value æ˜¯ stateå†…éƒ¨çš„å€¼ï¼Œåœ¨è¡¨å•å…ƒç´ æ”¹å˜çš„äº‹ä»¶ä¸­ï¼Œdispatchè¿™ä¸ªreducerï¼Œdispatché‡Œä¼ äº†ä¸ª typeå’Œä¸€ä¸ª payload é¡¹ï¼šnextNameï¼Œæ­¤æ—¶ï¼Œreducerå°±å¯ä»¥æ¥æ”¶å‚æ•°äº†ï¼šstateå°±æ˜¯å½“å‰å˜æ›´å‰çš„çŠ¶æ€å€¼ï¼Œactionå°±æ˜¯ dispatch ä¼ é€’çš„å‚æ•°ã€‚

> P.S. reducer å‡½æ•°é‡Œä¸èƒ½ç›´æ¥æ”¹ stateï¼š`state.age = state.age + 1;`ï¼Œä»–åº”è¯¥è¿”å›ä¸€ä¸ªæ–°çš„å¼•ç”¨çš„å¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡ä¼šè‡ªåŠ¨è¢« useReducer è®¾ç½®ã€‚

###### 2. é¿å…é‡æ–°æ‰§è¡Œåˆå§‹å‡½æ•°

è€ƒè™‘ä¸‹é¢çš„ä¾‹å­ï¼š

```js
function createInitialState(username) {  
    // ...  
}  

function TodoList({ username }) {  
    const [state, dispatch] = useReducer(reducer, createInitialState(username));  
    // ...
}
```

ç¬¬äºŒä¸ªå‚æ•°æœ¬æ¥æ˜¯åˆå§‹åŒ–çŠ¶æ€çš„ä½ç½®ï¼Œä¼ äº†ä¸ªå‡½æ•°è°ƒç”¨ï¼Œè€Œä¸æ˜¯å‡½æ•°å£°æ˜ï¼Œåœ¨æ¯æ¬¡ç»„ä»¶re-renderæ—¶éƒ½ä¼šè¢«æ‰§è¡Œï¼Œå½±å“æ€§èƒ½ã€‚

è€ƒè™‘å¦‚ä¸‹æ”¹é€ ï¼š

```js
const [state, dispatch] = useReducer(reducer, username, createInitialState);
```
ç¬¬äºŒä¸ªå‚æ•°è¿˜æ˜¯é™æ€çš„åˆå§‹å€¼ï¼Œç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯è‡ªå®šä¹‰çš„åˆå§‹åŒ–å¤„ç†å‡½æ•°ï¼Œåœ¨åˆå§‹åŒ–æ—¶ï¼Œä¼šå°† `createInitialState(username)` çš„è¿”å›å€¼ä½œä¸ºåˆå§‹å€¼ã€‚

### Q&A

###### 1. dispatch åå¦‚ä½•ä½¿ç”¨æœ€æ–°çš„çŠ¶æ€å€¼

ä¸ useState ç±»ä¼¼ï¼Œéœ€ä½¿ç”¨å±€éƒ¨å˜é‡ï¼š

```js
const action = { type: 'incremented_age' };
dispatch(action);

const nextState = reducer(state, action);
console.log(state);     // { age: 42 }
console.log(nextState); // { age: 43 }
```

###### 2. æˆ‘çš„ reducer ä¸ºä»€ä¹ˆæ€»æ˜¯è¢«æ‰§è¡Œäº†å¤šæ¬¡ï¼Ÿ

è¿™ä¸ªè¿˜æ˜¯è·Ÿä¸¥æ ¼æ¨¡å¼å’Œå¼€å‘ç¯å¢ƒæœ‰å…³ç³»çš„ã€‚å¼€å‘ç¯å¢ƒä¼šå¸®ä½ æ£€æµ‹ä½ çš„ reducer æ˜¯å¦æ˜¯çº¯å‡½æ•°ã€‚è€ƒè™‘ä¸‹é¢çš„ä¾‹å­ï¼š

```js
function reducer(state, action) {
  switch (action.type) {
    case 'added_todo': {
      // ğŸš© Mistake: mutating state
      state.todos.push({ id: nextId++, text: action.text });
      return state;
    }
    // ...
  }
}
```
ä¸Šé¢çš„ reducer å°±ä¸æ˜¯ä¸€ä¸ªçº¯å‡½æ•°ï¼Œåœ¨å¼€å‘ç¯å¢ƒä¸­ï¼Œæ‰§è¡Œä¸¤æ¬¡ï¼Œtodosæ•°ç»„æ•°æ®å°±ä¼šé”™ä¹±ï¼Œå¼€å‘è€…å°±å¾ˆå®¹æ˜“å‘ç°é—®é¢˜å¹¶åŠæ—¶æ”¹æ­£ã€‚ä¸‹é¢ç»™å‡ºæ­£ç¡®çš„å‚è€ƒï¼š

```js
// âœ… Correct: replacing with new state
return {
  ...state,
  todos: [
    ...state.todos,
    { id: nextId++, text: action.text }
  ]
};
```

> ä¸çŸ¥ä¸è§‰ï¼Œå†™åˆ°è¿™é‡Œå·²ç» 1W å­—äº†...

----

æœ¬æœŸçš„å®˜ç½‘è§£è¯»å°±åˆ°è¿™é‡Œå•¦ï¼Œå€ºè§ï¼21:T2d8e,React å®˜ç½‘å‡ºäº† beta ç‰ˆçš„æ–°ç‰ˆæœ¬ï¼Œä»æ—§æ²¡æœ‰ä¸­æ–‡ç‰ˆã€‚å¯¹äºå›½å†…ä¸å°‘å¼€å‘è€…æ¥è¯´å¢åŠ äº†ä¸å°‘éº»çƒ¦ã€‚æˆ‘è¿™é‡Œä»¥å‰ç«¯å¼€å‘çš„è§’åº¦å½’çº³æ€»ç»“ä¸€ä¸‹ï¼ŒæŠŠå…¶ä¸­å¤§å®¶é‡ç‚¹ä½¿ç”¨çš„éƒ¨åˆ†ä»‹ç»ç»™å¤§å®¶ã€‚

å®˜ç½‘åœ°å€ï¼š[React](https://beta.reactjs.org/)

æˆ‘ä»¬å…ˆä»ç”¨çš„æœ€å¤šçš„ hook éƒ¨åˆ†å¼€å§‹ã€‚

## 1. [useCallback]

useCallback è¿”å›ä¸€ä¸ªè®°å¿†åŒ–çš„å›è°ƒå‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°åªæœ‰åœ¨ä¾èµ–é¡¹æ”¹å˜æ—¶æ‰ä¼šå‘ç”Ÿå˜åŒ–ã€‚è¿™æ˜¯å¯¹å›è°ƒå‡½æ•°è¿›è¡Œæ€§èƒ½ä¼˜åŒ–çš„ä¸€ç§æ–¹å¼ï¼Œä»¥ç¡®ä¿å­ç»„ä»¶ä¸ä¼šåœ¨çˆ¶ç»„ä»¶é‡æ–°æ¸²æŸ“æ—¶é‡å¤æ¸²æŸ“ã€‚

å®šä¹‰ï¼š

```js
const cachedFn = useCallback(fn, dependencies);
```

### ä½¿ç”¨

```js
import { useCallback } from 'react';

export default function ProductPage({ productId, referrer, theme }) {
  const handleSubmit = useCallback(
    (orderDetails) => {
      post('/product/' + productId + '/buy', {
        referrer,
        orderDetails,
      });
    },
    [productId, referrer],
  );
}
```

### å‚æ•°

- fnï¼šæƒ³è¦ç¼“å­˜çš„å‡½æ•°
- ä¾èµ–é¡¹ï¼šç¼“å­˜æ›´æ–°çš„æ¡ä»¶

### è¿”å›å€¼

- åˆå§‹åŒ–æ—¶ï¼Œè¿”å›ç¼“å­˜çš„åŸå§‹å‡½æ•°
- ä¾èµ–é¡¹æ²¡æœ‰å˜åŒ–ï¼ˆObject.is åˆ¤æ–­ï¼‰ï¼Œè¿”å›ä¸Šæ¬¡ç¼“å­˜çš„å‡½æ•°ï¼Œå¦åˆ™è¿”å›æœ€æ–°çš„å‡½æ•°

### æ³¨æ„äº‹é¡¹

- ç»„ä»¶æ–‡ä»¶ä¿®æ”¹åï¼Œç¼“å­˜ä¼šå¤±æ•ˆ
- åˆå§‹åŒ–åï¼Œsuspends åŠ è½½å‰çš„ç»„ä»¶ï¼Œä¸ä¼šç¼“å­˜å‡½æ•°

### Future

- æœ‰æœ›åœ¨è™šæ‹Ÿåˆ—è¡¨å®ç°æ»šåŠ¨åŒºåŸŸå¤–çš„å…ƒç´ åœæ­¢ç¼“å­˜

### ä½¿ç”¨åœºæ™¯

#### åœ¨ç»„ä»¶ re-render æ—¶è·³è¿‡é‡æ¸²æŸ“

å®˜æ–¹æ¡ˆä¾‹ï¼š

```js
// å‡è®¾æ²¡æœ‰ä½¿ç”¨ useCallback çš„ ProductPage
export default function ProductPage({ productId, referrer, theme }) {
  const handleSubmit = (orderDetails) => {
    post('/product/' + productId + '/buy', {
      referrer,
      orderDetails,
    });
  }

  return (
    <div className={theme}>
      <ShippingForm onSubmit={handleSubmit} />
    </div>
  );
}
```

å½“ theme å˜åŒ–æ—¶ï¼ŒShippingForm ä¼šè¢«é‡æ–°æ¸²æŸ“ï¼Œé¡µé¢éš¾å…é€ æˆé˜»å¡ã€‚æ¥ä¸‹æ¥ä¼˜åŒ– ShippingFormã€‚

> å®˜æ–¹æ³¨é‡Šï¼šBy default, when a component re-renders, React re-renders all of its children recursively. 

ä¸ºäº†è§„é¿ç”± props å˜åŒ–é€ æˆçš„ä¸å¿…è¦çš„æ¸²æŸ“ï¼Œå¯ä»¥ä½¿ç”¨ memoï¼š

```js
const ShippingFormMemo = memo(function ShippingForm({ onSubmit }) {
  // ...
});
```

ä¸Šé¢è¿™ç§æƒ…å†µä¸‹ï¼Œå½“ props æ£€æµ‹å‡ºå˜åŒ–å‰åä¸€æ ·æ—¶ï¼Œè¢« memo åŒ…è£¹çš„ç»„ä»¶ä¸åšé‡æ–°æ¸²æŸ“ã€‚æ­¤æ—¶ï¼Œ**useCallback å°±èƒ½èµ·åˆ°ä½œç”¨äº†**ã€‚ä¸Šé¢çš„ä¾‹å­ï¼Œå¦‚æœä½ ä¸ä½¿ç”¨ useCallbackï¼Œç»„ä»¶æ¸²æŸ“å‰åï¼Œjs ä¼šåˆ›å»ºä¸¤æ¬¡ handleSubmitï¼Œä»–ä»¬åœ¨å†…å­˜ä¸­åœ°å€ä¸ä¸€æ ·ï¼Œè‡ªç„¶æ˜¯ä¸åŒçš„æ•°æ®ï¼Œæ­¤æ—¶ memo å°±å¤±æ•ˆäº†ï¼

æ‰€ä»¥ä¸ºäº† memo èƒ½å¤Ÿèµ·ä½œç”¨ï¼Œè¢«ä»–åŒ…è£¹çš„ ç»„ä»¶ä¸­çš„propsçš„å±æ€§åº”è¯¥ä½¿ç”¨ useCallbackã€‚

#### åœ¨ç¼“å­˜ä¸­ä½¿ç”¨ state

```js
function TodoList() {
  const [todos, setTodos] = useState([]);

  const handleAddTodo = useCallback(
    (text) => {
      const newTodo = { id: nextId++, text };
      setTodos([...todos, newTodo]);
    },
    [todos],
  );
  // ...
}
```

è®¾ç½® state çš„è¯­å¥å¯ä»¥å†™æˆä¸‹é¢å½¢å¼ï¼š

```js
const handleAddTodo = useCallback((text) => {
  const newTodo = { id: nextId++, text };
  setTodos((todos) => [...todos, newTodo]);
}, []); // âœ… No need for the todos dependency
```

#### é˜²æ­¢ useEffect è¿‡å¤šè§¦å‘

çœ‹ä¸‹é¢èŠå¤©å®¤çš„ä¾‹å­ï¼š

```js
function createOptions() {
  return {
    serverUrl: 'https://localhost:1234',
    roomId: roomId,
  };
}

useEffect(() => {
  const options = createOptions();
  const connection = createConnection();
  connection.connect();
  return () => connection.disconnect();
}, [createOptions]);
```

ç”¨ createOptions ä¼šé€ æˆå¾ªç¯æ£€æµ‹ï¼Œå¯¼è‡´ä¸€ç›´è°ƒç”¨ useEffect çš„æ­»å¾ªç¯ã€‚æ­¤æ—¶ï¼Œå¯ä»¥å°† createOptions ä¹Ÿç¼“å­˜ä¸€ä¸‹å³å¯ï¼š

```js
const createOptions = useCallback(() => {
  return {
    serverUrl: 'https://localhost:1234',
    roomId: roomId,
  };
}, [roomId]);
```

æ­¤æ—¶ï¼Œæ—¢ç„¶æœ‰ä¸€ä¸ªå¼•ç”¨é“¾ï¼Œæ ¹æºéƒ½ä¾èµ– roomIdï¼Œæ‰€ä»¥å¯ä»¥åˆå¹¶ï¼Œå› æ­¤æœ‰æ›´è¿›ä¸€æ­¥çš„æ”¹è¿›æ–¹æ¡ˆï¼š

```js
useEffect(() => {
  function createOptions() {
    // âœ… No need for useCallback or function dependencies!
    return {
      serverUrl: 'https://localhost:1234',
      roomId: roomId,
    };
  }

  const options = createOptions();
  const connection = createConnection();
  connection.connect();
  return () => connection.disconnect();
}, [roomId]); // âœ… Only changes when roomId changes
```

#### è‡ªå®šä¹‰ hook æ—¶ä½¿ç”¨

è‡ªå®šä¹‰ hook æ—¶ï¼Œæ¨èæ‰€æœ‰çš„å‡½æ•°ç¼“å­˜ä¸€ä¸‹ï¼Œä»¥ä¾¿äºåœ¨å¤–éƒ¨ä½¿ç”¨æ—¶ä¸ç•™æ€§èƒ½é—®é¢˜çš„å‘ï¼Œä¾¿äºéšæ—¶ä¼˜åŒ–æ€§èƒ½ï¼š

```js
function useRouter() {
  const { dispatch } = useContext(RouterStateContext);

  const navigate = useCallback(
    (url) => {
      dispatch({ type: 'navigate', url });
    },
    [dispatch],
  );

  const goBack = useCallback(() => {
    dispatch({ type: 'back' });
  }, [dispatch]);

  return {
    navigate,
    goBack,
  };
}
```

### QA

- å¦‚ä½•åœ¨å¾ªç¯åˆ—è¡¨é‡Œä½¿ç”¨ useCallback

ä¸å¯ä»¥ç›´æ¥ä½¿ç”¨ï¼Œä¼šç ´å hook çš„é“¾è¡¨ç»“æ„ã€‚æ¨èçš„åšæ³•æ˜¯å°†å…¬å…±ç»„ä»¶æå–å‡ºæ¥ï¼Œåœ¨æå–çš„å…¬å…±ç»„ä»¶ä¸­ä½¿ç”¨ã€‚

## 2. [useMemo]

useMemo ä¸ useCallback çš„åŸç†ç±»ä¼¼ã€‚å®ƒæ˜¯ç”¨æ¥ç¼“å­˜è®¡ç®—ç»“æœçš„ï¼Œç±»ä¼¼äº vue çš„è®¡ç®—å±æ€§ã€‚

å®šä¹‰ï¼š

```js
const cachedValue = useMemo(calculateValue, dependencies)
```

### ä½¿ç”¨

```js
import { useMemo } from 'react';  

function TodoList({ todos, tab }) {  
    const visibleTodos = useMemo(  
        () => filterTodos(todos, tab),  
        [todos, tab]  
    );  
    // ...  
}
```

### å‚æ•°

- fnï¼šç”¨æˆ·è¿”å›æƒ³è¦ç¼“å­˜çš„æ•°å€¼ï¼Œå¯ä»¥ä¼ é€’å‚æ•°
- ä¾èµ–é¡¹ï¼šç¼“å­˜æ›´æ–°çš„æ¡ä»¶

### å“åº”å¼è¿”å›å€¼

- åˆå§‹åŒ–æ—¶ï¼Œè¿”å›ä¸€æ¬¡ fn çš„è¿”å›å€¼
- ä¾èµ–é¡¹æ²¡æœ‰å˜åŒ–ï¼ˆObject.is åˆ¤æ–­ï¼‰ï¼Œè¿”å›ä¸Šæ¬¡ç¼“å­˜çš„å€¼ï¼Œå¦åˆ™è¿”å›æœ€æ–°çš„è®¡ç®—å€¼ï¼Œå¹¶å†æ¬¡ç¼“å­˜

### æ³¨æ„äº‹é¡¹

- åªèƒ½åœ¨å‡½æ•°å¼ç»„ä»¶é¡¶éƒ¨ä½¿ç”¨
- åœ¨ä¸¥æ ¼æ¨¡å¼ä¸‹ï¼ŒReactä¼šè°ƒç”¨è®¡ç®—å‡½æ•°ä¸¤æ¬¡ï¼Œä»¥å¸®åŠ©æ‚¨æŸ¥æ‰¾æ„å¤–æ‚è´¨ã€‚è¿™åªæ˜¯**å¼€å‘è¡Œä¸º**ï¼Œä¸å½±å“ç”Ÿäº§ã€‚å¦‚æœæ‚¨çš„è®¡ç®—å‡½æ•°æ˜¯çº¯çš„ï¼Œè¿™ä¸ä¼šå½±å“ç»„ä»¶çš„é€»è¾‘ã€‚å…¶ä¸­ä¸€ä¸ªè°ƒç”¨çš„ç»“æœå°†è¢«å¿½ç•¥ã€‚
- ç¼“å­˜è¢«ä¸¢å¼ƒçš„æƒ…å†µï¼šåœ¨å¼€å‘ä¸­ï¼Œå½“ç¼–è¾‘ç»„ä»¶æ–‡ä»¶æ—¶ï¼ŒReactä¼šä¸¢å¼ƒç¼“å­˜ã€‚åœ¨å¼€å‘å’Œç”Ÿäº§ç¯å¢ƒä¸­ï¼Œåœ¨ suspends åŠ è½½å‰çš„ç»„ä»¶ï¼Œä¸ä¼šç¼“å­˜å‡½æ•°ï¼ŒReactå°†ä¸¢å¼ƒç¼“å­˜ã€‚

### Future

- æœªæ¥æœŸæœ›æ·»åŠ å¯¹è™šæ‹ŸåŒ–åˆ—è¡¨çš„å†…ç½®æ”¯æŒã€‚æ­¤æ—¶ä¼šè‡ªåŠ¨ä¸¢å¼ƒä¸åœ¨å¯è§†çª—å£å†…çš„åˆ—è¡¨ç¼“å­˜ã€‚

### ä½¿ç”¨åœºæ™¯

#### è·³è¿‡æ²¡å¿…è¦çš„å€¼é‡è®¡ç®—

è¿™ä¸ªæ˜¯æœ€å¸¸ç”¨çš„ä½¿ç”¨åœºæ™¯ï¼Œåœ¨ä¾èµ–æ²¡æœ‰å˜åŒ–æ—¶ï¼Œä½¿ç”¨ç¼“å­˜å€¼ï¼Œè€Œä¸ç”¨é‡æ–°è®¡ç®—ï¼š

```js
import { useMemo } from 'react';

function TodoList({ todos, tab, theme }) {
  const visibleTodos = useMemo(() => filterTodos(todos, tab), [todos, tab]);
  // ...
}
```

è¿™é‡Œçš„è®¡ç®—å‡½æ•°ï¼Œå¯ç®€å•å¯å¤æ‚ã€‚å¦‚æœè®¡ç®—å‡½æ•°å¾ˆç®€å•ï¼Œé‚£ä¹ˆä¸ç¼“å­˜ä¸æ˜¯é—®é¢˜ï¼Œå› ä¸ºè®¡ç®—ä¼šå¾ˆå¿«ã€‚ç„¶è€Œï¼Œå¦‚æœè¦è¿‡æ»¤æˆ–è½¬æ¢å¤§å‹æ•°ç»„æˆ–è€…å¤æ‚çš„æ•°æ®ç»“æ„æ—¶ï¼Œæˆ–è¿›è¡Œä¸€äº›è€—æ—¶çš„è®¡ç®—ï¼ˆ`console.time`æ¥æµ‹è¯•ï¼‰æ—¶ï¼Œç¼“å­˜å°±å¾ˆæœ‰å¿…è¦äº†ã€‚

#### è·³è¿‡æ²¡å¿…è¦çš„ç»„ä»¶é‡æ¸²æŸ“

è¿˜ä»¥ä¸Šé¢çš„å¾…åŠåˆ—è¡¨çš„ä¾‹å­ï¼š

```js
export default function TodoList({ todos, tab, theme }) {
  // Every time the theme changes, this will be a different array...  
  const visibleTodos = filterTodos(todos, tab);
  
  return (
    <div className={theme}>
      <List items={visibleTodos} />
    </div>
  );
}
```

ä¸Šé¢çš„ä»£ç ï¼ŒåŸºäº React çš„æ¸²æŸ“åŸç†ï¼Œå½“ä¸€ä¸ªç»„ä»¶é‡æ¸²æŸ“ï¼Œå…¶å­ç»„ä»¶ä¼šå…¨éƒ¨é‡æ¸²æŸ“ã€‚æ‰€ä»¥ theme å˜åŒ–åï¼ŒList ç»„ä»¶å°±ä¼šè¢«é‡æ¸²æŸ“ã€‚æˆ‘ä»¬ä½¿ç”¨ memo æ£€æµ‹ props å˜åŒ–ï¼š

```js
import { memo } from 'react';

const List = memo(function List({ items }) {
  // ...
});
```

ä½†è¿˜æ˜¯ä¹‹å‰çš„é—®é¢˜ï¼Œprops ä¼ å…¥çš„å¯¹è±¡ä¹Ÿåº”è¯¥ç¼“å­˜ã€‚æ¯æ¬¡ TodoList é‡æ¸²æŸ“ï¼ŒvisibleTodos åˆ—è¡¨æ˜¯ä¸€ä¸ªä¸åŒçš„å€¼äº†ï¼Œæ‰€ä»¥ï¼ŒList çš„ memo ä¼šå¤±æ•ˆã€‚å› ä¸º visibleTodos ä¸æ˜¯å‡½æ•°ï¼Œæˆ‘ä»¬ä¸ç”¨ useCallbackï¼Œæˆ‘ä»¬ä½¿ç”¨ useMemoï¼š

```js
const visibleTodos = useMemo(
  () => filterTodos(todos, tab),
  [todos, tab] // ...so as long as these dependencies don't change...
);
```

#### ç¼“å­˜ä¸€ä¸ª hook çš„ä¾èµ–å…³ç³»

å‡è®¾æœ‰ä¸ªåœ¨ç»„ä»¶å†…éƒ¨æ–°åˆ›å»ºçš„å¯¹è±¡ï¼š

```js
function Dropdown({ allItems, text }) {
  const searchOptions = { matchMode: 'whole-word', text };

  const visibleItems = useMemo(() => {
    return searchItems(allItems, searchOptions);
  }, [allItems, searchOptions]); // ğŸš© Caution: Dependency on an object created in the component body
  // ...
}
```
ä¸Šé¢ä¾‹å­ä¸­ï¼ŒsearchOptions å°±æ˜¯ä¸€ä¸ªæ–°çš„å¯¹è±¡ï¼Œæ¯æ¬¡æ¸²æŸ“ç»„ä»¶éƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ã€‚è¿™å°±åˆä¼šé€ æˆ ä¸‹è¾¹ useMemo å¤±æ•ˆï¼Œæˆ‘ä»¬å¯ä»¥è¿™æ ·ï¼š

```js
const searchOptions = useMemo(() => {  
  return { matchMode: 'whole-word', text };  
}, [text]); // âœ… Only changes when text changes
```

å½“ç„¶ï¼Œä¹Ÿå¯ä»¥ä¸¤ä¸ª useMemo åˆå¹¶ä¸€ä¸ªï¼š

```js
const visibleItems = useMemo(() => {
  const searchOptions = { matchMode: 'whole-word', text };
  return searchItems(allItems, searchOptions);
}, [allItems, text]); // âœ… Only changes when allItems or text changes
```

#### ç¼“å­˜å‡½æ•°

ä¸¾ä¸€ä¸ªè¡¨å•æäº¤çš„ä¾‹å­ï¼š

```js
export default function ProductPage({ productId, referrer }) {
  function handleSubmit(orderDetails) {
    post('/product/' + productId + '/buy', {
      referrer,
      orderDetails,
    });
  }

  return <Form onSubmit={handleSubmit} />;
}
```

handleSubmit æ¯æ¬¡é‡æ¸²æŸ“éƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„å¯¹è±¡ï¼Œå¯¼è‡´ Form å­ç»„ä»¶ä¹Ÿé‡æ¸²æŸ“äº†ã€‚é™¤äº†ä½¿ç”¨ useCallbackï¼Œè¿˜å¯ä»¥ä½¿ç”¨ useMemoï¼š

```js
const handleSubmit = useMemo(() => {
  return (orderDetails) => {
    post('/product/' + product.id + '/buy', {
      referrer,
      orderDetails,
    });
  };
}, [productId, referrer]);
```

åªéœ€è¦è®© useMemo çš„ fn è¿”å›ä¸€ä¸ªå‡½æ•°å°±è¡Œäº†ã€‚å®˜æ–¹å»ºè®®ï¼Œç¼“å­˜å‡½æ•°ä½¿ç”¨ useCallbackï¼Œè¿™æ ·ä¼šé¿å…å¤šå†™ä¸€ä¸ªåŒ…è£¹å‡½æ•°è€Œé€ æˆä»£ç å¯è¯»æ€§ä¸‹é™ã€‚

### QA

- **ä¸ºä»€ä¹ˆæˆ‘çš„è®¡ç®—å€¼æ¯æ¬¡æ¸²æŸ“éƒ½æ‰§è¡Œä¸¤æ¬¡**

å› ä¸ºï¼Œåœ¨ä¸¥æ ¼æ¨¡å¼ä¸‹ï¼ŒReactå°†è°ƒç”¨æŸäº›å‡½æ•°ä¸¤æ¬¡è€Œä¸æ˜¯ä¸€æ¬¡ã€‚è€Œä¸”è¿™åªåœç•™åœ¨å¼€å‘æ¨¡å¼ä¸‹ï¼Œåªè¦ä½ çš„ç»„ä»¶å’Œè®¡ç®—å‡½æ•°æ˜¯çº¯çš„ï¼Œè¿™å°±ä¸ä¼šå½±å“é€»è¾‘ã€‚ä½†æ˜¯ä¸ºäº†è®©ä»£ç æ›´å¥å£®ï¼Œä¸‹é¢çš„ä»£ç å°±æ˜¯å¯æ”¹è¿›çš„ï¼š

```js
const visibleTodos = useMemo(() => {
  // ğŸš© Mistake: mutating a prop
  todos.push({ id: 'last', text: 'Go for a walk!' });
  const filtered = filterTodos(todos, tab);
  return filtered;
}, [todos, tab]);
```
todosä½œä¸ºä¾èµ–é¡¹ ä¼šè¢« push ä¸¤æ¬¡ï¼Œæˆ‘ä»¬å¯ä»¥è¿™æ ·å†™ï¼š

```js
const visibleTodos = useMemo(() => {
  const filtered = filterTodos(todos, tab);
  // âœ… Correct: mutating an object you created during the calculation
  filtered.push({ id: 'last', text: 'Go for a walk!' });
  return filtered;
}, [todos, tab]);
```
è¿™æ ·å°±ä¿è¯äº† useMemo ä¾èµ–çš„ä¸€è‡´æ€§ã€‚å³ä½¿è°ƒç”¨äº†ä¸¤æ¬¡ï¼Œé‚£ä¸ªå¯¹è±¡ä¹Ÿä¸ä¼šè¢« push ä¸¤ä¸ªç›¸åŒçš„å¯¹è±¡ã€‚

- **ä¸ºä»€ä¹ˆæˆ‘çš„ useMemo è¿”å›äº† undefined**

é”™è¯¯ä»£ç ç¤ºä¾‹ï¼š

```js
// ğŸ”´ You can't return an object from an arrow function with () => {
const searchOptions = useMemo(() => {
  matchMode: 'whole-word',
  text: text
}, [text]);
```
åŸå› ï¼šæ²¡æœ‰å†™è¿”å›å€¼ã€‚ä½ åº”è¯¥æŠŠæƒ³è¦çš„å¯¹è±¡ return è¿”å›å‡ºå»ã€‚å¯èƒ½å¯¹ç®­å¤´å‡½æ•°çš„ä½¿ç”¨è¿˜ä¸å¤ªç†Ÿæ‚‰ã€‚

- **å¦‚ä½•åœ¨å¾ªç¯åˆ—è¡¨é‡Œä½¿ç”¨ useMemo**

ä¸å¯ä»¥ç›´æ¥ä½¿ç”¨ï¼Œä¼šç ´å hook çš„é“¾è¡¨ç»“æ„ã€‚æ¨èçš„åšæ³•æ˜¯å°†å…¬å…±ç»„ä»¶æå–å‡ºæ¥ï¼Œåœ¨æå–çš„å…¬å…±ç»„ä»¶ä¸­ä½¿ç”¨ã€‚22:T1da3,> æœ‰åˆ†äº«æ‰æœ‰è¿›æ­¥ï¼Œæ¬¢è¿å¤§å®¶æ‰¹è¯„æŒ‡æ­£

æœ€è¿‘åœ¨å¼€å‘ä¸€ä¸ªå›½é™…ç«™é¡¹ç›®ï¼Œæ¶‰åŠåˆ°çš„ä»»åŠ¡æµè½¬å¯èƒ½ä¼šè·¨å¤šä¸ªå›½å®¶å’Œåœ°åŒºï¼Œè¿™å°±æ¶‰åŠåˆ°æ—¶é—´å·®çš„é—®é¢˜äº†ã€‚æœ¬æ–‡å°±æ¥æ¢³ç†ä¸€ä¸‹æˆ‘åœ¨å®é™…å¼€å‘ä¸­æ¶‰åŠåˆ°çš„å‰ç«¯æ—¶åŒºçš„é€»è¾‘å¤„ç†æ–¹æ¡ˆã€‚

## 1. å®é™…ä¸šåŠ¡åœºæ™¯

åœ¨ Asia/shanghai æ—¶åŒºä¸‹åˆ›å»ºå®šæ—¶æµè½¬ä»»åŠ¡æ—¶ï¼Œäº§å“ä¼šæœ‰è¦æ±‚ï¼šè®¾ç½®ä¸ºè¿ªæ‹œæ—¶é—´çš„ `2023-06-24 23:00:00` ç‚¹è§¦å‘ä»»åŠ¡æµç¨‹ï¼Œè¿™å°±ç‰µæ‰¯åˆ°æ—¶åŒºè½¬æ¢çš„é—®é¢˜ï¼›åŒæ—¶ï¼Œåœ¨ Asia/shanghai æ—¶åŒºä¸‹åˆ›å»ºçš„ä»»åŠ¡ï¼Œåœ¨ä¸–ç•Œå…¶ä»–å„ä¸ªæ—¶åŒºä¸‹çœ‹åˆ°çš„åº”è¯¥æ˜¯ä¸åŒçš„æ—¶é—´ï¼Œä½†æ˜¯è¿™é‡Œéœ€è¦æ ¼å¼åŒ–ä¸ºåŒä¸€ä¸ªæ—¶é—´ï¼ˆåˆ›å»ºåœ°çš„ï¼‰æ ¼å¼ï¼Œå¹¶æ ‡æ˜ `UTC +8`ã€‚

> æˆ‘ä»¬æ¥ä¸¾ä¸ªè¿‘ä¸€ç‚¹çš„ä¾‹å­ï¼š æ‹¿ä¸œäº¬ä¸¾ä¾‹ï¼Œæ˜¯ `UTC+9` æ—¶åŒºï¼Œæ¯”æˆ‘ä»¬å¿«äº†ä¸€ä¸ªæ—¶åŒºã€‚å¦‚æœåœ¨ Asia/shanghai æ—¶åŒºä¸‹é€‰æ‹©äº†è®¾å®šåœ¨ä¸œäº¬çš„ `2023-06-24 00:00:00` ä¸‹è§¦å‘ï¼Œé‚£ä¹ˆè¿™ä¸ªæ—¶é—´ä»¥ä¸œäº¬æ—¶é—´æ ¼å¼åŒ–ä¸ºæ—¶é—´æˆ³åï¼Œåœ¨ä¸Šæµ·æœ¬åœ°æ ¼å¼åŒ–ï¼Œåº”è¯¥æ˜¯ `2023-06-23 23:00:00`

åŸºäºä¸Šé¢çš„ä¸šåŠ¡åœºæ™¯ï¼Œæˆ‘è¿™é‡Œç»™å‡ºäº†å‡ ç§å¤„ç†æ–¹æ¡ˆï¼š

## 2. æ–¹æ¡ˆä¸€ã€åç«¯è°ƒæ•´æ—¶åŒº

å¯ä»¥ç›´æ¥æŠŠé€‰æ‹©çš„æ—¶é—´å­—ç¬¦ä¸² `2023-06-24 00:00:00` å’Œéœ€è¦è®¾ç½®çš„å½“åœ°æ—¶é—´çš„æ—¶åŒº `Asia/Tokyo` ç»™åˆ°åç«¯ï¼Œåç«¯æ¥æ ¹æ®æ—¶åŒºå°†æ—¶é—´å­—ç¬¦ä¸²æ ¼å¼åŒ–ä¸ºç›¸å¯¹äºä¸œäº¬çš„æ—¶é—´æˆ³ã€‚

ä»¥ Go ä¸ºä¾‹ï¼Œtime åŒ…ä¸‹å°±æœ‰æŒ‰ç…§æ—¶åŒºæ ¼å¼åŒ–çš„å‡½æ•°ï¼š

```go
layout := "2006-01-02 15:04:05"
value := "2023-06-24 00:00:00"
location := time.LoadLocation("Asia/Tokyo")
t := time.ParseInLocation(layout, value, location)

fmt.Println("Parsed time:", t.unix())
```

è¿™æ ·å°±èƒ½åœ¨æ•°æ®åº“é‡Œå­˜ä¸‹æ‰€é€‰æ—¶é—´çš„æ—¶åŒºå’Œç»å¯¹çš„æ—¶é—´æˆ³äº†ã€‚

è¿™æ—¶ä½ ä¼šé—®ï¼Œé‚£ä¹ˆæˆ‘å‰ç«¯å¦‚ä½•è·å–åˆ° `Asia/Tokyo` è¿™ä¸ªæ­£ç¡®çš„æ—¶åŒºæ ¼å¼ç»™åˆ°åç«¯å‘¢ï¼Ÿ

1. ä½¿ç”¨ moment-timezone åº“

```js
import moment from 'moment-timezone';

moment.tz.names(); // ["Africa/Abidjan", "Africa/Accra", "Africa/Addis_Ababa", ...]
```

é€‰æ‹©å®Œæ—¶åŒºåï¼Œå¯ä»¥é€šè¿‡ `const zone = moment.tz.zone('Asia/Tokyo');` æ¥è·å–æ—¶åŒºå¯¹è±¡ï¼Œå¯¹è±¡é‡Œä¾¿æœ‰äº† offset ç­‰ä¿¡æ¯ã€‚

å®é™…åœ¨é¡¹ç›®è½åœ°ä¸­ï¼Œmomentåº“æ¯”è¾ƒå¤§ï¼Œä¸€èˆ¬ä½¿ç”¨ dayjs ä»£æ›¿ï¼Œä½†æ˜¯ dayjs ä¸­æ²¡æœ‰ç›¸å…³çš„æ—¶åŒº APIï¼Œæ‰€ä»¥è¿™ä¸ªæ—¶åŒºåˆ—è¡¨ï¼Œæˆ‘åœ¨æœ¬åœ°ä½¿ç”¨ moment è·å–åˆ°ä»¥ååšäº†æœ¬åœ°çš„ç‰¹æ®Šæ ¼å¼åŒ–ï¼Œå¹¶ä½œä¸ºé™æ€æ–‡ä»¶æŒ‚è½½åœ¨ CDN ä¸Šäº†ï¼Œæ•°ç»„ç»“æ„å¦‚ä¸‹ï¼š

```js
[
  {
    value: 'Japan Standard Time',
    abbr: 'JST',
    offset: 9,
    isdst: false,
    text: '(UTC+09:00) Osaka, Sapporo, Tokyo',
    UTC: ['Asia/Dili', 'Asia/Jayapura', 'Asia/Tokyo', 'Etc/GMT-9', 'Pacific/Palau']
  },
  {
    value: 'China Standard Time',
    abbr: 'CST',
    offset: 8,
    isdst: false,
    text: '(UTC+08:00) Beijing, Chongqing, Hong Kong, Urumqi',
    UTC: ['Asia/Hong_Kong', 'Asia/Macau', 'Asia/Shanghai']
  },
  // ...
]
```

ä¸Šé¢çš„ offset æ˜¯ç›¸å¯¹äº UTC æ ‡å‡†æ—¶åŒºçš„åå·®ï¼Œè¯¥å€¼å¯ä»¥ä» moment çš„ zone å¯¹è±¡ä¸­è·å–ã€‚

> Zone å¯¹è±¡é‡Œ offsets å¸¸è§çš„æœ‰ PST æ—¶åŒº å’Œ PDT æ—¶åŒºï¼Œå‰è€…ä¸ºå¤ªå¹³æ´‹æ ‡å‡†æ—¶é—´ï¼ˆè‹±æ–‡ï¼š*Pacific Standard Time*ï¼Œç¸®å¯«ï¼š*PST*ï¼‰ï¼ŒUTC-8ï¼›åè€…ä¸ºå¤ä»¤æ—¶é—´ï¼ˆå¤å­£ï¼‰ç§°ä¸ºå¤ªå¹³æ´‹å¤ä»¤æ—¶é–“ï¼ˆè‹±æ–‡ï¼šPacific Daylight Timeï¼Œç¸®å¯«ï¼š*PDT*ï¼‰ï¼ŒUTC-7ï¼›ä½¿ç”¨å…¶ä¸­ä¸€ä¸ªï¼Œæ ¹æ®åå·®åšåŠ å‡å³å¯ã€‚

2. ä½¿ç”¨åŸç”Ÿçš„ Intl å¯¹è±¡

å¦‚æœä¸éœ€è¦äº¤äº’é€‰æ‹©æ—¶åŒºåˆ—è¡¨ï¼Œåªæ˜¯åœ¨é¡µé¢ä¸Šæ ¹æ®å½“åœ°æ—¶åŒºæ ¼å¼åŒ–æ—¶é—´æˆ³ï¼Œå¯ä»¥ä½¿ç”¨jsåŸç”Ÿçš„ Intl å¯¹è±¡ï¼š

```js
const timeZone = Intl.DateTimeFormat().resolvedOptions().timeZone;
console.log(timeZone); // Asia/Shanghai
```

è€Œä¸”è¯¥æ–¹æ³•çš„å…¼å®¹æ€§ç›®å‰å·²ç»æ¯”è¾ƒå¥½äº†ï¼š


![image.png](/img/posts/2023-6-26/2023-6-26-1.png)

è¿™æ ·åœ¨ä¸­å›½çš„é¡µé¢ä¸Šè¿™æ ·æ˜¾ç¤ºï¼š

```
(Asia/Shanghai UTC +8) 2023-06-23 23:00:00
```

åœ¨æ—¥æœ¬çš„é¡µé¢è¿™æ ·æ˜¾ç¤ºï¼š

```
(Asia/Tokyo UTC +9) 2023-06-24 00:00:00
```

## 3. æ–¹æ¡ˆäºŒã€å‰ç«¯æ ¼å¼åŒ–ä¸ºæ—¶é—´æˆ³

è¿™ç§æ–¹æ¡ˆä¸ä¾èµ–åç«¯ï¼Œå‰ç«¯é€‰æ‹©æ—¶åŒºï¼Œå‰ç«¯è½¬æ¢ä¸ºç»å¯¹å€¼æ—¶é—´æˆ³ç»™åˆ°åç«¯ã€‚è·å–æ—¶åŒºåˆ—è¡¨çš„æ–¹å¼å‚è§æ–¹æ¡ˆä¸€ã€‚è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨æ‰‹åŠ¨æ—¶åŒºè½¬æ¢çš„æ€è·¯ï¼Œè·å–åˆ°åº”è¯¥è½¬æ¢ä¸ºä¸Šæµ·æ—¶é—´çš„æ—¶é—´å­—ç¬¦ä¸²ï¼Œå³ï¼Œå°† `2023-06-24 00:00:00` è½¬æ¢ä¸º `2023-06-23 23:00:00`ã€‚

åœ¨è·å–åˆ°æ—¶åŒº `timeZoneOffset` ï¼ˆè¿™é‡Œæ˜¯ 9ï¼‰ å’Œ æ—¶é—´å­—ç¬¦ä¸² `time` ï¼ˆè¿™é‡Œæ˜¯ 2023-06-24 00:00:00ï¼‰åï¼Œå‰ç«¯æŒ‰ç…§å½“åœ°æ—¶é—´æ¨¡æ‹Ÿæ—¶åŒºå˜åŒ–æ¥å¤„ç†ï¼š

```js
// æ¨¡æ‹Ÿè½¬æ¢ä¸ºæ ‡å‡† UTC æ—¶é—´ï¼Œè¿™é‡Œå‡å»9ä¸ªå°æ—¶å³å¯
const UTC = dayjs(time).add(-timeZoneOffset, 'hour');
// è·å–æµè§ˆå™¨å½“åœ°æ—¶é—´çš„å°æ—¶å·®ï¼ŒoffsetHours å¦‚æœåœ¨ä¸Šæµ·ï¼Œå°±æ˜¯ 8
const date = new Date();
const offsetHours = -(date.getTimezoneOffset() / 60);
// å°†ä¸Šé¢çš„ UTC åŠ ä¸Šæµè§ˆå™¨æœ¬åœ°çš„æ—¶å·® 
const result = dayjs(UTC).add(offsetHours, 'hour');
```

é€šè¿‡ä¸Šè¿°æ“ä½œï¼Œå°±å°†ä¸œäº¬æ—¶é—´çš„ `2023-06-24 00:00:00` è½¬æ¢ä¸ºä¸Šæµ·æ—¶åŒºçš„ `2023-06-23 23:00:00`ï¼Œæ­¤æ—¶åœ¨å°†è¿™ä¸ª result è½¬æ¢ä¸ºæ—¶é—´æˆ³å³å¯ï¼š

```js
result.unix() // 1687532400
```


## 4. æ–¹æ¡ˆä¸‰ã€dayjsæ ¼å¼åŒ–ä¸ºæ—¶é—´æˆ³

è¯¥æ–¹æ¡ˆä¸ºæ–¹æ¡ˆäºŒçš„å˜ç§ï¼Œåªæ˜¯ä¸ç”¨åŸç”Ÿæ“ä½œæ—¶åŒºå·®æ¥è®¡ç®—ï¼Œè€Œæ˜¯ä½¿ç”¨ dayjs å†…ç½®çš„æ–¹æ³•æ›¿ä»£ä¹‹ï¼š

```js
const d = dayjs.tz('2023-06-24 00:00:00', 'Asia/Tokyo')
console.log(d.format()) // 2023-06-24T00:00:00+09:00
console.log(d.unix()) // 1687532400
```


![image.png](/img/posts/2023-6-26/2023-6-26-2.png)

è¯¥æ–¹æ³•çš„å‰ææ˜¯å¼•å…¥æ—¶åŒºæ’ä»¶ï¼š

```js
import timezone from 'dayjs/plugin/timezone';

dayjs.extend(timezone);
```

è¿™ç§æ–¹æ¡ˆçš„ç¼ºç‚¹æ˜¯å¿…é¡»æå‰ä¼ å…¥æ—¶åŒºå­—ç¬¦ä¸²ã€‚æ–¹æ¡ˆäºŒä¸éœ€è¦ä»»ä½•æ¡ä»¶ï¼Œåªéœ€è¦çŸ¥é“æ˜¯ UTC å‡ çš„æ—¶åŒºå°±å¯ä»¥äº†ã€‚

## 5. é€†å‘ï¼šæ—¶é—´æˆ³å±•ç¤ºä¸ºç»™å®šæ—¶åŒºçš„æ—¶é—´

ä¸Šé¢è®²äº†æ€ä¹ˆæŠŠæœ¬åœ°æ—¶é—´é€‰æ‹©å™¨é€‰ä¸­çš„æŒ‡å®šæ—¶åŒºçš„æ—¶é—´ï¼ˆdayjsï¼‰æŒ‰ç…§æ‰€é€‰æ—¶åŒºæ ¼å¼åŒ–ä¸ºæ—¶é—´æˆ³ã€‚ä¸‹é¢è¯´çš„æ˜¯ä»–çš„é€†å‘ï¼šæ€ä¹ˆä»æ—¶é—´æˆ³æ ¼å¼åŒ–ä¸ºæ‰€åœ¨æ—¶åŒºçš„æ—¶é—´å­—ç¬¦ä¸²ã€‚

> æ¯”å¦‚æ—¶é—´æˆ³ï¼š1688439600ï¼Œä»–åœ¨åŒ—äº¬æ—¶é—´æ˜¯ 2023-7-4 11:00:00ï¼Œåœ¨ä¸œäº¬æ—¶é—´ï¼ˆUTC +9ï¼‰åº”è¯¥å¿«ä¸€ä¸ªå°æ—¶

æŒ‰ç…§ä¸Šè¾¹çš„ä¾‹å­ï¼Œæˆ‘ä»¬å¯ä»¥å¯¹æ¯”æµè§ˆå™¨æ‰€åœ¨æ—¶åŒºå’Œç»™å®š offset çš„å·®å€¼æ¥æ¯”å¯¹ï¼Œè¿›è€Œå°†æ—¶é—´åŠ æˆ–è€…å‡å¯¹åº”çš„å°æ—¶æ•°å³å¯ï¼š

```js
// ä¼ å…¥ 1688439600ï¼Œ9
export const showWithTimeZone = (timestamp, timeZoneOffset) => {
  if (typeof timeZoneOffset === 'number') {
    const date = new Date();
    const offsetHours = -(date.getTimezoneOffset() / 60);

    // ç»™å®šæ—¶åŒºä¸æµè§ˆå™¨æœ¬åœ°æ—¶åŒºçš„å·®å¼‚
    const offset = timeZoneOffset - offsetHours;
    // ç›´æ¥åŠ æ³•å³å¯ï¼Œå¦‚æœæ—¶åŒºå¿«ï¼Œå°±æ˜¯æ­£æ•°ï¼Œå¦è‡ªæ˜¯è´Ÿæ•°
    const result = dayjs(timestamp * 1000).add(offset, 'hour');

    return {
      format: `(UTC ${timeZoneOffset > 0 ? '+' + timeZoneOffset : timeZoneOffset + ''}) ${result.format('YYYY-MM-DD HH:mm:ss')}`
    };
  }
};
```

å¦‚æ­¤ï¼Œåœ¨ç•Œé¢å°±ä¼šçœ‹åˆ°ï¼š


![image.png](/img/posts/2023-6-26/2023-6-26-3.png)

## 6. æ€»ç»“

ä¸ªäººä½¿ç”¨çš„æ˜¯æ–¹æ¡ˆä¸‰å’Œæ–¹æ¡ˆä¸€çš„ç»“åˆï¼Œè·å–åˆ°æ—¶åŒºåˆ—è¡¨å¹¶ç¼“å­˜CDNåï¼Œå‰ç«¯é€‰æ‹©æ—¶åŒºå¹¶è½¬æ¢ä¸ºç»å¯¹å€¼æ—¶é—´æˆ³ï¼Œåç«¯è¿›è¡ŒäºŒæ¬¡æ ¡éªŒå¹¶åœ¨åˆ—è¡¨æ˜¾ç¤ºçš„åœ°æ–¹æ ¼å¼åŒ–ä¸ºå­—ç¬¦ä¸²è¿”å›ã€‚

> éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç½‘ä¸Šè·å–åˆ°çš„æ—¶åŒºåç§»å¯èƒ½ä¼šæœ‰å»¶è¿Ÿï¼ˆæœ‰äº›åŸå¸‚ä¼šä¸åœè°ƒæ•´æ—¶åŒºï¼‰ï¼Œæ¯”å¦‚æŸæ—çš„æ—¶åŒºï¼Œæˆ‘åœ¨åˆ—è¡¨é‡Œçš„æ˜¯ +1ï¼Œä½†æ˜¯ç½‘ä¸Šæœåˆ°çš„æœ€æ–°æ¶ˆæ¯æ˜¯ GMT+2 çš„ï¼Œä½†æ˜¯ä»Šå¹´10æœˆä»½åˆä¼šè°ƒå› +1ã€‚æˆ‘è¿™é‡Œå°±è¿˜ä»¥momentè·å–çš„æ•°æ®ä¸ºå‡†äº†ã€‚


![image.png](/img/posts/2023-6-26/2023-6-26-4.png)23:T484f,> æœ¬æ–‡é’ˆå¯¹ ESLint 8+ ç‰ˆæœ¬

## 1. é…ç½®æ–‡ä»¶æ ¼å¼

ESLint é…ç½®æ–‡ä»¶å¯ä»¥ä½¿ç”¨å¤šç§æ–‡ä»¶æ ¼å¼ï¼Œå¸¸ç”¨çš„æœ‰ä»¥ä¸‹å‡ ç§ï¼š

-   .eslintrc.jsï¼šä½¿ç”¨ JavaScript ç¼–å†™çš„é…ç½®æ–‡ä»¶ï¼Œè¿”å›ä¸€ä¸ªé…ç½®å¯¹è±¡ã€‚
-   .eslintrc.yamlã€.eslintrc.ymlï¼šä½¿ç”¨ YAML è¯­è¨€ç¼–å†™çš„é…ç½®æ–‡ä»¶ã€‚
-   .eslintrc.jsonï¼šä½¿ç”¨ JSON æ ¼å¼ç¼–å†™çš„é…ç½®æ–‡ä»¶ã€‚
-   .eslintrc.cjsï¼šä½¿ç”¨è¿™ç§é…ç½®æ—¶ï¼Œä¸­éœ€è¦åœ¨`package.json`ä¸­é…ç½®`type":"module"`ã€‚
-   eslintConfigï¼šä½¿ç”¨npmåŒ…è¿›è¡Œé…ç½®ã€‚
-   .eslintrcï¼šæ™®é€šé…ç½®æ–‡ä»¶

æ­¤å¤–è¿˜æœ‰è¡Œå†…é…ç½®ï¼š

-   `/* eslint-disable */` å’Œ `/* eslint-enable */`ï¼Œç¦ç”¨å¯ç”¨è§„åˆ™
-   `/* global */`ï¼Œå®šä¹‰å…¨å±€å˜é‡
-   `/* eslint */`ï¼Œé…ç½®è§„åˆ™
-   `/* eslint-env */`ï¼ŒæŒ‡å®šå½“å‰è¿è¡Œç¯å¢ƒ

ç°åœ¨ï¼Œæœ‰ä¸€ç§æ–°çš„é…ç½®æ–‡ä»¶ç±»å‹ï¼š`eslint.config.js`ï¼Œå®˜æ–¹å°†åœ¨ v9 ç‰ˆæœ¬å…¨é¢ä½¿ç”¨è¯¥é…ç½®ç±»å‹ã€‚



å…¶ä¸­ï¼Œæ¨èä½¿ç”¨ .js æ–‡ä»¶æ ¼å¼ï¼Œå› ä¸ºå®ƒå¯ä»¥ä½¿ç”¨ JavaScript çš„æ‰€æœ‰ç‰¹æ€§ï¼Œæ–¹ä¾¿ç¼–å†™å¤æ‚çš„é…ç½®è§„åˆ™ã€‚æœ¬æ–‡ä»¥æ¨èçš„æ ¼å¼ä¸ºä¾‹æ¥è®²è§£é…ç½®:

```js
// .eslintrc.js
module.exports = {
...
}
```

```js
//eslint.config.js
export default [

]
```

## 2. å¸¸ç”¨é…ç½®é¡¹

### root

æŒ‡å®šESLintåœ¨æŸ¥æ‰¾é…ç½®æ–‡ä»¶æ—¶çš„èµ·å§‹ä½ç½®ã€‚

å‡è®¾ç°åœ¨ç›®å½•å±‚çº§å¦‚ä¸‹ï¼š

```bash
project/
â”œâ”€â”€ package.json
â”œâ”€â”€ .eslintrc.js
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ .eslintrc.js
â”‚   â””â”€â”€ index.js
â””â”€â”€ test/
    â”œâ”€â”€ .eslintrc.js
    â””â”€â”€ test.js
```

æˆ‘ä»¬åœ¨ é¡¶å±‚.eslintrc.js ä¸­é…ç½® rootï¼š

```
// project/.eslintrc.js
module.exports = {
  root: true,
  // ...
}
```
è¿™å‘Šè¯‰äº†ESLintåº”è¯¥ä½¿ç”¨æ­¤æ–‡ä»¶ä½œä¸ºèµ·å§‹ä½ç½®æ¥æŸ¥æ‰¾å…¶ä»–é…ç½®æ–‡ä»¶ã€‚è¿™å°†ç¡®ä¿ESLintå§‹ç»ˆä½¿ç”¨project/.eslintrc.jsä½œä¸ºé¡¹ç›®ä¸­æ‰€æœ‰æ–‡ä»¶çš„é…ç½®æ–‡ä»¶ï¼Œè€Œä¸æ˜¯ä½¿ç”¨å­ç›®å½•ä¸­çš„å…¶ä»–é…ç½®æ–‡ä»¶ã€‚

å¦‚æœåœ¨ä¸Šè¿°çš„ä¾‹å­ä¸­æ²¡æœ‰æŒ‡å®š"root"å­—æ®µï¼ŒESLintä¼šä½¿ç”¨æœ€è¿‘çš„é…ç½®æ–‡ä»¶æ¥æ£€æµ‹ä»£ç ï¼Œå¦‚æœå½“å‰ç›®å½•ä¸‹æ²¡æœ‰é…ç½®æ–‡ä»¶ï¼ŒESLintä¼šç»§ç»­å‘ä¸ŠæŸ¥æ‰¾çˆ¶ç›®å½•ï¼Œç›´åˆ°æ‰¾åˆ°ä¸€ä¸ªé…ç½®æ–‡ä»¶ä¸ºæ­¢ã€‚

### env

ç”¨æ¥æŒ‡å®šæ ¡éªŒç¯å¢ƒã€‚å®ƒå‘Šè¯‰ ESLint ä»£ç è¿è¡Œåœ¨å“ªä¸ªç¯å¢ƒä¸­ï¼Œä»è€Œå¸®åŠ© ESLint æ›´å¥½åœ°ç†è§£æ‚¨çš„ä»£ç å¹¶æ£€æµ‹æ½œåœ¨çš„é—®é¢˜ã€‚

é…ç½®å¦‚ä¸‹ï¼š

```js
env: {
  es6: true /** å¯ç”¨é™¤äº†modulesä»¥å¤–çš„æ‰€æœ‰ ES6 ç‰¹æ€§,å¼€å¯åä¼šè‡ªåŠ¨è®¾ç½®ecmaVersionä¸º6 */,
  node: true /** Node.js å…¨å±€å˜é‡å’Œ Node.js ä½œç”¨åŸŸ */,
  browser: true /** æµè§ˆå™¨å…¨å±€å˜é‡ */,
  commonjs: true /**  CommonJS å…¨å±€å˜é‡å’Œ CommonJS ä½œç”¨åŸŸ (ç”¨äº Browserify/WebPack æ‰“åŒ…çš„åªåœ¨æµè§ˆå™¨ä¸­è¿è¡Œçš„ä»£ç ) */,
  jest: false /** Jest å…¨å±€å˜é‡ */,
  jquery: false /** jQuery å…¨å±€å˜é‡ */,
  'shared-node-browser': false /** Node.js å’Œ Browser é€šç”¨å…¨å±€å˜é‡ */,
  worker: false /** Web Workers å…¨å±€å˜é‡ */,
  amd: false /** å°† require() å’Œ define() å®šä¹‰ä¸ºåƒ amd ä¸€æ ·çš„å…¨å±€å˜é‡ */,
  mocha: false /** æ·»åŠ æ‰€æœ‰çš„ Mocha æµ‹è¯•å…¨å±€å˜é‡ */,
  jasmine: false /** æ·»åŠ æ‰€æœ‰çš„ Jasmine ç‰ˆæœ¬ 1.3 å’Œ 2.0 çš„æµ‹è¯•å…¨å±€å˜é‡ã€‚ */,
  phantomjs: false /** phantomjs å…¨å±€å˜é‡ */,
  protractor: false /** protractor å…¨å±€å˜é‡ */,
  qunit: false /** QUnit å…¨å±€å˜é‡ */,
  prototypejs: false /** Prototype.js å…¨å±€å˜é‡ */,
  shelljs: false /** ShellJS å…¨å±€å˜é‡ */,
  meteor: false /** Meteor å…¨å±€å˜é‡ */,
  mongo: false /** MongoDB å…¨å±€å˜é‡ */,
  applescript: false /** AppleScript å…¨å±€å˜é‡ */,
  nashorn: false /** Java 8 Nashorn å…¨å±€å˜é‡ */,
  serviceworker: false /** Service Worker å…¨å±€å˜é‡ */,
  atomtest: false /** Atom æµ‹è¯•å…¨å±€å˜é‡ */,
  embertest: false /** Ember æµ‹è¯•å…¨å±€å˜é‡ */,
  webextensions: false /** WebExtensions å…¨å±€å˜é‡ */,
  greasemonkey: false /** GreaseMonkey å…¨å±€å˜é‡ */,
}
```

### parser

æŒ‡å®šç”¨äºè§£æJavaScriptä»£ç çš„è§£æå™¨ã€‚ESLinté»˜è®¤ä½¿ç”¨ esprima è§£æå™¨ï¼Œä½†æ˜¯å¯ä»¥é€šè¿‡"parser"é…ç½®æ¥ä½¿ç”¨å…¶ä»–è§£æå™¨ã€‚

å¸¸ç”¨çš„è§£æå™¨å¦‚ä¸‹ï¼š

1. esprimaï¼šé»˜è®¤çš„è§£æå™¨ï¼Œç”¨äºè§£æECMAScript 5åˆ°ECMAScript 2021ä¹‹é—´çš„JavaScriptä»£ç ã€‚
2.  @babel/eslint-parserï¼šç”±Babelé¡¹ç›®æä¾›çš„è§£æå™¨ï¼Œç”¨äºè§£æES6+ä»£ç ã€‚
3.  @typescript-eslint/parserï¼šç”±TypeScriptå›¢é˜Ÿæä¾›çš„è§£æå™¨ï¼Œç”¨äºè§£æTypeScriptä»£ç ã€‚
4.  eslint-plugin-htmlï¼šç”¨äºè§£æHTMLæ–‡ä»¶ä¸­çš„JavaScriptä»£ç ã€‚
5.  vue-eslint-parserï¼šç”¨äºè§£æVueå•æ–‡ä»¶ç»„ä»¶ä¸­çš„JavaScriptä»£ç ã€‚

### parserOptions

ç»™é…ç½®çš„è§£æå™¨æ·»åŠ å¯é€‰é…ç½®é¡¹ã€‚

å¦‚æœä½¿ç”¨çš„æ˜¯é»˜è®¤parseré…ç½®ï¼Œå¯ä»¥æœ‰å¦‚ä¸‹é…ç½®ï¼š
```js
// .eslintrc.js
module.exports = {
  parser: "esprima",
  parserOptions: {
    ecmaVersion: 2022, 
    sourceType: "module",
    range: true,
    loc: true,
  },
  // ...
}
```
å­—æ®µè§£æï¼š

-   `ecmaVersion`: æŒ‡å®šè¦è§£æçš„ ECMAScript ç‰ˆæœ¬ã€‚å¯ä»¥è®¾ç½®ä¸ºæ•°å­—ï¼ˆå¦‚ 3ã€5ã€6ã€7ã€8ã€9ã€10ã€11ã€12ã€13ã€2020ã€2021 ç­‰ï¼‰æˆ–å­—ç¬¦ä¸²ï¼ˆå¦‚ `"latest"`ï¼‰ã€‚é»˜è®¤ä¸º `5`ã€‚
-   `sourceType`: æŒ‡å®šè¦è§£æçš„æ¨¡å—ç³»ç»Ÿç±»å‹ã€‚å¯é€‰å€¼ä¸º `"script"`ï¼ˆé»˜è®¤ï¼‰æˆ– `"module"`ã€‚
-   `ecmaFeatures`: ä¸€ä¸ªå¯¹è±¡ï¼Œç”¨äºå¯ç”¨æˆ–ç¦ç”¨ ECMAScript ä¸­çš„ç‰¹å®šè¯­è¨€åŠŸèƒ½ã€‚å¯ç”¨çš„é€‰é¡¹åŒ…æ‹¬ï¼š
    -   `globalReturn`ï¼šå…è®¸åœ¨å…¨å±€ä½œç”¨åŸŸä¸­ä½¿ç”¨ return è¯­å¥ã€‚
    -   `impliedStrict`ï¼šå…è®¸åœ¨éä¸¥æ ¼æ¨¡å¼ä¸‹è§£æä¸ºä¸¥æ ¼æ¨¡å¼ã€‚
    -   `jsx`ï¼šå¯ç”¨ JSX è¯­æ³•ã€‚
    -   `experimentalObjectRestSpread`ï¼šå¯ç”¨å¯¹è±¡çš„ rest å’Œ spread æ“ä½œç¬¦ã€‚
-   `allowImportExportEverywhere`: å…è®¸åœ¨ä»£ç çš„ä»»ä½•ä½ç½®ä½¿ç”¨ import å’Œ export è¯­å¥ã€‚é»˜è®¤ä¸º `false`ã€‚
-   `codeFrame`: å½“å‘ç”Ÿè¯­æ³•é”™è¯¯æ—¶ï¼Œæä¾›æ›´è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯ã€‚é»˜è®¤ä¸º `true`ã€‚
-   `requireConfigFile`: å¦‚æœè®¾ç½®ä¸º `true`ï¼Œåˆ™å¿…é¡»æä¾› `tsconfig.json` æˆ– `.eslintrc.*` æ–‡ä»¶æ¥é…ç½®è§£æå™¨ã€‚é»˜è®¤ä¸º `false`ã€‚
-   `babelOptions`: ä¼ é€’ç»™ `@babel/parser` çš„é€‰é¡¹å¯¹è±¡ã€‚ç¤ºä¾‹å¦‚ä¸‹ï¼š
```js
babelOptions: {
  ecmaVersion: "es2020",
  ecmaFeatures: {
    globalReturn: true,
    jsx: true,
  },
  lib: ["ES2020"],
},
```
-   `tsconfigRootDir`: æŒ‡å®š TypeScript é…ç½®æ–‡ä»¶çš„æ ¹ç›®å½•ã€‚é»˜è®¤ä¸ºè§£æ `tsconfig.json` æ–‡ä»¶çš„ç›®å½•ã€‚

å¦‚æœä½¿ç”¨@babel/eslint-parserè§£æå™¨ï¼Œåˆ™å¯ä»¥æœ‰å¦‚ä¸‹é…ç½®ï¼š

```js
// .eslintrc.js
module.exports = {
  parser: "@babel/eslint-parser",
  parserOptions: {
    ecmaVersion: 2022,
    sourceType: "module",
    ecmaFeatures: {
      jsx: true,  //æ”¯æŒ jsx
    },
  },
  // ...
}
```

è‹¥ä½¿ç”¨ @typescript-eslint/parserï¼Œå¯ä»¥ä½¿ç”¨å¦‚ä¸‹é…ç½®ï¼š

```js
// .eslintrc.js
module.exports = {
  parser: "@typescript-eslint/parser",
  "parserOptions": {
    "ecmaVersion": 2021,
    "sourceType": "module",
    "project": "./tsconfig.json",
    "tsconfigRootDir": "./",
    "extraFileExtensions": [".tsm"]
  },
}
```

### globals

æŒ‡å®šå…¨å±€å˜é‡çš„ä¸€ä¸ªé…ç½®é¡¹ã€‚åœ¨ JavaScript ä¸­ï¼Œå¦‚æœä¸€ä¸ªå˜é‡æ²¡æœ‰ç»è¿‡å£°æ˜å°±è¢«ä½¿ç”¨ï¼Œä¼šå¯¼è‡´è¯¥å˜é‡è¢«å½“ä½œå…¨å±€å˜é‡å¤„ç†ï¼Œè¿™å¯èƒ½ä¼šå¯¼è‡´ä¸€äº›æ½œåœ¨çš„é—®é¢˜ã€‚é€šè¿‡é…ç½® `globals`ï¼Œæˆ‘ä»¬å¯ä»¥å‘Šè¯‰ ESLint è¿™äº›å˜é‡æ˜¯å…¨å±€å˜é‡ï¼Œä»è€Œé¿å…å‡ºç°è¿™ç§é—®é¢˜ã€‚

`globals` å¯ä»¥æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œé”®ä¸ºå…¨å±€å˜é‡çš„åç§°ï¼Œå€¼ä¸ºè¯¥å˜é‡çš„ä½¿ç”¨æƒ…å†µï¼Œå¯ä»¥æ˜¯ `readonly`ã€`writable` æˆ– `off`ã€‚ä¾‹å¦‚ï¼š

```js
{
  "globals": {
    "foo": "writable",
    "bar": "readonly",
    "baz": "off"
  }
}
```

åœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œ`foo` å’Œ `bar` éƒ½è¢«æŒ‡å®šä¸ºå…¨å±€å˜é‡ï¼Œ`foo` å¯ä»¥è¢«å†™å…¥ï¼Œè€Œ `bar` æ˜¯åªè¯»çš„ï¼Œ`baz` è¢«å…³é—­ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼ŒESLint ä¸ä¼šå¯¹å®ƒè¿›è¡Œä»»ä½•æ£€æŸ¥ã€‚

å¯ä»¥å°† `globals` è§†ä¸ºä¸€ä¸ªç™½åå•ï¼Œå…¶ä¸­åŒ…å«äº†æ˜ç¡®æŒ‡å®šçš„å…¨å±€å˜é‡ï¼Œè€Œå…¶ä»–æœªè¢«åˆ—å‡ºçš„å˜é‡ä¼šè¢«è®¤ä¸ºæ˜¯æœªå®šä¹‰çš„ï¼Œä»è€Œé¿å…äº†ä¸ç»æ„åœ°ä½¿ç”¨æœªå£°æ˜çš„å˜é‡è€Œå¯¼è‡´çš„é”™è¯¯ã€‚

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä½¿ç”¨å…¨å±€å˜é‡å¯èƒ½ä¼šé™ä½ä»£ç çš„å¯è¯»æ€§å’Œå¯ç»´æŠ¤æ€§ï¼Œå› æ­¤åº”è¯¥è°¨æ…ä½¿ç”¨ï¼Œå¹¶ä¸”åªåœ¨ç¡®å®éœ€è¦ä½¿ç”¨å…¨å±€å˜é‡æ—¶æ‰ä½¿ç”¨ã€‚åŒæ—¶ï¼Œ`globals` å¯èƒ½ä¹Ÿä¼šå¯¼è‡´ä¸€äº›ä¸å¯é¢„æµ‹çš„é—®é¢˜ï¼Œå› æ­¤å»ºè®®ä»…åœ¨å¿…è¦æ—¶ä½¿ç”¨ã€‚

### rules

é…ç½®æ–‡ä»¶ä¸­æœ€å¸¸ç”¨çš„é…ç½®é¡¹ä¹‹ä¸€ï¼Œç”¨äºè®¾ç½® ESLint çš„è§„åˆ™å’Œè§„åˆ™çš„é”™è¯¯ç­‰çº§ã€‚`rules` é…ç½®é¡¹æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œå®ƒçš„æ¯ä¸ªå±æ€§è¡¨ç¤ºä¸€ä¸ªè§„åˆ™ï¼Œå±æ€§å€¼è¡¨ç¤ºè¯¥è§„åˆ™çš„é”™è¯¯ç­‰çº§ã€‚

é…ç½®æ–¹å¼ï¼š

```js
"rules": {
    "eqeqeq": "off",  // å…³é—­å‘Šè­¦
    "no-undef": "warn", // è­¦å‘Šçº§åˆ«
    "react/prop-types": "error", // é”™è¯¯çº§åˆ«
}
```

é…ç½®é¡¹è¿˜æœ‰ç¬¬äºŒä¸ªå‚æ•°ï¼š

```js
"semi": ["error", "always"] // è¦æ±‚åœ¨è¯­å¥æœ«å°¾å§‹ç»ˆä½¿ç”¨åˆ†å·ã€‚
"semi": ["error", "never"] // è¦æ±‚åœ¨è¯­å¥æœ«å°¾ä¸ä½¿ç”¨åˆ†å·ã€‚
```

å½“ç„¶äº†ï¼Œä¹Ÿå¯ä»¥è¿™æ ·å†™æ¥æ‹¦æˆªç‰¹å®šçš„æ–‡ä»¶ï¼š

```js
overrides: [
  {
    files: ["*.ts", "*.tsx"],
    rules: {
      "no-undef": "off",
      "react/prop-types": "off",
      "semi": "off"
    },
  },
],
```
è¦æ³¨æ„è§„åˆ™é›†ä¹‹é—´çš„é¡ºåºé—®é¢˜ï¼Œåé¢çš„è§„åˆ™é›†ä¼šè¦†ç›–å‰é¢çš„è§„åˆ™é›†ã€‚å¦‚æœéœ€è¦ä¿ç•™å‰é¢çš„è§„åˆ™é›†ä¸­çš„è§„åˆ™ï¼š

```js
"rules": Object.assign({}, require("eslint-config-airbnb/rules"))
```


å¸¸è§çš„ruleæœ‰å¦‚ä¸‹è¿™äº›ï¼Œ

-   `no-var`: ç¦æ­¢ä½¿ç”¨ `var` å…³é”®å­—å£°æ˜å˜é‡ï¼Œä½¿ç”¨ `let` æˆ– `const` ä»£æ›¿ã€‚
-   `no-unused-vars`: ç¦æ­¢å£°æ˜å˜é‡ä½†æœªä½¿ç”¨ï¼Œå‡å°‘ä»£ç å†—ä½™ã€‚
-   `no-console`: ç¦æ­¢ä½¿ç”¨ `console` è¯­å¥ï¼Œé¿å…ä»£ç åœ¨ç”Ÿäº§ç¯å¢ƒä¸­æ³„æ¼æ•æ„Ÿä¿¡æ¯ã€‚
-   `semi`: è¦æ±‚åœ¨è¯­å¥æœ«å°¾ä½¿ç”¨åˆ†å·ï¼Œè§„èŒƒä»£ç é£æ ¼ã€‚
-   `indent`: è¦æ±‚ä½¿ç”¨æŒ‡å®šçš„ç¼©è¿›é£æ ¼ï¼Œæé«˜ä»£ç å¯è¯»æ€§ã€‚
-   `quotes`: è¦æ±‚åœ¨å­—ç¬¦ä¸²å‘¨å›´ä½¿ç”¨æŒ‡å®šçš„å¼•å·ç±»å‹ï¼Œè§„èŒƒä»£ç é£æ ¼ã€‚
-   `no-undef`: ç¦æ­¢ä½¿ç”¨æœªå£°æ˜çš„å˜é‡ï¼Œå‡å°‘é”™è¯¯å‡ºç°çš„æ¦‚ç‡ã€‚
-   `no-extra-parens`: ç¦æ­¢å‡ºç°ä¸å¿…è¦çš„æ‹¬å·ï¼Œæé«˜ä»£ç å¯è¯»æ€§ã€‚
-   `no-multiple-empty-lines`: ç¦æ­¢å‡ºç°å¤šè¡Œç©ºç™½è¡Œï¼Œæé«˜ä»£ç å¯è¯»æ€§ã€‚
-   `no-trailing-spaces`: ç¦æ­¢è¡Œæœ«å‡ºç°ç©ºæ ¼ï¼Œæé«˜ä»£ç å¯è¯»æ€§ã€‚
-   `no-unreachable`: ç¦æ­¢å‡ºç°æ— æ³•åˆ°è¾¾çš„ä»£ç ï¼Œå‡å°‘ä»£ç å†—ä½™ã€‚
-   `no-useless-return`: ç¦æ­¢å‡ºç°ä¸å¿…è¦çš„ `return` è¯­å¥ï¼Œå‡å°‘ä»£ç å†—ä½™ã€‚

React

-   `react/jsx-uses-react`: æ£€æµ‹æ˜¯å¦ä½¿ç”¨äº† React åº“ï¼Œå¦‚æœæ²¡æœ‰ä½¿ç”¨åˆ™æŠ¥é”™ã€‚
-   `react/jsx-uses-vars`: æ£€æµ‹æ˜¯å¦å£°æ˜äº† JSX å˜é‡ï¼Œå¦‚æœå£°æ˜äº†ä½†æœªä½¿ç”¨åˆ™æŠ¥é”™ã€‚
-   `react/jsx-no-undef`: æ£€æµ‹æ˜¯å¦ä½¿ç”¨äº†æœªå®šä¹‰çš„ JSX å˜é‡ï¼Œå¦‚æœä½¿ç”¨äº†åˆ™æŠ¥é”™ã€‚
-   `react/jsx-indent`: è¦æ±‚ JSX å…ƒç´ çš„ç¼©è¿›ä¸ºæŒ‡å®šæ•°é‡çš„ç©ºæ ¼ã€‚
-   `react/jsx-indent-props`: è¦æ±‚ JSX å±æ€§çš„ç¼©è¿›ä¸ºæŒ‡å®šæ•°é‡çš„ç©ºæ ¼ã€‚
-   `react/no-unescaped-entities`: ç¦æ­¢åœ¨ JSX ä¸­ä½¿ç”¨æœªè½¬ä¹‰çš„ HTML å®ä½“å­—ç¬¦ã€‚
-   `react/prop-types`: æ£€æµ‹æ˜¯å¦ä¸ºç»„ä»¶å£°æ˜äº† props ç±»å‹å®šä¹‰ï¼Œå¦‚æœæ²¡æœ‰åˆ™æŠ¥é”™ã€‚

Vue

-   `vue/html-indent`: è¦æ±‚æ¨¡æ¿ä¸­çš„ç¼©è¿›ä¸ºæŒ‡å®šæ•°é‡çš„ç©ºæ ¼ã€‚
-   `vue/no-unused-components`: æ£€æµ‹æ˜¯å¦æ³¨å†Œäº†ä½†æœªä½¿ç”¨çš„ç»„ä»¶ï¼Œå¦‚æœæœ‰åˆ™æŠ¥é”™ã€‚
-   `vue/no-unused-vars`: æ£€æµ‹æ˜¯å¦å£°æ˜äº†ä½†æœªä½¿ç”¨çš„å˜é‡ï¼Œå¦‚æœæœ‰åˆ™æŠ¥é”™ã€‚
-   `vue/require-prop-types`: è¦æ±‚ç»„ä»¶å£°æ˜ props ç±»å‹å®šä¹‰ã€‚
-   `vue/require-default-prop`: è¦æ±‚ç»„ä»¶å£°æ˜ props çš„é»˜è®¤å€¼ã€‚
-   `vue/require-v-for-key`: è¦æ±‚ä½¿ç”¨ v-for æŒ‡ä»¤æ—¶ä¸ºæ¯ä¸ªé¡¹æä¾›å”¯ä¸€çš„ key å±æ€§ã€‚

ç­‰ç­‰..

é™¤æ­¤ä¹‹å¤–ï¼Œä¸åŒçš„æ’ä»¶è¿˜æœ‰å¯¹åº”çš„ruleï¼Œå¯æŸ¥çœ‹å¯¹åº”æ–‡æ¡£æ¥é…ç½®ã€‚

### plugins

ç”¨æ¥æŒ‡å®šæ’ä»¶çš„ä¸€ä¸ªé€‰é¡¹ã€‚æ’ä»¶æ˜¯ä¸€ç§æ‰©å±• ESLint åŠŸèƒ½çš„æ–¹å¼ï¼Œå¯ä»¥ç”¨äºæ£€æŸ¥ç‰¹å®šç±»å‹çš„é—®é¢˜æˆ–è€…åº”ç”¨ç‰¹å®šçš„ç¼–ç è§„èŒƒã€‚ESLint æ’ä»¶é€šå¸¸æ˜¯ä¸€ä¸ª npm åŒ…ï¼ŒåŒ…å«ä¸€ç»„è§„åˆ™å’Œç›¸å…³çš„é…ç½®ï¼Œé€šè¿‡ `plugins` é€‰é¡¹å°†å…¶å¼•å…¥åˆ°é¡¹ç›®ä¸­ï¼Œå°±å¯ä»¥ä½¿ç”¨è¿™äº›è§„åˆ™æ¥æ£€æŸ¥ä»£ç äº†ã€‚

ESLint æ’ä»¶é€šå¸¸éœ€è¦é…åˆå¯¹åº”çš„è§„åˆ™è¿›è¡Œä½¿ç”¨ï¼Œå¯ä»¥é€šè¿‡ `extends` é€‰é¡¹æ¥ç»§æ‰¿æ’ä»¶çš„è§„åˆ™ã€‚å¸¸ç”¨çš„æ’ä»¶å¦‚ä¸‹ï¼š

1.  `eslint-plugin-import`ï¼šç”¨äºæ£€æŸ¥æ¨¡å—å¯¼å…¥çš„è§„èŒƒæ€§ï¼ŒåŒ…æ‹¬è·¯å¾„ã€æ–‡ä»¶ç±»å‹å’Œæ–‡ä»¶å†…å®¹ç­‰æ–¹é¢çš„æ£€æŸ¥ã€‚
2.  `eslint-plugin-react`ï¼šç”¨äºæ£€æŸ¥ React ä»£ç çš„è§„èŒƒæ€§ï¼ŒåŒ…æ‹¬ JSX è¯­æ³•ã€ç»„ä»¶ä½¿ç”¨å’Œç”Ÿå‘½å‘¨æœŸç­‰æ–¹é¢çš„æ£€æŸ¥ã€‚
3.  `eslint-plugin-vue`ï¼šç”¨äºæ£€æŸ¥ Vue.js ä»£ç çš„è§„èŒƒæ€§ï¼ŒåŒ…æ‹¬æ¨¡æ¿ã€ç»„ä»¶å’ŒæŒ‡ä»¤ç­‰æ–¹é¢çš„æ£€æŸ¥ã€‚
4.  `eslint-plugin-jest`ï¼šç”¨äºæ£€æŸ¥ Jest æµ‹è¯•ä»£ç çš„è§„èŒƒæ€§ï¼ŒåŒ…æ‹¬æµ‹è¯•åç§°ã€åŒ¹é…å™¨å’Œæ–­è¨€ç­‰æ–¹é¢çš„æ£€æŸ¥ã€‚
5.  `eslint-plugin-node`ï¼šç”¨äºæ£€æŸ¥ Node.js ä»£ç çš„è§„èŒƒæ€§ï¼ŒåŒ…æ‹¬ API ä½¿ç”¨ã€æ–‡ä»¶ç³»ç»Ÿå’Œå­è¿›ç¨‹ç­‰æ–¹é¢çš„æ£€æŸ¥ã€‚
6.  `eslint-plugin-prettier`ï¼šç”¨äºå°† Prettier ä»£ç æ ¼å¼åŒ–é›†æˆåˆ° ESLint ä¸­ï¼Œå¯ä»¥é€šè¿‡é…ç½®æ¥è‡ªåŠ¨ä¿®å¤ä»£ç æ ¼å¼é—®é¢˜ã€‚
7.  `eslint-plugin-security`ï¼šç”¨äºæ£€æŸ¥ä»£ç ä¸­çš„å®‰å…¨é—®é¢˜ï¼ŒåŒ…æ‹¬è·¨ç«™ç‚¹è„šæœ¬æ”»å‡»ã€å‘½ä»¤æ³¨å…¥å’Œ SQL æ³¨å…¥ç­‰æ–¹é¢çš„æ£€æŸ¥ã€‚

ç­‰ç­‰...

è¿™é‡Œä»¥ eslint-plugin-react ä¸ºä¾‹è®²è§£é…ç½®ï¼š

å®‰è£…ï¼š

```
npm install eslint-plugin-react --save-dev
```

ä½¿ç”¨ï¼š

```js
{
  "plugins": ["react"],
  "extends": ["eslint:recommended", "plugin:react/recommended"],
  "rules": {
    "react/jsx-props-no-spreading": "off",
    "react/jsx-props-no-spreading": [
      "error",
      {
        "exceptions": ["Component"],
        "html": "enforce",
        "custom": "ignore"
      }
    ]
  }
}
```

åœ¨ä¸Šé¢çš„é…ç½®ä¸­ï¼Œä½¿ç”¨äº† `eslint:recommended` å’Œ `plugin:react/recommended` æ‰©å±•ï¼Œåˆ†åˆ«è¡¨ç¤ºä½¿ç”¨äº† ESLint æ¨èçš„è§„åˆ™å’Œ `eslint-plugin-react` çš„æ¨èè§„åˆ™ã€‚è¿™äº›è§„åˆ™å¯ä»¥é€šè¿‡ `rules` é…ç½®é¡¹è¿›è¡Œä¿®æ”¹å’Œè¦†ç›–ã€‚

### extends

ç”¨æ¥ç»§æ‰¿å’Œæ‰©å±• ESLint è§„åˆ™é›†çš„é…ç½®é¡¹ã€‚é€šè¿‡ `extends`ï¼Œå¯ä»¥å°†ç°æœ‰çš„è§„åˆ™é›†åˆå¹¶åˆ°è‡ªå·±çš„è§„åˆ™é…ç½®ä¸­ï¼Œä¹Ÿå¯ä»¥åŸºäºç°æœ‰çš„è§„åˆ™é›†è¿›è¡Œæ‰©å±•å’Œå®šåˆ¶åŒ–ã€‚å…¶ä¸ pluginsçš„åŒºåˆ«æ˜¯ï¼Œå‰è€…é›†æˆäº†åè€…çš„åŠŸèƒ½ï¼Œè€Œä¸”è‡ªå¸¦äº†é…ç½®è§„åˆ™rulesã€‚

ESLint æä¾›äº†å¤šä¸ªå†…ç½®è§„åˆ™é›†ï¼ŒåŒ…æ‹¬ `eslint:recommended`ã€`plugin:@typescript-eslint/recommended`ã€`plugin:react/recommended`ã€`plugin:vue/recommended` ç­‰ã€‚é€šè¿‡åœ¨é…ç½®æ–‡ä»¶ä¸­è®¾ç½® `extends` ä¸ºå†…ç½®è§„åˆ™é›†çš„åç§°ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨å†…ç½®è§„åˆ™é›†ä¸­çš„è§„åˆ™ã€‚

é™¤äº†å†…ç½®è§„åˆ™é›†å¤–ï¼Œè¿˜æœ‰è®¸å¤šç¬¬ä¸‰æ–¹è§„åˆ™é›†å¯ä»¥ä½¿ç”¨ï¼Œæ¯”å¦‚ `airbnb`ã€`standard`ã€`prettier` ç­‰ã€‚

å¦‚æœéœ€è¦åŒæ—¶ä½¿ç”¨å¤šä¸ªè§„åˆ™é›†ï¼Œå¯ä»¥ä½¿ç”¨æ•°ç»„çš„æ–¹å¼å°†å¤šä¸ªè§„åˆ™é›†åˆå¹¶åˆ°ä¸€èµ·ï¼š

```js
{
  "extends": [
    "eslint:recommended",
    "plugin:@typescript-eslint/recommended",
    "plugin:react/recommended",
    "plugin:vue/recommended"
  ]
}
```

å¦‚æœéœ€è¦å®šä¹‰è‡ªå·±çš„è§„åˆ™é›†ï¼Œå¯ä»¥ä½¿ç”¨ç›¸å¯¹è·¯å¾„æˆ–ç»å¯¹è·¯å¾„æŒ‡å®šè§„åˆ™é›†çš„ä½ç½®:

```js
{
  "extends": "./path/to/my-rule-set"
}
```
extends çš„ä¼˜å…ˆçº§æ˜¯ä»ä½åˆ°é«˜çš„ï¼Œåé¢çš„è§„åˆ™ä¼šè¦†ç›–å‰é¢çš„è§„åˆ™ï¼Œæœ€ç»ˆä»¥æœ€åä¸€ä¸ªè§„åˆ™é›†ä¸ºå‡†ï¼›è€Œå½“ä¸€ä¸ªè§„åˆ™åœ¨å¤šä¸ªè§„åˆ™é›†ä¸­å®šä¹‰æ—¶ï¼Œåè¾¹çš„ä¼šè¦†ç›–å‰é¢çš„ã€‚ä¾‹å¦‚ï¼š

```js
// eslint-config-a.js
module.exports = {
  rules: {
    'no-console': 'off',
    'no-alert': 'error'
  }
};

// eslint-config-b.js
module.exports = {
  extends: ['eslint-config-a'],
  rules: {
    'no-console': 'error',
    'no-debugger': 'warn'
  }
};
```
eslint-config-b ä¸­ï¼Œno-consoleä½¿ç”¨errorï¼Œè€Œä¸æ˜¯offã€‚

### settings

ä¸€ä¸ªå¯é€‰çš„é¡¶å±‚å±æ€§ï¼Œå®ƒå¯ä»¥ç”¨æ¥é…ç½®ä¸€äº›é¢å¤–çš„ã€è‡ªå®šä¹‰çš„ä¿¡æ¯ï¼Œä¾›æ’ä»¶å’Œè§„åˆ™ä½¿ç”¨ã€‚å®ƒçš„å€¼æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œå¯ä»¥åŒ…å«å¤šä¸ªå±æ€§ã€‚ä¸‹é¢æ˜¯ä¸€äº›å¸¸ç”¨çš„ `settings` å±æ€§åŠå…¶ä½œç”¨ï¼š

-   `react`ï¼šè¯¥å±æ€§ç”¨äºé…ç½® React ç›¸å…³çš„ç¯å¢ƒå’Œé€‰é¡¹ã€‚å…·ä½“æ¥è¯´ï¼Œå®ƒå¯ä»¥åŒ…å«ä»¥ä¸‹å±æ€§ï¼š
    -   `version`ï¼šReact çš„ç‰ˆæœ¬å·ï¼Œå¦‚æœä¸è®¾ç½®è¯¥å±æ€§ï¼Œåˆ™æ’ä»¶ä¼šå°è¯•è‡ªåŠ¨æ£€æµ‹ React çš„ç‰ˆæœ¬ã€‚
    -   `pragma`ï¼šJSX çš„æ³¨é‡Šè¯­æ³•ï¼Œå¦‚æœä½ ä½¿ç”¨äº†ç±»ä¼¼äº `/** @jsx h */` çš„æ³¨é‡Šæ¥æŒ‡å®š JSX çš„è½¬æ¢å‡½æ•°ï¼Œåˆ™éœ€è¦è®¾ç½®è¯¥å±æ€§ã€‚
    -   `fragment`ï¼šä½¿ç”¨ Fragment ç»„ä»¶çš„åç§°ï¼Œå¦‚æœä½ ä½¿ç”¨äº† Fragment ç»„ä»¶ï¼Œåˆ™éœ€è¦è®¾ç½®è¯¥å±æ€§ã€‚
    -   `linkComponents`ï¼šé…ç½®è‡ªå®šä¹‰ç»„ä»¶é“¾æ¥çš„è§„åˆ™ï¼Œç”¨äºè§£å†³ç»„ä»¶åœ¨æŸäº›æƒ…å†µä¸‹æ— æ³•é“¾æ¥çš„é—®é¢˜ã€‚
-   `import/resolver`ï¼šè¯¥å±æ€§ç”¨äºé…ç½®å¯¼å…¥æ¨¡å—æ—¶çš„è§£æå™¨ï¼Œé€šå¸¸ç”¨äºè§£å†³è·¯å¾„é—®é¢˜ã€‚å…·ä½“æ¥è¯´ï¼Œå®ƒå¯ä»¥åŒ…å«ä»¥ä¸‹å±æ€§ï¼š
    -   `node`ï¼šè¯¥å±æ€§ç”¨äºè§£æ Node.js æ¨¡å—ã€‚
    -   `webpack`ï¼šè¯¥å±æ€§ç”¨äºè§£æ Webpack æ¨¡å—ã€‚
    -   `typescript`ï¼šè¯¥å±æ€§ç”¨äºè§£æ TypeScript æ¨¡å—ã€‚
    -   `alias`ï¼šé…ç½®æ¨¡å—è·¯å¾„çš„åˆ«åï¼Œç”¨äºè§£å†³è·¯å¾„é—®é¢˜ã€‚
    -   `extensions`ï¼šé…ç½®æ¨¡å—çš„æ‰©å±•åï¼Œç”¨äºè§£å†³æ¨¡å—æ–‡ä»¶ç±»å‹çš„é—®é¢˜ã€‚
-   `polyfills`ï¼šè¯¥å±æ€§ç”¨äºé…ç½®ä¸€äº›éœ€è¦åœ¨ä»£ç ä¸­æ‰‹åŠ¨å¼•å…¥çš„ Polyfillï¼Œé€šå¸¸ç”¨äºè§£å†³å…¼å®¹æ€§é—®é¢˜ã€‚
-   `react-native/style-sheet-object-names`ï¼šè¯¥å±æ€§ç”¨äºé…ç½® React Native ä¸­ä½¿ç”¨çš„ StyleSheet å¯¹è±¡åç§°ã€‚
-   `jest`ï¼šè¯¥å±æ€§ç”¨äºé…ç½® Jest æµ‹è¯•æ¡†æ¶ç›¸å…³çš„ä¿¡æ¯ã€‚
-   `svelte3`ï¼šè¯¥å±æ€§ç”¨äºé…ç½® Svelte 3 ç›¸å…³çš„ä¿¡æ¯ã€‚

ç­‰ç­‰...

## 3. æ–°é…ç½®æ–‡ä»¶

ESLintå°†åœ¨ 9.0ç‰ˆæœ¬å¯ç”¨æ–°çš„é…ç½®æ–‡ä»¶æ ¼å¼`eslint.config.js`ï¼Œå…¶æ¢äº†ä¸€ç§æ–°çš„é…ç½®æ–¹å¼ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š

```js
export default [
  {
    rules: {
      semi: "error",
      "prefer-const": "error"
    }
  },
  {
    files: ["src/**/*.js"],
    ignores: ["**/*.config.js"],
    rules: {
      semi: "off"
    }
  }
]
```

å…·ä½“æ–°çš„åŠ¨å‘ï¼Œå¯ä»¥å…³æ³¨[å®˜ç½‘](https://eslint.org/docs/latest/use/configure/configuration-files-new)çš„æ›´æ–°ã€‚


## 4. å‘å¸ƒnpm

å»ºç«‹ä¸€ä¸ªæ–‡ä»¶ä»“åº“ï¼š


![image.png](/img/posts/2023-4-21/2023-4-21-1.png)

index.jså†™å…¥é…ç½®ï¼š

![image.png](/img/posts/2023-4-21/2023-4-21-2.png)


package.jsonå†™å…¥ï¼š


![image.png](/img/posts/2023-4-21/2023-4-21-3.png)

ç™»å½•npmï¼š

```shell
npm login --registry=http://registry.npm.pre.xxx.com
```

æ‰§è¡Œå‘å¸ƒè„šæœ¬ï¼ˆpatchä¸ºä¾‹ï¼‰ï¼š

```shell
npm run publish:patch
```

åœ¨å‰ç«¯é¡¹ç›®ä¸­ä½¿ç”¨é…ç½®ï¼š


![image.png](/img/posts/2023-4-21/2023-4-21-4.png)

å½“ç„¶äº†ï¼Œä½¿ç”¨å‰è®°å¾— `yarn -D` ä¸€ä¸‹å•¦ã€‚

å‰©ä½™çš„é…ç½®huskyç­‰å·¥ä½œï¼Œå°±å¯ä»¥å‚è§æˆ‘ä¹‹å‰çš„æ–‡ç« ï¼š[å‰ç«¯é¡¹ç›®é…ç½® git hook + prettier + eslint](https://juejin.cn/post/7172430884673421342)

----

æ€»ç»“ï¼šeslinté…ç½®æ–‡ä»¶å•ç‹¬å°è£…åœ¨ä¸€ä¸ªç‹¬ç«‹åº“ä¸­ï¼Œä¾¿äºæ‰©å±•å’Œç»´æŠ¤å‡çº§ï¼Œçµæ´»æ€§æ›´å¼ºï¼Œé€‚åˆå‰ç«¯å¤šé¡µé¢åº”ç”¨æˆ–è€…å¾®æœåŠ¡åº”ç”¨çš„åœºæ™¯ã€‚

è‡³æ­¤ï¼Œå‰ç«¯æ ¡éªŒå·¥å…· eslintå°±é…ç½®å®Œæˆå•¦ï¼24:T29d8,## 1. å†™åœ¨å‰é¢çš„è¯

ç°åº¦è¿™ä¸ªæ¦‚å¿µï¼Œæ¥è‡ªæ•°å­—å›¾åƒé¢†åŸŸï¼Œæœ€åˆæ˜¯æè¿°é»‘ç™½æ•°å­—å›¾åƒçš„ç°åº¦å€¼ï¼ŒèŒƒå›´ä» `0` åˆ° `255`ï¼Œ`0` è¡¨ç¤ºé»‘è‰²ï¼Œ`255` è¡¨ç¤ºç™½è‰²ï¼Œä¸­é—´çš„æ•°å€¼è¡¨ç¤ºä¸åŒç¨‹åº¦çš„ç°è‰²ã€‚

ç°åº¦ç³»ç»Ÿçš„è¯ç”Ÿæºäºäº¤å‰å­¦ç§‘çš„å»ºè®¾ï¼Œåœ¨äº’è”ç½‘ä¸Šä¹Ÿä¸ä¾‹å¤–ã€‚å¯¹äºä¸€ä¸ªè½¯ä»¶äº§å“ï¼Œåœ¨å¼€å‘å’Œå‘å¸ƒçš„æ—¶å€™è‚¯å®šå¸Œæœ›ç”¨æˆ·èƒ½å¤Ÿé¡ºåˆ©çš„çœ‹åˆ°æƒ³è®©å…¶çœ‹åˆ°çš„å†…å®¹ã€‚ä½†æ˜¯ï¼Œå‘å¸ƒæ²¡æœ‰ä¸€å¸†é£é¡ºçš„ï¼Œå¦‚æœåœ¨å‘å¸ƒçš„æŸä¸ªç¯èŠ‚å‡ºäº†é—®é¢˜ï¼Œæ¯”å¦‚æ‰“é”™äº†é•œåƒæˆ–è€…ç”±äºéƒ¨ç½²ç¯å¢ƒä¸åŒè§¦å‘äº†éšè—çš„bugï¼Œå¯¼è‡´ç”¨æˆ·çœ‹åˆ°äº†é”™è¯¯çš„é¡µé¢æˆ–è€…æ—§çš„é¡µé¢ï¼Œè¿™å°±å‡ºç°äº†ç”Ÿäº§äº‹æ•…ã€‚ä¸ºäº†é¿å…è¿™ç§æƒ…å†µå‡ºç°ï¼Œå€Ÿé‰´æ•°å­—å›¾åƒå¤„ç†çš„ç†å¿µï¼Œè®¾è®¡å¸ˆä»¬è®¾è®¡å‡ºäº†ä¸€ç§ä»‹äº `0` å’Œ `1` ä¹‹é—´çš„`è¿‡æ¸¡ç³»ç»Ÿ`çš„æ¦‚å¿µï¼šè®©ç³»ç»Ÿå¯ä»¥é¢„å…ˆå‘å¸ƒï¼Œå¹¶è®¾ç½®å¯è§èŒƒå›´ï¼Œå°±åƒæœ‹å‹åœˆä¸€æ ·ï¼Œç­‰åˆ°é£é™©å¯æ§åï¼Œå†å¯¹å…¬ä¼—å¯è§ã€‚è¿™å°±æ˜¯ç°åº¦ç³»ç»Ÿã€‚

ç°åº¦ç³»ç»Ÿç‰ˆæœ¬çš„å‘å¸ƒåŠ¨ä½œç§°ä½œ `ç°åº¦å‘å¸ƒ`ï¼Œåˆåé‡‘ä¸é›€å‘å¸ƒï¼Œæˆ–è€…ç°åº¦æµ‹è¯•ï¼Œä»–æ˜¯æŒ‡åœ¨é»‘ä¸ç™½ä¹‹é—´èƒ½å¤Ÿå¹³æ»‘è¿‡æ¸¡çš„ä¸€ç§å‘å¸ƒæ–¹å¼ã€‚åœ¨å…¶ä¸Šå¯ä»¥è¿›è¡ŒA/B testingï¼Œå³è®©ä¸€éƒ¨åˆ†ç”¨æˆ·ç»§ç»­ç”¨äº§å“ç‰¹æ€§Aï¼Œä¸€éƒ¨åˆ†ç”¨æˆ·å¼€å§‹ç”¨äº§å“ç‰¹æ€§Bï¼Œå¦‚æœç”¨æˆ·å¯¹Bæ²¡æœ‰ä»€ä¹ˆåå¯¹æ„è§ï¼Œé‚£ä¹ˆé€æ­¥æ‰©å¤§èŒƒå›´ï¼ŒæŠŠæ‰€æœ‰ç”¨æˆ·éƒ½è¿ç§»åˆ°Bä¸Šé¢æ¥ã€‚(æ¦‚å¿µæ¥è‡ªçŸ¥ä¹)

å¯¹äºå‰ç«¯é¢†åŸŸï¼Œæ¼”è¿›åˆ°ç°åœ¨ï¼Œç°åº¦ç³»ç»Ÿä¸»è¦æœ‰å¦‚ä¸‹å‡ ç‚¹åŠŸèƒ½ï¼š

1. å¢é‡ç°åº¦ï¼šå°çš„patchå¯ä»¥å¢é‡çš„æ·»åŠ åœ¨å‘å¸ƒç‰ˆæœ¬ä¸Šï¼Œä¹Ÿå¯ä»¥é€šè¿‡å¼€å…³ä¸€é”®å…³é—­
2. ç”¨æˆ·ç°åº¦ï¼šå¢é‡å’Œå…¨é‡ç‰ˆæœ¬éƒ½å¯å¯¹ä¸åŒç¾¤ä½“æˆ–è€…æŸå‡ ä¸ªç‰¹å®šçš„ç”¨æˆ·è¿›è¡Œç°åº¦å¯è§
3. ç‰ˆæœ¬å›é€€ï¼šæ¯ä¸€ä¸ªç‰ˆæœ¬éƒ½åœ¨ç°åº¦ç³»ç»Ÿé‡Œå¯è§ï¼Œå¯ä»¥ä¸€é”®å›é€€

å‰ç«¯ç°åº¦ç³»ç»Ÿå·¥ä½œæµç¨‹å›¾å¦‚ä¸‹ï¼š


```mermaid
sequenceDiagram
å‰ç«¯é¡¹ç›®-->ç°åº¦ç³»ç»Ÿ: éƒ¨ç½²é˜¶æ®µ
å‰ç«¯é¡¹ç›®->>ç°åº¦ç³»ç»Ÿ: 1.CI æ‰“åŒ…åå†™å…¥æ‰“åŒ…èµ„æºï¼ŒçŠ¶æ€åˆå§‹åŒ–
å‰ç«¯é¡¹ç›®-->ç°åº¦ç³»ç»Ÿ: è®¿é—®é˜¶æ®µ
å‰ç«¯é¡¹ç›®->>ç°åº¦ç³»ç»Ÿ: 1.é¡µé¢è®¿é—®ï¼Œè¯·æ±‚å½“å‰ç™»å½•ç”¨æˆ·å¯¹åº”çš„èµ„æºç‰ˆæœ¬
ç°åº¦ç³»ç»Ÿ-->>å‰ç«¯é¡¹ç›®: 2.ä»å¯¹åº”ç‰ˆæœ¬çš„èµ„æºç›®å½•è¿”å›å‰ç«¯èµ„æº
```

![](/img/posts/2023-3-19/2023-3-19-1.png)
---

## 2. ç°åº¦è§„åˆ™

å…³äºç°åº¦èµ„æºä¼˜å…ˆçº§çš„è¯´æ˜å¦‚ä¸‹ï¼š

| ç°åº¦ç­–ç•¥ | ä¼˜å…ˆçº§ |
| --- | --- |
| æœªç”Ÿæ•ˆ | ä½ |
| ç”Ÿæ•ˆ | é«˜ |
| å…¨é‡ | ä¸€èˆ¬ |

å¦‚æ­¤å°±èµ·åˆ°äº†`ç°åº¦`çš„ä½œç”¨ï¼šå…¨é‡è¡¨ç¤ºæ‰€æœ‰äººéƒ½å¯ä»¥çœ‹ï¼›ç”Ÿæ•ˆè¡¨ç¤ºåªæœ‰åœ¨è§„åˆ™ä¸­çš„ç”¨æˆ·æ‰å¯ä»¥çœ‹åˆ°è¿™éƒ¨åˆ†å¢é‡æ›´æ–°ï¼Œä¼˜å…ˆçº§æœ€é«˜ï¼›æœªç”Ÿæ•ˆè¡¨ç¤ºä¸ç°åº¦ï¼Œä¼˜å…ˆçº§æœ€ä½ã€‚

## 3. ç°åº¦ç³»ç»Ÿæ•°æ®åº“è®¾è®¡

> `ä¸ºä»€ä¹ˆç°åº¦ç³»ç»Ÿæœ‰åç«¯`ï¼šå‰ç«¯é¡¹ç›® CI éƒ¨ç½²åï¼Œä¼šäº§ç”Ÿä¸€ä¸ª commit å·å’Œä¸€ä¸ªé•œåƒè®°å½•ï¼Œå¹¶ä¸”æ‰“åŒ…åçš„æ–‡ä»¶å­˜æ”¾åœ¨æœåŠ¡å™¨ä¸­æŸä¸€ä¸ªæ·±å±‚çš„æ–‡ä»¶å¤¹ç›®å½•ä¸­ï¼Œç°åº¦ç³»ç»Ÿéœ€è¦å­˜å…¥è¯¥éƒ¨ç½²çš„ç›®å½•åœ°å€ï¼Œä¾¿äºåœ¨åˆ‡æ¢ç°åº¦æ—¶æŸ¥æ‰¾ä¸åŒç‰ˆæœ¬çš„æ–‡ä»¶ã€‚


å…ˆä»‹ç»ä¸€ä¸ªè¦éƒ¨ç½²çš„å‰ç«¯é¡¹ç›®ï¼ˆä½ å¯ä»¥æ ¹æ®è‡ªå·±çš„å‰ç«¯é¡¹ç›®åŠ¨æ€è°ƒæ•´ï¼‰ã€‚

æœ¬é¡¹ç›®é’ˆå¯¹çš„å‰ç«¯é¡¹ç›®æ˜¯ä¸€ä¸ªåŸºäºå¾®æœåŠ¡æ¶æ„çš„é¡¹ç›®ï¼Œ

ä¸‹é¢æ˜¯è®¾è®¡ERå›¾ï¼š


![image.png](/img/posts/2023-3-19/2023-3-19-2.png)

æˆ‘ä»¬ä¾æ­¤æ¥åˆ†æï¼š

### å­é¡¹ç›®è¡¨

è¯¥è¡¨ç”¨äºå­˜æ”¾æ‰€æœ‰å­é¡¹ç›®çš„ä¿¡æ¯ï¼Œæ–°å»ºä¸€ä¸ªå¾®æœåŠ¡å­é¡¹ç›®æ—¶ï¼Œä¼šåœ¨è¿™ä¸ªè¡¨é‡Œæ–°å»ºä¸€ä¸ªæ¡ç›®ï¼Œæ•°æ®ç¤ºæ„å¦‚ä¸‹ï¼š


![image.png](/img/posts/2023-3-19/2023-3-19-3.png)

### ç°åº¦ç”¨æˆ·è¡¨

ç”¨äºç°åº¦ç³»ç»Ÿç™»å½•çš„ç”¨æˆ·ï¼Œæ‹¥æœ‰ç°åº¦æƒé™çš„äººæ‰å¯ä»¥åŠ å…¥ã€‚

### èµ„æºè¡¨

èµ„æºè¡¨å­˜æ”¾é¡¹ç›®åœ¨ CI ä¸­å†™å…¥çš„ commit ä¿¡æ¯å’Œ build å®Œä»¥ååœ¨æœåŠ¡å™¨çš„å­˜æ”¾ä½ç½®ï¼Œæ•°æ®ç¤ºæ„å¦‚ä¸‹ï¼š


![image.png](/img/posts/2023-3-19/2023-3-19-4.png)

å…¶ä¸­ `branch` æ˜¯è·‘CIçš„åˆ†æ”¯ï¼Œ`data` å­˜æ”¾æ‰“åŒ…èµ„æºç›®å½•ä¿¡æ¯ï¼Œä¸€èˆ¬ç»“æ„å¦‚ä¸‹ï¼š


![image.png](/img/posts/2023-3-19/2023-3-19-5.png)

`gitProjectId` å­˜æ”¾è¯¥äº§å“åœ¨ gitlab ä¸­çš„é¡¹ç›®å·ï¼Œ `status` è¡¨ç¤ºæ„å»ºçŠ¶æ€ï¼š0ï¼šæ„å»ºå®Œæˆ 1ï¼šéƒ¨ç½²å®Œæˆ 2ï¼šæ„å»ºå¤±è´¥ï¼Œ3ï¼šéƒ¨ç½²å¤±è´¥ã€‚

è¿™é‡Œç®€å•æä¸€ä¸‹ CI æ˜¯å¦‚ä½•å†™å…¥ç°åº¦ç³»ç»Ÿæ•°æ®åº“çš„ï¼Œè¿‡å¤šè¯¦æƒ…ä¸åšè§£é‡Šï¼Œå†™å…¥æ•°æ®åº“æ–¹å¼å¾ˆå¤šï¼Œè¿™åªæ˜¯å…¶ä¸­ä¸€ç§å®ç°æ–¹å¼ã€‚

1. é¦–å…ˆåœ¨ CI build ç¯èŠ‚å¾€æœåŠ¡å™¨å†™å…¥æ‰“åŒ…ä¿¡æ¯çš„ JSONï¼š

![image.png](/img/posts/2023-3-19/2023-3-19-6.png)

å…¶ä¸­ build.sh è´Ÿè´£æŠŠä¼ å…¥çš„å‚æ•°å†™åˆ°ä¸€ä¸ª json ä¸­ã€‚ä¸Šå›¾ä¸­æ˜¯å¾€æ ¹ç›®å½•copyï¼Œæ–¹ä¾¿ä¸‹ä¸€ä¸ª CI jobè¯»å–jsonæ–‡ä»¶çš„ç¤ºæ„å›¾ã€‚

2. åœ¨ CI éƒ¨ç½²ç¯èŠ‚ï¼Œé€šè¿‡è°ƒç”¨è„šæœ¬åˆ›å»ºèµ„æºï¼š


![image.png](/img/posts/2023-3-19/2023-3-19-7.png)

å…¶ä¸­ run_gray.js:

```js
const { ENV, file, branch, projectId, gitProjectId, user, commitMsg } = require('yargs').argv;

axios({
    url: URL,
    method: "POST",
    headers: {
        remoteUser: user
    },
    data: {
        Action: "CreateResource",
        projectId,
        branch,
        commitMsg,
        gitProjectId,
        channel: Channel,
        data: fs.readFileSync(file, 'utf8'),
        status: "0"
    }
}).then(...)
```
å…¶ä¸­ status çš„å˜åŒ–ï¼Œåœ¨ CI éƒ¨ç½²æœåŠ¡å™¨å®Œæˆåï¼Œè¿½åŠ ä¸€ä¸ª `UpdateResource` åŠ¨ä½œå³å¯ï¼š

```
if [[ $RetCode != 0 ]]; then curl "$STARK_URL" -X 'POST' -H 'remoteUser: '"$GITLAB_USER_NAME"'' -H 'Content-Type: application/json' -d '{"Action": "UpdateResource", "id": "'"$ResourceId"'", "status": "2"}' > test.log && echo `cat test.log`; fi
```

### ç°åº¦ç­–ç•¥è¡¨

ç°åº¦ç­–ç•¥æ˜¯å¯¹ç°åº¦èµ„æºçš„è°ƒåŠ¨é…ç½®ã€‚å…¶è®¾è®¡å¦‚ä¸‹ï¼š

![image.png](/img/posts/2023-3-19/2023-3-19-8.png)

å…¶ä¸­ï¼Œ`prijectId` è¡¨ç¤ºç°åº¦çš„é¡¹ç›®ï¼Œ`resourceId` è¡¨ç¤ºä½¿ç”¨çš„èµ„æºï¼Œ`rules` é…ç½®äº†å¯¹åº”çš„ç”¨æˆ·æˆ–ç”¨æˆ·ç»„ï¼ˆçœ‹ä½ æ€ä¹ˆé…ç½®äº†ï¼Œæˆ‘è¿™é‡Œåªé…ç½®äº†å•ç‹¬çš„ userIdï¼‰ï¼Œ`status` æ˜¯ç°åº¦çš„çŠ¶æ€ï¼Œæˆ‘è®¾ç½®äº†ä¸‰ç§ï¼š

- default: æœªç”Ÿæ•ˆ
- failure: ç”Ÿæ•ˆ
- success: å…¨é‡

çŠ¶æ€ç”Ÿæ•ˆè¡¨ç¤ºæ˜¯å¢é‡å‘å¸ƒçš„æ„æ€ã€‚

åˆ°è¿™é‡Œï¼Œæ•°æ®åº“è®¾è®¡å°±å®Œæ¯•äº†ã€‚

---

## 4. ç°åº¦ç³»ç»Ÿæ¥å£APIå¼€å‘

æœ‰äº†æ•°æ®åº“ï¼Œè¿˜éœ€è¦æä¾›èƒ½å¤Ÿæ“ä½œæ•°æ®åº“çš„æœåŠ¡ï¼Œä¸Šè¾¹åˆ›å»ºèµ„æºçš„æ¥å£å°±æ˜¯è°ƒç”¨çš„ç°åº¦è‡ªå·±çš„APIå®ç°çš„ã€‚ä¸»è¦çš„APIåˆ—è¡¨å¦‚ä¸‹ï¼š


| åç§° | æè¿° |
| --- | --- |
| getResourcesByProjectId | è·å–å•ä¸ªäº§å“ä¸‹æ‰€æœ‰èµ„æº |
| getResourcesById | é€šè¿‡ä¸»é”®è·å–èµ„æº |
| createResource | åˆ›å»ºä¸€ä¸ªèµ„æº |
| updateResource | æ›´æ–°ä¸€ä¸ªèµ„æº |
| getIngressesByProjectId | è·å–å•ä¸ªäº§å“ä¸‹ç°åº¦ç­–ç•¥ä»»åŠ¡åˆ—è¡¨ |
| getIngressById | é€šè¿‡ä¸»é”®è·å–å•ä¸ªç°åº¦ç­–ç•¥ä»»åŠ¡è¯¦æƒ… |
| createIngress | åˆ›å»ºä¸€ä¸ªç­–ç•¥ |
| updateIngress | æ›´æ–°ä¸€ä¸ªç­–ç•¥ |

å‰©ä½™çš„æ¥å£æœ‰ç”¨æˆ·å¤„ç†çš„ï¼Œæœ‰å­é¡¹ç›®ç®¡ç†çš„ï¼Œè¿™é‡Œä¸åšè¯¦è¿°ã€‚é™¤äº†ä¸Šè¾¹çš„å¿…é¡»çš„æ¥å£å¤–ï¼Œè¿˜æœ‰ä¸€ä¸ªæœ€é‡è¦çš„æ¥å£ï¼Œé‚£å°±æ˜¯è·å–å½“å‰ç™»å½•ç”¨æˆ·éœ€è¦çš„èµ„æºç‰ˆæœ¬çš„æ¥å£ã€‚åœ¨ç”¨æˆ·è®¿é—®æ—¶ï¼Œéœ€è¦é¦–å…ˆè°ƒç”¨ç°åº¦ç³»ç»Ÿçš„è¿™ä¸ªæ¥å£æ¥è·å–èµ„æºåœ°å€ï¼Œç„¶åæ‰èƒ½é‡å®šå‘åˆ°ç»™è¯¥ç”¨æˆ·çœ‹çš„é¡µé¢ä¸­å»ï¼š

| åç§° | æè¿° | æ¥æ”¶å‚æ•° | è¾“å‡º |
| --- | --- | --- | --- |
| getConsoleVersion | è·å–å½“å‰ç”¨çš„äº§å“ç‰ˆæœ¬ | userIdï¼Œproducts | resourceé”®å€¼å¯¹åˆ—è¡¨ |

`getConsoleVersion` æ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯å½“å‰ç™»å½•çš„ç”¨æˆ· IDï¼Œ ä¸€ä¸ªæ˜¯å½“å‰ç”¨æˆ·è®¿é—®çš„å¾®æœåŠ¡ç³»ç»Ÿä¸­æ‰€åŒ…å«çš„äº§å“åˆ—è¡¨ã€‚è¯¥æ¥å£åšäº†å¦‚ä¸‹å‡ æ­¥æ“ä½œï¼š

1. éå† productsï¼Œè·å–æ¯ä¸€ä¸ªäº§å“çš„ projectId
2. å¯¹äºæ¯ä¸€ä¸ª projectIdï¼Œè”æŸ¥èµ„æºè¡¨ï¼Œåˆ†åˆ«è·å–å¯¹åº”çš„ resourceId
3. å¯¹äºæ¯ä¸€ä¸ªresourceIdï¼Œç»“åˆ userIdï¼Œå¹¶è”æŸ¥ç°åº¦ç­–ç•¥è¡¨ï¼Œç­›é€‰å‡ºèµ·ä½œç”¨çš„ç°åº¦ç­–ç•¥ä¸­å¯ç”¨çš„èµ„æº
4. è¿”å›æ¯ä¸€ä¸ªèµ„æºçš„ data ä¿¡æ¯ã€‚

å…¶ä¸­ç¬¬ä¸‰æ­¥å¤„ç†ç›¸å¯¹ç¹çä¸€äº›ï¼Œæ¯”å¦‚è¯´ï¼Œä¸€ä¸ªèµ„æºæœ‰ä¸¤ä¸ªèµ·ä½œç”¨çš„ç°åº¦èµ„æºï¼Œä¸€ä¸ªæ˜¯å¢é‡çš„ï¼Œä¸€ä¸ªæ˜¯å…¨é‡çš„ï¼Œè¿™é‡Œåº”è¯¥æ‹¿å¢é‡çš„ç‰ˆæœ¬ï¼Œå› ä¸ºä»–ä¼˜å…ˆçº§æ›´é«˜ã€‚


è·å–ç”¨æˆ·ç‰ˆæœ¬çš„æµç¨‹å›¾å¦‚ä¸‹ï¼š


```mermaid
graph TD
ç”¨æˆ·ç™»å½•é¡µé¢ --> è·å–æ‰€æœ‰äº§å“ä¸‹çš„èµ„æºåˆ—è¡¨
è·å–æ‰€æœ‰äº§å“ä¸‹çš„èµ„æºåˆ—è¡¨ --> æ ¹æ®ç°åº¦ç­–ç•¥ç­›é€‰èµ„æºä¸­è¯¥ç”¨æˆ·å¯ç”¨çš„éƒ¨åˆ† --> è¿”å›äº§å“ç»´åº¦çš„èµ„æºå¯¹è±¡
```

![](/img/posts/2023-3-19/2023-3-19-9.png)

æœ€åè¿”å›çš„èµ„æºå¤§æ¦‚é•¿è¿™ä¸ªæ ·å­ï¼š

```js
interface VersionResponse {
    [productId: number]: ResourceVersion;
}

interface ResourceVersion {
    files: string[];
    config: ResourceConfig;
    dependencies: string[];
}
```

å…¶ä¸­ files å°±æ˜¯ JSON è§£æåçš„ä¸Šè¿° data ä¿¡æ¯çš„æ–‡ä»¶åˆ—è¡¨ï¼Œå› ä¸ºæ‰“åŒ…åçš„æ–‡ä»¶å¾€å¾€æœ‰ csså’Œå¤šä¸ªjsã€‚

è‡³äºè¿™ä¸ªåç«¯ä½¿ç”¨ä»€ä¹ˆè¯­è¨€ï¼Œä»€ä¹ˆæ¡†æ¶æ¥å†™ï¼Œå¹¶ä¸é‡è¦ï¼Œé‡è¦çš„æ˜¯ä¸€å®šè¦ç¨³å®šï¼Œä»–è¦æŒ‚æ‰äº†ï¼Œç”¨æˆ·å°±è¿›ä¸å»ç³»ç»Ÿäº†ï¼Œå®¹ç¾å’Œå®¹é”™è¦åšå¥½ï¼›å¦‚æœæ˜¯ä¸ªå®¢æˆ·æ¯”è¾ƒå¤šçš„ç½‘ç«™ï¼Œå¹¶å‘åˆ†æµä¹Ÿè¦è€ƒè™‘è¿›å»ã€‚

## 5. å‰ç«¯é¡µé¢å±•ç¤º

å‰ç«¯é¡µé¢å°±éšä¾¿ä½¿ç”¨äº†ä¸€ä¸ªå‰ç«¯æ¡†æ¶æ­äº†ä¸€ä¸‹ï¼Œé€‰å‹ä¸æ˜¯é‡ç‚¹ï¼Œç»„ä»¶åº“èƒ½å¤Ÿæ»¡è¶³è¦æ±‚å°±è¡Œï¼š

- ç™»å½•

![image.png](/img/posts/2023-3-19/2023-3-19-10.png)

- æŸ¥çœ‹èµ„æº


![image.png](/img/posts/2023-3-19/2023-3-19-11.png)

- é…ç½®ç­–ç•¥


![image.png](/img/posts/2023-3-19/2023-3-19-12.png)


![image.png](/img/posts/2023-3-19/2023-3-19-13.png)

---

éƒ¨ç½²ä»¥åï¼Œå®é™…è¿è¡Œé¡¹ç›®çœ‹çœ‹æ•ˆæœï¼š


![image.png](/img/posts/2023-3-19/2023-3-19-14.png)

å¯ä»¥çœ‹åˆ°ï¼Œåœ¨è°ƒç”¨ä¸šåŠ¡æ¥å£ä¹‹å‰ï¼Œä¼˜å…ˆè°ƒç”¨äº† getConsoleVersionæ¥è·å–ç‰ˆæœ¬ï¼Œå…¶è¿”å›å€¼æ˜¯ä»¥äº§å“ä¸º key çš„é”®å€¼å¯¹ï¼š


![image.png](/img/posts/2023-3-19/2023-3-19-15.png)

## 6. è®¿é—®è½¬å‘

è¿™é‡Œæ‹¿åˆ°éƒ¨ç½²ä¿¡æ¯åï¼ŒæœåŠ¡å™¨è¦è¿›è¡Œä¸‹ä¸€æ­¥å¤„ç†çš„ã€‚æˆ‘è¿™é‡Œæ˜¯æŠŠå®ƒå°è£…åˆ°ä¸€ä¸ªå¯¹è±¡ä¸­ï¼Œå¸¦ç€å‚æ•°ä¼ ç»™äº†å¾®æœåŠ¡çš„ hook å»äº†ï¼ˆå¾®æœåŠ¡ç³»ç»Ÿéœ€è¦ï¼‰ï¼›**å¦‚æœä½ æ˜¯å•é¡µåº”ç”¨ï¼Œå¯èƒ½éœ€è¦æŠŠå·¥ä½œé‡å¿ƒæ”¾åœ¨ Nginx çš„è½¬å‘ä¸Šï¼ŒNginxå†…éƒ¨æœåŠ¡è¯»å–ç°åº¦ç³»ç»Ÿæ•°æ®åº“æ¥æ‹¿åˆ°ç‰ˆæœ¬ç›®å½•ï¼Œç„¶ååˆ‡æ¢è·¯ç”±è½¬å‘ï¼ˆå¯èƒ½åªæ˜¯æ”¹å˜ä¸€ä¸ªè·¯ç”±å˜é‡ï¼‰ã€‚** ï¼ˆä½ ä¹Ÿå¯ä»¥å‚ç…§æˆ‘ [nginx ç›¸å…³æ–‡ç« ](https://juejin.cn/post/7211702508371656759)ï¼‰ï¼Œä¸‹é¢æˆ‘ç®€å•çš„ç»™ä¸ªç¤ºæ„å›¾ï¼š


```mermaid
graph TD
ç°åº¦ç³»ç»Ÿé…ç½®ç°åº¦ç­–ç•¥ --> Nginx+Lua+Mysqlè·å–ç°åº¦ç­–ç•¥å¹¶å†™å…¥Nginxå˜é‡
Nginx+Lua+Mysqlè·å–ç°åº¦ç­–ç•¥å¹¶å†™å…¥Nginxå˜é‡ --> NginxæœåŠ¡å™¨é…ç½®èµ„æºè½¬å‘
```

![](/img/posts/2023-3-19/2023-3-19-16.png)

## 7. æ€»ç»“

å‰ç«¯ç°åº¦ç³»ç»Ÿï¼Œå…¶å®å°±æ˜¯ä¸€ä¸ªåå°ç®¡ç†ç³»ç»Ÿã€‚ä»–é…ç½®å’Œç®¡ç†äº†ä¸åŒç‰ˆæœ¬çš„å‰ç«¯éƒ¨ç½²èµ„æºå’Œå¯¹åº”çš„ç”¨æˆ·ç­–ç•¥ï¼Œåœ¨éœ€è¦çš„æ—¶å€™è¿›è¡Œé…ç½®ã€‚

æ¥ä¸‹æ¥çš„æ–‡ç« æˆ‘ä¼šé…å¥—æ€§çš„è®²ä¸€ä¸‹ `Nginx` å’Œ `Docker` çš„å‰ç«¯å…¥é—¨ä½¿ç”¨ï¼Œæ•¬è¯·æœŸå¾…ï¼

å®Œï¼å¤§å®¶å¯¹ç°åº¦ç³»ç»Ÿæœ‰ä»€ä¹ˆå¥½çš„å»ºè®®ï¼Œå¯ä»¥åœ¨è¯„è®ºåŒºè®¨è®ºå“¦ï¼

---25:T4612,å¯¹äºä¸€ä¸ªå‰ç«¯å¼€å‘ï¼Œè™½ç„¶æœåŠ¡å™¨å¼€å‘éƒ¨ç½²ä¸æ˜¯ä¸»è¦ä¸šåŠ¡ï¼Œä½†æ˜¯ï¼Œç‹¬ç«‹å¼€å‘å‰ç«¯é¡¹ç›®æ€»å½’æ˜¯æŒ‚è½½åœ¨æœåŠ¡å™¨ä¸Šæ‰èƒ½è·‘èµ·æ¥çš„ï¼Œä¸èƒ½æ€»æŒ‡æœ›è¿ç»´æ¥åšè¿™ä¸ªå·¥ä½œã€‚è€Œä¸”ï¼Œä½œä¸ºä¸€ä¸ªç¨‹åºå‘˜ï¼Œä¸å¯èƒ½å¯¹é¡¹ç›®éƒ¨ç½²ä¸€ç‚¹éƒ½ä¸äº†è§£ã€‚

æœ¬æ–‡å°±è®²ä¸€ä¸‹ä½œä¸ºä¸€ä¸ªå‰ç«¯å¼€å‘åº”è¯¥è¦æŒæ¡çš„åŸºæœ¬çš„ nginx æœåŠ¡.

> å…³äº nginx ä¸ CI é…åˆçš„ä½¿ç”¨ï¼Œè§æˆ‘çš„æ–‡ç« ï¼šhttps://juejin.cn/post/7183517146729693221

## 1. æ¦‚å¿µ

- æ­£å‘ä»£ç†

ç‰¹ç‚¹ï¼šç”¨æˆ·ä¸»åŠ¨å»è”ç³»åˆ†å‘è®¾å¤‡ï¼Œåˆ†å‘è®¾å¤‡æ¥åˆ¤æ–­åˆ†å‘çš„ç›®æ ‡æœåŠ¡å™¨ã€‚æ­¤æ—¶ï¼Œ**ç”¨æˆ·å¯¹äºæœåŠ¡å™¨æœªçŸ¥**ã€‚

è·¯ç”±å™¨æ˜¯æ­£å‘ä»£ç†çš„ä¸€ä¸ªä¾‹å­ï¼Œä¸ç”¨æˆ·åœ¨ä¸€ä¾§ï¼Œæœ‰æœ€å¤§å¸¦å®½é™åˆ¶ã€‚

![image.png](/img/posts/2023-3-18/2023-3-18-1.png)

- åå‘ä»£ç†

åå‘ä»£ç†ä¸€èˆ¬æ˜¯éƒ¨ç½²åœ¨æœåŠ¡ä¾§çš„ï¼Œçµæ´»å¾ˆå¤šï¼Œå¯ä»¥åšè´Ÿè½½åˆ†æµå’Œæ‰©å±•åŠŸèƒ½ç­‰ã€‚ä½†æ˜¯å¯¹äºç”¨æˆ·è€Œè¨€ï¼Œåå‘ä»£ç†æœåŠ¡å™¨å°±ç›¸å½“äºç›®æ ‡æœåŠ¡å™¨ï¼Œå³ç”¨æˆ·ç›´æ¥è®¿é—®åå‘ä»£ç†æœåŠ¡å™¨å°±å¯ä»¥è·å¾—ç›®æ ‡æœåŠ¡å™¨çš„èµ„æºã€‚æ­¤æ—¶ï¼Œ**æœåŠ¡å™¨å¯¹äºç”¨æˆ·æœªçŸ¥**ï¼Œæé«˜äº†å®‰å…¨æ€§ã€‚

![image.png](/img/posts/2023-3-18/2023-3-18-2.png)

nginx ä¾¿æ˜¯é«˜æ€§èƒ½çš„ HTTP å’Œåå‘ä»£ç† web æœåŠ¡å™¨

ä¸€ä¸ªnginxçš„ä½¿ç”¨ä¾‹å­å°±æ˜¯è™šæ‹Ÿä¸»æœºï¼šå¤šä¸ªåŸŸåç»‘å®šä¸€ä¸ªä¸»æœºï¼Œç”± nginx è½¬å‘ä¸åŒçš„èµ„æºã€‚

## 2. å®‰è£…ä¸éƒ¨ç½²å‰ç«¯åº”ç”¨

- å¹³å°ï¼šCentOS7 è™šæ‹Ÿæœº
- å®‰è£…ç‰ˆæœ¬ï¼šç›®å‰æœ€æ–° 1.21.6
- ä¸‹è½½åœ°å€ï¼š[nginx å®˜ç½‘](https://nginx.p2hp.com/en/download.html)


å®‰è£…åŒ…è§£å‹åè¿›å…¥ç›®å½•

![image.png](/img/posts/2023-3-18/2023-3-18-3.png)

å®‰è£…ä¾èµ–

```
yum install -y gcc
yum install -y pcre-devel
yum install -y zlib zlib-devel
```

å¼€å§‹å®‰è£… (å®‰è£…ç›®å½•/usr/local/nginx)

```sh
./configure --prefix=/usr/local/nginx

make

make install
```

å®‰è£…æˆåŠŸï¼ŒæŸ¥çœ‹å®‰è£…ç›®å½•


![image.png](/img/posts/2023-3-18/2023-3-18-4.png)

æµ‹è¯•è¿è¡Œ

æ‰§è¡Œ `./sbin/nginx` (ä¹Ÿå¯ä»¥ä½¿ç”¨å…¨å±€ nginx å‘½ä»¤)

![image.png](/img/posts/2023-3-18/2023-3-18-5.png)

å¯ä»¥çœ‹åˆ°è¿›ç¨‹å·²ç»å¯åŠ¨

```
ps -ef | grep nginx
```

![image.png](/img/posts/2023-3-18/2023-3-18-6.png)

ä¸ºäº†æµ‹è¯•ï¼Œå…ˆå…³é—­é˜²ç«å¢™ï¼š

```
systemctl stop firewalld.service
```

æ­£å¼çº¿ä¸Šä½¿ç”¨çš„ï¼Œå¯ä»¥é…ç½®é˜²ç«å¢™æ”¾è¡Œç«¯å£ã€‚

é…ç½® nginx é…ç½®æ–‡ä»¶ï¼š

```
vim ./conf/nginx.conf
```

![image.png](/img/posts/2023-3-18/2023-3-18-7.png)

å…¶ä¸­ location æ ¹ç›®å½•ä½ç½®æ˜¯å·²ç» build å¥½çš„ä¸€ä¸ª vue åº”ç”¨ï¼š

![image.png](/img/posts/2023-3-18/2023-3-18-8.png)

é‡å¯

```
nginx -s reload
```

æµè§ˆå™¨æŸ¥çœ‹ ï¼ˆä½¿ç”¨ ip addr æŒ‡ä»¤å¯ä»¥æŸ¥çœ‹ipï¼‰

![image.png](/img/posts/2023-3-18/2023-3-18-9.png)

---
> ä¸Šè¿°åœ¨ä¹‹å‰çš„æ–‡ç« ä¸­ä¹Ÿæœ‰æ‰€æåŠï¼Œç›¸é¢æ›´æ·±å…¥çš„è®²ä¸€ä¸‹é…ç½®æ–‡ä»¶çš„ä½¿ç”¨
---

## 3. é…ç½®æ–‡ä»¶æœ€å°é›†

é…ç½®æ–‡ä»¶æœ€å°é›†æ˜¯ä¸€ä¸ªèƒ½å¤Ÿæ”¯æ’‘ nginx æ­£å¸¸è·‘èµ·æ¥çš„æœ€å°çš„é…ç½®é¡¹é›†åˆï¼Œè¿æ³¨é‡Šä¸€å¹¶å†™åœ¨ä¸‹é¢ï¼Œä¾›å¤§å®¶å‚è€ƒï¼š

```json
// ./conf/nginx.conf
worker_process 1; // å¹¶è¡Œæ‰§è¡Œçš„ä»»åŠ¡æ•°ï¼Œä¸€èˆ¬æŒ‰ç…§CPUå†…æ ¸é…ç½®
events: {
    worker_connections 1024; // é…ç½®å•ä¸ªworkerè¿›ç¨‹æœ€å¤§çš„è¿æ¥æ•°ï¼Œnginx é»˜è®¤è¿æ¥æ•°æ˜¯1024
}

http { // æ”¯æŒ http åè®®è®¿é—®çš„æœåŠ¡
    include      mime.types; // å½“å‰ç›®å½•ä¸‹çš„é…ç½®çš„æ–‡ä»¶ç±»å‹æ–‡ä»¶ï¼Œä½¿ç”¨é»˜è®¤å³å¯ã€‚å›¾ç‰‡éŸ³é¢‘ä¼šè‡ªåŠ¨è§£æç»™æµè§ˆå™¨ï¼Œä¸èƒ½è§£æçš„ä¸€å¾‹æŒ‰ç…§äºŒè¿›åˆ¶æµä¸‹è½½
    default_type  application/octet-stream; // é»˜è®¤æ–‡ä»¶ç±»å‹ äºŒè¿›åˆ¶æµä¸‹è½½
    sendfile        on;  // æ˜¯å¦å…è®¸ç›®æ ‡æœåŠ¡å™¨ç»•è¿‡ nginx æœåŠ¡å™¨ç›´æ¥è¿”å›ç»“æœç»™ç”¨æˆ·
    keepalive_timeout  65;  // è¶…æ—¶æ—¶é—´
    
    server { // éš¶å±äº http çš„ä¸€ä¸ª æœåŠ¡å™¨
        listen       10087;  // ç«¯å£
        server_name  localhost;  // æœåŠ¡éƒ¨ç½²çš„ipåœ°å€ï¼Œå¯ä»¥æ˜¯åŸŸå
        charset utf-8;
        location / {  // é…ç½® uri
	    root   /root/web/dist;  // è‡ªå®šä¹‰çš„èµ„æºç›®å½•ï¼Œå¯ä»¥æ˜¯ç»å¯¹ç›®å½•ï¼›è‹¥å‰è¾¹ä¸åŠ  /, åˆ™è¡¨ç¤ºç›¸å¯¹ç›®å½•ï¼Œç›¸å¯¹çš„æ˜¯ nginx ä¸»ç›®å½•
            index  index.html index.htm;
        }

        error_page  404             404.html;  // 404é¡µé¢é…ç½®ï¼Œç›¸å¯¹è·¯ç”±
        error_page   500 502 503 504   50x.html; // åŒä¸Š
        location = /50x.html {
            root   html;  // 50x æ—¶ï¼Œèµ„æºæŒ‡å‘ htmlç›®å½•ä¸‹å¯»æ‰¾
        }
        location = /404.html {
            root   html;  // åŒä¸Š
        }
    } // end server
} // end http
```

## 4. å¤šç«™ç‚¹é…ç½®

å‡è®¾æˆ‘ä»¬æœ‰ä¸¤ä¸ªèµ„æºç›®å½•ï¼Œä½ å¯ä»¥ç†è§£ä¸ºä¸¤ä¸ªé¡¹ç›®çš„ build ç›®å½•ï¼š

```
/root/web/vue/dist
/root/web/react/dist
```

æˆ‘ä»¬é€šè¿‡é…ç½®æ–‡ä»¶æ¥æ§åˆ¶ä¸åŒçš„è®¿é—® url åˆ†åˆ«åˆ†å‘ç»™è¿™ä¸¤ä¸ªèµ„æºã€‚

```json
server {
    listen       80;  
    server_name  www.vue.com;  
    location / {  
        root   /root/web/vue/dist; 
        index  index.html index.htm;
    }
}

server {
    listen       8080;  
    server_name  www.react.com;  
    location / {  
        root   /root/web/react/dist; 
        index  index.html index.htm;
    }
}
```

è¿™æ ·ï¼Œè®¿é—® www.vue.com å°±ä¼šè¿›å…¥ vue çš„é¡¹ç›®ï¼Œè®¿é—® www.react.com:8080 ä¼šè¿›å…¥ react çš„é¡¹ç›®ã€‚

æ³¨æ„ï¼šhttps çš„åŸŸåéœ€è¦åœ¨äº‘ç«¯é…ç½® ip ç»‘å®šä¸º nginx çš„æœåŠ¡å™¨ã€‚

## 5. server_name åŒ¹é…

server_name æ”¯æŒæ¨¡ç³ŠåŒ¹é…å’Œé€šé…ç¬¦åŒ¹é…ã€‚

- é€šé…ç¬¦ï¼š *.xxx.com ã€www.baidu.*

æ‰€æœ‰ .xxx.com ç»“å°¾çš„éƒ½å¯ä»¥åŒ¹é…åˆ°

- å®Œå…¨åŒ¹é…ï¼šwww.react.com
- æ­£åˆ™åŒ¹é…ï¼š~^[0-9]+\.xxx\.com$ (è§„åˆ™ï¼š~å¼€å¤´)


åŒ¹é…ä¼˜å…ˆçº§ï¼š

1. å®Œå…¨åŒ¹é…
2. é€šé…ç¬¦åœ¨å‰çš„
3. é€šé…ç¬¦åœ¨åçš„
4. æ­£åˆ™åŒ¹é…

å¦‚æœéƒ½ä¸åŒ¹é…

1. ä¼˜å…ˆé€‰æ‹©listené…ç½®é¡¹åæœ‰ default æˆ– default_server çš„
2. ä¸Šè¿°éƒ½ä¸æ»¡è¶³ï¼Œåˆ™å»æ‰¾ç«¯å£é…ç½®çš„ä½ç½®æœ€é å‰çš„server

## 6. è´Ÿè½½å‡è¡¡é…ç½®

ä½¿ç”¨åœºæ™¯ï¼šè®¿é—®åŒä¸€ä¸ªåŸŸåï¼Œä½†æ˜¯ç›®æ ‡åœ°å€å¯ä»¥æ˜¯å¤šä¸ªï¼Œæ ¹æ®ä½¿ç”¨æƒ…å†µå’Œç©ºé—²ç¨‹åº¦è‡ªåŠ¨åˆ†é…ä¸€ä¸ªä½¿ç”¨ã€‚upstream ç”¨äºè®¾ç½®å¤šå°åˆ†å‘ä¸»æœºçš„é›†åˆã€‚

```json
http {
    ...
    upstream my_server {
        server 10.123.345.456:8000;
        server 10.123.345.457:8000;
    }

    server {
        location / {
            proxy_pass http://my_server;
        }
    }
}

```

è¿™æ ·é…ç½®åï¼Œå®é™…è®¿é—® http://192.168.122.1 è®¿é—®æ—¶ï¼Œç³»ç»Ÿä¼šåœ¨ 456 å’Œ 457 ä¸¤ä¸ª ipæœåŠ¡é€‰æ‹©ä¸€ä¸ªåˆ†å‘ï¼Œé›¨éœ²å‡æ²¾ã€‚

å½“ç„¶ä½ ä¹Ÿå¯ä»¥é…ç½®ä¸¤ä¸ªæœåŠ¡å™¨çš„è½®è¯¢æƒé‡(è®¿é—®æ¦‚ç‡)ã€‚

```json
server 10.123.345.456:8000 weight=8;
server 10.123.345.457:8000 weight=1;
server 10.123.345.457:8000 backup;  // æ ‡è¯†å¤‡ç”¨æœºï¼Œå®åœ¨æ˜¯æ²¡æœ‰å¯ç”¨çš„æœºå™¨æ—¶å¯ç”¨
```

å¦‚æœæƒ³è¦æŸä¸€ä¸ªæœåŠ¡å™¨ä¸å‚ä¸è´Ÿè½½å‡è¡¡ï¼Œå¯ä»¥å¦‚ä¸‹é…ç½®ï¼š

```json
server 10.123.345.456:8000 down;
```

## 7. é…ç½®åŠ¨é™åˆ†ç¦»

é€‚åˆå°ä¸­å‹ç½‘ç«™ï¼Œé™æ€èµ„æºä¸å¤ªå¤šçš„åœºæ™¯ã€‚åŸç†æ˜¯ç”¨æˆ·è¯·æ±‚é¡µé¢æ—¶ï¼Œæå–å‡ºé™æ€èµ„æºï¼Œç­‰ä¸‹æ¬¡ç”¨æˆ·è®¿é—®ç›¸åŒé¡µé¢æ—¶ï¼Œé™æ€èµ„æºå¯ä»¥ä¸ç”¨å†æ¬¡æ‰¾æœåŠ¡å™¨è·å–ï¼Œè€Œæ˜¯å–ç¼“å­˜çš„å†…å®¹ã€‚

é…ç½®å¦‚ä¸‹ï¼š


```json
http {
    ...
    upstream my_server {
        server 10.123.345.456:8000;
        server 10.123.345.457:8000;
    }

    server {
        location / {
            proxy_pass http://my_server;
        }
        
        location ~.*\.(js|png|jpg|svg|css)$ {  // é™æ€èµ„æº
            root   html;
            index  index.html index.htm;
        }
    }
}
```

## 8. é…ç½® URLRewrite

ç”¨äºéšè—æœåŠ¡å™¨çœŸå®urlè·¯å¾„ã€‚

```js
http {
    ...
    upstream my_server {
        server 10.123.345.456:8000;
        server 10.123.345.457:8000;
    }

    server {
        location / {
            rewrite ^/([0-9]+).html$ /index/pageNum=$1 break;
            proxy_pass http://my_server;
        }
        
    }
}
```

ä¸Šè¾¹å°±ä½¿ç”¨äº†ä¸€ä¸ª rewrite æ¥é…ç½®äº†è½¬å‘ã€‚

è¿™ä¸ªä¾‹å­éšè—äº†é¡µé¢çš„åˆ†é¡µä¿¡æ¯ï¼šè®¿é—® /2.html å°±ç›¸å½“äºè®¿é—®äº† /index/pageNum=2 è·¯å¾„ã€‚

åŒ¹é…å…³é”®å­—ï¼š

- breakï¼šåœæ­¢æ‰€æœ‰rewriteåŒ¹é…
- lastï¼šæœ¬æ¡åŒ¹é…å®Œæˆåï¼Œç»§ç»­å‘ååŒ¹é…å…¶ä»–çš„ location çš„ rewrite
- redirectï¼šè¿”å› 302 é‡å®šå‘åˆ°çœŸå®åœ°å€ï¼Œè€Œä¸æ˜¯ç”¨å‡åœ°å€
- permanentï¼š301 æ°¸ä¹…é‡å®šå‘åˆ°çœŸå®åœ°å€ ï¼ˆé€‚ç”¨äºçˆ¬è™«ï¼‰

## 9. é…ç½®é˜²ç›—é“¾

ç›—é“¾ï¼ˆHotlinkingï¼‰æ˜¯æŒ‡åœ¨ä¸€ä¸ªç½‘ç«™ä¸Šï¼Œä½¿ç”¨åˆ«äººç½‘ç«™ä¸Šçš„å›¾ç‰‡æˆ–å…¶ä»–åª’ä½“èµ„æºæ¥è£…é¥°è‡ªå·±çš„ç½‘ç«™ï¼Œè€Œä¸è·å¾—è¯¥èµ„æºçš„æ‰€æœ‰è€…è®¸å¯çš„è¡Œä¸ºã€‚ç›—é“¾å¯ä»¥å¯¼è‡´è¢«ç›—ç”¨è€…çš„å¸¦å®½å’Œæµé‡å—åˆ°æ¶ˆè€—ï¼Œç”šè‡³å¯èƒ½ä½¿å…¶ç½‘ç«™é€Ÿåº¦å˜æ…¢æˆ–å´©æºƒã€‚

é˜²ç›—é“¾ä¹Ÿæ˜¯èµ„æºèŠ‚çœä¼˜åŒ–çš„å¿…å¤‡é…ç½®ã€‚nginx ä¸­æ ¹æ® http è¯·æ±‚å¤´çš„ referer åˆ¤æ–­æ¥æºå¯ä»¥åšåˆ°æ‹¦æˆªã€‚

ä¸€ä¸ªé…ç½®é˜²ç›—é“¾çš„ä¾‹å­å¦‚ä¸‹ï¼š

```json
location ~* \.(jpg|jpeg|png|gif)$ {
    valid_referers none blocked xxx.com;
    if ($invalid_referer) {
        return 403;
    }
}
```

ä»¥ä¸Šä»£ç è¡¨ç¤ºï¼Œå¦‚æœè®¿é—®çš„å›¾ç‰‡URLçš„`referer`ä¸æ˜¯ xxx.comï¼Œåˆ™è¿”å› 403 ç¦æ­¢è®¿é—®ã€‚å¦‚æœè®¿é—®çš„URLæ²¡æœ‰refererï¼Œåˆ™ä¹Ÿä¼šè¢«ç¦æ­¢è®¿é—®ã€‚

é…ç½®é¡¹ä»‹ç»ï¼š

- noneï¼šrefererä¸å­˜åœ¨æ—¶å¯ä»¥è®¿é—®ï¼Œä¸è®¾ç½®åˆ™æ‰€æœ‰è®¿é—®ä¸æ˜¯ xxx.com éƒ½ç¦æ­¢
- blockedï¼šrefererå€¼è¢«é˜²ç«å¢™æˆ–è€…ä»£ç†æœåŠ¡å™¨åˆ é™¤æˆ–ä¼ªè£…æ—¶å¯ä»¥è®¿é—®ã€‚ä¸€èˆ¬æ˜¯ä¸å¸¦ http å‰ç¼€çš„è®¿é—®æ”¾è¡Œé…ç½®ã€‚

æ¥ä¸‹æ¥é…ç½®é”™è¯¯æç¤ºé¡µé¢ï¼š

å‡è®¾æœ‰ä¸ªé¡µé¢ ï¼š `403.html`, éœ€è¦é…ç½®ç¦æ­¢è®¿é—®æ—¶æ˜¾ç¤ºï¼š

```json
error_page 403 /403.html
location = /403.html {
    root   html;  // èµ„æºæŒ‡å‘ htmlç›®å½•ä¸‹å¯»æ‰¾
}
```

æˆ–è€…åœ¨ return 403 æ—¶è®¾ç½®ï¼š`rewrite` åˆ°ä¸€ä¸ªé…ç½®å¥½çš„èµ„æºä¹Ÿå¯ä»¥ã€‚

## 10. å®‰å…¨é«˜å¯ç”¨æ–¹æ¡ˆé…ç½®

å®‰å…¨é«˜å¯ç”¨çš„æ„ä¹‰ï¼šåœ¨ä¸é¢å¤–æ·»åŠ æœºå™¨çš„æƒ…å†µä¸‹åšåˆ°ä¸downæœºåŠ¨æ€åˆ‡æ¢æœºå™¨ï¼Œä»è€Œè¾¾åˆ°æœåŠ¡æŒç»­å¯ç”¨ 

### keepalived

å®‰è£…

```sh
yum install keepalived
```

ç¼–è¾‘é…ç½®ï¼ˆ/etc/keepalived.confï¼‰:

```json
global_defs {
    router_id lb111
}

vrrp_instance_test {  // è‡ªå®šä¹‰ test å®ä¾‹
    state MASTER   // ä¸»
    interface eth01  // ä½ æœºå™¨ä¸Šç½‘å¡çš„åå­—
    virtual_router_id 33  // è™šæ‹Ÿè·¯ç”±idï¼Œä¸»ä»è¦ä¸€æ ·
    priority 100 // ä¼˜å…ˆçº§é«˜çš„æœºå™¨å°±ä¸º master
    advert_int 1 // é—´éš”æ£€æµ‹æ—¶é—´
    authentication {  // è®¤è¯é…ç½®ï¼ŒåŒä¸€ç»„ä¿æŒä¸€è‡´å³å¯
        auth_type PASS  
        auth_pass 1111  
    }
    virtual_ipaddress {
        192.168.44.1  // æœ¬å°æœºå™¨çš„è™šæ‹Ÿåœ°å€
    }
}
```

ä¸Šé¢æ˜¯ç¬¬ä¸€å°æœºå™¨çš„é…ç½®ï¼Œåœ¨ç¬¬äºŒå°è™šæ‹Ÿæœºä¸Šä¹Ÿé…ç½®ä¸€ä¸‹ç±»ä¼¼çš„é…ç½®ï¼Œè®¾ç½®ï¼š

```json
global_defs {
    router_id lb110  // ä¿®æ”¹è·¯ç”±å·
}

vrrp_instance_test {  // åŒä¸€ä¸ªå®ä¾‹
    state BACKUP   // ä»
    interface eth01  
    virtual_router_id 33
    priority 50 // å‡ä½ä¼˜å…ˆçº§
    advert_int 1
    authentication { 
        auth_type PASS  
        auth_pass 1111  
    }
    virtual_ipaddress {
        192.168.44.1  // æœ¬å°æœºå™¨çš„è™šæ‹Ÿåœ°å€
    }
}
```

ä¸¤å°æœºå™¨åˆ†åˆ«å¯åŠ¨ä¸€ä¸‹ï¼š

```
systemctl start keepalived
```

æ­¤æ—¶åœ¨å¤–ç½‘å¯ä»¥pingé€šçš„ipæ˜¯ï¼š 192.168.44.1ã€‚

æˆ‘ä»¬è®© MASTER æœºå™¨å…³æœºåï¼Œå†pingä¸€ä¸‹ 192.168.44.1ï¼Œå‘ç°ä»ç„¶å¯ä»¥ï¼Œæ­¤æ—¶åœ¨å¤‡ä»½åŠä½¿ç”¨æŒ‡ä»¤ `ip addr` æŸ¥çœ‹ï¼Œå¯ä»¥çœ‹åˆ° æœ‰ä¸€ä¸ª 192.168.44.1 çš„è™šæ‹Ÿipã€‚è¿™è¯´æ˜é«˜å¯ç”¨ç”Ÿæ•ˆäº†ï¼Œè¿™ç§é…ç½®å« ipæ¼‚ç§»ã€‚

ä¸Šè¿°æƒ…å†µåªèƒ½ä¿è¯ keepalived è¿›ç¨‹æŒ‚æ‰æ—¶èµ·ä½œç”¨ï¼Œæ›´é«˜çº§çš„ç”¨æ³•æ˜¯è·‘ä¸€ä¸ªè„šæœ¬ï¼Œæ£€æµ‹æœ¬æœºçš„ nginz æœåŠ¡è¿›ç¨‹ï¼Œå¦‚æœæœåŠ¡å¼‚å¸¸ï¼Œåˆ™ kill æ‰æœ¬æœºçš„ keepalived è¿›ç¨‹ã€‚


### https ä¸ TLS

http åè®®å¾€å¾€æ˜¯ä¸å®‰å…¨çš„ï¼Œå³ä½¿æœ‰é˜²ç«å¢™ï¼Œä½†æ˜¯æ²¡åŠæ³•é˜²å¾¡æ¶ˆæ¯åœ¨ä¼ è¾“è¿‡ç¨‹ä¸­è¢«åŠ«æŒï¼š

![image.png](/img/posts/2023-3-18/2023-3-18-10.png)

æ­¤æ—¶å°±éœ€è¦å¯¹ä¼ è¾“è¿‡ç¨‹çš„æ¶ˆæ¯è¿›è¡ŒåŠ å¯†ã€‚åŠ å¯†æ–¹å¼æœ‰å¯¹ç§°åŠ å¯†å’Œéå¯¹ç§°åŠ å¯†ã€‚

å¯¹ç§°åŠ å¯†çš„åŠ å¯†å’Œè§£å¯†äº’ä¸ºé€†è¿‡ç¨‹ï¼Œè§„åˆ™æ˜¯å›ºå®šçš„ï¼Œå­˜æ”¾åœ¨æœåŠ¡å™¨ç«¯æˆ–è€…å®¢æˆ·ç«¯ï¼Œè¿™ä¸ªåŠ å¯†ç®—æ³•ä¼ è¾“è¿‡ç¨‹ä¸­ä¹Ÿå®¹æ˜“è¢«è·å–ï¼Œæ‰€ä»¥å¹¶ä¸æ˜¯å¤ªå®‰å…¨ã€‚

- éå¯¹ç§°åŠ å¯†

éå¯¹ç§°åŠ å¯†ä¼šè®¾ç½®ä¸€ä¸ªå…¬é’¥ï¼Œç”¨äºä¼ é€’ï¼›æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯åˆ†åˆ«è®¾ç½®ä¸€ä¸ªç§é’¥ï¼Œè‡ªå·±ä¿å­˜ï¼ŒåŠ å¯†æ­¥éª¤å¦‚ä¸‹ï¼š

1. ç”¨æˆ·é€šè¿‡æœåŠ¡å™¨443ç«¯å£ä¸‹è½½å…¬é’¥ï¼Œå¹¶ä¼ é€’è‡ªå·±çš„å…¬é’¥ç»™æœåŠ¡å™¨ã€‚
2. å†æ¬¡è¯·æ±‚æœåŠ¡å™¨ï¼Œç”¨**æœåŠ¡å…¬é’¥+å¯¹ç§°åŠ å¯†ç®—æ³•**æ¥åŠ å¯†æ˜æ–‡ï¼Œç”Ÿæˆå¯†æ–‡
3. ä¼ é€’å¯†æ–‡ç»™æœåŠ¡å™¨
4. æœåŠ¡ç«¯ç”¨**æœåŠ¡ç§é’¥+åŠ å¯†ç®—æ³•**è§£å¼€å¯†æ–‡ï¼Œå¾—åˆ°æ˜æ–‡
5. ç±»ä¼¼çš„ï¼ŒæœåŠ¡ç«¯æ ¹æ®æ˜æ–‡è¯·æ±‚å’Œç”¨æˆ·ä¼ é€’çš„ç”¨æˆ·å…¬é’¥è¿›è¡Œå“åº”ï¼š**ç”¨æˆ·å…¬é’¥+ç®—æ³•çš„å¯†æ–‡**
6. ç”¨æˆ·ç”¨**ç”¨æˆ·ç§é’¥+ç®—æ³•è§£å¯†**è·å–æ•°æ®

å…¶ä¸­éœ€æ³¨æ„ï¼Œå…¬é’¥åŠ å¯†çš„æ•°æ®å…¬é’¥è‡ªå·±æ˜¯è§£ä¸å¼€çš„ï¼Œè€Œä¸”è¦ä¿è¯éƒ½æ˜¯å…¬é’¥åŠ å¯†ï¼Œç§é’¥è§£å¯†ã€‚

ä½†æ˜¯ï¼Œå¦‚æœæœåŠ¡å™¨è¢«ä¼ªé€ äº†ï¼Œå…¬é’¥æ˜¯åäººç»™çš„ï¼Œé‚£ä½ çš„æ•°æ®åŠ å¯†å†å¥½ä¹Ÿæ²¡ç”¨äº†ï¼Œè¿™å°±æ˜¯ä¸­é—´äººæ”»å‡»ã€‚

- TLS

ä¸ºäº†è§£å†³ä¸­é—´äººæ”»å‡»ï¼Œéœ€è¦å¯¹ä½¿ç”¨è€…è¿›è¡Œèº«ä»½è®¤è¯ï¼Œè¿™å°±å¼•å…¥äº†æ•°å­—è¯ä¹¦ã€‚å¸¸è§çš„æ–¹å¼æ˜¯æ‰¾ä¸€ä¸ªç¬¬ä¸‰æ–¹å…¬è®¤çš„å¥½äººï¼ˆCAï¼‰æ¥é¢å‘è¿™ä¸ªè¯ä¹¦æ¥è®¤è¯å…¬é’¥ã€‚

æœåŠ¡å™¨ä¼šç”³è¯·å…¬é’¥ç»™CAæ¥è·å–è¯ä¹¦ï¼ŒCAåˆ¤æ–­ä½ æ˜¯å¦æœ‰æ‰€è®¤è¯æœºæ„çš„ç®¡ç†æƒé™å’Œæ‹¥æœ‰æƒé™ï¼Œé€šè¿‡åé¢å‘æ•°å­—è¯ä¹¦ï¼ˆCAè‡ªå·±çš„ç§é’¥+åŠ å¯†ç®—æ³•ï¼‰ï¼›æœåŠ¡å™¨æ‹¿åˆ°è¯ä¹¦åï¼Œç»™ç”¨æˆ·ä¼ é€’çš„å°±æ˜¯è¿™ä¸ªè¯ä¹¦äº†ï¼Œç”¨æˆ·ç”¨CAå…¬é’¥è§£å¯†å‡ºæœåŠ¡å™¨å…¬é’¥æ¥ä½¿ç”¨ã€‚

æ­¤æ—¶ï¼Œä¸­é—´äººè·å–ä¸åˆ°CAçš„ç§é’¥ï¼Œæ‰€ä»¥ç”¨æˆ·ç«¯æµè§ˆå™¨å°±ä¸è®¤è¿™ä¸ªä¸­é—´äººï¼Œä»¥æ­¤è¾¾åˆ°é‰´ä¼ªã€‚ç”¨æˆ·åªè¦ä½¿ç”¨çš„æ˜¯æ­£ç‰ˆæ“ä½œç³»ç»Ÿå’Œæ­£è§„æµè§ˆå™¨ï¼Œå°±èƒ½ä¿è¯æ•°å­—è¯ä¹¦çš„è·å–ã€‚è¿™æœŸé—´ä½¿ç”¨äº† TLS ç®—æ³•ç”Ÿæˆäº†ä¸¤ç»„éšæœºæ•°ï¼Œé€šè¿‡éå¯¹ç§°åŠ å¯†ï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯è¾¾æˆä¸€è‡´ï¼Œç”Ÿæˆäº†ä¸€ä¸ªåªæœ‰ä»–ä»¬è‡ªå·±çŸ¥é“çš„å¯¹ç§°åŠ å¯†è§„åˆ™ï¼Œæˆ‘è¿™é‡Œå€Ÿç”¨[bç«™](https://www.bilibili.com/video/BV1KY411x7Jp) æŠ€æœ¯è›‹è€å¸ˆçš„è§£é‡Šå›¾ï¼š


![image.png](/img/posts/2023-3-18/2023-3-18-11.png)

ä¸Šå›¾çš„æ­¥éª¤å¦‚ä¸‹ï¼š

1. æœåŠ¡å™¨ç”Ÿæˆä¸€å¥—ç§é’¥å’Œå…¬é’¥
2. å¯ä»¥å…ˆç”Ÿæˆä¸€ä¸ªéšæœºæ•°1ï¼Œå¹¶ä¼ ç»™æœåŠ¡ç«¯ï¼Œè¯·æ±‚å…¬é’¥
3. æœåŠ¡ç«¯ç”Ÿæˆéšæœºæ•°2ï¼Œå¸¦ä¸Šå…¬é’¥ã€è¯ä¹¦ä¸€èµ·ç»™å®¢æˆ·ç«¯
4. ç°åœ¨å®¢æˆ·ç«¯ã€æœåŠ¡ç«¯ã€é»‘å®¢éƒ½çŸ¥é“äº†å…¬é’¥ã€éšæœºæ•°1å’Œéšæœºæ•°2
5. å®¢æˆ·ç«¯ç”Ÿæˆéšæœºæ•°3ï¼Œç»“åˆå…¬é’¥åŠ å¯†åç»™æœåŠ¡ç«¯ï¼ŒæœåŠ¡ç«¯é€šè¿‡ç§é’¥è§£å¯†åå¾—åˆ°æ˜æ–‡
6. å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯å„è‡ªé€šè¿‡ éšæœºæ•°1/2/3ç”Ÿæˆä¸€ä¸ªä¼šè¯ç§˜é’¥ï¼Œè¿™ä¸ªä¼šè¯ç§˜é’¥å°±æ˜¯å¯¹ç§°åŠ å¯†çš„ç§˜é’¥ï¼Œä¸”ä¸åœ¨ç½‘ç»œä¸Šä¼ é€’ã€‚
7. æ¥ä¸‹æ¥å°±æ˜¯å¯¹ç§°åŠ é€šä¿¡ç¯èŠ‚ï¼Œè€Œé»‘å®¢ç›®å‰åªçŸ¥é“å…¬é’¥ã€éšæœºæ•°1å’Œéšæœºæ•°2ï¼Œæ— æ³•ç ´è§£é€šä¿¡ã€‚


è¿™é‡Œè®²ä¸€ä¸‹ nginx å¦‚ä½•é…ç½® httpsã€‚ä½ éœ€è¦æœ‰ä¸€ä¸ªæœåŠ¡çš„å…¬ç½‘ipï¼ˆå‡è®¾ 123.456.789.111ï¼‰å’Œè´­ä¹°çš„åŸŸåï¼ˆå‡è®¾ www.abc.com ï¼‰å¹¶ç”³è¯·å¥½äº†åŸŸåè§£æå’Œæ•°å­—è¯ä¹¦ï¼ˆ.key å’Œ .pem æ–‡ä»¶ï¼‰:

```json
server {
    listen 443 ssl;
    server_name localhost;  // åŸŸåå·²ç»å’Œipç»‘å®šï¼Œå†™ localhostä¹Ÿæ˜¯èƒ½è§£æçš„
    ssl_certificate xxxx.pem;
    ssl_certificate_key xxxx.key;
    underscores_in_headers on; // å…è®¸è¯·æ±‚å¤´å‡ºç°ä¸‹åˆ’çº¿
    root html;
}
```


## 11. å˜é‡çš„ä½¿ç”¨

è·Ÿå…¶ä»–æŠ€æœ¯çš„é…ç½®æ–‡ä»¶ä¸€æ ·ï¼Œnginx ä¹Ÿèƒ½ä½¿ç”¨å˜é‡ï¼š

```json
location / { 
    set $name "zhangsan"; 
    return 200 "$name"; 
}
```

ä¸Šé¢å°±è®¾ç½®äº†ä¸€ä¸ªå˜é‡å« nameï¼Œå¹¶ä¸”ç›´æ¥è¿”å› 200 çš„è¯·æ±‚ï¼Œåœ¨é¡µé¢ä¸Šæ˜¾ç¤º name çš„å€¼ã€‚å…¶æ ¼å¼æ˜¯ï¼š

```sh
set $å˜é‡å å˜é‡å€¼
```

å½“ç„¶äº†ï¼Œnginx ä¹Ÿè‡ªå¸¦äº†ä¸€äº›å˜é‡ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ï¼Œæ¯”å¦‚ï¼š

- `$request`  å®Œæ•´çš„åŸå§‹çš„è¯·æ±‚è¡Œï¼Œä¾‹å¦‚ï¼šGET /nginx/index?a=1&b=2 HTTP/1.1
- `$request_uri`  å®Œæ•´çš„åŸå§‹è¯·æ±‚URIï¼Œè®¿é—®çš„URLé™¤å»åŸŸå(æˆ–IP)å’Œ port, å¦‚: /nginx/index?a=1&b=2
- `$args` è¯·æ±‚è¡Œä¸­çš„å…¨éƒ¨å‚æ•° ä¾‹å¦‚ï¼ša=1&b=2
- `$remote_addr` å®¢æˆ·ç«¯ipåœ°å€
- `$remote_port` å®¢æˆ·ç«¯ç«¯å£

...

nginx é…ç½®æ–‡ä»¶çš„å˜é‡å¯ä»¥ç»Ÿä¸€è®¾ç½®åœ¨æ–‡ä»¶çš„é¡¶éƒ¨ï¼Œè¿™æ ·åœ¨æ•´ä¸ªæ–‡ä»¶ä¸­éƒ½å¯ä»¥ä½¿ç”¨åŒä¸€ä¸ªå˜é‡ï¼š

```sh
set $my_var "hello";
```

å¼•ç”³ï¼šå˜é‡å€¼çš„è®¡ç®—

```json
location / { 
    set $my_var 10; 
    add_header X-Test $my_var; // æˆåŠŸå“åº”æ—¶ï¼Œæ·»åŠ å“åº”å¤´
    add_header X-Total $my_var*2; 
}
```
ä¸Šé¢çš„ä¾‹å­å°±æ˜¯å˜é‡ç®€å•çš„æ•°å€¼è®¡ç®—ã€‚


## 12. ä¸šåŠ¡åœºæ™¯æ¡ˆä¾‹

### æ¡ˆä¾‹ä¸€

- **é¡¹ç›®ä»‹ç»**ï¼šå‰ç«¯å¾®æœåŠ¡é¡¹ç›®
- **éœ€æ±‚**ï¼šå„ä¸ªå­æœåŠ¡çš„éƒ¨ç½²ï¼Œéœ€è¦æ ¹æ®ç°åº¦ç³»ç»Ÿä¼ é€’è¿‡æ¥çš„é™æ€èµ„æºç›®å½•åœ°å€æ¥åŠ¨æ€åˆ‡æ¢è½¬å‘åœ°å€
- **ä¸šåŠ¡ä»‹ç»**ï¼šè¿™æ˜¯æˆ‘å‚ä¸çš„ä¸€ä¸ªå‰ç«¯ä¸šåŠ¡åœºæ™¯ï¼Œè®¿é—®å¾®æœåŠ¡å­åº”ç”¨æ—¶ï¼Œå¾®æœåŠ¡å¯åŠ¨å™¨ä¼šè°ƒç”¨ç°åº¦ç³»ç»Ÿæ¥å£è·å–å½“å‰ç™»å½•ç”¨æˆ·çš„äº§å“æƒé™åˆ—è¡¨ï¼Œå¹¶è¿”å›ç»™å‰ç«¯æ‰“åŒ…å¥½çš„å‰ç«¯é¡µé¢é™æ€èµ„æºåœ°å€ã€‚è¿™ä¸ªåœ°å€ä¼šæ ¹æ®ç”¨æˆ·æƒé™å’Œç°åº¦ç­–ç•¥å˜åŒ–ã€‚

ç°åœ¨æœ‰ä¸Šé¢ä¸€ä¸ªå·¥ä½œï¼Œéœ€è¦é…ç½®nginxæ¥å®ŒæˆåŠ¨æ€è½¬å‘çš„å·¥ä½œï¼Œè®©ç”¨æˆ·çœ‹åˆ°ä¸åŒç‰ˆæœ¬çš„å‰ç«¯é¡¹ç›®ã€‚

#### è§£æ

å¯ä»¥ä½¿ç”¨ä¸€ä¸ªå˜é‡æ¥æ ‡è¯†èµ„æºåœ°å€ï¼Œåœ¨å‰ç«¯æœåŠ¡buildçš„CIä¸­ä¿®æ”¹è¿™ä¸ªé…ç½®æ–‡ä»¶ï¼Œæ›´æ”¹å˜é‡å€¼ã€‚

ä¸€ä¸ªç¤ºä¾‹ï¼š

```json
set $uri "/root/web/vue/dist";

server {
    listen       80;  
    server_name  www.test.com;  
    location / {  
        root   $uri; 
        index  index.html index.htm;
    }
}
```

åœ¨ CI ä¸­ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼šset $uri "/root/web/react/dist"ï¼Œé‡å¯ nginx åå³å¯ã€‚

> å¤§å®¶æœ‰æ›´å¥½çš„åŠæ³•çš„è¯ï¼Œå¯ä»¥åœ¨è¯„è®ºåŒºè®¨è®ºå“¦

### æ¡ˆä¾‹äºŒ

- **ä½¿ç”¨åœºæ™¯**ï¼šåœ¨å‰ç«¯é¡¹ç›®éƒ¨ç½²æ–°ç‰ˆæœ¬åï¼Œç”¨æˆ·æ²¡åŠæ³•æ„ŸçŸ¥åˆ·æ–°ï¼Œåœ¨ä¸å¼ºåˆ¶åˆ·æ–°çš„å‰æä¸‹ï¼Œçœ‹åˆ°çš„ä»ç„¶æ˜¯æ—§ç‰ˆæœ¬ã€‚
- **éœ€æ±‚**ï¼šéœ€è¦è®¾ç½®æœåŠ¡å™¨é…ç½®ï¼Œåœ¨å‰åç«¯ç‰ˆæœ¬ä¸ä¸€è‡´æ—¶å¼ºåˆ¶åˆ·æ–°

#### è§£æ

è¿™ä¸ªé—®é¢˜æœ‰å¤šç§è§£å†³æ–¹å¼ã€‚

å¯ä»¥é…ç½® nginxï¼Œé«˜é€Ÿæµè§ˆå™¨ä¸è¦ç¼“å­˜ï¼š

```json
location / {
    add_header Cache-Control "no-cache, must-revalidate"
}
```

æˆ–è€…é…ç½®å¼ºåˆ¶æµè§ˆå™¨ç¼“å­˜ï¼Œå¸¸ç”¨çš„åŠæ³•æ˜¯æ·»åŠ hashæˆ–è€…ç‰ˆæœ¬å·æ¥è®©æµè§ˆå™¨é‡æ–°ä¸‹è½½èµ„æºï¼š

```js
<link rel="stylesheet" href="/css/main.css?version=v2"
```26:T1f5a,ä¸Šä¸€èŠ‚è®²äº†å¦‚ä½•åœ¨ CentOS ä¸Šå®‰è£… gitlabï¼Œæœ¬èŠ‚è®²ä¸€ä¸‹å¦‚ä½•å®ç° gitlab CI/CDã€‚

## 1. å®‰è£…é…ç½® gitlab-runner

æ‰§è¡ŒæŒ‡ä»¤

```shell
mwget https://mirrors.tuna.tsinghua.edu.cn/gitlab-runner/yum/el7/gitlab-runner-11.5.1-1.x86_64.rpm
```

å®‰è£…

```shell
rpm -i gitlab-runner-11.5.1-1.x86_64.rpm
```

æŸ¥çœ‹ç‰ˆæœ¬

```shell
gitlab-runner -v
```

![image.png](/img/posts/2023-1-1/2023-1-1-1.png)

æ³¨å†Œï¼š
`gitlab-runner register`ï¼Œ
ä¼šæç¤ºè¾“å…¥URLï¼Œ

![image.png](/img/posts/2023-1-1/2023-1-1-2.png)

è¿™ä¸ªåœ¨ä»“åº“çš„é…ç½®çš„ Runners é‡Œå¯ä»¥æŸ¥åˆ°

![image.png](/img/posts/2023-1-1/2023-1-1-3.png)

æ¥ä¸‹æ¥æç¤ºè¾“å…¥ gitlab-ci tokenï¼Œé…ç½®é‡Œç´§æŒ¨ç€åˆšæ‰çš„URLçš„å°±æ˜¯Tokenï¼Œç²˜è´´è¿‡å»å›è½¦å°±å¯ä»¥å•¦ã€‚

ä¸€è·¯æŒ‰ç…§æç¤ºè¾“å…¥å°±è¡Œï¼Œè¾“å…¥tagä¸º  test-deployï¼Œæœ€åä¼šæç¤ºé€‰æ‹©å“ªç§æ‰§è¡Œå™¨ executorï¼š

![image.png](/img/posts/2023-1-1/2023-1-1-4.png)

çœ‹ä½ ç†Ÿæ‚‰å“ªä¸ªå•¦ï¼Œè¿™é‡Œä»¥ shellä¸ºä¾‹ã€‚

é…ç½®å¥½åï¼Œéœ€è¦å°†gitlabÂ æ ¡éªŒä¸€ä¸‹

![image.png](/img/posts/2023-1-1/2023-1-1-5.png)

åœ¨webé¡µé¢æŸ¥çœ‹ä¸€ä¸‹ runnersé…ç½®ï¼Œåˆšåˆšçš„æ³¨å†Œrunnerå·²ç»å­˜åœ¨å•¦ï¼š


![image.png](/img/posts/2023-1-1/2023-1-1-6.png)

ç‚¹å‡»ç¼–è¾‘æŒ‰é’®è¿›å…¥runnerç¼–è¾‘ï¼š

![image.png](/img/posts/2023-1-1/2023-1-1-7.png)
å‹¾ä¸Šå›¾ä¸­æ‰€ç¤ºé€‰é¡¹è®©æ²¡æœ‰æ‰“æ ‡ç­¾çš„é¡¹ç›®ä¹Ÿèƒ½ä½¿ç”¨ã€‚æˆ‘è¿™é‡Œ æ‰“äº† test-deploy çš„æ ‡ç­¾ã€‚åŒä¸€ä¸ªæ ‡ç­¾çš„ CI ç”¨çš„æ˜¯ä¸€ä¸ª Runnerã€‚

## 2. é¡¹ç›®buildä¸Nginxéƒ¨ç½²

å…ˆä¸ä½¿ç”¨gitlabæµæ°´çº¿ï¼Œè‡ªå·±å®ç°ä¸€ä¸‹è¯¥é¡¹ç›®çš„buildä¸nginxéƒ¨ç½²ã€‚

æœ¬æ–‡å‡†å¤‡çš„é¡¹ç›®å°±æ˜¯ä¸€ä¸ªviteåˆ›å»ºçš„ vue3 ç©ºé¡¹ç›®ï¼š

![image.png](/img/posts/2023-1-1/2023-1-1-8.png)

æŸ¥çœ‹ä»–çš„ package.jsonï¼š

```json
"scripts": {
    "dev": "vite",
    "build": "vite build",
    "preview": "vite preview"
}
```

æ‰§è¡Œï¼š

```shell
yarn build
```
å¯ä»¥çœ‹åˆ°æ‰“åŒ…æ–‡ä»¶å·²ç»ç”Ÿæˆäº†ï¼š

![image.png](/img/posts/2023-1-1/2023-1-1-9.png)

æ¥ä¸‹æ¥å°±æ˜¯åœ¨ æœåŠ¡å™¨ï¼ˆè¿˜ä»¥è¿™ä¸ªCentOSè™šæ‹Ÿæœºä¸ºä¾‹ï¼‰ä¸Šå®‰è£…ä¸€ä¸‹ Nginxï¼ŒæŠŠæ‰“åŒ…çš„æ–‡ä»¶ä¸¢è¿›å»å°±å¯ä»¥äº†ã€‚

### Nginx å®‰è£…

- å‰ç½®ä¾èµ–å®‰è£…

```shell
yum -y install gcc gcc-c++ autoconf pcre-devel zlib-devel openssl openssl-devel make automake
yum -y install httpd vim
```

- å®‰è£… Nginx

```shell
## ç”¨æˆ·ç›®å½•ä¸‹ï¼Œä¸‹è½½å…å®‰è£…ç‰ˆ (ä¹Ÿå¯ä»¥ç”¨ yum)
cd ~
mwget http://nginx.org/download/nginx-1.18.0.tar.gz

## è§£å‹ç¼©
tar zxvf nginx-1.18.0.tar.gz

## è¿›å…¥å®‰è£…ç›®å½• ï¼ˆä½ åœ¨å“ªé‡Œè§£å‹ç¼©çš„ï¼Œæ–‡ä»¶å°±åœ¨å“ªï¼‰
## é…ç½®å®‰è£…è¿è¡Œç›®å½•
./configure --prefix=/usr/local/nginx

## ç¼–è¯‘å®‰è£…
make && make install

## é…ç½®ç¯å¢ƒå˜é‡ ï¼ˆæˆ‘è¿™é‡Œåªé…ç½®ç”¨æˆ·çº§åˆ«ï¼‰
## åœ¨ç”¨æˆ·ä¸»ç›®å½•ä¸‹
vim .bash_profile

## è¿½åŠ 
PATH=$PATH:$HOME/bin:/usr/local/nginx/sbin

## ä¿å­˜é€€å‡ºåç”Ÿæ•ˆé…ç½®
source ./.bash_profile
```

æ­¤æ—¶åœ¨ä»»æ„ç›®å½•ä¸‹æ‰§è¡Œï¼š

```shell
nginx -v
```
ä¾¿å¯ä»¥çœ‹åˆ°æ‰“å°çš„ç‰ˆæœ¬å·äº†ã€‚

![image.png](/img/posts/2023-1-1/2023-1-1-10.png)

### å¯åŠ¨Nginx

```shell
å®‰è£…å®Œæ¯•ï¼Œè¿›å…¥Nginxä¸‹çš„sbinç›®å½•å¹¶å¯åŠ¨nginx
cd /usr/local/nginx/sbin
./nginx
```


### é…ç½® Nginx

> è¿™é‡Œè®² Nginx åªæ˜¯ä¸ºäº†è¾…åŠ© CI/CD è®²è§£ï¼Œé…ç½®è¯¦ç»†ä¸åšè¿‡å¤šå±•å¼€

è‹¥æ˜¯ yum å®‰è£…çš„ï¼Œé…ç½®æ–‡ä»¶åœ¨ `/etc/nginx/nginx.conf` ä¸­ï¼Œæˆ‘è¿™ä¸ªæ˜¯å…å®‰è£…ç‰ˆçš„ï¼Œé…ç½®æ–‡ä»¶åœ¨ `/usr/local/nginx` ä¸­ï¼š

```shell
vi /usr/local/nginx/conf/nginx.conf
```
æŒ‰ç…§è‡ªå·±çš„å–œå¥½é…ç½®ï¼Œæ‰¾å¯¹æ–‡ä»¶ç›®å½•å³å¯ï¼ˆå»ºè®®å•å¼€ä¸€ä¸ªå…¨å±€ç›®å½•ï¼‰ï¼š


![image.png](/img/posts/2023-1-1/2023-1-1-11.png)

æˆ‘ä»¬æŠŠ é¡¹ç›® dist ç›®å½•æ”¾å…¥å¯¹åº”é…ç½®çš„ä½ç½®ï¼ˆå»ºè®®ä¸è¦åœ¨è‡ªå®šä¹‰çš„ç”¨æˆ·ä¸‹ï¼Œä¸ç„¶ CI ä½¿ç”¨çš„è´¦æˆ· ä¼šæ‹¿ä¸åˆ°ï¼‰ï¼š


![image.png](/img/posts/2023-1-1/2023-1-1-12.png)

æŒ‰ç…§ä¸Šä¸€èŠ‚çš„è®²è§£ï¼Œé…ç½®äº†é˜²ç«å¢™å’Œè™šæ‹ŸæœºNATé…ç½®ï¼Œå¼€é€š 10087 ç«¯å£åï¼Œåœ¨ windowsä¸­è®¿é—®è™šæ‹Ÿæœºè¿™ä¸ªç«¯å£ http://192.168.137.128:10087


![image.png](/img/posts/2023-1-1/2023-1-1-13.png)
æˆåŠŸï¼

## 3. é…ç½®CI

åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹åˆ›å»º .gitlab-ci.yml æ–‡ä»¶æ¥ç¼–å†™æ‰§è¡Œæµç¨‹ã€‚

åœ¨ç¼–å†™ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¸…æ¥šä¸€ä¸ªäº‹æƒ…ï¼ŒCI/CD æ‰€è¦å®Œæˆçš„å·¥ä½œå°±æ˜¯ä¸Šè¾¹æˆ‘ä»¬æ‰‹åŠ¨ build å®Œä»¥åï¼Œå†æŠŠ dist ç›®å½•ç§»åŠ¨åˆ° nginx é…ç½®çš„ç›®å½•ä¸‹å¹¶ä¸”é‡å¯ Nginxï¼Œåªæ˜¯å˜æˆäº†æµæ°´çº¿è‡ªåŠ¨åŒ–éƒ¨ç½²è€Œå·²ï¼Œçœå»äº†ç¹æ‚çš„éƒ¨ç½²å·¥ä½œã€‚

ç¡®å®šæµæ°´çº¿åˆ†ä¸¤æ­¥ï¼šæ‰“åŒ… å’Œ éƒ¨ç½²ï¼š

```yaml
stages:
  - build
  - deploy
```

æµæ°´çº¿æ˜¯ä¸²è¡Œæ‰§è¡Œçš„ï¼Œæ•…runneråªç”¨ä¸€ä¸ªå°±å¯ä»¥ï¼Œyml ä¸­ tags è®¾ç½®ä¸ºåŒä¸€ä¸ªå°±è¡Œã€‚

æˆ‘ä»¬å†™ä¸€äº› build çš„è„šæœ¬æµ‹è¯•ï¼š

```yaml
build:
  stage: build
  tags:
    - test-deploy
  only:
    - master
  script:
    - pwd && ls -al
    - npm install --registry https://registry.npm.taobao.org && npm run build
    - cd $CI_PROJECT_DIR && ls
    - cp -r ./dist /home/gitlab-runner/web/backup/ 
  cache:
    paths:
      - node_modules/
```

> æœ€åçš„ cp æ˜¯ä¸ºäº†åœ¨ deploy èƒ½æ‹¿åˆ° build çš„æ–‡ä»¶ã€‚cp çš„æ—¶å€™åˆ«å¿˜äº†ç»™æ–‡ä»¶å¤¹æƒé™

æ¨é€åˆ° master åå‘ç° CI æŒ‚äº†ï¼š


![image.png](/img/posts/2023-1-1/2023-1-1-14.png)

åŸæ¥æ˜¯ runner ç¯å¢ƒé‡Œæ²¡æœ‰nodeç¯å¢ƒï¼Œé€šè¿‡å¦‚ä¸‹è„šæœ¬æ¥çœ‹çœ‹runnerçš„æ‰§è¡Œä½ç½®ï¼š

```yaml
before_script:
    - whoami
    - pwd
    - locate npm
    - echo ${PATH}
    - node -v
 ```
 
æ‰“å°ç»“æœï¼š

![image.png](/img/posts/2023-1-1/2023-1-1-15.png)

å¯ä»¥çœ‹åˆ°ï¼ŒPATH é‡Œæ˜¯æœ‰æˆ‘ä»¬åœ¨æœåŠ¡å™¨ä¸Šé…ç½®çš„ node çš„å…¨å±€å˜é‡çš„ï¼Œä½†æ˜¯è¿™é‡Œè¯»ä¸åˆ°ã€‚åº”è¯¥æ˜¯æœåŠ¡å™¨ç™»å½•è´¦æˆ·ä¸åŒé€ æˆçš„ã€‚


![image.png](/img/posts/2023-1-1/2023-1-1-16.png)

æº node æˆ‘æ˜¯é…ç½®åœ¨ root ä¸‹çš„å…¨å±€å˜é‡ï¼Œè€Œ CI æ˜¯è·‘åœ¨è‡ªåŠ¨åˆ›å»ºçš„ gitlab-runner è´¦æˆ·ä¸‹çš„ï¼Œæ­¤æ—¶åªè¦åœ¨runnerè´¦æˆ·ä¸‹å†å®‰è£…ä¸€æ¬¡ï¼Œé…ç½®å¥½ç¯å¢ƒå˜é‡å°±æå®šå•¦ã€‚å†æµ‹è¯•ä¸€ä¸‹ï¼š


![image.png](/img/posts/2023-1-1/2023-1-1-17.png)

å¯ä»¥çœ‹åˆ° node å·²ç»æ‹¿åˆ°ï¼Œç›´æ¥ä¸Š buildï¼š


![image.png](/img/posts/2023-1-1/2023-1-1-18.png)

å¯ä»¥çœ‹åˆ° npm build æˆåŠŸå•¦ï¼Œé‚£ä¹ˆæ‰“å®ŒåŒ…çš„ dist è¦å¦‚ä½•éƒ¨ç½²åˆ°æœåŠ¡å™¨ä¸Šå‘¢ï¼Ÿ

## 4. é…ç½®CD

é¦–å…ˆè¿›å…¥æŸ¥çœ‹ä¸€ä¸‹ ä¸Šä¸€æ­¥ cp çš„å…¬å…±ç›®å½•ï¼š


![image.png](/img/posts/2023-1-1/2023-1-1-19.png)

å¯ä»¥çœ‹åˆ°å·²ç»æœ‰å•¦ã€‚è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥åœ¨ deploy é˜¶æ®µå¤„ç†è¿™äº›æ–‡ä»¶äº†ã€‚

å¤ä¹ ä¸€ä¸‹ä¸Šä¸€èŠ‚ï¼ŒNginx éƒ¨ç½²ç›®å½•æ˜¯ï¼š/root/web/distï¼Œæˆ‘ä»¬è¯•ç€ cp ä¸€ä¸‹ï¼š

```yaml
deploy:
  stage: deploy
  tags:
    - test-deploy
  only:
    - master
  script:
    - echo "deploy"
    - pwd && ls -al
    - cp -r /home/gitlab-runner/web/backup/dist /root/web/dist
```

å‘ç°è¯»å–ä¸äº† root ä¸‹çš„ç›®å½•ï¼š


![image.png](/img/posts/2023-1-1/2023-1-1-20.png)

æ‰€ä»¥æ”¹è¿›ä¸€ä¸‹ Nginx éƒ¨ç½²ç›®å½•ï¼š


![image.png](/img/posts/2023-1-1/2023-1-1-21.png)

ä¿®æ”¹ deployï¼š
```yaml
- cp -r /home/gitlab-runner/web/backup/dist /home/gitlab-runner/web/
```

æ­¤æ—¶ 10087 ç«¯å£å·²ç»è·‘ä¸èµ·æ¥äº†ã€‚æˆ‘ä»¬æäº¤ä¸€ä¸‹ CI å†è·‘ä¸€æ¬¡ï¼š


![image.png](/img/posts/2023-1-1/2023-1-1-22.png)

æˆåŠŸå¤åˆ¶è¿‡å»äº†ã€‚

æ­¤æ—¶åœ¨ windowsä¸‹å†çœ‹çœ‹ï¼š


![image.png](/img/posts/2023-1-1/2023-1-1-23.png)

æˆåŠŸï¼

æˆ‘ä»¬æ”¹åŠ¨ä¸€ä¸‹ä»£ç æäº¤æµ‹è¯•ä¸€ä¸‹ï¼š


![image.png](/img/posts/2023-1-1/2023-1-1-24.png)

push åˆ° master ä¸Šï¼Œç­‰ CI/CD è·‘å®Œååˆ·æ–°ç½‘é¡µï¼š


![image.png](/img/posts/2023-1-1/2023-1-1-25.png)

è‡ªåŠ¨åŒ–éƒ¨ç½²å®Œæˆï¼ï¼

## 5. å°ç»“

1. å®‰è£… runner
2. é…ç½® nginx
3. ä¹¦å†™ .gitlab-ci.yml

```yaml
stages:
  - build
  - deploy

build:
  stage: build
  tags:
    - test-deploy
  only:
    - master
  before_script:
    - whoami
    - pwd
    - echo ${PATH}
    - node -v
  script:
    - pwd && ls -al
    - npm install --registry https://registry.npm.taobao.org && npm run build
    - cd $CI_PROJECT_DIR && ls
    - cp -r ./dist /home/gitlab-runner/web/backup/
  cache:
    paths:
      - node_modules/

deploy:
  stage: deploy
  tags:
    - test-deploy
  only:
    - master
  script:
    - echo "deploy"
    - pwd && ls -al
    - cp -r /home/gitlab-runner/web/backup/dist /home/gitlab-runner/web/
```

4. éƒ¨ç½²ç›®å½•æ£€æŸ¥ä¸æµ‹è¯•ä»£ç 27:T190d,ä¹‹å‰ä¸€ç›´æ¯”è¾ƒå¿Œè®³åœ¨å‰ç«¯é¡¹ç›®ä¸­ä½¿ç”¨å…¨å±€çŠ¶æ€ç®¡ç†å·¥å…·ï¼Œå®‰è£…åŒ…æ¯”è¾ƒå¤§ï¼Œé…ç½®èµ·æ¥æ¯”è¾ƒç¹çï¼Œæ¯”å¦‚ Reduxã€‚ä½†æ˜¯éšç€é¡¹ç›®ä¸šåŠ¡çš„å¢å¤šï¼Œä¸€äº›çŠ¶æ€å¾ˆéš¾åšåˆ°ç»„ä»¶é—´å…±äº«ï¼Œæ¯”å¦‚ç™»å½•çŠ¶æ€. é€šçŸ¥æ¶ˆæ¯ç­‰ã€‚


## 1. å‰ç«¯çŠ¶æ€ç®¡ç†æ–¹æ¡ˆ

ä¸‹é¢æ¥å¯¹æ¯”ä¸€ä¸‹ å‰ç«¯é¡¹ç›®ä¸­å…¨å±€çŠ¶æ€ç®¡ç†çš„å‡ ç§æ–¹å¼ã€‚

1. localStorage / sessionStorage

2. cookie

3. Context å…¨å±€ä¸Šä¸‹æ–‡

4. çŠ¶æ€ç®¡ç†å·¥å…·ï¼Œæ¯”å¦‚ Redux. Piniaç­‰


### 1. localStorage

å…ˆè¯´ç¬¬ä¸€ç§ï¼Œå¯ä»¥å­˜åœ¨æµè§ˆå™¨æœ¬åœ°çš„ä¸€ç§å­˜å‚¨æ–¹å¼ã€‚ç¡®å®é¡¹ç›®ä¸­ç»å¸¸åœ¨ç”¨ï¼š

```js
export function setLocalStorage(key, value) {
    try {
        window.localStorage.setItem(key, JSON.stringify(value));
    } catch (e) {
        console.log(e.message)
    }
}

export function getLocalStorage(key) {
    const value = window.localStorage.getItem(key);
    try {
        return JSON.parse(value);
    } catch (e) {
        return value;
    }
}
```

- ä¼˜åŠ¿
    1. èƒ½å¤Ÿé•¿æœŸå‚¨å­˜æ•°æ®
    2. åŒä¸€ä¸ªåŸŸä¸‹å…±äº«åŒä¸€ä¸ªå¯¹è±¡
    3. ä¸ä¼šéš HTTP è¯·æ±‚å‘é€
    4. é¡µé¢çº§åˆ«ä½¿ç”¨
- ç¼ºç‚¹
    1. ä¸åŒçš„æµè§ˆå™¨çª—å£ä¸‹ï¼Œä¿¡æ¯ä¼šç›¸äº’å¹²æ‰°
    2. åœ¨æµè§ˆå™¨çš„éšç§æ¨¡å¼ä¸‹ä¸å¯ä»¥è¯»å–
    3. ç”±äºæœåŠ¡å…³é—­åä¿¡æ¯è¿˜èƒ½å­˜åœ¨åœ¨æµè§ˆå™¨ç¼“å­˜ä¸­ï¼Œæ•…ä¸é€‚å®œå­˜å‚¨æ•æ„Ÿä¿¡æ¯ï¼Œæ¯”å¦‚ç™»å½•ä¿¡æ¯ç­‰
    4. ç”±äºä½¿ç”¨äº† window å¯¹è±¡ï¼Œéæµè§ˆå™¨ç¯å¢ƒä¸å¯ä½¿ç”¨
    5. æ— æ³•å“åº”å¼è§¦å‘æ‰€æœ‰ç»„ä»¶åŒæ­¥æ›´æ–°çŠ¶æ€ï¼ˆè¿™ä¹Ÿæ˜¯reduxå­˜åœ¨çš„æ„ä¹‰ï¼‰
- å»ºè®®
   - å­˜å‚¨å¸¸ç”¨çš„ä¸‹æ‹‰èœå•é€‰æ‹©é¡¹. å…¬ç”¨åˆ—è¡¨. æšä¸¾ç­‰ã€‚


### 2. Cookie

- ä¼˜åŠ¿
    1. å¯ä»¥å‰åç«¯å…±äº«
    2. åŒä¸€ä¸ªåŸŸä¸‹å…±äº«åŒä¸€ä¸ªå¯¹è±¡
- ç¼ºç‚¹
    1. é™åˆ¶å¤§å°4Kï¼Œåªèƒ½å­˜ä¸€äº›å…¬å…±å˜é‡ï¼Œä½¿ç”¨åœºæ™¯ä¸é€‚åˆç”¨äºç¼“å­˜
    2. å­˜åœ¨é¢å¤–çš„å®‰å…¨é…ç½®æˆæœ¬
    3. è·¨åŸŸå­˜åœ¨é—®é¢˜ï¼Œéœ€è¦é¢å¤–çš„é…ç½®æˆæœ¬
    4. ä¸å¤Ÿçµæ´»ï¼Œä¸èƒ½é€‚åº”è¶Šæ¥è¶Šå¤šçš„å…¨å±€çŠ¶æ€çš„æ·»åŠ 

### 3. Context

Context ä¼ é€’ä¿¡æ¯æ˜¯ç»„ä»¶çº§åˆ«çš„ï¼Œå¾€å¾€åŒ…è£¹åœ¨éœ€è¦å…±äº«å‚æ•°çš„ç»„ä»¶é›†åˆçš„æœ€å¤–å±‚ï¼š

```js
const BasicContext = React.createContext({});

<BasicContext.Provider value={{ ...context, ...systemStore }} >
    ...
</BasicContext.Provider>
```

Context ä¸äº§ç”Ÿæ•°æ®æ¥æºï¼Œå¾€å¾€å’Œç¼“å­˜ä¸€èµ·ä½¿ç”¨ï¼Œæ¯”å¦‚ systemStore å¯ä»¥æ˜¯ getLocalStorage æ‹¿åˆ°çš„ä¸€å †æ•°æ®çš„é›†åˆï¼Œè¢«ä»–åŒ…è£¹çš„å­å…ƒç´ ä¾¿éƒ½å¯ä»¥å…±äº«åŒä¸€ä»½ä¸Šä¸‹æ–‡æ•°æ®ã€‚

- ä¼˜åŠ¿
    1. ä½¿ç”¨ç®€å•ï¼Œä¸éœ€è¦é¢å¤–é…ç½®
    2. ç»„ä»¶çº§åˆ«ä½¿ç”¨
- ç¼ºç‚¹
    1. åªæä¾›ä¸€ä¸ªä¸Šä¸‹æ–‡ç¯å¢ƒï¼Œå¿…é¡»å’Œå…¶ä»–çš„çŠ¶æ€ç®¡ç†å·¥å…·ä¸€èµ·ä½¿ç”¨
    2. å—æ¡†æ¶é™åˆ¶
    3. contextç›¸å½“äºå…¨å±€å˜é‡ï¼Œ éš¾ä»¥è¿½æº¯æ•°æ®æº
    4. è€¦åˆåº¦é«˜ï¼Œå³ä¸åˆ©äºç»„ä»¶å¤ç”¨ä¹Ÿä¸åˆ©äºæµ‹è¯•
    5. æ²¡åŠæ³•åå‘ä¿®æ”¹çŠ¶æ€å€¼ï¼Œå­ç»„ä»¶åªèƒ½è¢«åŠ¨è¯»å–

### Mobx

ä½¿ç”¨æ¡†æ¶çº§åˆ«çš„çŠ¶æ€ç®¡ç†å·¥å…·å¯ä»¥ç”¨æ¥å­˜å‚¨ä¸´æ—¶çš„å‰ç«¯å±‚çº§çš„å…¬å…±çŠ¶æ€ï¼š


- ä¼˜åŠ¿
    1. ä¾¿äºä»£ç ç®¡ç†
    2. ç»„ä»¶çº§åˆ«ä½¿ç”¨
    3. è¯»å†™æ–¹ä¾¿ï¼Œæ²¡æœ‰å®‰å…¨é—®é¢˜
- ç¼ºç‚¹
    1. å—æ¡†æ¶é™åˆ¶
    2. éœ€è¦é¢å¤–çš„é…ç½®
    3. ä¸šåŠ¡è€¦åˆåº¦é«˜ï¼Œç”¨æˆ·å†™ä¸šåŠ¡å¿…é¡»ç…§é¡¾åˆ°çŠ¶æ€çš„é…ç½®
    4. ...

Mobx æ˜¯ä¸€ç§ç›¸å¯¹èƒ½å¤Ÿå…‹æœé…ç½®ç¹çé—®é¢˜çš„å·¥å…·ï¼Œè¿™æ¬¡åœ¨é¡¹ç›®å¼€å‘ä¸­å°±å¼•å…¥äº† Mobxï¼Œä½¿ç”¨å“åº”å¼+å‡½æ•°å¼æ¨¡å¼ï¼Œå¹¶å°† Reducerå’ŒActionåˆä¸ºä¸€ä½“ï¼Œä½¿å¾—Mobxç›¸å¯¹äº Redux ç®€å•è®¸å¤šã€‚

## 2. Mobx ä½¿ç”¨

è¿™é‡Œä»¥å®ç°ä¸€ä¸ªè¿è¥ç³»ç»Ÿå†…éƒ¨å½“å‰å¾…å®¡æ ¸é¡¹ç›®çš„æ•°é‡æç¤ºä¸ºä¾‹ï¼Œè®²è§£ Mobx åœ¨å‡½æ•°å¼ç»„ä»¶ä¸­çš„ä½¿ç”¨ã€‚

- å®‰è£…

```js
yarn add mobx mobx-react-lite
```

- å¼•å…¥ï¼šæ–°å»º stores.js

```js
import { runInAction } from "mobx"
import { useLocalObservable } from 'mobx-react-lite';

// è‡ªå·±å®šä¹‰çš„ APIè¯·æ±‚ï¼Œæœ¬è´¨æ˜¯ä¸€ä¸ª Promise
import { GetAuditingDataCount } from '../../src/apis/usms';

export const Store = () => {

  // åˆ›å»ºè§‚å¯Ÿè€…
  const storeContext = useLocalObservable(() => ({
    // çŠ¶æ€
    auditCount: {},
    get getAuditCount() { return this.auditCount; },
    // è¯·æ±‚APIçš„action
    reloadAuditCount() {
      GetAuditingDataCount().then(res => {
        runInAction(() => {
          this.auditCount = res?.Data || {}
        })
      })
    },
    // é‡ç½®çŠ¶æ€
    resetAuditCount() {
      runInAction(() => {
        this.auditCount = {};
      })
    }
  }));

  return { storeContext }
}

```
ä¸Šé¢å°±åˆ›å»ºäº†ä¸€ä¸ªè¯»å–å½“å‰å¾…å®¡æ ¸æ•°é‡çš„storeã€‚

- ä¸šåŠ¡ä¸­ä½¿ç”¨ï¼šä½¿ç”¨ observer åŒ…è£¹è¦ç”¨åˆ°çŠ¶æ€çš„ç»„ä»¶ï¼Œnameåœ¨è¿™ä¸ªç»„ä»¶å†…éƒ¨å°±å»ºç«‹äº†ç›‘å¬

```js
import { observer } from "mobx-react-lite";

function Menu() {
  ...
}

export default observer(Menus)
```

å€ŸåŠ© Context ä¼ å€¼ç»™ Menuï¼š

```js
// å¼•å…¥è‡ªå®šä¹‰çš„ store
import { Store as MobxStore } from '../stores';

const { storeContext } = MobxStore();

// å•ç‹¬ä¸€ä¸ªæ–‡ä»¶å†™å…¥ï¼šconst BasicContext = React.createContext({});
<BasicContext.Provider value={{ storeContext }} >
    ...
    <Menu />
    ...
</BasicContext.Provider>
```

Menu ç»„ä»¶å†…éƒ¨ä½¿ç”¨ï¼š

```js
import BasicContext from '../../BasicContext'

const context = useContext(BasicContext);

const storeContext = context.storeContext || {};
```
å¦‚æ­¤å°±æ‹¿åˆ°äº†é‚£ä¸ª store çš„å•ä¾‹ï¼Œè¿›è€Œåœ¨æ¸²æŸ“æ—¶å°±å¯ä»¥è¿™æ ·å†™ï¼š

```js
<Menu.SubMenu
    title={
      <span>
        {menu.icon}
        // è¿™é‡Œæ˜¯é‡ç‚¹ï¼Œå¯ç›´æ¥è·å–çŠ¶æ€æ•°æ® storeContext?.auditCount?.TotalCount
        {menu.auditCount ? <Badge offset={[4, 0]} dot={(storeContext?.auditCount?.TotalCount || 0) > 0}>
          <span>{menu.name}</span>
        </Badge> : <span>{menu.name}</span>}
      </span>
    }
    key={menu.key}
    >
    {genMenus(menu.children)}
</Menu.SubMenu>
```

æ•°æ®å˜æ›´ï¼š

```js
// å®¡æ ¸æ¥å£

AuditAPI(...).then(() => {
    ...
    // åˆ·æ–° mobx çŠ¶æ€
    storeContext.reloadAuditCount();
});
```
å½“å®¡æ ¸çŠ¶æ€å˜åŒ–æ—¶ï¼ŒåŠ¨æ€è°ƒç”¨APIé‡æ–°è®¾ç½®storesé‡Œçš„å€¼åï¼Œæ‰€æœ‰è¢« observe çš„ç»„ä»¶éƒ½ä¼šè‡ªåŠ¨å˜åŒ–ï¼š


![image.png](/img/posts/2022-12-26/2022-12-26-1.png)


## 3. æ€»ç»“

ä¸æ˜¯ä¸‡ä¸å¾—å·²ï¼Œå°½é‡ä¸è¦ä¸Šå…¨å±€çŠ¶æ€ç®¡ç†å·¥å…·ï¼Œä½¿ç”¨ Context + sessionStorage ä»£æ›¿å³å¯ã€‚åœ¨éœ€è¦å®æ—¶æˆ–è§¦å‘å¼æ›´æ–°çŠ¶æ€çš„åœ°æ–¹ï¼Œå¦‚æœä¸èƒ½ä¸Š webSocketï¼Œå®åœ¨è¦ç”¨ï¼Œå°±ä½¿ç”¨é…ç½®ç®€å•ï¼Œè€¦åˆæ€§ä½çš„å·¥å…·ã€‚åŒæ—¶è¿˜è¦ç…§é¡¾åˆ°å®‰å…¨æ€§ï¼Œæ¨èé…ç½®ï¼šContext + Mobx.28:Tbff,åœ¨éƒ¨ç½²å‰ç«¯æœåŠ¡çš„è¿‡ç¨‹ä¸­ï¼Œéœ€è¦å®ç°ç™»å½•ä¿¡æ¯å…±äº«çš„åŠŸèƒ½ï¼Œè‹¥å„ä¸ªæœåŠ¡æ˜¯åœ¨åŒä¸€ä¸ªåŸŸåä¸‹çš„ï¼Œåˆ™å¯ä»¥å…±äº«cookieã€‚ä½†æ˜¯ï¼Œå…¬å¸å¯¹å¤–äº§å“å¾€å¾€éƒ½æ˜¯å•ç‹¬éƒ¨ç½²åŸŸåçš„ï¼Œæ¯”å¦‚äº§å“é¡µé¢ã€é—¨æˆ·ç½‘ç«™ç­‰ï¼Œä»–ä»¬è‹¥éœ€è¦æ‹¿åˆ°å½“å‰ç™»å½•ä¿¡æ¯ï¼Œå°±éœ€è¦ç‰¹æ®Šé…ç½®äº†ã€‚

äº§å“éƒ¨ç½²é…ç½®ï¼š

- ç™»å½•é¡µé¢ï¼š https://passport.xxx.com
- å¾®æœåŠ¡äº§å“ç³»ç»Ÿï¼šhttps://console.xxx.com
- é—¨æˆ·ç½‘ç«™ï¼šhttps://www.xxx.com
- äº§å“æ–‡æ¡£ï¼šhttps://docs.xxx.com

å¯ä»¥çœ‹åˆ°çº¿ä¸Šéƒ¨ç½²åï¼Œå…¬å¸äº§å“çš„äºŒçº§åŸŸåè™½ç„¶æ˜¯ä¸ä¸€æ ·ï¼Œä½†æ˜¯ä¸€çº§åŸŸåä¸€æ ·ï¼ŒæŠŠcookieçš„Domainè®¾ç½®ä¸º `.xxx.com` å°±å¯ä»¥å…±äº«äº†ã€‚ä½†æ˜¯å¦‚æœæ˜¯æœ¬åœ°å¼€å‘å°±å¤´ç–¼äº†ã€‚æœ¬åœ°å¼€å‘ï¼Œä¼šå…ˆè·³è½¬åˆ°éƒ¨ç½²å¥½çš„ç™»å½•é¡µï¼š`passport.xxx.admin.com`ï¼Œç„¶åå†è·³è½¬å› `localhost` ï¼Œæ­¤æ—¶ï¼Œæ¥æºçš„ä¸€çº§åŸŸåä¸ä¸€æ ·ï¼Œå°±ä¼šå‡ºç°cookieæ²¡åŠæ³•å…±äº«çš„é—®é¢˜äº†ã€‚

è¿™é‡Œæä¾›ä¸‰ç§è·¨åŸŸcookieæ–¹æ¡ˆä¾›é€‰æ‹©ã€‚

## 1. åç«¯é…ç½®

æˆ‘ä»¬çŸ¥é“ cookie æœ‰å‡ ä¸ªå±æ€§ï¼š

![image.png](/img/posts/2022-12-25/2022-12-25-1.png)

HttpOnly å’Œ Secure ç”¨äºé™åˆ¶åªèƒ½ https ä¼ é€’ä¸å¯è¯»çš„å®‰å…¨ cookieï¼›å¦å¤–ä¸€ä¸ªå±æ€§ SameSite å¯ä»¥è®¾ç½®ä¸‰ä¸ªå€¼ï¼š`Strict`ã€`Lax`ã€`None`ï¼š

- `Strict`ï¼šå®Œå…¨ç¦æ­¢ç¬¬ä¸‰æ–¹è·å–cookieï¼Œè·¨ç«™ç‚¹æ—¶ï¼Œä»»ä½•æƒ…å†µä¸‹éƒ½ä¸ä¼šå‘é€cookie
- `Lax`ï¼šé˜²èŒƒè·¨ç«™ï¼Œå¤§å¤šæ•°æƒ…å†µä¸‹ç¦æ­¢è·å–cookieï¼Œé™¤éå¯¼èˆªåˆ°ç›®æ ‡ç½‘å€çš„GETè¯·æ±‚ï¼ˆé“¾æ¥ã€é¢„åŠ è½½ã€GETè¡¨å•ï¼‰
- `None`ï¼šæ²¡æœ‰é™åˆ¶ã€‚å¿…é¡»åŒæ—¶è®¾ç½®`Secure`å±æ€§ï¼ˆCookie åªèƒ½é€šè¿‡ HTTPS åè®®å‘é€ï¼‰ï¼Œå¦åˆ™æ— æ•ˆï¼Œéœ€è¦ chrome > 80ï¼Œå…¼å®¹æ€§æœ‰é—®é¢˜ï¼š

![image.png](/img/posts/2022-12-25/2022-12-25-2.png)

æ­¤æ—¶ï¼Œåªè¦è®¾ç½® åªæ”¯æŒhttps ä¸” samesite=Noneï¼Œä¾¿ä¼šåœ¨ https ä¸‹æºå¸¦ cookie äº†ã€‚ä½†æ˜¯è¿™åªé€‚ç”¨äº httpsï¼Œå¼€å‘ç¯å¢ƒå¤§å¤šæ˜¯ httpï¼Œä¸èƒ½ç”¨ã€‚

## 2. å‰ç«¯é…ç½®

å‰ç«¯ä¹Ÿæ˜¯å¯ä»¥è®¾ç½® cookie çš„ï¼Œè€Œä¸”å¯ä»¥æŒ‡å®šåŸŸåã€‚åœ¨ç™»å½•é¡µé¢ç™»å½•åè®¾ç½® cookieï¼š

```js
let host = window.location.host;

if (host.indexOf('passport.xxx.admin.com') > -1) {
    host = '.xxx.admin.com';
}

window.document.cookie = `${name}=${value};domain=${host}`;
```


## 3. è·³è½¬æ—¶è®¾ç½®å›è°ƒå‚æ•°

é’ˆå¯¹å‰ç«¯é…ç½®çš„è¡¥å……æ–¹æ¡ˆï¼Œæ­¤æ–¹æ³•ä¹Ÿé€‚åˆ iframe ä¼ å‚æ–¹å¼ã€‚

åœ¨ `localhost` è¿›å…¥å¼€å‘é¡µé¢ï¼Œæ­¤æ—¶æ£€æµ‹åˆ°æ²¡æœ‰ cookie ä¿¡æ¯ï¼Œä¼šè‡ªåŠ¨è·³è½¬åˆ°ç™»å½•é¡µé¢ï¼š `passport.xxx.admin.com`, è·³è½¬æ—¶å›å¸¦å‚æ•°ï¼š

```shell
http://passport.xxx.admin.com?origin=localhost
```

ç™»å½•é¡µé¢ç™»å½•åï¼Œç›´æ¥è¯»å–è·¯ç”±å‚æ•°ä¸­çš„ originï¼Œå¹¶è®¾ç½®å¸¦ç€ host çš„ cookieï¼š

```js
window.document.cookie = `${name}=${value};domain=${origin}`;
```
è®¾ç½®å®Œæ¯•åé‡å®šå‘é¡µé¢è·³è½¬å› origin å³å¯å®ç° cookie æºå¸¦ã€‚


## 4. å¯¹æ¯”

- åç«¯é…ç½®å€¾å‘äºå‰åç«¯ä¼ é€’ cookie æ—¶ä½¿ç”¨ï¼Œè‹¥åªæ˜¯å‰ç«¯å…±äº« cookieï¼Œä¸éœ€è¦å‘ŠçŸ¥åç«¯æ—¶åˆ™ä¸å¯ç”¨
- å‰ç«¯é…ç½®å¯ä»¥å®ç°åç«¯æ— æ„Ÿçš„cookieä¼ é€’ï¼Œä½†æ˜¯å®‰å…¨æ€§ä¸é«˜ï¼Œä¸å¯ä¼ é€’æ˜æ–‡ï¼Œå°½é‡åªç”¨åœ¨å¼€å‘ç¯å¢ƒã€‚

--------
å®Œ ï¼29:T18f4,åœ¨å›¢é˜Ÿä»£ç ç§æœ‰ä»“åº“ä¸­ï¼Œäº’è”ç½‘å…¬å¸ä¸­gitlabåº”è¯¥æ˜¯é¦–é€‰çš„ï¼Œä¸ä»…ä»…æ˜¯ä¸ªä»“åº“ï¼Œå…¶æ”¯æŒç§æœ‰åŒ–éƒ¨ç½²å’Œå…·å¤‡ç‹¬æœ‰çš„CI/CDï¼Œä¼˜åŠ¿æ˜æ˜¾ã€‚gitlab æœ‰å…è´¹çš„ç¤¾åŒºç‰ˆï¼ˆCEï¼‰ä¹Ÿæœ‰æ”¶è´¹çš„ä¼ä¸šç‰ˆï¼ˆEEï¼‰ï¼Œå›½å†…è¿˜æœ‰æç‹ç‰ˆï¼ˆJHï¼‰ã€‚æœ¬æ–‡ä»¥ CE ä¸ºä¾‹è®²è§£ã€‚

æœ¬æ–‡ä»‹ç»å¦‚ä½•åœ¨æœåŠ¡å™¨ï¼ˆä»¥centOS7ä¸ºä¾‹ï¼‰ä¸Šå®‰è£…gitlabï¼Œå¹¶å®ç°webç«¯è´¦å·é…ç½®ä¸sshé…ç½®ä»“åº“ã€‚

> å›½å†…å¯ä»¥ä½¿ç”¨ gitlab åœ¨å›½å†…çš„ä»£ç† [æç‹](https://gitlab.cn/install/) æ¥å®‰è£…ï¼Œå¾ˆå¤šè®¾ç½®éƒ½å·²ç»åšå¥½äº†ï¼Œä¹Ÿä¸å­˜åœ¨ç½‘ç»œé—®é¢˜ï¼Œå¯ä»¥çœå»å¾ˆå¤šç¹é‡çš„é…ç½®å·¥ä½œã€‚æœ¬æ–‡è¿˜æ˜¯ä»¥æ¸…åçš„é•œåƒæºä¸ºä¾‹ã€‚

## 1. å®‰è£…å‰æ£€æŸ¥

åœ¨å®‰è£…å‰ï¼Œå¯ä»¥æ£€æŸ¥ä¸€ä¸‹æ˜¯å¦å®‰è£…æœ‰æ—§ç‰ˆæœ¬ï¼Œå¸è½½æ‰ä»–ï¼

æŒ‰é¡ºåºæ‰§è¡Œå¦‚ä¸‹æŒ‡ä»¤ï¼š

```shell
## åœæ­¢gitlab
gitlab-ctl stop

## å¸è½½ (è¯·ç¡®å®šç‰ˆæœ¬`ce/ee/jh`ç­‰ã€‚è‹¥æ‰¾ä¸åˆ°åŒ…è¯´æ˜ä¸Šæ¬¡æ²¡æœ‰å®‰è£…æˆåŠŸ)
rpm -e gitlab-ce

## æ£€æŸ¥ä¸€ä¸‹è¿›ç¨‹
ps aux | grep gitlab
```


![image.png](/img/posts/2022-12-24/2022-12-24-1.png)

```shell
## æ¸…é™¤æ‰ service çš„è¿›ç¨‹
kill -9 9956

## åˆ é™¤æ‰€æœ‰åŒ…å«gitlabæ–‡ä»¶ ï¼ˆé€’å½’æŸ¥æ‰¾æœ‰äº›æ…¢ï¼Œå¯ä»¥ä¸åšï¼‰
find / -name gitlab | xargs rm -rf
```

## 2. å®‰è£…

- æ“ä½œç³»ç»Ÿï¼šCentOS7
- gitlabï¼šGitLab-ce æ¸…åæºé•œåƒ ï¼ˆgitlab-ce-11.5.3-ce.0.el7.x86_64.rpmï¼‰

### å‰ç½®å®‰è£…

åœ¨ç³»ç»Ÿé˜²ç«å¢™ä¸­æ‰“å¼€ HTTPã€HTTPS å’Œ SSH è®¿é—®ã€‚å¦‚æœæ‰“ç®—ä»…ä»æœ¬åœ°ç½‘ç»œè®¿é—®æç‹GitLabï¼Œåˆ™å¯ä»¥è·³è¿‡å®ƒã€‚

```shell
## å…¨éƒ¨ç²˜è´´ä¸€èµ·ä¸¢åˆ°ç»ˆç«¯é‡Œ
sudo yum install -y curl policycoreutils-python openssh-server perl
sudo systemctl enable sshd
sudo systemctl start sshd

sudo firewall-cmd --permanent --add-service=http
sudo firewall-cmd --permanent --add-service=https
sudo systemctl reload firewalld
```

sshé…ç½®ï¼š

```shell
sudo yum install curl policycoreutils openssh-server openssh-clients
```

é…ç½®é‚®ä»¶é€šçŸ¥ï¼ˆå¯é€‰ï¼‰

```shell
sudo yum install postfix
sudo systemctl enable postfix
sudo systemctl start postfix
```

ä¿®æ”¹é‚®ä»¶é…ç½®ï¼švi /etc/postfix/main.cf

```shell
inet_interfaces = allÂ Â  Â Â Â  Â Â  Â  //ä¹‹å‰åº”è¯¥æ˜¯localhost
```

å¯åŠ¨ postfixï¼š

```shell
service postfix start
systemctl status postfix.service
sudo systemctl enable postfix
```

ç”±äºå›½å†… wgeté€Ÿåº¦è¾ƒæ…¢ï¼Œå¯ä»¥ä½¿ç”¨ mwgetï¼š(è¿™ä¸€å †ä¸¢åˆ°ç»ˆç«¯é‡Œ)

```shell
wget http://jaist.dl.sourceforge.net/project/kmphpfm/mwget/0.1/mwget_0.1.0.orig.tar.bz2
yum install bzip2 gcc-c++ openssl-devel intltool -y
bzip2 -d mwget_0.1.0.orig.tar.bz2
tar -xvf mwget_0.1.0.orig.tar 
cd mwget_0.1.0.orig
./configure 
make
make installã€€
```

### ä¸‹è½½ä¸å®‰è£… gitlab

ä¸‹è½½é•œåƒæºï¼š

```shell
mwget https://mirrors.tuna.tsinghua.edu.cn/gitlab-ce/yum/el7/gitlab-ce-11.5.3-ce.0.el7.x86_64.rpm
```

å®‰è£…ï¼š

```shell
rpm -i gitlab-ce-11.5.3-ce.0.el7.x86_64.rpm
```
æˆ‘è¿™é‡Œå‡ºç°äº†ç£ç›˜ç©ºé—´ä¸è¶³çš„é—®é¢˜ï¼š

![image.png](/img/posts/2022-12-24/2022-12-24-2.png)

çœ‹äº†ä¸€ä¸‹ï¼Œä¸€å…±ä½¿ç”¨äº† 6Gï¼š

![image.png](/img/posts/2022-12-24/2022-12-24-3.png)

æŸ¥çœ‹å¯ç”¨ç©ºé—´ï¼š

![image.png](/img/posts/2022-12-24/2022-12-24-4.png)
æ ¹è·¯å¾„ä¸‹åªå‰©5Gä¸åˆ°äº†ï¼Œæ¸…ç†äº†åˆ é™¤åæœªé‡Šæ”¾ç£ç›˜çš„æ–‡ä»¶åå†è¯•ã€‚

è€å¿ƒç­‰å¾…åä¼šæœ‰å®‰è£…æˆåŠŸæç¤º


![image.png](/img/posts/2022-12-24/2022-12-24-5.png)

æ­¤æ—¶æŸ¥çœ‹gitlabç‰ˆæœ¬ï¼š

```shell
cat /opt/gitlab/embedded/service/gitlab-rails/VERSION

## 11.5.3
```
> ä¹Ÿå¯ä»¥ä½¿ç”¨ docker å®‰è£…ï¼šhttps://docs.gitlab.cn/jh/install/docker.html

## 3. å®‰è£…åé…ç½®

### é‡ç½®rootè´¦æˆ·

ç¼–è¾‘Â `/etc/gitlab/gitlab.rb`ï¼ˆå¦‚æœä¸å­˜åœ¨åˆ™åˆ›å»ºï¼‰å¹¶è®¾ç½®ï¼š

```shell
gitlab_rails['initial_root_password'] = 'passport'
```
åŒç›®å½•ä¸‹çš„ initial_root_password ä¹Ÿä¿®æ”¹ä¸€ä¸‹ï¼Œå¦‚æœæœ‰çš„è¯ã€‚å½“ç„¶ä¹Ÿå¯ä»¥é‡ç½®å¯†ç ï¼š

```shell
## 1. è·å–ç®¡ç†å‘˜æƒé™
sudo su
## 2. è¿›å…¥æ§åˆ¶å°
gitlab-rails console production
## 3. æŸ¥æ‰¾rootç”¨æˆ·
user = User.where(id: 1).first
## 4. è®¾ç½®
user.password = 'passport' #è®¾ç½®æ–°çš„å¯†ç 
user.password_confirmation = 'passport'  #ç¡®è®¤å¯†ç 
## 5. ä¿å­˜
user.save!
## å½“å‘ç°=> trueæ—¶è¡¨ç¤ºé‡ç½®æˆåŠŸ

## 6. é€€å‡º
ctrl+d or exit
```

### é…ç½®web URL
ç¼–è¾‘Â `/etc/gitlab/gitlab.rb`

```shell
## é…ç½®æœ¬æœºipå¯è®¿é—®çš„åœ°å€
external_url "http://127.0.0.1:10086"
```

æœ€åç”Ÿæ•ˆé…ç½®ï¼š

```shell
gitlab-ctl reconfigure
```

æŸ¥çœ‹çŠ¶æ€

```shell
gitlab-ctl status
```

## 4. Web è®¿é—®

æµè§ˆå™¨é‡Œæ‰“å¼€åˆšåˆšé…ç½®çš„ url åœ°å€ï¼š


![image.png](/img/posts/2022-12-24/2022-12-24-6.png)

> å¦‚æœå‡ºç°äº† 502 é”™è¯¯ï¼Œå¯èƒ½æ˜¯ç«¯å£è¢«å ç”¨äº†ï¼Œä¹Ÿå¯èƒ½æ˜¯å†…å­˜ä¸è¶³äº†

è¾“å…¥é…ç½®å¥½çš„å¯†ç ï¼š
- root/password

è¿›å…¥ç•Œé¢ï¼š


![image.png](/img/posts/2022-12-24/2022-12-24-7.png)

## 5. å®¢æˆ·ç«¯è®¿é—®

### è®¾ç½® CentOS å¤–éƒ¨å¯è®¿é—®ï¼š

æ‰§è¡ŒæŒ‡ä»¤ï¼š

```shell
iptables -F  
iptables -P INPUT ACCEPTï¼ˆè®¾ç½®é»˜è®¤å…è®¸è§„åˆ™ï¼‰
```
é…ç½®é˜²ç«å¢™ï¼Œå…è®¸10086ç«¯å£è®¿é—®ï¼š

```shell
## /etc/sysconfig/iptables-config

## æ·»åŠ 
-A RH-Firewall-1-INPUT -m state --state NEW -m tcp -p tcp --dport 10086 -j ACCEPT
```
å¼€æ”¾ç«¯å£ï¼š
```shell
firewall-cmd --zone=public --add-port=10086/tcp --permanent
```


å¦‚æœæ˜¯çœŸå®çš„ç‰©ç†æœºï¼Œåªè¦åœ¨ä¸€ä¸ªå±€åŸŸç½‘ä¸‹ç¨ä½œé…ç½®ä¾¿å¯ä»¥è®¿é—®ï¼Œæˆ‘è¿™é‡Œä½¿ç”¨çš„è™šæ‹Ÿæœºæ­å»ºçš„ CentOS ç¯å¢ƒï¼Œæ‰€ä»¥éœ€è¦å¦‚ä¸‹é…ç½®ï¼š


![image.png](/img/posts/2022-12-24/2022-12-24-8.png)

è™šæ‹Ÿæœºç¼–è¾‘é‡Œçš„è™šæ‹Ÿç½‘ç»œç¼–è¾‘å™¨ä¸­æ‰“å¼€NATè®¾ç½®ä¸­çš„æ·»åŠ ï¼šï¼ˆè™šæ‹Ÿæœºæ“ä½œç³»ç»Ÿipï¼š192.168.137.128ï¼‰

![image.png](/img/posts/2022-12-24/2022-12-24-9.png)

ç„¶ååœ¨ windows çš„é˜²ç«å¢™é…ç½®é‡Œæ·»åŠ è™šæ‹Ÿæœºçš„IPå³å¯ã€‚

> æ³¨æ„ï¼šä¸€å®šè¦é€‰æ‹© VWnet8 ç½‘ç»œ

windows ä¸‹è®¿é—®ï¼š


![image.png](/img/posts/2022-12-24/2022-12-24-10.png)

ç¬¬ä¸€éƒ¨åˆ†å°±å®Œæˆäº†ã€‚

-----

## 6. ç”¨æˆ·ç®¡ç†ä¸ä»“åº“ç®¡ç†

1. åˆ›å»ºä¸€ä¸ªç”¨æˆ·ï¼šç›´æ¥ä½¿ç”¨ç•Œé¢çš„æ³¨å†Œè¡¨å•å¡«å†™å³å¯ã€‚
2. ä½¿ç”¨è¯¥ç”¨æˆ·åˆ›å»ºä¸€ä¸ªä»“åº“ï¼š

![image.png](/img/posts/2022-12-24/2022-12-24-11.png)

3. æ­¤æ—¶å·²ç»çœ‹åˆ°æç¤ºäº†ï¼Œæˆ‘ä»¬é…ç½®ä¸€ä¸‹ sshkeyï¼Œé…ç½®è¿‡ç¨‹çœç•¥ï¼Œå¤§å®¶éƒ½ä¼šã€‚

![image.png](/img/posts/2022-12-24/2022-12-24-12.png)

4. åœ¨æœ¬åœ°åˆ›å»ºä¸€ä¸ª vue é¡¹ç›®ã€‚

5. å°†è¯¥ä»“åº“æ¨é€è‡³è¿œç«¯ä»“åº“åï¼ŒæŸ¥çœ‹ç•Œé¢ï¼š


![image.png](/img/posts/2022-12-24/2022-12-24-13.png)


ä»‹ç»å°±åˆ°è¿™é‡Œå•¦ï¼æœ‰æ„Ÿå…´è¶£çš„å¯ä»¥å…³æ³¨ä¸‹æœŸ CI/CD çš„é…ç½®ã€‚è°¢è°¢ï¼ï¼2a:T1e29,å‰ç«¯é¡¹ç›®é™¤äº†ç›®å‰çš„çº¯å•é¡µåº”ç”¨ï¼Œè¿˜æœ‰SSRçš„åº”ç”¨ï¼Œä¾‹å¦‚ nuxt å’Œ nextjsï¼Œå…¶åŒºåˆ«åœ¨äºå‰è€…æ˜¯å•ç‹¬çš„å‰ç«¯é¡µé¢éƒ¨ç½²ï¼Œè€Œåè€…ä½¿ç”¨äº†ä¸€ä¸ªå†…éƒ¨çš„ node å°å‹æœåŠ¡å™¨æ¥åšåˆ°æœåŠ¡å™¨é¡µé¢ç›´å‡ºçš„æ•ˆæœã€‚

ä¸‹é¢æˆ‘ä»¬å°±é’ˆå¯¹è¿™ä¸¤ç§å¸¸è§çš„å‰ç«¯é¡¹ç›®ï¼Œè®²è®²ä»–ä»¬ä¸Šçº¿éƒ¨ç½²çš„æµç¨‹ã€‚

## 1. éƒ¨ç½²å•é¡µåº”ç”¨


å•é¡µåº”ç”¨ï¼Œä¸€èˆ¬ä½¿ç”¨ä¸€ç§æˆ–å¤šç§å‰ç«¯æ¡†æ¶ï¼Œåœ¨å‘å¸ƒä¸Šçº¿æ—¶ï¼Œä¸€èˆ¬ä¼šæ‰“åŒ…ï¼ˆwebpack + babelï¼‰ä¸ºæœ€ä¼˜åŒ–çš„é™æ€èµ„æºï¼Œç„¶åä½¿ç”¨å•ç‹¬çš„æœåŠ¡å™¨ï¼ˆnginxï¼‰æ¥æŒ‚è½½è¯¥èµ„æºã€‚

- é¦–å…ˆæˆ‘ä»¬æ¥æ‰“åŒ…èµ„æº

å‡è®¾æˆ‘ä»¬çš„é¡¹ç›®å« opsï¼Œå…¶ä¸­ package.json æ˜¯è¿™ä¹ˆå†™çš„ï¼š

```sh
"build": "react-scripts build",
```

åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸­å†™ä¸€ä¸ªè„šæœ¬ç”¨äºæ‰“åŒ…æ–‡ä»¶ï¼šbuild.shï¼š

```sh
## æ‰“åŒ…çš„è„šæœ¬ï¼ˆåªå±•ç¤ºå¿…è¦æ­¥éª¤ï¼‰
#!/usr/bin/env bash

## æ¥å— ENV
env=$1

## è¿™é‡Œå¯ä»¥åŒºåˆ†å¼€å‘å’Œçº¿ä¸Šçš„ä¸åŒenvé…ç½®æ–‡ä»¶ï¼Œä¸€èˆ¬æ˜¯è¯·æ±‚çš„èµ„æºå’ŒAPIçš„urlä¸åŒ
if [ $env = "pre" ];then
    cp .env_pre .env
elif [ $env = "prod" ];then
    cp .env_prod .env
else
    exit 1
fi

# yarnæ‰“åŒ…
yarn build

# æ‰“åŒ…dockeré•œåƒ
# é»˜è®¤æ¨é€åˆ° hub.xxx.com/ops

time=$(date "+%Y%m%d%H%M%S")
tag="$time"

app_name=ops"_""$env"
default_registry=hub.xxx.com
default_project=ops
default_user=admin
default_pwd=xxxxxxxx
dockerfile=Dockerfile
nginx_conf="./scripts/nginx_""$env"".conf"

echo $(date "+%Y-%m-%d %H:%M:%S")-å¼€å§‹åˆ¶ä½œé•œåƒ
docker build --platform linux/amd64 --rm --build-arg NGINX_CONF=$nginx_conf -t $app_name:latest . 
echo $(date "+%Y-%m-%d %H:%M:%S")-é•œåƒåˆ¶ä½œå®Œæˆ

echo $(date "+%Y-%m-%d %H:%M:%S")-å¼€å§‹æ‰“tag
docker tag $app_name:latest $default_registry/$default_project/$app_name\:$tag
echo $(date "+%Y-%m-%d %H:%M:%S")-æ‰“tagå®Œæˆ

echo $(date "+%Y-%m-%d %H:%M:%S")-å¼€å§‹pushé•œåƒ
docker login -u $default_user -p $default_pwd $default_registry
docker push $default_registry/$default_project/$app_name\:$tag
echo $(date "+%Y-%m-%d %H:%M:%S")-pushé•œåƒå®Œæˆ

echo $(date "+%Y-%m-%d %H:%M:%S")-åˆ é™¤æœ¬åœ°é•œåƒ
docker rmi $app_name\:latest
docker rmi $default_registry/$default_project/$app_name\:$tag

echo "æ‰§è¡Œå‘å¸ƒè„šæœ¬è¯·è¾“å…¥tagï¼š"
echo $tag
```
å…¶ä¸­ docker çš„ç™»å½•ç”¨æˆ·åå¯†ç éœ€è¦è‡ªå·±é…ç½®å³å¯ã€‚ Dockerfileå¦‚ä¸‹ï¼š

```
FROM nginx:1.19.1
ARG NGINX_CONF=""

# æœåŠ¡å™¨ä¸Šèµ„æºçš„åœ°å€
WORKDIR /data/ops

# å¾€ç›®å½•é‡Œæ‹·è´æ‰“åŒ…çš„æ–‡ä»¶å¤¹ buildï¼Œè¿™æ˜¯æœ€å…³é”®çš„ä¸€æ­¥
ADD build build

# è¿™é‡Œåœ¨dockeré‡Œæ‰§è¡Œäº†nginxé…ç½®ï¼Œè¿™é‡Œä¸ä½¿ç”¨é»˜è®¤é…ç½®
COPY ./scripts/run.sh ./
COPY "${NGINX_CONF}" /etc/nginx/conf.d/default.conf

EXPOSE 80
ENTRYPOINT ["sh", "./run.sh"]  
```
ä¸Šè¾¹æ‰§è¡Œçš„ run.sh è„šæœ¬æˆ‘è¿™é‡Œæ˜¯ä»å®¢æˆ·ç«¯æ‹·è´åˆ°äº†æœåŠ¡å™¨ä¸Šï¼Œå½“ç„¶ä¹Ÿå¯ä»¥ç›´æ¥å†™åœ¨æœåŠ¡å™¨ä¸­ï¼Œå…¶ä½œç”¨æ˜¯å¯åŠ¨dockeré•œåƒä¸Šçš„ nginxï¼ˆå®‰è£…ç›®å½• /etc/init.d/nginxï¼Œnginxé…ç½®è¿™é‡Œçœç•¥ï¼‰ã€‚run.sh å¦‚ä¸‹ï¼š

```sh
#!/usr/bin/env bash

#start udnr web...
/etc/init.d/nginx start
```

å…¶ä¸­æœ¬åœ°çš„ nginxé…ç½®æ–‡ä»¶ `nginx_conf="./scripts/nginx_""$env"".conf"` æ˜¯ç”¨äº docker å®¹å™¨å†…éƒ¨çš„ nginxï¼Œè¦†ç›–é»˜è®¤é…ç½®ã€‚è¿™é‡Œæˆ‘é…ç½®äº†æœåŠ¡çš„è¯·æ±‚è·¯å¾„ä»¥åŠå¼€å‘ç¯å¢ƒå’Œç”Ÿäº§ç¯å¢ƒçš„è¯·æ±‚APIåœ°å€çš„åå‘ä»£ç†ï¼Œè¿™é‡Œä¸è¿‡å¤šå±•å¼€ï¼š

```sh
## ./scripts/nginx_prod.conf ä¸ºä¾‹
upstream dashboard {
    server 10.69.164.xxx:21001;
}

...

location / {
    try_files   /index.html =404;
    root        /data/ops/build;
}

location ~ .*.(js|gif|png|map|jpg|css|ico|html|less)$ {
    root            /data/ops/build;
    proxy_redirect  off;
    expires         30d;
    error_page 405  =200 http://$host$request_uri;
}

location /dashboard {
    proxy_pass         http://dashboard/;
    proxy_set_header   Host $Host;
}
```

build.sh è„šæœ¬æ‰§è¡Œå®Œæ¯•åï¼Œä¼šç”Ÿæˆä¸€ä¸ªæŒ‚è½½äº†é¡¹ç›®buildèµ„æºçš„Dockeré•œåƒï¼Œå¹¶è¾“å‡ºäº†å…¶ Tagã€‚

- æ¥ä¸‹æ¥æˆ‘ä»¬æ¥éƒ¨ç½²è¿™ä¸ª docker é•œåƒ

åˆšåˆšçš„æ“ä½œéƒ½æ˜¯åœ¨å®¢æˆ·ç«¯æ“ä½œçš„ï¼ˆå¯ä»¥æ‰‹åŠ¨æ‰§è¡Œè„šæœ¬ï¼Œä¹Ÿå¯ä»¥å†™åœ¨CIé‡Œï¼‰ã€‚ç°åœ¨æˆ‘ä»¬ç™»å½•æœåŠ¡å™¨ï¼š

```sh
ssh root@172.xx.xxx.72

cd /data/ops/
```

å…¶ä¸­ deploy.shï¼š

```sh
#!/bin/bash
if [ ! -n "$1" ]
then
echo "You should give me a image tag."
else
echo "The image tag is $1"

oldtag=`cat .env`

## è·å–ä¸Šä¸€æ¬¡æˆåŠŸçš„tagï¼Œä¾¿äºåœ¨æ‰“åŒ…å¤±è´¥æ—¶åŠæ—¶å›é€€
echo "The old image tag is $oldtag"

path=$(pwd)

# è®°å½•æ–°çš„tagåˆ°å®¹å™¨çš„.envä¸­
sed -i "s/$oldtag/TAG=$1/g" $path/.env

# docker-compose config
docker login -u ops -p ä½ çš„å¯†ç  hub.xxx.com
# é‡æ–°å¯åŠ¨å®¹å™¨ï¼Œå› ä¸º build æ–‡ä»¶å¤¹æ›¿æ¢äº†ï¼Œæ‰€ä»¥æ˜¯æœ€æ–°çš„æ‰“åŒ…ä¿¡æ¯
docker-compose up -d

fi
```

ç°åœ¨åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œï¼š

```sh
sh deploy.sh tagåç§°
```
æ­¤æ—¶åœ¨æœåŠ¡å™¨ä¸Šå°±å¯åŠ¨èµ·æ¥äº†ä¸€ä¸ªå‰ç«¯å•é¡µåº”ç”¨äº†ï¼Œå¯ä»¥é€šè¿‡ip+ç«¯å£å·æ¥è®¿é—®äº†ã€‚


## 2. éƒ¨ç½²SSRåº”ç”¨

SSRå‰ç«¯æ¡†æ¶æˆ‘ä»¬ä»¥ nextjs ä¸ºä¾‹æ¥è®²ä¸€ä¸‹å¦‚ä½•ä¸ docker ç»“åˆéƒ¨ç½²ã€‚

- é¦–å…ˆæ¥éƒ¨ç½²æ‰“åŒ…åº”ç”¨

å‡è®¾é¡¹ç›®çš„ package.jsonæ˜¯è¿™ä¹ˆå†™çš„ï¼š

```json
"scripts": {
    "build": "next build --profile",
    "start": "next start",
}
```
nextjséƒ¨ç½²åˆ°æœåŠ¡å™¨æ—¶ï¼Œéœ€è¦å…ˆ `yarn build`ï¼Œç„¶ååœ¨æ‰“å¥½åŒ…çš„ .next åŒç›®å½•ä¸Šæ‰§è¡Œ `yarn start` ä»¥æ­¤æ¥å¯åŠ¨ä¸€ä¸ªå°å‹çš„SSRç›´å‡ºæœåŠ¡å™¨ã€‚

æ˜ç™½äº†è¿™ä¸ªåï¼Œæˆ‘ä»¬é¦–å…ˆæ¥æ‰“åŒ…ã€‚æ‰“åŒ…çš„æ“ä½œé™¤äº†å†™åœ¨shellé‡Œï¼Œä¹Ÿå¯ä»¥ç›´æ¥å†™åœ¨ Dockerfile é‡Œï¼š

```
# å®‰è£…ä¸€äº›linuxç³»ç»Ÿå¿…é¡»çš„ä¾èµ–å’Œé…ç½®ç¯å¢ƒï¼Œå¹¶ä¸ºä¸‹ä¸€æ­¥buildå®‰è£…node_modules
FROM node:16-alpine AS deps
RUN apk add --no-cache libc6-compat
WORKDIR /app
COPY package.json yarn.lock ./
RUN yarn install --frozen-lockfile

# æ‹·è´æ‰“åŒ…éœ€è¦çš„èµ„æºï¼Œæ‰§è¡Œbuildã€‚é»˜è®¤çš„ï¼Œbuildå®Œåï¼Œå½“å‰ç›®å½•ä¸‹ä¼šæœ‰ä¸€ä¸ª.nextç›®å½•ç”Ÿæˆ
FROM node:alpine AS builder
WORKDIR /app
COPY . .
COPY --from=deps /app/node_modules ./node_modules
RUN yarn build && yarn install --production --ignore-scripts --prefer-offline

# æ·»åŠ ç”¨æˆ·ç»„
FROM node:alpine AS runner
WORKDIR /app

ENV NODE_ENV production
RUN addgroup -g 1001 -S nodejs
RUN adduser -S nextjs -u 1001

# æ‰“åŒ…ä»¥åï¼Œä¸€äº›é…ç½®æ–‡ä»¶åœ¨æ‰“åŒ…çš„ç›®å½•ä¸‹æ²¡æœ‰ï¼Œéœ€è¦æ‰‹åŠ¨copy
COPY --from=builder /app/next.config.js ./                      # nextçš„é…ç½®æ–‡ä»¶
COPY --from=builder /app/next-i18next.config.js ./              # å¦‚æœéœ€è¦next-i18nextæ”¯æŒï¼Œè¿™é‡Œä¹Ÿéœ€è¦æ‹·è´è‡ªå·±åœ¨æ ¹ç›®å½•æ”¾ç½®çš„é…ç½®æ–‡ä»¶

COPY --from=builder --chown=nextjs:nodejs /app/public ./public  # å…¬å…±èµ„æº
COPY --from=builder --chown=nextjs:nodejs /app/.next ./.next    # æ‰“åŒ…åçš„æºä»£ç 
COPY --from=builder /app/node_modules ./node_modules            # å®‰è£…å¥½çš„ä¾èµ–
COPY --from=builder /app/package.json ./package.json            # åŒ…ä¿¡æ¯
```

å¯ä»¥çœ‹åˆ° docker æ˜¯å¾ˆå¼ºå¤§çš„ï¼Œä¸€ä¸ªæ–‡ä»¶å°±æŠŠä¾èµ–å®‰è£…ã€buildå’Œèµ„æºæ‹·è´å®Œæˆäº†ã€‚

- æ¥ä¸‹æ¥æ˜¯å¯åŠ¨æ‰“åŒ…çš„é¡¹ç›®

ç”±äºnextjså†…ç½®çš„nodeæœåŠ¡ï¼Œç›´æ¥å¯ä»¥ `next start` å¯åŠ¨ï¼Œæ•…ä¸éœ€è¦é¢å¤–é…ç½® nginxã€‚å¯ä»¥åœ¨ä¸Šè¾¹çš„Dockerfile é‡Œè¿½åŠ å¯åŠ¨çš„æŒ‡ä»¤ï¼š

```
# ä½¿ç”¨åˆšåˆšæ·»åŠ çš„ç”¨æˆ·
USER nextjs

# æš´éœ²dockerç«¯å£3000
EXPOSE 3000

ENV PORT 3000

# æ‰§è¡Œ yarn start
CMD ["yarn", "start"]
```
åˆ°æ­¤ï¼Œä¸€ä¸ª nextjs åº”ç”¨å°±åœ¨æœåŠ¡å™¨çš„ 3000 ç«¯å£å¯åŠ¨èµ·æ¥äº†ã€‚


----


æµç¨‹æ€»ç»“å¦‚ä¸‹ï¼š

1. ä½¿ç”¨dockeræˆ–è€…shellè¿›è¡Œæ‰“åŒ…ï¼Œè·å–æ‰“åŒ…çš„èµ„æºæ–‡ä»¶ç›®å½•
2. å°†èµ„æºæ–‡ä»¶ã€é…ç½®é¡¹ã€ä¾èµ–ç­‰æ‹·è´åˆ°dockerå®¹å™¨ä¸­è‡ªå®šä¹‰çš„å·¥ä½œç›®å½•ä¸‹
3. åœ¨dockerè¯¥å·¥ä½œç›®å½•ä¸‹æ‰§è¡ŒæŒ‡ä»¤å¯åŠ¨dockerä¸­çš„nginxæˆ–è€…å…¶ä»–çš„æœåŠ¡å™¨

åˆ°è¿™é‡Œï¼Œå‰ç«¯é¡¹ç›®éƒ¨ç½²å°±å®Œæˆäº†ï¼Œæ˜¯ä¸æ˜¯å¾ˆç®€å•ï¼Ÿå¦‚æœæƒ³è¦çœ‹ä¸CI/CDç»“åˆçš„è‡ªåŠ¨åŒ–éƒ¨ç½²æµç¨‹ï¼Œå¯ä»¥çœ‹æˆ‘ä¹‹å‰è®²è¿° gitlab CI çš„æ–‡ç« ã€‚2b:T104a,æœ€è¿‘åœ¨å¼€å‘è‡ªå·±è‡ªå»ºçš„ç±»åº“å’Œç»„ä»¶åº“ï¼Œæ¶‰åŠåˆ°å„ç§åŒ…ç‰ˆæœ¬çš„ç®¡ç†é—®é¢˜ã€‚åœ¨è¿™é‡Œè®°å½•ä¸€ä¸‹æˆ‘æ˜¯æ€ä¹ˆç®¡ç†è‡ªå·±è‡ªå·±å¼€å‘åº“çš„ç‰ˆæœ¬çš„ã€‚


## 1. éœ€è¦è§£å†³çš„é—®é¢˜

1. åŒä¸€å¥—ç±»åº“éœ€è¦å‘å¸ƒä¸åŒçš„å¯å®‰è£…ç‰ˆæœ¬
2. éœ€è¦åŒºåˆ†ç¨³å®šç‰ˆå’Œæµ‹è¯•ç‰ˆ


## 2. å»ºç«‹ä¸€ä¸ªåº“

æˆ‘è¿™ä¸ªåº“æ˜¯ç»™å†…éƒ¨å¾®æœåŠ¡æ§åˆ¶å°æä¾›å…¬å…±ä¾èµ–çš„ï¼Œç”¨äºç»Ÿä¸€ç®¡ç†ä¾èµ–çš„ç‰ˆæœ¬ã€‚ç›®å½•ä¸€ç»“æ„å¦‚ä¸‹ï¼š

![image.png](/img/posts/2022-12-1/2022-12-1-1.png)

å®ç°åŠŸèƒ½å¾ˆç®€å•ï¼Œé€šè¿‡åœ¨é¡¹ç›®ä¸­å®‰è£…è¿™ä¸ªåº“ï¼Œå¯ä»¥è·å¾—ä¸€å¥—å®Œæ•´çš„ä¾èµ–åŒ…å’Œwebpacké…ç½®æ–‡ä»¶ï¼Œè¾…åŠ©ä»¥ cli å‘½ä»¤è¡Œå·¥å…·åŠ æŒï¼Œå°±å¯ä»¥èµ·åˆ°åŒæ—¶ç®¡ç† å…¬å…±ä¾èµ–å’Œwebpackå…¬å…±é…ç½®çš„æ•ˆæœã€‚

æ¥ä¸‹æ¥çœ‹çœ‹åœ¨å­åº”ç”¨ä¸­çš„ä½¿ç”¨ï¼š


![image.png](/img/posts/2022-12-1/2022-12-1-2.png)

æ¥ç€åªéœ€ yarn ä¸€ä¸‹å°±å¯ä»¥å®‰è£…ä¸Šä¾èµ–äº†ã€‚ç”±äºæœ¬æœŸè®²çš„æ˜¯è¿™ä¸ªåŒ…å¦‚ä½•å‘å¸ƒä¸åŒçš„ç‰ˆæœ¬ï¼Œæ•…ä¸Šè¿°é…ç½®ä¸åšè¯¦ç»†è¯´æ˜ï¼Œå¦‚æœæœ‰å¯¹ å‰ç«¯å‘½ä»¤è¡Œå·¥å…·ï¼ˆcliï¼‰æ„Ÿå…´è¶£çš„ï¼Œå¯ä»¥æœŸå¾…æˆ‘åæœŸçš„æ–‡ç« ã€‚

## 3. æ‰“ä¸€ä¸ªç‰ˆæœ¬

æ‰§è¡Œå¦‚ä¸‹æŒ‡ä»¤ï¼š

```shell
# å¯é€‰ (minor / major)
npm version patch
```
è¿™ä¸ªæƒ³å¿…å¤§å®¶éƒ½çŸ¥é“ï¼Œnpm åŒ…çš„ç‰ˆæœ¬æ˜¯ä¸‰æ®µå¼çš„ï¼Œä¸­é—´ä»¥ . éš”å¼€ï¼Œä»å·¦å¾€å³åˆ†åˆ«æ˜¯ major(ä¸»ç‰ˆæœ¬)ã€minorï¼ˆå°ç‰ˆæœ¬ï¼‰ã€patchï¼ˆè¡¥ä¸åŒ…ï¼‰ã€‚

æ‰§è¡Œå®ŒæŒ‡ä»¤åå¯ä»¥çœ‹åˆ°ç‰ˆæœ¬å·çš„ç¬¬ä¸‰æ®µè‡ªå¢äº†ï¼š


![image.png](/img/posts/2022-12-1/2022-12-1-3.png)

æ¥ä¸‹æ¥å‘å¸ƒnpmï¼Œè¿™é‡Œéœ€è¦æå‰ç™»å½•npmï¼Œå¤§å®¶éƒ½ä¼šï¼Œä¸åšè¿‡å¤šè®¨è®ºï¼Œç½‘ä¸Šå¾ˆå¤šè¯´æ˜äº†ï¼š

```shell
npm publish
```

å‘å¸ƒå®Œä»¥åï¼Œä½ æ‰€é…ç½®çš„npmä»“åº“é‡Œå°±æœ‰äº†ä½ è¿™ä¸ªé¡¹ç›®çš„ç‰ˆæœ¬äº†ã€‚

æ¥ä¸‹æ¥åœ¨å…¶ä»–é¡¹ç›®æ ¹ç›®å½•é‡Œï¼š

```shell
yarn add -D @xxx/xxx-console-dev-libs
```
å¦‚æ­¤ä¾¿å®‰è£…äº†ä¸€ä¸ªæ­£å¼å‘å¸ƒçš„ç‰ˆæœ¬äº†ã€‚

## 4. æ­£å¼ç‰ˆä¸æµ‹è¯•ç‰ˆ

### æ­£å¼ç‰ˆ

æˆ‘ä»¬åœ¨ä¸€ä¸ªæ–°åˆ›å»ºçš„çº¯å‡€é¡¹ç›®é‡Œæ‰§è¡Œå¦‚ä¸‹æŒ‡ä»¤æŸ¥çœ‹å½“å‰é¡¹ç›®å…¨éƒ¨npmç‰ˆæœ¬ï¼š

```shell
npm dist-tag ls
```
å¯ä»¥çœ‹åˆ°å¦‚ä¸‹æ˜¾ç¤ºï¼š

![image.png](/img/posts/2022-12-1/2022-12-1-4.png)

latestç‰ˆæœ¬å°±æ˜¯æˆ‘ä»¬åœ¨ä¸Šè¾¹å‘å¸ƒçš„é‚£ç§æ­£å¼ç‰ˆï¼Œé»˜è®¤å®‰è£…æ—¶ä¸éœ€è¦å¸¦ç€ç‰ˆæœ¬å·ï¼Œé»˜è®¤ä¼šå»æ‹¿ latestã€‚é‚£å¦‚æœéœ€è¦å®‰è£…å¾€æœŸçš„æ­£å¼ç‰ˆæœ¬ï¼Œå¯ä»¥å¦‚ä¸‹ï¼š

```shell
yarn add @xxx/xxx-console-dev-libs@1.0.8
```

### æµ‹è¯•ç‰ˆ

npm ä¼šæœ‰å†…ç½®çš„ä»£è¡¨ç‰ˆæœ¬æµ‹è¯•çš„åç§°ç¬¦å·ã€‚ä¸€ä¸ªè½¯ä»¶åœ¨æ­£å¼å‘å¸ƒå‰ï¼Œéƒ½ä¼šæœ‰ `alpha`, `beta` ç‰ˆï¼Œåˆ†åˆ«ä»£è¡¨å†…æµ‹ç‰ˆå’Œå…¬æµ‹ç‰ˆï¼ŒnpmåŒ…ä¹Ÿæ˜¯è½¯ä»¶ï¼Œä¹Ÿä¸ä¾‹å¤–ã€‚

å¦‚æœç±»åº“å¼€å‘åˆ°æŸä¸€ä¸ªç¨‹åº¦ï¼Œæƒ³è®©å†…éƒ¨çš„äººè¯•ä¸€ä¸‹ï¼Œåˆä¸æƒ³å½±å“è‡ªåŠ¨åŒ–éƒ¨ç½²ä¸­å®‰è£…çš„ç‰ˆæœ¬çš„è¯ï¼Œå¯ä»¥è¿™æ ·ï¼š

```shell
npm version 1.0.13-alpha.0

npm publish --tag alpha
```

æ­¤æ—¶ package.json ä¸­çš„ç‰ˆæœ¬ä¼šå˜æˆï¼š

![image.png](/img/posts/2022-12-1/2022-12-1-5.png)

è¿™ä¾¿æ˜¯ä¸€ä¸ªå†…æµ‹ç‰ˆäº†ï¼Œå†…æµ‹ç”¨æˆ·æ‰§è¡Œå¦‚ä¸‹æŒ‡ä»¤ä¾¿å¯ä»¥å®‰è£… alpha çš„æœ€æ–°æµ‹è¯•ç‰ˆï¼š

```shell
yarn add @xxx/xxx-console-dev-libs@alpha
```

å†…æµ‹ç‰ˆä¹Ÿå¯ä»¥æ›´æ–°ï¼š

```shell
npm version prerelease --preid alpha

npm publish --tag alpha
```

å¯ä»¥çœ‹åˆ°ç‰ˆæœ¬ä¹Ÿæ˜¯é€’å¢çš„ï¼š

![image.png](/img/posts/2022-12-1/2022-12-1-6.png)

åŒç†ï¼Œå…¬æµ‹ç‰ˆä¹Ÿä¸€æ ·ï¼š

```shell
// æ‰“ç‰ˆæœ¬
npm version 1.0.13-beta.0 
// æ‰“tag
npm publish --tag beta
// æ›´æ–°ç‰ˆæœ¬
npm version prerelease --preid beta
```

> ä¸Šé¢æ‰“ tag æ˜¯ä¸ºäº† npm dist-tag èƒ½å¤ŸæŸ¥åˆ°å¯¹åº”çš„ç‰ˆæœ¬ï¼Œä»¥æ­¤æ¥åŒºåˆ†å®‰è£…ã€‚å‚æ•° preid è¡¨ç¤ºé¢„å‘çš„æ˜¯alpha/bataçš„æµ‹è¯•ç‰ˆ

æœ€ååˆ«å¿˜äº† git æ¨é€çš„æ—¶å€™æ‰“ä¸Š tagï¼Œè¿™æ ·ä¾¿äºç®¡ç†ï¼š

```shell
git push --tags
```

çœ‹ä¸€ä¸‹æˆ‘å®é™…å¼€å‘çš„ä»“åº“é‡Œçš„ç‰ˆæœ¬(npm dist-tag ls)ï¼š

![image.png](/img/posts/2022-12-1/2022-12-1-7.png)

> æµ‹è¯•ç‰ˆè¿˜å¯ä»¥ npm version prepatch æ¥å‘å¸ƒï¼ŒåŸç†ä¸€æ ·ï¼š1.0.1 --> 1.0.1-0


æœ€åä¸€ä¸ªé—®é¢˜ï¼Œä¸€ä¸ªæµ‹è¯•ç‰ˆå¦‚æœæƒ³è¦è½¬æ­£ï¼Œå¯ä»¥æ‰§è¡Œå¦‚ä¸‹æŒ‡ä»¤ï¼š

```shell
npm version minor
```
> è‹¥ä½ ä¹‹å‰æ˜¯åœ¨ 12 ç‰ˆæœ¬ç›´æ¥å‡ä¸Šçš„ 13.beta, è¿™é‡Œå¯ä»¥ patch å°±è¡Œ

ä¹‹å‰ï¼š

![image.png](/img/posts/2022-12-1/2022-12-1-8.png)

ä¹‹åï¼š

![image.png](/img/posts/2022-12-1/2022-12-1-9.png)

-----

å®Œ ï¼2c:T519e,React Router v6ç‰ˆæœ¬ï¼Œå¬è¯´åˆæ›´æ–°äº†ä¸€ç‰ˆï¼Œå®˜ç½‘æ–‡æ¡£ä¹Ÿæ›´æ–°äº†ï¼ˆ6.4.2ï¼‰ã€‚è¿™é‡Œå°±æ±‡æ€»ç¿»è¯‘ä¸€ä¸‹æ–‡æ¡£æ›´æ–°çš„å†…å®¹ã€‚

äº†è§£å…¶ä»– React Router v6 çš„å®˜ç½‘æ–‡æ¡£ï¼Œå¯ä»¥çœ‹æˆ‘æœ¬ä¸“æ å¾€æœŸçš„æ–‡ç« ã€‚

## 1. å…³äº Routers

APIåˆ›å»ºrouterå¯¹è±¡ï¼š

### createBrowserRouter

ç±»å‹å®šä¹‰ï¼š

```js
function createBrowserRouter(
  routes: RouteObject[],
  opts?: {
    basename?: string;
    window?: Window;
  }
): RemixRouter;
```

è¿™ä¸ª API ç”¨äºä½¿ç”¨jsä»£ç åˆ›å»ºä¸€ä¸ª History routerã€‚ç¬¬äºŒä¸ªå±æ€§æ˜¯å¯é€‰å‚æ•°ï¼š

- basenameï¼šç›¸å¯¹è·¯ç”±æ ¹åœ°å€
- windowï¼šé‡æ–°æŒ‡å®šwindowå¯¹è±¡ï¼Œå¸¸ç”¨äºæµ‹è¯•ç¯å¢ƒæˆ–è€…éæµè§ˆå™¨ç¯å¢ƒ

ä½¿ç”¨æ–¹å¼å¦‚ä¸‹ï¼š


```js
import {
  createBrowserRouter,
  RouterProvider,
} from "react-router-dom";

const router = createBrowserRouter([
  {
    path: "/",
    element: <Root />,
    loader: rootLoader,
    children: [
      {
        path: "team",
        element: <Team />,
        loader: teamLoader,
      },
    ],
  },
]);

ReactDOM.createRoot(document.getElementById("root")).render(
  <RouterProvider router={router} />
);
```

### createHashRouter

ä½¿ç”¨æ–¹å¼åŒ createBrowserRouterï¼Œåˆ›å»ºä¸€ä¸ªåŸºäºé”šç‚¹å¯¼èˆªçš„ routerã€‚

### createMemoryRouter

memory routeræ˜¯ä¸€ä¸ªèƒ½å¤Ÿè‡ªå·±ç®¡ç† history stack çš„ History routerã€‚å¸¸ç”¨äºå¼€å‘å·¥å…·ï¼ˆä¾‹å¦‚StoryBookï¼‰. æµ‹è¯•æˆ–éæµè§ˆå™¨ç¯å¢ƒã€‚

ç±»å‹å®šä¹‰ï¼š

```js
function createMemoryRouter(
  routes: RouteObject[],
  opts?: {
    basename?: string;
    initialEntries?: InitialEntry[];
    initialIndex?: number;
    window?: Window;
  }
): RemixRouter;
```

ä½¿ç”¨æ–¹å¼ï¼š

```js
import {
  RouterProvider,
  createMemoryRouter,
} from "react-router-dom";
import * as React from "react";
import {
  render,
  waitFor,
  screen,
} from "@testing-library/react";
import "@testing-library/jest-dom";
import CalendarEvent from "./routes/event";

test("event route", async () => {
  const FAKE_EVENT = { name: "test event" };
  const routes = [
    {
      path: "/events/:id",
      element: <CalendarEvent />,
      loader: () => FAKE_EVENT,
    },
  ];

  const router = createMemoryRouter(routes, {
    initialEntries: ["/", "/events/123"],
    initialIndex: 1,
  });

  render(<RouterProvider router={router} />);

  await waitFor(() => screen.getByRole("heading"));
  expect(screen.getByRole("heading")).toHaveTextContent(
    FAKE_EVENT.name
  );
});
```

å…¶ä¸­çš„å‚æ•°ï¼š

- initialEntriesï¼šåˆå§‹åŒ–çš„ history stack
- initialIndexï¼šåˆå§‹åŒ–æ˜¾ç¤ºçš„ history stack çš„ä¸‹æ ‡


### RouterProvider

ç»™ä¸Šè¿°åˆ›å»ºrouterçš„APIæä¾›ä¸€ä¸ªå®¹å™¨ã€‚å…¶æœ‰ç¬¬äºŒä¸ªå‚æ•° `fallbackElement={<SpinnerOfDoom />}`ï¼Œå¯ä»¥æä¾›ä¸€ä¸ªåœ¨è·¯ç”±åŠ è½½è¿‡ç¨‹ä¸­ loadingçš„è‡ªå®šä¹‰ç»„ä»¶ã€‚

## 2. å…³äº Route ç»„ä»¶

### æ·»åŠ æ–°å±æ€§ loader

è·¯ç”±åœ¨æ¸²æŸ“ä¹‹å‰åŠ è½½çš„åŠ è½½å™¨ã€‚å½“è·¯ç”±è·³è½¬æ—¶ï¼Œloaderå‡½æ•°ä¼šå¼‚æ­¥çš„æ‰§è¡Œï¼Œå¹¶ä¸”åœ¨ç›®æ ‡è·¯ç”±ç»„ä»¶ä¸­å¯ä»¥è·å–åˆ°ã€‚

ä½¿ç”¨æ–¹å¼ï¼š
```js
 {
    element: <Team />,
    path: ":teamId",
    loader: async ({ params }) => {
      return fetch(`/api/teams/${params.teamId}.json`);
    },
  },
```

å‚æ•° params æ˜¯è·¯ç”±å‚æ•°ã€‚å¯ä»¥è¿”å›ä»»ä½•ä½ æƒ³è¦çš„å†…å®¹ï¼Œæ¨èä½¿ç”¨ fetch æˆ–è€… Promiseã€‚

loader åŠ è½½çš„æ•°æ®å¯ä»¥åœ¨è·³è½¬ä¹‹åçš„ç•Œé¢ é€šè¿‡ useLoaderData è·å–ã€‚ä½¿ç”¨æ–¹å¼è§ä¸‹é¢ hooks çš„æ›´æ–°å†…å®¹ã€‚

### æ·»åŠ æ–°å±æ€§ action

æä¾›ä¸€ç§è·¯ç”±åˆ‡æ¢æ—¶è§¦å‘çš„æ–¹æ³•ã€‚è¯¥æ–¹å¼å…è®¸åœ¨è·¯ç”±è·³è½¬æ—¶æ¨é€ä¸€ä¸ª ajax è¯·æ±‚å‡ºå»ã€‚

ä½¿ç”¨æ–¹å¼ï¼š

```js
// å®šä¹‰
<Route
  path="/song/:songId/edit"
  element={<EditSong />}
  action={async ({ params, request }) => {
    let formData = await request.formData();
    return fakeUpdateSong(params.songId, formData);
  }}
  loader={({ params }) => {
    return fakeGetSong(params.songId);
  }}
/>

// forms
<Form method="post" action="/songs" />;
<fetcher.Form method="put" action="/songs/123/edit" />;

// imperative submissions
let submit = useSubmit();
submit(data, {
  method: "delete",
  action: "/songs/123",
});
fetcher.submit(data, {
  method: "patch",
  action: "/songs/123/edit",
});

```

è§¦å‘æ–¹å¼ä¸ºéGETç±»çš„è¯·æ±‚ï¼Œå¹¶æä¾›ä¸¤ä¸ªå‚æ•°ï¼š

- params è·¯ç”±åŠ¨æ€å‚æ•°
- request fetchè¯·æ±‚çš„å®ä¾‹

### errorElement

åªé€‚ç”¨äºAPIåŠ¨æ€åˆ›å»ºçš„routerã€‚ä½¿ç”¨æ–¹å¼ï¼š
```jsx
<Route
  path="/invoices/:id"
  // if an exception is thrown here
  loader={loadInvoice}
  // here
  action={updateInvoice}
  // or here
  element={<Invoice />}
  // this will render instead of `element`
  errorElement={<ErrorBoundary />}
/>;

function Invoice() {
  return <div>Happy {path}</div>;
}

function ErrorBoundary() {
  let error = useRouteError();
  console.error(error);
  // Uncaught ReferenceError: path is not defined
  return <div>Dang!</div>;
}
```
æä¾›ä¸€ç§è·¯ç”±è·³è½¬é”™è¯¯åçš„è¡¥æ•‘æ–¹æ¡ˆã€‚åœ¨action. loaderæˆ–è€…ç»„ä»¶æ¸²æŸ“è¿‡ç¨‹ä¸­æŠ›å‡ºé”™è¯¯åï¼Œå¯ä»¥åœ¨è¿™é‡Œæ•è·å¹¶ä»£æ›¿æ˜¾ç¤ºè‡ªå®šä¹‰çš„é”™è¯¯ç•Œé¢ã€‚

### shouldRevalidate

ä½œä¸ºä¸€ä¸ªä¼˜åŒ–é¡¹ï¼Œç”¨äºå¯¹loaderåšæ ¡éªŒã€‚ä»–æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œåœ¨è·¯ç”± loader è·å–æ•°æ®ä¹‹å‰è°ƒç”¨ï¼Œè¯¥å‡½æ•°è¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œå¦‚æœè¿”å›å¸ƒå°”å€¼ï¼Œæœ¬æ¬¡ loader å‡½æ•°å°†ä¸ä¼šè°ƒç”¨ï¼Œç•Œé¢æ•°æ®ä¸ä¼šæ”¹å˜ã€‚

ä½¿ç”¨æ–¹å¼ï¼š
```jsx
<Route
  path="meals-plans"
  element={<MealPlans />}
  loader={loadMealPlans}
  shouldRevalidate={({ currentUrl }) => {
    // only revalidate if the submission originates from
    // the `/meal-plans/new` route.
    return currentUrl.pathname === "/meal-plans/new";
  }}
>
  <Route
    path="new"
    element={<NewMealPlanForm />}
    // `loadMealPlans` will be revalidated after
    // this action...
    action={createMealPlan}
  />
  <Route
    path=":planId/meal"
    element={<Meal />}
    // ...but not this one because origin the URL
    // is not "/meal-plans/new"
    action={updateMeal}
  />
</Route>
```

## 3. å…³äºè·¯ç”±ç»„ä»¶

### Await

æ˜¯ä¸€ç§ç±»ä¼¼äº React è·¯ç”±æ‡’åŠ è½½ï¼ˆlazyï¼‰çš„å·¥å…·ã€‚ä½¿ç”¨æ–¹å¼å¦‚ä¸‹ï¼š

```jsx
import { Await, useLoaderData } from "react-router-dom";

function Book() {
  const { book, reviews } = useLoaderData();
  return (
    <div>
      <h1>{book.title}</h1>
      <p>{book.description}</p>
      <React.Suspense fallback={<ReviewsSkeleton />}>
        <Await
          resolve={reviews}
          errorElement={
            <div>Could not load reviews ğŸ˜¬</div>
          }
          children={(resolvedReviews) => (
            <Reviews items={resolvedReviews} />
          )}
        />
      </React.Suspense>
    </div>
  );
}
```

### Form

v6ç‰ˆè·¯ç”±ï¼Œå¯¹äº plain HTMLÂ form è¿›è¡Œäº†ä¸€ä¸ªåŒ…è£…ã€‚ç›®å‰ä»…ä»…åœ¨ä½¿ç”¨ API åˆ›å»ºè·¯ç”±å®ä¾‹çš„åœºæ™¯ä¸­ä½¿ç”¨ã€‚

```jsx
import { Form } from "react-router-dom";

function NewEvent() {
  return (
    <Form method="post" action="/events">
      <input type="text" name="title" />
      <input type="text" name="description" />
      <button type="submit">Create</button>
    </Form>
  );
}
```

å±æ€§å‚æ•°ä»‹ç»ï¼š

- actionï¼šform submit çš„ urlã€‚å’ŒåŸç”Ÿformå”¯ä¸€ä¸åŒçš„æ˜¯ï¼Œä»–çš„é»˜è®¤urlæ˜¯æœ€è¿‘åŒ¹é…åˆ°çš„ç›¸å¯¹è·¯ç”±
- methodï¼šè¡¨å•æäº¤çš„æ–¹æ³•
- replaceï¼šæ”¹å˜ history stack çš„åˆ‡æ¢æ–¹å¼
- relativeï¼šè®¾ç½®ç›¸å¯¹è·¯ç”±çš„æ ¹è·¯ç”±
- reloadDocumentï¼šè·³è¿‡ React Router å¹¶ä½¿ç”¨æµè§ˆå™¨çš„å†…ç½®è¡Œä¸ºæäº¤è¡¨å•

ç»¼åˆä½¿ç”¨æ¡ˆä¾‹ï¼š

> **æ€»ç»“**ï¼šaction å¯ä»¥æ¥å— element ç»„ä»¶ä¸­ä¼ å…¥çš„è¯·æ±‚å®ä¾‹ï¼Œåœ¨actionä¸­è¿›è¡Œä½¿ç”¨ã€‚è€Œç´§æ¥ç€ï¼Œelement ç»„ä»¶ä¸­ï¼Œåˆå¯ä»¥é€šè¿‡ useLoaderData ä½¿ç”¨ loader é‡ŒåŠ è½½è¿›æ¥çš„æ•°æ®ã€‚

```jsx
<Route
  path="/projects/:id"
  element={<Project />}
  loader={async ({ params }) => {
    return fakeLoadProject(params.id)
  }}
  action={async ({ request, params }) => {
    switch (request.method) {
      case "put": {
        let formData = await request.formData();
        let name = formData.get("projectName");
        return fakeUpdateProject(name);
      }
      case "delete": {
        return fakeDeleteProject(params.id);
      }
      default {
        throw new Response("", { status: 405 })
      }
    }
  }}
/>;

function Project() {
  let project = useLoaderData();

  return (
    <>
      <Form method="put">
        <input
          type="text"
          name="projectName"
          defaultValue={project.name}
        />
        <button type="submit">Update Project</button>
      </Form>

      <Form method="delete">
        <button type="submit">Delete Project</button>
      </Form>
    </>
  );
}
```

### ScrollRestoration

ç”¨äºåœ¨æµè§ˆå™¨ locationå˜åŒ–åï¼Œä¿æŒæ»šåŠ¨æ¡çš„ä½ç½®ã€‚ä»…ä»…åœ¨ API åˆ›å»ºè·¯ç”±å¯¹è±¡æ—¶æœ‰æ•ˆã€‚

æ¨èåœ¨æ ¹è·¯ç”±ä¸­ä½¿ç”¨ï¼Œä½¿ç”¨æ–¹å¼ï¼š

```jsx
import { ScrollRestoration } from "react-router-dom";

function RootRouteComponent() {
  return (
    <div>
      {/* ... */}
      <ScrollRestoration
        getKey={(location, matches) => {
          // default behavior
          return location.key;
        }}
      />
    </div>
  );
}
```

å‚æ•°ï¼š

- getKeyï¼šReact Router ç¼“å­˜æ»šåŠ¨ä½ç½®çš„key
- preventScrollResetï¼šå½“åˆ›å»ºä¸€ä¸ªæ–°çš„ scroll keyæ—¶ï¼Œé¡µé¢æ»šåŠ¨ä½ç½®ä¼šè¢«é‡ç½®åœ¨é¡¶éƒ¨ã€‚ä½ å¯ä»¥å°†è¯¥å‚æ•°è®¾ç½®ä¸º true æ¥é˜»æ­¢é¡µé¢è¢«é‡ç½®å›é¡¶éƒ¨

<hr />


## 4. Hooks

### useActionData

æä¾›ä¸Šä¸€ä¸ªè·³è½¬æ—¶ action çš„è¿”å›å€¼ã€‚å¦‚æœæ²¡æœ‰è¿”å›å€¼ï¼Œåˆ™æ˜¯ undefinedã€‚

ä½¿ç”¨æ–¹å¼ï¼ˆæœ€å¸¸ç”¨çš„å°±æ˜¯è¡¨å•éªŒè¯ï¼‰ï¼š

```jsx
import {
  useActionData,
  Form,
  redirect,
} from "react-router-dom";

export default function SignUp() {
  // 2. è·å– action è¿”å›å€¼
  const errors = useActionData();

  return (
    <Form method="post">
      <p>
        <input type="text" name="email" />
        {errors?.email && <span>{errors.email}</span>}
      </p>

      <p>
        <input type="text" name="password" />
        {errors?.password && <span>{errors.password}</span>}
      </p>

      <p>
        <button type="submit">Sign up</button>
      </p>
    </Form>
  );
}

export async function action({ request }) {
  const formData = await request.formData();
  const email = formData.get("email");
  const password = formData.get("password");
  const errors = {};

  // validate the fields
  if (typeof email !== "string" || !email.includes("@")) {
    errors.email =
      "That doesn't look like an email address";
  }

  if (typeof password !== "string" || password.length < 6) {
    errors.password = "Password must be > 6 characters";
  }

  // return data if we have errors
  if (Object.keys(errors).length) {
    // 1. action ä¸­ return ä¸€ä¸ªå¯¹è±¡ï¼Œè€Œä¸æ˜¯ redirect
    return errors;
  }

  // otherwise create the user and redirect
  await createUser(email, password);
  return redirect("/dashboard");
}
```

### useAsyncError

è¿”å› Await ç»„ä»¶ çš„rejectçš„å€¼ï¼š

```jsx
import { useAsyncError, Await } from "react-router-dom";

function ErrorElement() {
  const error = useAsyncError();
  return (
    <p>Uh Oh, something went wrong! {error.message}</p>
  );
}

<Await
  resolve={promiseThatRejects}
  errorElement={<ErrorElement />}
/>;
```

### useAsyncValue

è¿”å› Await ç»„ä»¶çš„ resolve å€¼ï¼š

```jsx
function ProductVariants() {
  const variants = useAsyncValue();
  return <div>{/* ... */}</div>;
}

// Await creates the context for the value
<Await resolve={somePromiseForProductVariants}>
  <ProductVariants />
</Await>;
```

### useFetcher

> useFetcherä»…ä»…åœ¨ä½¿ç”¨ API åˆ›å»ºrouterå®ä¾‹ä¸­æœ‰æ•ˆã€‚


å½“ä½ éœ€è¦ï¼š

- è·å–ä¸ UI è·¯ç”±æ— å…³çš„æ•°æ®ï¼ˆå¼¹å‡ºæ¡†. åŠ¨æ€è¡¨å•ç­‰ï¼‰
- æ— éœ€å¯¼èˆªå³å¯å°†æ•°æ®æäº¤çš„æ“ä½œï¼ˆå…±äº«ç»„ä»¶ï¼Œå¦‚å®æ—¶é€šè®¯æ³¨å†Œï¼‰
- å¤„ç†åˆ—è¡¨ä¸­çš„å¤šä¸ªå¹¶å‘æäº¤ï¼ˆå…¸å‹çš„â€œå¾…åŠäº‹é¡¹åº”ç”¨ç¨‹åºâ€åˆ—è¡¨ï¼Œæ‚¨å¯ä»¥åœ¨å…¶ä¸­å•å‡»å¤šä¸ªæŒ‰é’®ï¼Œå¹¶ä¸”æ‰€æœ‰æŒ‰é’®éƒ½åº”åŒæ—¶å¤„äºå¾…å¤„ç†çŠ¶æ€ï¼‰
- æ— é™æ»šåŠ¨å®¹å™¨

ç­‰ç­‰ï¼ŒuseFetcher å¯ä»¥å¸®åŠ©åˆ°ä½ ï¼š

```jsx
import { useFetcher } from "react-router-dom";

function SomeComponent() {
  const fetcher = useFetcher();

  // æäº¤åŠ¨ä½œ
  React.useEffect(() => {
    fetcher.submit(data, options);
    fetcher.load(href);
  }, [fetcher]);

  // å¯ä»¥ç›´æ¥è·å–æ•°æ®
  fetcher.state;
  fetcher.formData;
  fetcher.formMethod;
  fetcher.formAction;
  fetcher.data;

  // ä¸ä¼šè§¦å‘è·¯ç”±å¯¼èˆªçš„è¡¨å•
  return <fetcher.Form />;
}
```


fetchers æœ‰å¾ˆå¤šå†…ç½®çš„è¡Œä¸ºï¼š

- ä¸­æ–­æ—¶ï¼Œè‡ªåŠ¨å¤„ç†fetchå–æ¶ˆ
- ä½¿ç”¨ POST. PUT. PATCH. DELETE æäº¤æ—¶ï¼Œé¦–å…ˆè°ƒç”¨è¯¥æ“ä½œï¼š
    - æ“ä½œå®Œæˆåï¼Œé¡µé¢ä¸Šçš„æ•°æ®å°†é‡æ–°éªŒè¯ä»¥æ•è·å¯èƒ½å‘ç”Ÿçš„ä»»ä½•çªå˜ï¼Œè‡ªåŠ¨ä½¿æ‚¨çš„ UI ä¸æ‚¨çš„æœåŠ¡å™¨çŠ¶æ€ä¿æŒåŒæ­¥
- å½“å¤šä¸ª fetcher åŒæ—¶è¿è¡Œæ—¶ï¼Œå®ƒä¼šï¼š
    - åœ¨ä»–ä»¬æ¯æ¬¡ç™»é™†æ—¶æäº¤æœ€æ–°çš„å¯ç”¨æ•°æ®
    - ç¡®ä¿æ²¡æœ‰é™ˆæ—§çš„è´Ÿè½½è¦†ç›–æ›´æ–°çš„æ•°æ®ï¼Œæ— è®ºå“åº”è¿”å›çš„é¡ºåºå¦‚ä½•
- é€šè¿‡å‘ˆç°æœ€è¿‘çš„ errorElement æ¥å¤„ç†æœªæ•è·çš„é”™è¯¯ï¼ˆå°±åƒæ¥è‡ª \<Link> æˆ– \<Form> çš„æ­£å¸¸å¯¼èˆªï¼‰
- å¦‚æœæ‚¨çš„æ“ä½œ/åŠ è½½ç¨‹åºè¢«è°ƒç”¨è¿”å›é‡å®šå‘ï¼Œå°†é‡å®šå‘åº”ç”¨ç¨‹åºï¼ˆå°±åƒæ¥è‡ª \<Link> æˆ– \<Form> çš„æ­£å¸¸å¯¼èˆªä¸€æ ·ï¼‰



å…¶ä¸­å„ä¸ªå±æ€§çš„è®²è§£ï¼š

- `fetcher.state`: æäº¤çš„çŠ¶æ€ï¼Œæšä¸¾å¦‚ä¸‹ï¼š
    -   **idle**Â - nothing is being fetched.
    -   **submitting**Â - A route action is being called due to a fetcher submission using POST, PUT, PATCH, or DELETE
    -   **loading**Â - The fetcher is calling a loader (from aÂ `fetcher.load`) or is being revalidated after a separate submission orÂ `useRevalidator`Â call
- `fetcher.Form`: ä¸ä¼šå¯¼èˆªçš„è¡¨å•
- `fetcher.load`: é€šè¿‡ router loader åŠ è½½æ•°æ®ï¼š 
```js
if (fetcher.state === "idle" && !fetcher.data) {
    fetcher.load("/some/route");
}
```
- `fetcher.submit`: æ¨¡æ‹Ÿfetcher.Form çš„æäº¤åŠ¨ä½œã€‚æ¯”å¦‚ä¸€ä¸ªç”¨æˆ·ç™»å‡ºçš„æ“ä½œï¼š

```jsx
import { useFetcher } from "react-router-dom";
import { useFakeUserIsIdle } from "./fake/hooks";

export function useIdleLogout() {
  const fetcher = useFetcher();
  const userIsIdle = useFakeUserIsIdle();

  useEffect(() => {
    if (userIsIdle) {
      fetcher.submit(
        { idle: true },
        { method: "post", action: "/logout" }
      );
    }
  }, [userIsIdle]);
}
```

- `fetcher.data`: loader æˆ–è€… action è¿”å›çš„æ•°æ®ä¼šå­˜å‚¨åœ¨è¿™é‡Œ
- `fetcher.formData`: å½“ä½¿ç”¨`<fetcher.Form>`Â orÂ `fetcher.submit()`æ—¶ï¼ŒformData å¯ä»¥ç”¨æ¥è·å–æäº¤æ•°æ®ï¼š

```jsx
function TaskCheckbox({ task }) {
  let fetcher = useFetcher();

  // é€šè¿‡ get æ–¹æ³•å¯ä»¥è·å–åˆ°formDataå†…çš„å€¼ï¼Œåå‘å½±å“æäº¤è¡¨å•çš„æ¸²æŸ“
  let status =
    fetcher.formData?.get("status") || task.status;

  let isComplete = status === "complete";

  return (
    <fetcher.Form method="post">
      <button
        type="submit"
        name="status"
        value={isComplete ? "incomplete" : "complete"}
      >
        {isComplete ? "Mark Incomplete" : "Mark Complete"}
      </button>
    </fetcher.Form>
  );
}
```

- `fetcher.formAction`: è·å–å½“å‰æäº¤çš„ action çš„ url
- `fetcher.formMethod`: è·å–å½“å‰æäº¤çš„ action çš„ method


### useFetchers

è¿”å›æ‰€æœ‰fetcherçš„æ•°ç»„ï¼Œä½†ä¸æºå¸¦Â `load`,Â `submit`, Â `Form`Â ä¿¡æ¯ã€‚

### useFormAction

ç±»å‹å®šä¹‰ï¼š
```tsx
declare function useFormAction(
  action?: string,
  { relative }: { relative?: RelativeRoutingType } = {}
): string;
```

å¯¹action çš„urlåŒ…è£…äº†ä¸€å±‚ï¼Œä¼šè‡ªåŠ¨è§£æç›¸å¯¹è·¯å¾„ã€‚è¯¥ä½¿ç”¨ä¸å¤ªå¸¸è§ã€‚

ä½¿ç”¨æ–¹å¼ï¼š
```jsx
import { useFormAction } from "react-router-dom";

function DeleteButton() {
  return (
    <button
      formAction={useFormAction("destroy")}
      formMethod="post"
    >
      Delete
    </button>
  );
}
```

### useLoaderData

ç”¨æˆ·è·å–route loaderçš„è¿”å›å€¼ã€‚

ä½¿ç”¨æ–¹å¼ï¼š
```jsx
import {
  createBrowserRouter,
  RouterProvider,
  useLoaderData,
} from "react-router-dom";

function loader() {
  return fetchFakeAlbums();
}

export function Albums() {
  const albums = useLoaderData();
  // ...
}

const router = createBrowserRouter([
  {
    path: "/",
    loader: loader,
    element: <Albums />,
  },
]);

ReactDOM.createRoot(el).render(
  <RouterProvider router={router} />
);
```

useLoaderData ä¸ä¼šé‡å¤æå–æ•°æ®ã€‚å®ƒåªæ˜¯è¯»å– React Router å†…éƒ¨ç®¡ç†çš„ fetch çš„ç»“æœï¼Œå½“å®ƒç”±äºè·¯ç”±ä¹‹å¤–çš„åŸå› é‡æ–°æ¸²æŸ“æ—¶ï¼Œæ‚¨æ— éœ€æ‹…å¿ƒå®ƒä¼šé‡æ–°è·å–ã€‚è¿™ä¹Ÿæ„å‘³ç€è¿”å›æ•°æ®å’Œæ¸²æŸ“ä¹‹é—´ï¼Œdataæ˜¯ç¨³å®šçš„ï¼Œå› æ­¤æ‚¨å¯ä»¥å®‰å…¨åœ°å°†å…¶ä¼ é€’ç»™ React é’©å­ï¼ˆå¦‚ useEffectï¼‰ä¸­çš„ä¾èµ–æ•°ç»„ã€‚åªæœ‰åœ¨æ“ä½œæˆ–æŸäº›å¯¼èˆªåå†æ¬¡è°ƒç”¨åŠ è½½ç¨‹åºæ—¶ï¼Œå®ƒæ‰ä¼šæ›´æ”¹ã€‚


### useMatches

è¿”å›å½“å‰åŒ¹é…çš„è·¯ç”±é¡¹ã€‚ä½¿ç”¨æ¡ˆä¾‹ï¼šé¢åŒ…å±‘å¯¼èˆªï¼š

```jsx
// è·¯ç”±è¡¨
<Route element={<Root />}>
  <Route
    path="messages"
    element={<Messages />}
    loader={loadMessages}
    handle={{
      // you can put whatever you want on a route handle
      // here we use "crumb" and return some elements,
      // this is what we'll render in the breadcrumbs
      // for this route
      crumb: () => <Link to="/message">Messages</Link>,
    }}
  >
    <Route
      path="conversation/:id"
      element={<Thread />}
      loader={loadThread}
      handle={{
        // `crumb` is your own abstraction, we decided
        // to make this one a function so we can pass
        // the data from the loader to it so that our
        // breadcrumb is made up of dynamic content
        crumb: (data) => <span>{data.threadName}</span>,
      }}
    />
  </Route>
</Route>

// å¯¼èˆªç»„ä»¶
function Breadcrumbs() {
  let matches = useMatches();
  let crumbs = matches
    // first get rid of any matches that don't have handle and crumb
    .filter((match) => Boolean(match.handle?.crumb))
    // now map them into an array of elements, passing the loader
    // data to each one
    .map((match) => match.handle.crumb(match.data));

  return (
    <ol>
      {crumbs.map((crumb, index) => (
        <li key={index}>{crumb}</li>
      ))}
    </ol>
  );
}
```

### useNavigation

è·å–è·¯ç”±åŠ è½½è¿‡ç¨‹ä¸­çš„å„ç§å¯¼èˆªå‚æ•°ï¼Œä½¿ç”¨åœºæ™¯ï¼š

- å…¨å±€åŠ è½½ loading
- éœ€è¦å…¨å±€ç¦ç”¨ form
- æäº¤æ—¶è¡¨å•å¤„ç†ä¸­çš„åŠ¨ç”»
- ...

ä½¿ç”¨æ–¹å¼ï¼š

```jsx
import { useNavigation } from "react-router-dom";

function SomeComponent() {
  const navigation = useNavigation();
  navigation.state; // idle â†’ submitting â†’ loading â†’ idle
  navigation.location;
  navigation.formData;
  navigation.formAction;
  navigation.formMethod;
}
```

### useRevalidator

ç”¨äºé‡æ–°éªŒè¯æ•°æ®çš„åœºæ™¯ï¼Œä½¿ç”¨æ–¹å¼ï¼š
```jsx
import { useRevalidator } from "react-router-dom";

function WindowFocusRevalidator() {
  let revalidator = useRevalidator();

  useFakeWindowFocus(() => {
    revalidator.revalidate();
  });

  return (
    <div hidden={revalidator.state === "idle"}>
      Revalidating...
    </div>
  );
}
```

### useRouteError

åœ¨ errorElementå±æ€§ç»„ä»¶å†…éƒ¨ä½¿ç”¨ï¼Œè¿”å›ä»»ä½•è·¯ç”±ä¸­å‡ºç°çš„é”™è¯¯ã€‚ä½¿ç”¨æ–¹å¼ï¼š

```jsx
function ErrorBoundary() {
  const error = useRouteError();
  console.error(error);
  return <div>{error.message}</div>;
}

<Route
  errorElement={<ErrorBoundary />}
  loader={() => {
    // unexpected errors in loaders/actions
    something.that.breaks();
  }}
  action={() => {
    // stuff you throw on purpose in loaders/actions
    throw new Response("Bad Request", { status: 400 });
  }}
  element={
    // and errors thrown while rendering
    <div>{breaks.while.rendering}</div>
  }
/>;
```

### useRouteLoaderData

æ”¶é›†è·¯ç”±æ ‘ä¸Šæ‰€æœ‰çš„loaderæ•°æ®ã€‚åœ¨éœ€è¦å…¨å±€æŠŠæ§å¤šåµŒå¥—è·¯ç”±å‚æ•°æ—¶æ¯”è¾ƒæœ‰ç”¨ã€‚

ä½¿ç”¨æ–¹å¼ï¼š

```jsx
createBrowserRouter([
  {
    path: "/",
    loader: () => fetchUser(),
    element: <Root />,
    id: "root",
    children: [
      {
        path: "jobs/:jobId",
        loader: loadJob,
        element: <JobListing />,
      },
    ],
  },
]);

...
const user = useRouteLoaderData("root");
```

é€šè¿‡è·¯ç”±çš„idæ¥è¯†åˆ«è·¯ç”±æ ‘çš„èµ·ç‚¹ã€‚

### useSubmit

åŠ¨æ€æäº¤è¡¨å•ã€‚ä½¿ç”¨æ–¹å¼ï¼š
```jsx
import { useSubmit, Form } from "react-router-dom";

function SearchField() {
  let submit = useSubmit();
  return (
    <Form
      onChange={(event) => {
        submit(event.currentTarget, { method: "post", action: "/check" });
      }}
    >
      <input type="text" name="search" />
      <button type="submit">Search</button>
    </Form>
  );
}
```

## 5. æ–°å¢å°å·¥å…·

### json

jsonè½¬æ¢å·¥å…·ï¼š

```jsx
import { json } from "react-router-dom";

const loader = async () => {
  const data = getSomeData();
  return json(data);
};
```

### redirect

é‡å®šå‘ã€‚åœ¨ loader å’Œ action ä¸­æ¨èä½¿ç”¨ï¼Œè€Œä¸æ˜¯ useNavigateï¼Œä»–ç­‰ä»·äºå¦‚ä¸‹æ“ä½œï¼š

```js
new Response("", {
  status: 302,
  headers: {
    Location: someUrl,
  },
});
```
ä½¿ç”¨æ¡ˆä¾‹ï¼š
```jsx
import { redirect } from "react-router-dom";

const loader = async () => {
  const user = await getUser();
  if (!user) {
    return redirect("/login");
  }
};
```2d:T2246,æœ¬æœŸè®²ä¸€ä¸‹ `React Router v6` çš„utilsåº“ä¸­çš„å†…ç½®æ–¹æ³•ã€‚æœ¬æ–‡åªåœ¨æ˜é‡‘å‘å¸ƒã€‚

> ä¸“æ è¯´æ˜ï¼šå¯¹äºreact-router v6ç‰ˆæœ¬ï¼Œæœ‰åŒäº‹åæ˜ ç¼ºå°‘ç›¸å¯¹å®Œæ•´çš„ä¸­æ–‡æ–‡æ¡£ï¼ŒæŸ¥çœ‹ä¸æ–¹ä¾¿ã€‚ä¸ºäº†ä¾¿äºä½¿ç”¨ï¼Œä½œè€…å¯¹[å®˜ç½‘æ–‡æ¡£](https://link.juejin.cn/?target=https%3A%2F%2Freactrouter.com%2Fdocs%2Fen%2Fv6 "https://link.juejin.cn/?target=https%3A%2F%2Freactrouter.com%2Fdocs%2Fen%2Fv6")è¿›è¡Œé’ˆå¯¹æ€§ç¿»è¯‘ï¼Œä¾¿äºv6ç‰ˆæœ¬æ›´å¹¿æ³›çš„è¢«ä½¿ç”¨ã€‚


## 1. createRoutesFromChildren

ç±»å‹å®šä¹‰ï¼š

```ts
declare function createRoutesFromChildren(
  children: React.ReactNode
): RouteObject[];

// è¿”å›å€¼
interface RouteObject {
  caseSensitive?: boolean;
  children?: RouteObject[];
  element?: React.ReactNode;
  index?: boolean;
  path?: string;
}
```
`createRoutesFromChildren`Â é€šå¸¸åœ¨Â `<Route>`Â å­å…ƒç´ ä¸­ä½¿ç”¨ï¼Œç”¨äºç”Ÿæˆå­ route çš„é…ç½®é¡¹ã€‚å¯ä»¥æŠŠ `<Route>` ç±»å‹çš„ react element å¯¹è±¡ï¼Œå˜æˆäº†æ™®é€šçš„ route å¯¹è±¡ç»“æ„ã€‚å…¶å†…éƒ¨é€šè¿‡ React.Children.forEach æŠŠ Route ç»„ä»¶ç»™ç»“æ„åŒ–ï¼Œå¹¶ä¸”å†…éƒ¨è°ƒç”¨é€’å½’ï¼Œæ·±åº¦é€’å½’ children ç»“æ„ã€‚

ç¤ºä¾‹ï¼š

è¾“å…¥
```js
<Routes> 
    <Route element={<Home />} path="/home" /> 
    <Route element={<List/>} path="/list" /> 
    <Route element={<Layout/>} path="/children" > 
        <Route element={<Child1/>} path="/children/child1" /> 
        <Route element={<Child2/>} path="/children/child2" /> 
    </Route> 
</Routes>
```
è¾“å‡º

![1](/img/posts/2022-9-19/2022-9-19-1.png)

## 2. createSearchParams

ç±»å‹å®šä¹‰ï¼š


```ts
declare function createSearchParams(
  init?: URLSearchParamsInit
): URLSearchParams;
```

`createSearchParams` é€šå¸¸ä¸ `useSearchParams` é…å¯¹ä½¿ç”¨ï¼Œç”¨äº search ä¼ å‚æ—¶æ„å»ºå‚æ•°ã€‚

ç¤ºä¾‹ï¼š

```js
// ä¼ å‚æ–¹å¼ 1
navigate({
    pathname: "/class",
    search: `?id=${id}&grade=${grade}`
})

// ä¼ å‚æ–¹å¼ 2
const params = { id: '1', grade: '2' };
navigate({
    pathname: "/class",
    search: `?${createSearchParams(params)}`
})
```

## 3. generatePath

ç±»å‹å®šä¹‰ï¼š

```ts
declare function generatePath(
  path: string,
  params?: Params
): string;
```

åŠ¨æ€ç”Ÿæˆå¯è·³è½¬çš„ pathï¼Œ å¯è‡ªåŠ¨åŒ¹é…å¹¶å¡«å……åŠ¨æ€å‚æ•°ã€‚

ç¤ºä¾‹ï¼š
```js
generatePath("/users/:id", { id: "42" }); // "/users/42"
generatePath("/files/:type/*", {
  type: "img",
  "*": "cat.jpg",
}); // "/files/img/cat.jpg"
```

## 4. Location

React Router ä¸­ "location" çš„æ¥å£å®šä¹‰ã€‚

## 5. matchPath

ç±»å‹å®šä¹‰ï¼š
```ts
declare function matchPath<
  ParamKey extends string = string
>(
  pattern: PathPattern | string,
  pathname: string
): PathMatch<ParamKey> | null;

interface PathMatch<ParamKey extends string = string> {
  params: Params<ParamKey>;
  pathname: string;
  pattern: PathPattern;
}

interface PathPattern {
  path: string;
  caseSensitive?: boolean;
  end?: boolean;
}
```

æ¯”è¾ƒå¸¸ç”¨çš„å‡½æ•°ã€‚æ˜¯hook `[useMatch](https://reactrouter.com/en/main/hooks/use-match)` çš„è¡¥å……ï¼Œç”¨äºéå‡½æ•°å¼ç»„ä»¶ä¸­ã€‚

ç¤ºä¾‹ï¼š

```js
matchPath('/children/child1/:id', '/children/child1/1') 
```
![2](/img/posts/2022-9-19/2022-9-19-2.png)
ä¸ªäººè§‰å¾—æ²¡å•¥ç”¨çš„æ–¹æ³•ï¼Œä½ éƒ½çŸ¥é“ä¼ å…¥ pathname äº†ï¼Œè¿˜åŒ¹é…ä¸ªderã€‚

---
P.S. 2023å¹´2æœˆè¿½åŠ 

æˆ‘é”™äº†ï¼ï¼ä»Šå¤©é‡åˆ°ä¸€ä¸ªé—®é¢˜ï¼Œå†å†™ä¸€ä¸ªé¢åŒ…å±‘å¯¼èˆªçš„æ—¶å€™ï¼ŒåŒ¹é…å¸¦æœ‰è·¯å¾„å‚æ•°çš„è·¯ç”±è¿›è¡Œé€‰æ‹©æ€§é«˜äº®ï¼Œè¿˜çœŸå¾—ä½¿ç”¨ matchPathï¼Œçœçš„è‡ªå·±å†™æ­£åˆ™æ ¡éªŒäº†ï¼š

![3](/img/posts/2022-9-19/2022-9-19-3.png)

(è“è‰²æ˜¯location.pathnameï¼Œçº¢è‰²æ˜¯éå† Menué…ç½®æ‹¿åˆ°çš„urlï¼Œç»¿è‰²æ˜¯matchPathè¿”å›çš„ï¼Œè‹¥ä¸æ˜¯nullåˆ™è¡¨ç¤ºåŒ¹é…åˆ°äº†ï¼)

## 6. matchRoutes

ç±»å‹å®šä¹‰ï¼š
```ts
declare function matchRoutes(
  routes: RouteObject[],
  location: Partial<Location> | string,
  basename?: string
): RouteMatch[] | null;

interface RouteMatch<ParamKey extends string = string> {
  params: Params<ParamKey>;
  pathname: string;
  route: RouteObject;
}
```

è¿™ä¸ªæ˜¯v6ç‰ˆåŒ¹é…è·¯ç”±çš„æ ¸å¿ƒç®—æ³•ï¼Œå®˜æ–¹æš´éœ²å‡ºæ¥äº†ï¼Œä¾›å¼€å‘è€…è‡ªå®šä¹‰ä½¿ç”¨ã€‚

ç¤ºä¾‹ï¼š

```js
const routes = [
  {
    path: '/',
    component: <Home />
  },
  {
    path: '/list',
    component: <List />
  },
  {
    path: '/children',
    component: <Layout />,
    children: [
      {
        path: 'child1',
        component: <Child1 />
      },
      {
        path: 'child2/:id',
        component: <Child2 />
      },
    ]
  }
]
...

<BrowserRouter>
  <Routes>
      {routes.map((route, index) => <Route key={index} element={route.component} path={route.path} >
        {route.children && <>
          {route.children.map((cRoute, cIndex) => <Route key={cIndex} element={cRoute.component} path={cRoute.path} />)}
        </>}
      </Route> )}
  </Routes>
</BrowserRouter>

matchRoutes(routes, '/children/child1')
```

![4](/img/posts/2022-9-19/2022-9-19-4.png)
å¯ä»¥çœ‹åˆ°ï¼Œ matchRoutes å°†æ‰€æœ‰çš„åŒ¹é…è·¯å¾„ä¸Šçš„è·¯ç”±éƒ½æŒ‰ç…§é¡ºåºè¿”å›å•¦ã€‚å¯ä»¥é€šè¿‡ route.path æ¥è·å–åŸå§‹è·¯ç”±è¡¨ä¸­çš„ pathã€‚


## 7. renderMatches

ç±»å‹å®šä¹‰ï¼š
```ts
declare function renderMatches(
  matches: RouteMatch[] | null
): React.ReactElement | null;
```

å®ƒçš„ä½œç”¨æ˜¯æŠŠ matchRoutes åŒ¹é…åˆ°çš„ component æ¸²æŸ“å‡ºæ¥ã€‚è¯´çš„å®¹æ˜“ï¼Œç½‘ä¸Šçš„ä½¿ç”¨æ¡ˆä¾‹å°‘ä¹‹åˆå°‘ï¼Œå®˜æ–¹æ–‡æ¡£åˆå¤ªè¿‡æ•·è¡ï¼Œåªèƒ½å»è¯»æºç äº†ï¼š

```tsx
// react-router/packages/lib/hooks.tsx
export function _renderMatches(
  matches: RouteMatch[] | null,
  parentMatches: RouteMatch[] = []
): React.ReactElement | null {
  if (matches == null) return null;

  return matches.reduceRight((outlet, match, index) => {
    return (
      <RouteContext.Provider
        children={
          match.route.element !== undefined ? match.route.element : outlet
        }
        value={{
          outlet,
          matches: parentMatches.concat(matches.slice(0, index + 1)),
        }}
      />
    );
  }, null as React.ReactElement | null);
}
```
å¯ä»¥çœ‹åˆ°ï¼Œå®ƒæ˜¯å°†åŒ¹é…åˆ°çš„è·¯ç”±æ•°ç»„ä»å³å‘å·¦æ‘˜å–ï¼Œç»Ÿä¸€æ”¾åˆ°ä¸€ä¸ª context é‡Œäº†ã€‚è€Œä¸”ï¼Œä»æºç é‡Œçœ‹åˆ°ï¼ŒuseRoutes çš„è¿”å›å€¼å°±æ˜¯ä¸€ä¸ª _renderMatchesï¼Œæˆ‘ä»¬å¯ä»¥å‚ç…§æºç çš„è°ƒç”¨æ–¹å¼è¿›è¡Œä½¿ç”¨ã€‚

è€ƒè™‘è·¯ç”±ï¼š

```js
const routes = [
    {
      path: '/',
      component: <Home />
    },
    {
      path: '/list',
      component: <List />
    },
    {
      path: '/children',
      component: <Layout />,
      children: [
        {
          path: 'child1',
          component: <Child1 />
        },
        {
          path: 'child2/:id',
          component: <Child2 />
        },
      ]
    },
  ]
```

ä½¿ç”¨æ–¹å¼ï¼š

```js
renderMatches(matchRoutes(routes, '/children/child2/1'))
```
matchRoutes è¿”å›çš„å€¼æ˜¯ï¼š

![5](/img/posts/2022-9-19/2022-9-19-5.png)
ä¸ _renderMatches æ¥å—çš„å‚æ•°ä¸€è‡´ã€‚

åœ¨ matches.reduceRight ä¸­ï¼Œä¼šå°† match.route.element é€šè¿‡ context çš„ children çš„å½¢å¼æŒ‚è½½ã€‚ä¸çŸ¥é“æ˜¯ä¸æ˜¯å¼€å‘è€…çš„ç¬”è¯¯ï¼Œchildren é‡Œä½¿ç”¨äº† match.route.elementï¼Œè€Œä¸Šå›¾ä¸­åŒ¹é…çš„æ•°ç»„æ˜æ˜æ˜¯ route.componentï¼Œå¯¼è‡´ç›´æ¥ä½¿ç”¨æ¸²æŸ“ä¸å‡ºæ¥ä»»ä½•æ•°æ®ï¼Œæˆ‘æ”¹åŠ¨ä¸€ä¸‹è¿™ä¸ªå‡½æ•°å°±æœ‰æ•°æ®äº†ï¼š

```jsx
const Context = createContext({});

const matches = matchRoutes(routes, '/children/child2/1');

return matches && matches.reduceRight((outlet, match, index) => {
    return (
      <Context.Provider
        children={
          match.route.component !== undefined ? match.route.component : outlet
        }
        value={{
          outlet,
        }}
      />
    );
}, null as React.ReactElement | null);
```
ä½†æ˜¯ä»–ä¼ çš„è¿™ä¸ª outlet å‚æ•°ï¼Œå¹¶ä¸èƒ½è¢«è‡ªåŠ¨è¯†åˆ«ä¸º \<Outlet /> æ ‡ç­¾ï¼Œæ‰€ä»¥åªèƒ½æ¸²æŸ“å‡ºæ¥ Layoutï¼Œ å­ç»„ä»¶ä»ç„¶æ¸²æŸ“ä¸å‡ºæ¥ã€‚
          
 è¯‘è€…è‡ªå·±å†™äº†ä¸ªDemoï¼Œæ¥å¤ç°ä¸€ä¸‹ä»–è¿™ä¸ªç®—æ³•ï¼š
 
```tsx
// ä¸»
<Context.Provider
  value={{
    outlet: <Context.Provider>
      <Child2 />
    </Context.Provider>
  }}
>
  <Layout />
</Context.Provider>

// Layout
function Layout () {
    return <Context.Consumer>
      {values => {
        return <>
           'Layout
           {values.outlet ? values.outlet : <Outlet />}
        </>
      }}
    </Context.Consumer>
}
```
å¯ä»¥æ­£å¸¸æ¸²æŸ“ï¼š

![6](/img/posts/2022-9-19/2022-9-19-6.png)

æ€»ç»“ï¼šrenderMatches ä¸è¦ç”¨ï¼Œå‘äººã€‚åµŒå¥— Outlet çš„æ€æƒ³å¾ˆå¥½ï¼Œä½†ç»ˆç©¶æ˜¯ç»™å†…éƒ¨ä½¿ç”¨çš„å†…éƒ¨ APIï¼Œä¸šåŠ¡ä¸Šä¸è¦ç”¨ã€‚

## 8. resolvePath

ç±»å‹å®šä¹‰ï¼š
```ts
declare function resolvePath(
  to: To,
  fromPathname?: string
): Path;

type To = string | Partial<Path>;

interface Path {
  pathname: string;
  search: string;
  hash: string;
}
```

é€šè¿‡ç»™å®šçš„ç›¸å¯¹è·¯ç”± to æ¥è·å–ä¸€ä¸ªèƒ½å¤Ÿ navigate çš„ç»å¯¹è·¯å¾„ pathã€‚æ˜¯hook useResolvedPath çš„å®ç°æ–¹æ³•ã€‚


```js
resolvePath('children/child2/:id') // /children/child2/:id
```

<hr />

å®Œï¼2e:T2bf7,> ä¸“æ è¯´æ˜ï¼šå¯¹äºreact-router v6ç‰ˆæœ¬ï¼Œæœ‰åŒäº‹ååº”ç¼ºå°‘ç›¸å¯¹å®Œæ•´çš„ä¸­æ–‡æ–‡æ¡£ï¼ŒæŸ¥çœ‹ä¸æ–¹ä¾¿ã€‚ä¸ºäº†ä¾¿äºä½¿ç”¨ï¼Œä½œè€…å¯¹[å®˜ç½‘æ–‡æ¡£](https://link.juejin.cn/?target=https%3A%2F%2Freactrouter.com%2Fdocs%2Fen%2Fv6 "https://reactrouter.com/docs/en/v6")è¿›è¡Œé’ˆå¯¹æ€§ç¿»è¯‘ï¼Œä¾¿äºv6ç‰ˆæœ¬æ›´å¹¿æ³›çš„è¢«ä½¿ç”¨ã€‚


> ä½œè€…è¯´æ˜ï¼šæœ¬æœŸçš„hooksä»…ä»…åœ¨å‡½æ•°å¼ç»„ä»¶é‡Œç”Ÿæ•ˆï¼Œè‹¥æƒ³è¦åœ¨ç±»å¼ç»„ä»¶é‡Œä½¿ç”¨ç›¸åº”åŠŸèƒ½ï¼Œå¯å‚è§æœ¬ä¸“æ ç¬¬ä¸€ç¯‡æ–‡ç« ï¼Œè‡ªå·±å†™ä¸€ä¸ª withRouter å‡½æ•°ã€‚

## 1. useHref

ç±»å‹å®šä¹‰ï¼š

```ts
declare function useHref(to: To): string;
```
`useHref` è¿”å›ä¸€ä¸ªå®Œæ•´çš„è·¯ç”±URLï¼ŒæŒ‡å‘å‚æ•°Â `to`Â å®šä½çš„åœ°å€, è¿™ä¸ªåœ°å€å¯ä»¥è„±ç¦» React Routerç¯å¢ƒã€‚ä½¿ç”¨ç¤ºä¾‹ï¼š

```js
// æ·±å±‚è·¯ç”±ä¸­
useHref({ to: 'dashboard' }) // /home/test/dashboard
```

## 2. useInRouterContext

ç±»å‹å®šä¹‰ï¼š
```ts
declare function useInRouterContext(): boolean;
```
å½“ç»„ä»¶ä½¿ç”¨äº†`<Router>`æ¸²æŸ“æ—¶ï¼Œè¯¥é’©å­è¿”å›trueï¼Œå¦åˆ™è¿”å›falseã€‚è¿™å¯¹äºä¸€äº›éœ€è¦çŸ¥é“ç»„ä»¶æ˜¯å¦åœ¨ React Router ä¸Šä¸‹æ–‡ä¸­çš„ç¬¬ä¸‰æ–¹æ‰©å±•éå¸¸æœ‰ç”¨ã€‚

## 3. useLinkClickHandler

ç±»å‹å®šä¹‰ï¼š
```ts
declare function useLinkClickHandler<
  E extends Element = HTMLAnchorElement
>(
  to: To,
  options?: {
    target?: React.HTMLAttributeAnchorTarget;
    replace?: boolean;
    state?: any;
  }
): (event: React.MouseEvent<E, MouseEvent>) => void;
```
å…¶è¿”å›ä¸€ä¸ªèƒ½å¤Ÿå®ç°`<Link>`æ ‡ç­¾åŠŸèƒ½çš„æ›¿ä»£æ€§çš„å‡½æ•°ï¼Œç”¨äºåœ¨è‡ªå®šä¹‰è·³è½¬æ—¶ä½¿ç”¨ï¼Œå‚æ•°åŒLinkæ ‡ç­¾ï¼š

```jsx
import {
  useHref,
  useLinkClickHandler,
} from "react-router-dom";

const StyledLink = styled("a", { color: "fuchsia" });

const Link = React.forwardRef(
  (
    {
      onClick,
      replace = false,
      state,
      target,
      to,
      ...rest
    },
    ref
  ) => {
    let href = useHref(to);
    // è°ƒç”¨handleClickï¼Œç›¸å½“äºç‚¹å‡»äº†ä¸€ä¸ª<Link>æ ‡ç­¾
    let handleClick = useLinkClickHandler(to, {
      replace,
      state,
      target,
    });

    return (
      <StyledLink
        {...rest}
        href={href}
        onClick={(event) => {
          onClick?.(event);
          if (!event.defaultPrevented) {
            handleClick(event);
          }
        }}
        ref={ref}
        target={target}
      />
    );
  }
);
```

## 4. useLinkPressHandler

ç±»å‹å®šä¹‰ï¼š
```ts
declare function useLinkPressHandler(
  to: To,
  options?: {
    replace?: boolean;
    state?: any;
  }
): (event: GestureResponderEvent) => void;
```
åŠŸèƒ½åŒ useLinkClickHandlerï¼Œ åªä¸è¿‡æ˜¯åœ¨ç§»åŠ¨ç«¯ä½¿ç”¨çš„ï¼ˆå¸¸ç”¨äº react-nativeï¼‰ï¼Œä½¿ç”¨ç¤ºä¾‹ï¼š
```tsx
import { TouchableHighlight } from "react-native";
import { useLinkPressHandler } from "react-router-native";

function Link({
  onPress,
  replace = false,
  state,
  to,
  ...rest
}) {
  let handlePress = useLinkPressHandler(to, {
    replace,
    state,
  });

  return (
    <TouchableHighlight
      {...rest}
      onPress={(event) => {
        onPress?.(event);
        if (!event.defaultPrevented) {
          handlePress(event);
        }
      }}
    />
  );
}
```

## 5. useLocation

ç±»å‹å®šä¹‰ï¼š
```ts
declare function useLocation(): Location;

interface Location extends Path {
  state: unknown;
  key: Key;
}
```

è¿™ä¸ªå°±æ¯”è¾ƒå¸¸ç”¨äº†ã€‚ä»–è¿”å›å½“å‰è·¯ç”±çŠ¶æ€ä¸‹çš„ location ä¿¡æ¯, å¯ç”¨äºè·¯ç”±ä¼ å‚ã€‚ä½¿ç”¨æ–¹å¼ï¼š
```jsx
import { useLocation } from 'react-router-dom';

function App() {
  let location = useLocation(); // hash, key, pathname, search, state
}
```

## 6. useMatch

ç±»å‹å®šä¹‰ï¼š
```ts
declare function useMatch<ParamKey extends string = string>(
  pattern: PathPattern | string
): PathMatch<ParamKey> | null;
```

å…¶æ¥å—ä¸€ä¸ªç›¸å¯¹è·¯ç”±å­—ç¬¦ä¸²ï¼Œè¿”å›åŒ¹é…åˆ°çš„è·¯ç”±è¡¨æ•°æ®ã€‚ç¤ºä¾‹ï¼š

```js
useMatch('/')
```
è¿”å›å€¼ï¼š

![image.png](/img/posts/2022-8-26/2022-8-26-1.png)

## 7. useNavigate

ç±»å‹å®šä¹‰ï¼š
```ts
declare function useNavigate(): NavigateFunction;

interface NavigateFunction {
  (
    to: To,
    options?: { replace?: boolean; state?: any }
  ): void;
  (delta: number): void;
}
```

ä»–è¿”å›ä¸€ä¸ªå¯ä»¥ç”¨äºè·¯ç”±å¯¼èˆªçš„å‡½æ•°ã€‚æœ‰ä¸€ä¸ªå‚æ•° replaceï¼Œå¦‚æœä¼ ä¸º trueï¼Œè·¯ç”±ä¼šåœ¨ history stack ä¸­æ›¿æ¢å½“å‰çš„ currentï¼Œ è€Œä¸æ˜¯æ–° push ä¸€ä¸ªçŠ¶æ€ã€‚ä½¿ç”¨ç¤ºä¾‹ï¼š

```jsx
import { useNavigate } from "react-router-dom";

// è¡¨å•æäº¤åè·³è½¬é¡µé¢
function SignupForm() {
  let navigate = useNavigate();

  async function handleSubmit(event) {
    event.preventDefault();
    await submitForm(event.target);
    navigate("../success", { replace: true });
  }

  return <form onSubmit={handleSubmit}>{/* ... */}</form>;
}
```

å½“ç„¶ä¹Ÿå¯ä»¥ä¸ä¼ è·¯ç”±çš„ pathï¼Œç›´æ¥ä¼ æ•°å­—ï¼š

```js
navigate(-1)
```
è¡¨ç¤ºæµè§ˆå™¨å›é€€æˆ–è€…å‰è¿›ã€‚

## 8. useNavigationType

ç±»å‹å®šä¹‰ï¼š
```ts
declare function useNavigationType(): NavigationType;

type NavigationType = "POP" | "PUSH" | "REPLACE";
```

è¿”å›è·¯ç”±è·³è½¬çš„çŠ¶æ€ï¼Œè¡¨ç¤ºå½“å‰é¡µé¢æ˜¯æ€ä¹ˆæ ·è¢«ç”¨æˆ·è·³è½¬è¿‡æ¥çš„ï¼Œå¯é€‰å‚æ•°ï¼špop, push, replace

## 9. useOutlet

ç±»å‹å®šä¹‰ï¼š

```ts
declare function useOutlet(): React.ReactElement | null;
```

è¿”å›åµŒå¥—è·¯ç”±ä¸­ï¼Œè¢« `<Outlet>` å ä½çš„å­å…ƒç´ çš„è·¯ç”±å¯¹è±¡ã€‚é€šå¸¸åœ¨å­è·¯ç”±å†…éƒ¨ä½¿ç”¨ã€‚ç¤ºä¾‹ï¼š

```js
function Dashboard() {
  // æ‰“å° outlet
  console.log(useOutlet())
  return (
    <div>
      <h1>Dashboard</h1>
      <Outlet />
    </div>
  );
}

function DashboardMessages() {
  return 'DashboardMessages'
}

function DashboardTasks() {
  return 'DashboardTasks'
}

function App() {
  return (
    <Routes>
      <Route path="/" element={<Dashboard />}>
        {/* å­è·¯ç”± */}
        <Route
          path="messages"
          element={<DashboardMessages />}
        />
        <Route path="tasks" element={<DashboardTasks />} />
      </Route>
    </Routes>
  );
}
```
æ­¤æ—¶è®¿é—®è·¯ç”± `http://localhost:3000/messages`ï¼Œé¡µé¢å¦‚ä¸‹ï¼š

![image.png](/img/posts/2022-8-26/2022-8-26-2.png)

æ§åˆ¶å°æ‰“å°ï¼š

![image.png](/img/posts/2022-8-26/2022-8-26-3.png)

## 10. useOutletContext

ç±»å‹å®šä¹‰ï¼š
```ts
declare function useOutletContext<
  Context = unknown
>(): Context;
```
ç”¨äºçˆ¶å­è·¯ç”±å…±äº«çŠ¶æ€ã€‚ç¤ºä¾‹ï¼š
```jsx
// çˆ¶
function Parent() {
  const [count, setCount] = React.useState(0);
  return <Outlet context={[count, setCount]} />;
}

// å­
import { useOutletContext } from "react-router-dom";

function Child() {
  const [count, setCount] = useOutletContext();
  const increment = () => setCount((c) => c + 1);
  return <button onClick={increment}>{count}</button>;
}
```
å¦‚æœæ˜¯åœ¨tsç¯å¢ƒä¸‹ï¼Œä½¿ç”¨æ–¹å¼åˆæœ‰æ‰€ä¸åŒã€‚æ¨èè‡ªå®šä¹‰ä¸€ä¸ª contextï¼Œ è¿™æ ·æ–¹ä¾¿ç±»å‹å®šä¹‰ï¼š
```tsx
// çˆ¶
import * as React from "react";
import type { User } from "./types";
import { Outlet, useOutletContext } from "react-router-dom";

type ContextType = { user: User | null };

export default function Dashboard() {
  const [user, setUser] = React.useState<User | null>(null);

  return (
    <div>
      <h1>Dashboard</h1>
      <Outlet context={{ user }} />
    </div>
  );
}

// è‡ªå®šä¹‰ hook
export function useUser() {
  return useOutletContext<ContextType>();
}

// å­
import { useUser } from "../dashboard";

export default function DashboardMessages() {
  const { user } = useUser();
  return (
    <div>
      <h2>Messages</h2>
      <p>Hello, {user.name}!</p>
    </div>
  );
}
```

## 11. useParams

ç±»å‹å®šä¹‰ï¼š
```ts
declare function useParams<
  K extends string = string
>(): Readonly<Params<K>>;
```

è¿”å›è·¯ç”±ä¼ å‚çš„é”®å€¼å¯¹å‚æ•°ï¼ˆä¸æ˜¯é—®å·ä¼ å‚ï¼Œé—®å·çš„åœ¨locationçš„searché‡Œï¼‰ã€‚å­è·¯ç”±ä¹Ÿä¼šç»§æ‰¿çˆ¶è·¯ç”±çš„æ‰€æœ‰å‚æ•°ã€‚ä½¿ç”¨ç¤ºä¾‹ï¼š
```jsx
import * as React from 'react';
import { Routes, Route, useParams } from 'react-router-dom';

function ProfilePage() {
  // Get the userId param from the URL.
  let { userId } = useParams();
  // ...
}

function App() {
  return (
    <Routes>
      <Route path="users">
        <Route path=":userId" element={<ProfilePage />} />
        <Route path="me" element={...} />
      </Route>
    </Routes>
  );
}
```

## 12. useResolvedPath

ç±»å‹å®šä¹‰ï¼š

```ts
declare function useResolvedPath(to: To): Path;
```

è¿”å›ä¼ å…¥pathçš„å…¨è·¯å¾„ã€‚å¯è§£æå‡ºpathï¼Œhashï¼Œsearchï¼ˆlocationå¯¹è±¡ï¼‰


## 13. useRoutes

ç±»å‹å®šä¹‰ï¼š
```ts
declare function useRoutes(
  routes: RouteObject[],
  location?: Partial<Location> | string;
): React.ReactElement | null;
```
æ˜¯æ ‡ç­¾ `<Routes>` çš„å‡½æ•°å¼å½¢å¼ã€‚ä½¿ç”¨æ—¶ä¹Ÿä¸éœ€è¦é¢å¤–çš„JSXã€‚ç¤ºä¾‹ï¼š
```jsx
import * as React from "react";
import { useRoutes } from "react-router-dom";

function App() {
  let element = useRoutes([
    {
      path: "/",
      element: <Dashboard />,
      children: [
        {
          path: "messages",
          element: <DashboardMessages />,
        },
        { path: "tasks", element: <DashboardTasks /> },
      ],
    },
    { path: "team", element: <AboutPage /> },
  ]);

  return element;
}
```
ä»–çš„è¿”å›å€¼è¦ä¹ˆæ˜¯åŒ¹é…åˆ°çš„Reactå…ƒç´ ï¼Œè¦ä¹ˆæ˜¯nullã€‚

## 14. useSearchParams
ç±»å‹å®šä¹‰ï¼š
```ts
declare function useSearchParams(
  defaultInit?: URLSearchParamsInit
): [URLSearchParams, SetURLSearchParams];

type ParamKeyValuePair = [string, string];

type URLSearchParamsInit =
  | string
  | ParamKeyValuePair[]
  | Record<string, string | string[]>
  | URLSearchParams;

type SetURLSearchParams = (
  nextInit?: URLSearchParamsInit,
  navigateOpts?: : { replace?: boolean; state?: any }
) => void;
```

è§£æå½“å‰è·¯å¾„ï¼Œè¿”å›locationä¸­çš„searchï¼›å¹¶å¯é‡æ–°è®¾ç½® search å¹¶è§¦å‘è·³è½¬ã€‚ç¤ºä¾‹ï¼š
```jsx
import * as React from "react";
import { useSearchParams } from "react-router-dom";

function App() {
  let [searchParams, setSearchParams] = useSearchParams();

  function handleSubmit(event) {
    event.preventDefault();
    let params = serializeFormQuery(event.target);
    setSearchParams(params);
  }

  return (
    <div>
      <form onSubmit={handleSubmit}>{/* ... */}</form>
    </div>
  );
}
```
å…¶ä¸­ï¼Œ setSearchParams ç±»ä¼¼äº navigateï¼Œä½†æ˜¯ä»…ä»…ä¼ é€’ search å‚æ•°ã€‚

## 15. useSearchParams (React Native)

ç±»å‹å®šä¹‰ï¼š
```ts
declare function useSearchParams(
  defaultInit?: URLSearchParamsInit
): [URLSearchParams, SetURLSearchParams];

type ParamKeyValuePair = [string, string];

type URLSearchParamsInit =
  | string
  | ParamKeyValuePair[]
  | Record<string, string | string[]>
  | URLSearchParams;

type SetURLSearchParams = (
  nextInit?: URLSearchParamsInit,
  navigateOpts?: : NavigateOptions
) => void;

interface NavigateOptions {
  replace?: boolean;
  state?: any;
}
```
ä½¿ç”¨æ–¹å¼åŒä¸Šã€‚ç¤ºä¾‹ï¼š
```jsx
import * as React from "react";
import { View, SearchForm, TextInput } from "react-native";
import { useSearchParams } from "react-router-native";

function App() {
  let [searchParams, setSearchParams] = useSearchParams();
  let [query, setQuery] = React.useState(
    searchParams.get("query")
  );

  function handleSubmit() {
    setSearchParams({ query });
  }

  return (
    <View>
      <SearchForm onSubmit={handleSubmit}>
        <TextInput value={query} onChangeText={setQuery} />
      </SearchForm>
    </View>
  );
}
```2f:T3b47,![WechatIMG105.jpeg](/img/posts/2022-8-23/2022-8-23-1.png)

> é•¿åˆ—è¡¨æ»šåŠ¨ï¼Œæ˜¯ä¸€ä¸ªè€ç”Ÿå¸¸è°ˆçš„æ€§èƒ½ä¼˜åŒ–é—®é¢˜ï¼Œåœ¨æåˆ°æ€§èƒ½ä¼˜åŒ–æ—¶å´åˆæ˜¯é¿ä¸å¼€çš„è¯é¢˜ï¼Œå…¶ç›®æ ‡æ— éå°±æ˜¯`å°½å¯èƒ½åœ¨ä»»æ„æ—¶åˆ»å†…åªå…³æ³¨å¯è§†çª—å£åŒºåŸŸçš„æ•°æ®çš„æµç•…å±•ç¤ºï¼Œè€Œå¿½è§†è¢«é®æŒ¡åŒºåŸŸï¼ŒåŒæ—¶åˆä¸èƒ½å½±å“æ•°æ®çš„æ­£å¸¸æ¸²æŸ“ã€‚`æœ¬æ–‡å°½å¯èƒ½å…¨çš„æ€»ç»“ä¸€ä¸‹æ‰€æœ‰é•¿åˆ—è¡¨æ»šåŠ¨çš„ä¼˜åŒ–æ–¹æ¡ˆï¼Œä»¥ä¾›å‚è€ƒã€‚
> 
> ï¼ˆæœ¬æ–‡ä»…åœ¨æ˜é‡‘å‘å¸ƒï¼‰


## 0. å¼•

å…ˆè¯´è¯´ DOM å…ƒç´ è¿‡å¤šï¼Œé¡µé¢ä¸ºä»€ä¹ˆä¼šå¡é¡¿å‘¢ï¼Ÿæœ‰æ²¡æœ‰æƒ³è¿‡è¿™ä¸ªé—®é¢˜ï¼Ÿ

å…¶å®ç”¨ç›´è§‚æ„Ÿå—ä¹Ÿèƒ½è§‰å¯Ÿçš„å‡ºæ¥ï¼Œå› ä¸ºæµè§ˆå™¨è¦æ“å¿ƒçš„äº‹æƒ…å¤šäº†ã€‚ä¸€ä¸‹åŠ è½½å¾ˆå¤šçš„ä¸œè¥¿ï¼ŒHTML å…ƒç´  å ç”¨çš„å†…å­˜ä¼šä¸€ä¸‹å˜å¤šï¼Œæµè§ˆå™¨å•è–„çš„å°èº«æ¿å°±ä¼šåƒä¸æ¶ˆï¼Œå¦‚æœç»™æ¯ä¸ªdomåˆæ·»åŠ ç›‘å¬äº‹ä»¶ï¼Œå†åŠ ä¸Šæ„ˆåŠ å¤æ‚çš„ DOM ç»“æ„ï¼Œé©¬ä¸Šå°±ä¼šé›ªä¸ŠåŠ éœœã€‚

å¯¹é•¿åˆ—è¡¨æ»šåŠ¨å‘¢ï¼Œåˆ™ä¼šæ›´è¿›ä¸€æ­¥ï¼Œæ¯æ¬¡æ»šåŠ¨å°±ä¼šè®©é¡µé¢æ‰€æœ‰å…ƒç´ è§¦å‘å›æµé‡ç»˜ï¼Œå› ä¸ºå…¶ä½ç½®å˜åŒ–äº†å˜›ã€‚ä½ æ‰“ä¸€äº›è€æ¸¸æˆï¼Œæ¯”å¦‚çº¢è­¦ï¼Œè§†çª—å†…å•ä½è¿‡å¤šæ—¶ï¼Œå°±ä¼šå¡é¡¿ï¼Œä½ ç”¨æœ€å¥½çš„æ˜¾å¡å’ŒCPUä¹Ÿè¿˜æ˜¯ä¼šå¡é¡¿ï¼Œä»–æ˜¯å› ä¸ºè€æ¸¸æˆçš„ä¼˜åŒ–åšçš„ä¸å¤Ÿå¥½ã€‚åŒç†ï¼Œwebç«¯ä¹Ÿéœ€è¦æ­¤ç±»ä¼˜åŒ–ï¼Œå¤„ç†é•¿åˆ—è¡¨æœ‰å¦‚ä¸‹å‡ ç§æ–¹å¼ï¼š

1. åˆ†é¡µåŠ è½½ï¼šé¡µæ¬¡éƒ½æ˜¾ç¤ºå›ºå®šçš„æ¡æ•°ï¼Œæ€§èƒ½å¯æ§ã€‚
2. æ— é™æ»šåŠ¨ï¼šåˆå§‹åŠ è½½ä¸€å°éƒ¨åˆ†ï¼Œè¶Šæ»šåŠ¨åŠ è½½è¶Šå¤šã€‚è¿™ç§å‡ºç°æ€§èƒ½é—®é¢˜åªæ˜¯æ—¶é—´é—®é¢˜ã€‚
3. è™šæ‹Ÿæ»šåŠ¨ã€‚

ç¬¬ä¸€ä¸ªåˆ†é¡µåŠ è½½ä¸åœ¨ä»Šå¤©çš„è®¨è®ºèŒƒç•´ï¼Œè¿™é‡Œå°±2ã€3ä¸¤ç‚¹å¼€å§‹è°ˆè®ºã€‚

## 1. æ‡’åŠ è½½

å¯¹äºæ•°æ®å¾ˆå¤šçš„åˆ—è¡¨ï¼Œä¸€å¼€å§‹ç•Œé¢åˆå§‹åŒ–çš„æ—¶å€™è‚¯å®šä¸èƒ½æŠŠå…¨éƒ¨æ•°æ®éƒ½å¡åœ¨åˆ—è¡¨é‡Œï¼Œå…ˆåˆ«è¯´å‰ç«¯èƒ½ä¸èƒ½æ’‘å¾—ä½ï¼Œåç«¯æŸ¥è¯¢æ—¶é•¿éƒ½è¦çˆ†ç‚¸ã€‚

æœ€å¸¸è§çš„å°±æ˜¯æ‰‹æœºç«¯çš„å•†å“åˆ—è¡¨ï¼Œå¦‚ä¸‹å›¾ï¼š

![WechatIMG102.jpeg](/img/posts/2022-8-23/2022-8-23-2.png)

è®¾ç½®ä¸€ä¸ªå†…éƒ¨å¯æ»šåŠ¨çš„å®¹å™¨ï¼Œå›ºå®šé«˜åº¦ï¼Œé€šè¿‡è®¡ç®— `scrollheight` ä¸ `scrollTop` çš„å·®å€¼ä¸å®¹å™¨çš„é«˜åº¦å°±å¯çŸ¥é“æ˜¯å¦æ»šåŠ¨åˆ°äº†åº•éƒ¨ï¼š


```jsx
// htmlä¸­cssè®¾ç½®containeré«˜åº¦ 500px
<div class="container">
    <div class="item">1</div>
    <div class="item">2</div>
    <div class="item">3</div>
    ...
</div>

// js
const container = document.querySelector('.container');

container.addEventListener('scroll', () => {
  const offset = container.scrollHeight - container.scrollTop;
  const delta = 50;
  
  console.log(offset)

  if (offset <= (500 + delta)) {
    // å¯ä»¥è®¾ç½®æ»šåŠ¨é”ï¼Œé”å®šæ»šåŠ¨ç›‘å¬
    const newDom = document.createElement('div');
    newDom.setAttribute('class', 'item');
    newDom.innerText = 'æˆ‘æ˜¯æ–°åŠ çš„';
    container.appendChild(newDom)
  }
})
```


åœ¨ç”¨æˆ·æ»šåŠ¨åˆ°æœ€ä¸‹è¾¹è‡ªåŠ¨ç›‘å¬æ»šåŠ¨äº‹ä»¶åï¼Œè‡ªåŠ¨åŠ è½½å›ºå®šæ•°ç›®çš„å†…å®¹æˆ–è€…æç¤º "åŠ è½½æ›´å¤š" æ¥è®©ç”¨æˆ·ç‚¹å‡»åŠ è½½ã€‚å¦‚ä¸‹è¾¹çš„ç¤ºæ„å›¾æ‰€ç¤ºï¼Œå·²ç»æ»šåˆ°åº•åï¼ŒscrollHeight - scrollTop çš„è®¡ç®—å€¼å°±æ˜¯è§†çª—é«˜åº¦çš„ 500px äº†ï¼š

![image.png](/img/posts/2022-8-23/2022-8-23-3.png)


ä¸Šé¢ç»™å‡ºäº†ç®€æ˜“å®ç°åŸç†ï¼Œè¿™é‡Œåªæ¢è®¨æ–¹æ¡ˆå®ç°ï¼Œå…·ä½“å®ç°å¯åŠ æ»šåŠ¨é”æˆ–è€…å»¶æ—¶æ¥é˜²æ­¢è¿‡å¿«æ·»åŠ å…ƒç´ ã€‚å¯ä»¥çœ‹åˆ°è¿™é‡Œè®¾ç½®äº†ä¸€ä¸ª $delta$ åç§»å€¼ 50 åƒç´ ï¼Œåœ¨æ»šåŠ¨åˆ°è·åº•éƒ¨ 50 åƒç´ æ—¶è§¦å‘å…ƒç´ æ’å…¥ã€‚

> æ»šåŠ¨é”å…¶å®å°±æ˜¯ä¸€ä¸ªå®šæ—¶å™¨ï¼Œå¼€å§‹æ»šåŠ¨æ—¶å®šæ—¶å™¨å¼€å§‹è®¡æ—¶ï¼Œåœ¨è®¡æ—¶æœŸé—´å¯ä»¥å–æ¶ˆè®¢é˜… scroll äº‹ä»¶æˆ–è€…ç¦ç”¨äº‹ä»¶å›è°ƒé€»è¾‘ï¼Œè®¡æ—¶ç»“æŸåæ‰§è¡Œä¸€æ¬¡æ¸²æŸ“åˆ—è¡¨çš„è®¡ç®—ã€‚

- ä¼˜ç‚¹

å®ç°ç›¸å¯¹ç®€å•ï¼Œä¸éœ€è¦é¢å¤–å¼•å…¥ç±»åº“ã€‚ä¸ç”¨è€ƒè™‘æ¯ä¸€ä¸ª item çš„é«˜åº¦æœ‰å¤šå°‘ã€‚

- ç¼ºç‚¹ 

1. é¢‘ç¹ä¸‹æ‹‰ï¼Œä¼šé€ æˆæ»šåŠ¨æ¡è¶Šæ¥è¶ŠçŸ­ï¼Œä½¿å¾—æ•°æ®å±•ç¤ºæ˜¾å¾—è‡ƒè‚¿ï¼›
2. å·²ç»åŠ è½½è¿‡çš„æ»šåŠ¨éšè—åŒºåŸŸçš„æ•°æ®å¹¶æ²¡æœ‰åšæ¸²æŸ“ä¸Šçš„å¤„ç†ï¼›
3. å…¨å±€æœç´¢æˆ–é¡µé¢å›é€€åå†æ¬¡è¿›æ¥æŸ¥çœ‹åˆ—è¡¨ï¼Œæ»šåŠ¨çŠ¶æ€ä¼šä¸¢å¤±ï¼›


## 2. IntersectionObserver + ç©ºdivå ä½

é¡¾åæ€ä¹‰ï¼Œè¿™ç§æ–¹å¼æ˜¯ä½¿ç”¨ç©ºçš„divå ä½éšè—åŒºåŸŸä¹‹å¤–çš„å…ƒç´ ï¼Œè¿™ç§å¾€å¾€å¯ä»¥å’Œç¬¬ä¸€ä¸ªæ–¹æ¡ˆç»„åˆä½¿ç”¨ã€‚è¿˜æ˜¯ä¸Šé¢çš„ä¾‹å­ï¼š

```js
const container = document.querySelector('.container');
const items = Array.from(container.children) || [];

items.forEach(item => {
  const intersectionObserver = new IntersectionObserver(
    function (entries) {
      // å¦‚æœä¸å¯è§ï¼Œå°±è¿”å›
      if (!entries[0].isVisible) {
        entries[0].target.backup = entries[0].target.innerHTML || entries[0].target.backup;
        entries[0].target.innerHTML = '';
        return;
      }

      // åœ¨å¯è§†åŒºåŸŸ
      entries[0].target.innerHTML = 
      entries[0].target.backup || entries[0].target.innerHTML;
    },
    {
      threshold: [0, 1],
      /* required options*/
      trackVisibility: true,
      delay: 100  
    });

  // å¼€å§‹è§‚å¯Ÿ
  intersectionObserver.observe(item);
})
```
æˆ‘è¿™é‡Œè®¾ç½® IntersectionObserver çš„é…ç½®å±æ€§thresholdä¸º `[0, 1]`ï¼Œè¡¨ç¤ºå®Œå…¨å¯è§å’Œå®Œå…¨ä¸å¯è§æ—¶æ‰å‡ºå‘å›è°ƒã€‚é€šè¿‡åˆ¤æ–­ `isVisible` å±æ€§æ¥æ§åˆ¶ `innerHTML` æ˜¾ç¤ºå†…å®¹ã€‚è¿™é‡Œä½ éœ€è¦ä¸€ä¸ªç¼“å­˜çš„mapï¼ˆæˆ‘è¿™é‡Œå­˜åœ¨äº†domçš„backupé‡Œï¼‰ï¼Œåœ¨å¯è§†æ—¶ï¼Œæ¢å¤ `innerHTML` çš„å€¼ã€‚

è¿™æ ·åœ¨æ»šåŠ¨æ—¶æˆ‘ä»¬å†çœ‹çœ‹domç»“æ„ï¼š

![image.png](/img/posts/2022-8-23/2022-8-23-4.png)

å¯ä»¥çœ‹åˆ°ï¼Œä¸æ˜¾ç¤ºçš„åŒºåŸŸå·²ç»ç½®ä¸ºäº†ç©ºçš„diväº†ã€‚


- ä¼˜ç‚¹
1. ä½¿ç”¨åŸç”Ÿçš„H5 APIï¼Œå…¼å®¹æ€§å¥½ï¼›
2. ç»“åˆç¬¬ä¸€ç§æ–¹æ¡ˆï¼Œå¯ç›‘å¬åº•éƒ¨å…ƒç´ æ˜¯å¦å¯è§æ¥å®ç°æ— é™æ»šåŠ¨ï¼Œå®ç°ç®€å•ï¼›
3. æ²¡æœ‰domæ’å…¥åˆ é™¤æ“ä½œï¼Œå¼€é”€æ¯”è¾ƒå°ï¼Œä¸ç ´ååŸæœ‰çš„ç»“æ„ï¼›
4. ç©ºçš„divå ä½å¯ä»¥ä½¿æ»šåŠ¨æ¡çš„é«˜åº¦ä¸ä¼šè·³å˜ï¼›

- ç¼ºç‚¹
1. å°±ç®—æ˜¯ç©ºçš„divï¼Œä¹Ÿè¿˜æ˜¯ä¼šé€ æˆæ¸²æŸ“æµªè´¹ï¼›
2. ç¼“å­˜mapé€ æˆç©ºé—´æµªè´¹ï¼Œç»´æŠ¤æˆæœ¬æé«˜ï¼›
3. æ— é™æ»šåŠ¨å¤ªé¢‘ç¹ï¼Œæ»šåŠ¨æ¡è¿˜æ˜¯ä¼šç¼©ä¸ºä¸€ä¸ªç‚¹ï¼›
4. å ä½divçš„é«˜åº¦å›ºå®šäº†ï¼Œå°±æ„å‘³ç€itemçš„é«˜åº¦éœ€è¦å›ºå®šï¼›

## 3. æ•°æ®æˆªæ–­å¼å ä½

è¿™ç§æ–¹æ¡ˆå¯ä»¥çœ‹åšæ˜¯ç¬¬äºŒç§æ–¹æ¡ˆçš„å‡çº§ç‰ˆã€‚å…¶ä¸ä½¿ç”¨å°çš„divå ä½ï¼Œè€Œæ˜¯åœ¨åˆ—è¡¨å¼€å¤´å’Œç»“å°¾ï¼Œåˆ†åˆ«ç”¨ä¸¤ä¸ªå¤§çš„divå ä½ï¼Œè¾¾åˆ°æ•°æ®æˆªæ–­çš„æ•ˆæœã€‚æˆ‘ä»¬çœ‹è‰å›¾ï¼š

![1071661234958_.pic.jpg](/img/posts/2022-8-23/2022-8-23-5.png)

`startIndex` å’Œ `endIndex` å°±æ˜¯æ•°æ®æ•°ç»„ä¸­çš„çœŸå®ä¸‹æ ‡ä½ç½®ï¼Œæ‰€ä»¥è¦æ›¿æ¢çš„åŒºé—´æ˜¯ $[0, startIndex) âˆª (endIndex, children.length - 1]$ã€‚æˆ‘ä»¬è¦åšçš„å°±æ˜¯æŠŠ startIndex ä¹‹å‰å’Œ endIndex ä¹‹åçš„éƒ¨åˆ†æ›¿æ¢ä¸ºdivã€‚è¿™é‡Œå› ä¸ºè¦ç”¨åˆ° scroll å±æ€§ï¼Œæ‰€ä»¥è¿˜æ˜¯ç”¨ scroll äº‹ä»¶æ¥ç›‘å¬ï¼ŒåŒæ—¶ç‰µæ‰¯åˆ°domç»“æ„çš„å˜åŠ¨ï¼Œæ‰€ä»¥è¿˜æ˜¯ä½¿ç”¨jsæ¥æ“ä½œdomã€‚

å…ˆå®šä¹‰å®¹å™¨ï¼š

```html
// cssä¸æ˜¯é‡ç‚¹ï¼Œå¿½ç•¥
<div class="container"></div>
```
å®šä¹‰æ•°æ®å¹¶è·å–å…ƒç´ ï¼š
```js
const data = [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20];
const container = document.querySelector('.container');
```
æ¥ä¸‹æ¥å®šä¹‰ä¸€ä¸‹æ·»åŠ åˆ—è¡¨çš„æ–¹æ³•ï¼š

```js
function addList(data, container) {
  data.forEach(item => {
    const dom = document.createElement('div');
    dom.setAttribute('class', 'item');
    dom.innerHTML = item;
    container.appendChild(dom)
  });
}
```

å®šä¹‰æ»šåŠ¨äº‹ä»¶ç›‘å¬ï¼ˆå¯åŠ å…¥æ»šåŠ¨é”æˆ–è€…èŠ‚æµä¼˜åŒ–ï¼‰ï¼š

```js
container.addEventListener('scroll', () => {
  const scrollTop = container.scrollTop;

  // ä¸Šè¾¹ç©ºç™½çš„é«˜åº¦
  const topHeight = scrollTop;
  const startIndex = Math.max(Math.ceil(topHeight / 40) - 2, 0);
  const endIndex = startIndex + Math.ceil(500 / 40);

  const show = data.slice(startIndex, endIndex + 1);

  // è®¡ç®—ä¸‹è¾¹å‰©ä½™çš„éšè—åŒºåŸŸé«˜åº¦
  const dataHeight = data.length * 40;
  const bottomHeight = dataHeight - 500 - scrollTop;

  const topDom = document.createElement('div');
  const bottomDom = document.createElement('div');
  topDom.style.height = topHeight + 'px';
  bottomDom.style.height = bottomHeight + 'px';

  // è¿˜æ²¡åˆ°åº•
  if (bottomHeight > -100) {
    // æ¸…ç©º
    container.innerHTML = '';
    container.appendChild(topDom);
    addList(show, container);
    container.appendChild(bottomDom);
  }
});
```
å¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œä¸èƒ½ä½¿ç”¨ container.scrollHeight æ¥è®¡ç®—é«˜åº¦äº†ï¼Œè¦é€šè¿‡æ•°æ®ä¹˜ä»¥æ¯ä¸€è¡Œé«˜åº¦è·å–ã€‚æœ€åçš„`bottomHeight > -100`æ˜¯ä¸ºäº†é¿å…å‡ºç°è®¡ç®—è´Ÿæ•°è€Œé€ æˆçš„é¡µé¢æŠ–åŠ¨ã€‚ï¼ˆå½“ç„¶ä½ ä¹Ÿå¯ä»¥å†™æ­»ä¸€ä¸ªé˜ˆå€¼ï¼Œé¡µé¢è¶³å¤Ÿé•¿æ—¶ï¼Œè¶…è¿‡è¿™ä¸ªé˜ˆå€¼ï¼Œé¦–å°¾ä¸¤ä¸ªdivé«˜åº¦å°±å®šæ­»ã€‚ï¼‰

æœ€ååœ¨é¡µé¢åˆå§‹åŒ–æ—¶åŠ è½½ä¸€æ¬¡åˆ—è¡¨ï¼š

```js
window.onload = function() {
    addList(data, container)
}
```
æœ€åæˆ‘ä»¬åœ¨é¡µé¢ä¸Šæ»šåŠ¨ä¸€ä¸‹çœ‹çœ‹æ•ˆæœï¼š

![image.png](/img/posts/2022-8-23/2022-8-23-12.png)
æˆåŠŸï¼ï¼

æ›´é‡è¦çš„æ˜¯ï¼Œè¿™ä¸ªæ–¹æ¡ˆå®Œç¾å¥‘åˆå•é¡µåº”ç”¨æ¡†æ¶ï¼Œæ‰€æœ‰çš„domæ“ä½œéƒ½å¯ä»¥ä½¿ç”¨æ¡†æ¶è¯­è¨€æ›¿ä»£ï¼Œæ¯”å¦‚ç”¨vueçš„v-for + è®¡ç®—å±æ€§å°±å¯ä»¥å®Œæˆã€‚ä¹‹å‰åœ¨bilibilié¢è¯•çš„æ—¶å€™ï¼Œå°±é—®äº†ä¸€ä¸‹æ˜¯å¦åšè¿‡è¿™ä¸ªæ–¹æ¡ˆğŸ˜‚ã€‚

- ä¼˜ç‚¹
1. é€šç”¨æ€§å¼ºï¼Œæ€§èƒ½æå‡æ˜æ˜¾
2. å¯ä»¥ä½¿ç”¨è™šæ‹Ÿdomç­‰æ¡†æ¶å®ç°
3. ä¸ç”¨æ‹…å¿ƒæ— é™æ»šåŠ¨åœºæ™¯ä¸‹æ»šåŠ¨æ¡ç¼©ä¸ºä¸€ä¸ªç‚¹ï¼Œå› ä¸ºä½ å®Œå…¨å¯ä»¥åŠ¨æ€æ§åˆ¶é¦–å°¾ä¸¤ä¸ªdivçš„é«˜åº¦ã€‚

- ç¼ºç‚¹
1. itemçš„é«˜åº¦å¾€å¾€éœ€è¦å›ºå®š
2. æ»šåŠ¨æ¡æŠ–åŠ¨éœ€è¦ç‰¹æ®Šå¤„ç†


## 4. CSS-`content-visibility`å®ç°å¯è§†åŒºåŸŸåˆ¤å®š

å…ˆæ¥çœ‹ä¸€ä¸‹caniuseçš„å…¼å®¹æ€§ï¼š

![image.png](/img/posts/2022-8-23/2022-8-23-6.png)

ä¸»æµçš„Chromeå’ŒEdgeå€’æ˜¯éƒ½æ”¯æŒã€‚ä»–æœ‰ä¸ª `auto` å±æ€§ï¼Œå…¶ä½œç”¨æ˜¯ï¼Œå¦‚æœè¯¥å…ƒç´ ä¸åœ¨å±å¹•ä¸Šï¼Œå¹¶ä¸”ä¸ç”¨æˆ·æ— å…³ï¼Œåˆ™ä¸ä¼šæ¸²æŸ“å…¶åä»£å…ƒç´ ã€‚

é‚£æˆ‘ä»¬å°±ä½¿ç”¨`content-visibility`æ¥å®ç°ä¸€ä¸‹è™šæ‹Ÿåˆ—è¡¨ã€‚

æˆ‘ä»¬å®šä¹‰domç»“æ„ï¼š

```html
<div class="container">
    <div class="item">
      <ul>
        <li>23423</li>
        <li>23423</li>
        <li>23423</li>
        <li>23423</li>
      </ul>
    </div>
    ... è‚¥è‚ å¤šæ•°æ®åœ¨è¿™é‡Œ
</div>
```

æˆ‘ä»¬æ·»åŠ åˆ°100Wè¡Œï¼Œçœ‹ä¸€ä¸‹æ¸²æŸ“æ—¶é—´ï¼š

![image.png](/img/posts/2022-8-23/2022-8-23-13.png)

æˆ‘ä»¬æ·»åŠ åˆ°400Wè¡Œï¼š

![image.png](/img/posts/2022-8-23/2022-8-23-7.png)
ç›´æ¥å¡æ­»ï¼Œç§’æ€CPUï¼

![image.png](/img/posts/2022-8-23/2022-8-23-8.png)

æ­¤æ—¶åŠ ä¸Šä¸€æ®µcssï¼š
```css
.itemÂ {
Â Â Â Â content-visibility:Â auto;
}
```
100Wæ¡æ—¶ï¼š

![image.png](/img/posts/2022-8-23/2022-8-23-9.png)
å¯ä»¥çœ‹åˆ°ï¼Œå¯¹äºæ•°æ®é‡å¤§çš„åˆ—è¡¨ï¼Œä¼˜åŒ–çš„æ•ˆæœå¾ˆæ˜æ˜¾ã€‚

400Wè¡Œæ—¶å‹‰å¼ºèƒ½çœ‹åˆ°åˆ—è¡¨ï¼Œä½†æ˜¯è¿˜æ˜¯å¡ï¼š

![image.png](/img/posts/2022-8-23/2022-8-23-10.png)
çœ‹æ¥æ•°æ®è¶³å¤Ÿå¤šæ—¶ï¼Œå·²ç»ä¸æ˜¯ä¼˜åŒ–èƒ½å¤„ç†çš„äº†ã€‚

å…¶å®ç°åŸç†ï¼Œå…¶å®è¿˜æ˜¯å±äºæ‡’åŠ è½½ï¼Œä¸åœ¨è§†å£åŒºåŸŸçš„åœ°æ–¹å°±ä¸æ¸²æŸ“ï¼Œåªä¸è¿‡æ˜¯cssé…ç½®åè®©æµè§ˆå™¨å¸®æˆ‘ä»¬åšäº†ã€‚æ­¤æ—¶å°±æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œä¸‹æ‹‰æ»šåŠ¨æ—¶ï¼Œçªç„¶å‡ºç°äº†ä¸€äº›æ•°æ®ï¼Œæ»šåŠ¨æ¡å¿…ç„¶ä¼šæŠ–åŠ¨ï¼Œæ­¤æ—¶åœ¨é…ç½®ä¸€ä¸ªcsså±æ€§å³å¯ï¼š
```css
.itemÂ {
Â Â Â Â contain-intrinsic-size:Â 120px;
}
```
è¿™æ ·ï¼Œæµè§ˆå™¨å°±ä¼šçŸ¥é“æ¯ä¸€è¡Œçš„é«˜åº¦ï¼Œä¼šè‡ªåŠ¨æ’‘å¼€æ»šåŠ¨åŒºåŸŸã€‚

- ä¼˜ç‚¹
1. ä¸å½±å“ç½‘é¡µå…¨å±€æœç´¢
2. ä½¿ç”¨ç®€å•ï¼Œçº¯css

- ç¼ºç‚¹
1. æœªåœ¨è§†çª—åŒºåŸŸçš„å¼‚æ­¥èµ„æºè¿˜æ˜¯ä¼šè¢«åŠ è½½
2. ä¸»æµæµè§ˆå™¨å…¼å®¹æ€§å·®ï¼Œæ…ç”¨


## 5. æ€»ç»“

ç»¼ä¸Šæ‰€è¿°ï¼Œå…³äºwebé•¿åˆ—è¡¨æ»šåŠ¨æ€§èƒ½ä¼˜åŒ–çš„ç®—æ³•ï¼Œè¦ä¹ˆæ˜¯æ¸…é™¤ä¸å¯è§åŒºåŸŸçš„domå…ƒç´ ï¼Œè¦ä¹ˆæ˜¯ç”¨æ›´ç®€å•çš„å…ƒç´ æ›¿æ¢ä¹‹ï¼Œå…¶ç›®çš„æ— éå°±æ˜¯ä¸ºäº†èƒ½å¤Ÿè®©æµè§ˆå™¨çš„æ¸²æŸ“å‹åŠ›å°ä¸€ç‚¹ã€‚

å›åˆ°ä¸€å¼€å§‹ã€‚`æˆ‘ä»¬åœ¨æŠ€æœ¯é€‰å‹æ—¶ï¼Œåˆ°åº•è¦ä½¿ç”¨åˆ†é¡µå‘¢ï¼Œè¿˜æ˜¯é•¿æ»šåŠ¨å‘¢ï¼Ÿ`ä½œè€…å»ºè®®è¦è§†æƒ…å†µè€Œå®šï¼Œæ¯”å¦‚æ‰‹æœºç«¯çš„H5å°±ä¸é€‚åˆåˆ†é¡µï¼Œåˆ†é¡µæ“ä½œåœ¨å°ç©ºé—´å†…ä¸å‹å¥½ï¼Œé€‚åˆPCç«¯åº”ç”¨ã€‚æ— é™æ»šåŠ¨å‘¢ï¼Œé€‚ç”¨èŒƒå›´æ¯”è¾ƒå¹¿ï¼Œæ¯”å¦‚bilibiliä¸»ç«™PCç«¯çš„è¯„è®ºåˆ—è¡¨ï¼Œå°±æ˜¯æ— é™+è™šæ‹Ÿæ»šåŠ¨ï¼ˆå½“ç„¶bç«™ä¹Ÿåšäº†éƒ¨åˆ† åˆ†é¡µå¼ çš„ï¼‰ï¼›ä½†æ˜¯ï¼Œæ— é™æ»šåŠ¨å¯¹äºæœç´¢ä¸å‹å¥½ï¼Œæœç´¢ç»“æŸåæ‰¾ä¸åˆ°æ»šåŠ¨çš„ä½ç½®äº†ï¼Œè¿˜å¾—é‡æ–°æ»šï¼Œå“ˆå“ˆï¼åŒæ—¶æ— é™æ»šåŠ¨å¯¹äºå„ä¸ªæ¡ç›®é«˜åº¦ç›¸å·®è¿‡å¤§çš„åœºæ™¯ä¹Ÿä¸é€‚åˆã€‚

> ä¸‹å›¾ä¸­ï¼Œbç«™è¯„è®ºåˆ—è¡¨çš„äºŒçº§è¯„è®ºï¼Œå±•å¼€åä¾¿æ˜¯åˆ†é¡µçš„


![image.png](/img/posts/2022-8-23/2022-8-23-11.png)

è¯´å¥é¢˜å¤–è¯ï¼Œå‡ ä¹æ‰€æœ‰çš„æ€§èƒ½ä¼˜åŒ–ç­–ç•¥ï¼Œéƒ½æ˜¯å—äº†ç°é˜¶æ®µæœ‰é™èµ„æºçš„é™åˆ¶ã€‚æƒ³å½“å¹´2Gæ—¶ä»£ï¼Œä¸€ä¸ªæœˆå¥—é¤åŒ…20MBéƒ½å·²ç»è§‰å¾—å¾ˆå¤§äº†ï¼Œæ‰‹æœºåˆ·ä¸€ä¸ªQQå®¶å›­ä»€ä¹ˆçš„éƒ½å¾ˆå¤Ÿç”¨ï¼Œé‚£ä¸ªæ—¶å€™ä¹Ÿæ²¡è§‰å¾—ç½‘é¡µæ…¢ã€‚ç„¶è€Œç°åœ¨ä¸»æµæµè§ˆå™¨éƒ½è‡ªå¸¦å¾ˆå¤šæ€§èƒ½ä¼˜åŒ–äº†ï¼Œä½†æ˜¯ä¼¼ä¹å¤§å®¶ä»ç„¶ä¸æ»¡è¶³\[â”“(Â Â´âˆ€`Â )â”\]ã€‚

éšç€æ—¶ä»£çš„è¿›æ­¥ï¼Œè®¡ç®—æœºç®—åŠ›è¿˜ä¼šæå‡ï¼Œåˆ°æ—¶å€™ç›®å‰çš„å‰ç«¯æ€§èƒ½ä¼˜åŒ–å¯èƒ½å°±æ²¡æœ‰æ„ä¹‰äº†ã€‚ä½†æ˜¯ç°åœ¨æ˜¾ç„¶è¿˜æ²¡åˆ°é‚£ä¸€æ­¥ã€‚

å¾ˆå¤šå¹´ä»¥åï¼Œæˆ‘ä»¬å¯èƒ½ä¼šç»™è¿™ä¸ªæ—¶ä»£å–ä¸ªåå­—ï¼Œå«â€œäº’è”ç½‘æ–°çŸ³å™¨æ—¶ä»£â€ã€‚è¿™ä¸ªæ—¶ä»£é‡Œï¼Œå®ç°ä¸€ä¸ªç¨‹åºéœ€è¦ä¸€ç¾¤å†™ä»£ç çš„äººå¥½å‡ ä¸ªæœˆçš„æŠ•å…¥ï¼Œä»£ç è´¨é‡å› äººè€Œå¼‚ï¼Œç»´æŠ¤èµ·æ¥ä¹Ÿå›°éš¾ï¼Œè¿ç»´æˆæœ¬ä¹Ÿé«˜ï¼Œè‡ªåŠ¨åŒ–ç¨‹åº¦è¿‡ä½ï¼Œå¤§å¤šæ•°ä»£ç çš„ç”Ÿå‘½å‘¨æœŸä¸è¶…è¿‡5å¹´ã€‚ä»–ä»¬èµ„æºæœ‰é™ï¼Œå¤©å¤©åœ¨ä¸ºèŠ‚çœå¸¦å®½å’Œå­˜å‚¨ç©ºé—´è€Œå‘æ„ï¼Œé‚£ä¸ªæ—¶ä»£ï¼Œè¢«è¿«æ€§èƒ½ä¼˜åŒ–åå€’æˆäº†ç¨‹åºå‘˜å¿…å¤‡çš„æŠ€èƒ½äº†ã€‚

å®Œï¼

<hr />

## 6. é™„è¨€

ä¸‹é¢å°±æ€»ç»“ä¸€ä¸‹ä¸»æµå‰ç«¯æ¡†æ¶çš„ä½¿ç”¨ï¼ˆ å†…éƒ¨åŸç†è‡ªå·±çœ‹æºç å»ï¼ŒåŸç†éƒ½è®²äº†ï¼Œä»£ç è¿˜ä¸æƒ³è‡ªå·±å†™ï¼Œå¯æ˜¯ä¸ä¼šè¿›æ­¥çš„å‘¦~~ ï¼‰ï¼š

### vue-virtual-scroll-list

å¼•å…¥ï¼š
```js
import VirtualList from 'vue-virtual-scroll-list'
```
ä½¿ç”¨ï¼š
```jsx
<virtual-list style="height: 360px; overflow-y: auto;" // make list scrollable
  :data-key="'uid'"
  :data-sources="items"
  :data-component="itemComponent"
/>
...

export default {
    name: 'root',
    data () {
      return {
        itemComponent: Item,
        items: [{uid: 'unique_1', text: 'abc'}, {uid: 'unique_2', text: 'xyz'}, ...]
      }
    },
    components: { 'virtual-list': VirtualList }
}

// Itemæ˜¯æ¸²æŸ“ç»„ä»¶ï¼Œæ¥å—indexå’Œsourceå±æ€§
```

å®˜ç½‘åœ°å€ï¼š[vue-virtual-scroll-list](https://github.com/tangbc/vue-virtual-scroll-list#live-demo)

### React-window

å¼•å…¥ï¼š

```js
import { FixedSizeList as List } from 'react-window';
```
ä½¿ç”¨ï¼š

```jsx
const Column = ({ index, style }) => (
  <div style={style}>Column {index}</div>
);

const Example = () => (
  <List
    height={75}
    itemCount={1000}
    itemSize={100}
    layout="horizontal"
    width={300}
  >
    {Column}
  </List>
);
```

å®˜ç½‘åœ°å€ï¼š[react-window](https://react-window.vercel.app/#/examples/list/fixed-size)

### Angular-cdk

å¼•å…¥ï¼š(å‰ææ˜¯å¼•å…¥cdkçš„module)

```js
import {ChangeDetectionStrategy, Component} from '@angular/core';

/** @title Basic virtual scroll */
@Component({
  selector: 'cdk-virtual-scroll-overview-example',
  styleUrls: ['cdk-virtual-scroll-overview-example.css'],
  templateUrl: 'cdk-virtual-scroll-overview-example.html',
  changeDetection: ChangeDetectionStrategy.OnPush,
})
export class CdkVirtualScrollOverviewExample {
  items = Array.from({length: 100000}).map((_, i) => `Item #${i}`);
}
```
ä½¿ç”¨ï¼š
```html
<cdk-virtual-scroll-viewport itemSize="50" class="example-viewport">
  <div *cdkVirtualFor="let item of items" class="example-item">{{item}}</div>
</cdk-virtual-scroll-viewport>
```

å®˜ç½‘åœ°å€ï¼š[Angular-CDK](https://v7.material.angular.io/cdk/scrolling/overview)

<hr/>

That's all ï¼30:T14d4,## 1. å‰è¨€

æˆ‘ä»¬ç»§ç»­æˆ‘ä»¬çš„ React ç»„ä»¶åº“ç³»åˆ—ã€‚æœ¬ç¯‡ä»‹ç»å¦ä¸€ç§å¼¹å‡ºå±‚ - æ¨¡æ€æ¡†ç»„ä»¶ã€‚æœ¬æ–‡çš„ä»£ç å±•ç¤ºçš„æ˜¯ä¸»è¦çš„æ ¸å¿ƒä»£ç ï¼Œå…¨éƒ¨ä»£ç è§ä»“åº“ï¼š[Giteeä»“åº“](https://link.juejin.cn/?target=https%3A%2F%2Fgitee.com%2Fdh1992%2Fdux-ui-react%2F)ï¼Œç»„ä»¶æ ·å¼è§[ä¸»é¡µ](https://link.juejin.cn?target=https%3A%2F%2Fdh1992.gitee.io%2Fdux-ui-react%2F)ã€‚

æ¨¡æ€æ¡†å’Œä¸Šä¸€æœŸè®²çš„popoverç±»ä¼¼ï¼Œä¹Ÿæ˜¯å¼¹å‡ºå±‚ç»„ä»¶ã€‚ä¸åŒçš„æ˜¯ï¼Œæ¨¡æ€æ¡†ä¸éœ€è¦é€šè¿‡triggerè§¦å‘ï¼Œé€šè¿‡ç›‘å¬ä¼ å…¥çš„ `visible` å‚æ•°å³å¯ç¡®å®šæ˜¾ç¤ºè¿˜æ˜¯éšè—ã€‚

## 2. å®šä¹‰å…¥å‚

ä¸€ä¸ªå¼¹çª—ï¼Œä¸€èˆ¬éœ€è¦ä¸€ä¸ªtitleï¼Œä¸€ä¸ªç»“å°¾çš„æŒ‰é’®æ”¾ç½®åŒºfooterã€‚è¿˜æœ‰å¼¹çª—çš„å°ºå¯¸sizeï¼ŒèƒŒæ™¯åŒºåŸŸçš„é®ç½©maskï¼Œæœ€åè¿˜æœ‰æ˜¾ç¤ºå‚æ•°visibleä»¥åŠå¼¹çª—çš„å„ç§äº‹ä»¶ï¼š

| å±æ€§              | è¯´æ˜         |
| --------------- | ---------- |
| visible         | å—æ§ï¼Œæ§åˆ¶å¼¹å‡ºå±‚å±•ç¤º |
| title       | æ ‡é¢˜       |
| footer | è„šæ³¨       |
| size           | æšä¸¾å‡ºå†…ç½®çš„å°ºå¯¸     |
| mask          | æ˜¯å¦æ˜¾ç¤ºé®ç½©         |
| visible  | æ§åˆ¶æ˜¾ç¤º      |
| onClose | ç‚¹å‡»å…³é—­æŒ‰é’®çš„ç›¸åº”äº‹ä»¶ |
| onOk | ç‚¹å‡»ç¡®å®šæŒ‰é’®çš„ç›¸åº”äº‹ä»¶ |
| afterClose | å…³é—­ä¹‹åçš„äº‹ä»¶å›è°ƒ |

## 3. rc-dialog å°è£…

è¿™å¯¹å®šåˆ¶åŒ–å¼¹çª—ç»„ä»¶ï¼Œä½¿ç”¨rc-triggerä¼¼ä¹æœ‰äº›åŠ›ä¸ä»å¿ƒï¼Œrc-triggeré‡ç‚¹åœ¨äºå¤„ç†è§¦å‘çš„æ—¶æœºï¼Œå¼¹å‡ºå±‚è·Ÿéšç‚¹å‡»ä½ç½®ï¼Œé€‚åˆè½»é‡çº§çš„å¼¹å‡ºå±‚ï¼›æ¨¡æ€æ¡†é‡ç‚¹åœ¨äºå¤„ç†å†…å®¹å±•ç¤ºï¼Œéœ€è¦æ›´å¥½çš„å±•ç¤ºçº§çš„åº“æ¥æ”¯æŒã€‚

è¿™é‡Œä½¿ç”¨ä¸“ç”¨çš„rc-dialogï¼š

```jsx
class RcDialogWrap extends Component {
  static propTypes = {
    className: PropTypes.string,
    wrapClassName: PropTypes.string,
  };
  render() {
    const { className, wrapClassName, ...rest } = this.props as any;
    return (
      <RcDialog
        wrapClassName={classnames(className, wrapClassName)}
        {...rest}
      />
    );
  }
}
```
`className` ä¸ºå¼¹çª—å†…å®¹æ ·å¼ç±»åï¼Œ`wrapClassName` ä¸ºå¼¹çª—å®¹å™¨æ ·å¼ç±»åã€‚

æˆ‘ä»¬è‡ªå·±å®šä¹‰çš„å¼¹çª—ï¼Œè‚¯å®šéœ€è¦æ¯”rc-dialogæ›´å¤šçš„å‚æ•°å’ŒåŠŸèƒ½ï¼Œå› æ­¤æˆ‘å†ä½¿ç”¨ModalWrapåŒ…è£¹ä¸€ä¸‹åˆšåˆšçš„ç»„ä»¶ï¼š


```js
export const ModalWrap = styleWrap()(
  styled(RcDialogWrap)((props) => {
    const {
      theme: { designTokens: DT, fontSize },
      mask,
      customStyle,
    } = props as any;
    
    return css`
    
      // å¼¹çª—å®¹å™¨
      position: fixed;
      overflow: auto;
      top: 0;
      right: 0;
      bottom: 0;
      left: 0;
      z-index: 1010;
      -webkit-overflow-scrolling: touch;
      outline: 0;
    
      ...
    `
  })
);
```

å¯ä»¥çœ‹åˆ°ï¼Œæ•´ä¸ªå¼¹çª—ä½¿ç”¨fixedå®šä½ï¼Œå¹¶ä¸”å±…ä¸­æ”¾ç½®ï¼Œz-indexè®¾ç½®æ¯”è¾ƒå¤§ï¼Œç¡®ä¿åœ¨æœ€é¡¶å±‚å³å¯ã€‚

æˆ‘ä»¬å†æ¥çœ‹çœ‹ ModalWrapæ˜¯æ€ä¹ˆä½¿ç”¨çš„ï¼š


```jsx
...
<ModalWrap
  // é»˜è®¤çš„ä¸€äº›ç›´ä¼ å±æ€§ï¼Œæ¯”å¦‚ visible ç­‰
  {...rest}
  style={{
    // æ¥å—è‡ªå®šä¹‰çš„widthæ ·å¼
    width: width,
    ...style,
  }}
  // prefixClsä¸ºç»„ä»¶åº“å‰ç¼€ï¼Œè¿™é‡Œä¸º dux-ui-modal
  prefixCls={prefixCls}
  // è¿™é‡Œç¦ç”¨rc-dialogè‡ªå¸¦çš„å…³é—­æŒ‰é’®
  closable={false}
  // ä¼ é€’rc-dialogå¯è¯†åˆ«çš„åŠ¨ç”»
  animation="slide-fade"
  maskAnimation="fade"
  onClose={onClose}
  title={[
    <div key="content" className={`${prefixCls}-title-content`}>
      {title}
    </div>,

    closable && (
      <Icon
        key="close"
        type="remove_circle"
        className={`${prefixCls}-close`}
        onClick={onClose}
      />
    ),
  ]}
  // ä½¿ç”¨äº†lodashï¼š_
  footer={_.isFunction(footer) ? footer({ locale }) : footer}
>
  // è·å–ref
  <div ref={this.savePopupContainer}></div>
  // å†…å®¹ç‰©
  {children}
</ModalWrap>
```

æˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹ä¸Šé¢çš„ä»£ç ã€‚

- animation å’Œ maskAnimation ä¸ºç›´ä¼ ç»™ rc-dialog çš„åŠ¨ç”»é…ç½®é¡¹ï¼›
- onClose æ˜¯å…³é—­äº‹ä»¶ï¼Œç”±propsä¼ å…¥
- title å°è£…äº†ä¼ å…¥çš„ title å…ƒç´ å’Œ å…³é—­æŒ‰é’®Iconï¼Œå¹¶ä»˜ç»™å…³é—­äº‹ä»¶onClose
- footer ä¹Ÿæ˜¯ç›´ä¼ å‚æ•°ã€‚å¯è‡ªå®šä¹‰ï¼ŒåŒæ—¶ä¹Ÿå†…ç½®äº†ä¸€ç»„æ“ä½œè„šæ³¨ï¼š

```js
getDefaultFooter = () => {
    const { onOk, onClose, locale } = this.props as any;
    return [
      <Button size="lg" key="cancel" onClick={onClose} style={{ marginRight: 8 }}>
        {locale.cancel}
      </Button>,
      <Button size="lg" key="confirm" onClick={onOk} styleType="primary">
        {locale.confirm}
      </Button>,
    ];
};
```

å¤–å£³å’Œäº‹ä»¶å¤„ç†çœ‹å®Œäº†ï¼Œå†çœ‹çœ‹å†…å®¹ç‰© children æ˜¯æ€ä¹ˆå¤„ç†çš„ã€‚æˆ‘ä»¬ä¸ºäº†ä½¿ç”¨ä¾¿åˆ©ï¼Œå¯¹ç”¨æˆ·æš´éœ²å‡ºä¸€ä¸ªå†…ç½®çš„modal content ç»„ä»¶ï¼Œå…¶å®å°±æ˜¯ä¸€ä¸ªåŠ äº†æ ·å¼çš„ divï¼š


```jsx
export const SContent = styleWrap({ className: contentCls })(
  styled.div((props) => {
    const { maxHeight } = props as any;
    return css`
      padding: 16px 20px;
      overflow: auto;
      max-height: ${maxHeight};
    `;
  }),
);
```

## 4. ä¸€ä¸ªğŸŒ°

æˆ‘ä»¬æ¥ä½¿ç”¨ä»¥ä¸‹åˆšåˆšå†™å¥½çš„ç»„ä»¶ï¼š


```jsx
...
const props = {
    visible: true
}
<Modal
    {...props}
    onClose={() => this.close()}
    afterClose={() => console.log('afterClose')}
    onOk={() => console.log('onOk')}
    title="this is title"
>
    <Modal.Content>this is content</Modal.Content>
</Modal>
```

ç•Œé¢å¦‚ä¸‹ï¼š


![image.png](/img/posts/2022-6-28/2022-6-28-1.png)

---

æ¨¡æ€æ¡†ç›¸å¯¹æ¯”è¾ƒç®€å•ï¼Œæœ¬æ–‡å°±åˆ°æ­¤ç»“æŸå•¦~~31:T24ab,## 1. å‰è¨€

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æˆ‘ä»¬ç»§ç»­æˆ‘ä»¬çš„ React ç»„ä»¶åº“ç³»åˆ—ã€‚æœ¬ç¯‡ä»‹ç»å¼¹å‡ºå±‚ PopOverä»¥åŠ tooltip çš„å®ç°ã€‚æœ¬æ–‡çš„ä»£ç å±•ç¤ºçš„æ˜¯ä¸»è¦çš„æ ¸å¿ƒä»£ç ï¼Œå…¨éƒ¨ä»£ç è§ä»“åº“ï¼š[Githubä»“åº“](https://github.com/heiheihoho1213/dux-ui)ï¼Œç»„ä»¶æ ·å¼è§[ä¸»é¡µ](https://heiheihoho1213.github.io/dux-ui/)ã€‚


## 2. å®šä¹‰å…¥å‚

é¦–å…ˆï¼Œè¿˜æ˜¯å…ˆç¡®å®šä¸€ä¸‹ä¸€ä¸ªå¼¹å‡ºå±‚éƒ½éœ€è¦ä»€ä¹ˆå‚æ•°æ¥æ§åˆ¶å‘¢ã€‚ç›¸ä¿¡å¤§å®¶ä¹Ÿéƒ½ç”¨è¿‡Tooltipä¹‹ç±»çš„ç»„ä»¶ï¼Œè‚¯å®šæœ‰æ§åˆ¶æ˜¾ç¤ºéšè—çš„å±æ€§ï¼Œè¿˜æœ‰å±•å¼€æ–¹å‘ç­‰ï¼Œæˆ‘è¿™é‡Œæ€»ç»“äº†ä¸€ä¸‹åŸºç¡€çš„å±æ€§ï¼š


| å±æ€§ | è¯´æ˜ |
| --- | --- |
| visible | å—æ§ï¼Œæ§åˆ¶å¼¹å‡ºå±‚å±•ç¤º |
| trigger | è§¦å‘æ–¹å¼ |
| placement | å±•å¼€æ–¹å‘ |
| onVisibleChange | æ˜¾ç¤ºäº‹ä»¶ |
| popup | å¼¹å‡ºå±‚çš„å…ƒç´  |
| zIndex | å±‚çº§ |
| popupClassName | å¼¹å‡ºå±‚ç±»å |


## 3. rc-trigger

[rc-trigger](https://www.npmjs.com/package/rc-trigger)æ˜¯ä¸€å¥—æµè¡Œçš„å¼€æºåº“ï¼Œé›†æˆäº†å„ç§è§¦å‘æ–¹å¼åˆ¤æ–­ã€å¼¹å‡ºå±‚æ¸²æŸ“ç­‰åŠŸèƒ½ã€‚æœ¬ç»„ä»¶åº“å°±ä½¿ç”¨è¯¥ç¬¬ä¸‰æ–¹åº“ã€‚

å…ˆå¼•å…¥ä¸€ä¸‹ï¼š

```js
import RcTrigger from 'rc-trigger';
```
ç„¶åå£°æ˜ä¸€ä¸ªrcTriggerçš„ç»„ä»¶ï¼š

```jsx
class RcTriggerWrap extends Component {
  static propTypes = {
    className: PropTypes.string,
    popupClassName: PropTypes.string,
    trueClassName: PropTypes.string,
  };
  render() {
    const { className, popupClassName, trueClassName, ...rest } = this.props as any;
    return (
      <RcTrigger
        className={trueClassName}
        popupClassName={classnames(className, popupClassName)}
        {...rest}
      />
    );
  }
}
```

æ¥ä¸‹æ¥ï¼Œç”¨styledæ ·å¼åŒ…è£¹ä¸€ä¸‹ï¼Œä¾¿äºæˆ‘ä»¬è‡ªå®šä¹‰æ ·å¼ï¼š

```jsx
import styled from '@emotion/styled';

export const PopoverWrap = styled(RcTriggerWrap)`
    /* æ”¾ç½®css */
`;
```
è¿™ä¸ª`PopoverWrap`ä¾¿æ˜¯æˆ‘ä»¬ä¹‹åè¦ç”¨çš„å¼¹å‡ºå±‚ç»„ä»¶çš„å¤–å£³äº†ã€‚

å¼¹å‡ºå±‚çš„ç»„ä»¶ï¼Œå…¶å®åªéœ€è¦å¯¹å¤–æš´éœ² `action` ã€`placement` å’Œ `popup`å±æ€§å°±è¡Œäº†ï¼Œæ‰€è°“åœ¨å¯¼å‡ºæ—¶ï¼Œæˆ‘ä»¬éœ€è¦å†å°è£…ä¸€ä¸‹ã€‚

åœ¨ç»„ä»¶åº“çš„index.tsxæ–‡ä»¶ä¸­ï¼Œå¯ä»¥è¿™æ ·ä½¿ç”¨ï¼š


```tsx
...
return <PopoverWrap
            action={trigger}
            popupPlacement={placement}
            popupTransitionName={
              transitionName || animation ? animationPrefixCls + '-' + animation : null
            }
            popupVisible={popup == null ? false : this.state.visible}
            popup={popup}
            onPopupVisibleChange={this.onVisibleChange}
            popupClassName={className}
            getPopupContainer={getPopupContainer}
      >
            {children}
      </PopoverWrap>
```
- `action`å¯¹åº”çš„æ˜¯rc-triggerçš„actionå±æ€§ï¼Œtriggeré€šè¿‡propsæ¥å—ã€‚æŒ‡çš„æ˜¯è§¦å‘å¼¹å‡ºçš„æ“ä½œï¼Œå¯é€‰é¡¹æœ‰ 'hover','click','focus','contextMenu'ï¼Œæ˜¯ä¸€ä¸ªæ•°ç»„å‚æ•°ï¼Œé»˜è®¤ä¸ºï¼š`['hover']`

- `popupPlacement`å¯¹åº”çš„æ˜¯rc-triggerçš„popupPlacementå±æ€§ï¼Œé€šè¿‡propsæ¥å—ã€‚æ˜¯ä¸€ä¸ªæšä¸¾é¡¹ï¼Œæšä¸¾å®šä¹‰å¦‚ä¸‹ï¼š

```ts
placement?:
    | 'topLeft'
    | 'top'
    | 'topRight'
    | 'bottomLeft'
    | 'bottom'
    | 'bottomRight'
    | 'leftTop'
    | 'left'
    | 'leftBottom'
    | 'rightTop'
    | 'right'
    | 'rightBottom';
```

- `popupTransitionName`å¯¹åº”rc-triggerçš„popupTransitionNameå±æ€§ï¼Œå®šä¹‰å¼¹å‡ºçš„åŠ¨ç”»ï¼Œæ˜¯å¯é€‰é¡¹ã€‚å¯é€šè¿‡propsæ¥å—animationå±æ€§æ¥å®šä¹‰ã€‚ç›®å‰ï¼Œrc-triggeråªæ”¯æŒä¸Šä¸‹æ–¹å‘çš„åŠ¨ç”»ï¼Œå…¶å†…éƒ¨ä½¿ç”¨äº†rc-animationï¼Œå¯é€‰é¡¹å¦‚ä¸‹ï¼š
`"fade" | "zoom" | "bounce" | "slide-up"`

- `popupVisible`å¯¹åº”rc-triggerçš„popupVisibleå±æ€§ï¼Œåœ¨ç”¨æˆ·ä¼ äº†popupåï¼Œé€šè¿‡props.visibleå±æ€§æ¥æ§åˆ¶ï¼Œè‹¥ç”¨æˆ·æ²¡æœ‰ä¼ popupï¼Œå¼ºè¡Œç½®ä¸ºfalse

- `popup`å¯¹åº”rc-triggerçš„popupå±æ€§ï¼Œæ˜¯æœ€æ ¸å¿ƒçš„å‚æ•°ï¼Œå¯ä¼ ä¸€ä¸ªElementå…ƒç´ ï¼Œç”¨äºå¼¹å‡ºå±‚çš„å±•ç¤ºã€‚
- `onPopupVisibleChange`å±æ€§åŒä¸Šï¼Œåœ¨popupå¼¹å‡ºæ—¶è§¦å‘ã€‚
- `popupClassName`å¯¹åº”rc-tableçš„popupClassNameï¼Œç»™å¼¹å‡ºå±‚åŠ ä¸€ä¸ªç±»åã€‚
- `getPopupContainer`å¯¹åº”rc-tableçš„getPopupContainerï¼Œå¯ä»¥è‡ªå®šä¹‰ä¸€ä¸ªå¼¹å‡ºå±‚å®¹å™¨ï¼Œéå¿…é€‰é¡¹ã€‚
- æœ€åä¸èƒ½å°‘äº†å‚æ•° `children`, é€šè¿‡hoveræˆ–è€…clickè¿™ä¸ªchildrenæ‰èƒ½è§¦å‘å¼¹å‡ºå±‚çš„å˜åŒ–ã€‚rc-triggerç»„ä»¶å¯ä»¥éšæ€§çš„ä¼ ä¸€ä¸ªåŒåçš„childrenï¼Œæ–‡æ¡£é‡Œè™½ç„¶æ²¡æœ‰å†™æ˜ï¼Œä½†æ˜¯reactç»„ä»¶é»˜è®¤éƒ½å¯ä»¥è¿™æ ·ä¼ é€’ã€‚


## 4. å®šä¹‰æ ·å¼

å¯¹äºå¼¹å‡ºå±‚ç»„ä»¶çš„å¤–å£³PopoverWrapï¼Œè¿˜è®°å¾—ä¸Šè¾¹é¢„ç•™çš„æ ·å¼çš„ç©ºç™½äº†å—ï¼Œæˆ‘ä»¬è¿™é‡Œåˆ†æƒ…å†µè®¨è®ºã€‚

å…ˆæŠŠå¤–å£³è®¾ç½®ä¸ºç»å¯¹å®šä½ï¼Œè¿™æ˜¯ä¸ºäº†é…åˆrc-triggerçš„topå’Œbottomæ ·å¼ï¼Œå¦å¤–ï¼Œæƒ³è¦å¼¹å‡ºå±‚è·Ÿéšç‚¹å‡»åŒºåŸŸï¼Œä¹Ÿå¿…é¡»ç»å¯¹å®šä½ï¼Œçˆ¶å…ƒç´ ä½¿ç”¨ç›¸å¯¹å®šä½ã€‚

```tsx
const _prefixCls = 'dux-ui'; // é€šè¿‡å¯¼å…¥å…¨å±€å˜é‡è·å¾—

export const prefixCls = _prefixCls + '-popover';
export const animationPrefixCls = prefixCls + '-animation';

export const PopoverWrap = styled(RcTriggerWrap)`
  &.${prefixCls} {
    // å¼¹å‡ºå±‚ç»å¯¹å®šä½
    position: absolute;
    z-index: 1030;
    display: block;

    &-hidden {
      display: none;
    }
  }
  ...
`;
```

åœ¨æ§åˆ¶å°é‡Œå¯ä»¥çœ‹åˆ°ï¼š

![WeChat37acb5ff66ca4ccd10b4cf17b7162a84.png](/img/posts/2022-6-22/2022-6-22-1.png)

rc-triggerä¼šåœ¨ä¼ å…¥çš„popupClassNameåæ‹¼æ¥ä¸€ä¸ªå¸¦æœ‰æ–¹å‘å‚æ•°çš„ç±»åï¼Œç”±æ­¤ï¼Œæˆ‘ä»¬æ¥å®šä¹‰å„è‡ªçš„æ ·å¼ï¼Œä»¥å·¦ä¸‹å’Œå·¦ä¸Šä¸ºä¾‹ï¼š


```scss
&-enter-active.${prefixCls}-placement-bottomLeft,
    &-appear-active.${prefixCls}-placement-bottomLeft {
    animation-name: ${slideUpIn};
    animation-play-state: running;
}
&-enter-active.${prefixCls}-placement-topLeft,
    &-appear-active.${prefixCls}-placement-topLeft {
    animation-name: ${slideDownIn};
    animation-play-state: running;
}
```

åˆ†åˆ«é…ç½®ä½¿ç”¨ä¸åŒçš„åŠ¨ç”»ï¼Œå¦‚æœä¸æƒ³è‡ªå®šä¹‰åŠ¨ç”»ï¼Œä¹Ÿå¯ä»¥ä¸è®¾ç½®ã€‚


å¦‚æœpropsä¸­å£°æ˜äº†åŠ¨ç”»ç±»å‹ï¼Œåˆ™ä¼šæœ‰ä¸€ä¸ªè¿™æ ·çš„ç±»åï¼š

![WeChat2b4c3d7733fd94dae215a0b13c47490f.png](/img/posts/2022-6-22/2022-6-22-2.png)


ä»¥fadeä¸ºä¾‹ï¼Œå¯ä»¥è¿™æ ·å£°æ˜cssï¼š

```css
const animationDuration = '0.1s';

...
&-fade {
  &-enter,
  &-appear,
  &-leave {
    animation-duration: ${animationDuration};
    animation-fill-mode: both;
  }
  &-enter,
  &-appear {
    animation-name: ${fadeIn};
  }
  &-leave {
    animation-name: ${fadeOut};
  }
}
```

è‡³äºåŠ¨ç”»çš„å…·ä½“å†™æ³•ï¼Œæœ‰å¾ˆå¤šç§ï¼Œè¿™é‡Œä»¥æ·¡å…¥æ·¡å‡ºä¸ºä¾‹ï¼Œå®ç°ä¸€ç§ä½œä¸ºå‚è€ƒï¼š

```css
export const fadeIn = keyframes`
    from {
        opacity: 0;
    }

    to {
        opacity: 1;
    }
`;
export const fadeOut = keyframes`
    from {
        opacity: 1;
    }

    to {
        opacity: 0;
    }
`;
```

## 5. ä¸€ä¸ªğŸŒ° 

æœ‰äº†è¿™äº›åŸºæœ¬çš„é…ç½®ï¼Œä¸€ä¸ªå¼¹å‡ºå±‚ç»„ä»¶å°±èƒ½è·‘èµ·æ¥äº†ã€‚

æµ‹è¯•ï¼š

```tsx
const Popup = () => (
  <div style={{ height: 30, border: '1px solid #ddd', background: '#fff' }}>This is a popup</div>
);

<Popover trigger={['hover']} popup={<Popup />}>
    <Content>{'hover'}</Content>
</Popover>
```

é¢„è§ˆæ•ˆæœï¼š


![WeChatee739043574f992511ff4658245bc54f.png](/img/posts/2022-6-22/2022-6-22-3.png)

æˆåŠŸï¼


## 6. è¿›é˜¶ï¼šåšä¸€ä¸ªTooltip

Tooltipçš„åº•å±‚ï¼Œå…¶å®å°±æ˜¯ä¸€ä¸ªpopoverï¼Œæˆ‘ä»¬æ¥å®ç°ä¸€ä¸‹ã€‚

ç›´æ¥çœ‹returnçš„ç»“æœï¼š

```tsx
<Popover
      placement={placement}
      popupClassName={...}
      popup={popup}
 />
```
Tooltipä¸åŒäºé€šç”¨å¼¹å‡ºå±‚çš„åœ°æ–¹åœ¨äºpopupçš„å†…å®¹ï¼Œä»–ä¼šæœ‰ä¸€ä¸ªç±»ä¼¼æ¼«ç”»å¯¹è¯æ¡†çš„å°ç®­å¤´ã€‚é‚£æˆ‘ä»¬æ¥å®šä¹‰ä¸€ä¸‹popupï¼š


```tsx
export const arrowWrapCls = popoverPrefixCls + '-span' + '-arrow-wrap';
export const arrowCls = popoverPrefixCls + '-span' + '-arrow-inner';

const popup = useMemo(() => {
    return (
      <TooltipWrap>
        {arrow && (
          <Arrow className={arrowWrapCls}>
            <ArrowInner className={arrowCls} />
          </Arrow>
        )}
        <ContentWrap customStyle={customStyle}>
          {popup}
        </ContentWrap>
      </TooltipWrap>
    );
  }, [popup, arrow, customStyle, theme]);
```

å¯ä»¥çœ‹åˆ°å…¶æ¥å—äº†å‡ ä¸ªæ–°çš„å‚æ•°ï¼Œæˆ‘ä»¬ä¸€ä¸ªä¸ªæ¥åˆ†æã€‚

- `arrow`: ä¸€ä¸ªboolå€¼ï¼Œæ§åˆ¶æ˜¯å¦æ˜¾ç¤ºç®­å¤´ã€‚é»˜è®¤æ˜¯æ²¡æœ‰çš„ï¼š

![image.png](/img/posts/2022-6-22/2022-6-22-4.png)

æˆ‘ä»¬æ¥å®šä¹‰ç®­å¤´çš„æ ·å¼ï¼Œä»¥ top çš„æ–¹å‘ä¸ºä¾‹ï¼š


```css
const arrowMixin = css`
  display: inline-block;
  position: absolute;
  width: 0;
  height: 0;
  border-width: 0;
  border-color: transparent;
  border-style: solid;
`;

export const Arrow = styled('span')`
  ${arrowMixin};
`;
export const ArrowInner = styled('span')`
  ${arrowMixin};
`;

.${arrowWrapCls}, .${arrowCls} {
    margin-left: -${arrowWidth};
    border-width: ${arrowWidth} ${arrowWidth} 0 ${arrowWidth};
    border-bottom-color: transparent;
    border-left-color: transparent;
    border-right-color: transparent;
}
.${arrowWrapCls} {
    bottom: -${arrowWidth};
}
.${arrowCls} {
    bottom: ${borderWidth};
}
```
å¯ä»¥çœ‹åˆ°ï¼Œç”¨ä¸€ä¸ªç»å¯¹å®šä½çš„spanåŒ…è£¹ï¼Œè®¾ç½®å®½é«˜æ˜¯0ï¼Œç„¶åè®¾ç½®å…¶ä¸Šã€å³ã€å·¦è¾¹æ¡†å®½åº¦åå†è®¾ç½®å‚ç›´æ–¹å‘çš„åæ–¹å‘ï¼Œå³ä¸‹ã€å·¦ã€å³è¾¹æ¡†ä¸ºé€æ˜è‰²ï¼Œæ¨¡æ‹Ÿä¸€ä¸ªç®­å¤´å‡ºæ¥ï¼Œæ•ˆæœå›¾å¦‚ä¸‹ï¼š


![image.png](/img/posts/2022-6-22/2022-6-22-5.png)

åŒç†ï¼Œå¯è®¾ç½®å…¶ä»–æ–¹å‘çš„ç®­å¤´æ ·å¼~~

- `popup`: æ˜¯å¼¹å‡ºå±‚å…ƒç´ ã€‚
- `TooltipWrap`å’Œ`ContentWrap`æ˜¯styledåŒ…è£¹ç»„ä»¶ï¼Œæœ¬è´¨æ˜¯ä¸ªdivï¼Œå¯ä»¥è‡ªå®šä¹‰æ ·å¼ã€‚

---

è‡³æ­¤ï¼Œå¼¹å‡ºå±‚ç»„ä»¶ä¹Ÿè®²å®Œè¾£~~32:T3a4b,## 1. å‡ºç°èƒŒæ™¯

åº”å“åº”å¼ç¼–ç¨‹çš„éœ€æ±‚ï¼Œå‡ºç°äº† Rx è¿™æ ·çš„ä¸“é—¨ç”¨æ¥å¤„ç†æ•°æ®å“åº”å¼çš„åº“ã€‚Rxå®¶æ—æœ‰å¾ˆå¤š: RxJavaï¼ŒRxSwift, Rx.NETç­‰ï¼Œè¿™é‡Œä¸»è¦ä»‹ç» RxJs çš„ä½¿ç”¨ã€‚

RxJs æ˜¯ä¸€ä¸ªç›¸å½“çµæ´»çš„ï¼Œä½¿ç”¨JavaScriptè¯­è¨€çš„æ•°æ®å“åº”å¼åº“ã€‚ä½¿ç”¨ç›¸å½“çš„çµæ´»ï¼ŒAPIç¹å¤šï¼Œå­¦ä¹ æˆæœ¬ä½ï¼Œç”¨å®˜ç½‘çš„è¯å«`å¯ä»¥æŠŠ RxJS å½“åšæ˜¯ç”¨æ¥å¤„ç†äº‹ä»¶çš„ Lodash `ã€‚

## 2. å…³é”®è¯

ReactiveXã€è§‚å¯Ÿè€…æ¨¡å¼ã€è¿­ä»£å™¨æ¨¡å¼ã€å‡½æ•°å¼ç¼–ç¨‹ã€æ•°æ®ç®¡é“ã€‚

## 3. RxJsç‰¹ç‚¹

1.  çº¯å‡€æ€§ (Purity)ï¼šä½¿ç”¨çº¯å‡½æ•°æ¥äº§ç”Ÿå€¼

> ä¸‹å›¾ä¸­ï¼ŒfromEventä¾¿æ˜¯çº¯å‡½æ•°ï¼Œå‡½æ•°çš„è¾“å‡ºä¸éšå¤–éƒ¨å˜é‡çš„å½±å“
> ![1.png](/img/posts/2022-6-19/2022-6-19-1.png)

2.  æµåŠ¨æ€§ (Flow)ï¼šRxJS æä¾›äº†ä¸€æ•´å¥—æ“ä½œç¬¦æ¥å¤„ç†æ•°æ®æµåŠ¨

> å¸¸ç”¨çš„è¿ç®—æœ‰ filterã€delayã€debounceTimeã€throttleTimeã€takeã€takeUntilã€distinctã€distinctUntilChanged

![2.png](/img/posts/2022-6-19/2022-6-19-2.png)

3.  ä»¥å€¼ (Values)ä¼ é€’ï¼šå¯¹äºæµç» observables çš„å€¼ï¼Œä½ å¯ä»¥å¯¹å…¶è¿›è¡Œè½¬æ¢ã€‚

> è¿˜æ˜¯ç‚¹å‡»äº‹ä»¶çš„ä¾‹å­ï¼Œä¸‹å›¾ä¸­çš„mapå’Œscanä¾¿å¯ä»¥å¯¹æµç»çš„æ•°æ®å€¼è¿›è¡Œæ˜ å°„å’Œæ•°å€¼è®¡ç®—

![3.png](/img/posts/2022-6-19/2022-6-19-3.png)

4.  Observable (å¯è§‚å¯Ÿå¯¹è±¡)

> Rxä¸­ä¸€åˆ‡éƒ½æ˜¯å¯è§‚å¯Ÿå¯¹è±¡ï¼Œæ•°æ®å€¼æ”¾åœ¨å¯è§‚å¯Ÿå¯¹è±¡ä¸­ã€‚å¯¹è±¡é€šè¿‡nextæ–¹æ³•å¾€æ•°æ®ç®¡é“é‡Œæ”¾å…¥å€¼ï¼Œåœ¨æ¥æ”¶ç«¯ï¼Œå¯ä»¥è®¢é˜…ï¼ˆsubscribeï¼‰åˆ›å»ºå‡ºæ¥çš„åŒä¸€ä¸ªå¯è§‚å¯Ÿå¯¹è±¡ï¼Œé€šè¿‡è®¢é˜…äº‹ä»¶**å¼‚æ­¥åœ°**æ‹¿åˆ°æ•°æ®å˜åŒ–çš„å†…å®¹ï¼Œå¹¶ä¸”å¯ä»¥å¤„ç†ä¼ è¾“å¼‚å¸¸ã€‚

> ä¸‹å›¾ä¸­å¯ä»¥çœ‹å‡ºï¼Œsubscribeè¢«åˆ›å»ºæ—¶ï¼Œè‹¥ç®¡é“é‡Œæœ‰å€¼ï¼Œä»–ä¼šä¾æ¬¡éå†ä¸€ä¸‹å„ä¸ªå€¼ï¼ˆè¿™å¯ä»¥ç”¨ä½œå±€éƒ¨ç¼“å­˜ï¼‰ï¼Œå¹¶å¯è‡ªå®šä¹‰å¤„ç†å‡½æ•°ã€‚å¯¹äºå®ä»»åŠ¡ï¼ˆsetTimeoutï¼‰ä¼šå»¶ååˆ¤æ–­ã€‚

![4.png](/img/posts/2022-6-19/2022-6-19-4.png)

ä¸Šå›¾ä¸­ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥çœ‹åˆ°ä¸€ä¸ªå®Œæ•´çš„ subscribe è®¢é˜…å†…éƒ¨çš„æ„æˆã€‚nextå‡½æ•°æ¥å—ç®¡é“ä¼ å€¼ï¼›erroræ¥å—ä¼ å€¼å¼‚å¸¸åçš„é”™è¯¯ä¿¡æ¯ï¼›å½“å“åº”å¼å¯¹è±¡è°ƒç”¨completeå‡½æ•°åï¼Œæ‰§è¡Œcompleteå‡½æ•°ï¼Œå¹¶ç»“æŸè¯¥æ¬¡è®¢é˜…ã€‚

ä¸€èˆ¬ä¸Šï¼Œsubscribeå‡½æ•°è°ƒç”¨æ—¶ï¼Œåªæ¥å—ä¸€ä¸ªå‚æ•°çš„è¯ï¼Œé»˜è®¤å°±æ˜¯nextè¿‡æ¥çš„æ•°æ®å€¼ã€‚

> **ä¸å‡½æ•°ã€è¿­ä»£å™¨çš„åŒºåˆ«**
>
> *   å‡½æ•°å’Œ Observables éƒ½æ˜¯æƒ°æ€§è¿ç®—ã€‚å¦‚æœä½ ä¸è°ƒç”¨å‡½æ•°ï¼Œå°±ä¸ä¼šæ‰§è¡Œã€‚Observables ä¹Ÿæ˜¯å¦‚æ­¤ï¼Œå¦‚æœä½ ä¸â€œè°ƒç”¨â€å®ƒ(ä½¿ç”¨ subscribe)ï¼Œä¹Ÿä¸ä¼šæ‰§è¡Œ
>
> *   ES2015 å¼•å…¥äº† generator å‡½æ•°å’Œ iterators (function\*)ï¼Œè¿™æ˜¯å¦å¤–ä¸€ç§ç±»å‹çš„æ‹‰å–ä½“ç³»ã€‚è°ƒç”¨ iterator.next() çš„ä»£ç æ˜¯æ¶ˆè´¹è€…ï¼Œå®ƒä¼šä» iterator(ç”Ÿäº§è€…) é‚£â€œå–å‡ºâ€å¤šä¸ªå€¼ã€‚
>
> Observable å¯ä»¥éšç€æ—¶é—´çš„æ¨ç§»â€œè¿”å›â€å¤šä¸ªå€¼ï¼Œè¿™æ˜¯å‡½æ•°æ‰€åšä¸åˆ°çš„ã€‚

å­¦ä¹ RxJsï¼Œé¦–å…ˆå¾—å¼„æ‡‚ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å¼çš„ä¸»è¢«åŠ¨å…³ç³»ï¼š

| ç”Ÿäº§è€…                 | æ¶ˆè´¹è€…                 |
| ------------------- | ------------------- |
| æ‹‰å–æ˜¯è¢«åŠ¨çš„: å½“è¢«è¯·æ±‚æ—¶äº§ç”Ÿæ•°æ®ã€‚  | æ‹‰å–æ˜¯ä¸»åŠ¨çš„: å†³å®šä½•æ—¶è¯·æ±‚æ•°æ®ã€‚   |
| æ¨é€æ˜¯ä¸»åŠ¨çš„: æŒ‰è‡ªå·±çš„èŠ‚å¥äº§ç”Ÿæ•°æ®ã€‚ | æ¨é€æ˜¯è¢«åŠ¨çš„: å¯¹æ”¶åˆ°çš„æ•°æ®åšå‡ºååº”ã€‚ |

RxJsæ˜¯ä¸»åŠ¨æ¨é€ã€è¢«åŠ¨æ¥å—æ¨¡å¼ã€‚ç®¡é“å…¥å£ï¼ˆå¯è®¢é˜…å¯¹è±¡ï¼Œæ¯”å¦‚Subjectï¼‰å¼ºè¡Œæ¨é€å€¼ï¼Œåœ¨å‡ºå£å¤„å¯é€‰æ‹©åœ°æ¥å—å’Œè¿‡æ»¤æ•°æ®ã€‚

ç¤ºä¾‹å‚è€ƒï¼š`<https://cn.rx.js.org/manual/overview.html#h21>`

## 4. å¸¸ç”¨è¿ç®—ç¬¦

#### $1. of/from$

å°†æ™®é€šå¯¹è±¡è½¬æ¢ä¸ºrxjså¯æ£€æµ‹çš„å“åº”å¼å¯¹è±¡

![5.png](/img/posts/2022-6-19/2022-6-19-5.png)

> ä¸åŒç‚¹ï¼š ofè®¢é˜…åå¿ å®çš„æ‰“å°æºå¯¹è±¡ï¼Œfromä¼šå°†æºå¯¹è±¡è§£æ„åä¾æ¬¡æ‰“å°ã€‚æ˜¯ä¸æ˜¯æœ‰ç‚¹åƒPromise.all ?

#### $2. map$

![6.png](/img/posts/2022-6-19/2022-6-19-6.png)

> é¡¾åæ€ä¹‰ï¼Œä¸æ•°ç»„çš„mapç±»ä¼¼ï¼Œå¯¹äºä¸€ä¸ªå“åº”å¼å¯¹è±¡ï¼Œå¯ä»¥ä½¿ç”¨pipeç®¡é“æŒ‡ä»¤è·å–å…¶ç®¡é“çš„å†…å®¹ï¼Œä¹‹åä¾¿å¯ä»¥ä½¿ç”¨å„ç§è¿ç®—ç¬¦æ¥å¤„ç†æ•°æ®å•¦ã€‚

#### $3. concat å’Œ concatAll$

åˆå¹¶Observableå¯¹è±¡å¹¶ä»¥æ­¤è¿”å›å…¶å€¼

concatï¼šé¦–å°¾ç›¸è¿ï¼Œå°†å„ä¸ªè®¢é˜…å€¼ç©¿èµ·æ¥è¾“å‡º

ä¾‹1ï¼š

```js
// RxJS v6+
import  {  of, concat }  from  'rxjs';
concat(
  of(1,  2,  3),
  // subscribed after first completes
  of(4,  5,  6),
  // subscribed after second completes
  of(7,  8,  9)
)
// log: 1, 2, 3, 4, 5, 6, 7, 8, 9
.subscribe(console.log);
```

ä¾‹2ï¼š

```js
import { concat, merge, defer, from } from 'rxjs'; 

console.log('Start')
const promiseA$ = defer(()=>from(new Promise((reslove, reject)=>{
  setTimeout(()=>{
    reslove('PromiseA')
  }, 1000)
})))
const promiseB$ = defer(()=>from(new Promise((reslove, reject)=>{
  setTimeout(()=>{
    reslove('PromiseB')
  }, 1000)
})))

// ä¼šä¾æ¬¡é—´éš”ä¸€ç§’æ‰“å°Start, PromiseA, PromiseB
concat(promiseA$, promiseB$).subscribe(x => console.log(x));
```

concatAllï¼šæ˜¯ä¸€ä¸ªé«˜é˜¶çš„å¤„ç†å‡½æ•°ï¼Œé¡ºåºæ¥å—ä¸Šæ¸¸æŠ›å‡ºçš„å„ä¸ªæ•°æ®æµä½œä¸ºå®ƒçš„æ•°æ®ï¼Œ è‹¥å‰é¢çš„æ•°æ®æµä¸èƒ½åŒæ­¥çš„å®Œç»“ï¼Œå®ƒä¼šæš‚å­˜åç»­æ•°æ®æµï¼Œå½“å‰æ•°æ®æµå®Œæˆåå®ƒæ‰ä¼šè®¢é˜…åä¸€ä¸ªæš‚å­˜çš„æ•°æ®æµã€‚å¯ä»¥æƒ³æˆæ˜¯æŠŠæ‰€æœ‰å…ƒç´  concat èµ·æ¥ã€‚å…¶å‰ç½®æ¡ä»¶å¼å¿…é¡»ä¼ è¿‡æ¥ä¸€ç»„ Observable å¯¹è±¡ã€‚

ä¾‹1ï¼š

![7.png](/img/posts/2022-6-19/2022-6-19-7.png)

> concatAll ä¸€èˆ¬ç”¨äºå¤„ç†ä¸€æ¬¡æ€§æˆ–è€…çŸ­æ—¶é—´å†…æœ‰å¤šä¸ªç®¡é“æ•°æ®çš„æƒ…å†µã€‚æ¯”å¦‚å¤„ç†ç‚¹å‡»äº‹ä»¶ï¼Œåœ¨ä»–å‰ç½®çš„è¿ç®—ç¬¦ï¼Œå¿…æœ‰ä¸€ä¸ªç±»ä¼¼äºmapçš„æ˜ å°„ï¼ŒconcatAll å¯ä»¥å°†ä¸€ä¸ª Observable å¯¹è±¡æ˜ å°„ä¸ºæ‹å¹³çš„å€¼æ¥ä¾æ¬¡å¤„ç†ã€‚

ä¸ä½¿ç”¨ concatAllï¼Œåªä½¿ç”¨mapæ—¶ï¼Œè¾“å‡ºç»“æœï¼š

![image.png](/img/posts/2022-6-19/2022-6-19-8.png)

ä¾‹2ï¼šé‡å†™ä¸‹ä¸Šé¢ concat çš„ä¾‹2ï¼Œè¾“å‡ºç›¸åŒçš„ç»“æœ

```js
import { concat, defer, from, of } from 'rxjs'; 
import { tap, concatAll } from 'rxjs/operators';

console.log('Start')

const promiseA$ = defer(() => from(new Promise((reslove, reject) => {
  console.log('PromiseA is been Subscribed ')
  setTimeout(()=>{
    reslove('PromiseA')
  }, 1000)
})))

const promiseB$ = defer(() => from(new Promise((reslove, reject) => {
  console.log('PromiseB is been Subscribed ')
  setTimeout(()=>{
    reslove('PromiseB')
  }, 1000)
})))

// ä¼šä¾æ¬¡é—´éš”ä¸€ç§’æ‰“å°Start, PromiseA, PromiseB
of(promiseA$, promiseB$).pipe(tap(console.log), concatAll()).subscribe(x => console.log(x));
```

#### $4. mergeAll$

mergeAll ä¸ä¼šåƒ concatAll ä¸€æ ·é¦–å°¾ç›¸è¿è¾“å‡ºå€¼ï¼Œå…¶å¹¶è¡Œå¤„ç†æ‰€æœ‰çš„ Observableï¼Œä¸ä¿è¯è¾“å‡ºé¡ºåºã€‚

![8.png](/img/posts/2022-6-19/2022-6-19-9.png)

#### $5. è¡ç”Ÿæ“ä½œç¬¦ concatMap, mergeMap$

concatMap, mergeMap åˆ†åˆ«æ˜¯ `map + concatAll` å’Œ `map + mergeAll` çš„ç»“åˆä½“ã€‚

![9.png](/img/posts/2022-6-19/2022-6-19-10.png)

ä¸Šé¢çš„å®æˆ˜ä¾‹å­ï¼Œæ¥å—ä¸€ä¸ªå¼¹çª—å…³é—­äº‹ä»¶ï¼Œåˆ¤æ–­å€¼æ˜¯å¦ä¸ºconfirmedï¼Œè‹¥æ˜¯ï¼Œåˆ™äº¤ç»™ mergeMapå¤„ç†ã€‚

mergeMapæ˜¯æ¯”è¾ƒå¸¸ç”¨çš„è¯·æ±‚æ•°æ®çš„æ“ä½œç¬¦ï¼Œè¯¦ç»†ä½¿ç”¨è§å®˜ç½‘ï¼š`<https://cn.rx.js.org/class/es6/Observable.js~Observable.html#instance-method-mergeMap>`

ä¸‹é¢æ˜¯ä»–çš„æ‰§è¡ŒåŸç†ï¼š
![10.png](/img/posts/2022-6-19/2022-6-19-11.png)
ä¸Šå›¾ä¸­ï¼Œç®—å­ç©¿äº†å¤„ç†å‡½æ•°ï¼š10\*iï¼Œå°†ä¸¤ä¸ªæµä¸­çš„æ•°ç›¸ä¹˜ã€‚å¯ä»¥çœ‹åˆ°ç±»ä¼¼äºçŸ©é˜µä¹˜ç§¯çš„å½¢å¼ï¼Œåˆ†åˆ«ç›¸ä¹˜åè¾“å‡ºã€‚

ç±»ä¼¼çš„ï¼ŒconcatMap æ˜¯æŒ‰ç…§é¡ºåºæ’åˆ—çš„ï¼Œä½¿ç”¨åœºæ™¯æ›´åŠ å¹¿æ³›ã€‚æ¯ä¸ªæ–°çš„å†…éƒ¨ Observable ä¸å…ˆå‰çš„å†…éƒ¨ Observable é¦–å°¾ä¸²è”ç»„æˆã€‚ä»–è§£å†³äº† concat å’Œ concatAll çš„ä¸€ä¸ªé—®é¢˜ï¼šåä¸€ä¸ªæ•°æ®æµæ‹¿ä¸åˆ°å‰ä¸€ä¸ªæ•°æ®æµæŠ›å‡ºçš„æ•°æ®ã€‚

> æ³¨æ„ï¼šÂ `concatMap`ç­‰æ•ˆäºÂ `mergeMap` çš„å¹¶å‘å‚æ•°è®¾ç½® åˆ°Â `1`ã€‚

![WeChat6cbaa584dbb91a47061695335ded81c5.png](/img/posts/2022-6-19/2022-6-19-12.png)

æˆ‘ä»¬è¿˜æ˜¯ä½¿ç”¨ä¸Šé¢ concat çš„åŒä¸€ä¸ªä¾‹å­ï¼Œä¸è¿‡æ§åˆ¶ä¸€ä¸‹ä¸¤ä¸ªpromiseçš„å…ˆåé¡ºåºï¼Œè®©åä¸€ä¸ªpromiseè·å–å‰ä¸€ä¸ªpromiseçš„æ•°æ®ï¼š

```js
import { concat, defer, from } from 'rxjs'; 
import { concatAll, map, tap } from 'rxjs/operators'; 

console.log('Start')

const promiseA$ = defer(() => from(new Promise((reslove, reject)=>{
  setTimeout(() => {
    reslove('PromiseA')
  }, 1000)
})))

// è¿™æ˜¯ä¸€ä¸ªä¼šè¿”å›æ•°æ®æµpromiseB$çš„å‡½æ•°
const promiseB = data => from(new Promise((reslove, reject)=>{
  setTimeout(() => {
    reslove(`${data} then PromiseB`)
  }, 1000)
}))

// mapä¼šå°†æŠŠä¸Šæ¸¸å®Œæˆåçš„æ•°æ®é€šè¿‡promiseBè½¬æ¢æˆpromiseB$æ•°æ®æµ
// å¹¶ä¼ é€’ç»™concatAll, concatAllå°†promiseB$è¿æ¥ä¸‹æ¸¸æ•°æ®æµ
// è¿™é‡Œå°†åœ¨ä¸¤ç§’åæ‰“å°å‡º PromiseA then PromiseB
promiseA$.pipe(
  map(promiseB),
  concatAll()
).subscribe(x => console.log(x))
```

æˆ‘ä»¬ä½¿ç”¨ concatMap æ”¹å†™ï¼š

```js
import { concat, defer, from } from 'rxjs'; 
import { concatMap, map, tap } from 'rxjs/operators'; 

console.log('Start')

const promiseA$ = defer(() => from(new Promise((reslove, reject)=>{
  setTimeout(() => {
    reslove('PromiseA')
  }, 1000)
})))

// è¿™æ˜¯ä¸€ä¸ªä¼šè¿”å›æ•°æ®æµpromiseB$çš„å‡½æ•°
const promiseB = data => new Promise((reslove, reject)=>{
  setTimeout(() => {
    reslove(`${data} then PromiseB`)
  }, 1000)
})

// concatMap å¯ä»¥æ¥æ”¶ä¸€ä¸ªè¿”å›Promiseçš„å‡½æ•°æˆ–è€…æ˜¯æ•°æ®æµ
// è¿™é‡Œå°†åœ¨ä¸¤ç§’åæ‰“å°å‡º PromiseA then PromiseB
promiseA$.pipe(
  concatMap(promiseB)
).subscribe(x => console.log(x))
```

å¯ä»¥çœ‹åˆ°ï¼Œå•å• concatMap å°±å¯ä»¥è®©åä¸€ä¸ªæ•°æ®æµæ¥å—å‰é¢æ•°æ®æµçš„æ•°æ®ï¼Œå…¶æœ¬è´¨å°±æ˜¯ map + concatAllã€‚

**concatMap å¼•ç”³ï¼š**

è€ƒè™‘ä¸€ä¸ªå®é™…çš„ä¸šåŠ¡åœºæ™¯ã€‚æˆ‘ä»¬æœ‰ä¸€ä¸ªé¡µé¢ï¼Œé¡µé¢åˆå§‹åŒ–çš„æ—¶å€™æœ‰ä¸ªåˆå§‹åŒ–æ¥å£è·å–æ•°æ®ï¼Œé¡µé¢ä¸Šæœ‰ä¸ªä¸‹ä¸€æ­¥æŒ‰é’®ï¼Œè¿™ä¸ªæŒ‰é’®è§¦å‘çš„äº‹ä»¶éœ€è¦ä½¿ç”¨åˆå§‹åŒ–æ¥å£çš„æ•°æ®ã€‚

å¯ä»¥è¿™æ ·å†™ï¼š

```js
import { concat, defer, from, fromEvent } from 'rxjs'; 
import { tap, concatMap } from 'rxjs/operators'; 

// ä½¿ç”¨promiseæ¥æ¨¡æ‹Ÿæ•°æ®è¯·æ±‚è¿‡ç¨‹
const req$ = defer(() => from(new Promise((reslove, reject)=>{
  setTimeout(() => {
    reslove('This is init data')
  }, 1000)
})))

// äº‹ä»¶æµ
const button$ = () => fromEvent(document.getElementById('button'), 'click')

// ç‚¹å‡»æŒ‰é’®åè¾“å‡ºè¯·æ±‚å†…å®¹
// è¿™é‡Œä¼šæ‰“å°å‡º This is init data
req$.pipe(
  concatMap(button$, (data, event) => data)
).subscribe(x => console.log(x))
```

concatMapæ¥å—å¼‚æ­¥è¯·æ±‚çš„æ•°æ®ï¼Œç„¶åä¼ ç»™ button çš„ç‚¹å‡»äº‹ä»¶ Observable å¯¹è±¡ï¼Œé€šè¿‡è¯¥äº‹ä»¶ Observable å¯¹è±¡æ¥è¾“å‡ºç»“æœã€‚å¤„ç†äº‹ä»¶æ—¶ï¼Œ concatMap ç¬¬äºŒä¸ªå‚æ•°å°±æ´¾ä¸Šç”¨åœºäº†ã€‚

#### $6. å®šæ—¶å™¨$

```js
import { interval, timer } from 'rxjs';

const test_interval = interval(1000);

const test_timer = timer(1000, 5000);

const test_timer = timer(1000);

export {test_interval, test_timer}
```

intervalä¼šä¸åœçš„æŒ‰ç…§é—´éš”æ—¶é—´ç´¯åŠ æ•°å­—ï¼Œä»0å¼€å§‹ã€‚timeræ˜¯ä¸€ä¸ªå®šæ—¶å™¨ï¼Œåªæœ‰ä¸€ä¸ªå‚æ•°æ—¶ï¼Œåœ¨æŒ‡å®šæ—¶é—´ï¼ˆæ¯«ç§’ï¼‰åè¾“å‡ºä¸€ä¸ª0ï¼Œä¸¤ä¸ªå‚æ•°æ—¶ï¼Œæ¯”å¦‚ä¸Šé¢çš„ä¾‹å­ï¼ŒæŒ‡çš„æ˜¯ä»ç¬¬1ç§’å¼€å§‹ï¼Œæ¯éš”5ç§’å‡ºä¹¦ä¸€ä¸ªç´¯åŠ çš„å€¼ï¼Œä»0å¼€å§‹ã€‚

#### $7. å¼‚å¸¸å¤„ç† throwError$

```js
import { throwError, interval, of } from 'rxjs';
import { mergeMap } from 'rxjs/operators';

interval(1000).pipe(
mergeMap(x => x === 2
    ? throwError('Twos are bad')
    : of('a', 'b', 'c')
    ),
).subscribe(x => console.log(x), e => console.error(e));
```

ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œä½¿ç”¨ç®—å­ throwErroræŠ›å‡ºé”™è¯¯ï¼ŒæŠ›å‡ºåï¼Œè®¢é˜…åœæ­¢ã€‚

#### $8. zipAll$

ä¸‹å›¾ä¸­ï¼ŒzipAll å°† from æ“ä½œç¬¦è§£æ„å‡ºçš„æµå¼æ•°æ®åˆæ‹¼æ¥å›æ•°ç»„å½¢å¼ã€‚

![12.png](/img/posts/2022-6-19/2022-6-19-13.png)

#### $9. group ä¸ reduce$

ç±»ä¼¼ SQL ä¸­çš„ groupByï¼Œæ¥å—ä¸€ä¸ªå‡½æ•°ï¼Œè¿”å›è¦groupçš„å¯¹è±¡keyå€¼ã€‚

![13.png](/img/posts/2022-6-19/2022-6-19-14.png)

è§£å¼€ tapçš„æ³¨é‡Šåï¼Œå¯ä»¥çœ‹åˆ°æ‰“å°çš„è¾“å‡ºï¼š

![image.png](/img/posts/2022-6-19/2022-6-19-15.png)

reduceç”¨æ¥èšåˆObservableä¸­çš„æ•°å€¼ã€‚

#### $10. distinct$

å»é‡ç®—å­ã€‚

ä½¿ç”¨RxJsæ¥æ•°ç»„å»é‡ï¼š

![14.png](/img/posts/2022-6-19/2022-6-19-16.png)

#### $11. takeUtill$

ç›´åˆ°æä¾›çš„ observable å‘å‡ºå€¼ï¼Œå®ƒä¾¿å®Œæˆ

ä¾‹1ï¼š

![15.png](/img/posts/2022-6-19/2022-6-19-17.png)

> æ€è€ƒï¼šæ˜¯ä¸æ˜¯å¯ä»¥ç”¨æ¥ é˜²æŠ–èŠ‚æµ å‘¢

ä¾‹2ï¼šç›´åˆ°ç”¨æˆ·ç‚¹å‡»åï¼Œå¼€å¯å®šæ—¶å™¨

![16.png](/img/posts/2022-6-19/2022-6-19-18.png)

#### $12. takeLast$

å–æµæ•°æ®çš„æœ€åä¸€ä¸ªï¼ˆåŒç†ï¼Œæœ‰ take(index: number)å‡½æ•°æ¥æ­£å‘æŒ‡å®šä¸‹æ ‡è·å–ï¼‰

![17.png](/img/posts/2022-6-19/2022-6-19-19.png)

#### $13. ä¸“ç”¨çš„é˜²æŠ–èŠ‚æµ$

ä¸Šé¢è¯´å¯ä»¥ç”¨takeUtilsæ¨¡æ‹Ÿé˜²æŠ–èŠ‚æµï¼Œå…¶å®Rxjsæœ‰ä¸“ç”¨çš„é˜²æŠ–èŠ‚æµå‡½æ•°ã€‚

```js
import { debounceTime, throttleTime } from 'rxjs';

Observable.fromEvent(document.getElementById("debounceTime"), "click")
    .debounceTime(1000)
    .subscribe(() => console.log("debounceTime"));
    
Observable.fromEvent(document.getElementById("throttleTime"), "click")
    .throttleTime(1000)
    .subscribe(() => console.log("throttleTime"));
```

#### $14. Subject å¯¹è±¡$

Subjectç»§æ‰¿è‡ªObservableç±»ï¼ŒåŒæ ·å…·æœ‰æ•°æ®æµç›‘å¬ç‰¹æ€§ï¼Œå…¶ä½œä¸ºobservableçš„ä¸€ç§è½½ä½“ï¼Œå¤šç”¨äºç»„ä»¶ä¹‹é—´ä¼ é€’ã€‚

å¯ä»¥æ¨é€(next)å’Œè¢«è®¢é˜…(subscribe)

![18.png](/img/posts/2022-6-19/2022-6-19-20.png)

BehaviorSubjectï¼šæ¯ä¸ªæ–°çš„è®¢é˜…å¯ä»¥æ‹¿åˆ°ç®¡é“ä¸­æœ€æ–°çš„é‚£æ¬¡æ•°æ®

![19.png](/img/posts/2022-6-19/2022-6-19-21.png)

AsyncSubjectï¼šcompleteæ—¶ä¼šè¾“å‡ºæœ€æ–°çš„ç®¡é“æ•°æ®ï¼Œå…¶ä½™æ—¶é—´ä¸è¾“å‡º

![20.png](/img/posts/2022-6-19/2022-6-19-22.png)

ReplaySubjectï¼šæ¯æ¬¡æ–°è®¢é˜…æ—¶ï¼Œå¯æŒ‡å®šè·å–ç®¡é“ä¸­æœ€æ–°çš„Nä¸ªæ•°æ®

![21.png](/img/posts/2022-6-19/2022-6-19-23.png)

> å¼•ç”³é˜…è¯»ï¼Œæ•°ç™¾ä¸ªæ“ä½œç¬¦ï¼šÂ http\://[reactivex.io/documentation/operators.html](http://reactivex.io/documentation/operators.html)

## 5. åº”ç”¨åœºæ™¯

1.  å¤šäº‹ä»¶ç•Œé¢
2.  æ›´åŠ å¤æ‚çš„äº¤äº’åœºæ™¯ï¼Œå°¤å…¶æ˜¯éœ€è¦ç»„ä»¶é—´å¤šçº§ä¼ é€’çš„æƒ…å†µ
3.  éœ€è¦æºæºä¸æ–­çš„æµå‡ºæ•°æ®çš„åœºæ™¯

## 6. ä¸ Promise å¯¹æ¯”

å…±åŒç‚¹ï¼š

1.  å¤„ç†å¼‚æ­¥

ä¾‹1ï¼š

![22.png](/img/posts/2022-6-19/2022-6-19-24.png)

ä¾‹2ï¼š

![23.png](/img/posts/2022-6-19/2022-6-19-25.png)

ä¸åŒï¼š

1.  è®¾è®¡ç†å¿µä¸åŒï¼ˆå‘å¸ƒè®¢é˜…ã€è§‚å¯Ÿè€…+pipeï¼‰
2.  ä¸­é€”å–æ¶ˆ

åœ¨ä¸Šé¢å¼‚æ­¥å¤„ç†çš„ä¾‹å­ä¸­ï¼Œå¯ä»¥é€‰æ‹©å–æ¶ˆå®šæ—¶å™¨ï¼šå³å–æ¶ˆè®¢é˜…

![24.png](/img/posts/2022-6-19/2022-6-19-26.png)

3.  å®Œå–„çš„å‡½æ•°å·¥å…·

## 7. ä¸ React ç»“åˆ

ç¤ºä¾‹ï¼šç»„ä»¶é—´ä¼ é€’æ¶ˆæ¯

çˆ¶ç»„ä»¶ï¼šå£°æ˜ä¸€ä¸ª subjectï¼Œé€šè¿‡ prop ä¼ é€’ç»™ å­ç»„ä»¶

![25.png](/img/posts/2022-6-19/2022-6-19-27.png)

![26.png](/img/posts/2022-6-19/2022-6-19-28.png)

å­ç»„ä»¶ï¼šæ¥å—è¯¥ subjectï¼Œç„¶åå¾€é‡Œè¾¹æ¨é€å€¼ã€‚åŒç†ï¼Œçˆ¶ç»„ä»¶ä¹Ÿå¯ä»¥æ¨é€ï¼Œå­ç»„ä»¶æ¥ç›‘å¬ã€‚å¦‚æ­¤è¾¾åˆ° çˆ¶å­ç»„ä»¶ å…¨åŒå·¥é€šä¿¡ã€‚

![27.png](/img/posts/2022-6-19/2022-6-19-29.png)

ç‚¹å‡»å­ç»„ä»¶çš„ä¸‰ä¸ªæŒ‰é’®ï¼Œå°±ä¼šçœ‹åˆ°çˆ¶ç»„ä»¶çš„è®¢é˜…è§¦å‘äº†ï¼

![28.png](/img/posts/2022-6-19/2022-6-19-30.png)

ç‚¹å‡»åä¼šæœ‰ç›¸åº”è¾“å‡ºï¼Œæ¯”å¦‚ï¼š

```
1
2
3
3
```

æ¨èé¡¹ç›®ï¼š`<https://github.com/LeetCode-OpenSource/rxjs-hooks>`

<hr />

å‚è€ƒï¼š

*   [Rxjs Github](https://github.com/ReactiveX/rxjs)
*   [ReactiveX å®˜ç½‘](https://reactivex.io/)33:T732,## 1. ä¼ªå…ƒç´ æ¨¡æ‹Ÿå®ç°å¾®è½¯logoé˜´å½±

>  CSS æ¢ç©¶ç³»åˆ—æ–‡ç« ä¹‹ä¼ªshadow

```html
<div style={{ width: '100%', height: '500px', background: 'linear-gradient(90deg, hsl(199, 98%, 50%), hsl(199, 98%, 38%))', overflow: 'hidden' }}>
  <div className={`${style.box}`}>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
  </div>
</div>
```


```html {{ title: 'HTML' }}
<div class='box'>
  <div></div>
  <div></div>
  <div></div>
  <div></div>
</div>
```

```css {{ title: 'CSS' }}
/* å…ˆä½¿ç”¨ grid å¸ƒå±€å®ç°å››ä¸ªæ–¹å—çš„å®šä½ */
.box {
  position: relative;
  width: 20vmin;
  height: 20vmin;
  margin: 20vmin;
  padding: 0;
  z-index: 2;
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  grid-template-rows: repeat(2, 1fr);
  grid-row-gap: 4%;
  grid-column-gap: 4%;
  grid-auto-flow: row;
}

/* è®¾ç½®ä¸¤ä¸ªä¼ªå…ƒç´ ï¼Œåˆ†åˆ«è¡¨ç¤ºä¸¤ä¸ªè¾¹çš„é˜´å½± */
.box::before,
.box::after {
  content: "";
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  z-index: 2;
}

.box::before {
  /* transform-origin æ˜¯å˜å½¢åŸç‚¹ï¼Œä¹Ÿå°±æ˜¯è¯¥å…ƒç´ å›´ç»•ç€é‚£ä¸ªç‚¹å˜å½¢æˆ–æ—‹è½¬ */
  /*æ¯”å¦‚ï¼š0 50% è¡¨ç¤º x æ–¹å‘ä¸Šåœ¨æœ€å·¦è¾¹ï¼Œy æ–¹å‘ä¸Šåœ¨æœ€å·¦è¾¹é‚£æ¡è¾¹ä¸­é—´çš„ä½ç½® */
  transform-origin: 0 0;
  /* è·‘åˆ°æœ€å³è¾¹çš„ä¸Šè¾¹, scaleX ç¼©æ”¾ä¸€ä¸‹èŒƒå›´ï¼Œå¯ä»¥ä¸è¦ */
  transform: translate(100%, 0) skewY(45deg) scaleX(.6);
  background: linear-gradient(90deg, rgba(0, 0, 0, .3), transparent);
  animation: shadowMoveY 5s infinite linear alternate;
}

.box::after {
  transform-origin: 0 0;
  transform: translate(0%, 100%) skewX(45deg) scaleY(.6);
  background: linear-gradient(180deg, rgba(0, 0, 0, .3), transparent);
}

@keyframes shadowMoveY {
  to {
    transform: translate(100%, 0) skewY(20deg) scaleX(.6);
  }
}
```

![microsoft-logo](/img/posts/css/microsoft-logo.jpg)34:T6cf,```html
<div className={style.container}>
  <div className={style.shadow}>Hover</div>
</div>
```

#### è®¾ç½®åˆå§‹é¢œè‰²

å…ˆè®¾ç½®å››ä¸ªè§’çš„é¢œè‰²ï¼ˆè®¾ç½®å®½é«˜. åœ†è§’. 0è¾¹æ¡† çš„ä»£ç çœç•¥ï¼‰ï¼š

```html
<div class='shadow'>Hover</div>
```

```css
--color: #1e91e9;

/* ç”¨å››ä¸ªé˜´å½±æ¨¡æ‹Ÿå››ä¸ªè±¡é™ï¼Œè¿™é‡Œåªè®¾ç½®ä¸€ä¸ªï¼Œå…¶å®åˆå§‹æ•ˆæœæ˜¯ä¸€æ ·çš„ */
box-shadow: 0 0 0 2px var(--color), 0 0 0 2px var(--color),
  0 0 0 2px var(--color), 0 0 0 2px var(--color);
```

#### è®¾ç½®æµ®åŠ¨åŠ¨ç”»

```css

.shadow:hover {
  --color: #1e91e9;
  animation: border .5s ease forwards;
}

@keyframes border {
  /* 1/4 æ—¶ï¼Œå³ä¸Šè§’ï¼šå‘å³åç§»ä¸º0ï¼Œå‘ä¸Šåç§»125ï¼Œä¸æ¨¡ç³Šï¼Œæ‰©æ•£2pxï¼Œå˜ä¸ºç°è‰² */
  /* å·¦ä¸Šè§’ï¼šå‘å³åç§»ä¸º0ï¼Œå‘ä¸Šåç§»125ï¼Œä¸æ¨¡ç³Šï¼Œæ‰©æ•£2pxï¼Œå˜ä¸ºç°è‰² */
  25% {
    box-shadow: 0 -125px 0 2px var(--color),
                -60px -60px 0 2px var(--color),
                -60px 60px 0 2px var(--color),
                60px 60px 0 2px var(--color),
                0 0 0 2px #ccc;
  }

  50% {
    box-shadow: 0 -125px 0 2px var(--color),
                -125px 0px 0 2px var(--color),
                -60px 60px 0 2px var(--color),
                60px 60px 0 2px var(--color),
                0 0 0 2px #ccc;
  }

  75% {
    box-shadow: 0 -125px 0 2px var(--color),
                -125px 0px 0 2px var(--color),
                0px 125px 0 2px var(--color),
                60px 60px 0 2px var(--color),
                0 0 0 2px #ccc;
  }

  100% {
    box-shadow: 0 -125px 0 2px var(--color),
                -125px 0px 0 2px var(--color),
                0px 125px 0 2px var(--color),
                120px 40px 0 2px var(--color),
                0 0 0 2px #ccc;
  }
}
```35:T60a,```html
<div className={style.container}>
  <div className='flex-start'>
    <div className={style.left}>å·¦</div>
    <p>box-shadow: -7px 0 5px -5px #ccc</p>
  </div>
  <div className='flex-start'>
    <div className={style.right}>å³</div>
    <p>box-shadow: 7px 0 5px -5px #ccc</p>
  </div>
  <div className='flex-start'>
    <div className={style.top}>ä¸Š</div>
    <p>box-shadow: 0 -7px 5px -5px #ccc</p>
  </div>
  <div className='flex-start'>
    <div className={style.bottom}>ä¸‹</div>
    <p>box-shadow: 0 7px 5px -5px #ccc</p>
  </div>
</div>
```

```html
<div>
  å‚æ•°ï¼š x æ–¹å‘åç§»é‡ï¼ˆå³+ï¼‰ï¼Œ y æ–¹å‘åç§»é‡ ï¼ˆä¸‹+ï¼‰ï¼Œæ¨¡ç³ŠåŠå¾„ï¼Œæ‰©å¼ åŠå¾„

  æ‰©å¼ åŠå¾„ä¼šæ ¹æ®æŒ‡å®šçš„å€¼å»æ‰©å¤§æˆ–ç¼©å°æŠ•å½±å°ºå¯¸ï¼Œå¦‚æœæˆ‘ä»¬ç”¨ä¸€ä¸ªè´Ÿçš„æ‰©å¼ åŠå¾„ï¼Œè€Œä»–çš„ç»å¯¹å€¼åˆšå¥½ç­‰äºæ¨¡ç³ŠåŠå¾„ï¼Œé‚£ä¹ˆæŠ•å½±çš„å°ºå¯¸å°±ä¼šä¸æŠ•å½±æ‰€å±çš„å…ƒç´ å°ºå¯¸å®Œå…¨ä¸€è‡´ï¼Œé™¤éä½¿ç”¨åç§»é‡æ¥ç§»åŠ¨ä»–ï¼Œå¦åˆ™æˆ‘ä»¬å°†çœ‹ä¸åˆ°ä»»ä½•æŠ•å½±ã€‚
</div>
```

```html
<div className={style.container}>
  <div className='flex-start'>
    <div className={style.left2}>å·¦</div>
    <p>box-shadow: -7px 0 5px 5px #ccc</p>
  </div>
  <div className='flex-start'>
    <div className={style.right2}>å³</div>
    <p>box-shadow: 7px 0 5px 5px #ccc</p>
  </div>
  <div className='flex-start'>
    <div className={style.top2}>ä¸Š</div>
    <p>box-shadow: 0 -7px 5px 5px #ccc</p>
  </div>
  <div className='flex-start'>
    <div className={style.bottom2}>ä¸‹</div>
    <p>box-shadow: 0 7px 5px 5px #ccc</p>
  </div>
</div>
```36:Ta671,## 0. å‰è¨€

### 1ã€åç§°ç”±æ¥

è¯´èµ·JavaScriptç›¸å…³çš„å†å²ï¼Œè¿˜å¾—è¿½æº¯åˆ°è®¡ç®—æœºåŠå…¶ç¼–ç¨‹è¯­è¨€è¯ç”Ÿä¹‹åˆçš„é‚£æ®µæ—¶é—´ã€‚

åœ¨1959å¹´ï¼Œæ¬§æ´²çš„è®¡ç®—æœºäº§ä¸šå·²ç»å‡ºç°è“¬å‹ƒå‘å±•çš„è¿¹è±¡äº†ï¼Œç°ä»£æ„ä¹‰çš„è®¡ç®—æœºä¹Ÿè¶Šæ¥è¶Šå¤šåœ°å¼€å§‹åœ¨ç§‘ç ”æœºæ„ï¼Œæ”¿åºœç­‰ç¤¾ä¼šåœºæ‰€è¢«ä½¿ç”¨ï¼Œä½¿ç”¨çš„äººå¤šäº†ï¼Œè®¡ç®—æœºæ“ä½œæŠ€æœ¯å®ç°æ ‡å‡†åŒ–å°±è¢«æ¨ä¸Šäº†æ—¥ç¨‹ï¼Œä¾‹å¦‚ç¼–ç¨‹ï¼Œä»¥åŠè¾“å…¥å’Œè¾“å‡ºä»£ç è§„èŒƒç­‰ã€‚

è¡Œä¸šæ ‡å‡†å¯¹äºè¡Œä¸šå‘å±•çš„é‡è¦æ€§ä¸è¨€è€Œå–»ã€‚ä¸ºäº†åè°ƒæ ‡å‡†åˆ¶å®šå·¥ä½œï¼Œæ¬§æ´²æ•°æ®å¤„ç†é¢†åŸŸå†å²æœ€æ‚ ä¹…çš„å…¬å¸ï¼ˆCompagnie des Machines Bullã€IBM World Trade Europe Corporation å’Œ International Computers and Tabulators Limitedï¼‰çš„è´Ÿè´£äººå‘æ‰€æœ‰å·²çŸ¥çš„è®¡ç®—æœºå‘å‡ºäº†è”åä¿¡ã€‚æ¬§æ´²åˆ¶é€ å•†é‚€è¯·è¿™äº›å…¬å¸æ´¾ä»£è¡¨å‚åŠ ä¼šè®®ã€‚è¿™æ¬¡ä¼šè®®äº 1960 å¹´ 4 æœˆ 27 æ—¥åœ¨å¸ƒé²å¡å°”ä¸¾è¡Œï¼›å†³å®šæˆç«‹ä¸€ä¸ªåˆ¶é€ å•†åä¼šï¼Œç§°ä¸ºæ¬§æ´²è®¡ç®—æœºåˆ¶é€ å•†åä¼šï¼ˆ`European Computer Manufacturers Association`ï¼‰æˆ–ç®€ç§° `ECMA`ï¼Œå¹¶æåäº†ä¸€ä¸ªå§”å‘˜ä¼šæ¥å‡†å¤‡è¯¥åä¼šçš„æˆç«‹å¹¶åˆ¶å®šç« ç¨‹å’Œè§„åˆ™ã€‚éšåçš„ 1961 å¹´ 5 æœˆ 17 æ—¥ï¼Œåä¼šæ­£å¼æˆç«‹ã€‚

è¿™ä¾¿æ˜¯`ECMA`è¿™ä¸ªåå­—çš„æ¥æºã€‚

`ECMA`èµ°å‘å…¨çƒåï¼Œåœ¨1994 å¹´æ›´åä¸ºï¼š`Ecma International`ã€‚å…¶å•†æ ‡â€œECMAâ€ç”±äºå†å²åŸå› è¢«ä¿ç•™äº†ä¸‹æ¥ï¼Œæ²¿ç”¨è‡³ä»Šã€‚

### 2ã€ECMA-262æ ‡å‡†ï¼Œæ¢¦å¼€å§‹çš„åœ°æ–¹

`EMCA`æ ‡å‡†å®¹çº³äº†å¤§é‡é€šä¿¡ã€è®¡ç®—æœºåŠå…¶ç›¸å…³è¡Œä¸šçš„æ ‡å‡†è§„èŒƒã€‚æˆ‘ä»¬æ‰¾ä¸€ä¸‹æœ¬æ–‡çš„ä¸»è§’ã€‚

åœ¨[å®˜ç½‘](https://www.ecma-international.org/publications-and-standards/standards/)ä¸­æ‰’ä¸€å¼ å›¾ï¼š

![image.png](/img/posts/2022-6-15/2022-6-15-1.png)

å¯ä»¥çœ‹åˆ°ï¼Œç¬¬262å·æ ‡å‡†åˆå«`ECMAScript`ï¼Œæ˜¯ECMAå®šä¹‰çš„ä¸€å¥—è„šæœ¬è¯­è¨€ç¼–ç¨‹è§„èŒƒã€‚

> ECMAScript é€šå¸¸ç¼©å†™ä¸º ESã€‚

æ­£æ˜¯å› ä¸ºæœ‰è¿™ä¸ªæ ‡å‡†çš„å‡ºç°ï¼Œæ‰æœ‰äº† JavaScript çš„è“¬å‹ƒå‘å±•ï¼æ„Ÿè°¢å¤§ä½¬èµé¥­åƒï¼ï¼

ECMA-262æ˜¯ä¸€ç§è§„èŒƒï¼ˆå®˜ç½‘ä¸­å¯ä»¥æŸ¥åˆ°å„ä¸ªç‰ˆæœ¬çš„PDFææ¡ˆï¼‰ï¼Œè‡ªç„¶ä¼šæœ‰æ»¡è¶³è¿™ç§è§„èŒƒçš„å…·ä½“çš„è¯­è¨€è¢«åˆ›é€ å‡ºæ¥ã€‚æœ€è‘—åçš„å°±æ˜¯**JavaScript**
ï¼ˆç°åœ¨å•†æ ‡å±äºOracleï¼‰ï¼Œåœ¨1995å¹´ç”±[Netscape](https://baike.baidu.com/item/Netscape/2778944)å…¬å¸çš„Brendan Eichï¼Œåœ¨Netscapeå¯¼èˆªè€…æµè§ˆå™¨ä¸Šé¦–æ¬¡è®¾è®¡å®ç°è€Œæˆã€‚å› ä¸ºNetscapeä¸[Sun](https://baike.baidu.com/item/Sun/69463)åˆä½œï¼ŒNetscapeç®¡ç†å±‚å¸Œæœ›å®ƒå¤–è§‚çœ‹èµ·æ¥åƒJavaï¼Œå› æ­¤å–åä¸ºJavaScriptã€‚ä½†å®é™…ä¸Šå®ƒçš„è¯­æ³•é£æ ¼ä¸SelfåŠ[Scheme](https://baike.baidu.com/item/Scheme/8379129)è¾ƒä¸ºæ¥è¿‘ã€‚å…¶è®¾è®¡æ€è·¯å¦‚ä¸‹ï¼š

1.  å€Ÿé‰´ C è¯­è¨€çš„åŸºæœ¬è¯­æ³•ã€‚
2.  å€Ÿé‰´ Java è¯­è¨€çš„æ•°æ®ç±»å‹å’Œå†…å­˜ç®¡ç†ã€‚
3.  å€Ÿé‰´ Scheme è¯­è¨€ï¼Œå°†å‡½æ•°æå‡åˆ°â€œç¬¬ä¸€ç­‰å…¬æ°‘â€ï¼ˆfirst classï¼‰çš„åœ°ä½ã€‚
4.  å€Ÿé‰´ Self è¯­è¨€ï¼Œä½¿ç”¨åŸºäºåŸå‹ï¼ˆprototypeï¼‰çš„ç»§æ‰¿æœºåˆ¶ã€‚

> JavaScriptçš„æ˜¯ä¸€é—¨åŠ¨æ€å¼±ç±»å‹ã€åŸºäºåŸå‹çš„ä¸€ç§è§£é‡Šæ€§è®¡ç®—æœºè„šæœ¬è¯­è¨€ã€‚

åœ¨æ²¡æœ‰ JavaScript çš„å¹´ä»£ï¼Œä¸€äº›ç®€å•çš„è¡¨å•éªŒè¯ï¼ˆå¦‚å¸¸è§çš„ å¯†ç å¤æ‚åº¦éªŒè¯ï¼‰éƒ½æ˜¯ç”±æœåŠ¡ç«¯è´Ÿè´£çš„ï¼Œè€Œä¸”å½“æ—¶çš„ç½‘ç»œé€Ÿåº¦æ˜¯éå¸¸æ…¢çš„ï¼Œè¿™ç§éªŒè¯æ–¹å¼ä¼šå¯¼è‡´ç½‘ç«™çš„å“åº”é€Ÿåº¦å˜å¾—æ›´æ…¢ï¼Œäºæ˜¯ä¾¿æœ‰äº†è¿™é—¨è¯­è¨€çš„è¯ç”Ÿã€‚

å…¶æ¬¡è¿˜æœ‰å¾®è½¯è‡ªç ”çš„ä¸€å¥—è¯­è¨€ï¼Œå«`JScript`ï¼Œå…¶å£°ç§°å®Œå…¨éµå¾ª`ECMA-262`è§„èŒƒã€‚ä¸‹é¢åˆ—ä¸¾ä¸€ä¸‹äºŒè€…çš„åŒºåˆ«ï¼š

| ç‰¹ç‚¹    | JavaScript                                       | JScript          |
| ----- | ------------------------------------------------ | ---------------- |
| è¿è¡Œå¹³å°  | å®¢æˆ·ç«¯,æœåŠ¡ç«¯                                          | å®¢æˆ·ç«¯,æœåŠ¡ç«¯          |
| è§£é‡Šç¯å¢ƒ  | Netscape Livewireã€V8ï¼ˆChrome + nodeï¼‰ã€TraceMonkeyç­‰ | WSHã€ASPã€.Net     |
| æ”¯æŒæµè§ˆå™¨ | æ‰€æœ‰ä¸»æµæµè§ˆå™¨                                          | ä¸»è¦æ˜¯IE3.0+        |
| å‡ºç°æ—¶é—´  | æ¯”è¾ƒæ—©ï¼Œç”šè‡³æ—©äºECMA-262                                 | VBScriptç«äº‰å¤±è´¥åçš„äº§ç‰© |

## 1. JavaScript 1.0 ï¼ˆ96å¹´ï¼‰

å‘å¸ƒäº1996å¹´ï¼Œé€‚ç”¨äºNetscape Navigator2.0æµè§ˆå™¨ï¼Œåˆæ­¥ç¡®å®šäº†å®Œæ•´çš„JavaScriptçš„ä¸‰ä¸ªæ„æˆè¦ç´ ï¼š

1.  ECMAScriptï¼ˆå§‘ä¸”è¿™ä¹ˆå«ï¼Œ1.3ç‰ˆæœ¬æ‰æ­£å¼å®Œå…¨å…¼å®¹ECMAè§„èŒƒï¼‰ã€‚JavaScript çš„æ ¸å¿ƒéƒ¨åˆ†ï¼Œå®ƒè§„å®šäº† JavaScript çš„è¯­æ³•ã€ç±»å‹ã€è¯­å¥ã€ å…³é”®å­—ã€ä¿ç•™å­—ã€è¿ç®—ç¬¦å’Œå¯¹è±¡ã€‚

2.  DOMï¼ˆDocument Object Modelï¼‰ã€‚é€šè¿‡æŠŠæ•´ä¸ªé¡µé¢æ˜ å°„æˆä¸€ä¸ªæ ‘ç»“æ„çš„æ–‡æ¡£ï¼Œæä¾› äº†ä¸€å¥—å¯ä»¥è®¿é—® HTML å’Œ XMLï¼ˆeXtensible Markup Languageï¼‰èŠ‚ç‚¹çš„ APIï¼ˆApplication Programming Interfaceï¼‰ï¼Œå¼€å‘è€…å¯ä»¥åˆ©ç”¨å®ƒè½»æ¾åœ°åˆ é™¤ã€æ·»åŠ ã€æ›¿æ¢æˆ–ä¿®æ”¹ä»»ä½•èŠ‚ç‚¹ã€‚

3.  BOMï¼ˆBrowser Object Modelï¼‰ã€‚æä¾›äº†è®¿é—®æµè§ˆå™¨çª—å£çš„æ–¹æ³•ï¼Œå¼€å‘è€…å¯ä»¥æ§åˆ¶æµ è§ˆå™¨çª—å£è¿›è¡Œä¸€äº›è¯¸å¦‚ç§»åŠ¨çª—å£ä¹‹ç±»çš„æ“ä½œã€‚BOM éƒ¨åˆ†çš„æœ‰å…³å®šä¹‰ï¼Œé›¶æ•£åˆ†å¸ƒåœ¨å„ç§æ ‡ å‡†ä¸­ï¼Œä¸»è¦ä½äº HTML æ ‡å‡†ã€‚å…¶ä»–æ¯”å¦‚ WebRTC æ ‡å‡†ç­‰å†…ä¹Ÿå®šä¹‰äº†ä¸€äº›æ¥å£ã€‚

> 1.0é‡Œæœ‰ä¸€äº›ä»¥åå¾ˆå°‘ç”¨çš„å†·é—¨ç‰¹æ€§ã€‚æ¯”å¦‚å‡½æ•°ä¸ä½†æœ‰callï¼Œapplyæ–¹æ³•ï¼Œè¿˜æœ‰nameå’Œlengthï¼Œè¿˜æœ‰`arguments`ï¼ŒÂ `caller`ï¼ˆåœ¨1.2ç‰ˆç§»é™¤ï¼‰ï¼›Argumentsæ˜¯ä¸ªå¯¹è±¡è€Œä¸æ˜¯æ•°ç»„ï¼›å¯¹è±¡å¯ä»¥ç”¨æ•°å­—ä¸‹æ ‡è®¿é—®å±æ€§ï¼›æ²¡æœ‰===çš„å¼ºç±»å‹åˆ¤å®šï¼›å¯¹ä¸æ”¯æŒscriptæ ‡ç­¾çš„æµè§ˆå™¨åšç‰¹æ®Šæ³¨é‡Šå…¼å®¹ç­‰ã€‚

## 2. JavaScript 1.1ï¼ˆ96å¹´ï¼‰

å‘å¸ƒäº1996å¹´ä¸‹åŠå¹´ï¼Œé€‚é…äº†Netscape Navigator3.0 å’Œ IE3.0ã€‚å®Œå–„æ•°ç»„å¯¹è±¡å’Œæ–¹æ³•ã€‚

## 3. JavaScript 1.2ï¼ˆ97å¹´ï¼‰

å‘å¸ƒäº1997å¹´ï¼Œé€‚é…äº†Netscape Navigator4.0ï¼Œä½†ä¸æ”¯æŒ IE ç¯å¢ƒã€‚å¢åŠ äº†===çš„åˆ¤æ–­æ–¹å¼ã€‚

## 4. JavaScript 1.3 ä¸ ECMAScript 1/2ï¼ˆ98å¹´ï¼‰

å‘å¸ƒäº1998å¹´ã€‚å‰è¾¹è¯´JavaScriptå‡ºç°æ—¶é—´æ—©äºECMA-262ï¼ŒæŒ‡çš„å°±æ˜¯è¿™ä¸ªç‰ˆæœ¬çš„äº‹æƒ…ã€‚è¿™ä¸€å¹´ï¼ŒECMAæ ‡å‡†åŒ–äº†JavaScript1.1çš„åŸºæœ¬ç‰¹æ€§ï¼ŒåŒæ—¶JavaScriptä¹Ÿå‡çº§åˆ°1.3ï¼Œå¹¶æ·»åŠ äº†ä¸€äº›æ–°ç‰¹æ€§ï¼ˆæ²¡æœ‰æ ‡å‡†åŒ–switchè¯­å¥å’Œæ­£åˆ™è¡¨è¾¾å¼ï¼‰ã€‚è‡³æ­¤ï¼ŒJavaScriptæ‰é€æ­¥éµå¾ªECMAè§„èŒƒè¿›è¡Œå‡çº§æ¢ä»£ã€‚

ECMAScript 2æ ‡å‡†æ˜¯å¯¹v1çš„ä¸€ä¸ªç»´æŠ¤ç‰ˆæœ¬ï¼Œåªæ·»åŠ äº†è¯´æ˜ï¼Œä¹Ÿåœ¨åŒä¸€å¹´å‘å¸ƒã€‚

## 5. JavaScript 1.4ï¼ˆ99å¹´ï¼‰

é€‚ç”¨äºNetscape serverçš„ä¸“ç”¨ç‰ˆæœ¬ã€‚

## 6. JavaScript 1.5 ä¸ ECMAScript 3ï¼ˆ00å¹´ï¼‰

å‘å¸ƒäº2000å¹´åº•ï¼Œå¼€å§‹æ”¯æŒ Mozilla Firefox å’Œ Opera æµè§ˆå™¨ï¼Œå¹¶æ ‡å‡†åŒ–äº†switchè¯­å¥ã€å¼‚å¸¸å¤„ç†( try/catch)å’Œæ­£åˆ™è¡¨è¾¾å¼ã€‚

## 7. JavaScript 1.6ï¼ˆ05å¹´ï¼‰

2005å¹´å‘å¸ƒã€‚é€æ­¥å¢åŠ äº†æ•°ç»„çš„æ‰©å±•æ–¹æ³•ã€å¢åŠ äº†Arrayå’ŒStringæ³›å‹ã€æ”¯æŒXMLæ‰©å±•ï¼ˆE4Xï¼‰ã€‚å¼€å§‹æ”¯æŒSafari 3.0ã€‚åŒå¹´ï¼ŒAjaxæŠ€æœ¯å‘å¸ƒã€‚

æ–°å¢çš„æ•°ç»„æ‰©å±•å¦‚ä¸‹ï¼ˆéƒ¨åˆ†æ‰©å±•åœ¨ES5ä¸­é€æ­¥è§„èŒƒåŒ–ï¼‰ï¼š

| æ–°å¢æ‰©å±•          | æè¿°                                           |
| ------------- | -------------------------------------------- |
| indexOf()     | è¿”å›æŒ‡å®šé¡¹é¦–æ¬¡å‡ºç°çš„index                              |
| lastIndexOf() | è¿”å›æŒ‡å®šé¡¹æœ€åä¸€æ¬¡å‡ºç°çš„index                            |
| every()       | åœ¨æ•°ç»„ä¸­çš„æ¯ä¸€ä¸ªé¡¹è¿è¡Œä¸€ä¸ªå‡½æ•°ã€‚å¦‚æ–¹æ³•å¯ç”¨éå†æ¯ä¸€ä¸ªé¡¹éƒ½è¿”å›çš„trueï¼Œåˆ™è¿”å›true  |
| filter()      | åœ¨æ•°ç»„ä¸­çš„æ¯ä¸€ä¸ªé¡¹è¿è¡Œä¸€ä¸ªå‡½æ•°ï¼Œå¹¶å°†è¿™ä¸ªå‡½æ•°è¿”å›trueçš„é¡¹ä½œä¸ºä¸€ä¸ªæ•°ç»„è¿”å›       |
| forEach()     | åœ¨æ•°ç»„ä¸­çš„æ¯ä¸€ä¸ªé¡¹è¿è¡Œä¸€ä¸ªå‡½æ•°                              |
| map()         | åœ¨æ•°ç»„ä¸­çš„æ¯ä¸€ä¸ªé¡¹è¿è¡Œä¸€ä¸ªå‡½æ•°ï¼Œå¹¶å°†æ‰€æœ‰çš„ç»“æœä½œä¸ºæ•°ç»„è¿”å›                |
| some()        | åœ¨æ•°ç»„ä¸­çš„æ¯ä¸€ä¸ªé¡¹è¿è¡Œä¸€ä¸ªå‡½æ•°ï¼Œå¦‚æœè¿™ä¸ªæ–¹æ³•è®¿é—®çš„ä»»ä½•ä¸€ä¸ªé¡¹è¿”å›trueï¼Œåˆ™è¿”å›true |

æ³›å‹ï¼ˆéTSçš„é‚£ç§ï¼‰ä½¿ç”¨ï¼š

```js
functionÂ isLetter(character)Â {Â Â 
  returnÂ (characterÂ >=Â "a"Â &&Â characterÂ <=Â "z");Â Â 
}Â Â 

// åœ¨å­—ç¬¦ä¸²ä¸­ä½¿ç”¨æ•°ç»„çš„æ–¹æ³•
ifÂ (Array.every(str,Â isLetter))Â Â 
  alert("TheÂ stringÂ '"Â +Â strÂ +Â "'Â containsÂ onlyÂ letters!");
```

## 8. JavaScript 1.7ï¼ˆ07å¹´ï¼‰

2007å¹´å‘å¸ƒã€‚æ–°ç‰¹æ€§å¦‚ä¸‹ï¼š

*   å­¦ä¹ äº†Pythonçš„è¯­æ³•ï¼Œå¹¶å¼•å…¥äº†Pythonic generatorsï¼ˆgeneratorå‡½æ•°ï¼‰ã€
*   å¼•å…¥è§£æ„èµ‹å€¼
*   Iteratorsï¼ˆè¿­ä»£å™¨ï¼‰
*   let å£°æ˜

> è¿™ä»ç„¶æ˜¯ES3çš„å†…å®¹ï¼Œä¸è¦è®¤ä¸ºæ˜¯ES6æ‰æœ‰çš„ã€‚

*   å¼€å§‹æ”¯æŒ Google Chrome1.0ã€‚

## 9. ECMAScript 4

2008å¹´è¢«åºŸå¼ƒçš„æ ‡å‡†ã€‚[æ­»äº¡åŸå› ](https://www.136.la/jingpin/show-14541.html)

## 10. JavaScript 1.8 ï¼ˆ08-10å¹´ï¼‰ ä¸ ECMAScript 5 ï¼ˆ09å¹´ï¼‰

åŒ…å«å¾ˆå¤špatchç‰ˆæœ¬ã€‚

#### 2008å¹´å‘å¸ƒ 1.8.0

æ–°ç‰¹æ€§ï¼š

| æ–°ç‰¹æ€§    | æè¿°                                   |
| ------ | ------------------------------------ |
| è¡¨è¾¾å¼é—­åŒ…  | è§ä¸‹é¢ä»£ç                                 |
| ç”Ÿæˆå™¨è¡¨è¾¾å¼ | ä¸ªæ–°ç‰¹æ€§ä½¿ä½ å¯ä»¥ä½¿ç”¨ç±»ä¼¼æ•°ç»„æ¦‚å¿µçš„è¯­æ³•æ¥åˆ›å»ºä¸€ä¸ªç‹¬ç«‹çš„ç”Ÿæˆå™¨å¥æŸ„ï¼Œè§ä»£ç  |

è¡¨è¾¾å¼é—­åŒ…ï¼š

```js
// JavaScript 1.7 ä»¥åŠæ›´è€çš„ç‰ˆæœ¬:
function(x) { return x * x; }

// JavaScript 1.8:
function(x) x * x;
```

ç”Ÿæˆå™¨è¡¨è¾¾å¼

```js
// ä½¿ç”¨1
let it = (i + 3 for (i in someObj));
try {
    while (true) {
        document.write(it.next() + "<br>\n");
    }
} catch (err if err instanceof StopIteration) {

    document.write("End of record.<br>\n");
}

// ä½¿ç”¨2
function handleResults( results ) {
    for ( let i in results )
    ...
}
handleResults( i for ( i in obj ) if ( i > 3 ) );
```

#### åŒå¹´å‘å¸ƒ 1.8.1

æ–°ç‰¹æ€§ï¼š

| æ–°ç‰¹æ€§                     | æè¿°                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| ----------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Object.getPrototypeOf() | è¿”å›æŒ‡å®šå¯¹è±¡çš„åŸå‹å¯¹è±¡ï¼Œè§[`ç¤ºä¾‹`](https://developer.mozilla.org/En/Core_JavaScript_1.5_Reference/Global_Objects/Object/GetPrototypeOf)                                                                                                                                                                                                                                                                                                                              |
| Firefox 3.5 åŸç”Ÿæ”¯æŒ JSON   | -                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| Stringå¯¹è±¡æ–°å¢æ–¹æ³•            | [`String`Â ](https://developer.mozilla.org/en/Core_JavaScript_1.5_Reference/Global_Objects/String)Â Â å¢åŠ Â Â [`trim()`Â ](https://developer.mozilla.org/En/Core_JavaScript_1.5_Reference/Global_Objects/String/Trim),Â Â Â [`trimLeft()`Â ](https://developer.mozilla.org/En/Core_JavaScript_1.5_Reference/Global_Objects/String/TrimLeft), å’ŒÂ Â Â [`trimRight()`Â ](https://developer.mozilla.org/En/Core_JavaScript_1.5_Reference/Global_Objects/String/TrimRight) |
| å…¶ä»–ä¸€äº›æ¬¡è¦æ›´æ–°                | -                                                                                                                                                                                                                                                                                                                                                                                                                                                     |

#### 2009å¹´å‘å¸ƒ 1.8.2

ä¸€äº›æ¬¡è¦æ›´æ–°ã€‚

#### 2010å¹´å‘å¸ƒ 1.8.5ï¼Œå¹¶éµå¾ªECMAScript 5 ï¼ˆ2009å¹´å‘å¸ƒï¼‰è§„èŒƒ

ä¸€æ¬¡å¤§çš„æ›´æ–°ï¼Œå°†ä¹‹å‰JSå„ä¸ªç‰ˆæœ¬çš„æ–¹æ³•è¿›è¡Œç»Ÿä¸€æ±‡æ€»æ•´ç†ï¼Œå¹¶æ–°åŠ å…¥ä¸€æ‰¹APIï¼Œä¸€èµ·å†™å…¥è§„èŒƒï¼Œä½¿å¾—ESå’ŒJSçš„è´´åˆç¨‹åº¦æ›´æ·±ã€‚

| æ–°ç‰¹æ€§       | æè¿°           |
| --------- | ------------ |
| æ·»åŠ äº†â€œä¸¥æ ¼æ¨¡å¼â€ | use 'strict' |
| è§„èŒƒthiså…³é”®å­— | -            |
| å¯¹ JSONæ”¯æŒ  | -            |
| å­—ç¬¦ä¸²æ–¹æ³•     | è§ä¸‹åˆ—è¡¨         |
| æ•°ç»„æ–¹æ³•      | è§ä¸‹åˆ—è¡¨         |
| å„ç§å¯¹è±¡æ–¹æ³•    | è§ä¸‹åˆ—è¡¨         |

*   **ä¸¥æ ¼æ¨¡å¼**

1.  ä¸å…è®¸çœç•¥varå®šä¹‰å˜é‡
2.  ä¸å…è®¸å‡½æ•°å½¢å‚åŒå
3.  ä¸å…è®¸æ™®é€šå‡½æ•°ä¸­çš„thisä»£è¡¨window

*   **thisè§„èŒƒ**

1.  å…¨å±€thisã€æ™®é€šå‡½æ•°çš„this ã€ è‡ªè°ƒç”¨å‡½æ•°çš„thiséƒ½ä»£è¡¨window
2.  äº‹ä»¶å‡½æ•°ä¸­çš„thisä»£è¡¨äº‹ä»¶æº
3.  å¯¹è±¡æ–¹æ³•ä¸­çš„thisä»£è¡¨å½“å‰å¯¹è±¡
4.  æ™®é€šå‡½æ•°è¢«è°è°ƒç”¨ï¼Œå‡½æ•°ä¸­thisæŒ‡å‘è°

*   **ES5 æ–°å¢æ•°ç»„æ–¹æ³•/è§„èŒƒ**ï¼ˆéƒ¨åˆ†æ–¹æ³•js1.6ä¸­å·²ç»æœ‰è¿‡å®ç°ï¼Œåœ¨ES5æ­£å¼å†™å…¥è§„èŒƒï¼‰

1.  Array.isArray()
2.  Array.forEach()
3.  Array.map()
4.  Array.filter()
5.  Array.reduce()
6.  Array.reduceRight()
7.  Array.every()
8.  Array.some()
9.  Array.indexOf()
10. Array.lastIndexOf()

*   **ES5æ–°å¢å­—ç¬¦ä¸²è§„èŒƒ**

1.  String.trim()
2.  charAt()
3.  å¯å¯¹å­—ç¬¦ä¸²è¿›è¡Œå±æ€§è®¿é—®
4.  å…è®¸å¤šè¡Œå­—ç¬¦ä¸²ï¼Œæ¯ä¸€è¡Œä½¿ç”¨åæ–œæ ç»“å°¾
5.  String.fromCharCode() ç”¨äºä» Unicode ç ç‚¹è¿”å›å¯¹åº”å­—ç¬¦

*   **ES5 æ–°å¢å„ç§å¯¹è±¡æ–¹æ³•**

1.  JSON.parse()
2.  JSON.stringify()
3.  Date.now()
4.  å±æ€§ Getter å’Œ Setter
5.  æ–°çš„å¯¹è±¡å±æ€§å’Œæ–¹æ³•è§„èŒƒï¼Œè§ä¸‹è¡¨

| æ–°çš„å¯¹è±¡å±æ€§å’Œæ–¹æ³•è§„èŒƒ                                         | æè¿°                                     |
| --------------------------------------------------- | -------------------------------------- |
| Object.defineProperty(object, property, descriptor) | æ·»åŠ æˆ–æ›´æ”¹å¯¹è±¡å±æ€§                              |
| Object.defineProperties(object, descriptors)        | æ·»åŠ æˆ–æ›´æ”¹å¤šä¸ªå¯¹è±¡å±æ€§                            |
| Object.getOwnPropertyDescriptor(object, property)   | è®¿é—®å±æ€§                                   |
| Object.getOwnPropertyNames(object)                  | å°†æ‰€æœ‰å±æ€§ä½œä¸ºæ•°ç»„è¿”å›                            |
| Object.keys(object)                                 | å°†å¯æšä¸¾å±æ€§ä½œä¸ºæ•°ç»„è¿”å›                           |
| Object.hasOwnProperty(key)                          | æ˜¯å¦ä¸ºå¯¹è±¡è‡ªèº«å±æ€§                              |
| Object.getPrototypeOf(object)                       | è·å–å¯¹è±¡åŸå‹                                 |
| Object.preventExtensions(object)                    | é˜²æ­¢å‘å¯¹è±¡æ·»åŠ æ–°çš„å±æ€§                            |
| Object.isExtensible(object)                         | å¦‚æœå¯ä»¥å°†å±æ€§æ·»åŠ åˆ°å¯¹è±¡ï¼Œåˆ™è¿”å› true                  |
| Object.seal(object)                                 | é˜²æ­¢æ›´æ”¹å¯¹è±¡å±æ€§ï¼ˆè€Œä¸æ˜¯å€¼ï¼‰å¯¹è±¡ä¸å¯ä»¥æ–°å¢å±æ€§å’Œåˆ é™¤ ä½†æ˜¯å¯ä»¥ä¿®æ”¹      |
| Object.isSealed(object)                             | å¦‚æœå¯¹è±¡è¢«å¯†å°ï¼Œåˆ™è¿”å› true                       |
| Object.freeze(object)                               | é˜²æ­¢å¯¹å¯¹è±¡è¿›è¡Œä»»ä½•æ›´æ”¹ ä¸å¯ä»¥æ–°å¢å±æ€§å’Œåˆ é™¤ä¹Ÿä¸å¯ä¿®æ”¹ å®Œå…¨é”æ­»       |
| Object.isFrozen(object)                             | å¦‚æœå¯¹è±¡è¢«å†»ç»“ï¼Œåˆ™è¿”å› true                       |
| å…è®¸ä¿ç•™å­—ä½œä¸ºå±æ€§åç§°                                         | `var obj = {name: "Bill", new: "yes"}` |

*   **ES5 è¯­æ³•æ›´æ”¹**

1.  å¯¹å­—ç¬¦ä¸²çš„å±æ€§è®¿é—® \[ ]
2.  æ•°ç»„å’Œå¯¹è±¡å­—é¢é‡ä¸­çš„å°¾éšé€—å·ï¼ˆJSONé™¤å¤–ï¼‰
3.  å¤šè¡Œå­—ç¬¦ä¸²å­—é¢é‡
4.  ä½œä¸ºå±æ€§åç§°çš„ä¿ç•™å­—

*   **ES5 æµè§ˆå™¨æ”¯æŒ**

Chrome 23ã€IE 10 å’Œ Safari 6 æ˜¯ç¬¬ä¸€æ‰¹å®Œå…¨æ”¯æŒ ECMAScript 5 çš„æµè§ˆå™¨ï¼š

| Chrome23                                                                                                                                                                                | IE10/Edge                                                                                                                                                                           | Firefox21                                                                                                                                                                                | Safari6                                                                                                                                                                                 | Opera15                                                                                                                                                                                |
| --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| ![compatible\_chrome.png](/img/posts/2022-6-15/chrome.png) | ![compatible\_ie.png](/img/posts/2022-6-15/ie.png) | ![compatible\_firefox.png](/img/posts/2022-6-15/firefox.png) | ![compatible\_safari.png](/img/posts/2022-6-15/safari.png) | ![compatible\_opera.png](/img/posts/2022-6-15/opera.png) |
| 2012å¹´9æœˆ                                                                                                                                                                                 | 2012å¹´9æœˆ                                                                                                                                                                             | 2013å¹´4æœˆ                                                                                                                                                                                  | 2012å¹´7æœˆ                                                                                                                                                                                 | 2013å¹´7æœˆ                                                                                                                                                                                |

## 11. ECMAScript 6 ï¼ˆ2015å¹´ï¼‰

2015å¹´å‘å¸ƒES6ï¼Œåˆæ˜¯ä¸€æ¬¡é‡å¤§æ›´æ–°ï¼š

| æ–°çš„ç‰¹æ€§å’Œæ‰©å±•  | æè¿°                                                                                                                                                        |
| -------- | --------------------------------------------------------------------------------------------------------------------------------------------------------- |
| å˜é‡å£°æ˜     | **let**ï¼š js1.7ä¸­å·²ç»æœ‰è¿‡å®ç°ï¼Œè¿™é‡Œé‡æï¼Œè¯´æ˜å—çº§ä½œç”¨åŸŸçš„é‡è¦æ€§ï¼›**const**ï¼šå¸¸é‡ï¼›**å˜é‡è§£æ„èµ‹å€¼**ï¼š`let \[a, b, c] = \[1, 2, 3]; let { foo, bar } = { foo: 'aaa', bar: 'bbb' }; `               |
| å¹‚ (\*\*) | æŒ‡æ•°è¿ç®—ç¬¦, Math.pow() ?                                                                                                                                       |
| é»˜è®¤å‚æ•°å€¼    | å‡½æ•°å£°æ˜æ—¶å¯ä»¥åˆ¶å®šé»˜è®¤å‚æ•°                                                                                                                                             |
| å­—ç¬¦ä¸²æ‰©å±•    | è§ä¸‹é¢åˆ—è¡¨                                                                                                                                                     |
| æ­£åˆ™æ‰©å±•     | è§ä¸‹é¢åˆ—è¡¨                                                                                                                                                     |
| æ•°ç»„æ‰©å±•     | è§ä¸‹é¢åˆ—è¡¨                                                                                                                                                     |
| å¯¹è±¡æ‰©å±•     | è§ä¸‹é¢åˆ—è¡¨                                                                                                                                                     |
| æ–°çš„æ•°å­—å±æ€§   | ES6 å°†ä»¥ä¸‹å±æ€§æ·»åŠ åˆ° Number å¯¹è±¡ï¼š EPSILONã€MIN\_SAFE\_INTEGERã€MAX\_SAFE\_INTEGER                                                                                     |
| æ–°çš„æ•°å­—æ–¹æ³•   | Number.isInteger() ã€Number.isSafeInteger()ï¼Œ Mathä¹Ÿæ–°å¢äº†17ä¸ª[é™æ€æ–¹æ³•](https://es6.ruanyifeng.com/#docs/number#Math-%E5%AF%B9%E8%B1%A1%E7%9A%84%E6%89%A9%E5%B1%95) |
| æ–°çš„å…¨å±€æ–¹æ³•   | isFinite()ã€isNaN()                                                                                                                                        |
| å‡½æ•°æ‰©å±•     | 1ã€å¼•å…¥ç®­å¤´å‡½æ•°ï¼šæ²¡æœ‰è‡ªå·±çš„thisã€æ²¡æœ‰é€’å½’ï¼Œäº‹ä»¶ç»‘å®šï¼Œè§£ç»‘å®šã€æ²¡æœ‰æ„é€ å™¨ã€ä¸å¯å…·ååŒ–ã€ä¹¦å†™ç®€å• 2ã€å¼•å…¥restå‚æ•° 3ã€å¢åŠ Function.prototype.toString()                                                            |
| Symbol   | æ–°çš„åŸå§‹æ•°æ®ç±»å‹, è¡¨ç¤ºç‹¬ä¸€æ— äºŒçš„å€¼                                                                                                                                        |
| æ–°å¢æ•°æ®ç»“æ„   | Setå’ŒMap                                                                                                                                                   |
| Proxy    | å¯¹è±¡ä»£ç†ï¼Œè¯¦è§é˜®è€å¸ˆçš„[è§£é‡Š](https://es6.ruanyifeng.com/#docs/proxy)                                                                                                   |
| Reflect  | ä¸ºäº†æ“ä½œå¯¹è±¡è€Œæä¾›çš„æ–° API                                                                                                                                           |
| å‰ç«¯å¼‚æ­¥ç­–ç•¥   | Promiseï¼ˆé€šå¸¸ä¸ES2017çš„asyncä¸€èµ·ä½¿ç”¨ï¼‰                                                                                                                              |
| è¿­ä»£å™¨      | å°†Iterator ã€ for...of å¾ªç¯ å’Œ Generatorå‡½æ•°å†™å…¥è§„èŒƒ                                                                                                                 |
| Classå£°æ˜  | å¢åŠ ç»§æ‰¿ã€æ¥å£ç­‰æ¦‚å¿µ                                                                                                                                                |
| ESModule | jsåŸç”Ÿæ”¯æŒæ¨¡å—åŒ–                                                                                                                                                 |
| æ–°å¢ææ¡ˆ     | è£…é¥°å™¨Decoratorã€do è¡¨è¾¾å¼ã€throw è¡¨è¾¾å¼ã€å‡½æ•°çš„éƒ¨åˆ†æ‰§è¡Œã€ç®¡é“è¿ç®—ç¬¦ã€Math.signbit()ã€åŒå†’å·è¿ç®—ç¬¦ã€Realm APIã€#!å‘½ä»¤ã€import.metaã€JSON æ¨¡å—                                                      |
| æ–°å¢è§„æ ¼æ–‡ä»¶   | -                                                                                                                                                         |

*   **å­—ç¬¦ä¸²æ‰©å±•**

1.  å­—ç¬¦ä¸²Unicodeæ ‡è¯†æ³•ï¼Œå¹¶å…è®¸ç›´æ¥è¾“å…¥å­—ç¬¦
2.  å¼•å…¥å­—ç¬¦ä¸²éå†å™¨
3.  JSON.stringifyæ”¹é€ 
4.  å¼•å…¥æ¨¡æ¿å­—ç¬¦ä¸²ã€æ ‡ç­¾æ¨¡æ¿æ¸²æŸ“
5.  æ–°å¢ä¸€äº›æ–¹æ³•ï¼Œè§ä¸‹è¡¨

| å­—ç¬¦ä¸²æ–¹æ³•                  | æè¿°                                         |
| ---------------------- | ------------------------------------------ |
| String.fromCodePoint() | å¯ä»¥è¯†åˆ«å¤§äº`0xFFFF`çš„å­—ç¬¦                          |
| String.raw()           | è¿”å›ä¸€ä¸ªæ–œæ éƒ½è¢«è½¬ä¹‰ï¼ˆå³æ–œæ å‰é¢å†åŠ ä¸€ä¸ªæ–œæ ï¼‰çš„å­—ç¬¦ä¸²ï¼Œå¾€å¾€ç”¨äºæ¨¡æ¿å­—ç¬¦ä¸²çš„å¤„ç†æ–¹æ³• |
| codePointAt            | èƒ½å¤Ÿæ­£ç¡®å¤„ç† 4 ä¸ªå­—èŠ‚å‚¨å­˜çš„å­—ç¬¦ï¼Œè¿”å›ä¸€ä¸ªå­—ç¬¦çš„ç ç‚¹ã€‚               |
| normalize              | å°†å­—ç¬¦çš„ä¸åŒè¡¨ç¤ºæ–¹æ³•ç»Ÿä¸€ä¸ºåŒæ ·çš„å½¢å¼ï¼Œè¿™ç§°ä¸º Unicode æ­£è§„åŒ–ã€‚        |
| startsWith             | è¿”å›å¸ƒå°”å€¼ï¼Œè¡¨ç¤ºå‚æ•°å­—ç¬¦ä¸²æ˜¯å¦åœ¨åŸå­—ç¬¦ä¸²çš„å¤´éƒ¨ã€‚                   |
| endsWith               | è¿”å›å¸ƒå°”å€¼ï¼Œè¡¨ç¤ºå‚æ•°å­—ç¬¦ä¸²æ˜¯å¦åœ¨åŸå­—ç¬¦ä¸²çš„å°¾éƒ¨ã€‚                   |
| repeat                 | è¿”å›ä¸€ä¸ªæ–°å­—ç¬¦ä¸²ï¼Œè¡¨ç¤ºå°†åŸå­—ç¬¦ä¸²é‡å¤`n`æ¬¡ã€‚                    |
| at                     | æ¥å—ä¸€ä¸ªæ•´æ•°ä½œä¸ºå‚æ•°ï¼Œè¿”å›å‚æ•°æŒ‡å®šä½ç½®çš„å­—ç¬¦ï¼Œæ”¯æŒè´Ÿç´¢å¼•ï¼ˆå³å€’æ•°çš„ä½ç½®ï¼‰ã€‚      |

*   **æ­£åˆ™æ‰©å±•**

1.  RegExpæ„é€ å‡½æ•°å¢åŠ ç¬¬äºŒä¸ªå‚æ•°
2.  ES6 å‡ºç°ä¹‹å‰ï¼Œå­—ç¬¦ä¸²å¯¹è±¡å…±æœ‰ 4 ä¸ªæ–¹æ³•ï¼Œå¯ä»¥ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼ï¼š`match()`ã€`replace()`ã€`search()`å’Œ`split()`ã€‚ES6ä¸­RegExpé›†æˆäº†è¿™å››ä¸ªæ–¹æ³•ã€‚
3.  `u`ä¿®é¥°ç¬¦
4.  æ–°å¢RegExp.prototype.unicode å±æ€§
5.  æ–°å¢RegExp.prototype.sticky å±æ€§
6.  æ–°å¢RegExp.prototype.flags å±æ€§

*   **æ•°ç»„æ‰©å±•**

1.  å¼•å…¥æ‰©å±•è¿ç®—ç¬¦
2.  Array.from()
3.  Array.of()
4.  å®ä¾‹æ–¹æ³•ï¼šcopyWithin()
5.  å®ä¾‹æ–¹æ³•ï¼šfind() å’Œ findIndex()
6.  å®ä¾‹æ–¹æ³•ï¼šfill()
7.  å®ä¾‹æ–¹æ³•ï¼šentries()ï¼Œkeys() å’Œ values()
8.  æ•°ç»„çš„ç©ºä½å®šä¹‰
9.  Array.prototype.sort() çš„æ’åºç¨³å®šæ€§é—®é¢˜ï¼šå¸¸è§çš„æ’åºç®—æ³•ä¹‹ä¸­ï¼Œæ’å…¥æ’åºã€åˆå¹¶æ’åºã€å†’æ³¡æ’åºç­‰éƒ½æ˜¯ç¨³å®šçš„ï¼Œå †æ’åºã€å¿«é€Ÿæ’åºç­‰æ˜¯ä¸ç¨³å®šçš„ã€‚ä¸ç¨³å®šæ’åºçš„ä¸»è¦ç¼ºç‚¹æ˜¯ï¼Œå¤šé‡æ’åºæ—¶å¯èƒ½ä¼šäº§ç”Ÿé—®é¢˜ã€‚åœ¨ES2019æ‰è§£å†³ã€‚

*   **å¯¹è±¡æ‰©å±•**

1.  keyå’Œå˜é‡æ˜¯åŒä¸€ä¸ªå•è¯æ—¶ï¼Œå¯ç®€å†™
2.  å±æ€§åè¡¨è¾¾å¼å†™æ³•ï¼š`obj['a' + 'bc'] = 123;`
3.  æ–¹æ³•æœ‰nameå±æ€§
4.  Object.assign()
5.  å¯¹è±¡å±æ€§éå†æ–¹å¼ï¼šfor...inã€Object.keys(obj)ã€Object.getOwnPropertyNames(obj)ã€Object.getOwnPropertySymbols(obj)ã€Reflect.ownKeys(obj)
6.  superå…³é”®å­—
7.  å¯¹è±¡æ‰©å±•`...`
8.  Object.is()ï¼šES5 æ¯”è¾ƒä¸¤ä¸ªå€¼æ˜¯å¦ç›¸ç­‰ï¼Œåªæœ‰ä¸¤ä¸ªè¿ç®—ç¬¦ï¼šç›¸ç­‰è¿ç®—ç¬¦ï¼ˆ`==`ï¼‰å’Œä¸¥æ ¼ç›¸ç­‰è¿ç®—ç¬¦ï¼ˆ`===`ï¼‰ã€‚å®ƒä»¬éƒ½æœ‰ç¼ºç‚¹ï¼Œå‰è€…ä¼šè‡ªåŠ¨è½¬æ¢æ•°æ®ç±»å‹ï¼Œåè€…çš„`NaN`ä¸ç­‰äºè‡ªèº«ï¼Œä»¥åŠ`+0`ç­‰äº`-0`ã€‚JavaScript ç¼ºä¹ä¸€ç§è¿ç®—ï¼Œåœ¨æ‰€æœ‰ç¯å¢ƒä¸­ï¼Œåªè¦ä¸¤ä¸ªå€¼æ˜¯ä¸€æ ·çš„ï¼Œå®ƒä»¬å°±åº”è¯¥ç›¸ç­‰ã€‚

*   **ES6 æµè§ˆå™¨æ”¯æŒ**

Safari 10 å’Œ Edge 14 æ˜¯é¦–å…ˆå®Œå…¨æ”¯æŒ ES6 çš„æµè§ˆå™¨ï¼š

| Chrome 58                                                                                                                                                                               | Edge 14                                                                                                                                                                             | Firefox 54                                                                                                                                                                               | Safari 10                                                                                                                                                                               | Opera 55                                                                                                                                                                               |
| --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| ![compatible\_chrome.png](/img/posts/2022-6-15/chrome.png) | ![compatible\_ie.png](/img/posts/2022-6-15/ie.png) | ![compatible\_firefox.png](/img/posts/2022-6-15/firefox.png) | ![compatible\_safari.png](/img/posts/2022-6-15/safari.png) | ![compatible\_opera.png](/img/posts/2022-6-15/opera.png) |
| Jan 2017                                                                                                                                                                                | Aug 2016                                                                                                                                                                            | Mar 2017                                                                                                                                                                                 | Jul 2016                                                                                                                                                                                | Aug 2018                                                                                                                                                                               |

> ES6ä¹‹åæ²¡æœ‰å°æ•°å­—ç‰ˆæœ¬çš„ECMAScriptäº†ï¼Œå–è€Œä»£ä¹‹çš„æ˜¯ä»¥å¹´ä»½ä¸ºä»£å·çš„ç‰ˆæœ¬ï¼Œå› ä¸ºæ¯ä¸€å¹´éƒ½ä¼šæœ‰ä¸€ä¸ªç‰ˆæœ¬ã€‚ç½‘ä¼ çš„ES7ã€ES8ä»€ä¹ˆçš„ï¼Œå…¶å®å®˜æ–¹æ²¡æœ‰è¿™ç§å«æ³•ã€‚

## 12. ECMAScript 2016

2016å¹´å‘å¸ƒã€‚

| æ–°ç‰¹æ€§                      | æè¿°                                                |
| ------------------------ | ------------------------------------------------- |
| æ±‚å¹‚èµ‹å€¼                     | let x = 5; x \*\*= 2; // ç»“æœæ˜¯ 25                   |
| Array.prototype.includes | -                                                 |
| è£…é¥°å™¨                      | [åŠ¨æ€](https://github.com/tc39/proposal-decorators) |

*   **ES2016 æµè§ˆå™¨æ”¯æŒ**

æ‰€æœ‰ç°ä»£æµè§ˆå™¨éƒ½æ”¯æŒ Array.prototype.includesï¼š

| Chrome 47                                                                                                                                                                               | Edge 14                                                                                                                                                                             | Firefox 43                                                                                                                                                                               | Safari 9                                                                                                                                                                                | Opera 34                                                                                                                                                                               |
| --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| ![compatible\_chrome.png](/img/posts/2022-6-15/chrome.png) | ![compatible\_ie.png](/img/posts/2022-6-15/ie.png) | ![compatible\_firefox.png](/img/posts/2022-6-15/firefox.png) | ![compatible\_safari.png](/img/posts/2022-6-15/safari.png) | ![compatible\_opera.png](/img/posts/2022-6-15/opera.png) |
| 2015 å¹´ 12 æœˆ                                                                                                                                                                             | 2016 å¹´ 8 æœˆ                                                                                                                                                                          | 2015 å¹´ 12 æœˆ                                                                                                                                                                              | 2015 å¹´ 10 æœˆ                                                                                                                                                                             | 2015 å¹´ 12 æœˆ                                                                                                                                                                            |

<hr />

æœ€è¿‘çš„ç‰ˆæœ¬å¿«é€Ÿæµè§ˆï¼š

## 13. ECMAScript 2017

2017å¹´å‘å¸ƒã€‚

| æ–°ç‰¹æ€§     | æè¿°                                                              |
| ------- | --------------------------------------------------------------- |
| å¼‚æ­¥å£°æ˜    | async/await                                                     |
| å¯¹è±¡æ”¯æŒå°¾é€—å· | `{ a: 1, b: 2, } `                                                |
| å­—ç¬¦ä¸²æ‰©å±•   | String.padStart å’Œ String.padEndï¼Œå¢åŠ å­—ç¬¦ä¸²å‰åç¼©è¿›                       |
| å¯¹è±¡æ‰©å±•    | Object.valuesã€Object.entriesã€Object.getOwnPropertyDescriptors() |

## 14. ECMAScript 2018

2018å¹´å‘å¸ƒã€‚

| æ–°ç‰¹æ€§                   | æè¿°                                                      |
| --------------------- | ------------------------------------------------------- |
| å¼‚æ­¥è¿­ä»£                  | ES2018å¼•â¼Šå¼‚æ­¥è¿­ä»£å™¨ï¼Œå…è®¸ for...of å¾ªç¯å¯ä»¥å’Œ await â¼€èµ·ä½¿â½¤ï¼Œä»¥ä¸²â¾çš„â½…å¼è¿â¾å¼‚æ­¥æ“ä½œ |
| Promiseæ‰©å±•             | Promise.finally()                                       |
| Restå‚æ•°çš„Spreadå±æ€§       | å±•å¼€è¿ç®—ç¬¦ï¼šMath.max(...values) // values = \[1,2,3,4]        |
| æ­£åˆ™è¡¨è¾¾å¼å‘½åæ•è·ç»„            | ES2018å…è®¸å‘½åæ•è·ç»„ä½¿â½¤ç¬¦å·`?<name>`ï¼Œåœ¨æ‰“å¼€æ•è·æ‹¬å·(åâ½´å³å‘½å                |
| æ­£åˆ™è¡¨è¾¾å¼åå‘æ–­è¨€             | `?<= ã€?\<!  `                                             |
| æ­£åˆ™è¡¨è¾¾å¼ s ä¿®é¥°ç¬¦ï¼šdotAll æ¨¡å¼ | [æ­£åˆ™æ‰©å±•](http://caibaojian.com/es6/regex.html)            |
| æ­£åˆ™è¡¨è¾¾å¼Unicodeè½¬ä¹‰        | [æ­£åˆ™æ‰©å±•](http://caibaojian.com/es6/regex.html)            |

*   å¼‚æ­¥è¿­ä»£ç¤ºä¾‹ï¼š

```js
// ä¸èµ·ä½œç”¨
async function process(array) {
  for (let i of array) {
    await doSomething(i);
  }
}

// èµ·ä½œç”¨äº†
async function process(array) {
  for await (let i of array) {
    doSomething(i);
  }
}
```

## 15. ECMAScript 2019

2019å¹´å‘å¸ƒã€‚

| æ–°ç‰¹æ€§                             | æè¿°                                                                                   |
| ------------------------------- | ------------------------------------------------------------------------------------ |
| å­—ç¬¦ä¸²æ‰©å±•                           | `String.prototype.trimStart() , String.prototype.trimEnd()`ï¼ŒåŸæ¥çš„trimLeftå’ŒtrimRightè¢«åºŸå¼ƒ |
| Object.fromEntries()            | Object.entriesçš„é€†è¿ç®—                                                                   |
| æ•°ç»„æ‹å¹³                            | `Array.prototype.flat() ï¼Œ Array.prototype.flatMap()`                                 |
| catch çš„å‚æ•°æ”¹ä¸ºå¯é€‰                   | å¯ä»¥çœç•¥catchç»‘å®šçš„å‚æ•°å’Œæ‹¬å·                                                                    |
| Symbol.description              | -                                                                                    |
| JSON Superset è¶…é›†                | å³jså…¼å®¹æ‰€æœ‰JSONæ”¯æŒçš„æ–‡æœ¬ã€‚åŸå§‹çš„JSON å†…å®¹å¯ä»¥æ­£å¸¸åŒ…å« U+2028è¡Œåˆ†éš”ç¬¦ ä¸ U+2029æ®µåˆ†éš”ç¬¦ï¼Œè€Œä¹‹å‰ç‰ˆæœ¬çš„ECMAScript å´ä¸è¡Œ       |
| JSON.stringify() è½¬åŒ–ç‰¹æ®Šå­—ç¬¦         | ä¿®å¤äº†å¯¹äºä¸€äº›è¶…å‡ºèŒƒå›´çš„Â `Unicode`å±•ç¤ºé”™è¯¯çš„é—®é¢˜                                                        |
| Array.sort                      | å˜ä¸ºç¨³å®šç®—æ³•                                                                               |
| Function.prototype.toString()å¢å¼º | å¯ä»¥è¿”å›æ³¨é‡Šå’Œç©ºæ ¼                                                                            |
| String.prototype.matchAll       | è¿”å›ä¸€ä¸ªåŒ…å«æ‰€æœ‰åŒ¹é…æ­£åˆ™è¡¨è¾¾å¼åŠåˆ†ç»„æ•è·ç»“æœçš„è¿­ä»£å™¨                                                           |

## 16. ECMAScript 2020

2020å¹´å‘å¸ƒã€‚

| æ–°ç‰¹æ€§                | æè¿°                                                                                                                           |
| ------------------ | ---------------------------------------------------------------------------------------------------------------------------- |
| Promise.allSettled | å½“æ‰€æœ‰promiseéƒ½resolveæˆ–rejectåï¼Œè¿”å›resolveæˆ–rejectçš„ç»“æœé›†åˆæ•°ç»„                                                                           |
| é“¾åˆ¤æ–­è¿ç®—ç¬¦             | `const firstName = message?.body?.user?.firstName \|\| 'default';`                                                           |
| ç©ºå€¼åˆå¹¶è¿ç®—ç¬¦            | `var level = user.level ?? 'æš‚â½†ç­‰çº§';`                                                                                          |
| åŠ¨æ€å¼•å…¥               | import(`/test.js`).then((module) =\> {}                                                                                      |
| globalThiså¯¹è±¡       | `globalThis`Â æä¾›äº†ä¸€ä¸ªæ ‡å‡†çš„æ–¹å¼æ¥è·å–ä¸åŒç¯å¢ƒä¸‹çš„å…¨å±€Â `this`Â å¯¹è±¡ï¼ˆä¹Ÿå°±æ˜¯å…¨å±€å¯¹è±¡è‡ªèº«ï¼‰ã€‚ä¸åƒÂ `window`Â æˆ–è€…Â `self`Â è¿™äº›å±æ€§ï¼Œ`globalThis` ç¡®ä¿å¯ä»¥åœ¨æœ‰ã€æ— çª—å£çš„å„ç§ç¯å¢ƒä¸‹æ­£å¸¸å·¥ä½œ         |
| å¼•å…¥bigint           | Numberæœ‰å–å€¼èŒƒå›´ \[Number.MIN\_SAFE\_INTEGER, Number.MAX\_SAFE\_INTEGER], è¶…è¿‡è¿™ä¸ªèŒƒå›´ä¼šç²¾åº¦ä¸¢å¤±ï¼Œè¿™å°±éœ€è¦å¤§æ•°ç±»å‹ï¼švar bigIntNum = 9007199254740993n; |

## 17. ECMAScript 2021

2021å¹´å‘å¸ƒã€‚

| æ–°ç‰¹æ€§         | æè¿°                                                                                                                                 |
| ----------- | ---------------------------------------------------------------------------------------------------------------------------------- |
| Promise.any | æ¥æ”¶ä¸€ä¸ªPromiseæ•°ç»„ï¼Œåªè¦å…¶ä¸­ä»»æ„ä¸€ä¸ªresolveï¼Œä¾¿é€šè¿‡ï¼Œå¦åˆ™æ‹’ç»                                                                                             |
| replaceAll  | è¿”å›â¼€ä¸ªå…¨æ–°çš„å­—ç¬¦ä¸²ï¼Œæ‰€æœ‰ç¬¦åˆåŒ¹é…è§„åˆ™çš„å­—ç¬¦éƒ½å°†è¢«æ›¿æ¢æ‰                                                                                                       |
| WeakRefs    | åœ¨ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œå¯¹è±¡çš„å¼•ç”¨æ˜¯å¼ºå¼•ç”¨çš„ï¼Œè¿™æ„å‘³ç€åªè¦æŒæœ‰å¯¹è±¡çš„å¼•ç”¨ï¼Œå®ƒå°±ä¸ä¼šè¢«åƒåœ¾å›æ”¶ã€‚åªæœ‰å½“è¯¥å¯¹è±¡æ²¡æœ‰ä»»ä½•çš„å¼ºå¼•ç”¨æ—¶ï¼Œåƒåœ¾å›æ”¶æœºåˆ¶æ‰ä¼šé”€æ¯è¯¥å¯¹è±¡å¹¶ä¸”å›æ”¶è¯¥å¯¹è±¡æ‰€å çš„å†…å­˜ç©ºé—´ã€‚è€Œ `WeakRef` å…è®¸ä¿ç•™å¯¹ä¸€ä¸ªå¯¹è±¡çš„å¼±å¼•ç”¨ï¼Œè€Œä¸ä¼šé˜»æ­¢è¢«å¼±å¼•ç”¨çš„å¯¹è±¡è¢«åƒåœ¾å›æ”¶ã€‚ |
| æ•°å­—å£°æ˜æ—¶å¯å¢åŠ åˆ†éš”ç¬¦ | `const num = 1_000_000_000  //1000000000`                                                                                          |
| æ–°çš„é€»è¾‘è¿ç®—ç¬¦å’Œè¡¨è¾¾å¼ | è§ä¸‹é¢ä»£ç                                                                                                                               |

```js
a ||= b
//ç­‰ä»·äº
a = a || (a = b)
a &&= b
//ç­‰ä»·äº
a = a && (a = b)
a ??= b
//ç­‰ä»·äº
a = a ?? (a = b)
```

## 18. ECMAScript 2022

2022å¹´å‘å¸ƒã€‚

| æ–°ç‰¹æ€§                         | æè¿°                                                                                       |
| --------------------------- | ---------------------------------------------------------------------------------------- |
| classæ–°ç‰¹æ€§                    | 1ã€å¢åŠ privateå±æ€§ï¼Œ `class A { #a = 1 }`; 2ã€å¢åŠ classçš„staticæˆå‘˜æ–¹æ³•                                  |
| top-level await             | å¯ä»¥ä½¿ç”¨type='module'çš„scriptæ ‡ç­¾å¼•å…¥ä¸€ä¸ªjsæ–‡ä»¶ï¼Œjsé‡Œä½¿ç”¨awaitè·å–å¼‚æ­¥æ•°æ®                                      |
| æ•°ç»„å®ä¾‹æ–¹æ³•at(index)             | `a = [1,2,3]; const value = a.at(1)`                                                     |
| errorå¤„ç†æ–°æ–¹å¼                  | `throw new Error('fail', { cause: 123 });` åœ¨catché‡Œè·å–ï¼š`catch(e) { console.log(e.cause) }` |
| Object.hasOwn(obj, propKey) | åŒhasOwnPropertyï¼Œä½†æ”¯æŒæ‰€æœ‰å¯¹è±¡ç±»å‹çš„åˆ¤æ–­                                                             |

## 19. ECMAScript 2023

*   ä»å¤´åˆ°å°¾æœç´¢æ•°ç»„ï¼š`findLast()`Â ã€`findLastIndex()`
*   Hashbang è¯­æ³•
*   é€šè¿‡å‰¯æœ¬æ›´æ”¹æ•°ç»„ï¼š`toReversed()`ã€`toSorted()`ã€`toSpliced()`ã€`with()`
*   Symbol ä½œä¸º WeakMap çš„é”®

## 20. åè®°

éšç€ECMAScriptç‰ˆæœ¬çš„æ›´æ–°ï¼Œæ–‡ç« ä¼šæŒç»­ä¿æŒæ›´æ–°\~\~

<hr />

å‚è€ƒèµ„æ–™

*   [ECMA-international å®˜ç½‘](https://www.ecma-international.org/)
*   [Baiduç™¾ç§‘ - JavaScript](https://baike.baidu.com/item/JavaScript/321142?fr=aladdin)
*   [Javascript.com](https://www.javascript.com/)
*   [W3Cå­¦é™¢](https://www.w3school.com.cn/js/js_versions.asp)37:T2710,> ä¸“æ è¯´æ˜ï¼šå¯¹äºreact-router v6ç‰ˆæœ¬ï¼Œæœ‰åŒäº‹ååº”ç¼ºå°‘ç›¸å¯¹å®Œæ•´çš„ä¸­æ–‡æ–‡æ¡£ï¼ŒæŸ¥çœ‹ä¸æ–¹ä¾¿ã€‚ä¸ºäº†ä¾¿äºä½¿ç”¨ï¼Œä½œè€…å¯¹[å®˜ç½‘æ–‡æ¡£](https://reactrouter.com/docs/en/v6)è¿›è¡Œé’ˆå¯¹æ€§ç¿»è¯‘ï¼Œä¾¿äºv6ç‰ˆæœ¬æ›´å¹¿æ³›çš„è¢«ä½¿ç”¨ã€‚

## 1. \<Link>

ç±»å‹å®šä¹‰ï¼š

```ts
declare function Link(props: LinkProps): React.ReactElement;

interface LinkProps
  extends Omit<
    React.AnchorHTMLAttributes<HTMLAnchorElement>,
    "href"
  > {
  replace?: boolean;
  state?: any;
  to: To;
  reloadDocument?: boolean;
}

type To = Partial<Location> | string;
```
å†…ç½®å…ƒç´ Â `<Link>`Â æ˜¯ç”¨äºé€šè¿‡ç‚¹å‡»è·³è½¬é¡µé¢çš„ã€‚ åœ¨Â `react-router-dom`ä¸­ï¼Œ`<Link>`Â ä¼šæ¸²æŸ“ä¸€ä¸ª`<a>`Â æ ‡ç­¾ï¼Œ æ ‡ç­¾çš„ `href`Â ä¸ºLinkçš„ `to` å±æ€§. ä¹Ÿå°±æ˜¯è¯´ï¼Œå³é”®ç‚¹å‡»ä¸€ä¸ª `<Link>`ä¹Ÿæ˜¯èµ·ä½œç”¨çš„. ä½ ä¹Ÿå¯ä»¥è¿™ä¹ˆå†™ï¼š`<Link reloadDocument>`Â ï¼Œ ä»¥æ­¤æ¥é˜»æ­¢æµè§ˆå™¨é»˜è®¤äº‹ä»¶ã€‚

ä½¿ç”¨æ¡ˆä¾‹ï¼š

```ts
import * as React from "react";
import { Link } from "react-router-dom";

function UsersIndexPage({ users }) {
  return (
    <div>
      <h1>Users</h1>
      <ul>
        {users.map((user) => (
          <li key={user.id}>
            <Link to={user.id}>{user.name}</Link>
          </li>
        ))}
      </ul>
    </div>
  );
}
```

`<Link to>`Â çš„ `to` å‚æ•°ï¼Œå¦‚æœä¸æ˜¯ä»¥ `/` å¼€å¤´çš„è¯ï¼Œè¡¨ç¤ºæ˜¯ä¸€ä¸ªç›¸å¯¹è·¯ç”±ã€‚è·¯å¾„ä¸­å¯èƒ½ä¼šåŒ…å« `..`æ¥æ£€ç´¢ä¸Šä¸€çº§ï¼Œç±»ä¼¼ç›®å½•æŒ‡ä»¤çš„ `cd`ã€‚


åœ¨ React Native ä¸­ä½¿ç”¨ï¼š

ç±»å‹å®šä¹‰ï¼š
```ts
declare function Link(props: LinkProps): React.ReactElement;

interface LinkProps extends TouchableHighlightProps {
  children?: React.ReactNode;
  onPress?(event: GestureResponderEvent): void;
  replace?: boolean;
  state?: any;
  to: To;
}
```

`<Link>` ç”¨äºå“åº”ç”¨æˆ·ç‚¹å‡»åè·³è½¬å…¶ä»–çš„ `View`, æ¸²æŸ“ä¸ºä¸€ä¸ªÂ `<a>`Â æ ‡ç­¾ã€‚ åœ¨Â `react-router-native`, ä¸­ï¼ŒÂ `<Link>`Â æ¸²æŸ“ä¸€ä¸ªÂ `TouchableHighlight`ã€‚å¯ä»¥ä½¿ç”¨[`TouchableHighlight`é…ç½®é¡¹](https://reactnative.dev/docs/touchablehighlight#props)æ¥è‡ªå®šä¹‰æ ·å¼å’Œè¡Œä¸ºã€‚

```ts
import * as React from "react";
import { View, Text } from "react-native";
import { Link } from "react-router-native";

function Home() {
  return (
    <View>
      <Text>Welcome!</Text>
      <Link to="/profile">Visit your profile</Link>
    </View>
  );
}
```

## 2. \<NavLink>

ç±»å‹å®šä¹‰ï¼š
```ts
declare function NavLink(
  props: NavLinkProps
): React.ReactElement;

interface NavLinkProps
  extends Omit<
    LinkProps,
    "className" | "style" | "children"
  > {
  caseSensitive?: boolean;
  children?:
    | React.ReactNode
    | ((props: { isActive: boolean }) => React.ReactNode);
  className?:
    | string
    | ((props: {
        isActive: boolean;
      }) => string | undefined);
  end?: boolean;
  style?:
    | React.CSSProperties
    | ((props: {
        isActive: boolean;
      }) => React.CSSProperties);
}
```

`<NavLink>`Â æ˜¯ç‰¹æ®Šç±»å‹çš„[`<Link>`](https://reactrouter.com/docs/en/v6/components/link)ï¼ŒÂ å¯ä»¥è®°å½• "active" çŠ¶æ€ã€‚ å¯ç”¨äºé¢åŒ…å±‘æˆ–è€…èœå•çš„é€‰ä¸­ç‚¹äº®ã€‚å¯¹äºç”¨æˆ·å’Œè¯»è€…æ¥è¯´ä¹Ÿæä¾›äº†ä¸Šä¸‹æ–‡çš„å¯¼èˆªè¯´æ˜ã€‚

é»˜è®¤çš„, `<NavLink>`æ¿€æ´»æ—¶ï¼Œä¼šåŠ ä¸Šç±»å`active`ï¼Œv5ä¸­ä¹Ÿæ˜¯è¿™ä¹ˆåšçš„. ä¸åŒçš„æ˜¯ï¼Œæ–°ç‰ˆæœ¬`v6.0.0-beta.3`Â ä¸­å±æ€§ç§»é™¤äº† `activeClassName`Â å’ŒÂ `activeStyle`ï¼Œå–è€Œä»£ä¹‹çš„æ˜¯Â `style`Â æˆ–è€…Â `className`Â å±æ€§ï¼Œç”¨äºè‡ªå®šä¹‰è¡Œå†…æ ·å¼æˆ–è€…è‡ªå®šä¹‰ç±»åï¼Œå½“ç„¶ä¹Ÿå¯ä»¥ç©¿ä¸€ä¸ªå‡½æ•°ä½œä¸ºå±æ€§ç»™Â `<NavLink>`Â ç»„ä»¶æ¥è‡ªå®šä¹‰è¡Œä¸ºã€‚

ä¾‹å­ï¼š

```ts
import * as React from "react";
import { NavLink } from "react-router-dom";

function NavList() {
  // This styling will be applied to a <NavLink> when the
  // route that it links to is currently selected.
  let activeStyle = {
    textDecoration: "underline",
  };

  let activeClassName = "underline";

  return (
    <nav>
      <ul>
        <li>
          <NavLink
            to="messages"
            style={({ isActive }) =>
              isActive ? activeStyle : undefined
            }
          >
            Messages
          </NavLink>
        </li>
        <li>
          <NavLink
            to="tasks"
            className={({ isActive }) =>
              isActive ? activeClassName : undefined
            }
          >
            Tasks
          </NavLink>
        </li>
        <li>
          <NavLink to="tasks">
            {({ isActive }) => (
              <span
                className={
                  isActive ? activeClassName : undefined
                }
              >
                Tasks
              </span>
            )}
          </NavLink>
        </li>
      </ul>
    </nav>
  );
}
```

å¦‚æœä½ å¾ˆç†Ÿæ‚‰ v5 çš„ APIï¼Œå¯ä»¥äºŒæ¬¡å°è£…ä¸€ä¸‹ä½¿ç”¨ï¼š
```ts
import * as React from "react";
import { NavLink as BaseNavLink } from "react-router-dom";

const NavLink = React.forwardRef(
  ({ activeClassName, activeStyle, ...props }, ref) => {
    return (
      <BaseNavLink
        ref={ref}
        {...props}
        className={({ isActive }) =>
          [
            props.className,
            isActive ? activeClassName : null,
          ]
            .filter(Boolean)
            .join(" ")
        }
        style={({ isActive }) => ({
          ...props.style,
          ...(isActive ? activeStyle : null),
        })}
      />
    );
  }
);
```

`end` å±æ€§ç”¨äºæ§åˆ¶ä¸ä¼šçº§è”ç‚¹äº®ã€‚å¦‚æœæƒ³è¦åªåœ¨å®Œå…¨åŒ¹é…è·¯ç”±æ˜¯activeï¼Œè€Œä¸æ˜¯åœ¨è¯¥è·¯ç”±ä¸Šå‡ çº§è·¯å¾„éƒ½è¢«activeï¼Œå¯ä»¥ä½¿ç”¨è¿™ä¸ªå±æ€§ã€‚ä¸‹é¢çš„ä¾‹å­ï¼Œåªä¼šåœ¨è·¯å¾„ä¸º `/` æ—¶åŒ¹é… activeï¼Œå…¶ä»–ä»»ä½•è·¯å¾„éƒ½ä¸ä¼šç‚¹äº®ï¼š

```jsx
<NavLink to="/" end>
  Home
</NavLink>
```

## 3. \<Navigate>

ç±»å‹å®šä¹‰ï¼š

```ts
declare function Navigate(props: NavigateProps): null;

interface NavigateProps {
  to: To;
  replace?: boolean;
  state?: any;
}
```

`<Navigate>`Â è¢«æ¸²æŸ“æ—¶ï¼Œä¼šç«‹å³æ”¹å˜å½“å‰çš„location. å’Œhooks [`useNavigate`](https://reactrouter.com/docs/en/v6/hooks/use-navigate) å¯ä»¥è¾¾åˆ°ä¸€æ ·çš„æ•ˆæœï¼Œä¼ é€’çš„å‚æ•°ä¹Ÿä¸€æ ·ã€‚
> **æç¤º:**
>
> `<Navigate>`å¯ä»¥åœ¨ä¸èƒ½ä½¿ç”¨è·¯ç”± hooks çš„åœ°æ–¹ä»£æ›¿ useNavigate

ä¸‹é¢çš„ä¾‹å­ä¸­ï¼Œä¼šå…ˆæ‹¿åˆ°ç™»å½•çŠ¶æ€çš„userï¼Œè‹¥æ²¡æœ‰userï¼Œæ¸²æŸ“ç™»å½•è¡¨å•ï¼›å¦‚æœæ‹¿åˆ°äº†ç™»å½•ä¿¡æ¯ï¼Œåˆ™é€šè¿‡`<Navigate>`ç›´æ¥è·³è½¬åˆ° dashboard é¡µé¢ï¼š

```jsx
import * as React from "react";
import { Navigate } from "react-router-dom";

class LoginForm extends React.Component {
  state = { user: null, error: null };

  async handleSubmit(event) {
    event.preventDefault();
    try {
      let user = await login(event.target);
      this.setState({ user });
    } catch (error) {
      this.setState({ error });
    }
  }

  render() {
    let { user, error } = this.state;
    return (
      <div>
        {error && <p>{error.message}</p>}
        {user && (
          <Navigate to="/dashboard" replace={true} />
        )}
        <form
          onSubmit={(event) => this.handleSubmit(event)}
        >
          <input type="text" name="username" />
          <input type="password" name="password" />
        </form>
      </div>
    );
  }
}
```


## 4. \<Outlet>

ç±»å‹å®šä¹‰ï¼š

```ts
interface OutletProps {
  context?: unknown;
}
declare function Outlet(
  props: OutletProps
): React.ReactElement | null;
```

`<Outlet>`Â å¯ç”¨äºçˆ¶è·¯ç”±ä¸­ï¼Œç”¨æ¥æ¸²æŸ“å­è·¯ç”±ç»„ä»¶. è¿™éœ€è¦å¼€å‘è€…åˆç†å®‰æ’åµŒå¥— UI çš„å¸ƒå±€. å½“ç›´æ¥è®¿é—®çˆ¶è·¯ç”±æ—¶ï¼Œä¼šè‡ªåŠ¨æ¸²æŸ“çˆ¶è·¯ç”±ä¸­é…ç½®äº† index å±æ€§çš„å­è·¯ç”±æ¥æ›¿ä»£ `Outlet`, å¦‚æœæ²¡æœ‰ index è·¯ç”±ï¼Œè¯¥ä½ç½®ä¸æ¸²æŸ“ã€‚

ä¸‹é¢çš„ä¾‹å­ä¸­ï¼Œè®¿é—® `/` ä¼šæ¸²æŸ“ Dashboard ç»„ä»¶ï¼Œ Outletç•™ç™½ï¼› è®¿é—® `/tasks` åˆ™ä¼šæ¸²æŸ“ Dashboardï¼ŒOutletä½ç½®ä¼šæ¸²æŸ“ DashboardTasksï¼š

```jsx
function Dashboard() {
  return (
    <div>
      <h1>Dashboard</h1>

      <Outlet />
    </div>
  );
}

function App() {
  return (
    <Routes>
      <Route path="/" element={<Dashboard />}>
        <Route
          path="messages"
          element={<DashboardMessages />}
        />
        <Route path="tasks" element={<DashboardTasks />} />
      </Route>
    </Routes>
  );
}
```

å½“ç„¶äº†ï¼Œçˆ¶å­ç»„ä»¶ä»ç„¶å¯ä»¥ä¼ å‚ï¼Œä½¿ç”¨ context å’Œ useOutletContext ç»„åˆæ‹³å³å¯ï¼Œè¯¦æƒ…å¯å‚è€ƒæœ¬ä¸“æ çš„ hook ä¸“é¢˜ã€‚

## 5. \<Routes> ä¸ \<Route>

ç±»å‹å£°æ˜ï¼š

```ts
declare function Routes(
  props: RoutesProps
): React.ReactElement | null;

interface RoutesProps {
  children?: React.ReactNode;
  location?: Partial<Location> | string;
}

declare function Route(
  props: RouteProps
): React.ReactElement | null;

interface RouteProps {
  caseSensitive?: boolean;
  children?: React.ReactNode;
  element?: React.ReactNode | null;
  index?: boolean;
  path?: string;
}
```

`<Routes>`Â å’ŒÂ `<Route>`Â æ˜¯ React Router ä¸­ä¸»è¦çš„é…ç½®ç±»å‹ã€‚å¯ä»¥æŠŠÂ `<Route>`çœ‹åšæ˜¯ä¸€ä¸ª `if`Â åˆ¤æ–­ï¼šå¦‚æœÂ `path`Â åŒ¹é…äº†å½“å‰ URL, åˆ™ä¼šæ¸²æŸ“ä»–çš„Â `element`ï¼ä½¿ç”¨Â `<Route caseSensitive>`å¯ä»¥å¯ç”¨è·¯ç”±å¤§å°å†™åŒ¹é…ã€‚

å½“ location å˜åŒ–æ—¶,Â `<Routes>`Â ä¼šéå†ä¸‹å±Â `children`Â çš„æ‰€æœ‰ `<Route>`Â ä»¥è¯•å›¾å¯»æ‰¾æœ€ä½³åŒ¹é…çš„è·¯ç”±.Â `<Route>`Â æ‰€åœ¨è·¯å¾„è·ŸåµŒå¥— UI çš„è·¯å¾„ä½ç½®æ˜¯ä¸€è‡´çš„ï¼Œæ‰€è§å³æ‰€å¾—çš„æ¸²æŸ“æ–¹å¼ã€‚

ä¾‹å­ï¼š

```jsx
<Routes>
  <Route path="/" element={<Dashboard />}>
    <Route
      path="messages"
      element={<DashboardMessages />}
    />
    <Route path="tasks" element={<DashboardTasks />} />
  </Route>
  <Route path="about" element={<AboutPage />} />
</Routes>
```

> **Note:**
>
> Routes çš„ Javascriptæ›¿ä»£å“è§ [Â `useRoutes`Â ](https://reactrouter.com/docs/en/v6/hooks/use-routes).

`<Route element>`Â ä¼šé»˜è®¤å¾€ä¸‹æ¸²æŸ“ï¼Œå¹¶ä¸”æ‹¼æ¥è·¯å¾„ï¼Œæ‰€ä»¥ä¸æ˜¯æ¯ä¸€ä¸ª Route éƒ½éœ€è¦é…ç½®ä¸€ä¸ª element å±æ€§ã€‚

æ¯”å¦‚è¯´ä¸‹é¢çš„ä¾‹å­ï¼Œ è·¯å¾„ `/users/:id`ä¾ç„¶å¯ä»¥åŒ¹é…åˆ° UserProfile å…ƒç´ ï¼Œè€Œä¸ç”¨æ‹…å¿ƒè·¯å¾„è¢«æˆªæ–­ï¼š

```jsx
<Route path="users">
  <Route path=":id" element={<UserProfile />} />
</Route>
```

<hr />

ã€å®Œã€38:T1d12,> åŸæ–‡è·¯å¾„ï¼šhttps://reactrouter.com/docs/en/v6/routers/browser-router

### BrowserRouter

ç±»å‹å£°æ˜ï¼š
```ts
declare function BrowserRouter(
  props: BrowserRouterProps
): React.ReactElement;

interface BrowserRouterProps {
  basename?: string;
  children?: React.ReactNode;
  window?: Window;
}
```

BrowserRouteræ˜¯React Routeræ¨èä½¿ç”¨çš„æ¥å£ã€‚BrowserRouteråŸºäºæµè§ˆå™¨å†…ç½®ï¼ˆH5 APIï¼‰çš„history stackæ¥å­˜å‚¨å½“å‰æµè§ˆå™¨åœ°å€æ çš„locationä¿¡æ¯ã€‚

`<BrowserRouter window>`é»˜è®¤ä¼šä½¿ç”¨å½“å‰[documentçš„`defaultView`](https://developer.mozilla.org/en-US/docs/Web/API/Document/defaultView)ï¼Œä»–åœ¨ä¸šåŠ¡ä½¿ç”¨ä¸­è¿˜ä¹Ÿå¯ç”¨æ¥åœ¨å¦å¤–ä¸€ä¸ªæµè§ˆå™¨windowç¯å¢ƒä¸‹ï¼ˆæ¯”å¦‚iframeä¸­ï¼‰è¿½æº¯URLçš„å˜åŒ–ã€‚


ä½¿ç”¨èŒƒä¾‹ï¼š
```jsx
import * as React from "react";
import * as ReactDOM from "react-dom";
import { BrowserRouter } from "react-router-dom";

ReactDOM.render(
  <BrowserRouter>
    {/* The rest of your app goes here */}
  </BrowserRouter>,
  root
);
```

### HashRouter

ç±»å‹å£°æ˜ï¼š
```ts
declare function HashRouter(
  props: HashRouterProps
): React.ReactElement;

interface HashRouterProps {
  basename?: string;
  children?: React.ReactNode;
  window?: Window;
}
```

HashRouterç”¨åœ¨åŸºäºæµè§ˆå™¨çš„webé¡¹ç›®ä¸­ï¼Œè€Œä¸”ä¸éœ€è¦é€šè¿‡åç«¯æœåŠ¡æ¥æ§åˆ¶è·¯ç”±è·³è½¬ã€‚ä»–çš„åŸç†æ˜¯åŸºäºæµè§ˆå™¨çš„é”šç‚¹ï¼Œé€šè¿‡è®¾ç½®ä¸åŒçš„é”šç‚¹æ¥è¾¾åˆ°è·³è½¬é¡µé¢çš„æ•ˆæœã€‚


ä¹Ÿå¯ä»¥æœ‰`<HashRouter window>`çš„å†™æ³•ï¼Œä½œç”¨åŒ`<BrowserRouter window>`ã€‚

ä½¿ç”¨èŒƒä¾‹ï¼š
```jsx
import * as React from "react";
import * as ReactDOM from "react-dom";
import { HashRouter } from "react-router-dom";

ReactDOM.render(
  <HashRouter>
    {/* The rest of your app goes here */}
  </HashRouter>,
  root
);
```

> å®˜æ–¹ä¼˜å…ˆæ¨èä½¿ç”¨BrowserRouterï¼Œä»–æ˜¯åŸºäºH5æ ‡å‡†åˆ¶å®šçš„ï¼Œæ›´åŠ è§„èŒƒï¼Œæœ‰åŸç”Ÿçš„APIå¯ä»¥ä½¿ç”¨ï¼›åŒæ—¶ï¼ŒBrowserRouterè¿˜å¯ä»¥å°†å½“å‰è·¯ç”±ä¿¡æ¯å‘é€ç»™serverï¼Œä¾¿äºæ•°æ®åŒæ­¥ï¼›æ­¤å¤–åœ¨ä¸€äº›ç‰¹æ®Šåœºæ™¯ä¸‹ï¼Œä¼šä¸¢å¤±hashä¿¡æ¯ï¼Œä»¥è‡³äºHashRouterä¸èƒ½ä½¿ç”¨ï¼Œæ¯”å¦‚å°†URLä½¿ç”¨å¾®ä¿¡åˆ†äº«ã€‚

### HistoryRouter

ç±»å‹å£°æ˜ï¼š
```jsx
declare function HistoryRouter(
  props: HistoryRouterProps
): React.ReactElement;

interface HistoryRouterProps {
  basename?: string;
  children?: React.ReactNode;
  history: History;
}
```

`<unstable_HistoryRouter>`æä¾›ä¸€ä¸ªå°†historyä½œä¸ºpropçš„å®ä¾‹å¯¹è±¡ã€‚å¯ä»¥ä½¿ç”¨å®ƒåœ¨éReactçš„ä¸Šä¸‹æ–‡ç¯å¢ƒæˆ–å…¨å±€å˜é‡ä¸­ä½¿ç”¨Routerã€‚

èŒƒä¾‹ï¼š

```jsx
import * as React from "react";
import * as ReactDOM from "react-dom";
import { unstable_HistoryRouter as HistoryRouter } from "react-router-dom";
import { createBrowserHistory } from "history";

const history = createBrowserHistory({ window });

ReactDOM.render(
  <HistoryRouter history={history}>
    {/* The rest of your app goes here */}
  </HistoryRouter>,
  root
);
```

> æ­¤APIçš„å‰ç¼€ä¸ºâ€œunstable_â€ï¼Œå› ä¸ºæ‚¨å¯èƒ½ä¼šæ— æ„ä¸­å°†å†å²åº“çš„ä¸¤ä¸ªç‰ˆæœ¬éƒ½æ·»åŠ åˆ°åº”ç”¨ç¨‹åºä¸­ã€‚å¦‚æœæ‚¨ä½¿ç”¨çš„å¼€å‘å·¥å…·å…è®¸ï¼Œå»ºè®®ä¸è¦å°†historyæ·»åŠ ä¸ºç›´æ¥ä¾èµ–é¡¹ï¼Œè€Œæ˜¯ä¾èµ–react-routeråŒ…ä¸­çš„åµŒå¥—ä¾èµ–é¡¹ã€‚ä¸€æ—¦æˆ‘ä»¬æœ‰äº†æ£€æµ‹ä¸åŒ¹é…ç‰ˆæœ¬çš„æœºåˆ¶ï¼Œè¿™ä¸ªAPIå°†åˆ é™¤å…¶â€œunstable_â€çš„å‰ç¼€ã€‚

### MemoryRouter

ç±»å‹å£°æ˜ï¼š
```jsx
declare function MemoryRouter(
  props: MemoryRouterProps
): React.ReactElement;

interface MemoryRouterProps {
  basename?: string;
  children?: React.ReactNode;
  initialEntries?: InitialEntry[];
  initialIndex?: number;
}
```

`<MemoryRouter>`å°†locationä¿¡æ¯å­˜åœ¨ä¸€ä¸ªæ•°ç»„ä¸­. ä¸åŒäºÂ `<BrowserHistory>`Â å’ŒÂ `<HashHistory>`, ä»–ä¸ä½¿ç”¨é¢å¤–çš„èµ„æºï¼ˆæ¯”å¦‚æµè§ˆå™¨history stackï¼‰ã€‚å®ƒé€‚ç”¨äºä½ æƒ³è¦å®Œå…¨æ§åˆ¶history stackçš„åœºæ™¯ã€‚æ¯”å¦‚å•å…ƒæµ‹è¯•ã€‚

ä»–æœ‰ä¸¤ä¸ªå‚æ•°ï¼š
-   `<MemoryRouter initialEntries>`Â é»˜è®¤ä¸ºÂ `["/"]`Â (å•ä¸€å…¥å£â€™/â€˜) ä»–æ˜¯å†å²å †æ ˆä¸­çš„ä½ç½®æ•°ç»„ã€‚è¿™äº›å¯¹è±¡å¯ä»¥æ˜¯åŒ…å«`{pathname, search, hash, state}`çš„å®Œæ•´ä½ç½®å¯¹è±¡ï¼Œä¹Ÿå¯ä»¥æ˜¯ç®€å•çš„å­—ç¬¦ä¸²url
-   `<MemoryRouter initialIndex>`Â é»˜è®¤ä¸ºÂ `initialEntries` çš„æœ€åä¸€ä¸ªç´¢å¼•ï¼Œå¯ä¼ é€’ä»»æ„çš„ç´¢å¼•ä½ç½®

> **Tip:**
> å¤§å¤šæ•°React Routerçš„æµ‹è¯•éƒ½æ˜¯ç”¨äº†`<MemoryRouter>`ä½œä¸ºè·¯ç”±å…¥å£, è¿™é‡Œæœ‰å¾ˆå¤šæµ‹è¯•èŒƒä¾‹ï¼š[browsing through our tests](https://github.com/remix-run/react-router/tree/main/packages/react-router/__tests__).

ä½¿ç”¨èŒƒä¾‹ï¼š
```jsx
import * as React from "react";
import { create } from "react-test-renderer";
import {
  MemoryRouter,
  Routes,
  Route,
} from "react-router-dom";

describe("My app", () => {
  it("renders correctly", () => {
    let renderer = create(
      <MemoryRouter initialEntries={["/users/mjackson"]}>
        <Routes>
          <Route path="users" element={<Users />}>
            <Route path=":id" element={<UserProfile />} />
          </Route>
        </Routes>
      </MemoryRouter>
    );

    expect(renderer.toJSON()).toMatchSnapshot();
  });
});
```

### NaviteRouter

ç±»å‹å£°æ˜ï¼š
```jsx
declare function NativeRouter(
  props: NativeRouterProps
): React.ReactElement;

interface NativeRouterProps extends MemoryRouterProps {}
```

`<NativeRouter>`Â æ˜¯React Routeræ¨èçš„åœ¨[React Native](https://reactnative.dev/)Â Appä¸­ä½¿ç”¨çš„è·¯ç”±ç±»å‹ã€‚

ä»–æœ‰ä¸¤ä¸ªå¯é€‰å‚æ•°ï¼š
-   `<NativeRouter initialEntries>`Â é»˜è®¤ä¸ºÂ `["/"]`
-   `<NativeRouter initialIndex>`Â Â é»˜è®¤ä¸ºÂ `initialEntries` çš„æœ€åä¸€ä¸ªç´¢å¼•

ä½¿ç”¨èŒƒä¾‹ï¼š
```jsx
import * as React from "react";
import { NativeRouter } from "react-router-native";

function App() {
  return (
    <NativeRouter>
      {/* The rest of your app goes here */}
    </NativeRouter>
  );
}
```

### StaticRouter

ç±»å‹å£°æ˜ï¼š
```jsx
declare function StaticRouter(
  props: StaticRouterProps
): React.ReactElement;

interface StaticRouterProps {
  basename?: string;
  children?: React.ReactNode;
  location?: Path | LocationPieces;
}
```

`<StaticRouter>`ç”¨äºåœ¨Â [node](https://nodejs.org/) ä¸­æ¸²æŸ“React Routerã€‚å…¶é€šè¿‡ `location`Â prop æ¥æä¾›è·¯ç”±ä¿¡æ¯ã€‚

æœ‰ä¸€ä¸ªå¯é€‰å‚æ•°ï¼š
-   `<StaticRouter location>`Â é»˜è®¤æ˜¯Â `"/"`

ä½¿ç”¨èŒƒä¾‹ï¼š
```jsx
import * as React from "react";
import * as ReactDOMServer from "react-dom/server";
import { StaticRouter } from "react-router-dom/server";
import http from "http";

function requestHandler(req, res) {
  let html = ReactDOMServer.renderToString(
    <StaticRouter location={req.url}>
      {/* The rest of your app goes here */}
    </StaticRouter>
  );

  res.write(html);
  res.end();
}

http.createServer(requestHandler).listen(3000);
```

### ~~Router ï¼ˆä¸æ¨èï¼‰~~

ç±»å‹å£°æ˜ï¼š
```jsx
declare function Router(
  props: RouterProps
): React.ReactElement | null;

interface RouterProps {
  basename?: string;
  children?: React.ReactNode;
  location: Partial<Location> | string;
  navigationType?: NavigationType;
  navigator: Navigator;
  static?: boolean;
}
```

`<Router>`æ¥å£æ˜¯ä¸Šè¿°å…¶ä»–ç±»å‹Routeræ‰€å…±äº«çš„æ ¸å¿ƒç»„ä»¶ï¼Œä¸ºå…¶ä»–é«˜çº§Routeræä¾›ç†ç”±ä¿¡æ¯ä¸Šä¸‹æ–‡ï¼ˆ[context provider](https://reactjs.org/docs/context.html#contextprovider)ï¼‰ï¼Œä½¿ç”¨ä¼˜å…ˆçº§æœ€ä½ã€‚

å¼€å‘è€…å‡ ä¹ä¸éœ€è¦ç›´æ¥ä½¿ç”¨è¿™ä¸ªAPIï¼Œæ¨èä½¿ç”¨ä¸Šè¾¹æ›´é«˜é˜¶çš„è·¯ç”±ã€‚

ä»–æœ‰ä¸€ä¸ªå‚æ•°ï¼š
- `<Router basename>` ä½¿ç”¨basenameå…±äº«ä¸€ä¸ªæ ¹è·¯ç”±ã€‚åœ¨å¤§å‹é¡¹ç›®æˆ–è€…å¤šå…¥å£å·¥ç¨‹åŒ–æ–‡ä»¶ä¸­ä½¿ç”¨æœ‰å¥‡æ•ˆã€‚

<hr />


That's All. ä¸‹æœŸè®²å†…ç½®ç»„ä»¶çš„ä½¿ç”¨ã€‚39:T6f41,## 1. ä¸»è¦æ¦‚å¿µ

> åŸæ–‡è·¯å¾„ï¼šhttps://reactrouter.com/docs/en/v6/getting-started/concepts

ä½ å¯èƒ½ä¼šå¥½å¥‡ï¼ŒReact Routeræ˜¯æ€ä¹ˆè¿è¡Œèµ·æ¥çš„ï¼Œä»–åˆæ˜¯æ€ä¹ˆè¾…åŠ©æ„å»ºAppçš„ï¼Ÿæ¢å¥è¯è¯´ï¼Œè·¯ç”±routeråˆ°åº•æ˜¯ä»€ä¹ˆï¼Ÿ

å¦‚æœä½ æ›¾ç»æƒ³è¿‡ä¸Šè¿°é—®é¢˜ï¼Œæˆ–è€…ä½ æƒ³è¦æ›´æ·±å…¥çš„äº†è§£è·¯ç”±æœºåˆ¶ï¼Œé‚£ä¹ˆæœ¬ç¯‡æ–‡ç« å¯ä»¥å¸®åŠ©åˆ°ä½ ã€‚æœ¬æ–‡åŒ…å«React Routeræ‰€æœ‰æ ¸å¿ƒæ¦‚å¿µçš„è¯¦ç»†è§£é‡Šã€‚

åŒæ—¶ä¹Ÿè¯·ä¸è¦å› ä¸ºè¿™ç¯‡æ–‡ç« è€Œé’»ç‰›è§’å°–ï¼ŒReact Routerçš„åŸºæœ¬ä½¿ç”¨è¿˜æ˜¯å¾ˆç®€å•çš„ï¼Œä¸šåŠ¡ä½¿ç”¨çš„è¯ï¼Œä¹Ÿä¸éœ€è¦æŒ–æ˜è¿™ä¹ˆæ·±å…¥ã€‚

React Routerå¯ä¸ä»…ä»…æ˜¯ä¸€ä¸ªurlçš„æ˜ å°„å‡½æ•°ï¼Œä»–æ˜¯ä¸€å¥—å…³äºæ„å»ºå®Œæ•´çš„ç”¨æˆ·ç•Œé¢çš„URLæ˜ å°„æœºåˆ¶ï¼Œæ‰€ä»¥ä¼šæœ‰æ›´å¤šçš„æ¦‚å¿µå’Œè§„èŒƒã€‚æˆ‘ä»¬å°†ä¼šåœ¨ä»¥ä¸‹ä¸‰ç‚¹æ¥è®¨è®ºï¼š

1. è®¢é˜…å’Œä½¿ç”¨ [history stack](https://reactrouter.com/docs/en/v6/getting-started/concepts#history-stack)

2. åœ¨è·¯ç”±ä¸­æ˜ å°„[URL](https://reactrouter.com/docs/en/v6/getting-started/concepts#url)

3. é€šè¿‡æ˜ å°„æ¥æ¸²æŸ“å±‚çº§åµŒå¥—UI


### å®šä¹‰ 

é¦–å…ˆå…ˆæŠ›å‡ºä¸€äº›å®šä¹‰ã€‚ä¸åŒäºå‰åç«¯æ¡†æ¶çš„è®¾è®¡æ€è·¯ï¼Œæœ‰æ—¶å€™React Routerä¸­çš„ä¸€ä¸ªè¯ï¼Œåœ¨ä¸åŒçš„ä¸Šä¸‹æ–‡è¯­ä¹‰ä¸­ä¼šæœ‰ä¸åŒçš„æ„æ€ã€‚ä¸‹é¢åˆ—ä¸¾ä¸€äº›å¸¸ç”¨çš„è¯æ±‡ï¼Œåœ¨ä¹‹åä¹Ÿä¼šè¯¦ç»†çš„æè¿°ï¼š

- **URL** - å¾ˆå¤šäººè®¤ä¸ºURLå’Œrouteå¯äº’æ¢ï¼Œç„¶è€ŒReact Routerä¸­å´ä¸æ˜¯è¿™æ ·ã€‚
- **Location** - æ˜¯React Routerç‹¬æœ‰çš„ï¼ŒåŸºäºwindow.locationçš„ä¸€ä¸ªå¯¹è±¡ï¼Œè¡¨ç¤ºå½“å‰ç”¨æˆ·æ‰€åœ¨åœ°ã€‚ä»–é€šå¸¸ç”¨æ¥è¡¨ç¤ºURLï¼Œä½†æ˜¯ä¼šé™„å¸¦é¢å¤–çš„è·¯ç”±ä¿¡æ¯ã€‚
- **Location State** - ä¸€ä¸ªæœªè¢«ç¼–ç çš„URLè·¯ç”±ä½ç½®çŠ¶æ€ã€‚ç±»ä¼¼äºè·¯ç”±hashæˆ–è€…è·¯ç”±parmasï¼Œä¸åŒçš„æ˜¯stateæ˜¯å­˜å‚¨åœ¨æµè§ˆå™¨ç¼“å­˜ä¸­ã€‚
- **History Stack** - å½“ç”¨æˆ·ä½¿ç”¨è·¯ç”±è·³è½¬æ—¶ï¼Œæµè§ˆå™¨ç»´æŠ¤ä¸€ä¸ªè·¯ç”±æ ˆï¼Œå¯¹äºæ ˆä¸­çš„æ¯ä¸€ä¸ªè·¯ç”±è¿›è¡Œè¿½æº¯ã€‚å¦‚æœä½ é•¿æŒ‰æµè§ˆå™¨ä¸­çš„å‘åæŒ‰é’®ï¼Œä½ ä¼šçœ‹åˆ°æµè§ˆå™¨çš„è·¯ç”±è·³è½¬å†å²ã€‚
- **Client Side Routing (CSR)** - æ‰å¹³åŒ–HTMLæ–‡æ¡£è·³è½¬æ—¶ï¼Œæµè§ˆå™¨ä¼šè‡ªåŠ¨ç»´æŠ¤ä¸€ä¸ªhistory stackï¼Œç”¨æˆ·ä¾§çš„è·¯ç”±å¯ä»¥è®©å¼€å‘è€…åœ¨ä¸è®¿é—®åç«¯æœåŠ¡çš„å‰æä¸‹æ“ä½œè·¯ç”±å †æ ˆã€‚
- **History** React Routerå†…ç½®å¯¹è±¡ï¼Œç”¨æˆ·å¯ä»¥ç”¨å®ƒè·å–è·¯ç”±è®¢é˜…ä¿¡æ¯ï¼ŒåŒæ—¶ä¹Ÿæä¾›äº†ä¸€äº›APIæ¥ç„¶ç”¨æˆ·æ“ä½œhistory stackã€‚
- **History Action** - history stackçš„æ“ä½œï¼Œæœ‰Pop. Pushå’ŒReplaceã€‚å¯ä½¿ç”¨Pushæ¥æ–°æ·»åŠ ä¸€ä¸ªè·¯ç”±å…¥å£ï¼Œä½¿ç”¨Replaceä¹Ÿå¯ä»¥è¾¾åˆ°ç±»ä¼¼çš„æ•ˆæœï¼Œåªæ˜¯ä¼šåœ¨å †æ ˆä¸­æ›¿æ¢æ‰å½“å‰çš„è·¯ç”±ï¼Œä½¿ç”¨Popæ¥è·å–ä¸Šä¸€ä¸ªå†å²è·¯ç”±ï¼Œç”¨ä»¥æµè§ˆå™¨è¿”å›ã€‚
- **Segment** - ä»‹äº'/'ä¹‹é—´çš„URLç‰‡æ®µã€‚æ¯”å¦‚ï¼Œâ€™/users/123â€˜å°±æœ‰ä¸¤ä¸ªç‰‡æ®µã€‚
- **Path Pattern** - å¸¦å‚URLã€‚æ¯”å¦‚åŠ¨æ€ç‰‡æ®µ'/users/:userId'å’Œæ˜Ÿå·ç‰‡æ®µ'/docs/\*'ã€‚æ˜¯ä¸€ç§React Routerè·¯ç”±çš„åŒ¹é…æ¨¡å¼ã€‚
- **Dynamic Segment** - åŠ¨æ€ç‰‡æ®µï¼Œè§ä¸Šè¾¹æè¿°ã€‚'users/:userId'å¯ä»¥ç²¾ç¡®åŒ¹é…'users/123'.
- **URL Params** - åŠ¨æ€è·¯ç”±ç‰‡æ®µè§£æå‡ºæ¥çš„è·¯ç”±å‚æ•°ã€‚
- **Router** - æœ‰çŠ¶æ€è·¯ç”±ç»„ä»¶ã€‚å±‚çº§åµŒå¥—ä½¿ç”¨ã€‚
- **Route Config** - è·¯ç”±æ ‘ã€‚é€šè¿‡åŒ¹é…æœºåˆ¶æ¥æ„å»ºè·¯ç”±åˆ†æ”¯ã€‚
- **Route** - è·¯ç”±å…ƒç´ çš„åŸºç¡€ç»„ä»¶ã€‚æœ‰pathå’Œelementä¸¤ä¸ªå‚æ•°ã€‚pathæ˜¯åŒ¹é…æ¨¡å¼ï¼Œå½“pathåŒ¹é…æˆåŠŸåï¼Œelementä¸­çš„å…ƒç´ æ‰ä¼šè¢«æ¸²æŸ“ã€‚
- **Nested Routes** - åµŒå¥—è·¯ç”±ã€‚è·¯ç”±å¯ä»¥æœ‰è‡ªå·±çš„å­©å­ï¼Œæ¯ä¸€ä¸ªè·¯ç”±éƒ½å®šä¹‰äº†URLç‰‡æ®µï¼Œå•ä¸ªURLå¯ä»¥åŒæ—¶åŒ¹é…è·¯ç”±æ ‘ä¸­çš„å¤šä¸ªè·¯ç”±ã€‚è¿™ä½¿å¾—å¯ä»¥ä½¿ç”¨outlet. ç›¸å¯¹è·¯ç”±ç­‰æ¥å¸ƒå±€åµŒå¥—domç»“æ„ã€‚
- **Relative links** - ç›¸å¯¹è·¯ç”±ã€‚ä¸ä½¿ç”¨'/'å¼€å¤´çš„è·¯ç”±ã€‚ä»–ä¼šç»§æ‰¿çˆ¶çº§è·¯ç”±ä½œä¸ºå‰ç¼€æ¥è¿›è¡ŒåŒ¹é…ã€‚è¿™ä½¿å¾—æ·±å±‚æ¬¡çš„URLæ¸²æŸ“å˜å¾—å®¹æ˜“ï¼Œå› ä¸ºä½ ä¸ç”¨å†è€ƒè™‘å¦‚ä½•è·å¾—å®Œæ•´çš„ä¸Šä¸‹æ–‡è·¯ç”±äº†ã€‚
- **Match** - å½“è·¯ç”±ä¸URLåŒ¹é…æ—¶ç”¨äºä¿å­˜ä¿¡æ¯çš„å¯¹è±¡ã€‚æ¯”å¦‚ï¼ŒåŒ¹é…çš„URLå‚æ•°å’Œè·¯å¾„åã€‚
- **Matches** - åŒ¹é…å½“å‰ä½ç½®çš„è·¯ç”±æ•°ç»„ã€‚ç”¨äºåµŒå¥—è·¯ç”±ä¸­ã€‚
- **Parent Route** - çˆ¶è·¯ç”±ã€‚
- **Outlet** - çˆ¶è·¯ç”±ä¸­åŒ¹é…å­è·¯ç”±çš„æ¸²æŸ“æ’æ§½ã€‚
- **Index Route** - outletä¸­é»˜è®¤æ¸²æŸ“çš„ç»„ä»¶ã€‚
- **Layout Route** - æ²¡æœ‰pathçš„çˆ¶è·¯ç”±ã€‚ç”¨äºæŠŠå­è·¯ç”±åˆ†ç»„åˆ°ä¸€ä¸ªå¸ƒå±€å•å…ƒä¸­ã€‚

### Historyå’ŒLocation

åœ¨ä½¿ç”¨React Routerä¹‹å‰ï¼Œéœ€è¦å…ˆè®¢é˜…æµè§ˆå™¨è·¯ç”±å †æ ˆçš„å˜æ›´ã€‚æµè§ˆå™¨ä¼šç‹¬ç«‹ç»´æŠ¤è¯¥å †æ ˆçš„å˜åŒ–ï¼Œæ‰€ä»¥æµè§ˆå™¨è‡ªå¸¦çš„å‰è¿›å’Œåé€€æ‰èƒ½å¤Ÿä½¿ç”¨ã€‚ä¼ ç»Ÿwebå¼€å‘ä¸­ï¼Œç”¨æˆ·æ¯ç‚¹å‡»å‰è¿›æˆ–åé€€. æ¯å‘èµ·ä¸€ä¸ªè·¯ç”±è·³è½¬éƒ½ä¼šå‘åç«¯å‘èµ·è¯·æ±‚ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬æœ‰å¦‚ä¸‹çš„æ“ä½œæµç¨‹ï¼š

1.  ç‚¹å‡»é“¾æ¥è·³è½¬åˆ°Â `/dashboard`
2.  ç‚¹å‡»é“¾æ¥è·³è½¬åˆ°Â `/accounts`
3.  ç‚¹å‡»é“¾æ¥è·³è½¬åˆ°Â `/customers/123`
4.  ç‚¹å‡»åé€€æŒ‰é’®
5.  ç‚¹å‡»é“¾æ¥è·³è½¬åˆ°Â `/dashboard`

é‚£ä¹ˆè·¯ç”±å †æ ˆå°†ä¼šæœ‰å¦‚ä¸‹çš„å˜åŒ–ï¼š
1. \[**`/dashboard`**\]
2.  \[`/dashboard`,Â  **`/accounts`**\]
3.  \[`/dashboard`,Â `/accounts`,Â  **`/customers/123`**\]
4.  \[`/dashboard`,Â  **`/accounts`**,Â `/customers/123`\]
5.  \[`/dashboard`,Â `/accounts`,Â  **`/dashboard`**\]

> è¯‘è€…æ³¨è§£ï¼Œè¿™é‡Œç¬¬å››åˆ°ç¬¬äº”æ­¥ï¼Œ/customers/123è¢«æ›¿æ¢æ‰äº†ï¼Œç±»ä¼¼äºæ“ä½œäº†replaceï¼Œå¯èƒ½æ˜¯æµè§ˆå™¨åˆ¤æ–­ç¬¬4æ­¥æ˜¯backæ“ä½œå›æ¥çš„ï¼Œç¬¬äº”æ­¥ä¸­å¼ºåˆ¶ä½¿ç”¨äº†replaceã€‚

#### History Object

åœ¨ç”¨æˆ·ç«¯è·¯ç”±ä½¿ç”¨çš„è¿‡ç¨‹ä¸­ï¼Œå¼€å‘è€…å¯ä»¥é€šè¿‡ä»£ç æ˜¾å¼çš„æ“ä½œæµè§ˆå™¨è·¯ç”±ã€‚æ¯”å¦‚è¯´ï¼Œå¯ä»¥å¦‚ä¸‹å†™ï¼š

```js
<a
  href="/contact"
  onClick={(event) => {
    // stop the browser from changing the URL and requesting the new document
    event.preventDefault();
    // push an entry into the browser history stack and change the URL
    window.history.pushState({}, undefined, "/contact");
  }}
/>
```
ä¸Šè¿°ä»£ç æ”¹å˜äº†URLï¼Œä½†æ˜¯å¹¶æ²¡æœ‰å¯¹UIè¿›è¡Œä»»ä½•çš„ä¿®æ”¹ã€‚æˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡ä»£ç æ¥æ”¹å˜è·¯ç”±çŠ¶æ€ï¼Œä»è€Œå½±å“UIçš„å˜åŒ–ã€‚ä½†é—®é¢˜æ˜¯ï¼Œæµè§ˆå™¨æ²¡æœ‰æä¾›éå¸¸å¥½çš„ç›‘å¬URLå˜åŒ–çš„æ–¹æ³•ã€‚

æˆ‘ä»¬å¯ä»¥æ¢ç§ç›‘å¬æ–¹å¼ï¼š


```js
window.addEventListener("popstate", () => {
  // URL changed!
});
```

ä¸Šè¿°æ–¹æ³•çœ‹èµ·æ¥ä¸é”™ï¼Œä½†æ˜¯ä»–åªåœ¨ç”¨æˆ·ç‚¹å‡»åé€€æˆ–è€…å‰è¿›æ—¶ç”Ÿæ•ˆã€‚åœ¨ç¨‹åºè°ƒç”¨`window.history.pushState`æˆ–`window.history.replaceState`æ—¶å´æ²¡æœ‰ä»»ä½•ç›‘å¬äº‹ä»¶å¯ä»¥ä½¿ç”¨ã€‚

åœ¨React Routerä¸­ï¼Œhistoryå¯ä»¥å¸®åŠ©ä½ å®ç°ç›‘å¬ã€‚ä»–æä¾›å¯¹push. pop. replaceäº‹ä»¶çš„ç›‘å¬ï¼š

```js
let history = createBrowserHistory();
history.listen(({ location, action }) => {
  // this is called whenever new locations come in
  // the action is POP, PUSH, or REPLACE
});
```
Appä¸éœ€è¦å†é¢å¤–åˆ›å»ºä»–ä»¬è‡ªå·±çš„historyå¯¹è±¡ï¼Œé€šè¿‡ç®€å•çš„ç›‘å¬å‡½æ•°ï¼Œå¯ä»¥å®Œæˆæ­£ç¡®çš„é‡æ–°æ¸²æŸ“ã€‚

#### Location

æµè§ˆå™¨çš„windowè‡ªå¸¦æœ‰locationå¯¹è±¡ï¼Œä»–æä¾›URLçš„ç›¸å…³ä¿¡æ¯ï¼š

```js
window.location.pathname; // /getting-started/concepts/
window.location.hash; // #location
window.location.reload(); // force a refresh w/ the server
```

åœ¨React Routerä¸­çš„ä½¿ç”¨ç±»ä¼¼ï¼Œä½†æ˜¯ä¼šæ›´ç®€å•ï¼Œå…¶ç»“æ„å¦‚ä¸‹ï¼š


```js
{
  pathname: "/bbq/pig-pickins",
  search: "?campaign=instagram",
  hash: "#menu",
  state: null,
  key: "aefz24ie"
}
```
å‰ä¸‰ä¸ªå‚æ•°`{ pathname, search, hash }`ç±»ä¼¼äºwindow.locationï¼Œåä¸¤ä¸ªå‚æ•°æ˜¯React Routerç‹¬æœ‰çš„ã€‚

##### Location Pathname

Location Pathnameæ˜¯URLçš„ä¸€éƒ¨åˆ†ï¼Œæ¯”å¦‚å¯¹äºURLï¼š`https://example.com/teams/hotspurs`, ä»–çš„pathnameå°±æ˜¯`/teams/hotspurs`ã€‚è¿™éƒ¨åˆ†æ‰æ˜¯ç”¨äºè·¯ç”±åŒ¹é…çš„ã€‚

##### Location Search

URLæœ‰å¾ˆå¤šä¸åŒçš„ä½¿ç”¨é€‰é¡¹ï¼š

- location search
- search params
- URL search params
- query string

åœ¨React Routerä¸­ï¼Œæˆ‘ä»¬ä¾¿å¯ä»¥ä½¿ç”¨location searchï¼Œå®ƒæ˜¯ä¸€ç§åºåˆ—åŒ–çš„`URLSearchParams`ï¼Œæ‰€ä»¥æœ‰æ—¶å€™ä¹Ÿå¯ä»¥å«ä»–`URL search params`ï¼š

```js
// given a location like this:
let location = {
  pathname: "/bbq/pig-pickins",
  search: "?campaign=instagram&popular=true",
  hash: "",
  state: null,
  key: "aefz24ie",
};

// we can turn the location.search into URLSearchParams
let params = new URLSearchParams(location.search);
params.get("campaign"); // "instagram"
params.get("popular"); // "true"
params.toString(); // "campaign=instagram&popular=true",
```
è§£æå‰çš„åºåˆ—åŒ–å­—ç¬¦ä¸²å«`search`ï¼Œç²¾å‡†è§£æåä¾¿æ˜¯`search params`äº†ã€‚è¯‘è€…è®¤ä¸ºè¿™é‡Œæè¿°çš„æ„æ€å°±æ˜¯è¯´å¯ä»¥å°†URLå­—ç¬¦ä¸²ç¿»è¯‘ä¸ºä¸€ä¸ªç»“æ„åŒ–çš„å‚æ•°å¯¹è±¡ã€‚å½“ä¸éœ€è¦è€ƒè™‘ç²¾ç¡®åº¦æ—¶ï¼Œè¿™ä¸¤ä¸ªæ¦‚å¿µæ˜¯å¯ä»¥äº’æ¢çš„ã€‚

##### Location Hash

URLä¸­çš„å“ˆå¸Œï¼ˆé”šç‚¹ï¼‰è¡¨ç¤ºå½“å‰é¡µé¢æ»šåŠ¨çš„ä½ç½®ã€‚åœ¨window.history.pushStateè¢«å¼•å…¥ä¹‹å‰ï¼Œwebå¼€å‘è€…åªèƒ½é€šè¿‡æ”¹å˜URLé”šç‚¹æ¥æ§åˆ¶æµè§ˆå™¨è·¯ç”±çš„å˜åŒ–ï¼Œè¿™ä¹Ÿæ˜¯åœ¨ä¸è®¿é—®åç«¯æœåŠ¡çš„å‰æä¸‹æ”¹å˜è·¯ç”±çš„å”¯ä¸€æ–¹å¼ã€‚ç°åœ¨æˆ‘ä»¬ä»ç„¶å¯ä»¥è¿™æ ·ä½¿ç”¨ä»–ã€‚

##### Location State

ä½ å¯èƒ½ä¼šå¥½å¥‡H5çš„API`window.history.pushState()`ä¸ºä»€ä¹ˆä¼šå«åšpush stateï¼Œæˆ‘ä»¬åˆšåˆšæ”¹å˜äº†URLï¼Œç†è®ºä¸Šä¸æ˜¯åº”è¯¥å«åš`history.push`æ›´è´´åˆ‡ï¼Ÿå“ˆï¼Œæˆ‘ä»¬ä¹Ÿä¸æ˜¯æµè§ˆå™¨æ ‡å‡†çš„åˆ¶å®šè€…ï¼Œè¿™äº›é—®é¢˜æˆ‘ä»¬æš‚ä¸”ä¸è€ƒè™‘ï¼Œå°±è¿™ä¸ªAPIæœ¬èº«è€Œè¨€ï¼Œç¡®å®æ˜¯ä¸€ä¸ªä¸é”™çš„æµè§ˆå™¨æ–°ç‰¹æ€§ã€‚ï¼ˆä½œè€…éšæ€§ç¿»è¯‘ï¼Œå¤§æ„åŸºæœ¬æ˜¯è¿™æ ·ï¼‰ã€‚

æµè§ˆå™¨æä¾›çš„è¿™ä¸ªstateï¼Œå¯ä»¥è®©æˆ‘ä»¬è½»æ¾åœ°ä¼ é€’è·¯ç”±çŠ¶æ€ã€‚å½“æˆ‘ä»¬ç‚¹å‡»æµè§ˆå™¨åé€€æŒ‰é’®æ—¶ï¼Œé€šè¿‡`pushState`ä¾¿å¯ä»¥å¼•èµ·`history.state`çš„å˜åŒ–ï¼š

> è¯‘è€…æé†’ï¼šè¿™ç§çŠ¶æ€åœ¨åˆ·æ–°æµè§ˆå™¨åä¼šä¸¢å¤±ï¼Œéœ€è¦æ…ç”¨

```js
window.history.pushState("look ma!", undefined, "/contact");
window.history.state; // "look ma!"
// user clicks back
window.history.state; // undefined
// user clicks forward
window.history.state; // "look ma!"
```

React Routeråˆ©ç”¨äº†æµè§ˆå™¨è‡ªå¸¦çš„åŠŸèƒ½ï¼Œå¯¹å…¶è¿›è¡Œäº†ä¸€äº›æŠ½è±¡å°è£…ï¼Œå¹¶å°†å€¼æ˜¾ç¤ºåœ¨locationä¸­ï¼Œè€Œä¸æ˜¯historyé‡Œã€‚

ä½ å¯ä»¥è¯•ç€ä½¿ç”¨location.stateï¼Œæ¯”å¦‚`location.hash`æˆ–è€…`location.search`ï¼Œè€Œä¸æ˜¯ç›´æ¥å°†è·¯ç”±å‚æ•°æ”¾åœ¨URLé‡Œï¼Œè¿™æ ·ä½ çš„URLä¼šæ¯”è¾ƒæ•´æ´ï¼Œä¼ é€’ä¼šç›¸å¯¹å®‰å…¨ã€‚

ä¸€ç»„æ¯”è¾ƒå¥½çš„ä½¿ç”¨æ¡ˆä¾‹ï¼š

- å‘Šè¯‰ä¸‹ä¸ªé¡µé¢ä½ è·³è½¬è‡ªå“ªé‡Œï¼Œä»¥æ­¤æ¥åŠ¨æ€å¸ƒå±€UIã€‚ç”¨çš„æœ€å¤šçš„ä¾‹å­æ˜¯ç”¨æˆ·ç‚¹å‡»ä¸€ä¸ªitemï¼Œç„¶åæ‰“å¼€ä¸€ä¸ªå¼¹çª—æ˜¾ç¤ºè¯¦ç»†è®°å½•çš„ä½¿ç”¨åœºæ™¯ã€‚å¦‚æœä½ æƒ³ç›´æ¥æ˜¾ç¤ºåˆ°URLçš„è¯ï¼Œï¼ˆè¯‘è€…è®¤ä¸ºæ˜¯è¯¦æƒ…é¡µé¢å¯ä»¥å¼¹çª—æ˜¾ç¤ºåˆå¯ä»¥é¡µé¢æ˜¾ç¤ºçš„æ„æ€ï¼‰ï¼Œé‚£ä¹ˆå°±å¯ä»¥è‡ªå®šä¹‰å¸ƒå±€ç»„ä»¶æ¥æ˜¾ç¤ºã€‚
- ä¼ é€’é¡µé¢è®°å½•ä¿¡æ¯çš„ä¸€éƒ¨åˆ†ç»™è¦è·³è½¬çš„é¡µé¢ï¼Œé‚£ä¹ˆä¸‹ä¸ªé¡µé¢ä¼šç›´æ¥å°†è¿™ä¸€éƒ¨åˆ†æ¸²æŸ“å‡ºæ¥ï¼Œè¿›è€Œå¯ä»¥å€ŸåŠ©å·²æœ‰ä¿¡æ¯æ¸²æŸ“å‰©ä½™éƒ¨åˆ†ã€‚

ä»£ç å®ç°ä¸Šï¼Œå¯ä»¥ä½¿ç”¨`<Link>`æˆ–è€…`navigate`æ¥å®ç°æ”¹å˜stateï¼š

```jsx
<Link to="/pins/123" state={{ fromDashboard: true }} />;

let navigate = useNavigate();
navigate("/users/123", { state: partialUser });
```

åœ¨è·³è½¬åçš„é¡µé¢ä¸­ä½¿ç”¨`useLocation`è·å–è·¯ç”±ä¿¡æ¯ï¼š

```js
let location = useLocation();
location.state;
```

> location.stateæ˜¯ä¸€ä¸ªåºåˆ—åŒ–çš„å€¼ï¼Œä½¿ç”¨new Date()ä¼ é€’æ—¶é—´æ—¶ï¼Œä¼šè¢«è½¬åŒ–ä¸ºå­—ç¬¦ä¸²

##### Location Key

æ¯ä¸€ä¸ªlocationåˆæœ‰è‡ªå·±å”¯ä¸€çš„keyã€‚è¿™å¯¹äºé”šç‚¹æ»šåŠ¨å¼è·¯ç”±è·³è½¬. å®¢æˆ·ç«¯æ•°æ®ç¼“å­˜ç­‰æ˜¯å¾ˆæœ‰å¸®åŠ©çš„ã€‚æ¯ä¸€ä¸ªlocationè·å–å”¯ä¸€keyåï¼Œä½ éƒ½å¯ä»¥ä½¿ç”¨æ‰å¹³åŒ–æ•°ç»„. new Map()ï¼Œç”šè‡³æ˜¯locationStorageæ¥å°†å¯¹åº”ä¿¡æ¯æŠ½è±¡å‡ºæ¥ã€‚

ä¸¾ä¸ªğŸŒ°ï¼Œåœ¨ä¸€ä¸ªå•ä¸€çš„å®¢æˆ·ç«¯ï¼Œä¸è¯·æ±‚åç«¯æ•°æ®ï¼Œåœ¨ç”¨æˆ·ç‚¹å‡»åé€€æŒ‰é’®æ—¶ï¼Œå¯ä»¥é€šè¿‡å¦‚ä¸‹è®¾ç½®æ¥å­˜å‚¨è·¯ç”±ç¼“å­˜ï¼š

```js
let cache = new Map();

function useFakeFetch(URL) {
  let location = useLocation();
  let cacheKey = location.key + URL;
  let cached = cache.get(cacheKey);

  let [data, setData] = useState(() => {
    // initialize from the cache
    return cached || null;
  });

  let [state, setState] = useState(() => {
    // avoid the fetch if cached
    return cached ? "done" : "loading";
  });

  useEffect(() => {
    if (state === "loading") {
      let controller = new AbortController();
      fetch(URL, { signal: controller.signal })
        .then((res) => res.json())
        .then((data) => {
          if (controller.signal.aborted) return;
          // set the cache
          cache.set(cacheKey, data);
          setData(data);
        });
      return () => controller.abort();
    }
  }, [state, cacheKey]);

  useEffect(() => {
    setState("loading");
  }, [URL]);

  return data;
}
```

### Matching

åœ¨é¡µé¢åˆå§‹åŒ–æ¸²æŸ“å’Œhistory stackå˜åŒ–æ—¶ï¼ŒReact Routerä¼šé’ˆå¯¹è·¯ç”±é…ç½®é¡¹æ¥åŒ¹é…å‡ºä¸€å¥—æ¸²æŸ“ç»“æ„ã€‚

#### Defining Routes

è·¯ç”±é…ç½®ç±»ä¼¼ä¸€ä¸ªå±‚çº§æ ‘ï¼Œå°±åƒä¸‹é¢çš„ä¾‹å­ï¼š


```jsx
<Routes>
  <Route path="/" element={<App />}>
    <Route index element={<Home />} />
    <Route path="teams" element={<Teams />}>
      <Route path=":teamId" element={<Team />} />
      <Route path=":teamId/edit" element={<EditTeam />} />
      <Route path="new" element={<NewTeamForm />} />
      <Route index element={<LeagueStandings />} />
    </Route>
  </Route>
  <Route element={<PageLayout />}>
    <Route path="/privacy" element={<Privacy />} />
    <Route path="/tos" element={<Tos />} />
  </Route>
  <Route path="contact-us" element={<Contact />} />
</Routes>
```

`<Routes>`é€’å½’åœ°æ¸²æŸ“åŒ¹é…åˆ°çš„`props.children`ï¼Œæå–ä»–ä»¬çš„propså¹¶ç”Ÿæˆå¦‚ä¸‹çš„ç»“æ„ï¼š


```jsx
let routes = [
  {
    element: <App />,
    path: "/",
    children: [
      {
        index: true,
        element: <Home />,
      },
      {
        path: "teams",
        element: <Teams />,
        children: [
          {
            index: true,
            element: <LeagueStandings />,
          },
          {
            path: ":teamId",
            element: <Team />,
          },
          {
            path: ":teamId/edit",
            element: <EditTeam />,
          },
          {
            path: "new",
            element: <NewTeamForm />,
          },
        ],
      },
    ],
  },
  {
    element: <PageLayout />,
    children: [
      {
        element: <Privacy />,
        path: "/privacy",
      },
      {
        element: <Tos />,
        path: "/tos",
      },
    ],
  },
  {
    element: <Contact />,
    path: "/contact-us",
  },
];
```

äº‹å®ä¸Šï¼Œä½ å¯ä»¥ä¸ä½¿ç”¨`<Routes>`ï¼Œä½¿ç”¨hook `useRoutes(routesGoHere)`ä¾ç„¶å¯ä»¥å®Œæˆä¸Šè¿°ä»»åŠ¡ã€‚å¦‚ä½ æ‰€è§ï¼Œè·¯ç”±å®šä¹‰ä¸­ï¼Œå¯ä»¥å£°æ˜å¤šé‡è·¯ç”±ç‰‡æ®µï¼Œæ¯”å¦‚`:itemId/edit`ï¼Œä¹Ÿå¯ä»¥å£°æ˜å•ä¸ªç‰‡æ®µï¼Œæ¯”å¦‚`:itemId`ã€‚æ‰€æœ‰çš„ç‰‡æ®µä¼šè¢«ç»„åˆåœ¨ä¸€ä¸ªæ¥æ„å»ºæœ€åçš„è·¯å¾„æ¨¡å¼ï¼ˆè·¯ç”±æ ‘ï¼‰ã€‚

#### Match Params

ä»¥`/items/:itemId`è¿™ç§åŠ¨æ€è·¯ç”±ç‰‡æ®µä¸ºä¾‹ï¼Œä»–å¯ä¸æ˜¯é™æ€åŒ¹é…URLçš„ï¼Œä»»ä½•çš„å€¼ä¼¼ä¹éƒ½å¯ä»¥å½“åš`:itemId`æ¥ä½¿ç”¨ï¼Œæ¯”å¦‚`/items/123`å’Œ`/items/å°è‚šè‚šè‚šè‚šè‚šå“¦`ã€‚è§£æå‡ºæ¥çš„å€¼å°±æ˜¯`URL params`ã€‚åœ¨æ¸²æŸ“ä¸€èŠ‚ï¼ˆRenderingï¼‰ä¼šè®²è¿°æ€ä¹ˆç”¨è¿™ä¸ªå‚æ•°ã€‚

#### Ranking Routes

å½“æˆ‘ä»¬è®¾ç½®å®Œè·¯ç”±é…ç½®åï¼Œæˆ‘ä»¬æœ€ç»ˆä¼šå¾—åˆ°è¯¸å¦‚å¦‚ä¸‹çš„åŒ¹é…æ¨¡å¼ï¼š


```js
[
  "/",
  "/teams",
  "/teams/:teamId",
  "/teams/:teamId/edit",
  "/teams/new",
  "/privacy",
  "/tos",
  "/contact-us",
];
```

äº‹æƒ…å˜å¾—çªç„¶èŒƒç‰¹è¥¿èµ·æ¥ï¼Œä»¥è¯·æ±‚path `"/teams/new"`ä¸ºä¾‹ï¼Œä¸Šè¿°åˆ—è¡¨ä¸­å“ªä¸€ä¸ªåŒ¹é…æ¨¡å¼èƒ½å¤Ÿè¢«ç¿»ç‰Œå­ï¼Ÿæˆ‘çŒœæœ‰ä¸¤ä¸ªï¼š


```
/teams/new
/teams/:teamId
```

æ­¤æ—¶ï¼ŒReact Routerå°±éœ€è¦åšå‡ºæœ€ç»ˆå†³å®šï¼Œåˆ°åº•ç¿»å“ªä¸€ä¸ªçš„ç‰Œå­ï¼Œå¤§å¤šæ•°è·¯ç”±éƒ½ä¼šæŒ‰ç…§ä»–ä»¬å®šä¹‰çš„å…ˆåé¡ºåºè¿›è¡ŒåŒ¹é…ï¼Œå…ˆåˆ°å…ˆå¾—ã€‚ä½†æ˜¯ä½¿ç”¨è¿™ç§ç®—æ³•ï¼Œæˆ‘ä»¬è¿`/`éƒ½èƒ½åŒ¹é…åˆ°äº†ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬åº”è¯¥æ›´åŠ å®Œç¾çš„æ’åºè¿™äº›åŒ¹é…æ¨¡å¼ï¼Œè¿›è€Œè¾¾åˆ°æˆ‘ä»¬æƒ³è¦çš„åŒ¹é…ç»“æœã€‚è¿™ä¹Ÿæ˜¯v6æ¯”è¾ƒæ™ºèƒ½çš„ä¸€ä¸ªä½“ç°ã€‚

è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬ç›´è§‚çš„æ„Ÿè§‰`/teams/new`åº”è¯¥æ˜¯æœ€ç»ˆçš„ç»“æœã€‚æˆ‘ä»¬æ‰€åšçš„å°±æ˜¯æ•™ä¼šäº†React Routerå»å®Œæˆè¿™ä¸ªä»»åŠ¡ã€‚åœ¨åŒ¹é…çš„è¿‡ç¨‹ä¸­ï¼ŒReact Routerä¼šæŒ‰ç…§ç‰‡æ®µåºå·è¿›è¡Œæ’åºï¼ˆåŒ…æ‹¬é™æ€çš„. åŠ¨æ€çš„å’Œæ˜Ÿå·ç‰‡æ®µç­‰ï¼‰ï¼ŒæŒ‘é€‰æœ€é€‚åˆçš„åŒ¹é…æ¨¡å¼ï¼Œè€Œå¯¹äºå¼€å‘è€…ï¼Œå†ä¹Ÿä¸ç”¨è€ƒè™‘è·¯ç”±é…ç½®çš„å…ˆåæ”¾ç½®é¡ºåºäº†ã€‚

#### Pathless Routes

è¿˜æœ‰ä¸€äº›ä¸å¸¦pathçš„è·¯ç”±ï¼š

```html
<Route index element={<Home />} />
<Route index element={<LeagueStandings />} />
<Route element={<PageLayout />} />
```

å¯¹äºè¿™ç§æˆ‘ä»¬æ€ä¹ˆåŒ¹é…å‘¢ï¼ŸReact Routerçš„åŒ¹é…æ—¶ç›¸å½“å®½æ¾çš„ï¼Œ`<LeagueStandings />`å’Œ`<Home />`ç»„ä»¶æ˜¯indexè·¯ç”±ï¼Œ`<PageLayout />`æ˜¯å¸ƒå±€è·¯ç”±ï¼Œæˆ‘ä»¬åœ¨æ¸²æŸ“ï¼ˆRenderingï¼‰è¿™ä¸€èŠ‚æ¥è®¨è®ºä»–æ˜¯æ€ä¹ˆå·¥ä½œçš„ï¼Œè¿™ä¸¤è€…éƒ½ä¸åŒ¹é…æœ¬èº«æ²¡æœ‰å¤šå¤§å…³ç³»ã€‚


#### Route Matches

å½“è·¯ç”±å»åŒ¹é…URLæ—¶ï¼Œå†…éƒ¨éƒ½ä¼šè½¬åŒ–ä¸€ä¸ªåŒ¹é…å¯¹è±¡ï¼Œä»¥`<Route path=":teamId" element={<Team/>}/>`ä¸ºä¾‹ï¼š
 
```jsx
{
  pathname: "/teams/firebirds",
  params: {
    teamId: "firebirds"
  },
  route: {
    element: <Team />,
    path: ":teamId"
  }
}
```

pathnameæ˜¯URLéƒ¨åˆ†ï¼Œä»£è¡¨çš„æ˜¯å…¨é‡è·¯å¾„ï¼›paramsæ˜¯é€šè¿‡URLè§£ææ¥çš„æš‚æ€è·¯ç”±å‚æ•°ï¼Œ`:teamId`å³ä¸º`params.teamId`ã€‚

å› ä¸ºè·¯ç”±è¡¨æ˜¯ä¸€æ£µæ ‘ï¼Œå•ä¸ªURLå¯èƒ½ä¼šåŒ¹é…ä¹¦ä¸Šçš„å¤šä¸ªåˆ†æ”¯ï¼Œä»¥`/teams/firebirds`ä¸ºä¾‹ï¼š


```diff 
<Routes>
+   <Route path="/" element={<App />}>
    <Route index element={<Home />} />
+   <Route path="teams" element={<Teams />}>
+     <Route path=":teamId" element={<Team />} />
      <Route path=":teamId/edit" element={<EditTeam />} />
      <Route path="new" element={<NewTeamForm />} />
      <Route index element={<LeagueStandings />} />
    </Route>
  </Route>
  <Route element={<PageLayout />}>
    <Route path="/privacy" element={<Privacy />} />
    <Route path="/tos" element={<Tos />} />
  </Route>
  <Route path="contact-us" element={<Contact />} />
</Routes>
```
é«˜äº®éƒ¨åˆ†æ˜¯ä»–çš„åŒ¹é…è·¯å¾„ã€‚React Routerä¼šåˆ›å»ºä¸€ä¸ªåŒ¹é…æ•°ç»„æ¥å­˜æ”¾åµŒå¥—çš„åŒ¹é…è·¯ç”±ï¼Œæ‰€ä»¥ä¼šç”Ÿæˆä¸€ä¸ªåµŒå¥—çš„UIç»“æ„ï¼š

```jsx
[
  {
    pathname: "/",
    params: null,
    route: {
      element: <App />,
      path: "/",
    },
  },
  {
    pathname: "/teams",
    params: null,
    route: {
      element: <Teams />,
      path: "teams",
    },
  },
  {
    pathname: "/teams/firebirds",
    params: {
      teamId: "firebirds",
    },
    route: {
      element: <Team />,
      path: ":teamId",
    },
  },
];
```

### Rendering

æœ€åçš„é‡å¤´æˆï¼Œåœ¨æ‹¿åˆ°åŒ¹é…æ•°åï¼Œè¦å¦‚ä½•è¿›è¡Œæ¸²æŸ“å‘¢ï¼Ÿè€ƒè™‘å¦‚ä¸‹çš„ç»“æ„ï¼š


```jsx
// react 18+
const root = ReactDOM.createRoot(
  document.getElementById("root")
);
root.render(
  <BrowserRouter>
    <Routes>
      <Route path="/" element={<App />}>
        <Route index element={<Home />} />
        <Route path="teams" element={<Teams />}>
          <Route path=":teamId" element={<Team />} />
          <Route path=":teamId/edit" element={<EditTeam />} />
          <Route path="new" element={<NewTeamForm />} />
          <Route index element={<LeagueStandings />} />
        </Route>
      </Route>
      <Route element={<PageLayout />}>
        <Route path="/privacy" element={<Privacy />} />
        <Route path="/tos" element={<Tos />} />
      </Route>
      <Route path="contact-us" element={<Contact />} />
    </Routes>
  </BrowserRouter>
);
```

æˆ‘ä»¬ä½¿ç”¨è®¿é—®è·¯å¾„`/teams/firebirds`ä½œä¸ºä¾‹å­æ¥è§£é‡Šå¦‚ä½•æ¸²æŸ“è·¯ç”±ã€‚`<Routes>`ä¼šè¯†åˆ«é…ç½®é¡¹ï¼Œé€šè¿‡ç²¾å‡†åŒ¹é…ååœ¨é¡µé¢ä¸Šæ„å»ºå¦‚ä¸‹ç»“æ„ï¼š

```jsx
<App>
  <Teams>
    <Team />
  </Teams>
</App>
```

æ¯ä¸€çº§åŒ¹é…é¡¹éƒ½æ”¾ç½®åœ¨å…¶çˆ¶è·¯ç”±å…ƒç´ ä¸­ï¼Œæœ€ç»ˆæ¸²æŸ“çš„ç»“æ„ä¸è·¯ç”±é…ç½®æ–‡ä»¶å®Œå…¨ä¸€æ ·ã€‚å¤§å¤šæ•°çš„ç½‘ç«™å’Œappéƒ½æœ‰è¿™æ ·çš„ç‰¹æ€§ï¼šå¥—å¨ƒå¼æ”¾ç½®å…ƒç´ ï¼Œæ¯ä¸€çº§å…ƒç´ éƒ½ä¼šæœ‰è‡ªå·±çš„å¯¼èˆªæ¥æ›´æ”¹è‡ªå·±çš„å­é¡µé¢å†…å®¹ã€‚

#### Outlets

åµŒå¥—å…ƒç´ æ ‘ä¸ä¼šè‡ªåŠ¨æ¸²æŸ“ï¼Œéœ€è¦ç”¨outletæ¥å‘Šè¯‰çˆ¶å…ƒç´ æ¸²æŸ“å­å…ƒç´ çš„åœ°æ–¹ã€‚`<Routes>`ä¼šé¦–å…ˆæ¸²æŸ“å…ƒç´ æ ‘çš„é¡¶å±‚å…ƒç´ ï¼ˆæ¯”å¦‚`<App />`ï¼‰ï¼Œæ¥ä¸‹æ¥åŒ¹é…å…ƒç´ `<Teams>`ï¼š

```jsx
function App() {
  return (
    <div>
      <GlobalNav />
      <Outlet />
      <GlobalFooter />
    </div>
  );
}
```

Outletç»„ä»¶ä¼šæ¸²æŸ“ä¸‹ä¸€ä¸ªmatchçš„å…ƒç´ ã€‚åŒç†ï¼Œ`<Teams>`ä¸­ä¹Ÿéœ€è¦ä¸€ä¸ªoutletæ¥æ¸²æŸ“`<Team />`ã€‚

å¦‚æœURLæ˜¯`/contact-us`ï¼Œé‚£ä¹ˆå…ƒç´ æ ‘å°±ä¼šæ˜¯å¦‚ä¸‹ç»“æ„ï¼š
```
<Contact />
```
ä»–æ²¡æœ‰åœ¨Appç»„ä»¶ä¹‹ä¸‹ï¼Œæ‰€ä»¥ä¼šå•ç‹¬æŒ‰ç…§è·¯ç”±å±‚çº§ç»“æ„æ¸²æŸ“ã€‚

å¦‚æœURLæ˜¯`/teams/firebirds/edit`ï¼Œå…ƒç´ æ ‘ä¼šå˜æˆï¼š

```jsx
<App>
  <Teams>
    <EditTeam />
  </Teams>
</App>
```

Outletæ˜¯ä¸€ä¸ªå ä½ç¬¦ï¼Œè¢«åŒ¹é…åˆ°åä¼šæ›¿æ¢ä¸ºåŒ¹é…çš„å­å…ƒç´ ï¼Œè€Œçˆ¶çº§å…ƒç´ ä¸ä¼šå˜åŒ–ã€‚


#### Index Routes

å¯¹äºå¦‚ä¸‹çš„è·¯ç”±é…ç½®ï¼š

```jsx
<Route path="teams" element={<Teams />}>
  <Route path=":teamId" element={<Team />} />
  <Route path="new" element={<NewTeamForm />} />
  <Route index element={<LeagueStandings />} />
</Route>
```
å¦‚æœè®¿é—®è·¯å¾„`/teams/firebirds`ï¼Œé‚£ä¹ˆå…ƒç´ æ ‘å°±ä¼šæ˜¯å¦‚ä¸‹ç»“æ„ï¼š

```jsx
<App>
  <Teams>
    <Team />
  </Teams>
</App>
```
ä½†æ˜¯ï¼Œå¦‚æœè®¿é—®è·¯å¾„æ˜¯`/teams`ï¼Œé‚£ä¹ˆå…ƒç´ æ ‘å°±ä¼šæ˜¯ï¼š
```jsx
<App>
  <Teams>
    <LeagueStandings />
  </Teams>
</App>
```
è¿™é‡Œçš„ä¼˜å…ˆçº§æ˜¯æ€ä¹ˆå¤„ç†çš„ï¼Ÿä¸ºä»€ä¹ˆå£°æ˜äº†indexå°±èƒ½å¤Ÿä¼˜å…ˆè¢«popå‡ºæ¥ï¼Ÿä»–ç”šè‡³éƒ½æ²¡æœ‰pathï¼å¾ˆæ˜¾ç„¶ï¼Œä¸æ˜¯é€šè¿‡pathçš„åŒ¹é…é€»è¾‘æ¥çš„ã€‚è¿™é‡Œä½¿ç”¨äº†ç‰¹æ®Šçš„index routesï¼ŒåŒæ ·æ˜¯æ¸²æŸ“åœ¨çˆ¶ç»„ä»¶ä¸‹çš„outletçš„ä½ç½®ã€‚è¿™é‡Œå¦‚æœä¸è®¾ç½®indexè·¯ç”±çš„è¯ï¼Œä»…ä»…è®¿é—®`/teams`ï¼Œæ¸²æŸ“çš„å…ƒç´ æ ‘ä¼šæ˜¯ä¸‹é¢è¿™æ ·ï¼š
```jsx
<App>
  <Teams />
</App>
```

å¦‚æœteamsè·¯ç”±è¢«æ˜¾ç¤ºåœ¨å·¦ä¾§çš„ç›®å½•æ ‘ä¸‹æ—¶ï¼Œnameé¡µé¢å³ä¾§å°±ä¼šæ˜¯ç©ºç™½é¡µäº†ï¼éœ€è¦é»˜è®¤çš„é¡µé¢ç»„ä»¶æ¥å¡«å……ã€‚æ¢å¥è¯è¯´ï¼Œindexè·¯ç”±å°±æ˜¯åœ¨æ‰€æœ‰childæ²¡æœ‰åŒ¹é…çš„æ—¶å€™ç»™å‡ºçš„é»˜è®¤æ¸²æŸ“æ–¹æ¡ˆã€‚


æ ¹æ®ä¸šåŠ¡éœ€æ±‚çš„ä¸åŒï¼Œå¯èƒ½ä¼šéœ€è¦ä¸åŒçš„è·¯ç”±ç»“æ„ã€‚ä¸ç®¡çˆ¶è·¯ç”±ä¸‹çš„å­è·¯ç”±å¦‚ä½•æ’åºï¼Œæ€»æ˜¯æ— æ³•é¿å…ç”¨æˆ·ä¼šç›´æ¥è®¿é—®çˆ¶è·¯ç”±çš„è·¯å¾„ï¼Œå¦‚æœçˆ¶è·¯ç”±ä¸­ç”¨äº†outletçš„è¯å°±ä¼šäº§ç”Ÿç©ºç™½é¡µï¼Œindexå°±æ˜¯ç”¨æ¥å¡«å……ç©ºç™½çš„ï¼ˆ**è¯‘è€…**ï¼šä½œè€…çš„æè¿°æœ‰ä¸€äº›ç¹çï¼Œå…¶å®å°±æ˜¯ä¸€å¥è¯ï¼šé»˜è®¤è·¯ç”±ä½œä¸ºç©ºç™½å¡«å……ç‰©ï¼‰ã€‚

> æˆ‘å‘ç°React Routerçš„å®˜ç½‘è‡ªå·±æœ¬èº«å°±æ²¡æœ‰åšçš„å¾ˆå¥½ï¼ŒIndexæ˜¯ä¸æ˜¯å¿˜äº†

![image.png](/img/posts/2022-6-7/2022-6-7-1.png)

#### Layout Routes

è€ƒè™‘å¦‚ä¸‹é«˜äº®éƒ¨åˆ†çš„è·¯å¾„ï¼š

```diff
<Routes>
+ <Route path="/" element={<App />}>
    <Route index element={<Home />} />
    <Route path="teams" element={<Teams />}>
      <Route path=":teamId" element={<Team />} />
      <Route path=":teamId/edit" element={<EditTeam />} />
      <Route path="new" element={<NewTeamForm />} />
      <Route index element={<LeagueStandings />} />
    </Route>
  </Route>
+ <Route element={<PageLayout />}>
+   <Route path="/privacy" element={<Privacy />} />
    <Route path="/tos" element={<Tos />} />
  </Route>
  <Route path="contact-us" element={<Contact />} />
</Routes>
```

ä»–çš„æ¸²æŸ“å…ƒç´ æ ‘æ˜¯ï¼š
```jsx
<App>
  <PageLayout>
    <Privacy />
  </PageLayout>
</App>
```
å¯ä»¥çœ‹åˆ°ï¼Œä¸¤ä¸ªå¹¶åˆ—çš„`<Route>`ç«Ÿç„¶æ¸²æŸ“å‡ºäº†åŒ…å«å…³ç³»ã€‚è¿™ç§æƒ…å†µçš„å‡ºç°åªæ˜¯ä¸ºäº†ç®€åŒ–åœ¨åŒä¸€ä¸ªå¸ƒå±€ä¸­å¤šé‡å­è·¯ç”±
åµŒå¥—çš„å…³ç³»ã€‚ä¸è¿‡ç¦ç”¨è¿™ç§åˆå¹¶ï¼Œåˆä¸æƒ³æ— é™åˆ¶åµŒå¥—ä¸‹å»çš„è¯ï¼Œå°±å¾—éœ€è¦æ¯”è¾ƒç¹ççš„é…ç½®äº†ï¼Œå¯èƒ½ä¼šå‡ºç°å¤§é‡é‡å¤çš„ç»„ä»¶ï¼š

> ä¸å»ºè®®è¿™æ ·å†™å“¦

```jsx
<Routes>
  <Route path="/" element={<App />}>
    <Route index element={<Home />} />
    <Route path="teams" element={<Teams />}>
      <Route path=":teamId" element={<Team />} />
      <Route path=":teamId/edit" element={<EditTeam />} />
      <Route path="new" element={<NewTeamForm />} />
      <Route index element={<LeagueStandings />} />
    </Route>
  </Route>
  <Route
    path="/privacy"
    element={
      <PageLayout>
        <Privacy />
      </PageLayout>
    }
  />
  <Route
    path="/tos"
    element={
      <PageLayout>
        <Tos />
      </PageLayout>
    }
  />
  <Route path="contact-us" element={<Contact />} />
</Routes>
```
æ‰€ä»¥ï¼Œå«ä»–å¸ƒå±€è·¯ç”±æœ‰ç‚¹é—®é¢˜ï¼Œå› ä¸ºä»–å¹¶ä¸ä¼šå»å‚ä¸åŒ¹é…URLï¼Œä»–åªæ˜¯ä¸ºäº†æ–¹ä¾¿ç”¨æˆ·ä½¿ç”¨è€Œåšçš„ä¸€ç§è·¯ç”±åˆå¹¶è€Œå·²ã€‚

> æ’ä¸€å¥ï¼Œæ— é™åˆ¶åµŒå¥—å¯ä»¥è¿™ä¹ˆå†™ï¼Œä¸è¿‡è·¯å¾„ä¼šé•¿ä¸€äº›ï¼š/layout/privacy


```jsx
<Routes>
  <Route path="/" element={<App />}>
    <Route index element={<Home />} />
    <Route path="teams" element={<Teams />}>
      <Route path=":teamId" element={<Team />} />
      <Route path=":teamId/edit" element={<EditTeam />} />
      <Route path="new" element={<NewTeamForm />} />
      <Route index element={<LeagueStandings />} />
    </Route>
    
    // åµŒå¥—é…ç½®
    <Route path="layout" element={<PageLayout />}>
      <Route path="privacy" element={<Privacy />} />
      <Route path="tos" element={<Tos />} />
    </Route>
  </Route>
</Routes>
```

### Navigating

URLå˜åŒ–çš„è¿™ä¸ªåŠ¨ä½œå«åšå¯¼èˆªï¼ˆnavigationï¼‰ï¼Œåœ¨React Routerä¸­æœ‰ä¸¤ç§æ–¹æ³•ï¼š

- `<Link>`
- `navigate`

#### Link

è·¯ç”±å¯¼èˆªçš„ä¸»è¦æ–¹å¼ã€‚å½“ç”¨æˆ·ç‚¹å‡»æ”¹æ ‡ç­¾æ—¶ä¾¿ä¼šè§¦å‘æ“ä½œã€‚React Routerä¼šé˜»æ­¢æµè§ˆå™¨é»˜è®¤çš„äº‹ä»¶è¡Œä¸ºï¼Œå¹¶ä¸”å‘historyå †æ ˆä¸­pushä¸€ä¸ªæ–°çš„çŠ¶æ€ã€‚ç»§è€Œè§¦å‘locationçš„å˜åŒ–å’Œè·¯ç”±åŒ¹é…å…ƒç´ çš„æ¸²æŸ“ã€‚

ç„¶è€Œï¼Œlinkæœ‰å±€é™æ€§ï¼š

- ä»ç„¶æ˜¯æ¸²æŸ“ä¸€ä¸ªaæ ‡ç­¾ï¼ˆå› æ­¤é”®ç›˜æ“ä½œ. å¯èšç„¦å’ŒSEOå¯ä»¥ä½¿ç”¨ï¼‰
- æ²¡æœ‰é˜»æ­¢æµè§ˆå™¨çš„é»˜è®¤è¡Œä¸ºï¼Œæ¯”å¦‚å³é”®ç‚¹å‡»æˆ–è€…æŒ‰ä½ctrlåæ–°å»ºä¸€ä¸ªtabé¡µç­¾ã€‚

åµŒå¥—è·¯ç”±ä¸ä»…ä»…æ˜¯æ¸²æŸ“å¸ƒå±€ï¼Œä»–ä¹Ÿèƒ½å¤„ç†ç›¸å¯¹è·¯ç”±ã€‚è¿˜æ‹¿ä¹‹å‰çš„ä¾‹å­ï¼š

```jsx
<Route path="teams" element={<Teams />}>
  <Route path=":teamId" element={<Team />} />
</Route>
```

åœ¨`<Teams>`ä¸­å¯ä»¥è¿™æ ·å†™ï¼š
```jsx
<Link to="psg" />
<Link to="new" />
```
ä»–ä»¬çš„è·¯å¾„å…¨ç¨‹æ˜¯`/teams/psg`Â å’ŒÂ `/teams/new`ï¼Œå¯ä»¥çœ‹åˆ°ä»–ä»¬ç»§æ‰¿äº†çˆ¶è·¯ç”±ä½œä¸ºå‰ç¼€ï¼Œå› æ­¤è·¯ç”±ç»„ä»¶ä¸éœ€è¦çœŸçš„çŸ¥é“å‰©ä½™çš„è·¯ç”±ä¿¡æ¯ã€‚å› æ­¤è·¯ç”±é…ç½®ä¼šéå¸¸çµæ´»ï¼Œå¯¹äºè¶Šæ¥è¶Šå¤æ‚çš„appï¼Œéœ€æ±‚å’Œè®¾è®¡éƒ½åœ¨ä¸åœçš„å˜åŒ–æ—¶ï¼Œè¿™ä¼šå¤§å¤§å‡å°‘å¼€å‘è€…çš„ç—›è‹¦ã€‚

#### Navigate Function

å¦ä¸€ç§æ–¹å¼ï¼Œå¿…é¡»åœ¨å‡½æ•°å¼ç»„ä»¶ï¼ˆRFCï¼‰ä¸­ä½¿ç”¨ï¼Œä½¿ç”¨`useNavigate`é’©å­è·å–navigateå‡½æ•°ï¼š
```jsx
let navigate = useNavigate();
useEffect(() => {
  setTimeout(() => {
    navigate("/logout");
  }, 30000);
}, []);
```

åœ¨formçš„æäº¤äº‹ä»¶ä¸­ä¹Ÿå¯ä»¥ä½¿ç”¨ï¼š

```jsx
<form onSubmit={event => {
  event.preventDefault();
  let data = new FormData(event.target)
  let urlEncoded = new URLSearchParams(data)
  navigate("/create", { state: urlEncoded })
}} />
```

ä»–å’Œlinkä¸­çš„toä½¿ç”¨æ–¹å¼æ˜¯ç±»ä¼¼çš„ã€‚ä½ å¯ä»¥ç”¨å®ƒæ›¿ä»£linkæ ‡ç­¾ï¼š

```jsx
<li onClick={() => navigate("/somewhere")} />
```

ä½†æ˜¯ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œé™¤äº†é“¾æ¥å’Œè¡¨å•ä»¥å¤–ï¼Œå¾ˆå°‘æœ‰äº¤äº’ä¼šæ”¹å˜URLï¼ˆ**è¯‘è€…è¯´**ï¼šæ”¾å±ï¼è·³ä¸è·³è½¬è¿˜ä¸æ˜¯è€æ¿ä¸€å¥è¯ï¼Ÿå›¾ç‰‡ï¼Œaudioï¼Œspanç­‰ç­‰ï¼Œåªè¦æ˜¯èƒ½æƒ³åˆ°çš„å…ƒç´ çš†å¯è·³è½¬ğŸ¶ ï¼‰ï¼Œå› ä¸ºä»–ä¼šå¢åŠ å¯è®¿é—®æ€§å’Œç”¨æˆ·äº¤äº’çš„å¤æ‚åº¦ã€‚

### Data Access

è·¯ç”±çš„æ•°æ®æ— éå°±æ˜¯å‚æ•°çš„è·å–ï¼Œå‚æ•°çš„ä¿®æ”¹ï¼Œå¦‚ä¸‹ä½¿ç”¨å³å¯ï¼š
```jsx
let location = useLocation();
let urlParams = useParams();
let [urlSearchParams, setUrlSearchParams] = useSearchParams();
```

### Review

æ€»ç»“ï¼

1. å†™ä¸€ä¸‹ä½ çš„Appï¼š

```jsx
const root = ReactDOM.createRoot(
  document.getElementById("root")
);
root.render(
  <BrowserRouter>
    <Routes>
      <Route path="/" element={<App />}>
        <Route index element={<Home />} />
        <Route path="teams" element={<Teams />}>
          <Route path=":teamId" element={<Team />} />
          <Route path="new" element={<NewTeamForm />} />
          <Route index element={<LeagueStandings />} />
        </Route>
      </Route>
      <Route element={<PageLayout />}>
        <Route path="/privacy" element={<Privacy />} />
        <Route path="/tos" element={<Tos />} />
      </Route>
      <Route path="contact-us" element={<Contact />} />
    </Routes>
  </BrowserRouter>
);
```

2. `<BrowserRouter>`åˆ›å»ºhistoryæ¨¡å¼çš„è·¯ç”±ï¼ˆåŸåœ°åˆ·æ–°é¡µé¢éœ€è¦åç«¯å¤„ç†è·³è½¬ï¼Œæˆ–è€…é…ç½®Nginxæ¥åˆ¤æ–­æ˜¯å¦éœ€è¦è¯·æ±‚åç«¯ï¼‰ï¼ŒpushçŠ¶æ€å€¼ï¼Œå¹¶ä¸”è®¢é˜…URLå˜åŒ–ã€‚

3. `<Routes>`å®¹çº³å­è·¯ç”±ï¼Œå¹¶ä¸”åˆ›å»ºè·¯ç”±é…ç½®å¯¹è±¡ï¼Œé€šè¿‡å½“å‰è·¯å¾„æ¥åŒ¹é…å…·ä½“çš„è·¯ç”±å¹¶åˆ›å»ºåŒ¹é…çš„å…ƒç´ æ ‘ï¼Œæœ€åæ¸²æŸ“æœ€ä¼˜çš„åŒ¹é…ã€‚

4. æ¯ä¸ªçˆ¶è·¯ç”±ä¸­åº”è¯¥æœ‰ä¸€ä¸ª`<Outlet />`

5. outletä¼šæ¸²æŸ“çˆ¶è·¯ç”±ä¸­åŒ¹é…åˆ°çš„ä¸‹ä¸€ä¸ªå­è·¯ç”±å…ƒç´ ã€‚

6. ç”¨æˆ·ç‚¹å‡»Linkè¿›è¡Œè·³è½¬ã€‚

7. ä¹Ÿå¯ä½¿ç”¨navigate()è¿›è¡Œè·³è½¬ã€‚

8. historyä¿®æ”¹URLåä¼šé€šçŸ¥`<BrowserRouter>`ã€‚

9. `<BrowserRouter>`æ”¶åˆ°é€šçŸ¥ï¼Œè§¦å‘åŒ¹é…å’Œæ¸²æŸ“ï¼Œé‡æ–°ä»ç¬¬2æ­¥å¼€å§‹ã€‚

That's all !

<hr />

æ–‡ç« è¾ƒé•¿ï¼Œç¿»è¯‘ä¸æ˜“ï¼Œéƒ½çœ‹åˆ°è¿™é‡Œäº†ï¼Œè¦ä¸ç‚¹ä¸ªèµå†èµ°å‘—ğŸ¶ ~~3a:T24e7,## 1. å‰è¨€

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ç»è¿‡å‰å‡ ç¯‡æ–‡ç« çš„è®²è¿°ï¼Œæˆ‘ä»¬çš„ç»„ä»¶åº“å·²ç»åˆå…·è§„æ¨¡ï¼š[æºç ](https://github.com/heiheihoho1213/dux-ui)ã€‚ç°åœ¨æˆ‘ä»¬è®²è¿°ä¸€ä¸‹å¦‚ä½•å‘å¸ƒåˆ°npmä¸Šï¼Œå¹¶ä¸”é…ç½®ä¸€ä¸‹gitee pages.

æœ¬æ–‡æœ€ç»ˆéƒ¨ç½²ä¸»é¡µæ•ˆæœï¼š[UIåº“ä¸»é¡µ](https://heiheihoho1213.github.io/dux-ui/)ã€‚

## 2. ä½¿ç”¨Webpackæ‰“åŒ…é™æ€æ–‡ä»¶


&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;é¦–å…ˆçœ‹ä¸€ä¸‹æˆ‘ä»¬é¡¹ç›®çš„ç›®å½•ç»“æ„ï¼š

![image.png](/img/posts/2022-5-22/2022-5-22-3.png)

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å¯ä»¥çœ‹åˆ°ï¼Œæœ¬ç»„ä»¶çš„é™æ€æ–‡ä»¶æ¯”è¾ƒå°‘ï¼Œä»…ä»…åœ¨staticä¸­æ”¾ç½®äº†Iconçš„å­—ä½“æ ·å¼æ–‡ä»¶ï¼Œæˆ‘ä»¬æƒ³æŠŠé™æ€æ–‡ä»¶è·Ÿæºç æ–‡ä»¶åˆ†å¼€æ”¾ç½®ï¼Œæ–¹ä¾¿ä»¥åè¿ç§»ï¼ŒåŒæ—¶ä¹Ÿæ–¹ä¾¿æ ·å¼çš„æŒ‰éœ€å¼•å…¥ã€‚æ‰€ä»¥æˆ‘ä»¬å°±å…ˆæ¥æ‰“åŒ…staticã€‚

### webpack.config.js

1. è®¾ç½®å…¥å£


```js
entry: {
    // webpackåªè´Ÿè´£icon/cssæ‰“åŒ…
    icon: path.resolve(__dirname, './static/style/icon.css'),
},
```

2. é…ç½®é™æ€èµ„æºå‡ºå£çš„è·¯å¾„

```js
 output: {
    // ä¸iconç›¸å…³çš„jsæ”¾åœ¨scripts
    filename: 'scripts/[name].[contenthash].min.js',
    // é™æ€èµ„æºï¼ˆå­—ä½“æ ·å¼æ–‡ä»¶ï¼‰æ”¾åœ¨assets
    assetModuleFilename: 'assets/[contenthash][ext]',
    // å‘å¸ƒçš„åŒ…å
    library: 'dux-ui',
    // ä½¿ç”¨umdæ¨¡å¼ï¼Œæé«˜å…¼å®¹æ€§
    libraryTarget: 'umd',
    // æ¯æ¬¡buildæ—¶æ¸…ç©ºoutputç›®å½•
    clean: true,
 },
```

3. é…ç½®æ’ä»¶ - å‹ç¼©css

```js
const cssPlugin = new MiniCssExtractPlugin({
  // cssæ”¾åœ¨stylesæ–‡ä»¶å¤¹ä¸‹
  filename: 'styles/[name].min.css',
});

...
plugins: [cssPlugin],
```

4. é…ç½®loaderå…¼å®¹csså’Œå­—ä½“æ–‡ä»¶ï¼ˆé‡è¦ï¼‰

```js
module: {
    rules: [
      {
        test: /static\/style\/icon\.css$/,
        use: [
          // 1. webpack5ä¸­, ä½¿ç”¨MiniCssExtractPlugin.loaderä»£æ›¿style-loader
          {
            loader: MiniCssExtractPlugin.loader,
          },
          'css-loader',
        ],
      },
      {
        // 2. webpack5 é…ç½® - è¯†åˆ«å­—ä½“æ–‡ä»¶
        test: /.(svg|eot|ttf|woff)$/,
        type: 'asset/resource',
      },
    ],
  },
```

5. é…ç½®æ‰“åŒ…çš„æ–‡ä»¶å¤¹æ ¹è·¯å¾„ä¸ºdistã€‚æ–°å»ºä¸€ä¸ª webpack.dist.config.jsï¼š


```js
const path = require('path');

const config = require('./webpack.config');

config.output.path = path.resolve(__dirname, 'dist');
```

è¿è¡Œè„šæœ¬ï¼š

`NODE_ENV=production npm run build:webpack -- --config webpack.dist.config.js`

æŸ¥çœ‹é¡¹ç›®è·¯å¾„ä¸Šå¤šå‡ºçš„æ–‡ä»¶ï¼š

![image.png](/img/posts/2022-5-22/2022-5-22-4.png)

æ‰“åŒ…æˆåŠŸï¼


## 4. ä½¿ç”¨Babelæ‰“åŒ…æºæ–‡ä»¶

### .babelrc.json


```json
{
  // import/export åŒ¹é…ä¸º scriptÂ , å…¶ä»–åŒ¹é…ä¸ºÂ module
  "sourceType": "unambiguous",
  "presets": [
    [
      // é¢„è®¾ï¼Œä»åå¾€å‰è¯†åˆ«
      "@babel/preset-env",
      {
        "targets": {
          "ie": "11",
          "firefox": "29",
          "chrome": "30",
          "safari": "7"
        },
        "spec": true,
        "loose": true
      }
    ],
    ["@babel/preset-react"],
    // è¯†åˆ«ts
    ["@babel/preset-typescript", { "allowDeclareFields": true }]
  ],
  "plugins": [
    [
      // è‡ªåŠ¨ç§»é™¤è¯­æ³•è½¬æ¢åå†…è”çš„è¾…åŠ©å‡½æ•° 
      "@babel/plugin-transform-runtime",
      {
        "regenerator": false
      }
    ],
    ["@babel/plugin-transform-typescript", { "allowDeclareFields": true }],
    // æ”¯æŒè£…é¥°å™¨è¯­æ³•
    ["@babel/plugin-proposal-decorators", { "legacy": true }],
    // ç¼–è¯‘ç±»å¼ç»„ä»¶ï¼Œä½¿ç”¨ç›´æ¥èµ‹å€¼æ–¹å¼
    ["@babel/plugin-proposal-class-properties", { "loose": true }],
    // è¯†åˆ«ç§æœ‰å˜é‡
    ["@babel/plugin-proposal-private-methods", { "loose": true }],
    "emotion",
    "lodash",
    ["babel-plugin-webpack-alias", { "config": "./webpack.config.js", "noOutputExtension": true }],
    // ä»TypeScriptç”ŸæˆReact interface æˆ– åˆ«å
    ["babel-plugin-typescript-to-proptypes"]
  ]
}

```

### package.json

é…ç½®åŒ…å…¥å£å’Œæ–‡ä»¶ï¼š
```json
"main": "lib/index.js",

...
"files": [
    "README.md",
    "index.d.ts",
    "dist/",
    "lib/"
],
```

è¿è¡Œè„šæœ¬ï¼Œæ‰“åŒ…æ‰€æœ‰srcä¸‹çš„æŒ‡å®šæ–‡ä»¶ï¼š
`babel src/ --extensions '.js,.jsx,.ts,.tsx' -d lib/ --ignore '**/.umi/*','**/__tests__/*'`

æŸ¥çœ‹æ‰“åŒ…ç›®å½•libï¼Œå·²ç»æœ‰äº†ç»“æœï¼š

![image.png](/img/posts/2022-5-22/2022-5-22-5.png)

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å¯ä»¥çœ‹åˆ°indexæ˜¯æœ‰é—®é¢˜çš„ã€‚ä»–è‡ªåŠ¨æŠŠ`src/index.ts`æ‰“åŒ…è¿›å»äº†ï¼Œè¿™ä¸ª`index.ts`æ˜¯`dumi`æ–‡æ¡£è‡ªåŠ¨ç”Ÿæˆçš„å…¥å£ã€‚è€Œå¾€å¾€æ–‡æ¡£å±•ç¤ºçš„ç»„ä»¶ä¸ç»„ä»¶åº“å®é™…æ‹¥æœ‰çš„ç»„ä»¶æ•°é‡æ˜¯ä¸ä¸€è‡´çš„ï¼Œæœ‰ä¸€äº›å¼€å‘ä¸­çš„é¡¹ç›®æ˜¯ä¸å±•ç¤ºåœ¨æ–‡æ¡£ä¸­çš„ï¼›åŒæ—¶ï¼Œå¦‚æœè°ƒæ•´äº†æ–‡æ¡£å±•ç¤ºçš„ç»„ä»¶ï¼Œåˆ™ä¼šé€ æˆæ‰“åŒ…çš„ç»„ä»¶æœ‰ç¼ºå¤±çš„é£é™©ã€‚æ‰€ä»¥è¿˜æ˜¯å†³å®šå•ç‹¬åœ¨ç”Ÿæˆä¸€æ¬¡libä¸‹çš„index.jsã€‚

### build-index.js

å†™ä¸€ä¸ªè„šæœ¬ç”Ÿæˆindex.jsï¼š
```js
const fs = require('fs');
const path = require('path');
const child_process = require('child_process');

let js = '';

// 1. è¯»å–æ‰€æœ‰æƒ³è¦ä»å¯¼å‡ºçš„ç»„ä»¶ï¼ˆè¿™é‡Œé»˜è®¤å…¨éƒ¨ï¼‰
const result = fs
  .readdirSync('./src/components/', {
    withFileTypes: true,
  })
  .filter((dir) => /^[A-Z]+[a-zA-Z]*$/.test(typeof dir === 'string' ? dir : dir.name));

/** 2. è¾“å‡ºjsæ ¼å¼
  * import * as InputAll from './components/Input/';
  *  const Input = Object.assign(InputAll.default, InputAll);
  *  export { Input };
 */
result.forEach((dir) => {
  if (typeof dir !== 'string') dir = dir.name;
  js += `
    import * as ${dir}All from './components/${dir}/';
    const ${dir} = Object.assign(${dir}All.default, ${dir}All);
    export { ${dir} };
    `;
});

// 3. å†™å…¥æ–‡ä»¶
fs.writeFileSync(path.join(__dirname, 'lib/__index.js'), js);

// 4. ä½¿ç”¨babelå†æ¬¡æ‰“ä¸€ä¸‹åŒ…
child_process.execSync('npx babel lib/__index.js --out-file lib/index.js');

```

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æ‰§è¡Œè„šæœ¬ `node build-index`å³å¯ã€‚è¿™æ ·ç”Ÿæˆçš„libæ–‡ä»¶å¤¹ä¸‹ä¼šå¤šä¸€ä¸ª`__index.js`æ–‡ä»¶ï¼Œä½†æ˜¯æ— ä¼¤å¤§é›…ï¼Œå¦‚æœè§‰å¾—ä¸å¤Ÿæ¸…çˆ½ï¼Œå¯ä»¥åŠ å…¥ä»¥ä¸‹åˆ é™¤ä»£ç ï¼š

```js
fs.unlink('lib/__index.js', () => {});
```

å¦‚æ­¤ï¼Œå†æ¬¡æ‰§è¡Œè„šæœ¬ï¼š

```js
babel src/ --extensions '.js,.jsx,.ts,.tsx' -d lib/ --ignore '**/.umi/*','**/__tests__/*' && node build-index.js
```
libæ–‡ä»¶ç”Ÿæˆå®Œæ¯•~


## 5. npmå‘å¸ƒ

1. [NPM](https://www.npmjs.com/)çš„ä½¿ç”¨ï¼Œéœ€è¦å…ˆæ³¨å†Œè´¦å·ï¼Œç„¶ååœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹æ‰§è¡Œ`npm login`:

![image.png](/img/posts/2022-5-22/2022-5-22-6.png)

æŒ‰ç…§å›¾ç¤ºè¾“å…¥é¡ºåºç™»å½•ï¼Œå°±ä¼šçœ‹åˆ°Logged inå­—æ ·ï¼Œè¯´æ˜ç™»å…¥æˆåŠŸï¼

2. ç”Ÿæˆå˜æ›´è®°å½•

- é¡¹ç›®ä¸­å®‰è£…standard-version / cz-conventional-changelogï¼š
`yarn add --dev standard-version cz-conventional-changelog`

- é…ç½®package.jsonä¸­çš„è„šæœ¬ï¼š`"commit": "cz"`


- commitä½ çš„æ‰€æœ‰æäº¤ã€‚

- ç„¶åæ‰“ç‰ˆæœ¬ï¼ˆæœ‰patch/minor/majorä¸‰ç§ç‰ˆæœ¬ç±»å‹ï¼‰ï¼š
`standard-version --release-as patch`

- æœ€åå‘å¸ƒ
`npm publish`

çœ‹åˆ°æœ€æ–°çš„ç‰ˆæœ¬å·ç”Ÿæˆå°±è¡¨ç¤ºå‘å¸ƒæˆåŠŸäº†ï¼š

![image.png](/img/posts/2022-5-22/2022-5-22-7.png)

æœ€åæ£€æŸ¥npmä¸ªäººä»“åº“ä¸»é¡µæ˜¯å¦æœ‰æ–°çš„ç‰ˆæœ¬ç”Ÿæˆï¼š

![image.png](/img/posts/2022-5-22/2022-5-22-8.png)

## 6. viteé¡¹ç›®ä½¿ç”¨
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æˆ‘ä»¬å¯ä»¥åœ¨viteé¡¹ç›®ä¸­æµ‹è¯•ä¸€ä¸‹æˆ‘ä»¬å‘å¸ƒçš„åŒ…èƒ½å¦ä½¿ç”¨ã€‚ä½¿ç”¨å¦‚ä¸‹é…ç½®çš„ä¾èµ–ç¯å¢ƒï¼š

```json
  "scripts": {
    "start": "vite",
    "build": "vite build",
    "preview": "vite preview"
  },
  "dependencies": {
    "dux-ui": "^1.3.4",
    "react": "^18.0.0",
    "react-dom": "^18.0.0"
  },
  "devDependencies": {
    "@types/react": "^18.0.0",
    "@types/react-dom": "^18.0.0",
    "@vitejs/plugin-react": "^1.3.0",
    "vite": "^2.9.9"
  }
```

æ‰§è¡Œ`yarn`å®‰è£…ä¾èµ–ã€‚

åœ¨`vite.config.js`ä¸­é…ç½®å¼•ç”¨è·¯å¾„ï¼š


```js
import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'

export default defineConfig({
  plugins: [react()],
  alias: [
    { find: 'dux-ui/dist/styles/icon.min.css', replacement: '/node_modules/dux-ui/dist/styles/icon.min.css' },
    { find: 'dux-ui', replacement: '/node_modules/dux-ui/lib/index.js' },
  ],
})
```

åœ¨App.jsxä¸­æµ‹è¯•ç»„ä»¶ï¼š

```jsx
...
<>
    <Icon type="loading" spin></Icon>
    {StyleTypes.map((type) => (
        <Button styleType={type} key={type} onClick={() => console.log('clicked')}>
          Button
        </Button>
    ))}
</>
```
å¯åŠ¨é¡¹ç›®åå¯ä»¥çœ‹åˆ°æ•ˆæœï¼š

![image.png](/img/posts/2022-5-22/2022-5-22-9.png)

## 7. Dumié¡¹ç›®Gitee Pagesé…ç½®

- é¦–å…ˆå®‰è£…ä¾èµ–ï¼š`yarn add --dev gh-pages`

- æ‰§è¡Œè„šæœ¬`dumi build`

- ç„¶åè¾“å‡ºåˆ°æƒ³è¦å¯¼å‡ºçš„æ–‡ä»¶å¤¹ï¼ˆä»¥docs-distä¸ºä¾‹ï¼‰ï¼š`gh-pages -d docs-dist`

è¿è¡ŒæˆåŠŸåï¼Œä¼šçœ‹åˆ°gitä»“åº“å¤šä¸€ä¸ªåˆ†æ”¯ï¼š

![image.png](/img/posts/2022-5-22/2022-5-22-10.png)

- åœ¨giteeä»“åº“é¡µé¢ï¼Œé€‰æ‹©å¯¹åº”çš„æœåŠ¡ï¼š

![image.png](/img/posts/2022-5-22/2022-5-22-11.png)

- é€‰æ‹©å¯¹åº”çš„åˆ†æ”¯ï¼Œå¹¶ä¸”éƒ¨ç½²å³å¯ï¼š

![image.png](/img/posts/2022-5-22/2022-5-22-12.png)

æ‰“å¼€ç”Ÿæˆçš„é“¾æ¥å³å¯çœ‹åˆ°éƒ¨ç½²çš„ä¸»é¡µã€‚å¦‚æœæ‰“å¼€åæç¤ºé™æ€èµ„æº404ï¼Œåˆ™éœ€è¦è¿›è¡Œå¦‚ä¸‹é…ç½®ï¼š

`.umirc.ts`

```js
  base: '/dux-ui-react/',
  publicPath: '/dux-ui-react/',
```
å†æ¬¡ä»ç¬¬äºŒæ­¥å¼€å§‹æ‰§è¡Œå³å¯ï¼


&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;è‡³æ­¤ï¼ŒåŸºäºReactçš„UIåº“çš„æ­å»º. éƒ¨ç½². åŸºç¡€ç»„ä»¶çš„å°è£…å·²ç»ç»“æŸã€‚åç»­æˆ‘ä¼šé€æ­¥å®Œå–„ç»„ä»¶åº“ï¼Œæ·»åŠ æ›´å¤šå¸¸ç”¨çš„ç»„ä»¶ï¼Œæ•¬è¯·æœŸå¾…~~3b:T31d5,## 1. å‰è¨€

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ç”±äºç–«æƒ…åŸå› ï¼Œè¢«å°é—­åœ¨å®¶ä¸­æ¯”è¾ƒçƒ¦èºï¼Œæ‹–äº†å¥½ä¹…æ‰å¼€å§‹ç»­å†™UIç¯‡çš„æ–‡ç« ï¼ŒæŠ±æ­‰ã€‚æœ¬ç¯‡æ˜¯Reactç»„ä»¶åº“çš„ç¬¬5ç¯‡æ–‡ç« ï¼Œæˆ‘ä»¬æ¥å®ç°ä¸€ä¸‹Formè¡¨å•çš„åŠŸèƒ½ã€‚æœ¬æ–‡çš„ä»£ç å±•ç¤ºçš„æ˜¯ä¸»è¦çš„æ ¸å¿ƒä»£ç ï¼Œå…¨éƒ¨ä»£ç è§ä»“åº“ï¼š[Giteeä»“åº“](https://gitee.com/dh1992/dux-ui-react/)ã€‚å¦ï¼Œæˆ‘å·²éƒ¨ç½²äº†æœ¬ç»„ä»¶åº“çš„æ–‡æ¡£åœ°å€ï¼Œè¿˜è¯·æ‰¹è¯„æŒ‡æ­£ï¼šhttps://dh1992.gitee.io/dux-ui-react


## 2. Input
   &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Inputä½œä¸ºæœ€åŸºæœ¬çš„HTMLè¡¨å•ç»„ä»¶ï¼Œè‚¯å®šæ˜¯ç»„ä»¶åº“ä¸­å¿…ä¸å¯å°‘çš„ä¸€ä¸ªç»„ä»¶ï¼ŒåŒæ—¶ä¹Ÿæ˜¯å®ç°èµ·æ¥ç›¸å¯¹ç®€å•çš„ï¼ŒH5æœ¬èº«å°±è‡ªå¸¦äº†`input`æ ‡ç­¾ï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨å…¶åŸºç¡€ä¸Šè‡ªå®šä¹‰è‡ªå·±çš„æ ·å¼ï¼Œå¹¶ä¸”å®ç°ä¸€äº›äº‹ä»¶ç›‘å¬å³å¯ã€‚
   
   &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æˆ‘ä»¬å…ˆç¡®å®šInputè¦æ¥å—çš„propsæœ‰å“ªäº›ã€‚é¦–å…ˆè¾“å…¥æ¡†è‚¯å®šè¦æœ‰å€¼ï¼Œè¿˜è¦èƒ½ç¦ç”¨å’Œæ¸…é™¤ï¼ŒåŒæ—¶å˜åŒ–è¿˜è¦æœ‰æ£€æµ‹äº‹ä»¶ï¼Œä¸»è¦çš„å‚æ•°æˆ‘ç½—åˆ—ä¸€ä¸‹ï¼š
   
| å±æ€§ | æè¿° |
| --- | --- |
| value | å—æ§å€¼ |
| prefix | å‰ç¼€ |
| suffix | åç¼€ |
| clearable | æ˜¯å¦å¯æ¸…ç©º |
| size | å°ºå¯¸ |
| disabled | æ˜¯å¦ç¦ç”¨ |
| onClear | æ¸…é™¤äº‹ä»¶ |
| onFocus | èšç„¦äº‹ä»¶ |
| onBlur | å¤±ç„¦äº‹ä»¶ |
| onChange | å˜åŒ–äº‹ä»¶ |


   æˆ‘ä»¬åœ¨`components`æ–‡ä»¶å¤¹ä¸‹ï¼Œæ–°å»º`Input`æ–‡ä»¶å¤¹ï¼Œå¹¶åœ¨å…¶ä¸‹æ–°å»º`index.tsx`æ–‡ä»¶ï¼š
   
   
```tsx
...
const Input = ({size, focused, disabled, customStyle, clearable, value}) => {
      
      return <SWrap
        {...{ size, focused, disabled, customStyle }}
        empty={!value}
      >
        <span className={inputWrapCls}>
          {renderPrefix}
          <input
            {...rest}
            value={value}
            onChange={onChange}
            ref={inputRef}
            onFocus={handleFocus}
            onBlur={handleBlur}
            disabled={disabled}
          />
          {renderClear}
          {renderSuffix}
        </span>
      </SWrap>
    );
}
```

 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æˆ‘ç”¨ä¸€ä¸ª`SWrap`ç»„ä»¶åŒ…è£¹äº†åŸç”Ÿçš„inpuæ ‡ç­¾ï¼Œæ¥å—ç”¨æˆ·ä¼ å…¥çš„propså±æ€§ã€‚çœ‹ä¸€ä¸‹SWrapæ˜¯æ€ä¹ˆå®ç°çš„ï¼Œä»ç„¶æ˜¯è¿”å›ä¸€ä¸ªstyleWrapå‡½æ•°ï¼Œå…·ä½“çš„csså®ç°å¯ä»¥çœ‹æˆ‘çš„æºç ï¼Œè¿™é‡Œä¸å¤šèµ˜è¿°ï¼š
 
```tsx
import styled from '@emotion/styled';
import { css } from '@emotion/core';

...
export const SWrap = styleWrap({})(
  styled.span((props) => {
    const {
      theme: { designTokens: DT },
      disabled,
      size,
      focused,
      clearable,
      customStyle,
    } = props;

    return css`
        /** csså®ç° */
        ...
    `
  })
);
```

æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹æ¯ä¸€ä¸ªå±æ€§éƒ½æ˜¯æ€ä¹ˆå®ç°å…¶ä»·å€¼çš„ï¼š

### 2.1 value/disabled/onChange
é€šè¿‡propså±æ€§ä¼ å…¥ä»¥åç›´æ¥èµ‹å€¼ç»™inputæ ‡ç­¾ï¼š`value={value}`

### 2.2 prefix/suffix
å‰åç¼€æˆ‘ä»¬é€šè¿‡`renderPrefix/renderSuffix`ç»„ä»¶å®ç°ï¼Œåˆ†åˆ«æ”¾åœ¨inputçš„å‰åï¼š


```tsx
// å¦‚æœç”¨æˆ·ä¼ å…¥äº†prefixï¼Œå°±è¿”å›ä¸€ä¸ªspanï¼ŒåŠ ä¸Šclassnameï¼Œå¹¶ç»™ä¸€ä¸ªonMouseDownçš„äº‹ä»¶ï¼Œå¦‚æœä¸éœ€è¦è¿™é‡Œä¹Ÿå¯ä»¥ä¸è¦äº‹ä»¶ã€‚åç¼€ä¹ŸåŒå‰ç¼€ä¸€æ ·ã€‚
const renderPrefix = useMemo(() => {
  return (
    prefix && (
      <span className={inputPrefixCls} onMouseDown={onMouseDown}>
        {prefix}
      </span>
    )
  );
}, [onMouseDown, prefix]);
```

### 2.3 clearable
clearableæ˜¯ç»„ä»¶è‡ªå®šä¹‰çš„å±æ€§ï¼ŒåŸç”Ÿinputæ²¡æœ‰è‡ªå¸¦çš„æ¸…é™¤æ“ä½œã€‚æˆ‘ä»¬é€šè¿‡åç¼€ç»„ä»¶å‰è¾¹çš„`renderClear`ç»„ä»¶å®ç°:


```tsx
// å…¶å®ä¸å‰åç¼€å®ç°æ–¹å¼ä¸€æ ·ï¼Œä¸åŒçš„æ˜¯contentæ˜¯å›ºå®šçš„ä¸€ä¸ªIconï¼Œå¹¶å¼ºåˆ¶èµ‹äºˆhandleClearäº‹ä»¶
const renderClear = useMemo(() => {
  if (clearable) {
    return (
      <span className={clearCls} onClick={handleClear} onMouseDown={onMouseDown}>
        <Icon type="remove_sign" />
      </span>
    );
  }
}, [clearable, handleClear, onMouseDown]);

// æ¸…é™¤valueäº‹ä»¶
const handleClear = useCallback(
  (e) => {
    if (disabled) return;
    onClear();
    const input = inputRef.current;
    if (!input) return;
    e.target = input;
    e.currentTarget = input;
    const cacheV = input.value;
    input.value = '';
    onChange(e);
    input.value = cacheV;
  },
  [disabled, onChange, onClear],
);
```
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æˆ‘ä»¬è®¾å®šçš„æ¸…é™¤äº‹ä»¶æ‰§è¡Œé¡ºåºæ˜¯å…ˆæ‰§è¡Œç”¨æˆ·ä¼ å…¥çš„`onClear`ï¼Œä¹‹åç¼“å­˜valueï¼Œç„¶åæ‹¿åˆ°Inputæ ‡ç­¾çš„refï¼Œè®¾ç½®å…¶valueæ˜¯ç©ºå­—ç¬¦ä¸²ï¼Œå¹¶å°†å½“å‰ç‚¹å‡»äº‹ä»¶çš„targetç»™Inputï¼Œè°ƒç”¨`onChange`è¿”ç»™ç”¨æˆ·ã€‚**æ³¨æ„æœ€åä¸€è¡Œ**ï¼Œè¦é‡æ–°æŠŠinputçš„valueèµ‹å€¼å›ç¼“å­˜çš„åŸå€¼ï¼Œå› ä¸ºè¿™é‡Œå¹¶æ²¡æœ‰ä»»ä½•setStateçš„æ“ä½œï¼Œä¸åº”è¯¥æ”¹å˜åŸæ¥çš„å€¼ã€‚ç”¨ä¸€ä¸ªonChangeäº‹ä»¶é—´éš”ä¸€ä¸‹ï¼Œvalueå€¼åœ¨ä¸€ä¸ªæ¸²æŸ“å‘¨æœŸå†…ä¸ä¼šæ¸²æŸ“ä¸¤æ¬¡ï¼Œæ‰€ä»¥å°±é€ æˆäº†è¢«æ¸…ç©ºçš„å‡è±¡ã€‚è‡³äºæ¸…ç©ºæ•°æ®çš„çœŸå®æ“ä½œï¼Œåº”è¯¥æ”¾åœ¨onChangeä¸­ã€‚
 
  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;è‡³æ­¤ï¼ŒInputç»„ä»¶çš„åŠŸèƒ½å®ç°å·²ç»ä»‹ç»å®Œæ¯•ã€‚ä»¥æ­¤ç±»æ¨ï¼Œæ•°å­—è¾“å…¥æ¡†`NumberInput`ï¼Œåªéœ€è¦åœ¨å·¦å³ä¸¤ä¾§ä¸ªåŠ ä¸€ä¸ªButtonæ¥æ§åˆ¶å¢å‡ï¼Œåœ¨`onBlur`äº‹ä»¶ä¸­éœ€è¦é€šè¿‡æ­£åˆ™æ ¡éªŒæ˜¯å¦ä¸ºåˆæ³•çš„æ•°å­—å³å¯ï¼›æ–‡æœ¬åŸŸ`Textarea`å®Œå…¨å¯ä»¥å‚ç…§Inputï¼Œå°†åŸç”Ÿæ ‡ç­¾æ¢æˆtextareaå³å¯ã€‚
  
## 3. Radio
  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;H5çš„inputæ ‡ç­¾è™½ç„¶æœ‰radioå±æ€§ï¼Œä½†æ˜¯ä¸€èˆ¬ç»„ä»¶åº“å°±ä¸å¤ªä¼šç›´æ¥ä½¿ç”¨äº†ï¼Œä¸€æ–¹é¢æ˜¯åŸç”Ÿçš„æ–¹æ³•å¾€å¾€ä¸èƒ½æ»¡è¶³ç»„ä»¶åº“çš„éœ€æ±‚ï¼Œå¦ä¸€æ–¹é¢ï¼Œä¸æƒ³åŸå§‹çš„Inputè¾“å…¥æ¡†ï¼ŒåŸç”Ÿæ ‡ç­¾ä¸èƒ½åšåˆ°ç»„ä»¶åº“éœ€è¦çš„æ ·å¼å®šåˆ¶å’Œä¸»é¢˜å®šåˆ¶ã€‚æ¯”å¦‚æˆ‘ä»¬è‡ªå®šä¹‰çš„radioç»„ä»¶ï¼Œå¯ä»¥æœ‰åŸç”Ÿæ ·å¼ï¼Œä¹Ÿå¯ä»¥æœ‰cardæ¨¡å¼ï¼Œè€Œä¸”radioå¾€å¾€éƒ½ä¸æ˜¯ä¸€ä¸ªå•ç‹¬å­˜åœ¨ï¼Œè‡³å°‘å¾—æœ‰ä¸¤ä¸ªæ‰èƒ½æ»¡è¶³è¦æ±‚ã€‚æˆ‘ä»¬å…ˆæ¥å®šä¹‰ä¸€ä¸‹`props`ï¼š
  
  | å±æ€§ | æè¿° |
| --- | --- |
| checked        | æ˜¯å¦é€‰ä¸­                                                        | 
| defaultChecked | é»˜è®¤æ˜¯å¦é€‰ä¸­                                                      | 
| disabled       | æ˜¯å¦ç¦ç”¨                                                        | 
| onChange       | ç‚¹é€‰æ—¶çš„å›è°ƒ                                                      | 
| value          | radioçš„å€¼                                                     | 
| styleType      | æ ·å¼é£æ ¼, å¯é€‰ 'default', 'button', 'tag', 'card', 'text', 'list' | 
| size           | å°ºå¯¸ï¼Œå¯é€‰'sm', 'md', 'lg'ï¼ŒstyleType ä¸º card. list æ—¶æ— æ•ˆ             | 
| title          | æ ‡é¢˜ï¼ŒstyleType ä¸º card æ—¶ä½¿ç”¨                                     | 

 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æ¥ä¸‹æ¥åœ¨`src/components`ä¸‹æ–°å»ºæ–‡ä»¶å¤¹`Radio`ï¼Œå¹¶åœ¨å…¶ä¸­æ–°å»º`index.tsx`ï¼š
 
 
```tsx
...
renderRadioList(props: any) {
    /* eslint-disable no-unused-vars */
    const {
      children,
      checked,
      onChange,
      onClick,
      disabled,
      ...rest
    } = props;
    /* eslint-enable no-unused-vars */

    return (
      <RadioListWrap
        checked={checked}
        disabled={disabled}
        {...rest}
        onClick={(...args: any) => this.onClick(props, { ...args })}
      >
        <RadioIcon checked={checked} disabled={disabled} />
        {children != null && <span className={contentCls}>{children}</span>}
      </RadioListWrap>
    );
}
```
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`RadioListWrap`ä»ç„¶æ˜¯ç”¨`styleWrap`åŒ…è£¹çš„åŒ…å«æ ·å¼çš„divï¼Œå†…å®¹ç‰©æˆ‘ä»¬æ”¾ä¸€ä¸ªå›¾æ ‡`RadioIcon`æ¥æ”¶æœ€é‡è¦çš„å±æ€§`checked`ï¼Œåè¾¹ç”¨ä¸€ä¸ªspanåŒ…è£¹ä¼ å…¥çš„childrenï¼Œä½¿ç”¨æ—¶å¯ä»¥è¿™æ ·å†™ï¼š
 
 ```tsx
 <Radio checked>checked</Radio>
 ```
 ç»„ä»¶`RadioIcon`å†…éƒ¨æ”¾ä¸€ä¸ªå®å¿ƒåœ†å½¢çš„Iconï¼Œ`SIconWrap`ä»ç„¶æ˜¯ä¸€ä¸ªdivï¼š
 
 
```tsx
const RadioIcon = (props: { checked?: boolean; disabled?: boolean }) => {
  return (
    <SIconWrap {...props}>
      <Icon className={iconCls} type="whitecircle" />
    </SIconWrap>
  );
};
```

åœ¨`SIconWrap`æ ·å¼å®šä¹‰é‡Œï¼Œé€šè¿‡åˆ¤æ–­æ˜¯å¦checkedæ¥æ§åˆ¶æ ·å¼é«˜äº®ï¼š


```tsx
${checked &&
  css`
    // checkedæ—¶ï¼ŒSIconWrapåŠ ä¸€ä¸ªä¸»é¢˜è‰²çš„è¾¹æ¡†
    &.${iconWrapCls} {
      color: ${DT.T_COLOR_LINE_PRIMARY_DEFAULT};
      border-color: ${DT.T_COLOR_LINE_PRIMARY_DEFAULT};
    }
    // checkedæ—¶ï¼ŒIconå­—ä½“åŠ ä¸Šä¸»é¢˜è‰²
    .${iconCls} {
      visibility: visible;
      opacity: 1;
      fill: ${DT.T_COLOR_TEXT_PRIMARY_DEFAULT};
    }
`}
```

åŸºæœ¬ç»“æ„è®²è§£å®Œäº†ï¼Œæˆ‘ä»¬æ¥çœ‹åŠ ä¸Šæ ·å¼ç¾åŒ–åçš„æ•ˆæœï¼š

![image.png](/img/posts/2022-5-22/2022-5-22-1.png)

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å¯ä»¥çœ‹åˆ°ï¼Œé™¤äº†æ¨¡æ‹ŸåŸç”Ÿæ ·å¼å¤–ï¼Œè¿˜å¯ä»¥æ¨¡æ‹ŸæŒ‰é’®. æ ‡ç­¾å’Œåˆ—è¡¨æ ·å¼ï¼Œå®ç°æ–¹å¼åŒä¸Šï¼Œåªéœ€è¦å°†`RadioWrap`å†…çš„Iconæ›¿æ¢æˆå…¶ä»–çš„ç»„ä»¶å³å¯ã€‚

>  è¡¨å•ç»„ä»¶æ¯”è¾ƒå¤šï¼Œè¿™é‡Œåªæ˜¯è®²è¿°äº†åŸºæœ¬çš„å‡ ä¸ªå®ç°ï¼Œä¸ºå†™è¡¨å•ç»„ä»¶æä¾›ä¸€ä¸ªæ€è·¯ï¼Œæ›´å¤šç»„ä»¶å¯ä»¥å‚è§[ç»„ä»¶åº“ä¸»é¡µ](https://dh1992.gitee.io/dux-ui-react/)


## 4. Form
  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;è®²å®ŒåŸºç¡€è¡¨å•ç»„ä»¶ï¼Œæˆ‘ä»¬å®ç°ä¸€ä¸‹è¡¨å•ç»„ä»¶çš„å¸ƒå±€ï¼Œå°±å«`Form`ã€‚H5åŸç”Ÿçš„ç»„ä»¶æ˜¯æœ‰formçš„ï¼Œæˆ‘ä»¬è¿™é‡Œéœ€è¦ç”¨åˆ°å…¶submitæ–¹æ³•ï¼Œæ‰€ä»¥å°±ä½¿ç”¨åŸç”Ÿçš„formï¼Œå¹¶å¯¹å…¶è¿›è¡Œæ ·å¼å°è£…ã€‚
  
  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;è¡¨å•å®¹å™¨ï¼Œå¿…é¡»æœ‰ä¸€ä¸ªæ ¹ç»„ä»¶Formï¼Œå†…éƒ¨æœ‰è‡³å°‘ä¸€ä¸ªformitemï¼Œæ¯ä¸€ä¸ªformitemå†…åŒ…å«ä¸€ä¸ªåŸºç¡€è¡¨å•è¾“å…¥ç»„ä»¶ï¼Œå®šä¹‰ä¸åŒçš„nameã€‚åœ¨`src/components`ä¸‹æ–°å»º`Form`æ–‡ä»¶å¤¹ï¼Œå¹¶åœ¨å…¶ä¸‹æ–°å»º`Form.tsx`,`Item.tsx`ã€‚å…ˆçœ‹`Form.tsx`ï¼š
  
  
```tsx
const Form = ({ onSubmit, ...rest }: any) => {
  const { preventFormDefaultAction } = useContext(ConfigContext);
  const handleSubmit = React.useCallback(
    (e) => {
      if (e) {
        e.preventDefault();
        e.stopPropagation();
      }
      onSubmit && onSubmit(e);
    },
    [onSubmit],
  );
  return (
      <FormWrap onSubmit={preventFormDefaultAction ? handleSubmit : onSubmit} {...rest} />
  );
};
```
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;è¡¨å•å®¹å™¨ï¼Œå¿…é¡»æœ‰ä¸€ä¸ªæ ¹ç»„ä»¶Formç”¨äºå®¹çº³æ‰€æœ‰çš„è¾“å…¥å…ƒç´ ï¼Œè§¦å‘åŸç”Ÿçš„submitäº‹ä»¶ï¼›å†…éƒ¨childrenæœ‰è‡³å°‘ä¸€ä¸ªformitemï¼Œæ¯ä¸€ä¸ªformitemå†…åŒ…å«ä¸€ä¸ªåŸºç¡€è¡¨å•è¾“å…¥ç»„ä»¶ï¼Œå®šä¹‰ä¸åŒçš„nameï¼Œformitemåº”è¯¥éµå¾ªå·¦å³å¸ƒå±€æ ¼å¼ï¼Œä½¿ç”¨floatæˆ–è€…flexéƒ½å¯ä»¥å®ç°ã€‚æˆ‘ä»¬çœ‹ä¼ å…¥çš„å‚æ•°`onSubmit`ï¼Œåœ¨ç»„ä»¶`FormWrap`çš„å›è°ƒonSubmitä¸­è°ƒç”¨ã€‚æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹`FormWrap`ï¼Œä»–è¿”å›çš„å°±æ˜¯ä¸€ä¸ªåŠ äº†æ ·å¼çš„åŸç”Ÿformæ ‡ç­¾ï¼š
  
  
```tsx
export const FormWrap = styleWrap<{ size: string }>({
  className: prefixCls,
})(
  styled('form')((props) => {

    return css`
      font-size: 12px;

      // ç»™ä¸‹å±çš„æ¯ä¸€ä¸ªitemåŠ æ ·å¼
      .${itemCls} {
        margin-bottom: 16px;
        &:last-child {
          margin-bottom: 0;
        }
      }
    `;
  }),
);

```

  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æˆ‘ä»¬å†æ¥çœ‹å†…å®¹ç‰©`Item.tsx`çš„å®ç°ï¼š
  
  
```tsx
...
return (
    <ItemWrap>
      <LabelWrap {...labelCol}>
        {label}
        {required && <RequiredLabel>*</RequiredLabel>}
        {help && <CommentWrap>{help}</CommentWrap>}
      </LabelWrap>
      <ControllerWrap {...controllerCol}>
        {children}
        <RenderTip tip={tip} status={status} />
      </ControllerWrap>
    </ItemWrap>
);
```
  
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`ItemWrap`ï¼Œ`LabelWrap`ï¼Œ`ControllerWrap`ï¼Œç”¨äºè¡¨å•æ¡ç›®å·¦å³å¸ƒå±€çš„å®ç°ï¼š
  
  ```tsx
// ItemWrap ä½¿ç”¨12æ …æ ¼å¸ƒå±€
export const ItemWrap = styleWrap<{ size: string }>({
  className: prefixCls,
})(
    styled('form')((props) => {

    return css`
      font-size: 12px;
      display: flex;

      // ç»™ä¸‹å±çš„æ¯ä¸€ä¸ªlabelåŠ æ ·å¼ï¼Œæ ·å¼ç±»åä»LabelWrapè·å–
     .${prefixCls} > .${itemLabelCls} {
        flex: ${props.labelCol.span || 6}
      }
      
      // ç»™ä¸‹å±çš„æ¯ä¸€ä¸ªcontrollerå—æ§åŒºåŸŸåŠ æ ·å¼ï¼Œæ ·å¼ç±»åä»ControllerWrapè·å–
     .${prefixCls} > .${itemControllerCls} {
        flex: ${props.controllerCol.span || 6}
      }
    `;
  }),
);

```
  
   &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æˆ‘ä»¬æ¥çœ‹çœ‹æ”¾ç»„ä»¶åçš„æ•ˆæœï¼ˆä¸»é¡µdemoï¼‰ï¼š
   
![image.png](/img/posts/2022-5-22/2022-5-22-2.png)



   &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æ€»ç»“ä¸€ä¸‹ï¼Œè¡¨å•ç»„ä»¶éœ€è¦æ”¾åœ¨åŸç”Ÿformæ ‡ç­¾å†…ï¼Œä½¿ç”¨æ …æ ¼å¸ƒå±€ï¼Œå·¦ä¾§æ”¾ç½®labelï¼Œå³ä¾§æ”¾ç½®å…·ä½“çš„è¾“å…¥ç»„ä»¶ï¼›æœ¬æ–‡ç« ä»‹ç»äº†Inputå’ŒRadioå¦‚ä½•æ¥å°è£…ï¼Œå…¶ä»–ç»„ä»¶ä¹Ÿéƒ½æ˜¯å¤§åŒå°å¼‚ï¼Œç”±äºç¯‡å¹…é™åˆ¶ï¼Œè¯»è€…å¯ä»¥å»ä¸»é¡µæŸ¥çœ‹æ•ˆæœæˆ–è€…è‡ªå·±å»npmå®‰è£…ä¸€ä¸‹å®æ–½æ•ˆæœï¼ˆç›¸å…³é…ç½®å¯æŸ¥çœ‹æºç READMEï¼‰ï¼š

```sh
npm install --save dux-ui
```3c:T2c69,å‰åç«¯åˆ†ç¦»çš„é¡¹ç›®ä¸­ï¼ŒAPIæ¥å£çš„è´¨é‡ä¼šç›´æ¥å½±å“å‰ç«¯é¡µé¢æ¸²æŸ“çš„é€»è¾‘ã€‚ä½œè€…ç»è¿‡å¤šå¹´çš„ä¸åç«¯å¼€å‘åŒå­¦. äº§å“çš„â€œç£¨åˆâ€ä¸­æ€»ç»“äº†ä¸€å¥—ç›¸å¯¹æ¥è¯´æ¯”è¾ƒå®Œæ•´çš„ï¼Œå¯¹äºå‰ç«¯æ¯”è¾ƒå‹å¥½çš„æ¥å£è§„èŒƒã€‚å…¶å®è¯´æ˜¯æ€¼åç«¯ï¼Œä½†æ¢ä¸ªè§’åº¦è®²ï¼Œä¹Ÿæ˜¯åœ¨å¸®åŠ©åç«¯è¿›æ­¥å˜›ï¼


## 0. è®¾è®¡è§„èŒƒåŸåˆ™

```
1.   å‰ç«¯åº”åªå…³æ³¨æ¸²æŸ“é€»è¾‘ï¼Œè€Œä¸åº”è¯¥å…³æ³¨æ•°æ®çš„å¤„ç†é€»è¾‘ã€‚æ¥å£è¿”å›çš„æ•°æ®åº”è¯¥æ˜¯èƒ½å¤Ÿç›´æ¥å±•ç¤ºåœ¨ç•Œé¢ä¸Šçš„ã€‚
2.   ä¸€ä¸ªåŠŸèƒ½åº”é¿å…å¤šä¸ªæ¥å£åµŒå¥—è°ƒç”¨è·å–æ•°æ®ï¼Œåå°åº”è¯¥å¤„ç†å¥½ä¸€æ¬¡æ€§è¿”å›ã€‚
3.   å“åº”æ ¼å¼åº”è¯¥æ˜¯JSONï¼Œè€Œä¸”åº”é¿å…å¤šçº§JSONçš„å‡ºç°ï¼›
4.   åç«¯å¦‚æœéœ€è¦ç•Œé¢å®æ—¶åˆ·æ–°æ•°æ®ï¼Œä¸åº”è¯¥è¦æ±‚å‰ç«¯å®šæ—¶å™¨è½®è¯¢ï¼Œè€Œè¦æä¾›ç±»ä¼¼webSocketä¹‹ç±»çš„åŠŸèƒ½ã€‚
```
æ ¹æ®è¿™ä¸ªåŸåˆ™ï¼Œåç«¯è¿”å›çš„æ•°æ®åº”è¯¥æ˜¯æ‰€è§å³æ‰€å¾—çš„æ•°æ®ï¼Œè€Œä¸åº”è¯¥æ˜¯ä¸€å±‚åŒ…ä¸€å±‚çš„å¤æ‚çš„JSONï¼Œéœ€è¦å‰ç«¯é¢å¤–æ¥å¤„ç†å¾ˆå¤æ‚çš„å»é‡ï¼Œæ’åº. æ·±æµ…æ‹·è´ï¼Œå˜å½¢ç­‰å¤„ç†ã€‚å‰ç«¯åœ¨æ¸²æŸ“æ¯ä¸€ä¸ªdivï¼Œæ¯ä¸€ä¸ªtableçš„cellæ—¶ï¼Œä¸ç”¨æ‹…å¿ƒæ•°æ®ç»“æ„ä¼šé¢‘ç¹æ›´æ”¹ä»è€Œå¯¼è‡´é¡µé¢å´©æºƒã€‚

## 1. æ¥å£åˆ¶å®šçš„å…¨æµç¨‹

å‰ç«¯è¯·æ±‚ä¸€èˆ¬æ˜¯`HTTP`åè®®ï¼Œè¿™é‡Œä»¥HTTPä¸ºä¾‹ã€‚

### HTTPè¯·æ±‚çš„åè®®ç±»å‹

åº”ä½¿ç”¨ä¸‹é¢ç½—åˆ—çš„HTTPæ–¹æ³•ï¼ˆä½¿ç”¨çš„SQLå…³é”®å­—ï¼‰:

- `GET`ï¼ˆSELECTï¼‰ï¼šä»æœåŠ¡å™¨å–å‡ºèµ„æºï¼Œä¸€é¡¹æˆ–å¤šé¡¹ã€‚
- `POST`ï¼ˆCREATEï¼‰ï¼šåœ¨æœåŠ¡å™¨æ–°å»ºä¸€ä¸ªèµ„æºã€‚
- `PUT`ï¼ˆUPDATEï¼‰ï¼šåœ¨æœåŠ¡å™¨æ›´æ–°èµ„æºï¼ˆå®¢æˆ·ç«¯æä¾›æ”¹å˜åçš„å®Œæ•´èµ„æºï¼‰ã€‚
- `PATCH`ï¼ˆUPDATEï¼‰ï¼šåœ¨æœåŠ¡å™¨æ›´æ–°èµ„æºï¼ˆå®¢æˆ·ç«¯æä¾›æ”¹å˜çš„å±æ€§ï¼‰ï¼Œä½¿ç”¨æ¯”è¾ƒå°‘
- `DELETE`ï¼ˆDELETEï¼‰ï¼šä»æœåŠ¡å™¨åˆ é™¤èµ„æºã€‚

ä¸‹é¢æ˜¯ä¸€äº›ä¾‹å­:

- `GET` /schoolsï¼šåˆ—å‡ºæ‰€æœ‰çš„å­¦æ ¡åˆ—è¡¨
- `POST` /schoolï¼šæ–°å»ºä¸€ä¸ªå­¦æ ¡
- `GET` /school/`{id}`ï¼šè·å–æŸä¸ªæŒ‡å®šå­¦æ ¡çš„ä¿¡æ¯
- `PUT` /school/`{id}`ï¼šæ›´æ–°æŸä¸ªæŒ‡å®šå­¦æ ¡çš„ä¿¡æ¯ï¼ˆæä¾›è¯¥å­¦æ ¡çš„å…¨éƒ¨ä¿¡æ¯ï¼Œè€Œä¸æ˜¯è®©å‰ç«¯å†é€šè¿‡åˆ«çš„æ¥å£è·å–ï¼‰
- `PATCH` /school/`{id}`ï¼šæ›´æ–°æŸä¸ªæŒ‡å®šå­¦æ ¡çš„ä¿¡æ¯ï¼ˆæä¾›è¯¥å­¦æ ¡çš„éƒ¨åˆ†ä¿¡æ¯ï¼‰
- `DELETE` /school/`{id}`ï¼šåˆ é™¤æŸä¸ªå­¦æ ¡

### HTTPè¯·æ±‚çš„å‚æ•°å®šä¹‰

ä¸åŒ`HTTP`æ–¹æ³•å¯¹åº”ä¸åŒçš„å‚æ•°ä¼ é€’æ–¹å¼ï¼Œå¦‚ä¸‹ï¼š

> queryæŒ‡è·¯å¾„ä¼ å‚ï¼ŒbodyæŒ‡requestBodyè¯·æ±‚ä½“

- `GET`ï¼špath & query
- `POST`ï¼špath & body
- `PUT`ï¼špath & query & body
- `PATCH`ï¼špath & query & body
- `DELETE`ï¼špath & query

æ³¨æ„ï¼š

```
1. æœªå‡ºç°åœ¨ä¸Šè¡¨ä¸­çš„ä½ç½®ä¸å¯æ”¾ç½®å‚æ•°ï¼Œå¦‚GETæ–¹æ³•ä¸å¯åœ¨bodyä¸­æ”¾ç½®å‚æ•°ã€‚
2. å‚æ•°å‘½åå‡éµå¾ªå°é©¼å³°å‘½åæ³•ã€‚
3. pathå’Œqueryä¸­ä¼ é€’çš„å‚æ•°éœ€ç¡®ä¿é•¿åº¦å¯æ§ï¼Œè¶…è¿‡2000å­—ç¬¦ï¼ˆå› æµè§ˆå™¨è€Œå¼‚ï¼‰çš„å‚æ•°å¯å¯¼è‡´è¯·æ±‚å¤±è´¥ã€‚å½“è¯·æ±‚æ— æ³•ä¿è¯å‚æ•°é•¿åº¦å¯æ§ï¼Œåˆ™ä¸èƒ½å°†å‚æ•°æ”¾åœ¨pathæˆ–queryä¸­ï¼Œå¿…é¡»ä½¿ç”¨æ”¯æŒbodyå‚æ•°çš„HTTPæ–¹æ³•ï¼Œå¦‚POSTã€‚
4. pathå’Œqueryä¸­ä¼ é€’çš„å‚æ•°éœ€æ˜¯åŸºæœ¬ç±»å‹ï¼Œäº¦ä¸å¯ä¼ é€’åºåˆ—åŒ–ä¹‹åçš„JSONå¯¹è±¡ï¼ä¸ç„¶å‰ç«¯å°±è¦try/catchä¸€ä¸‹æ¥parseäº†ã€‚
5. bodyä¸­çš„å‚æ•°éœ€æ˜¯åˆæ³•JSONå¯¹è±¡æˆ–è€…formDataï¼Œå³ä½¿å‚æ•°ä»…åŒ…å«å•å­—æ®µæˆ–å•æ•°ç»„ï¼Œä¹Ÿéœ€åŒ…å«åœ¨å¯¹è±¡ä¸­ï¼Œå¦‚ï¼š
{
Â  name: string;
}
```


### HTTPå“åº”ç»“æœå®šä¹‰

é’ˆå¯¹ä¸åŒæ“ä½œï¼ŒæœåŠ¡å™¨å‘ç”¨æˆ·è¿”å›çš„ç»“æœåº”è¯¥ç¬¦åˆä»¥ä¸‹è§„èŒƒã€‚

<Row>
  <Col>
    - `GET` /collectionsï¼šè¿”å›èµ„æºå¯¹è±¡çš„åˆ—è¡¨ï¼ˆæ•°ç»„ï¼‰
  </Col>
  <Col sticky>
    ```js {{ title: 'Response' }}
    {
        RetCode: 0,
        Message: 'ok',
        Action: 'collections',
        Data: [
            {
                Id: 1,
                name: 'collection1',
                ...
            },
            ...
        ]
    }
    ```
  </Col>
</Row>
---
<Row>
  <Col>
    - `GET` /collection/resourceï¼šè¿”å›å•ä¸ªèµ„æºå¯¹è±¡
  </Col>
  <Col sticky>
    ```js {{ title: 'Response' }}
    {
        RetCode: 0,
        Message: 'ok',
        Action: 'collectionResource',
        Data: {
            Id: 1,
            name: 'collection1',
            ...
        }
    }
    ```
  </Col>
</Row>
---
<Row>
  <Col>
    - `POST` /collectionï¼šè¿”å›æ–°ç”Ÿæˆçš„èµ„æºå¯¹è±¡
  </Col>
  <Col sticky>
    ```js {{ title: 'Response' }}
      {
          RetCode: 0,
          Message: 'ok',
          Action: 'collection',
          Data: {
              Id: 1,
              name: 'collection1',
              ...
          }
      }
    ```
  </Col>
</Row>

- `PUT` /collection/resourceï¼šè¿”å›å®Œæ•´çš„èµ„æºå¯¹è±¡ï¼Œ è¿”å›ç»“æœåŒä¸Šã€‚
- `PATCH` /collection/resourceï¼šè¿”å›å®Œæ•´çš„èµ„æºå¯¹è±¡ï¼Œè¿”å›ç»“æœåŒä¸Šã€‚

<Row>
  <Col>
    - `DELETE` /collection/resourceï¼šè¿”å›ä¸€ä¸ªç©ºæ–‡æ¡£
  </Col>
  <Col sticky>
    ```js {{ title: 'Response' }}
      {
          RetCode: 0,
          Message: 'ok',
          Action: 'collectionResource',
          Data: {}
      }
    ```
  </Col>
</Row>

æ³¨æ„ï¼š


1. æ‰€æœ‰è¿”å›æ•°æ®éœ€æ˜¯åˆæ³•JSONï¼Œå°½é‡è¿”å›objectæˆ–è€…array (äºŒè¿›åˆ¶æ–‡ä»¶ä¸‹è½½é™¤å¤–)ã€‚å¦‚æœæ•°æ®ä¸­åŒ…å«ç±»å‹ä¸ºarrayçš„å±æ€§ï¼Œå½“æ•°æ®ä¸ºç©ºæ—¶ï¼Œå°½é‡è¿”å›ç©ºæ•°ç»„[]ï¼Œé¿å…è¿”å›nullã€‚
2. è¿”å›æ•°æ®é¿å…ä½¿ç”¨mapçš„`<'key', 'value'>`å½¢å¼ï¼å¦‚æœ‰ç›¸å…³æ ¼å¼çš„è¿”å›æ•°æ®ï¼Œè¯·è½¬æ¢ä¸ºarrayã€‚
3. å¦‚æœæ²¡æœ‰æ•°æ®éœ€è¦è¿”å›ï¼Œæˆ–ç³»ç»ŸæŠ¥é”™æ—¶ï¼Œå¯ç»Ÿä¸€è¿”å›å›ºå®šå­—æ®µï¼š

```ts
{
  RetCode: number, // åç«¯çŠ¶æ€ç 
  Message: string, // è¯·æ±‚è¿”å›æ¶ˆæ¯
  Action: string, // è¯·æ±‚çš„å“åº”å…³é”®å­—
  Data: Object | Array // å“åº”æ•°æ®
}
```

4. è¿”å›å€¼ä¸­åº”å°½é‡é¿å…åŒ…å«æ— ç”¨ä¿¡æ¯ï¼Œæˆ–è€…é¢å¤–çš„æ•°æ®ç»“æ„ï¼Œä»…åŒ…å«å¿…è¦æ•°æ®å³å¯ã€‚å¿…è¦æ•°æ®æŒ‡å‰ç«¯éœ€è¦æ¸²æŸ“çš„æ•°æ®ã€‚
5. åç«¯å¼‚å¸¸æŠ¥é”™å‡ä»¥'500'çŠ¶æ€ç çš„å½¢å¼è¿”å›ï¼Œä¹Ÿå¯é€‚å½“æ·»åŠ é¢å¤–ä¿¡æ¯ï¼Œéç‰¹æ®Šæƒ…å†µæ— éœ€åœ¨è¿”å›çš„æ•°æ®ä½“ä¸­è¿”å›HTTP codeã€‚


### URLè§„èŒƒ

å¯å‚ç…§ä¸‹é¢çš„èŒƒä¾‹ï¼š
`GET [http | https]://host:port/studio/api/ç»„ä»¶å/v1/æ¨¡å—å/èœå•å/æ¥å£å/:param`

æ³¨æ„ï¼š
```
1. ä¸ç”¨å¤§å†™å­—æ¯ï¼Œå»ºè®®ç”¨ä¸­æ  - ä¸ç”¨ä¸‹æ  _. æ¯”å¦‚é‚€è¯·ç å†™æˆinvitation-codeè€Œä¸æ˜¯invitation_code
2. ä½¿ç”¨åè¯è¡¨ç¤ºèµ„æºé›†åˆï¼Œä½¿ç”¨å¤æ•°å½¢å¼ï¼ˆä¸ºç¡®ä¿æ‰€æœ‰API URIsä¿æŒä¸€è‡´ï¼‰ï¼Œä¸èƒ½ä½¿ç”¨åŠ¨è¯ï¼›
3. æ¯ä¸ªèµ„æºéƒ½è‡³å°‘æœ‰ä¸€ä¸ªæ ‡è¯†å®ƒçš„URIï¼ŒåŒæ—¶åº”è¯¥éµå¾ªä¸€ä¸ªå¯é¢„æµ‹çš„å±‚æ¬¡ç»“æ„æ¥æé«˜å¯ç†è§£æ€§ï¼Œä»è€Œæé«˜å¯ç”¨æ€§ï¼›
4. å®¾è¯­å¿…é¡»æ˜¯åè¯ã€‚ç½‘å€ä¸­ä¸èƒ½æœ‰åŠ¨è¯ï¼Œåªèƒ½æœ‰åè¯ï¼ŒAPIä¸­çš„åè¯ä¹Ÿåº”è¯¥ä½¿ç”¨å¤æ•°ï¼Œå®¾è¯­å°±æ˜¯APIçš„URLï¼Œæ˜¯HTTPåŠ¨è¯ä½œç”¨çš„å¯¹è±¡ã€‚å®ƒåº”è¯¥æ˜¯åè¯ï¼Œä¸èƒ½æ˜¯åŠ¨è¯
```
æ­£ğŸŒ° ï¼š

- `GET` /classesï¼šåˆ—å‡ºæ‰€æœ‰ç­çº§
- `POST` /classesï¼šæ–°å»ºä¸€ä¸ªç­çº§
- `GET` /classes/`{classId}`ï¼šè·å–æŸä¸ªæŒ‡å®šç­çº§çš„ä¿¡æ¯
- `PUT` /classes/`{classId}`ï¼šæ›´æ–°æŸä¸ªæŒ‡å®šç­çº§çš„ä¿¡æ¯ï¼ˆä¸€èˆ¬å€¾å‘æ•´ä½“æ›´æ–°ï¼‰
- `PATCH` /classes/`{classId}`ï¼šæ›´æ–°æŸä¸ªæŒ‡å®šç­çº§çš„ä¿¡æ¯ï¼ˆä¸€èˆ¬å€¾å‘éƒ¨åˆ†æ›´æ–°ï¼‰
- `DELETE` /classes/`{classId}`ï¼šåˆ é™¤æŸä¸ªç­çº§
- `GET` /classes/`{classId}`/teachersï¼šåˆ—å‡ºæŸä¸ªæŒ‡å®šç­çº§çš„æ‰€æœ‰è€å¸ˆçš„ä¿¡æ¯
- `GET` /classes/`{classId}`/studentsï¼šåˆ—å‡ºæŸä¸ªæŒ‡å®šç­çº§çš„æ‰€æœ‰å­¦ç”Ÿçš„ä¿¡æ¯
- `DELETE` classes/`{classId}`/teachers/`{teacherId}`ï¼šåˆ é™¤æŸä¸ªæŒ‡å®šç­çº§ä¸‹çš„æŒ‡å®šçš„è€å¸ˆçš„ä¿¡æ¯

åä¾‹ï¼š
- /getAllclasses
- /createNewclass
- /deleteAllActiveclasses

> **å¤æ•°è¿˜æ˜¯å•æ•°URLé—®é¢˜**ï¼š æ—¢ç„¶ URL æ˜¯åè¯ï¼Œé‚£ä¹ˆåº”è¯¥ä½¿ç”¨å¤æ•°ï¼Œè¿˜æ˜¯å•æ•°ï¼Ÿè¿™æ²¡æœ‰ç»Ÿä¸€çš„è§„å®šï¼Œä½†æ˜¯å¸¸è§çš„æ“ä½œæ˜¯è¯»å–ä¸€ä¸ªé›†åˆï¼Œæ¯”å¦‚GET /articlesï¼ˆè¯»å–æ‰€æœ‰æ–‡ç« ï¼‰ï¼Œè¿™é‡Œæ˜æ˜¾åº”è¯¥æ˜¯å¤æ•°ï¼Œè€Œè·å–å•ä¸ªå¯ä»¥ç”¨GET /article/2ã€‚ å½“ç„¶ï¼Œä½ å¯ä»¥ä¸ºäº†ç»Ÿä¸€èµ·è§ï¼Œéƒ½ä½¿ç”¨å¤æ•°URLï¼Œæ¯”å¦‚GET /articles/2ã€‚

å¤šçº§URLçš„å¤„ç†ï¼šå½“æŸ¥è¯¢èµ„æºä¿¡æ¯è¾ƒå¤šæ—¶ï¼Œå¾€å¾€ä¼šæœ‰å¤šçº§å‚æ•°å‡ºç°åœ¨URLä¸­ï¼Œæ­¤å¤„è¦åˆ†ä¸‰ç§æƒ…å†µè®¨è®ºï¼š

1. æŸ¥è¯¢ä¿¡æ¯æŒ‡ä»£å½“å±‚å”¯ä¸€idï¼Œå°†æŸ¥è¯¢ä¿¡æ¯æ”¾åœ¨pathä¸­ï¼Œæ„å»ºå”¯ä¸€çš„æŸ¥è¯¢è·¯å¾„ï¼Œå¦‚ï¼š
`> GET /authors/12/categories/2`

2. æŸ¥è¯¢ä¿¡æ¯å±äºå¯¹å½“å±‚ä¿¡æ¯çš„çŠ¶æ€è¿‡æ»¤ï¼Œå°†æŸ¥è¯¢ä¿¡æ¯æ”¾åœ¨queryä¸­ï¼Œå¦‚ï¼š
`> GET /articles?published=true`

3. æŸ¥è¯¢ä¿¡æ¯æ—¢åŒ…å«å½“å±‚idï¼Œä¹ŸåŒ…å«è¿‡æ»¤ä¿¡æ¯ï¼Œåˆ†åˆ«å°†idå’Œè¿‡æ»¤ä¿¡æ¯æ”¾åœ¨pathå’Œqueryä¸­ï¼Œå¦‚ï¼š
`> GET /authors/12/categories/2?published=true`


### HTTPçŠ¶æ€ç çº¦æŸ

å®¢æˆ·ç«¯çš„æ¯ä¸€æ¬¡è¯·æ±‚ï¼ŒæœåŠ¡å™¨éƒ½å¿…é¡»ç»™å‡ºå›åº”ã€‚å›åº”åŒ…æ‹¬ HTTP çŠ¶æ€ç å’Œæ•°æ®ä¸¤éƒ¨åˆ†ã€‚HTTP çŠ¶æ€ç å°±æ˜¯ä¸€ä¸ªä¸‰ä½æ•°ï¼Œåˆ†æˆäº”ä¸ªç±»åˆ«ã€‚

```
- 1xxï¼šç›¸å…³ä¿¡æ¯
- 2xxï¼šæ“ä½œæˆåŠŸ
- 3xxï¼šé‡å®šå‘
- 4xxï¼šå®¢æˆ·ç«¯é”™è¯¯
- 5xxï¼šæœåŠ¡å™¨é”™è¯¯
```
çŠ¶æ€ç è§„èŒƒè§[W3Cå…³äºHTTPçŠ¶æ€ç å®šä¹‰](https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html)

### åˆ†é¡µä¸æœç´¢æ¥å£çº¦æŸ

åˆ†é¡µæ¥å£å¹¿æ³›å‡ºç°åœ¨æ•°æ®é‡è¾ƒå¤§åœºæ™¯ä¸‹çš„è¡¨æ ¼å‹äº¤äº’ã€‚å³ä½¿æ˜¯æ¸²æŸ“ç®€å•çš„åˆ—è¡¨å…ƒç´ ï¼Œè¶…è¿‡500é¡¹æœ‰å¯èƒ½å¯¼è‡´å‰ç«¯å¡é¡¿ï¼Œè¶…è¿‡5000é¡¹ä»¥ä¸Šï¼ˆä¸åŒæµè§ˆå™¨. ç”µè„‘é…ç½®ä¼šå½±å“è¿™ä¸ªæ•°å­—ï¼‰æœ‰å¯èƒ½å¯¼è‡´å‰ç«¯å´©æºƒã€‚å‡¡æ— æ³•ä¿è¯èƒ½é™åˆ¶æ¥å£è¿”å›æ•°é‡åœ¨ä¸€ä¸ªè¾ƒå°æ•°é‡çº§ï¼ˆ100ä»¥ä¸‹ï¼‰çš„æ¥å£éƒ½éœ€è¦è€ƒè™‘æ”¯æŒåç«¯åˆ†é¡µï¼›å¦‚æœè¿”å›ç»“æœæ•°é‡æ˜¯ä¸å—æ§åˆ¶çš„ï¼ˆå¦‚åŒ…å«ç”¨æˆ·ç”Ÿæˆæ•°æ®ï¼‰ï¼Œåˆ™`å¿…é¡»æ”¯æŒ`åç«¯åˆ†é¡µã€‚
<br />

è¿™é‡Œç»™å‡ºè¯·æ±‚èŒƒä¾‹ï¼š

GET æ¥å£

`?page={page}&size={size}`

POST æ¥å£

```js
// æ ¼å¼1
{
    page: number;
    size: number;
    total: number; // æ•°æ®æ€»é‡
}

// æ ¼å¼2
{
    Limit: number;
    Offset: number
    Total: number; // æ•°æ®æ€»é‡
}

// å…¶ä¸­pageä¸ºå½“å‰è¯·æ±‚é¡µï¼Œä¸ºä»0å¼€å§‹çš„æ­£æ•´æ•°ï¼›
// sizeä¸ºå½“å‰é¡µå¤§å°ï¼Œå¸¸ç”¨çš„å€¼æœ‰10. 20ç­‰ï¼Œç†è®ºä¸Šéœ€æ”¯æŒä»»æ„æ­£æ•´æ•°ã€‚ç‰¹æ®Šçš„ï¼Œè‹¥ä¸º-1ï¼Œå¯ä»¥çº¦å®šä¸ºæŸ¥è¯¢å…¨éƒ¨
// LimitåŒsize
// Offsetä¸ºç›¸å¯¹åç§»é‡ï¼Œä¸ºä»0å¼€å§‹çš„æ­£æ•´æ•°
```


éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœäº¤äº’ä¸­å‡ºç°è¿‡æ»¤. æ’åºåŠŸèƒ½ï¼Œåˆ™ç›¸å…³åŠŸèƒ½å¿…è¦æ—¶éƒ½éœ€è¦åç«¯æ”¯æŒã€‚å¦‚æœå‚æ•°èƒ½ä¿è¯ä¸è¶…è¿‡ä¸€å®šé•¿åº¦ï¼Œåˆ™å‚æ•°æ”¾åœ¨queryé‡Œä¹Ÿæ˜¯å¯ä»¥æ¥å—çš„ã€‚æ•°ç»„å‹å‚æ•°å¯ä»¥ä»¥ç›¸å…³å­—æ®µç”¨é€—å·è¿æ¥çš„å½¢å¼ä¼ é€’ï¼Œå¦‚ï¼š

```
?status=RUNNING,COMPLETE,ERROR
```

> ç‰¹æ®Šç±»å‹å¤„ç†
> 1. å…³äºBooleanç±»å‹ï¼ŒJSONæ•°æ®ä¼ è¾“ä¸­ä½¿ç”¨true/falseå­—æ®µè¿›è¡Œä¼ é€’ã€‚
> 2. å…³äºæ—¥æœŸç±»å‹ï¼ŒJSONæ•°æ®ä¼ è¾“ä¸­ä¸€å¾‹ä½¿ç”¨é•¿æ•´å½¢æ—¶é—´æˆ³ï¼ˆUnix timeï¼‰è¿›è¡Œä¼ é€’ï¼Œå…·ä½“æ—¥æœŸæ˜¾ç¤ºæ ¼å¼ç”±å‰ç«¯å¤„ç†ã€‚



## 2. æ³¨æ„äº‹é¡¹

ä»»ä½•å½¢å¼çš„æ¥å£å˜æ›´éƒ½ä¼šå¯¹å‰ç«¯äº§ç”Ÿå½±å“ï¼Œæ¯”å¦‚å­—æ®µåç§°çš„ä¿®æ”¹ï¼Œå­—æ®µçš„å¢å‡ï¼Œå­—æ®µç±»å‹çš„ä¿®æ”¹ï¼Œè¯·æ±‚å‚æ•°ç±»å‹çš„å˜åŠ¨ç­‰ã€‚åŸåˆ™ä¸Šå½“æ¥å£å¯¹æ¥å®Œæˆåä¸åº”æœ‰ä»»ä½•å½¢å¼çš„ä¿®æ”¹ï¼Œå¦‚æœä¸€å®šè¦å˜æ›´æ¥å£ï¼Œéœ€åŠæ—¶é€šçŸ¥ç›¸åº”å‰ç«¯å¼€å‘äººå‘˜å¹¶é‡æ–°å¯¹æ¥ã€‚

è¡¨ç¤ºåŒä¸€å«ä¹‰çš„å­—æ®µåœ¨åŒä¸€å¥—åŠŸèƒ½æ¥å£é›†åˆï¼ˆå¢åˆ æ”¹æŸ¥ï¼‰ä¸­åº”å°½é‡ä¿è¯ç›¸åŒã€‚åœ¨æ¥å£è®¾è®¡ä¸­ï¼Œå¯¹åŒä¸€å®ä½“è¿›è¡Œæ“ä½œçš„æ¥å£åº”å°½é‡ä¿è¯åœ¨å‚æ•°å’Œè¿”å›å€¼ä¸­ï¼Œè¯¥å®ä½“çš„æ•°æ®ç»“æ„ä¿æŒä¸€è‡´ï¼Œå°½é‡é¿å…å‰ç«¯åšæ•°æ®å¯¹è±¡è½¬æ¢çš„åŠ¨ä½œã€‚


## 3. å‚è€ƒ

[é˜®ä¸€å³° RESTful API è®¾è®¡æŒ‡å—](https://www.ruanyifeng.com/blog/2014/05/restful_api.html)

[Representational state transfer](https://en.wikipedia.org/wiki/Representational_state_transfer)

[Hypertext Transfer Protocol](https://en.wikipedia.org/wiki/Hypertext_Transfer_Protocol#Request_methods)

```
çµæ„Ÿæ¥æº - Transwarpé€šç”¨æŠ€æœ¯ç»„å‰ç«¯å›¢é˜Ÿjiraæ–‡æ¡£ - å‰åç«¯æ¥å£è§„èŒƒ
```3d:T2d3f,> ä¸“æ è¯´æ˜ï¼šå¯¹äºreact-router v6ç‰ˆæœ¬ï¼Œæœ‰åŒäº‹ååº”ç¼ºå°‘ç›¸å¯¹å®Œæ•´çš„ä¸­æ–‡æ–‡æ¡£ï¼ŒæŸ¥çœ‹ä¸æ–¹ä¾¿ã€‚ä¸ºäº†ä¾¿äºä½¿ç”¨ï¼Œä½œè€…å¯¹[å®˜ç½‘æ–‡æ¡£](https://reactrouter.com/docs/en/v6)è¿›è¡Œé’ˆå¯¹æ€§ç¿»è¯‘ï¼Œä¾¿äºv6ç‰ˆæœ¬æ›´å¹¿æ³›çš„è¢«ä½¿ç”¨ã€‚

ä¸Šä¸€ç¯‡ï¼š[# React Router v6 å®˜æ–¹æ–‡æ¡£ç¿»è¯‘ ï¼ˆä¸€ï¼‰ ---- Installation && Quick Start](https://juejin.cn/post/7100479939694034952)

## 1. é—®ç­”ç¯èŠ‚

> åŸæ–‡è·¯å¾„ï¼šhttps://reactrouter.com/docs/en/v6/getting-started/faq#faqs

ä¸‹é¢æ˜¯å¤§å®¶åœ¨ä½¿ç”¨`React Router v6`æ—¶ç»å¸¸é—®åˆ°çš„é—®é¢˜ã€‚

### 1. å½“æˆ‘ç”¨çš„æ˜¯ç±»å¼ç»„ä»¶ï¼Œåˆå¿…é¡»ä½¿ç”¨Routeræ—¶ï¼Œæˆ‘åº”è¯¥æ€ä¹ˆåšï¼Ÿ

React Router v6ç‰ˆæœ¬ä¸å†æ”¯æŒ`withRouter`ã€‚å½“ä½¿ç”¨ç±»å¼Reactç»„ä»¶æ—¶ï¼Œä¸èƒ½å¤Ÿä½¿ç”¨hooksï¼Œç„¶è€Œåœ¨React Router v6ä¸­éƒ½æ˜¯ç”¨hookså‡½æ•°æ¥å…±äº«è·¯ç”±çŠ¶æ€ï¼Œä½†è¿™å¹¶ä¸æ„å‘³ç€ç±»å¼ç»„ä»¶ä¸èƒ½ä½¿ç”¨React Router v6ã€‚æ­¤æ—¶ä½ éœ€è¦å†™ä¸€ä¸ªè‡ªå·±çš„`withRouter`å°è£…å‡½æ•°ï¼ˆReact16.8+ï¼‰ï¼š

```tsx
import {
  useLocation,
  useNavigate,
  useParams,
} from "react-router-dom";

function withRouter(Component) {
  function ComponentWithRouterProp(props) {
    let location = useLocation();
    let navigate = useNavigate();
    let params = useParams();
    return (
      <Component
        {...props}
        router={{ location, navigate, params }}
      />
    );
  }

  return ComponentWithRouterProp;
}
```

### 2. ä¸ºä»€ä¹ˆ`<Route>`æ ‡ç­¾ç”¨`element`å±æ€§æ›¿ä»£`render`å’Œ`component`ï¼Ÿ

åœ¨React Router v6ä¸­ï¼Œæˆ‘ä»¬æŠŠv5ä¸­`<Route component>`å’Œ`<Route render>`ä¸¤ä¸ªAPIç”¨`<Route element>`æ›¿æ¢ï¼Œä¸»è¦åŸå› æœ‰å¦‚ä¸‹å‡ ç‚¹ï¼š

1. å¯¹äºåˆå­¦è€…ï¼Œè‚¯å®šä¼šç»å¸¸ä½¿ç”¨ç»„ä»¶æ‡’åŠ è½½`<Suspense fallback={<Spinner />}>`ï¼Œè¿™ä¸ªAPIé‡Œï¼Œfallbackå°±æ˜¯ä¸€ä¸ª`ReactÂ element`ï¼Œæˆ‘ä»¬ä¹‹æ‰€ä»¥è¿™ä¹ˆè®¾è®¡ï¼Œå°±æ˜¯ä¸ºäº†è®©åˆå­¦è€…èƒ½å¤Ÿæ›´å®¹æ˜“. æ›´å¹³æ»‘çš„ä½¿ç”¨æ¸²æŸ“å‡½æ•°ã€‚

2. ï¼ˆå®˜ç½‘è¯´çš„æ¯”è¾ƒå¤æ‚ï¼Œæˆ‘æ€»ç»“ä¸€ä¸‹ï¼‰v5ç‰ˆæœ¬ä¸­ï¼Œ`<Route component>`ä¸èƒ½ä¼ é€’propsï¼Œæƒ³è¦ä¼ é€’ç»„ä»¶å‚æ•°ï¼Œå°±éœ€è¦ä½¿ç”¨`<Route render>`ï¼Œè¿™å°±å¯¼è‡´äº†v4/v5çš„æ¸²æŸ“APIä½“é‡ä¼šæ›´å¤§ä¸€äº›ï¼Œä¸‹é¢æ˜¯ä¾‹å­ï¼š

```jsx
// å“¦å¼ï¼Œçœ‹èµ·æ¥æ˜¯ä¸ªä¸é”™çš„å†™æ³•ï¼
<Route path=":userId" component={Profile} />

// ä½†æ˜¯å‘¢ï¼Œæˆ‘æ€ä¹ˆç»™ <Profile> ä¼ é€’ props å‘¢??
// Hmm, æˆ‘è¿˜å¾—ç”¨å¦å¤–ä¸€ç§æ–¹å¼ï¼šrender
<Route
  path=":userId"
  render={routeProps => (
    <Profile routeProps={routeProps} animate={true} />
  )}
/>

// æ‰€ä»¥ï¼Œåœ¨v5ç‰ˆæœ¬ä¸­æœ‰ä¸¤ç§è·¯ç”±ç»„ä»¶æ¸²æŸ“æ–¹å¼ :/

// ä½†æ˜¯è¿˜æœ‰ä¸€ç§æƒ…å†µï¼Œå…³äºæ‰€æœ‰URLéƒ½ä¸èƒ½åŒ¹é…çš„404æƒ…å†µå‘¢ï¼Ÿ
// æˆ–è®¸è¿˜å¯ä»¥ä½¿ç”¨childrenæ–¹æ³•
<Route
  path=":userId"
  children={({ match }) => (
    match ? (
      <Profile match={match} animate={true} />
    ) : (
      <NotFound />
    )
  )}
/>

// å¦‚æœæƒ³è¦æ‹¿åˆ°è·¯ç”±çš„åŒ¹é… æˆ–è€… æƒ³åœ¨åµŒå¥—è·¯ç”±æ¯”è¾ƒæ·±å±‚çš„åœ°æ–¹æ¥ä¸€ä¸ªè·¯ç”±è·³è½¬å‘¢ï¼Ÿ
function DeepComponent(routeStuff) {
  // å•Šï¼Œå¤æ‚çš„å®ç°~
}
export default withRouter(DeepComponent);

// ä»¥ä¸Šæ˜¯åˆ—ä¸¾çš„ä½œè€…èƒ½æƒ³åˆ°çš„ä½¿ç”¨æƒ…å†µã€‚
```

Reactæœ¬èº«ä¸æä¾›ä»»ä½•è·å–`<Route>`ä¿¡æ¯çš„æ–¹å¼ï¼Œ æ‰€ä»¥æˆ‘ä»¬å¿…é¡»å‘æ˜ä¸€ç§æ—¢èƒ½è·å–Routeä¿¡æ¯ï¼Œåˆèƒ½è·å–è‡ªå®šä¹‰propsçš„æ–¹å¼ã€‚åº†å¹¸çš„æ˜¯ï¼Œhooksçš„å‡ºç°ï¼Œå¯ä»¥æ›¿ä»£ä¹‹å‰çš„`component`. `render`å’Œé«˜é˜¶ç»„ä»¶ã€‚å†çœ‹çœ‹é’ˆå¯¹ä»¥ä¸Šæƒ…å†µï¼Œv6æ˜¯æ€ä¹ˆå®ç°çš„ï¼š

```jsx
// å°±åƒReactåŸç”Ÿçš„ <Suspense> é‚£æ ·ä½¿ç”¨è·¯ç”±ç»„ä»¶!
// ä¸éœ€è¦é¢å¤–å¢åŠ å­¦ä¹ ä»»åŠ¡.
<Route path=":userId" element={<Profile />} />

// æˆ‘ä»¬æ¥ä¼ é€’è‡ªå·±çš„props
<Route path=":userId" element={<Profile animate={true} />} />

// è·å–è·¯ç”±å‚æ•°å’Œè·¯ç”±å®šä½ä¿¡æ¯
function Profile({ animate }) {
  let params = useParams();
  let location = useLocation();
}

// è·¯ç”±åµŒå¥—æ·±å±‚çš„ç»„ä»¶è¿›è¡Œè·³è½¬
function DeepComponent() {
  // ä¸€ä¸ªhooksæå®šï¼
  let navigate = useNavigate();
}
```

å¦å¤–è¯´ä¸€ä¸‹ï¼Œv6ä¸­ä¸ä½¿ç”¨`children`ï¼Œè¿˜æœ‰ä¸ªåŸå› ï¼Œv6åœ¨åµŒå¥—è·¯ç”±ä¸­å·²ç»å°†childrenä½œä¸ºå†…éƒ¨ä¿ç•™å…³é”®å­—äº†ï¼Œè¿™é‡Œå°±ä¸èƒ½å†ç”¨äº†ï¼š[åµŒå¥—è·¯ç”±](https://reactrouter.com/docs/en/v6/getting-started/overview#nested-routes)

### 3. v6å¦‚ä½•å®šä¹‰404é¡µé¢

åœ¨v4ä¸­ï¼Œæ¥æˆ‘ä»¬éœ€è¦å®šä¹‰ä¸€ä¸ªè·¯ç”±ä¹‹å¤–çš„pathï¼Œv5ä¸­å¯ä»¥ä½¿ç”¨`path="*"`ï¼Œv6ä¸­æ²¿ç”¨v5çš„ç”¨æ³•ï¼Œä¸è¿‡æ›´ç®€æ´ï¼š

```jsx
<Route path="*" element={<NoMatch />} />
```

### 4. ä¸ºä»€ä¹ˆæˆ‘çš„`<Route>`ä¸æ¸²æŸ“ï¼Ÿå¥½æ°”ï¼

åœ¨v5ä¸­ï¼Œ`<Route>`ç»„ä»¶å°±æ˜¯ä¸€ä¸ªæ™®é€šçš„Reactç»„ä»¶ï¼ŒURLæ²¡æœ‰åŒ¹é…åˆ°çš„æ—¶å€™ï¼Œå°±ä¼šåƒæ˜¯ifè¯­å¥æ²¡æœ‰è¦†ç›–åˆ°ä¸€æ ·ï¼Œä¸ä¼šæ¸²æŸ“ï¼›åœ¨v6ä¸­ï¼Œ`<Route>`å…ƒç´ å¹¶æ²¡æœ‰çœŸæ­£çš„æ¸²æŸ“å‡ºæ¥ï¼Œä»–åªæ˜¯ä¸€ä¸ªé…ç½®ã€‚æˆ‘ä»¬æ¥ä¸¾ä¾‹å¯¹æ¯”ä¸€ä¸‹ï¼š

v5ä¸­ï¼Œ`<Route>`å°±æ˜¯ä¸€ä¸ªç»„ä»¶ï¼Œå½“åŒ¹é…åˆ°è·¯å¾„`/my-route`æ—¶ï¼Œ`MyRoute`ç»„ä»¶å°±ä¼šè¢«æ¸²æŸ“å‡ºæ¥ï¼š
```jsx
let App = () => (
  <div>
    <MyRoute />
  </div>
);

let MyRoute = ({ element, ...rest }) => {
  return (
    <Route path="/my-route" children={<p>Hello!</p>} />
  );
};
```

v6ä¸­ï¼Œä½ è¦å†è¿™æ ·å†™å°±æ¸²æŸ“ä¸å‡ºæ¥äº†ï¼š
```jsx
// ERROR !!!
let App = () => (
  <Routes>
    <MyRoute />
  </Routes>
);

let MyRoute = () => {
  // <Routes>å¯çœ‹ä¸åˆ°ä½ è¿™é‡Œè¾¹é…ç½®çš„path
  return (
    <Route path="/my-route" children={<p>Hello!</p>} />
  );
};
```
v6çš„æ­£ç¡®å†™æ³•åº”è¯¥éµå¾ªä¸¤ä¸ªåŸåˆ™ï¼š

1. åœ¨`<Routes>`ä¸­åªæ”¾ç½®`<Route>`

2. æŠŠéœ€è¦æ¸²æŸ“çš„éƒ½æ”¾åˆ°`element`ä¸­

ç¤ºä¾‹ï¼š

```jsx
let App = () => (
  <div>
    <Routes>
      <Route path="/my-route" element={<MyRoute />} />
    </Routes>
  </div>
);

let MyRoute = () => {
  return <p>Hello!</p>;
};
```

ä½¿ç”¨`<Routes>`æ¥é™æ€åœ°é…ç½®å…¨å±€è·¯ç”±ï¼Œèƒ½å¤Ÿå‘æŒ¥å‡ºv6æ›´å¤šçš„ç‰¹æ€§ã€‚æˆ‘ä»¬ä¹Ÿé¼“åŠ±å¼€å‘è€…å°†æ‰€æœ‰`<Route>`éƒ½æ”¾åˆ°ä¸€ä¸ª`<Routes>`æ¥é…ç½®è·¯ç”±ã€‚å¦‚æœä½ çœŸçš„æƒ³è¦ä¸ªæ€§åŒ–çš„åŒ¹é…ç‹¬ç«‹URLçš„ç»„ä»¶ï¼Œä½ å¯ä»¥åƒä¸‹é¢è¿™æ ·ä¹¦å†™ï¼š

```jsx
function MatchPath({ path, Comp }) {
  let match = useMatch(path);
  return match ? <Comp {...match} /> : null;
}

// åŒ¹é…ä»»ä½•åœ°æ–¹çš„ç»„ä»¶ï¼Œä¸ä¸€å®šæœ‰ <Routes> åŒ…è£¹
<MatchPath path="/accounts/:id" Comp={Account} />;
```

### 5. è·¯ç”±æ ‘æ„å»ºçš„è¿ç§»å·¥ä½œ

åœ¨v5ç‰ˆæœ¬ä¸­ï¼Œä½ å¯ä»¥ä½¿ç”¨`<Route>`å’Œ`<Switch>`æ ‡ç­¾æ¥å¤„ç†è·¯ç”±åµŒå¥—é—®é¢˜ï¼š

```jsx
// è·¯ç”±æ ‘é¡¶éƒ¨
<Switch>
  <Route path="/users" component={Users} />
</Switch>;

// è·¯ç”±æ ‘ä¸­æŸä¸ªåœ°æ–¹
function Users() {
  return (
    <div>
      <h1>Users</h1>
      <Switch>
        <Route path="/users/account" component={Account} />
      </Switch>
    </div>
  );
}
```

v6ä¸­çš„ä½¿ç”¨åŸºæœ¬ç±»ä¼¼ï¼Œå°†`Switch`æ¢æˆ`Routes`ã€‚ä¸è¿‡éœ€è¦æ³¨æ„ä»¥ä¸‹ä¸¤ç‚¹ï¼š

1. åœ¨çˆ¶è·¯ç”±çš„pathé…ç½®ä¸­ï¼Œéœ€è¦åŠ å…¥`/*`æ¥åŒ¹é…elementä¸­é…ç½®çš„å­è·¯ç”±

2. åµŒå¥—è·¯ç”±ä¸­ä¸éœ€è¦è·å–å®Œæ•´çš„è·¯å¾„ï¼Œv6æ”¯æŒç›¸å¯¹è·¯å¾„

ç¤ºä¾‹ï¼š
```jsx
// é¡¶å±‚è·¯ç”±
<Routes>
  <Route path="/users/*" element={<Users />} />
</Routes>;

// è·¯ç”±æ ‘ä¸­æŸä¸ªåœ°æ–¹
function Users() {
  return (
    <div>
      <h1>Users</h1>
      <Routes>
        <Route path="account" element={<Account />} />
      </Routes>
    </div>
  );
}
```

å¦ï¼Œåœ¨v5ä¸­å¦‚æœæœ‰æ¸¸ç¦»çš„`<Route>`ï¼Œåœ¨è¿ç§»æ—¶éœ€è¦ç”¨`<Routes>`åŒ…è£¹ï¼š
```jsx
// v5
<Route path="/contact" component={Contact} />

// v6
<Routes>
  <Route path="contact" element={<Contact />} />
</Routes>
```

### 6. v6è¿˜èƒ½ä½¿ç”¨æ­£åˆ™åŒ¹é…å—ï¼Ÿ

v6ä¸­å·²ç»ç§»é™¤äº†æ­£åˆ™åŒ¹é…~~ æœ‰ä»¥ä¸‹ä¸¤ä¸ªåŸå› ï¼š

1. æ­£åˆ™è·¯ç”±åœ¨ä½¿ç”¨ä¸­é€ æˆäº†å¾ˆå¤šä¼˜å…ˆçº§åŒ¹é…çš„é—®é¢˜ï¼Œå› ä¸ºæ­£åˆ™æ˜¯æ²¡æœ‰ä¼˜å…ˆçº§è¿™ä¸ªæ¦‚å¿µçš„

2. æ­£åˆ™åŒ¹é…çš„ä¾èµ–åŒ…å¤ªå¤§äº†ï¼Œå¦‚æœå†æ”¾å›æ¥ï¼Œv6çš„ä½“ç§¯ä¼šå¢åŠ 1/2ï¼ˆå³æ­£åˆ™å ç”¨1/3ï¼‰

åœ¨è°ƒç ”è¿‡å¤§é‡çš„ç”¨ä¾‹åï¼Œæˆ‘ä»¬å‘ç°ï¼Œå®Œå…¨å¯ä»¥è§„é¿æ‰ç›´æ¥ä½¿ç”¨æ­£åˆ™æ¥åŒ¹é…è·¯ç”±ã€‚æ‰€ä»¥ï¼Œå†ä¸‰æƒè¡¡ä¹‹ä¸‹ï¼Œæˆ‘ä»¬åšäº†è¿™ä¸ªé‡è¦çš„åˆ å‡ï¼Œæ¥ç¼©å°React Routerçš„ä½“ç§¯å’Œè§„é¿å·²çŸ¥çš„ä¼˜å…ˆçº§é—®é¢˜ã€‚

ä¸€èˆ¬æ¥è¯´ï¼Œæ­£åˆ™è·¯ç”±ä»…ä»…æ˜¯ç”¨æ¥åŒ¹é…ä¸€ä¸ªURLå­—ç¬¦ä¸²ç‰‡æ®µï¼Œå®ç°å¦‚ä¸‹åŠŸèƒ½ï¼š

1. åŒ¹é…å¤šä¸ªé™æ€å€¼
ä¸¾ä¾‹ï¼ˆv5ï¼‰ï¼š
```jsx
// v5-lang-route.js
function App() {
  return (
    <Switch>
      <Route path={/(en|es|fr)/} component={Lang} />
    </Switch>
  );
}

function Lang({ params }) {
  let lang = params[0];
  let translations = I81n[lang];
  // ...
}
```
è¿™äº›å­—ç¬¦ä¸²éƒ½æ˜¯é™æ€å†™å…¥çš„è·¯å¾„ï¼Œåœ¨v6ä¸­ï¼Œå®Œå…¨å¯ä»¥ç”¨ä¸‰ä¸ª`Route`ä»£æ›¿ï¼Œå¦‚æœæœ‰å¾ˆå¤šè¦åŒ¹é…çš„ï¼Œæ”¾åœ¨æ•°ç»„é‡Œæ¥ä¸ªéå†å°±è¡Œï¼š
```jsx
// v6-lang-route.js
function App() {
  return (
    <Routes>
      <Route path="en" element={<Lang lang="en" />} />
      <Route path="es" element={<Lang lang="es" />} />
      <Route path="fr" element={<Lang lang="fr" />} />
    </Routes>
  );
}

function Lang({ lang }) {
  let translations = I81n[lang];
  // ...
}
```

2. æ ¡éªŒå‚æ•°ï¼ˆæ¯”å¦‚æ˜¯ä¸æ˜¯numberç±»å‹ï¼‰

ä¸¾ä¾‹ï¼ˆv5ï¼‰ï¼š
```jsx
// v5-userId-route.js
function App() {
  return (
    <Switch>
      <Route path={/users/(\d+)/} component={User} />
    </Switch>
  );
}

function User({ params }) {
  let id = params[0];
  // ...
}
```
åœ¨v6ä¸­éœ€è¦åšä¸€ç‚¹å¾®é‡çš„å·¥ä½œæ¥å®ç°è¿™ç§æ ¡éªŒï¼š
```jsx
// v6-userId-route.js
function App() {
  return (
    <Routes>
      <Route path="/users/:id" element={<ValidateUser />} />
      <Route path="/users/*" element={<NotFound />} />
    </Routes>
  );
}

function ValidateUser() {
  let params = useParams();
  let userId = params.id.match(/\d+/);
  if (!userId) {
    return <NotFound />;
  }
  return <User id={params.userId} />;
}

function User(props) {
  let id = props.id;
  // ...
}
```

åœ¨v5ä¸­ï¼Œå¦‚æœæ­£åˆ™è·¯ç”±ä¸èƒ½åŒ¹é…ä»»ä½•ä¸€ä¸ªURLæ—¶ï¼Œ`<Switch>`ä¼šå°è¯•åŒ¹é…æ¥ä¸‹æ¥çš„è·¯ç”±ï¼š
```jsx
// v5-switch.js
function App() {
  return (
    <Switch>
      <Route path={/users/(\d+)/} component={User} />
      <Route path="/users/new" exact component={NewUser} />
      <Route
        path="/users/inactive"
        exact
        component={InactiveUsers}
      />
      // 'users/abc' ä¼šåŒ¹é…åˆ°è¿™é‡Œ
      <Route path="/users/*" component={NotFound} />
    </Switch>
  );
}
```

åœ¨v6ä¸­å°±ä¸ç”¨æ‹…å¿ƒè¿™ç§é—®é¢˜ï¼Œåœ¨ä¸‹è¾¹çš„ä¾‹å­ä¸­ï¼Œç”±äºv6çš„ç²¾ç¡®åŒ¹é…æœºåˆ¶ï¼Œ`:userId`ä¼šä¼˜å…ˆè¢«åŒ¹é…æ‰ï¼Œæ ¡éªŒçš„å·¥ä½œæ˜¯åœ¨åŒ¹é…åˆ°ä¹‹ååœ¨å­ç»„ä»¶å†…è¿›è¡Œçš„ï¼Œè€Œä¸æ˜¯é€šè¿‡æ ¡éªŒæ¥åŒ¹é…ã€‚
```jsx
// v6-ranked.js
function App() {
  return (
    <Routes>
      // '/users/123', '/users/abc' éƒ½ä¼šåŒ¹é…åˆ°
      <Route path="/users/:id" element={<ValidateUser />} />
      // '/users/new' æ‰èƒ½åŒ¹é…åˆ°
      <Route path="/users/new" element={<NewUser />} />
      <Route
        path="/users/inactive"
        element={<InactiveUsers />}
      />
    </Routes>
  );
}
```

äº‹å®ä¸Šï¼Œ å¦‚æœä½¿ç”¨è€…æ²¡æœ‰æŒ‰ç…§æ­£ç¡®çš„é¡ºåºå¸ƒå±€è‡ªå·±çš„è·¯ç”±æ—¶ï¼Œv5ä¸­ç¡®å®ä¼šå­˜åœ¨è·¯ç”±ä¼˜å…ˆçº§é”™ä¹±çš„é—®é¢˜ã€‚v6å¼•å…¥äº†ç²¾å‡†åŒ¹é…è§£å†³äº†è¿™ä¸ªé—®é¢˜ã€‚

<hr />

å¦‚æœä½ æ˜¯ç”¨çš„æ˜¯`Remix`ï¼Œåœ¨è·¯ç”±æ²¡æœ‰åŒ¹é…åˆ°æ—¶ï¼Œä½ å¯ä»¥è¿”å›å¸¦`40x`çŠ¶æ€ç çš„Loaderï¼Œç”±äºLoaderè¿è¡Œåœ¨æœåŠ¡ç«¯ï¼Œæ‰€ä»¥è¿™å°†ä¼šå‡å°‘å‰ç«¯ä»£ç æ‰“åŒ…çš„ä½“ç§¯ï¼š
```jsx
// remix-useLoaderData.js
import { useLoaderData } from "remix";

export async function loader({ params }) {
  if (!params.id.match(/\d+/)) {
    throw new Response("", { status: 400 });
  }

  let user = await fakeDb.user.find({
    where: { id: params.id },
  });
  if (!user) {
    throw new Response("", { status: 404 });
  }

  return user;
}

function User() {
  let user = useLoaderData();
  // ...
}
```

ä¸åŒäºç›´æ¥æ¸²æŸ“ç»„ä»¶ï¼Œremixä¼šæ¸²æŸ“æœ€è¿‘çš„[catch boundary](https://remix.run/docs/en/v1/api/conventions#catchboundary)ã€‚

<hr />

FAQs finished !3e:T36b8,> ä¸“æ è¯´æ˜ï¼šå¯¹äºreact-router v6ç‰ˆæœ¬ï¼Œæœ‰åŒäº‹ååº”ç¼ºå°‘ç›¸å¯¹å®Œæ•´çš„ä¸­æ–‡æ–‡æ¡£ï¼ŒæŸ¥çœ‹ä¸æ–¹ä¾¿ã€‚ä¸ºäº†ä¾¿äºä½¿ç”¨ï¼Œä½œè€…å¯¹[å®˜ç½‘æ–‡æ¡£](https://reactrouter.com/docs/en/v6)è¿›è¡Œé’ˆå¯¹æ€§ç¿»è¯‘ï¼Œä¾¿äºv6ç‰ˆæœ¬æ›´å¹¿æ³›çš„è¢«ä½¿ç”¨ã€‚

## 1. å®‰è£…


æœ¬æ–‡æ¡£ä»‹ç»ä½¿ç”¨åŸºäºReactæ¡†æ¶çš„ä¸åŒæ„å»ºå·¥å…·æ¥é…ç½®React Routerçš„ä¸€èˆ¬æ–¹æ¡ˆã€‚

### åŸºç¡€å®‰è£…

> åŸæ–‡è·¯å¾„ https://reactrouter.com/docs/en/v6/getting-started/installation#basic-installation

å¤§å¤šæ•°Reactå·¥ç¨‹é¡¹ç›®éƒ½ä½¿ç”¨åŒ…ç®¡ç†å™¨[npm](https://www.npmjs.com/) æˆ–è€…Â [Yarn](https://yarnpkg.com/)è¿›è¡Œä¾èµ–ç®¡ç†ã€‚ä½¿ç”¨React Routerå‰çš„ç¬¬ä¸€ä»¶äº‹æƒ…ï¼Œå°±æ˜¯åŸºäºä½ çš„åŒ…ç®¡ç†å·¥å…·è¿›è¡ŒReact Routerçš„å®‰è£…ã€‚

1. npm

```sh
$ npm install react-router-dom@6
```
2. yarn

```sh
$ yarn add react-router-dom@6
```
3. pnpm

```sh
$ pnpm add react-router-dom@6
```

### åŸºäºCreate-react-appé¡¹ç›®çš„å®‰è£…

> åŸæ–‡è·¯å¾„ https://reactrouter.com/docs/en/v6/getting-started/installation#create-react-app

å½“ä½ åœ¨craé¡¹ç›®ä¸­å®‰è£…å¥½ä¾èµ–åï¼Œæ‰“å¼€æ–‡ä»¶`src/index.js`ï¼Œ ä»Â `react-router-dom`Â å¼•å…¥ `BrowserRouter`ï¼Œ å¹¶ä½¿ç”¨æ ‡ç­¾`<BrowserRouter>`åŒ…è£¹æ–‡ä»¶:


```jsx
import * as React from "react";
import ReactDOM from "react-dom/client";
import { BrowserRouter } from "react-router-dom";
import "./index.css";
import App from "./App";
import reportWebVitals from "./reportWebVitals";

const root = ReactDOM.createRoot(
  document.getElementById("root")
);
root.render(
  <React.StrictMode>
    <BrowserRouter>
      <App />
    </BrowserRouter>
  </React.StrictMode>
);
```

æ¥ä¸‹æ¥ä½ å°±å¯ä»¥åœ¨appä¸­ä»»æ„åœ°æ–¹ä½¿ç”¨è·¯ç”±äº†ï¼š

```jsx
import * as React from "react";
import { Routes, Route, Link } from "react-router-dom";
import "./App.css";

function App() {
  return (
    <div className="App">
      <h1>Welcome to React Router!</h1>
      <Routes>
        <Route path="/" element={<Home />} />
        <Route path="about" element={<About />} />
      </Routes>
    </div>
  );
}
```
ä¸Šè¿°æ–‡ä»¶ä¸­ï¼ŒHomeå’ŒAboutæ˜¯è‡ªå®šä¹‰çš„è·¯ç”±ç»„ä»¶ï¼Œé€šè¿‡importå¼•å…¥ã€‚

### åŸºäºParcelé¡¹ç›®çš„å®‰è£…

åœ¨package.jsonä¸­æ·»åŠ è„šæœ¬ï¼š

```json
"scripts": {
  "start": "parcel index.html"
}
```

å®‰è£…å®Œä¾èµ–åï¼Œåœ¨æ ¹ç›®å½•ä¸‹æ–°å»ºæ–‡ä»¶`.babelrc`:
```js
{
  "presets": ["@babel/preset-react"]
}
```

ç„¶ååœ¨æ ¹ç›®å½•çš„`index.js`æ–‡ä»¶ä¸­å³å¯ä½¿ç”¨ï¼š
```jsx
import * as React from "react";
import ReactDOM from "react-dom/client";
import { BrowserRouter } from "react-router-dom";
import App from "./App.js";

const root = ReactDOM.createRoot(
  document.getElementById("root")
);
root.render(
  <React.StrictMode>
    <BrowserRouter>
      <App />
    </BrowserRouter>
  </React.StrictMode>
);
```
å†™å…¥æ–‡ä»¶`index.html`ï¼š
```html
<body>
  <noscript
    >You need to enable JavaScript to run this
    app.
  </noscript>
  <div id="root"></div>
  <script src="./index.js"></script>
</body>
```
æ¥ä¸‹æ¥å°±å¯ä»¥åœ¨Appç»„ä»·ä¸­ä½¿ç”¨routeräº†ï¼Œä½¿ç”¨æ–¹å¼åŒcraé¡¹ç›®ã€‚

### åŸºäºWebpacké¡¹ç›®çš„å®‰è£…

> åŸæ–‡è·¯å¾„ https://reactrouter.com/docs/en/v6/getting-started/installation#webpack

webpackæ˜¯ä¸€ç§æ›´ç»†ç²’åº¦çš„æ„å»ºå·¥å…·ï¼Œæ‚¨å¯ä»¥è¿›è¡Œæ›´åŠ ç»†å¾®çš„é…ç½®ã€‚å®‰è£…å®Œå¿…è¦çš„ä¾èµ–åï¼Œä¾¿å¯ä»¥å¼•å…¥è·¯ç”±äº†ï¼š
```jsx
import {
  BrowserRouter,
  Routes,
  Route,
} from "react-router-dom";

function App() {
  return (
    <BrowserRouter>
      <div>
        <h1>Hello, React Router!</h1>
        <Routes>
          <Route path="/" element={<Home />} />
        </Routes>
      </div>
    </BrowserRouter>
  );
}
```

### ä½¿ç”¨scriptæ ‡ç­¾å…¨å±€å®‰è£…

> åŸæ–‡è·¯å¾„ https://reactrouter.com/docs/en/v6/getting-started/installation#html-script-tags

React-router v6ä¸React16.8+å®Œå…¨å…¼å®¹ã€‚æ‚¨å®Œå…¨å¯ä»¥åœ¨ä¸€ä¸ªHTMLä¸­é€šè¿‡`<script>`å¼•å…¥å¯¹åº”çš„jsæ–‡ä»¶è¿›è¡Œå…¨å±€ä½¿ç”¨ï¼šï¼ˆæˆ‘è¿™é‡Œåˆ æ‰äº†åŸæ–‡çš„æ³¨é‡Šï¼‰
```html
<body>
  <div id="root"></div>

  <script src="https://unpkg.com/react@>=16.8/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@>=16.8/umd/react-dom.development.js" crossorigin></script>

  <!-- Load history -->
  <script src="https://unpkg.com/history@5/umd/history.development.js" crossorigin></script>

  <!-- Load React Router and React Router DOM -->
  <script src="https://unpkg.com/react-router@6/umd/react-router.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-router-dom@6/umd/react-router-dom.development.js" crossorigin></script>

  <!-- A simple example app -->
  <script>
  var e = React.createElement;
  var Router = ReactRouterDOM.BrowserRouter;
  var Routes = ReactRouterDOM.Routes;
  var Route = ReactRouterDOM.Route;

  ReactDOM.render(
    (
      e(Router, null, (
        e(Routes, null, (
          e(Route, {
            element: e('div', null, 'Hello, React Router!')
          })
        ))
      ))
    ),
    document.getElementById('root')
  );
  </script>

</body>
```
è™½ç„¶è¿™ç§æ–¹æ³•æ¥å¾—æ¯”è¾ƒå¿«ï¼Œä½†æ˜¯ä¹Ÿå¼•å…¥äº†ä¸€äº›ä¸å¿…è¦çš„ä»£ç å¼•ç”¨ã€‚React RouteråŒ…å«äº†å¾ˆå¤šå°å·¥å…·å’Œç»„ä»¶ï¼ŒæŒ‰éœ€å¼•å…¥æ‰æ˜¯ç‹é“ã€‚æ‰€ä»¥è¿˜æ˜¯æ¨èå‰ä¸‰ç§å®‰è£…æ–¹å¼ã€‚


## 2. å¿«é€Ÿå¼€å§‹ï¼ˆæœ‰ä¸€äº›ä¸å®‰è£…é‡å¤ï¼‰

> åŸæ–‡åœ°å€ https://reactrouter.com/docs/en/v6/getting-started/overview#quick-start-overview

### å¼•å…¥ 

å®‰è£…ä¾èµ–ï¼Œå‰è¾¹å·²ç»æåˆ°ï¼š

```js
npm install react-router-dom@6
```

é…ç½®è·¯ç”±
```jsx
import ReactDOM from "react-dom/client";
import {
  BrowserRouter,
  Routes,
  Route,
} from "react-router-dom";
// import your route components too

const root = ReactDOM.createRoot(
  document.getElementById("root")
);
root.render(
  <BrowserRouter>
    <Routes>
      <Route path="/" element={<App />}>
        <Route index element={<Home />} />
        <Route path="teams" element={<Teams />}>
          <Route path=":teamId" element={<Team />} />
          <Route path="new" element={<NewTeamForm />} />
          <Route index element={<LeagueStandings />} />
        </Route>
      </Route>
    </Routes>
  </BrowserRouter>
);
```
åœ¨v6ä¹‹å‰çš„ç‰ˆæœ¬ï¼Œæœ‰å¤šè·¯ç”±è¦åŒ¹é…æ—¶ï¼Œéœ€è¦åˆç†å®‰æ’å‰åæ”¾ç½®é¡ºåºã€‚åœ¨v6ä¸­ï¼ŒåŒ¹é…æ›´æ™ºèƒ½ï¼Œä¸è¦åœ¨æ‹…å¿ƒé¡ºåºé—®é¢˜äº†ï¼Œä¸¾ä¸ªä¾‹å­ï¼š
```jsx
<Route path="teams/:teamId" element={<Team />} />
<Route path="teams/new" element={<NewTeamForm />} />
```
è·¯ç”±`teams/new`ä¼¼ä¹å¯¹äºä¸Šè¾¹ä¸¤ä¸ªè·¯å¾„éƒ½å¯ä»¥åŒ¹é…ï¼Œä½†æ˜¯ç¬¬äºŒä¸ªæ›´ç²¾ç¡®ï¼Œæ‰€ä»¥v6 routerä¼šé€‰æ‹©ç¬¬äºŒä¸ªNewTeamFormã€‚

### è·¯ç”±è·³è½¬

å¯ä½¿ç”¨`Link`æ ‡ç­¾æ¥ç‚¹å‡»æ”¹å˜URLï¼Œæˆ–è€…ä½¿ç”¨`useNavigate`é’©å­é€šè¿‡ä»£ç è·³è½¬ã€‚

- Link
```jsx
import { Link } from "react-router-dom";

function Home() {
  return (
    <div>
      <h1>Home</h1>
      <nav>
        <Link to="/">Home</Link> |{" "}
        <Link to="about">About</Link>
      </nav>
    </div>
  );
}
```

- navigate
```jsx
import { useNavigate } from "react-router-dom";

function Invoices() {
  let navigate = useNavigate();
  return (
    <div>
      <NewInvoiceForm
        onSubmit={async (event) => {
          let newInvoice = await createInvoice(
            event.target
          );
          navigate(`/invoices/${newInvoice.id}`);
        }}
      />
    </div>
  );
}
```

### è·å–è·¯ç”±å‚æ•°

å¯ä»¥ä½¿ç”¨Â `:style`Â å½¢å¼ä¼ å‚ï¼Œ ä½¿ç”¨Â `useParams()`Â è·å–å‚æ•°ï¼š
```jsx
import { Routes, Route, useParams } from "react-router-dom";

function App() {
  return (
    <Routes>
      <Route
        path="invoices/:invoiceId"
        element={<Invoice />}
      />
    </Routes>
  );
}

function Invoice() {
  let params = useParams();
  return <h1>Invoice {params.invoiceId}</h1>;
}
```
ä¸¾ä¸€ä¸ªé€šè¿‡è·¯ç”±å‚æ•°è·å–å¼‚æ­¥æ•°æ®çš„ä¾‹å­ï¼š
```jsx
function Invoice() {
  let { invoiceId } = useParams();
  // useFakeFetchå¯ä»¥ç†è§£ä¸ºä¸€ä¸ªå¼‚æ­¥è¯·æ±‚
  let invoice = useFakeFetch(`/api/invoices/${invoiceId}`);
  return invoice ? (
    <div>
      <h1>{invoice.customerName}</h1>
    </div>
  ) : (
    <Loading />
  );
}
```

---
> 2023.3.9 è¡¥å……ï¼šè¿™é‡Œé¡ºä¾¿è¡¥å……ä¸€ä¸‹è·å–é—®å·ä¼ å‚çš„æ–¹å¼ï¼Œæ–¹ä¾¿æŸ¥è¯¢

### é—®å·ä¼ å‚è·å–

#### v6 ä¸­

```jsx
// å¼•å…¥
import { useSearchParams } from 'react-router-dom';
...

// è·å–
const [searchParams] = useSearchParams();
// ä½¿ç”¨
const currentType = searchParams.get('type');
```

#### v5ä¸­

v5 ç‰ˆæœ¬æ²¡æœ‰è¿™ä¸ªhookï¼Œéœ€è¦è‡ªå·±å®šä¹‰ä¸€ä¸‹ï¼š

```jsx
// useSearchParams.js
import { useLocation } from "react-router-dom";
import { useMemo } from "react";

/**
 * è·å–å½“å‰é¡µé¢çš„æŸ¥è¯¢å‚æ•°
 */
export default function useSearchParams() {
  const { search } = useLocation();
  return useMemo(() => {
    const urlSearchParams = new URLSearchParams(search);
    let params = {};
    urlSearchParams.forEach((value, key) => {
      params[key] = value;
    });
    return params;
  }, [search]);
}
```

ä½¿ç”¨ï¼š

```jsx
const searchParams = useSearchParams();

console.log(searchParams.type)
```

---


### è·¯ç”±åµŒå¥—

è·¯ç”±åµŒå¥—æ˜¯ä¸€ä¸ªå¾ˆå¼ºå¤§çš„åŠŸèƒ½ï¼Œå¯ä»¥å‡å°‘å†—æ‚çš„å¸ƒå±€ä»£ç ï¼Œé™ä½å¸ƒå±€çš„éš¾åº¦ã€‚å¦‚ä¸‹ä½¿ç”¨ï¼š
```jsx
function App() {
  return (
    <Routes>
      <Route path="invoices" element={<Invoices />}>
        <Route path=":invoiceId" element={<Invoice />} />
        <Route path="sent" element={<SentInvoices />} />
      </Route>
    </Routes>
  );
}
```
åˆ†åˆ«é€šè¿‡å¦‚ä¸‹ä¸‰ç§è·¯å¾„åŒ¹é…ï¼š
-   `"/invoices"`
-   `"/invoices/123"`
-   `"/invoices/sent"`

### Outlet

å¯ä»¥ä½¿ç”¨ä¸€ä¸ªè·¯ç”±å ä½ç¬¦ï¼Œé’ˆå¯¹å¤šåŒ¹é…çš„è·¯ç”±ä½ç½®è¿›è¡Œå¤ç”¨ï¼Œç±»ä¼¼äºvue routerçš„è·¯ç”±æ’æ§½å’ŒAngularçš„`router-outlet`ï¼š
```jsx
import {
  Routes,
  Route,
  Link,
  Outlet,
} from "react-router-dom";

function App() {
  return (
    <Routes>
      <Route path="/" element={<Layout />}>
        <Route path="invoices" element={<Invoices />} />
        <Route path="dashboard" element={<Dashboard />} />
      </Route>
    </Routes>
  );
}

function Layout() {
  return (
    <div>
      <h1>Welcome to the app!</h1>
      <nav>
        <Link to="invoices">Invoices</Link> | {" "}
        <Link to="dashboard">Dashboard</Link>
      </nav>
      <div className="content">
        <Outlet />
      </div>
    </div>
  );
}

function Invoices() {
  return <h1>Invoices</h1>;
}

function Dashboard() {
  return <h1>Dashboard</h1>;
}
```
è¿™æ ·ä¼šæŠŠURLç‰‡æ®µæ„å»ºä¸ºç»„ä»¶æ ‘ï¼Œè·¯ç”±ä¸‹çš„å­è·¯ç”±ä¼šåŠ¨æ€çš„å»æ›¿æ¢æ‰çˆ¶è·¯ç”±çš„`<Outlet />`ï¼Œä»¥æ­¤è¾¾åˆ°åµŒå¥—çš„ç›®çš„ã€‚

### é»˜è®¤è·¯ç”±

å½“ä¸€ä¸ªçˆ¶è·¯ç”±æœ‰å¤šä¸ªå­è·¯ç”±ï¼Œä¸”å½“å‰URLåœç•™åœ¨çˆ¶è·¯ç”±æ—¶ï¼ˆä¸Šä¸ªä¾‹å­ä¸­ï¼Œè·¯ç”±ä¸º'/'æ—¶ï¼Œoutleté‡Œå°±æ— æ³•è¯†åˆ«æ¸²æŸ“ï¼‰ï¼Œç•Œé¢è¯¥å¦‚ä½•æ¸²æŸ“å‘¢ï¼Ÿä½ éœ€è¦ç»™çˆ¶è·¯ç”±è®¾ç½®ä¸€ä¸ªé»˜è®¤æ¸²æŸ“çš„å­è·¯ç”±ã€‚
```jsx
function App() {
  return (
    <Routes>
      <Route path="/" element={<Layout />}>
        <Route index element={<Activity />} />
        <Route path="invoices" element={<Invoices />} />
        <Route path="activity" element={<Activity />} />
      </Route>
    </Routes>
  );
}
```
åŠ ä¸Š`index`å±æ€§åå°±ä¼šé»˜è®¤æ¸²æŸ“è¯¥è·¯ç”±ä¸‹çš„ç»„ä»¶ã€‚è€Œä¸”é»˜è®¤ç´¢å¼•è·¯ç”±å¯ä»¥æ”¾åœ¨è·¯ç”±åµŒå¥—çš„ä»»ä½•ä¸€çº§ä¸­ä½¿ç”¨ã€‚

### åµŒå¥—è·¯ç”±ä¸­ä½¿ç”¨Link

```jsx
...
// <Dashboard />
<nav>
    <Link to="invoices">Invoices</Link>{" "}
    <Link to="team">Team</Link>
</nav>

...
<Routes>
    <Route path="/" element={<Home />} />
    <Route path="dashboard" element={<Dashboard />}>
        <Route path="invoices" element={<Invoices />} />
        <Route path="team" element={<Team />} />
    </Route>
</Routes>

```
åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä¸Šè¿°ä¸¤ä¸ªLinkä¼šè¿æ¥åˆ°`/dashboard/invoices`Â å’ŒÂ `/dashboard/team`ä¸¤ä¸ªåœ°å€ï¼Œè¿™å°±æ˜¯ç›¸å¯¹è·¯ç”±ã€‚

### 404è·¯ç”±

å½“æ²¡æœ‰ä¸€ä¸ªURLåŒ¹é…æ—¶ï¼Œå°±ä¼šæŸ¥æ‰¾æ˜¯å¦é…ç½®äº†é€šç”¨è·¯ç”±`path="*"`ï¼Œä»–å¯ä»¥åŒ¹é…ä»»ä½•å½¢å¼çš„è·¯ç”±ï¼Œå½“æ²¡æœ‰æ›´ç²¾ç¡®çš„è·¯ç”±åŒ¹é…æ—¶ï¼Œå°±è¿›å…¥è¯¥è·¯ç”±çš„é…ç½®ï¼Œè¯¥è·¯ç”±çš„ä¼˜å…ˆçº§æ˜¯æœ€ä½çš„ã€‚

```jsx
function App() {
  return (
    <Routes>
      <Route path="/" element={<Home />} />
      <Route path="dashboard" element={<Dashboard />} />
      <Route path="*" element={<NotFound />} />
    </Routes>
  );
}
```

### å¤šä¸ªè·¯ç”±ç»„

ä¸€ä¸ª`Routes`ç»„ä»¶åŒ…è£¹çš„è·¯ç”±ä¸ºä¸€ç»„ï¼Œv6ä¸­ä½ å¯ä»¥ä½¿ç”¨å¤šä¸ª`Routes`ã€‚æ¯ä¸€ä¸ª`<Routes>`éƒ½æ˜¯ç‹¬ç«‹çš„ï¼Œåˆ†åˆ«è¿›è¡Œè·¯ç”±åŒ¹é…ï¼Œå…¶éƒ½æ˜¯ç›¸å¯¹äºè·Ÿè·¯ç”±çš„ä¸€ä¸ªé“¾æ¥ã€‚
```jsx
function App() {
  return (
    <div>
      <Sidebar>
        <Routes>
          <Route path="/" element={<MainNav />} />
          <Route
            path="dashboard"
            element={<DashboardNav />}
          />
        </Routes>
      </Sidebar>

      <MainContent>
        <Routes>
          <Route path="/" element={<Home />}>
            <Route path="about" element={<About />} />
            <Route path="support" element={<Support />} />
          </Route>
          <Route path="dashboard" element={<Dashboard />}>
            <Route path="invoices" element={<Invoices />} />
            <Route path="team" element={<Team />} />
          </Route>
          <Route path="*" element={<NotFound />} />
        </Routes>
      </MainContent>
    </div>
  );
}
```

### å¤šçº§Routesæ—¶æ³¨æ„äº‹é¡¹

å½“å­ç»„ä»¶ä¹Ÿä½¿ç”¨äº†`Routes`æ—¶ï¼Œéœ€è¦åœ¨å…¶ä¸Šä¸€çº§çˆ¶è·¯ç”±åè¾¹è¿½åŠ `/*`ï¼Œè¿½åŠ çš„`*`çš„å±‚çº§æ•°å–å†³äºä½ å­è·¯ç”±çš„å±‚çº§æ•°ã€‚
```jsx
function App() {
  return (
    <Routes>
      <Route path="/" element={<Home />} />
      // ä¸åŠ *ä¼šåŒ¹é…ä¸åˆ°Dashboardä¸­çš„å­è·¯ç”±
      <Route path="dashboard/*" element={<Dashboard />} />
    </Routes>
  );
}

function Dashboard() {
  return (
    <div>
      <p>Look, more routes!</p>
      <Routes>
        <Route path="/" element={<DashboardGraphs />} />
        <Route path="invoices" element={<InvoiceList />} />
      </Routes>
    </div>
  );
}
```

å¸¸ç”¨é…ç½®ä»‹ç»å®Œæ¯•äº†ã€‚æºæ–‡æ¡£çš„[Tutorial](https://reactrouter.com/docs/en/v6/getting-started/tutorial)æ„Ÿè§‰ä¸æœ¬ç« åŸºæœ¬ç±»ä¼¼ï¼Œæˆ‘æ‰“ç®—è·³è¿‡ä»–ï¼Œä¸‹ä¸€ç« è®²è§£FAQsã€‚3f:T19bb,## 1. å‰è¨€

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æ‰¿æ¥ä¸Šä¸€ç¯‡[# æ‰‹æŠŠæ‰‹æ­å»ºåŸºäºReactçš„å‰ç«¯UIåº“ ï¼ˆä¸‰ï¼‰-- åŸºç¡€ç»„ä»¶Iconå’ŒButton](https://juejin.cn/post/7076668781044924453)ã€‚æˆ‘ä»¬ç»§ç»­æ·»åŠ ç»„ä»¶ï¼Œæœ¬æ¬¡è®°å½•çš„æ˜¯å¸ƒå±€ç»„ä»¶Boxå’ŒCombineã€‚

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æœ¬æ–‡çš„ä»£ç å±•ç¤ºçš„æ˜¯ä¸»è¦çš„æ ¸å¿ƒç¤ºæ„ä»£ç ï¼Œå…¨éƒ¨ä»£ç è§ä»“åº“ï¼š[Githubä»“åº“](https://github.com/heiheihoho1213/dux-ui)


## 2. Box

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å…³äºé¡µé¢å¸ƒå±€ï¼Œæœ€æµè¡Œçš„ä¾¿æ˜¯flexå¸ƒå±€ï¼ŒBoxç»„ä»¶ä¾¿æ˜¯å¯¹flexå¸ƒå±€è¿›è¡Œçš„ä¸€æ¬¡å°è£…ã€‚åºŸè¯ä¸å¤šè¯´ï¼Œä¸Šä»£ç ã€‚åœ¨`src/component`æ–‡ä»¶å¤¹ä¸‹æ–°å»ºæ–‡ä»¶å¤¹`Box`ï¼Œåœ¨å…¶ä¸­æ–°å»ºæ–‡ä»¶`index.tsx`ï¼š

```tsx
export interface BoxProps {
  children?: ReactNode;
  direction?: 'row' | 'row-reverse' | 'column' | 'column-reverse';
  wrap?: 'nowrap' | 'wrap' | 'wrap-reverse';
  alignItems?: 'center' | 'flex-start' | 'flex-end' | 'stretch';
  alignContent?: 'center' | 'flex-start' | 'flex-end' | 'space-between' | 'space-around';
  justifyContent?:
    | 'center'
    | 'flex-start'
    | 'flex-end'
    | 'space-between'
    | 'space-around'
    | 'stretch';
  padding?: number | string;
  width?: string;
  height?: string;
  flex?: string;
}

class Box extends PureComponent<BoxProps> {
  render() {
    const box = <BoxWrap {...this.props} />;

    return box;
  }
}

...

```
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ä¸Šè¾¹å®šä¹‰äº†ä¸€äº›æ¥æ”¶å‚æ•°ï¼Œå…¶ä¸flexçš„csså‚æ•°æ˜¯å¯¹åº”çš„ï¼Œæˆ‘ä»¬å°±æ¯ä¸€ä¸ªå…·ä½“çš„å‚æ•°ï¼Œåœ¨ä»£ç é‡Œè¿›è¡Œå®ç°ä¾¿å¯ä»¥å®Œæˆè¯¥ç»„ä»¶äº†ã€‚æ¥ä¸‹æ¥å®ç°`BoxWrap`ç»„ä»¶ï¼š


```tsx
import styled from '@emotion/styled';
import { css } from '@emotion/core';

export const BoxWrap = styleWrap({
  className: prefixCls,
})(
  styled('div')((props: any) => {
      // è¦å®ç°çš„å†…å®¹
  }),
);
```
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æ¶å­å·²ç»æ­èµ·æ¥ï¼Œè€æ ·å­ï¼Œä»ç„¶ä½¿ç”¨styleWrapåŒ…è£¹ä¸€å±‚å…¬å…±æ ·å¼ï¼Œå†…éƒ¨ç”¨ä¸€ä¸ªdivæ‰¿æ¥ï¼Œä¸­é—´è¦å®ç°çš„å†…å®¹åº”è¯¥è¿”å›è¦ä½¿ç”¨çš„cssï¼Œè¿™è¾¹æ˜¯æ ¸å¿ƒå†…å®¹ï¼š


```tsx
...
const {
    children,
    direction,
    wrap,
    justifyContent,
    alignItems,
    alignContent,
    span,
    flex,
    width,
    height,
    padding,
} = props;

...

return css`
    box-sizing: border-box;
    
    // direction
    ${direction != null &&
      css`
        flex-direction: ${direction};
      `}

    // wrap
    ${wrap != null &&
      css`
        flex-wrap: ${wrap};
      `}
      
    // justifyContent
    ${justifyContent != null &&
      css`
        justify-content: ${justifyContent};
      `}
      
    // ...
`
```
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å¯ä»¥çœ‹åˆ°ï¼Œåªæ˜¯ç®€å•åŠ ä¸€ä¸ªcssä¾¿å¯ä»¥å®ç°ï¼Œç›¸å½“ç®€å•ã€‚éœ€è¦è§£é‡Šçš„æ˜¯childrençš„å±æ€§å¹¶æ²¡æœ‰å…¬å¼€å£°æ˜ï¼Œè€Œæ˜¯ä¼ é€’ç»™`styled`ç”Ÿæˆçš„ç»„ä»¶åéšå¼çš„æ¸²æŸ“äº†ã€‚

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;åˆ›å»ºå®Œæ¯•åï¼Œåœ¨ç»„ä»¶å¤–ä¾¿å¯ä»¥è¿™æ ·å®ç°ï¼š


```tsx
<Box direction="column" justifyContent="center">
    <div>1</div>
    <div>2</div>
    <div>3</div>
</Box>
```

## 3. Combine
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Combineç»„ä»¶ç”¨äºç»„åˆä¸åŒçš„ç»„ä»¶ï¼Œç±»ä¼¼Boxï¼Œä»ç„¶æ˜¯æ ·å¼ä¸ºä¸»çš„ç»„ä»¶ï¼Œæ˜¯ä¸ºäº†å¸ƒå±€æ–¹ä¾¿çš„ï¼Œå¯¹cssè¿›è¡Œçš„å°è£…ã€‚æˆ‘ä»¬ä¸ä½¿ç”¨flexï¼Œä½¿ç”¨ä¸€ä¸ªå¤§divåŒ…è£¹ä¸€å †inline-blockå…ƒç´ å³å¯ã€‚åœ¨`src/components`ä¸‹æ–°å»ºæ–‡ä»¶å¤¹`Combine`ï¼Œåœ¨æ–‡ä»¶å¤¹ä¸‹æ–°å»ºæ–‡ä»¶`index.tsx`ï¼š


```tsx
const Combine = ({
  children,
  sharedProps = {},
  spacing = 'smart',
  separator,
  ...rest
}: CombineProps) => {
  const { size = 'md' } = sharedProps;
  let isFirstItem: boolean;
  return (
    <CombineWrap spacing={spacing} {...rest}>
        {React.Children.map(children, (child) => (
            // éå†child
            <>
                // æ”¾ç½®åˆ†éš”ç¬¦
                {separator && !isFirstItem ? <span className={separatorCls} key="separator">
                    {separator}
                  </span> : null
                }
                // æ”¾ç½®å­å…ƒç´ 
                <div className={itemCls}>
                    {React.cloneElement(child)}
                    ...
                </div>
            </>
          )
        )}
    </CombineWrap>
  )
}
```
ä¸Šè¾¹ä»£ç ä¸­å®šä¹‰äº†å­å…ƒç´ å’Œåˆ†éš”ç¬¦çš„ç±»ï¼š

```tsx
export const itemCls = prefixCls + '-item';
export const separatorCls = prefixCls + '-separator';
```

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ç»„ä»¶æ¥æ”¶spacingå‚æ•°æ¥æ§åˆ¶ç›¸å…³è”ç»„ä»¶ä¹‹é—´çš„è·ç¦»ï¼ŒåŒæ—¶è¿˜å¯ä»¥è®¾ç½®separatoræ¥ä½œä¸ºè‡ªå®šä¹‰åˆ†éš”ç¬¦ã€‚æ¥çœ‹ä¸€ä¸‹ç»„ä»¶`CombineWrap`çš„å®ç°ï¼š

```tsx
import styled from '@emotion/styled';
import { css } from '@emotion/core';

export const CombineWrap = styledWrap<{ spacing: string }>({
  // æ¥å—è‡ªå®šä¹‰class
  className: prefixCls,
})(
  // ç”Ÿæˆä¸€ä¸ªè‡ªå®šä¹‰æ ·å¼åŒ…è£¹çš„div
  styled('div')((props) => {
    const {
      spacing,
      theme: { designTokens: DT },
    } = props;
    
    // spacingMapä¸ºdesignTokensé‡Œå®šä¹‰çš„å¸¸é‡
    const space = (DT as any)[spacingMap[spacing]];

    return css`
      display: inline-block;  // inlinkä½¿å¾—å„ä¸ªå­å…ƒç´ å¹³é“ºæ’åˆ—
      vertical-align: middle;
      
      // å­å…ƒç´ æ ·å¼
      > .${itemCls} { 
        &:focus {
          z-index: 2;
        }
        &:hover {
          z-index: 3;
        }
      }
      
      // å­å…ƒç´ ä¸‹ä¸€ä¸ªå…„å¼Ÿï¼Œåˆ†éš”ç¬¦ä¸‹ä¸€ä¸ªå­å…ƒç´ ï¼Œå­å…ƒç´ ä¸‹ä¸€ä¸ªåˆ†éš”ç¬¦ ç»Ÿä¸€éƒ½åŠ ä¸Šå·¦è¾¹è·ï¼Œè¿™é‡Œå°±æ˜¯spaceçš„ç”¨æ³•
      > .${itemCls}+.${itemCls}, > .${separatorCls}+.${itemCls}, > .${itemCls}+.${separatorCls} {
        margin-left: ${space};
      }
    `;
  }),
);

```

å…³äºspacingå¸¸é‡ï¼Œå¯ä»¥åœ¨themeä¸»ä½“ä¸­å®šä¹‰å¸¸é‡ï¼š

```js
T_SPACING_COMMON_XS: '4px',
T_SPACING_COMMON_SM: '8px',
T_SPACING_COMMON_MD: '12px',
T_SPACING_COMMON_LG: '16px',
T_SPACING_COMMON_XLG: '20px',
T_SPACING_COMMON_XXLG: '24px',
T_SPACING_COMMON_XXXLG: '32px',
```

ç„¶åæˆ‘ä»¬åœ¨é¡¹ç›®ä¸­ä½¿ç”¨ä¸€ä¸‹ï¼š

```tsx
<Combine>
  <Button styleType="primary">æŒ‰é’®ç»„å±•ç¤º</Button>
  <Button>æŒ‰é’®ç»„å±•ç¤º</Button>
  <Button>æŒ‰é’®ç»„å±•ç¤º</Button>
  <Button disabled>æŒ‰é’®ç»„å±•ç¤º</Button>
</Combine>
```


è‡³æ­¤ï¼Œå¸ƒå±€ç»„ä»¶`Box`å’Œ`Combine`å·²ç»ä»‹ç»å®Œæ¯•~  æ›´å¤šç»„ä»¶å‚ç…§ä»£ç ä»“åº“ï¼š[Githubä»“åº“](https://github.com/heiheihoho1213/dux-ui)

### å‚è€ƒ

[React-components](https://ucloud-fe.github.io/react-components/)

[Antdä¹‹Spaceå’ŒGrid](https://ant.design/components/grid-cn/)40:T3b59,## 1. å‰è¨€

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æ‰¿æ¥ä¸Šä¸€ç¯‡[æ‰‹æŠŠæ‰‹æ­å»ºåŸºäºReactçš„å‰ç«¯UIåº“ï¼ˆäºŒï¼‰-- ä¸»é¢˜é…ç½®](https://juejin.cn/post/7076652936331280421/)ã€‚åœ¨ä¸»é¢˜é…ç½®ä¹‹åï¼Œæˆ‘ä»¬ç€æ‰‹å†™ä¸€äº›åŸºç¡€ç»„ä»¶ä»¥åŠå…¶å‘¨è¾¹çš„é…ç½®å·¥å…·ã€‚ï¼ˆæœ¬æœŸç”¨åˆ°çš„styleWrapçš„å®šä¹‰å¯æŸ¥çœ‹ä¸ŠæœŸï¼‰

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æœ¬æ–‡çš„ä»£ç å±•ç¤ºçš„æ˜¯ä¸»è¦çš„æ ¸å¿ƒä»£ç ï¼Œå…¨éƒ¨ä»£ç è§ä»“åº“ï¼š[Githubä»“åº“](https://github.com/heiheihoho1213/dux-ui)


## 2. Icon

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å›¾æ ‡çš„è®¾è®¡æ˜¯ä¸ªæŠ€æœ¯æ´»ï¼Œéœ€è¦è®¾è®¡å‡ºè‡ªå·±ä¸“å±çš„é£æ ¼ï¼Œå°±åƒä¸Šä¸€æœŸä¸€å¼€å§‹è®²çš„é‚£æ ·ï¼ŒStyleé£æ ¼è®¾è®¡æ˜¯ä¸‰è¦ç´ ä¹‹é¦–ã€‚åŸºç¡€ç»„ä»¶è®¾è®¡ï¼Œæ¯”å¦‚æŒ‰é’®æ˜¯æ‰å¹³è¿˜æ˜¯ç«‹ä½“ï¼Œè¾“å…¥æ¡†æ˜¯æ–¹è§’è¿˜æ˜¯åœ†è§’ï¼ŒåŠ ä¸åŠ é˜´å½±ç­‰è¿™äº›ï¼Œå—é¡¹ç›®ç»ç†. äº§å“å’Œäº¤äº’çš„å½±å“ä¼šå¤šä¸€ç‚¹ï¼Œä½†æ˜¯å¤§ä½“æ¥è¯´ï¼Œåº”ä¸å…¬å¸åŒç±»äº§å“ä¿æŒä¸€è‡´ï¼Œè‡³äºå¦‚ä½•è®¾è®¡ï¼Œé‚£å°±æ˜¯å¦å¤–çš„è¯¾é¢˜äº†ï¼Œä¸åœ¨æœ¬æ–‡çš„è®¨è®ºä¹‹åˆ—ã€‚

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æœ¬æ–‡ä¸­çš„Iconå›¾æ ‡ä½¿ç”¨å­—ä½“åº“æ¥å®Œæˆï¼Œé€šè¿‡CSSæ— ä¾µå…¥å¼çš„åœ¨ä¸€ä¸ªå…ƒç´ ä¸ŠåŠ å…¥`before`æˆ–è€…`after`ä¼ªç±»æ¥å®ç°å›¾æ ‡æ˜¾ç¤ºï¼Œè¿™é‡Œä¸æ˜¯æµè§ˆå™¨çš„å­—ä½“ï¼Œä¹Ÿä¸æ˜¯å®¢æˆ·ç”µè„‘é‡Œå®‰è£…çš„å­—ä½“ï¼Œä¹Ÿä¸æ˜¯å›¾ç‰‡æˆ–å…¶ä»–æ–¹å¼ï¼Œè€Œä¸”æ˜¯ä»¥æ–‡å­—çš„æ–¹å¼æ˜¾ç¤ºï¼Œè¿™æ ·åšç›¸å¯¹æ¯”è¾ƒç®€æ´ï¼Œæ–¹ä¾¿ä¿®æ”¹ï¼Œæ›´é‡è¦çš„æ˜¯åˆ©äºSEOä¼˜åŒ–ã€‚æµè§ˆå™¨å…¼å®¹æ€§æ¯”è¾ƒå¥½çš„å­—ä½“åº“æœ‰`WOFF`. `WOFF2`ç­‰ã€‚å­—ä½“åº“å…¼å®¹æ€§è§[å®˜æ–¹è§£é‡Š](https://developer.mozilla.org/zh-CN/docs/Web/CSS/@font-face)ã€‚å­—ä½“åº“æœ‰ä¸“é—¨çš„è‡ªå®šä¹‰ç”Ÿæˆå·¥å…·ï¼Œä¾‹å¦‚[fonteditor](http://www.fonteditor.com/)ï¼Œå¯ä»¥è¯•ç”¨30å¤©ï¼›è‡³äºå­—ä½“åº“ï¼Œä½ ä¹Ÿå¯ä»¥ä½¿ç”¨ç¬¬ä¸‰æ–¹å¼€æºçš„å­—ä½“åº“ï¼Œä¾‹å¦‚[Font Awesome](https://fontawesome.dashgame.com/)ã€‚è¿™é‡Œä½œè€…å°±ä½¿ç”¨Font Awesomeçš„woffå­—ä½“åº“ï¼Œæˆ‘ä»¬æ‰“å¼€å›¾å½¢åˆ›å»ºå·¥å…·fonteditoræ¥æŸ¥çœ‹è¿™ä¸ªæ–‡ä»¶ï¼š

![image.png](/img/posts/2022-3-19/2022-3-19-6.png)


&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å¯ä»¥çœ‹åˆ°ï¼Œæ¯ä¸€ä¸ªIconéƒ½æœ‰å¯¹åº”çš„`Code-points`ï¼Œè¿™æ ·æˆ‘ä»¬å°±èƒ½é€šè¿‡CSSæ¥é…ç½®å­—ä½“å›¾æ ‡äº†ï¼š

```css
// ä¸Šå›¾ä¸­ç»ç’ƒæ¯
.glass:before {
    content: '\F000';
}
```
è®¾è®¡æ€è·¯æœ‰äº†ï¼Œæ¥ä¸‹æ¥å°±å¼€å§‹åŠ¨å·¥ï¼

### Icon.tsx
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;åœ¨`src/components`æ–‡ä»¶å¤¹ä¸‹ï¼Œæ–°å»ºæ–‡ä»¶å¤¹`Icon`ï¼Œåœ¨è¯¥æ–‡ä»¶å¤¹ä¸‹æ–°å»º`Icon.tsx`ï¼š

```tsx
// å®šä¹‰æ¥æ”¶å‚æ•°
export interface IconProps {
    /** å›¾æ ‡ç±»å‹ */
    type: string;
    /** æ˜¯å¦æ—‹è½¬ */
    spin?: boolean;
    /** è‡ªå®šä¹‰ icon ç±»åå‰ç¼€ï¼Œä½¿ç”¨è‡ªå®šä¹‰å›¾æ ‡åº“æ—¶ä½¿ç”¨ï¼Œé»˜è®¤ä¸º icon\_\_ */
    prefix?: string;
}

// å›¾æ ‡æ§ä»¶
const Icon = ({
    type,
    spin,
    prefix,
    className,
    ...rest
}) => {
    const configContext = useContext(ConfigContext);
    const finalPrefix = useMemo(() => prefix || configContext.iconDefaultPrefix || 'icon__', [
        configContext.iconDefaultPrefix,
        prefix
    ]);
    return (
        <IconWrap
            className={classnames(prefixCls, `${finalPrefix}${type}`, spin && `${prefixCls}-spin`, className)}
            spin={spin}
            {...rest}
        />
    );
};

export default React.memo(Icon);
```
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;è¿™é‡Œå¯ä»¥çœ‹åˆ°ï¼Œæˆ‘åœ¨å…¨å±€`configContext`å®šä¹‰äº†é»˜è®¤çš„å›¾æ ‡ç±»åå‰ç¼€ï¼Œé»˜è®¤ä¸º`icon__`ï¼Œä½ ä¹Ÿå¯ä»¥è‡ªå®šä¹‰ï¼Œåªè¦å’ŒCSSæ ·å¼å¯¹åº”å³å¯ã€‚æœ€åè¿”å›çš„æ˜¯ä¸€ä¸ª`IconWrap`ç»„ä»¶ï¼Œæˆ‘ä»¬åœ¨`Icon`æ–‡ä»¶å¤¹ä¸‹æ–°å»º`style`æ–‡ä»¶å¤¹æ¥æ”¾ç½®æ ·å¼åŒ…è£¹ç±»ï¼Œ`style`ä¸‹è®¾ç½®`font`æ–‡ä»¶å¤¹æ¥å®‰ç½®æˆ‘ä»¬ä¸‹è½½çš„WOFFæ–‡ä»¶ï¼Œå¹¶åœ¨`style`åŒç›®å½•ä¸‹æ–°å»º`icon.css`å’Œ`index.ts`ï¼š

src/components/Icon/style/icon.cssï¼š

```css
/* è‡ªå®šä¹‰ä¸“å±çš„å­—ä½“ç±»å‹ */
@font-face {
    font-family: duiicon;
    /* src: url(./fonts/duiicon.eot?v=1552285261926); */
    src: url(./fonts/fontawesome-webfont.woff) format('woff');
    font-weight: 400;
    font-style: normal;
}

...
/* è®¾ç½®å­—ä½“å¯¹åº”çš„ç±» */
[class*=' icon__']:before,
[class^='icon__']:before {
    display: inline-block;
}
.icon__glass:before {
    content: '\F000';
}
...
```

src/components/Icon/style/index.ts:

```ts
import styled from '@emotion/styled';
import { css } from '@emotion/core';

// spinMixinæ˜¯å…¬å…±çš„æ—‹è½¬æ ·å¼ï¼Œè¯¦è§å…¨éƒ¨ä»£ç 
const iconSpinMixin = css`
    ${spinMixin};
    line-height: normal;
`;

export const IconWrap = styleWrap<{ spin?: boolean }>({})(
    styled('i')(props => {
        const { spin } = props;

        return css`
            vertical-align: baseline;
            &&& {
                ${spin && iconSpinMixin};
            }
        `;
    })
);
```
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ä»ä»£ç ä¸­çœ‹åˆ°ï¼Œè™½ç„¶è¿™é‡Œé¢æ²¡æœ‰ç”¨åˆ°ä¸»é¢˜æ ·å¼çš„å˜é‡ï¼Œä½†ä¸ºäº†é£æ ¼ç»Ÿä¸€ï¼Œè¿™é‡Œç”¨`styleWrap`åŒ…è£¹ä¸€ä¸‹ï¼Œä¸ç»™è¾“å…¥å‚æ•°å³å¯ï¼Œå…¶è¿”å›çš„ä»ç„¶æ˜¯ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œæ¥å—ä¸€ä¸ªå‡½æ•°å¼ç»„ä»¶ä½œä¸ºå‚æ•°ï¼Œè¿™é‡Œä¼ é€’ä¸€ä¸ªiæ ‡ç­¾ï¼š`styled('i')`ï¼Œå‚æ•°`props`æ˜¯ç»„ä»¶`IconWrap`æ¥å—çš„å‚æ•°ï¼Œå¦‚æœæœ‰spinæ—‹è½¬ï¼Œé‚£å°±åŠ ä¸Šæ—‹è½¬çš„æ ·å¼ã€‚

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å…³äºå‰ç¼€çš„æ‹¼æ¥ï¼Œæˆ‘è¿™é‡Œè¯´ä¸€ä¸‹ï¼š

```js
classnames(prefixCls, `${finalPrefix}${type}`, spin && `${prefixCls}-spin`, className)
```
ç¬¬ä¸€æ®µæ˜¯å…¬å…±æ ·å¼ï¼Œè¿™é‡Œä¸º`dux-ui-icon`ï¼Œå¯ä»¥ç†è§£ä¸ºæ¥è‡ªç»„ä»¶åº“çš„æ ‡è¯†ï¼Œä¹Ÿæ–¹ä¾¿ç”¨æˆ·åœ¨ä½¿ç”¨æ—¶æ‰¹é‡æ·»åŠ æ ·å¼ï¼›ç¬¬äºŒæ®µå°±æ˜¯æˆ‘ä»¬ä»£ç ä¸­æ‹¼æ¥çš„`icon__glass`ç­‰ï¼Œç”¨äºå®é™…å›¾æ ‡æ˜¾ç¤ºï¼›ç¬¬ä¸‰æ®µæ˜¯æ—‹è½¬æ ‡è¯†ï¼›ç¬¬å››æ®µæä¾›äº†ç”¨æˆ·è‡ªå®šä¹‰classã€‚

ç°åœ¨ï¼Œä»£ç ç›®å½•ç»“æ„å¦‚ä¸‹ï¼š

![image.png](/img/posts/2022-3-19/2022-3-19-7.png)

å½“ç„¶åˆ«å¿˜äº†åœ¨`src/index`å¯¼å‡ºï¼š

```ts
export { default as Icon } from './components/Icon';
```

### Icon demo

æˆ‘ä»¬åœ¨åŒç›®å½•ä¸‹çš„`index.md`ä¸­å†™ä¸Šdemoç”¨ä¾‹ï¼š

```tsx
import React from 'react';
// dumi-dux-uiè¦ä¸ä½ package.jsonä¸­çš„nameä¸€è‡´
import { Icon } from 'dumi-dux-ui';
import Copy from 'copy-to-clipboard';

// demo start
const layout = {
    style: {
        marginRight: 10
    }
};

const Icons = [
    'glass',
];
const TypeDemo = () => (
    <div style={{ display: "flex" }}>
        {Icons.map(item => (
            <div key={item} style={{ width: '50px', height: '50px', cursor: 'pointer' }} onClick={() => Copy(item)}>
                <Icon type={item} {...layout} />
            </div>
        ))}
    </div>
);
```
ä¿®æ”¹`.umirc.ts`ï¼š

```ts
...
menus: {
    // éœ€è¦è‡ªå®šä¹‰ä¾§è¾¹èœå•çš„è·¯å¾„ï¼Œæ²¡æœ‰é…ç½®çš„è·¯å¾„è¿˜æ˜¯ä¼šä½¿ç”¨è‡ªåŠ¨ç”Ÿæˆçš„é…ç½®
    '/components': [
      {
        title: 'ç»„ä»¶',
        path: '/components',
        children: [
          // èœå•å­é¡¹ï¼ˆå¯é€‰ï¼‰
          'components/Icon/index.md',
        ],
      },
    ],
  },
```

ç„¶ååœ¨æ ¹ç›®å½•ä¸‹æ‰§è¡Œï¼š`npm run docs`ï¼Œæ‰“å¼€æµè§ˆå™¨ï¼Œè¿›å…¥localhost:8000/components/iconå³å¯çœ‹åˆ°ï¼š

![image.png](/img/posts/2022-3-19/2022-3-19-8.png)

æˆ‘ä»¬çš„ç»ç’ƒæ¯å›¾æ ‡åŠ è½½å‡ºæ¥äº†ï¼F12æŸ¥çœ‹å…ƒç´ ï¼Œç¡®å®æ˜¯æˆ‘ä»¬æƒ³è¦çš„åŠ è½½æ–¹å¼ï¼š

![image.png](/img/posts/2022-3-19/2022-3-19-9.png)


> å…³äº @emotionä¸­çš„`styled`å’Œ`css`æ–¹æ³•ï¼Œå¯ä»¥é¿å…ä½¿ç”¨å¤–æŒ‚cssæ–‡ä»¶ï¼ŒåŒæ—¶ç»„ä»¶ä¼ é€’å‚æ•°æ›´åŠ æ–¹ä¾¿ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥å®Œå…¨ä¸ç”¨styledï¼Œå¦‚ä¸‹é¢ä»£ç æ‰€ç¤ºï¼Œå…¶æ•ˆæœæ˜¯ç­‰ä»·çš„ã€‚è¯¦ç»†ä½¿ç”¨å¯ä»¥æŸ¥çœ‹[emotionå®˜ç½‘](http://emotion.sh/docs)


```tsx
function Content(props: any) {
    // propsçš„å±æ€§éœ€è¦ç‰¹æ®Šå¤„ç†ï¼Œå¯ä¼ é€’classNameå±æ€§ï¼Œé€šè¿‡å¤–æŒ‚csså®ç°ç›¸åŒçš„æ ·å¼
    ...
    return <i {...props}></i>
}

export const IconWrap = styleWrap<{ spin?: boolean }>({})(Content);
```

---

## 3. Button

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æŒ‰é’®ä¸€èˆ¬ä¼šåˆ†ç±»åˆ«ï¼Œä¸åŒçš„ç±»åˆ«æœ‰ä¸åŒçš„é¢œè‰²ï¼Œæˆ‘ä»¬åˆ†ä¸ºå®å¿ƒï¼Œè¾¹æ¡†ç©ºå¿ƒå’Œç¦ç”¨ä¸‰ç§æ¨¡å¼ã€‚ä¸‹é¢åˆ—ä¸€ä¸ªè¡¨æ ¼è¯´æ˜æ‰€æœ‰çš„buttonæ ·å¼ï¼š


| ç±»åˆ«åç§° | ç§ç±»åé›†åˆ |
| --- | --- |
| StyleTypes ç§ç±» | ['primary', 'warning', 'success', 'error', 'border', 'border-gray'] |
| Sizes å¤§å° | ['sm', 'md', 'lg'] |
| Shapes å½¢çŠ¶ | ['circle', 'square'] |
| Shadowed é˜´å½± | ['true', 'false'] |
| Loading åŠ è½½ | ['true', 'false'] |
| Disabled ç¦ç”¨ | ['true', 'false'] |
| Block å—çº§æ˜¾ç¤º | ['true', 'false'] |

æˆ‘ä»¬æ ¹æ®ç½—åˆ—çš„ç±»å‹ï¼Œå¼€å§‹æ­å»ºç»„ä»¶ï¼

### æ­å»ºåŸºç¡€

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æˆ‘ä»¬åœ¨`src/components`æ–‡ä»¶å¤¹ä¸‹æ–°å»ºæ–‡ä»¶å¤¹`Button`ï¼Œåœ¨è¯¥ç›®å½•ä¸‹æ–°å»ºæ–‡ä»¶`index.tsx`ï¼š


```tsx
// å®šä¹‰æ¥å—å‚æ•°ï¼Œä¸ºè¡¨æ ¼ä¸­ç½—åˆ—å±æ€§
export interface ButtonProps {
  /** æŒ‰é’®ç±»å‹ */
  styleType?: 'primary' | 'warning' | 'success' | 'error' | 'border' | 'border-gray';
  /** æŒ‰é’®å°ºå¯¸ */
  size?: 'sm' | 'md' | 'lg';
  /** å½¢çŠ¶ */
  shape?: 'circle' | 'square';
  /** é˜´å½± */
  shadowed?: boolean;
  /** ä¸»é¢˜ */
  // theme?: 'dark';
  /** æ˜¯å¦åŠ è½½ä¸­ */
  loading?: boolean;
  /** å›¾æ ‡ */
  icon?: string | ReactNode;
  /** è®¾ç½®åŸç”Ÿçš„ button ä¸Š type å±æ€§ */
  type?: string;
  /** å±•ç¤ºè®¾ç½®ä¸ºå—å…ƒç´  */
  block?: boolean;
}
```
åŒæ ·çš„ï¼Œæˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ªæ ·å¼ç±»åŒ…è£¹ä¸€ä¸‹åŸç”Ÿçš„buttonï¼ˆè¿˜æ˜¯åœ¨è¿™ä¸ªæ–‡ä»¶ï¼‰ï¼š

```tsx
...
render() {
    // eslint-disable-next-line @typescript-eslint/no-unused-vars
    const { loading, icon, children, ...rest } = this.props;

    return (
      <StyleButton loading={loading} {...rest}>
        // renderIconä¸ºæŒ‚è½½æŒ‰é’®å†…å›¾æ ‡çš„å‡½æ•°
        {this.renderIcon()}
        {children}
      </StyleButton>
    );
  }
```
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æ¥ä¸‹æ¥å»åˆ›å»º`StyleButton`ï¼Œä¸Iconåˆ›å»ºä¸€æ ·åœ°ï¼Œæˆ‘ä»¬åœ¨`src/components/Button`æ–‡ä»¶å¤¹ä¸‹æ–°å»º`style`æ–‡ä»¶å¤¹ï¼Œåœ¨è¯¥æ–‡ä»¶å¤¹ä¸‹æ–°å»º`index.tsx`ï¼Œæ ¸å¿ƒä»£ç åœ¨è¿™é‡Œï¼š

```tsx
...
const Button = ({
  loading,
  styleType,
  disabled,
  onClick,
  block,
  shadowed,
  ...rest
}) => (
  <button
    disabled={disabled}
    onClick={!disabled ? onClick : undefined}
    {...rest}
  />
);

export const StyleButton = styleWrap<SButtonProps, HTMLButtonElement>({
  className: classNameMixin,
})(styled(Button)(buttonStyleMixin));

```
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å®šä¹‰ä¸€ä¸ªå«Buttonçš„å‡½æ•°å¼ç»„ä»¶ï¼Œå…¶è¿”å›çš„å°±æ˜¯ä¸€ä¸ªåŸç”Ÿçš„buttonï¼Œæ‰€ä»¥restå‚æ•°é‡Œä½ å¯ä»¥ä¼ é€’åŸç”Ÿçš„å±æ€§ï¼Œæœ€åç”¨styleWrapåŒ…è£¹åå¯¼å‡ºã€‚ä¸Iconä¸åŒçš„æ˜¯ï¼ŒButtonçš„æ ·å¼æ›´å¤šï¼Œè€Œä¸”è¿˜è¦é€‚é…ä¸»é¢˜ã€‚æ‰€ä»¥è¿™é‡Œå¤šäº†ä¸€ä¸ªç±»åå£°æ˜`classNameMixin`å’Œä¸€ä¸ªæ ·å¼å‡½æ•°`buttonStyleMixin`.

classNameMixinï¼š
```tsx
// classNameMixinè´Ÿè´£æ·»åŠ å„ç§ç±»åï¼Œç”¨äºå”¯ä¸€è¯†åˆ«å’Œå¼€å‘è€…è¿›è¡Œå®šåˆ¶
const classNameMixin = ({
  size,
  styleType,
  shape,
  loading,
  disabled,
  checked,
}) =>
  classnames(
    prefixCls,
    `${prefixCls}-size-${size}`,
    `${prefixCls}-styletype-${styleType}`,
    shape && `${prefixCls}-${shape}`,
    loading && `${prefixCls}-loading`,
    disabled && `${prefixCls}-disabled`,
    checked && `${prefixCls}-checked`,
  );
```

buttonStyleMixinæ˜¯ä¸€ä¸ªæ€»å¼€å…³ï¼Œç”¨äºæ·»åŠ å„ç§æ ·å¼ï¼š

```tsx
// buttonStyleMixin
const buttonStyleMixin = (props) => {
  const { theme, loading, shape, checked, block } = props;
  const { designTokens: DT } = theme;
  return css`
    margin: 0;
    box-sizing: border-box;
    border-radius: ${DT.T_CORNER_LG};
    text-align: center;
    text-decoration: none;
    cursor: pointer;
    outline: none;
    font-size: ${DT.T_TYPO_FONT_SIZE_1};
    white-space: nowrap;
    ${inlineBlockWithVerticalMixin};  // å—çº§

    ${sizeMixin(props)};  // å¤§å°
    ${styleTypeMixin(props)};  // styleType
    ${shape && shapeMixin(props)}; // å½¢çŠ¶
    ${loading && loadingMixin(props)};  // åŠ è½½ä¸­
    ${block &&
    css`
      width: 100%;
    `};
  `;
};
```
æ¥ä¸‹æ¥åˆ†åˆ«è®°å½•ä¸Šè¿°å„ä¸ªæ ·å¼å˜é‡ï¼š

sizeMixinï¼š

```tsx
// é€šè¿‡getHeightBySizeæ‹¿åˆ°ä¸»é¢˜é…ç½®æ–‡ä»¶ä¸­çš„å„ä¸ªå¤§å°
...
return css`
    height: ${getHeightBySize(DT, size)};
    line-height: ${getHeightBySize(DT, size)};
    padding: 0 ${getPaddingBySize(DT, size)};
`;
...
```

shapeMixinï¼š

```tsx
...
// ç›®å‰æ”¯æŒåœ†å½¢å’Œæ–¹å½¢
switch (shape) {
    case 'circle':
      return css`
        border-radius: 50% !important;
        padding: 0;
        overflow: hidden;
        width: ${getHeightBySize(DT, size)};
      `;
    case 'square':
      return css`
        padding: 0;
        overflow: hidden;
        width: ${getHeightBySize(DT, size)};
      `;
    default:
      return css``;
}
```

loadingMixinçš„è®¾ç½®ä¹Ÿä¸€æ ·ï¼Œä½¿å¾—é¼ æ ‡ä¸å¯ç‚¹å‡»ï¼Œæš—ç°è‰²æ˜¾ç¤ºå³å¯ã€‚

styleTypeMixinç”¨æ¥é€šè¿‡styleTypeçš„ä¸åŒï¼Œå¯¹åº”çš„è®¾ç½®ä¸åŒçš„ä¸»é¢˜é…è‰²ï¼Œ ä»¥primaryä¸ºä¾‹ï¼š

```tsx
const {
  // æ¥å—ThemeProviderä¼ é€’çš„themeå‚æ•°
  theme: { designTokens: DT },
  styleType,
  disabled,
  size,
  shadowed,
} = props;

...
primary: {
  background: DT.T_BUTTON_PRIMARY_COLOR_BG_DEFAULT,
  ':hover,:active': {
    background: DT.T_BUTTON_PRIMARY_COLOR_BG_HOVER,
    boxShadow: shadowed ? DT.T_SHADOW_BUTTON_PRIMARY_HOVER : 'none',
  },
  color: DT.T_BUTTON_PRIMARY_COLOR_TEXT_DEFAULT,
  fill: DT.T_BUTTON_PRIMARY_COLOR_TEXT_DEFAULT,
  border: 'none',
  boxShadow: shadowed ? DT.T_SHADOW_BUTTON_PRIMARY : 'none',
  transition: `${transitionProperty} ${transitionFlat}`,
  ':link,:visited': {
    color: DT.T_BUTTON_PRIMARY_COLOR_TEXT_DEFAULT,
  },
},
...
```
å¯ä»¥çœ‹åˆ°ï¼Œå½“`styleType='primary'æ—¶`ï¼Œè®¾ç½®äº†å…¶èƒŒæ™¯è‰². æ–‡å­—é¢œè‰². å¡«å……è‰². æ¸å˜. è¿‡æ¸¡. æ¿€æ´»æ—¶çš„æ ·å¼ä»¥åŠè¢«è®¿é—®åçš„æ ·å¼ç­‰ã€‚

å¦‚æ­¤ï¼Œä¸€ä¸ªç®€å•çš„Buttonç»„ä»¶å°è£…è£…å¥½äº†ï¼Œæˆ‘ä»¬åªæ˜¯å¯¹æ ·å¼è¿›è¡Œäº†æ”¹åŠ¨ï¼Œå…¶æœ¬è´¨è¿˜æ˜¯è¿”å›äº†ä¸€ä¸ªåŸç”ŸæŒ‰é’®ï¼ŒåŸæ¥çš„äº‹ä»¶ä¸å½±å“ä½¿ç”¨ã€‚

### Button demo

æˆ‘ä»¬å†™ä¸ªdemoæµ‹è¯•ä¸€ä¸‹ã€‚åœ¨`src/components/Button`ä¸‹æ–°å»º`index.md`ï¼š

```tsx
import React from 'react';

import { Button } from 'dumi-dux-ui';

// demo start
const { StyleTypes } = Button;

const ColorDemo = () => {
  return (
    <div>
      {StyleTypes.map((type) => (
        <Button styleType={type} key={type} onClick={() => console.log('clicked')}>
          Button
        </Button>
      ))}
    </div>
  );
};
// demo end

export default ColorDemo;
```
åœ¨`.umirc.ts`ä¸­åŠ å…¥ï¼š

```js
...
menus: {
    // éœ€è¦è‡ªå®šä¹‰ä¾§è¾¹èœå•çš„è·¯å¾„ï¼Œæ²¡æœ‰é…ç½®çš„è·¯å¾„è¿˜æ˜¯ä¼šä½¿ç”¨è‡ªåŠ¨ç”Ÿæˆçš„é…ç½®
    '/components': [
      {
        title: 'ç»„ä»¶',
        path: '/components',
        children: [
          // èœå•å­é¡¹ï¼ˆå¯é€‰ï¼‰
          'components/Icon/index.md',
          'components/Button/index.md',
        ],
      },
    ],
  },
```

æ ¹ç›®å½•ä¸‹æ‰§è¡Œ`npm run docs`ï¼Œ ä¸å‡ºæ„å¤–çš„è¯ï¼Œåœ¨localhost:8000/components/buttonä¸‹å¯ä»¥çœ‹åˆ°ï¼š

![image.png](/img/posts/2022-3-19/2022-3-19-10.png)
F12æµ‹è¯•ç‚¹å‡»äº‹ä»¶ï¼š

![image.png](/img/posts/2022-3-19/2022-3-19-11.png)

è‡³æ­¤ï¼ŒåŸºç¡€ç»„ä»¶Iconå’ŒButtonçš„è®°å½•å°±åˆ°æ­¤ç»“æŸäº†ã€‚ä¸‹ä¸€æœŸä¼šè®°å½•å¸ƒå±€ç»„ä»¶çš„æ­å»ºï¼Œæ•¬è¯·æœŸå¾…~


---

å‚è€ƒï¼š
[antdæ ·å¼è®¾è®¡](https://ant.design/docs/spec/values-cn) 
[Material UIè®¾è®¡](https://mui.com/zh/components/buttons/)41:T2957,## 1. å‰è¨€

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æ‰¿æ¥ä¸Šä¸€ç¯‡[æ‰‹æŠŠæ‰‹æ­å»ºåŸºäºReactçš„å‰ç«¯UIåº“ ï¼ˆä¸€ï¼‰-- é¡¹ç›®åˆå§‹åŒ–](https://juejin.cn/post/7074915729601986567)ï¼Œå¦‚æœæ²¡æœ‰çœ‹è¿‡é¡¹ç›®æ­å»ºçš„ï¼Œå¯ä»¥ç‚¹å‡»å‰è¾¹çš„é“¾æ¥ã€‚åœ¨dumié¡¹ç›®æ­å»ºå®Œæ¯•åï¼Œæˆ‘ä»¬ç€æ‰‹å†™ä¸€ä¸‹å…¨å±€ä¸»é¢˜é…ç½®ã€‚

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æœ¬æ–‡çš„ä»£ç å±•ç¤ºçš„æ˜¯ä¸»è¦çš„æ ¸å¿ƒä»£ç ï¼Œå…¨éƒ¨ä»£ç è§ä»“åº“ï¼š[Githubä»“åº“](https://github.com/heiheihoho1213/dux-ui)

## 2. UIåº“ä¸‰è¦ç´ 

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;åœ¨å†³å®šè¦å†™æ ¸å¿ƒç»„ä»¶ä¹‹å‰ï¼Œé¦–å…ˆè¦ç¡®å®šè¿™ä¹ˆå‡ ä¸ªæ³¨æ„äº‹é¡¹ï¼š

- `1. Styleé£æ ¼`
- `2. é€‚é…æ€§`
- `3. å†…å®¹é€‚åº”æ€§`

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`Styleé£æ ¼`å¯ä»¥åŒ…å«ç»„ä»¶åº“çš„è‰²å½©è®¾è®¡ï¼Œè§†è§‰é£æ ¼è®¾è®¡ï¼Œå­—ä½“ï¼ŒåŠ¨ç”»æ•ˆæœï¼Œä¸»é¢˜çš®è‚¤å’Œä¸€äº›åŸºç¡€æ ·å¼çš„è®¾è®¡ç­‰ï¼›`é€‚é…æ€§`åˆ™è¡¨ç¤ºè¦è€ƒè™‘ç»„ä»¶åº“è¦è¿è¡Œåœ¨ä»€ä¹ˆå¹³å°ï¼Œæ˜¯PCç«¯è¿˜æ˜¯ç§»åŠ¨ç«¯ï¼Œæˆ–è€…æ˜¯å…¼å®¹å…¶ä»–å¹³å°ç­‰ï¼›`å†…å®¹é€‚åº”æ€§`æŒ‡çš„æ˜¯ç»„ä»¶åŒ…å«çš„åŠŸèƒ½èŒƒå›´ï¼Œæ–‡æ¡ˆå‹å¥½åº¦ï¼Œæ˜¯å¦è€ƒè™‘å›½é™…åŒ–ï¼Œå¯¹å¼€å‘è€…æ˜¯å¦å‹å¥½ç­‰é—®é¢˜ã€‚è¿™äº›è®¾è®¡é£æ ¼ä»è€…è§ä»ï¼Œåœ¨ä¹‹åçš„æ–‡ç« ä¸­ä¼šé™†ç»­è®°å½•æˆ‘æ˜¯å¦‚ä½•è®¾è®¡çš„ã€‚

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;åŸºäºä¸Šè¿°åŸåˆ™ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆä»ä¸»é¢˜è‰²å½©å…¥æ‰‹ã€‚

<hr />

## 3. ThemeProvider

Themeå’Œæ ·å¼è‡ªç„¶æ˜¯å±äºå…¨å±€çš„ï¼Œæˆ‘ä»¬ç”¨ä¸€ä¸ª`provider`æ¥æ‰¿æ¥ã€‚

### ThemeProvider.tsx

åœ¨`src/components`ä¸‹æ–°å»ºä¸€ä¸ªæ–‡ä»¶å¤¹`ThemeProvider`ï¼Œåœ¨è¯¥æ–‡ä»¶å¤¹ä¸‹æ–°å»ºä¸€ä¸ªæ–‡ä»¶`ThemeProvider.tsx`ï¼š

```tsx
class ThemeProvider extends Component {
    ...
}
```


åœ¨`src/components/ThemeProvider/ThemeProvider.tsx`ä¸­æ·»åŠ propsï¼Œå…¶ä¸­çš„themeè¡¨ç¤ºå½“å‰çš„ä¸»é¢˜ï¼š

```tsx
static propTypes = {
    /**
     * è‡ªå®šä¹‰ä¸»é¢˜
     */
    theme: PropTypes.object.isRequired
};
```

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æ¥ä¸‹æ¥å®‰è£…ä¸€ä¸ªç¬¬ä¸‰æ–¹ä¾èµ–`emotion-theming`æ¥æä¾›ä¸»é¢˜åŒ–çš„è§£å†³æ–¹æ¡ˆï¼Œè¯¦ç»†é…ç½®å¯æŸ¥çœ‹å…¶[ä¸»é¡µ](https://emotion.sh/docs/theming#themeprovider-reactcomponenttype)ï¼Œå°±å½“åšæ˜¯ä¸€ä¸ªå…¨å±€çš„`context`æ¥ç®¡ç†çŠ¶æ€å§ã€‚æ‰§è¡ŒæŒ‡ä»¤ï¼š
```sh
npm i --save emotion emotion-theming @emotion/core @emotion/styled
```

ç„¶åå®šä¹‰æ„é€ å™¨å’Œæ¸²æŸ“å‡½æ•°ï¼š
```tsx
import React, { Component } from 'react';
import _ from 'lodash';
import PropTypes from 'prop-types';
import { ThemeProvider as EThemeProvider } from 'emotion-theming';

constructor(props: any) {
    super(props);
    const theme = props.theme;
 
    this.state = {
        theme
    };
}
...
render() {
    // eslint-disable-next-line no-unused-vars
    const { theme: _theme, ...rest } = this.props as any;
    const { theme } = this.state;
    return <EThemeProvider theme={theme} {...rest} />;
}
```

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ç•™å¿ƒçš„æœ‹å‹å¯èƒ½ä¼šæ³¨æ„åˆ°ï¼Œæˆ‘è¿™é‡Œçš„stateä¸­çš„themeæ˜¯å†™åœ¨æ„é€ å™¨ä¸­çš„ï¼Œåœ¨æŒ‚è½½çš„æ—¶å€™åªæ‰§è¡Œä¸€æ¬¡ï¼Œå¦‚æœç”¨æˆ·æƒ³è¦åˆ‡æ¢ä¸»é¢˜ï¼Œå¿…ç„¶ä¼šé€šè¿‡`props`ä¼ é€’æ–°çš„themeå€¼ï¼Œæˆ‘ä»¬è¿™é‡Œæ£€æµ‹propså˜åŒ–ï¼š

```tsx
...
componentWillReceiveProps(nextProps: any) {
    const { theme } = nextProps;
    if (JSON.stringify(theme) !== this.cache) {
        const mergedTheme = this.getMergedTheme(theme);
        this.cache = JSON.stringify(theme);
        this.setState(
            {
                theme: mergedTheme
            },
        );
    }
}

getMergedTheme = (theme: string) => {
    return generateTheme(theme);
};
```
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å¯ä»¥çœ‹åˆ°ï¼ŒåŠ äº†ä¸€ä¸ªæœ¬åœ°çš„ç¼“å­˜`cache`æ¥é¿å…é‡å¤å˜æ›´ã€‚å…¶ä¸­`generateTheme`æ˜¯æˆ‘å†™çš„ä¸€ä¸ªå¢å¼ºæ–¹æ³•ï¼Œç”¨äºå¤„ç†å‰åä¸¤ä¸ªä¸»é¢˜å¯¹æ¯”æ›´æ–°ï¼Œå¹¶åŠ å…¥äº†ä¸€äº›å¸¸ç”¨æ ·å¼ï¼Œæ¯”å¦‚`fontSize`ç­‰ï¼Œå¦‚æœä½ è§‰å¾—æ²¡å¿…è¦ï¼Œé‚£ä¹ˆä½ ç›´æ¥è®¾ç½®æ‹¿åˆ°çš„themeå°±è¡Œäº†ã€‚

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;è‡³æ­¤ï¼Œä¸€ä¸ªæä¾›ä¸»é¢˜çš„providerå°±å†™å¥½äº†ï¼Œç°åœ¨æ¥ç»™ä»–å¢åŠ çµé­‚ï¼šé…è‰²ã€‚è¿™é‡Œæˆ‘å†™äº†ä¸¤ç§é…è‰²ï¼ˆä½ ä¹Ÿå¯ä»¥è‡ªå·±è®¾è®¡ï¼Œå¦‚æœä½ å…·å¤‡è®¾è®¡å¸ˆçš„ç¾å­¦ç´ å…»å’Œä¸“ä¸šçŸ¥è¯†çš„è¯ï¼‰ï¼š`Black`å’Œ`White`ã€‚

### designTokens.ts

æˆ‘ä»¬åœ¨`ThemeProvider.tsx`åŒç›®å½•æ–°å»ºæ–‡ä»¶`designTokens.ts`æ¥æ”¾ç½®é»˜è®¤ä¸»é¢˜é…è‰²ï¼š


```ts
/** é»˜è®¤çš„ä¸»é¢˜é…è‰² */
const designTokens = {
    ...
};

export { designTokens };
```
å…·ä½“çš„é…è‰²å˜é‡åº”å…¨å¤§å†™ï¼Œä»¥Tå¼€å¤´ï¼Œä»…åŒ…å«å­—æ¯. æ•°å­—. ä¸‹åˆ’çº¿ï¼Œç”±äºå˜é‡å¤ªå¤šï¼Œè¿™é‡Œç»™å‡ºä¸€éƒ¨åˆ†ï¼š

èƒŒæ™¯è‰²ï¼š

![image.png](/img/posts/2022-3-19/2022-3-19-1.png)

å¤šå½©è‰²ï¼š

![image.png](/img/posts/2022-3-19/2022-3-19-2.png)


æ¸å˜è‰²æ± ï¼š

![image.png](/img/posts/2022-3-19/2022-3-19-3.png)


å¸¸ç”¨å°ºå¯¸ï¼š

![image.png](/img/posts/2022-3-19/2022-3-19-4.png)


&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;åŒç†ï¼Œåœ¨ç›¸åŒçš„ç›®å½•ä¸‹ï¼Œæ–°å»ºæ–‡ä»¶`dark.ts`, æ”¾å…¥ç›¸åŒçš„å˜é‡ï¼Œä½†æ˜¯è‰²å·åº”è¯¥æ˜¯æš—è‰²è°ƒçš„é…è‰²ï¼Œäº®è‰²è°ƒä¸‹çš„äº®è‰²ï¼Œåœ¨æš—è‰²è°ƒä¸‹åº”è¯¥æ˜¯æš—è‰²ã€‚æ¯”å¦‚æ¸å˜è‰²æ± åº”è¯¥æ˜¯ä¸‹é¢è¿™æ ·ï¼š

![image.png](/img/posts/2022-3-19/2022-3-19-5.png)


è¿™äº›é…è‰²æ–¹æ¡ˆï¼Œç½‘ä¸Šä¹Ÿèƒ½æ‰¾åˆ°ç±»ä¼¼çš„ï¼Œé€‰æ‹©è‡ªå·±å–œæ¬¢çš„å°±è¡Œäº†ã€‚

æœ‰äº†è¿™äº›é¢œè‰²æ± ï¼Œæˆ‘ä»¬å†™ä¸€ä¸ªæ–¹æ³•æ¥è·å–å½“å‰çš„`designTokens`ï¼Œè¿˜æ˜¯åœ¨åŒç›®å½•ä¸‹ï¼Œæ–°å»ºæ–‡ä»¶`useDesignTokens.ts`ï¼š


```tsx
import { useTheme } from 'emotion-theming';

// ../../styleä¸­å†™äº†å‡ ä¸ªè¾…åŠ©çš„æ ·å¼ï¼Œå¯¹è§£é‡ŠåŸç†æ²¡æœ‰å½±å“ï¼Œæƒ³çœ‹å…¨éƒ¨ä»£ç å¯ä»¥å»é¡¹ç›®ä»“åº“æŸ¥çœ‹
import { defaultTheme, Theme } from '../../style';

const useDesignTokens = () => {
  // æ‹¿åˆ°Themeproviderçš„theme
  const theme = useTheme<Theme>();
  if (!Object.keys(theme).length) return defaultTheme.designTokens;
  return theme.designTokens;
};

export default useDesignTokens;

```
è¿™æ ·ï¼Œå°±å¯ä»¥åœ¨ä»»ä½•ä¸€ä¸ªåœ°æ–¹ï¼Œé€šè¿‡useDesignTokensæ‹¿åˆ°å½“å‰çš„ä¸»é¢˜é…è‰²äº†ã€‚

## 4. åæ€

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å†å›åˆ°`ThemeProvider`æœ¬èº«è¿›è¡Œæ€è€ƒï¼Œæ€»è§‰å¾—å°‘äº†ç‚¹ä»€ä¹ˆã€‚æ˜¯ä¸æ˜¯æ˜¾å¾—åŠŸèƒ½æœ‰ç‚¹å•è–„ï¼Œä¼ å€¼åªèƒ½ä¼ é€’themeï¼Œä¸å¤Ÿçµæ´»ã€‚æ•´ä¸ªç»„ä»¶åº“é¡¹ç›®è¦ç»´æŠ¤çš„å…¬å…±å˜é‡åº”è¯¥ä¸ä¼šåªæœ‰ä¸»é¢˜ï¼Œåæ¥å¯èƒ½è¿˜ä¼šæœ‰å›½é™…åŒ–ä»€ä¹ˆçš„ï¼Œæ‰€ä»¥ï¼Œæ˜¯ä¸æ˜¯è¦å†™ä¸€ä¸ªæ›´é€šç”¨çš„Provideræ¥ç»Ÿä¸€å¤„ç†ï¼Ÿ

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æˆ‘ä»¬åœ¨`src/components`æ–‡ä»¶å¤¹ä¸‹ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„æ–‡ä»¶å¤¹`ConfigProvider`ï¼Œåœ¨æ–°åˆ›å»ºçš„æ–‡ä»¶å¤¹ä¸‹åˆ›å»ºæ–‡ä»¶`ConfigProvider.tsx`ï¼Œå†™ä¸Šå¦‚ä¸‹ä»£ç ï¼š

```tsx
import React, { ReactNode, createContext } from 'react';

import ThemeProvider from '../ThemeProvider';

export interface ConfigProviderProps {
  /** @ignore */
  children: ReactNode;

  /** æä¾›æ—¶ä¼šä½¿ç”¨ ThemeProvider åŒ…è£¹ */
  theme?: any;
}

const ConfigProvider = ({ children, theme, ...rest }: ConfigProviderProps) => {

  const defaultConfig = {};
  const ConfigContext = createContext<any>(defaultConfig);

  let provider = (
    <ConfigContext.Provider value={{ ...defaultConfig, ...rest }}>
      {children}
    </ConfigContext.Provider>
  );
  if (theme) provider = <ThemeProvider theme={theme}>{provider}</ThemeProvider>;

  // ä¸‹è¾¹å¯ä»¥è¿½åŠ å…¶ä»–æƒ…å†µçš„Provider ...

  return provider;
};

export { ThemeProvider };
export default ConfigProvider;
```
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;è¿™é‡Œï¼Œæˆ‘ä»¬ä½¿ç”¨`createContext`æ¥åˆ›å»ºä¸€ä¸ªcontextæ”¾ç½®å…¨å±€å˜é‡ï¼Œä½¿ç”¨`ConfigContext.Provider`ä½œä¸ºåŸºç¡€å…¨å±€å‚æ•°ï¼Œé€šè¿‡æ‹¿åˆ°çš„ä¸åŒå‚æ•°æ¥åŠ¨æ€å åŠ è½¬æ¢ä¸ºå…¶ä»–ä¸åŒçš„`Provider`ã€‚å½“ç„¶ï¼Œcontextå¯ä»¥è‡ªå·±å†å•å†™ä¸€ä¸ªæ–‡ä»¶æ¥å­˜å‚¨ï¼Œè¿™é‡Œå°±ä¸èµ˜è¿°äº†ã€‚

## 5. å¦‚ä½•ä½¿ç”¨

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ä¸ºäº†èƒ½å¤Ÿåœ¨ç»„ä»¶ä¸­ä½¿ç”¨çš„å†…ç½®ä¸»é¢˜è‰²ï¼Œéœ€è¦å°†é…ç½®å¯¹å¤–æš´éœ²å‡ºæ¥ï¼Œåœ¨`src/index.ts`æ–‡ä»¶ä¸­åˆ é™¤ä¸Šä¸€æœŸå¯¼å…¥çš„Fooç»„ä»¶ï¼š

<del>`export { default as Foo } from './components/Foo';`</del>

ç„¶ååŠ å…¥å¦‚ä¸‹ä»£ç ï¼š

```ts
export { default as ThemeDark } from './components/ThemeProvider/dark';
export { designTokens as ThemeDefault } from './components/ThemeProvider/designTokens';
export {
  default as ConfigProvider,
  ThemeProvider,
} from './components/ConfigProvider/ConfigProvider';
```

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ä¸»é¢˜é…ç½®æœ‰äº†ï¼Œæ¥ä¸‹æ¥è¦æ€ä¹ˆç”¨å‘¢ï¼Ÿç”¨è¿™ä¸ªProvideræŠŠå…¨å±€Appç»„ä»¶åŒ…è£¹ä¸€ä¸‹å—ï¼Ÿå¦‚æœæœ‰ä¸ªåˆ«ç»„ä»¶æƒ³è¦å®šåˆ¶æ ·å¼å‘¢ï¼Ÿä¼¼ä¹ä¸å¤Ÿçµæ´»ï¼Œä½œè€…è®¤ä¸ºåº”è¯¥å°è£…ä¸€ä¸ªå·¥å…·ç±»ï¼Œåœ¨éœ€è¦é…ç½®ä¸»é¢˜è‰²çš„ç»„åŠ ä¸Šä½¿ç”¨å³å¯ã€‚åœ¨`src`ç›®å½•ä¸‹æ–°å»º`style`æ–‡ä»¶å¤¹ç”¨æ¥æ”¾ç½®å…¬å…±çš„æ ·å¼é…ç½®ï¼Œåœ¨è¯¥æ–‡ä»¶å¤¹ä¸‹æ–°å¢æ–‡ä»¶`styleWrap.tsx`ï¼š

```tsx
// å¼•å…¥ä¾èµ–
import React, { FC, useMemo } from 'react';
import { useTheme } from 'emotion-theming';
import defaultTheme from '../components/ThemeProvider/theme';

...

// æ–°å»ºä¸€ä¸ªå‡½æ•°
const styleWrap = () => {
    ...
    return Com => {
        const WithThemeComponent = (props) => {

            ...

            const theme = useTheme();

            const memoTheme = useMemo(
                () => (!theme || !Object.keys(theme)?.length ? defaultTheme : theme),
                [theme],
            );

            const result = {
                ...props,
                theme: memoTheme,
            };
            ...

            const Com = Comp as unknown as FC;
            // resultä¸­å¸¦æœ‰themeä¸»é¢˜å‚æ•°ï¼Œåœ¨åŸºç¡€ä¸šåŠ¡ç»„ä»¶ä¸­åº”æ¥å—å¹¶å¤„ç†
            return <Com {...result} />;
        } 

        return WithThemeComponent;
    }
}

```
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å¯ä»¥çœ‹åˆ°ï¼ŒstyleWrapè¿”å›çš„æ˜¯ä¸€ä¸ªé«˜é˜¶ç»„ä»¶WithThemeComponentï¼Œåœ¨è¯¥ç»„ä»¶é‡Œè·å–å½“å‰ä¸»é¢˜å¹¶ä½¿ç”¨`useMemo`èŠ‚çœæ¸²æŸ“å¼€é”€ï¼Œå°†ç»“æœæ”¶é›†åˆ°`result`é‡Œä½œä¸ºå±æ€§ä¼ é€’ç»™åŸºç¡€ä¸šåŠ¡ç»„ä»¶`Com`.

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æ¥ä¸‹æ¥è®°å½•ä¸€ä¸‹`ThemeProvider`åœ¨ç»„ä»¶ä¸­çš„ä½¿ç”¨æ–¹å¼ï¼š


```tsx
...
// 1. å¼•å…¥ä¸€ç§å­—ä½“
const [theme, setTheme] = useState(ThemeDark);
...

// 2. ä½¿ç”¨
<ConfigProvider theme={theme}>
    // æ”¾ç½®è¢«styleWrapåŒ…è£¹çš„ä¸šåŠ¡ç»„ä»¶
    ...
</ConfigProvider>

// 3. åˆ‡æ¢ä¸»é¢˜
setTheme(designTokens);
```


<hr />

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æœ¬æœŸä¸»é¢˜é…ç½®çš„è®°å½•åˆ°è¿™é‡Œå°±ç»“æŸäº†ï¼Œä¸‹ä¸€æœŸè®²è§£åŸºç¡€ç»„ä»¶`Button`å’Œ`Icon`çš„è®¾è®¡ï¼ŒåŒæ—¶ä¼šå°†ä¸»é¢˜è‰²åº”ç”¨åœ¨è¿™äº›ç»„ä»¶ä¸Šï¼Œä¸ºäº†èƒ½å¤Ÿæ›´å¥½åœ°ç†è§£åŸºç¡€ç»„ä»¶å¦‚ä½•å¤„ç†ä¼ å…¥çš„themeå‚æ•°ï¼Œä¸‹ä¸€æœŸä¼šå’Œæœ¬æœŸä¸€èµ·å‘å¸ƒï¼Œæ•¬è¯·æœŸå¾…~~42:T14b2,## 1. å‰è¨€

### å†™ä½œèƒŒæ™¯
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ç°åœ¨å¼€å§‹æˆ‘åœ¨æ˜é‡‘çš„ç¬¬ä¸€ä¸ªä¸“æ ï¼Œè®°å½•ä¸€ä¸‹æˆ‘åœ¨å®é™…é¡¹ç›®ä¸­æ­å»ºUIç»„ä»¶åº“çš„è¿‡ç¨‹ï¼Œä»¥ä¾¿äºä»¥åæŸ¥è¯¢ï¼ŒåŒæ—¶ä¹Ÿä¸ºå¤§å®¶æä¾›ä¸€ç§åŸºäºReactåˆ›å»ºå‰ç«¯UIåº“çš„æ€è·¯ã€‚

### ä¸ºä»€ä¹ˆè¦è‡ªå·±å†™UIåº“

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ç°åœ¨ä¼˜ç§€çš„å‰ç«¯å¼€æºUIåº“å·²ç»å¾ˆå¤šäº†ï¼Œæ¯”å¦‚antd. Material UI. element UIç­‰ç­‰ï¼Œè¿™äº›UIåº“ç”Ÿæ€éƒ½æ¯”è¾ƒå®Œå–„ï¼Œæ–‡æ¡£ä¹Ÿå†™å¾—å¾ˆå¥½ï¼Œä½ åœ¨é¡¹ç›®ä¸­ç›´æ¥ç”¨ä¸å°±è¡Œäº†ï¼Œå¯ä¸ºä»€ä¹ˆè¿˜è¦è‡ªå·±å†™å‘¢ï¼Ÿå€Ÿç”¨ä¸€å¥è€è¯ï¼Œç§Ÿä¸å¦‚ä¹°ï¼Œä¹°ä¸å¦‚é€ ï¼Œä»è¿™ä¸ªè§’åº¦ä¹Ÿèƒ½çŸ¥é“è€ç”¨åˆ«äººçš„æ€»è§‰å¾—æœ‰ç‚¹ç¼ºé™·ï¼Œè¿™é‡Œä½œè€…ä¸ªäººè®¤ä¸ºåšæŒå†™è‡ªå·±çš„UIåº“ä¸»è¦æœ‰è¿™ä¹ˆå‡ ä¸ªåŸå› ï¼š

*1.* *ä¼šå—åˆ¶äºäººã€‚*

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;è™½ç„¶æ˜¯å¼€æºçš„åº“ï¼Œä½†æ˜¯éè§‚å¸‚é¢ä¸Šå¤§å¤šæ•°äº§å“ï¼Œéƒ½æ²¡æœ‰ç”¨è¿™äº›ç»„ä»¶åº“ï¼Œç›¸åçš„æ˜¯ä¼ä¸šå†…éƒ¨çš„é¡¹ç›®ç”¨çš„æ¯”è¾ƒå¤šã€‚æˆ‘æƒ³æ›´å¤šçš„åŸå› æ˜¯ä¸æƒ³å—åˆ¶äºäººï¼Œå¦‚æœå“ªä¸€å¤©UIåº“çš„ä½œè€…æƒ³è¦æ”¶ä¸“åˆ©è´¹äº†ï¼Œä½ çš„é¡¹ç›®è¦ä¸è¦è¿ç§»åˆ°åˆ«çš„ç»„ä»¶åº“ï¼Ÿè¿˜æ˜¯è¯´ä¹–ä¹–äº¤é’±å‘¢ï¼Ÿå¦ä¸€æ–¹é¢ï¼Œå¦‚æœä½ å…¬å¸æ‰€æœ‰çš„äº§å“éƒ½ç”¨äº†antdï¼Œæ—¥ç§¯æœˆç´¯ï¼Œä½ å°±ä¼šå¤©ç„¶çš„ä¾èµ–é˜¿é‡Œçš„å¼€å‘ä¹ æƒ¯ï¼Œé€‰æ‹©æ–°äº§å“çš„æ—¶å€™å°±ä¼šæ›´å€¾å‘äºé˜¿é‡ŒåŒç³»çš„ï¼Œæ‰€ä»¥è¯´ï¼Œå…è´¹çš„ä»£ä»·æ˜¯å¤±å»è‡ªä¸»æƒã€‚

*2.* *å‡çº§äº§å“éœ€è¦çœ‹è„¸è‰²ã€‚*

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ä¸¾ä¸ªä¾‹å­ï¼Œä½ çš„äº§å“æ‰€ä½¿ç”¨çš„æ¡†æ¶ï¼ŒVueè¦ä»2å‡3ï¼ŒAngularè¦ä»9å‡12ï¼ŒReactè¦å‡çº§18äº†ï¼Œè€Œä½ æ‰€ä¾èµ–çš„ç¬¬ä¸‰æ–¹UIç»„ä»¶åº“è¿˜ä¸æ”¯æŒæ–°ç‰ˆæœ¬æ¡†æ¶ï¼Œæˆ–è€…å¯¹æ–°ç‰ˆæœ¬æ¡†æ¶æˆ–å…¶ä»–çš„ä¾èµ–éƒ¨åˆ†å…¼å®¹ï¼Œè¿™å°±ä¼šä½¿å¾—ä½ çš„å¼€å‘éå¸¸çš„éš¾å—ã€‚

*3.* *ä¸å¥½ç»´æŠ¤ã€‚*

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ä½¿ç”¨åˆ«äººçš„ç»„ä»¶åº“ï¼Œå¦‚æœå‡ºäº†Bugæ€ä¹ˆä¿®å‘¢ï¼Ÿéš¾é“è¦åœ¨Githubä¸ŠæIssueå˜›ğŸ˜‚ï¼Œè¿™æ ·æŠ±æ€¨çš„æ˜¯ä½ çš„å®¢æˆ·ï¼Œå—æŸçš„æ˜¯ä½ çš„äº§å“ã€‚ç¬¬ä¸‰æ–¹è¿›è¡Œçš„å¼€æºï¼Œæ˜¯ä¸ªåŒåˆƒå‰‘ï¼Œå…è´¹ç»™ä½ ç”¨ï¼Œä½†æ˜¯å‡ºäº†é—®é¢˜äººå®¶ä¹Ÿä¸è´Ÿè´£ã€‚


&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æœ‰äº†è¿™äº›åŸå› ï¼Œåº”è¯¥ä¸ä¼šå†è´¨ç–‘ä¸ºä»€ä¹ˆè¦åšè‡ªå·±çš„UIåº“äº†å§ã€‚æ‹¥æœ‰è‡ªå·±å…¨å¥—çš„äº§å“ä½“ç³»ï¼Œå¯¹äºä¼ä¸šï¼Œæ˜¯ä¸€ä¸ªæ‹¿å›è‡ªä¸»æƒçš„é‡è¦ä¸€æ­¥ï¼Œå¯¹äºæˆ‘ä»¬å¼€å‘è€…ï¼Œä¹Ÿæ˜¯é”¤ç‚¼è‡ªå·±åŸºæœ¬åŠŸçš„è¿‡ç¨‹ï¼Œä½•ä¹è€Œä¸ä¸ºï¼Ÿ

## 2. åŸºäºReact
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;è¿™é‡Œè®°å½•æˆ‘ç°åœ¨æ­£åœ¨æ­å»ºçš„ä¼ä¸šé¡¹ç›®ï¼Œä¸€è¾¹æ­å»ºä¸€è¾¹è®°å½•ï¼Œå…¶ä¹èèï¼Œå¯ä»¥ç§°å¾—ä¸Šæ‰‹æŠŠæ‰‹æ•™å­¦æœ¬å­¦äº†\[doge\]ã€‚

### 1. ä½¿ç”¨dumiåˆ›å»º

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dumiæ˜¯ä¸€ä¸ªå¼€æºçš„è´Ÿè´£ç»„ä»¶å¼€å‘åŠç»„ä»¶æ–‡æ¡£ç”Ÿæˆçš„å·¥å…·ï¼Œè¿™é‡Œä»…ä¸ºäº†æ–¹ä¾¿ç»„ä»¶åº“æ–‡æ¡£å±•ç¤ºä½¿ç”¨ã€‚åœ¨æœ€åæ‰“åŒ…å‘å¸ƒæ—¶ï¼Œdumiä¸å‚ä¸æ‰“åŒ…ï¼Œæ‰€ä»¥è¿™é‡Œä½¿ç”¨dumiæ˜¯å¯ä»¥çš„ã€‚

æ¥ä¸‹æ¥å°±å¼€å§‹è®°å½•å®æ“æ­¥éª¤ã€‚

é¦–å…ˆå®‰è£…Â [node](https://nodejs.org/en/)ï¼Œå¹¶ç¡®ä¿`node >= 10.13 && node < 17.6.0`ã€‚è¿™é‡Œä½œè€…äº²æµ‹ï¼Œnode 17.6.0æ˜¯ä¸å…¼å®¹çš„ï¼Œè€Œä½œè€…æœ¬åœ°ä½¿ç”¨çš„`v16.14.2`å¯ä»¥å®Œå…¨å…¼å®¹ã€‚

åœ¨ç©ºç™½çš„åœ°æ–¹æ–°å»ºæ–‡ä»¶å¤¹
```sh
mkdir dux-ui && cd ./dux-ui
```

ç„¶åæ‰§è¡Œå®‰è£…å‘½ä»¤ï¼Œè¿™é‡Œæˆ‘é€‰æ‹©ç«™ç‚¹å¼çš„åˆ›å»ºæ–¹å¼

```sh
$ npx @umijs/create-dumi-lib        # åˆå§‹åŒ–ä¸€ä¸ªæ–‡æ¡£æ¨¡å¼çš„ç»„ä»¶åº“å¼€å‘è„šæ‰‹æ¶
// or
$ yarn create @umijs/dumi-lib

$ npx @umijs/create-dumi-lib --site # åˆå§‹åŒ–ä¸€ä¸ªç«™ç‚¹æ¨¡å¼çš„ç»„ä»¶åº“å¼€å‘è„šæ‰‹æ¶
// or
$ yarn create @umijs/dumi-lib --site
```
åœ¨æ ¹ç›®å½•ä¸‹æ‰§è¡Œå‘½ä»¤

```sh
npm install
npm run dev
```
ç„¶åé¡¹ç›®å°±è·‘èµ·æ¥äº†ï¼ï¼ˆç›—ç”¨å®˜ç½‘çš„å›¾ï¼Œä»…ä¾›å‚è€ƒï¼‰

![image.png](/img/posts/2022-3-14/2022-3-14-1.png)

### 2. æ–‡ä»¶ç›®å½•

è„šæ‰‹æ¶æ­å»ºèµ·é¡¹ç›®åï¼Œå¯ä»¥çœ‹åˆ°åˆå§‹æ–‡ä»¶ç›®å½•

![image.png](/img/posts/2022-3-14/2022-3-14-2.png)


è¿™é‡Œä¸ºäº†å¼€å‘æ–¹ä¾¿ï¼Œæˆ‘ä»¬æŠŠè‡ªå®šä¹‰çš„ç»„ä»¶æ”¾åœ¨å•ç‹¬çš„`components`æ–‡ä»¶å¤¹ä¸‹ï¼š

![image.png](/img/posts/2022-3-14/2022-3-14-3.png)


ç„¶åä¿®æ”¹`src`ä¸‹çš„`index`æ–‡ä»¶ä¸­ç»„ä»¶çš„å¯¼å…¥è·¯å¾„ï¼š

```js
export { default as Foo } from './components/Foo';
```
ä¿®æ”¹dumié…ç½®æ–‡ä»¶`.umirc.ts`ï¼Œæ–°å¢menuå±•ç¤ºè·¯å¾„ï¼š

```js
import { defineConfig } from 'dumi';

export default defineConfig({
  title: 'test-dumi',
  favicon:
    'https://user-images.githubusercontent.com/9554297/83762004-a0761b00-a6a9-11ea-83b4-9c8ff721d4b8.png',
  logo: 'https://user-images.githubusercontent.com/9554297/83762004-a0761b00-a6a9-11ea-83b4-9c8ff721d4b8.png',
  outputPath: 'docs-dist',
  mode: 'site',
  
  // æ–°å¢
  menus: {
    // éœ€è¦è‡ªå®šä¹‰ä¾§è¾¹èœå•çš„è·¯å¾„ï¼Œæ²¡æœ‰é…ç½®çš„è·¯å¾„è¿˜æ˜¯ä¼šä½¿ç”¨è‡ªåŠ¨ç”Ÿæˆçš„é…ç½®
    '/components': [
      {
        title: 'ç»„ä»¶',
        path: '/components',
        children: [
          // èœå•å­é¡¹ï¼ˆå¯é€‰ï¼‰
          'components/Foo/index.md',
        ],
      },
    ],
  },
});
```

ä¿®æ”¹`package.json`

![image.png](/img/posts/2022-3-14/2022-3-14-4.png)


ç„¶åæ‰§è¡Œ

```sh
npm run docs
```

å¯ä»¥çœ‹åˆ°è·‘èµ·æ¥äº†

![image.png](/img/posts/2022-3-14/2022-3-14-5.png)
![image.png](/img/posts/2022-3-14/2022-3-14-6.png)

è‡³æ­¤ï¼Œé¡¹ç›®å°±æ­å»ºèµ·æ¥äº†ï¼æœ¬ç« åˆ°æ­¤ç»“æŸï¼Œä¸‹ä¸€èŠ‚ä¼šé€æ­¥è®°å½•å„ä¸ªç»„ä»¶çš„å¼€å‘è¿‡ç¨‹ã€‚43:T2618,## 1. nodeç¯å¢ƒä¸å¼€å‘å·¥å…·å‡†å¤‡

å‰ç«¯å·¥ç¨‹åŒ–å¼€å‘ï¼Œæœ¬åœ°å¯åŠ¨å¼€å‘ç¯å¢ƒéƒ½æ˜¯åŸºäºnodejsçš„ï¼Œå‘½ä»¤è¡Œé‡Œè¾“å…¥æŒ‡ä»¤`node -v`å¯ä»¥å¸®åŠ©ç¡®è®¤æ‚¨çš„ç”µè„‘ä¸Šæ˜¯å¦å®‰è£…äº†nodeï¼Œå¦‚æœæ²¡æœ‰å®‰è£…ï¼Œåˆ™å¯ä»¥å» [nodeå®˜ç½‘](http://nodejs.cn/download/) ä¸‹è½½å®‰è£…åŒ…ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š
![nodeå®˜ç½‘ä¸‹è½½ç•Œé¢](/img/posts/2022-3-1/2022-3-1-1.png)
ä¸ç®¡æ˜¯åœ¨windowsè¿˜æ˜¯åœ¨macç¯å¢ƒä¸‹ï¼Œéƒ½æ˜¯ä¸€é”®å‚»ç“œå¼å®‰è£…ï¼Œç”šè‡³è¿ç¯å¢ƒå˜é‡éƒ½ä¸éœ€è¦æ‰‹åŠ¨é…ç½®ï¼Œè¿™é‡Œå°±ä¸è¿‡å¤šä»‹ç»äº†ã€‚


## 2. å¼€å‘å·¥å…·å‡†å¤‡
å‰ç«¯çš„å¼€å‘å·¥å…·ï¼Œå¸¸è§çš„æœ‰VSCode. WebStorm. Atomç­‰ï¼Œåªéœ€ç”¨å…¶ä¸­ä¹‹ä¸€ä¾¿è¶³å¯ä»¥å®Œæˆæ‚¨çš„å¼€å‘ä»»åŠ¡ã€‚è¿™é‡Œç¬”è€…ç»™å‡ºå¸¸ç”¨ç¼–è¾‘å™¨çš„å¯¹æ¯”ã€‚


| å·¥å…·åç§° | ä¼˜ç‚¹ | ç¼ºç‚¹ | æ¨èåº¦ |
| --- | --- | --- | --- |
| WebStorm | æ’ä»¶å¾ˆå¤šï¼ŒåŠŸèƒ½é½å…¨ | æ”¶è´¹ï¼Œå ç”¨èµ„æºå¤§ | â˜†â˜…â˜… | 
| Atom | ç•Œé¢æ•´æ´ï¼Œå…è´¹ | æ’ä»¶å®‰è£…å¤šäº†ä¼šæ…¢ï¼Œä¸å¤Ÿæµç•… | â˜†â˜…â˜… | 
| VSCode | è½»é‡çº§ï¼Œæ’ä»¶ç¹å¤šï¼Œæ”¯æŒå®šåˆ¶ï¼Œå…è´¹ | æ’ä»¶è¿‡å¤šä¼šå‡ºç°å†²çªï¼Œä»£ç çš„æç¤ºä¸å‹å¥½ | â˜†â˜…â˜…â˜…â˜… | 


ç¬”è€…æ¥ä¸‹æ¥çš„å¼€å‘å°±ä»¥VSCodeä¸ºå‡†ã€‚

vsCodeä½œä¸ºç›®å‰æœ€ä¸ºæµè¡Œçš„è½»é‡çº§å¼€å‘å·¥å…·ï¼Œå¹¿å—å‰åç«¯ç¨‹åºå‘˜çš„å–œçˆ±ï¼Œå…¶æ’ä»¶åº“ä¹Ÿæ˜¯ååˆ†çš„ä¸°å¯Œï¼Œå¯ä»¥ä¾›å¼€å‘çš„è¿›è¡Œè‡ªå®šä¹‰é…ç½®ï¼Œè€Œä¸”æä¾›äº†æ’ä»¶å¼€å‘çš„åŠŸèƒ½ï¼Œä½¿å¾—å¼€æºä½œè€…èƒ½å¤Ÿæ›´åŠ è½»æ¾çš„è‡ªå®šä¹‰è‡ªå·±çš„æ’ä»¶ï¼Œå¹¶ä¸”æœ‰æ”¯æŒè¿œç¨‹å¼€å‘ç­‰ä¼˜ç‚¹ã€‚ç›¸æ¯”äºwebStormå’Œsublimeè¿™ç§éœ€è¦è´­ä¹°æ­£å¼ç‰ˆï¼ˆsublimeè™½ç„¶ä¸ä¹°ä¹Ÿæ²¡ä»€ä¹ˆå…³ç³»ï¼‰çš„äº§å“ï¼Œå…¶æœ€ç›´æ¥çš„ä¼˜ç‚¹æ˜¯ä»–æ˜¯å…è´¹çš„ï¼
vsCodeå®˜ç½‘åœ°å€ä¸ºï¼š`https://code.visualstudio.com/`ï¼Œå¼€å‘è€…å¯ä»¥ä¸‹è½½è‡ªå·±æ‰€éœ€çš„ç‰ˆæœ¬ï¼š

![image.png](/img/posts/2022-3-1/2022-3-1-2.png)
å›½å†…ç”¨æˆ·æœªç¿»å¢™çš„å¯èƒ½ä¼šå‡ºç°ä¸‹è½½ç¼“æ…¢çš„é—®é¢˜ï¼Œè¿™é‡Œä½œè€…æå‰ä¸‹è½½å¥½äº†å›½å†…ç‰ˆæœ¬æ”¾åœ¨æ–‡ç« æœ«å°¾ä¾›å¤§å®¶ä¸‹è½½ã€‚

atomä¹Ÿæ˜¯å…è´¹çš„å¼€å‘å·¥å…·ï¼Œè¿™ä¸ªæ ¹æ®è‡ªå·±çš„å–œå¥½æ¥ä½¿ç”¨ã€‚ä½œè€…ä¸€å¼€å§‹å†™ç½‘é¡µä¹Ÿæ˜¯ç”¨çš„atomï¼Œä½†æ˜¯å½“ä½ ä¸‹è½½äº†å®˜ç½‘çš„å®‰è£…åŒ…ï¼Œçœ‹åˆ°ä»–çš„å¤§å°åï¼Œæˆ–è€…åœ¨ä½¿ç”¨å¾ˆé•¿ä¸€æ®µæ—¶é—´åæ‰“å¼€èµ„æºç®¡ç†å™¨åï¼Œä½ å¯èƒ½å°±ä¼šåƒä½œè€…ä¸€æ ·å¼ƒç”¨å®ƒï¼è¿™é‡Œè¿˜æ˜¯ç»™å‡ºå…¶å®˜ç½‘åœ°å€`https://atom.io/`ï¼Œä»–çš„ç•Œé¢ä½œè€…è¿˜æ˜¯æŒºå–œæ¬¢çš„ã€‚

## 3. reacté¡¹ç›®å¼€å‘ç¯å¢ƒæ­å»º
reactå·¥ç¨‹åŒ–é¡¹ç›®åˆ›å»ºçš„è„šæ‰‹æ¶å·¥å…·è¿™é‡Œä½œè€…ä»‹ç»ä¸»æµçš„ä¸¤ç§ï¼š`create-react-app`å’Œ`vite`.
### 3.1. create-react-appæ„å»º
è¿™é‡Œä½¿ç”¨npxå®‰è£…ï¼š`npx create-react-app <å·¥ç¨‹å>`ã€‚
æ³¨æ„å·¥ç¨‹åç§°ä½¿ç”¨å­—æ¯æ•°å­—è¿æ¥çº¿çš„å½¢å¼(èŒƒä¾‹å‚è€ƒï¼š\<https://create-react-app.dev/docs/getting-started/> )ï¼Œè¿™é‡Œä½œè€…ä½¿ç”¨hello-world1.
æ„å»ºæˆåŠŸåä¼šçœ‹åˆ°æ§åˆ¶å°æ‰“å°å¦‚ä¸‹æŒ‡ä»¤ï¼š

![10.png](/img/posts/2022-3-1/2022-3-1-3.png)

è¿›å…¥å·¥ç¨‹æ ¹ç›®å½•`cd ./hello-world1`
> è‹¥åˆ›å»ºæ—¶æ²¡æœ‰å®‰è£…ä¾èµ–æˆåŠŸï¼Œè¿›å…¥å·¥ç¨‹æ ¹ç›®å½•ä¸‹æ‰‹åŠ¨å®‰è£…`npm inatall`å³å¯

æ‰§è¡ŒæŒ‡ä»¤ï¼š`npm start`ï¼Œå¯åŠ¨æˆåŠŸååœ¨æµè§ˆå™¨è¾“å…¥ç½‘å€`localhost:3000`å³å¯çœ‹åˆ°æ¬¢è¿ç•Œé¢ï¼š

![11.png](/img/posts/2022-3-1/2022-3-1-4.png)

### 3.2. viteæ„å»º
ç»ˆç«¯è¾“å…¥æŒ‡ä»¤
```sh
# npm 6.x
npm init vite@latest <å·¥ç¨‹å> --template <æ¨¡æ¿å>
# npm 7+
npm init vite@latest <å·¥ç¨‹å> -- --template <æ¨¡æ¿å>
```
è¿™é‡Œæˆ‘ä»¬å½“ç„¶ä½¿ç”¨`react`ä½œä¸ºæ¨¡æ¿å. hello-world2ä½œä¸ºå·¥ç¨‹åæ¥æ„å»ºå·¥ç¨‹ç›®å½•ã€‚è¾“å…¥æŒ‡ä»¤åä½ ä¼šå‘ç°é¡¹ç›®æ„å»ºçš„å¾ˆå¿«ï¼Œé‚£æ˜¯å› ä¸ºè„šæ‰‹æ¶æ²¡æœ‰é»˜è®¤å¸®ä½ å®‰è£…ä¾èµ–ï¼Œæ‰€ä»¥è¦è¿›å…¥å·¥ç¨‹ç›®å½•ï¼ˆ`cd ./hello-world2`ï¼‰å¹¶æ‰‹åŠ¨å®‰è£…ä¾èµ–ï¼š`npm install`ã€‚ä¾èµ–å®‰è£…å®Œæˆåï¼Œå³å¯å¯åŠ¨é¡¹ç›®ï¼š`npm run dev`ï¼ŒåŒæ ·çš„ï¼Œåœ¨æµè§ˆå™¨è¾“å…¥ç½‘å€`localhost:3000`å³å¯çœ‹åˆ°æ¬¢è¿ç•Œé¢ï¼š

![12.png](/img/posts/2022-3-1/2022-3-1-5.png)

è‡³æ­¤é¡¹ç›®å°±å¯åŠ¨å®Œæ¯•äº†~~ 

å¦‚æœæ‚¨åªæ˜¯æƒ³å¿«é€Ÿå¼€å‘ä¸€ä¸ªé¡¹ç›®ï¼Œç¯å¢ƒé…ç½®åˆ°è¿™é‡Œå°±ç»“æŸäº†ã€‚ä»¥ä¸‹å†…å®¹ä¸ºé€‰æ‹©æ€§è§‚çœ‹å†…å®¹ï¼Œå¦‚æœæ‚¨è§‰å¾—ä¾èµ–å®‰è£…æ¯”è¾ƒæ…¢ï¼Œåˆæˆ–è€…éœ€è¦ç®¡ç†ä¸åŒç‰ˆæœ¬çš„nodeï¼Œå¯ä»¥ç»§ç»­å¾€ä¸‹çœ‹ã€‚

## 4. ä¾èµ–å®‰è£…çš„æ–¹å¼(é€‰è¯»)
ä¸Šè¾¹ç« èŠ‚ä¸­ï¼Œä½œè€…ä¸»è¦ä½¿ç”¨`npm install`çš„æ–¹å¼å®‰è£…ä¾èµ–ï¼Œä½†æ˜¯æœ‰æ—¶å€™ï¼Œå°¤å…¶æ˜¯ç½‘ç»œä¸å¤ªå¥½çš„æƒ…å†µä¸‹ï¼Œä¾èµ–æ€»æ˜¯ä¸èƒ½è¢«æ­£ç¡®å®‰è£…ï¼Œå‡ºç°å®‰è£…é”™è¯¯ã€‚è¿™ä¸ªæ—¶å€™å¯èƒ½å°±éœ€è¦è¿›è¡Œä¸‹ä¸€æ­¥æ“ä½œã€‚
### 4.1. npmå›½å†…é•œåƒé…ç½®
å›½å†…npmé•œåƒå¯ä»¥ç»•å¼€è¢«å¢™çš„å›°æ‰°ï¼Œä½œè€…æ¨ètaobaoçš„é•œåƒã€‚ä½ å¯ä»¥è¿™æ ·æ‰§è¡Œå‘½ä»¤ï¼š
`npm install -g cnpm --registry=https://registry.npm.taobao.org`ï¼Œè¿™æ ·å°±å…¨å±€å®‰è£…äº†ä½¿ç”¨çš„taobaoå›½å†…é•œåƒçš„cnpmæŒ‡ä»¤ã€‚ä½ åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹è¯•è¯•`cnpm install`å°±ä¼šå¿«å¾ˆå¤šã€‚
ä½ è¿˜å¯ä»¥è¿™æ ·é…ç½®é•œåƒï¼š
`npm config set registry https://registry.npm.taobao.org`ï¼Œè¿™æ ·ä½ å³ä½¿ä½¿ç”¨npmæŒ‡ä»¤å®‰è£…ï¼Œä¹Ÿä¼šèµ°å›½å†…é•œåƒå®‰è£…ã€‚

### 4.2. ä¸åŒçš„ä¾èµ–å®‰è£…ç­–ç•¥
å‰ç«¯å·¥ç¨‹åŒ–é¡¹ç›®ä¾èµ–å®‰è£…ä¸åªæœ‰npmæ–¹å¼ï¼Œè¿˜æœ‰ä»–çš„å„ç§å˜ç§ã€‚æ¯”å¦‚å®‰è£…é€Ÿåº¦å¿«ï¼Œç‰ˆæœ¬èƒ½å¤Ÿæ›´å¥½ç»Ÿä¸€çš„`yarn`æˆ–è€…è¿è¡Œé€Ÿåº¦æ›´å¿«çš„`pnpm`ã€‚ç»†å¿ƒçš„è¯»è€…å¯ä»¥å‘ç°ï¼Œä¸Šé¢`create-react-app`å®‰è£…çš„æ–¹å¼ä½¿ç”¨äº†`npx`ï¼Œè€Œæ²¡æœ‰ä½¿ç”¨`npm -g`è¿™ç§å…¨å±€æŒ‡ä»¤æ–¹å¼ã€‚åœ¨`npm 5.2`ä»¥åçš„ç‰ˆæœ¬é»˜è®¤ä¼šå®‰è£…`npx`å‘½ä»¤ï¼Œå®ƒå¯ä»¥é¿å…å…¨å±€å®‰è£…æ¨¡å—ã€‚è¿™äº›ä¸åŒçš„ç­–ç•¥åœ¨ä¹‹åçš„æ–‡ç« ä¸­ä¼šæåŠï¼Œåœ¨è¿™é‡Œä¸åšè¿‡å¤šçš„èµ˜è¿°ã€‚

### 4.3. ä½¿ç”¨nvmç®¡ç†nodeç‰ˆæœ¬
nvmæ˜¯ç›®å‰æ¯”è¾ƒä¸»æµçš„nodeç‰ˆæœ¬ç®¡ç†å·¥å…·ï¼Œç±»ä¼¼çš„è¿˜æœ‰nodistï¼ˆ`https://github.com/nullivex/nodist/releases`ï¼‰ã€‚è¿™é‡Œä»¥nvmä¸ºå‡†è¿›è¡Œä»‹ç»ã€‚
#### 4.3.1. windowsç¯å¢ƒå®‰è£…
è¿›å…¥å®˜ç½‘ä¸‹è½½é“¾æ¥`https://github.com/coreybutler/nvm-windows/releases`ï¼Œä¸‹è½½assetsä¸­çš„å®‰è£…åŒ…ï¼ˆæ–‡ç« æœ«å°¾æä¾›å®‰è£…åŒ…ï¼‰ã€‚

![13.png](/img/posts/2022-3-1/2022-3-1-6.png)

è¿™é‡Œå¯ä»¥ç›´æ¥ä¸‹è½½setupç‰ˆçš„ï¼Œè§£å‹ååŒå‡»å°±å¯å®‰è£…ã€‚å½“ç„¶ä¹Ÿå¯ä»¥é€‰æ‹©noinstallç‰ˆæœ¬çš„ï¼Œé€šè¿‡æ‰‹åŠ¨é…ç½®ç¯å¢ƒæ¥è¾¾åˆ°ç›¸åŒçš„ç›®çš„ã€‚è¿™é‡Œä»¥å®‰è£…ç‰ˆä¸ºä¾‹ã€‚ä¸‹å›¾ä¸ºå®‰è£…ç•Œé¢ï¼š

![14.png](/img/posts/2022-3-1/2022-3-1-7.png)
ä¸€è·¯nextåˆ°åº•å®Œæˆå®‰è£…å³å¯ã€‚ç¯å¢ƒå˜é‡å·²ç»è‡ªåŠ¨é…ç½®å¥½äº†ã€‚
åœ¨å‘½ä»¤è¡Œä¸­æ£€æŸ¥æ˜¯å¦å®‰è£…æˆåŠŸï¼š

![15.png](/img/posts/2022-3-1/2022-3-1-8.png)

çœ‹åˆ°ç‰ˆæœ¬è¯´æ˜å·²ç»æ­£ç¡®å®‰è£…ï¼ï¼
#### 4.3.2. MacOSç¯å¢ƒå®‰è£…ï¼ˆéœ€ç¿»å¢™ï¼‰
è¿›å…¥å®˜ç½‘ä¸‹è½½é“¾æ¥`https://github.com/nvm-sh/nvm#installing-and-updating`ï¼Œå¯ä»¥çœ‹åˆ°å®‰è£…æŒ‡å¼•ï¼Œæˆ‘ä»¬éµä»å®˜æ–¹ç»™çš„æŒ‡ä»¤ç›´æ¥æ‰§è¡Œå³å¯ï¼š
```sh
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.1/install.sh | bash
```
æ¥ä¸‹æ¥æ‚¨å¯èƒ½ä¸ä¼šçœ‹åˆ°å®‰è£…æˆåŠŸï¼Œåè€Œä¼šæç¤ºå¦‚ä¸‹ï¼š
> Failed to connect to raw.githubusercontent.com port 443

è¿™æ˜¯å› ä¸ºæŸç§ç¥ç§˜çš„ä¸œæ–¹åŠ›é‡å¯¼è‡´çš„githubè®¿é—®çš„é—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥å€ŸåŠ©ç½‘å€`https://ipaddress.com/website/raw.githubusercontent.com`æŸ¥ä¸€ä¸‹`githubusercontent.com`çš„çœŸå®IPï¼Œè¾“å…¥githubusercontent.comæŸ¥è¯¢ä¼šçœ‹åˆ°ï¼š

![16.png](/img/posts/2022-3-1/2022-3-1-9.png)
æˆ‘ä»¬æ‰¾ä¸‹è¾¹æŸ¥åˆ°çš„IPå…¶ä¸­ä¸€ä¸ªå³å¯ï¼ˆå¦‚æœä¸è¡Œå°±æ¢ç€è¯•è¯•ï¼‰ï¼Œæ‰§è¡Œä¸‹è¿°æ­¥éª¤ï¼š

1. è¿›å…¥macçš„hostæ–‡ä»¶ï¼š`sudo vim /etc/hosts`
2. æœ€ä¸‹è¾¹è¿½åŠ IPæ˜ å°„

![17.png](/img/posts/2022-3-1/2022-3-1-10.png)

ç»è¿‡è¿™ä¸¤æ­¥åå†æ¬¡å°è¯•ä¸€å“ˆï¼Œå°±å¯ä»¥æ‰§è¡ŒæˆåŠŸäº†ã€‚
```sh
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.1/install.sh | bash
```
å¦‚æœå¾ˆä¸å¹¸ä½ å’å•å‡ºç°äº†å¦‚ä¸‹é”™è¯¯ï¼Œä¸è¦æƒŠæ…Œï¼Œåº”è¯¥æ˜¯æ²¡æœ‰æ£€æµ‹åˆ°ä½ çš„githubè´¦æˆ·ï¼Œä½ åªéœ€è¦æ‰“å¼€githubä¸»é¡µç™»å½•è´¦å·é‡è¯•å³å¯ã€‚
> unable to access 'https://github.com/nvm-sh/nvm.git/': LibreSSL SSL_connect: SSL_ERROR_SYSCALL in connection to github.com:443

æœ€åï¼

å®‰è£…æˆåŠŸçš„ç•Œé¢å¦‚ä¸‹ï¼š

![18.png](/img/posts/2022-3-1/2022-3-1-11.png)

æ­¤æ—¶å…ˆä¸è¦ç€æ€¥ï¼Œå…¨å±€çš„`nvm`æŒ‡ä»¤è¿˜æ²¡æœ‰åŠ å…¥ç¯å¢ƒå˜é‡ä¸­ï¼Œéœ€è¦ä½ æ¥æ‰‹åŠ¨æ·»åŠ ã€‚æ‰§è¡Œå‘½ä»¤(ä»¥zshç»ˆç«¯ä¸ºä¾‹) `sudo vim ~/.zshrc`ï¼Œè¿›å…¥ç¼–è¾‘åï¼Œè¿½åŠ ï¼š
```sh
export NVM_DIR="$([ -z "${XDG_CONFIG_HOME-}" ] && printf %s "${HOME}/.nvm" || printf %s "${XDG_CONFIG_HOME}/nvm")"
[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh" # This loads nvm
```
ç„¶åç”Ÿæ•ˆé…ç½®æ–‡ä»¶ï¼š`source ~/.zshrc`å³å¯ã€‚

ç°åœ¨å°±è¯•è¯•nvmæŒ‡ä»¤ï¼š

![19.png](/img/posts/2022-3-1/2022-3-1-12.png)

æˆåŠŸï¼

##### 4.3.3. nvmåŸºç¡€ä½¿ç”¨

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨`nvm list`å‘½ä»¤æŸ¥çœ‹å½“å‰nodeçš„ç‰ˆæœ¬åˆ—è¡¨

![20.png](/img/posts/2022-3-1/2022-3-1-13.png)

å¯ä»¥çœ‹åˆ°ï¼Œå½“å‰åªæœ‰ç³»ç»Ÿé»˜è®¤çš„16.13.2ç‰ˆæœ¬ã€‚å¦‚æœæƒ³è¦å®‰è£…åˆ«çš„nodeç‰ˆæœ¬ï¼Œæ²¡æœ‰å¿…è¦å†å»nodeå®˜ç½‘ä¸‹è½½äº†ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨nvmæŒ‡ä»¤ä¸‹è½½ã€‚æˆ‘ä»¬å¯ä»¥å…ˆä½¿ç”¨`nvm ls-remote`çœ‹ä¸€ä¸‹å®˜æ–¹éƒ½æœ‰å“ªäº›æ­£å¼ç‰ˆæœ¬ï¼š

![21.png](/img/posts/2022-3-1/2022-3-1-14.png)

åˆ—å‡ºçš„ç‰ˆæœ¬éƒ½æ˜¯å¯ä»¥å®‰è£…çš„ï¼Œæˆ‘ä»¬è¿™é‡Œå¯ä»¥å®‰è£…ç¨³å®šç‰ˆï¼š`nvm install stable`

![23.png](/img/posts/2022-3-1/2022-3-1-15.png)

å¯ä»¥çœ‹åˆ°æˆªæ­¢ä½œè€…å†™è¿™ç¯‡æ–‡ç« æ—¶ï¼Œnodeçš„ç¨³å®šç‰ˆæœ¬æ˜¯17.4.0ï¼Œnvmä¼šè‡ªåŠ¨åˆ‡æ¢è¿›å®‰è£…çš„ç‰ˆæœ¬ä¸Šã€‚å¦‚æœæƒ³è¦è‡ªå®šä¹‰ç‰ˆæœ¬å·å®‰è£…ï¼Œå¯ä»¥ä½¿ç”¨æŒ‡ä»¤`nvm install <ç‰ˆæœ¬å·>`

![24.png](/img/posts/2022-3-1/2022-3-1-16.png)

è¿™é‡Œæˆ‘ä»¬å®‰è£…äº†12.22.10ç‰ˆæœ¬ï¼Œå†æ¬¡`nvm list`å¯ä»¥çœ‹åˆ°å·²ç»æœ‰ä¸‰ä¸ªç‰ˆæœ¬äº†ã€‚æƒ³è¦åœ¨å¤šä¸ªç‰ˆæœ¬ä¹‹é—´åˆ‡æ¢ï¼Œåªéœ€ä½¿ç”¨æŒ‡ä»¤`nvm use <ç‰ˆæœ¬å·>`å³å¯ä¸€é”®åˆ‡æ¢ï¼

![25.png](/img/posts/2022-3-1/2022-3-1-17.png)

windowsä¸‹ä½¿ç”¨è¿‡ç¨‹ä¸­è‹¥å‡ºç°å¦‚ä¸‹é”™è¯¯ï¼š

![image.png](/img/posts/2022-3-1/2022-3-1-18.png)

ä¸€èˆ¬æ˜¯vscodeæˆ–è€…ç»ˆç«¯æ²¡æœ‰ç®¡ç†å‘˜æƒé™ï¼Œä»¥ç®¡ç†å‘˜èº«ä»½æ‰“å¼€å³å¯ã€‚

è‡³æ­¤ï¼Œå‰ç«¯å·¥ç¨‹åŒ–é¡¹ç›®çš„ç¯å¢ƒé…ç½®å·²ç»ç»“æŸï¼ 

## 5. é™„ä»¶
é™„ä»¶æ¸…å•ï¼švscodeå®‰è£…åŒ…. nvmå®‰è£…åŒ…ï¼ˆwinï¼‰. atomå®‰è£…åŒ…ï¼ˆmacï¼‰ã€‚

ä¸‹è½½é“¾æ¥ï¼š
> é“¾æ¥: https://pan.baidu.com/s/1zD2s9UjXrVZ06NANnx8oXg  æå–ç : 5diu44:T2b05,## 0. å¼•è¨€
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ä¸€ä¸ªå¥½çš„å‰ç«¯äº§å“ï¼Œå¿…ç„¶æ˜¯ç”¨æˆ·ä½“éªŒä¼˜ç§€. ä½¿ç”¨æµç•…. æ•°æ®å‡†ç¡®. ç•Œé¢å‹å¥½çš„äº§å“ã€‚è¦æƒ³è¾¾åˆ°è¿™ä¸ªç›®æ ‡ï¼Œä¸€å¼€å§‹çš„æŠ€æœ¯é€‰å‹å°±éœ€è¦éå¸¸æ…é‡ï¼Œä¸èƒ½å›¾ä¸€æ—¶ä¹‹å¿«è€Œå¯¼è‡´åæœŸç»´æŠ¤å‡çº§æˆæœ¬æŒ‡æ•°çº§ä¸Šæ¶¨ï¼Œä¹Ÿä¸èƒ½å¿½è§†å›¢é˜Ÿçš„æŠ€æœ¯æ²¿é©å’Œè€æ¿å¯¹äº§å“å®šä½çš„è¦æ±‚ã€‚

> PS. æŠ€æœ¯é€‰å‹ä»è€…è§ä»ï¼Œæœ¬æ–‡åªè°ˆç»éªŒï¼Œæä¾›ä¸€ä¸ªé€‰å‹çš„æ€è·¯ï¼Œè€Œä¸æ˜¯ç»™ä½ å…·ä½“çš„æ–¹æ¡ˆ

#### é€‰å‹çš„ç›®çš„
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;é¡¾åæ€ä¹‰ï¼Œå°±æ˜¯ä¸ºäº†å®ç°æ”¶ç›Šæœ€å¤§åŒ–ï¼Œæ˜¯äº§å“è¦æ±‚å’ŒæŠ€æœ¯æˆæœ¬ä¹‹é—´çš„ä¸€ä¸ªæƒè¡¡ã€‚

## 1. ä»ä¼ä¸šçš„è§’åº¦è€ƒè™‘é€‰å‹
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ä¼ä¸šçš„å­˜æ´»å®—æ—¨æ˜¯ç”¨æœ€å°‘çš„äººåŠ›æˆæœ¬åˆ›é€ å‡ºå°½å¯èƒ½å¤šçš„ä¼ä¸šæ•ˆç›Šï¼Œä»è¿™ä¸ªå‡ºå‘ç‚¹å°±å¯ä»¥å¾—å‡ºä¼ä¸šå¯¹ä¸€ä¸ªäº§å“é€‰å‹çš„è¦æ±‚ã€‚
#### ä¿è¯äº§å“è´¨é‡æ˜¯åŸºç¡€
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;äº§å“è´¨é‡è¦è¿‡åŸºæœ¬å…³ã€‚ä¸è¦æ±‚èƒ½æœ‰å¾ˆæƒŠè‰³çš„æ•ˆæœï¼Œä½†æ˜¯ä¸€å®šè¦æ»¡è¶³å®¢æˆ·çš„è¦æ±‚ï¼Œç½‘é¡µä¸èƒ½é•¿æ—¶é—´ç™½å±ï¼Œè¦ä¸é”™ä½ä¸å¡æ­»ï¼Œæ“ä½œæ­£å¸¸ï¼Œæ•°æ®ç²¾å‡†ã€‚æ›´è¿›é˜¶ä¸€ç‚¹çš„ï¼Œå¯èƒ½è¿˜ä¼šè¦æ±‚ä¸€å®šçš„äº¤äº’å’Œè§†è§‰ä½“éªŒï¼Œè¿˜æœ‰å¯èƒ½ä¼šåŠ å…¥æ— éšœç¢æ•ˆæœã€‚

> å¦‚æœè¦åŠ å…¥å…¼å®¹é˜¿æ‹‰ä¼¯è¯­ç½‘ç«™æ’ç‰ˆçš„è¯ï¼Œå·²æœ‰çš„æ¶æ„å¯èƒ½å®Œå…¨ä¸èƒ½ç”¨ï¼Œéœ€è¦å•ç‹¬å¢åŠ ä¸€å€çš„å·¥ä½œé‡å†å†™ä¸€å¥— -_- 

#### é™ä½æˆæœ¬æ˜¯å¿…è¦æ¡ä»¶
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æˆæœ¬åŒ…æ‹¬å‰æœŸå¼€å‘æŠ•å…¥çš„äººåŠ›å’ŒåæœŸç»´æŠ¤æŠ•å…¥çš„äººåŠ›ã€‚å‰ææŠ•å…¥äººåŠ›è¶Šå¤šï¼Œå¼€å‘çš„å‘¨æœŸå¯èƒ½ä¼šçŸ­ï¼Œä½†æ˜¯ä¸ä¹‹å¯¹åº”çš„æ˜¯å›¢é˜Ÿåä½œçš„ç®¡ç†æˆæœ¬ä¼šé«˜èµ·æ¥ï¼›å‰æœŸäººæŠ•å…¥çš„å°‘ï¼Œå¯èƒ½æŠ€æœ¯é€‰å‹ä¼šæœ‰æ¼æ´æˆ–è€…å¯æ‰©å±•æ€§ä¸è¶³ï¼ŒåæœŸæ¢äººæ¥ç»´æŠ¤çš„è¯å¯èƒ½ä¼šä¸¾æ­¥ç»´è‰°ï¼Œä¸å¾—ä¸é‡æ„ã€‚

## 2. ä»äº§å“æŠ€æœ¯å½¢æ€ä¸Šæ¥è€ƒè™‘é€‰å‹
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;äº§å“çš„æŠ€æœ¯å½¢æ€æŒ‡çš„æ˜¯å…¶æŠ€æœ¯æ¨¡å¼ï¼Œåˆ†ä¸ºçº¯å‰ç«¯å¼€å‘. å‰åç«¯åˆ†ç¦»å’Œåç«¯é©±åŠ¨çš„å¼€å‘ã€‚

#### çº¯å‰ç«¯é¡µé¢
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;çº¯å‰ç«¯çš„ä¸€èˆ¬æ˜¯ä¸€äº›é™æ€é¡µé¢ï¼Œæ¯”å¦‚ä¸ªäººåšå®¢. ä¸€äº›æ´»åŠ¨é¡µé¢. å®£ä¼ ç½‘ç«™ç­‰ã€‚ä¸€èˆ¬æ¥è¯´ä¸€ä¸ªäººè¶³ä»¥ï¼Œæ­¤æ—¶ä½ å°±ä¸éœ€è¦è€ƒè™‘ä»€ä¹ˆæ¶æ„äº†ï¼Œä½¿ç”¨ä½ æœ€æ“…é•¿çš„æŠ€æœ¯æ ˆå’Œæˆç†Ÿçš„ç”Ÿæˆå·¥å…·ï¼Œèƒ½å¤Ÿå¿«é€Ÿå †ç Œèµ·æ¥é¡µé¢å°±å¥½ã€‚

#### å‰åç«¯åˆ†ç¦»
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;è¿™ç§äº§å“å½¢æ€åº”è¯¥æ˜¯ç›®å‰å¸‚é¢ä¸Šå¤§å¤šæ•°äº§å“çš„å¼€å‘æ¨¡å¼ï¼Œæ¯”å¦‚å¤§å‹çš„ToBé¡¹ç›®. æˆç†Ÿçš„APPç½‘é¡µå®¢æˆ·ç«¯. ç½‘é¡µè´­ç‰©ç­‰ã€‚è¿™ç§çš„äº§å“ï¼Œé¡µé¢æ¸²æŸ“åŸºæœ¬ä¸Šæ˜¯å‰ç«¯çš„å·¥ä½œï¼Œåç«¯åªéœ€è¦æä¾›APIæ–‡æ¡£å³å¯ã€‚

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;è¿™æ ·çš„äº§å“ï¼Œæ¨èåšæˆWebç«¯æ¸²æŸ“æ¡†æ¶å¼€å‘çš„å•é¡µåº”ç”¨ï¼Œæˆ–è€…ä½¿ç”¨node.jsåšæˆç›´å‡ºæ¨¡æ¿æ¸²æŸ“å¼çš„ã€‚å¦‚æœé¡¹ç›®ä¸šåŠ¡æ¯”è¾ƒå¤šï¼Œå¯ä»¥è€ƒè™‘éƒ¨ç½²å‰ç«¯å¾®æœåŠ¡ã€‚

#### åç«¯ä¸»å¯¼å¼€å‘
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;åç«¯ä¸»å¯¼çš„äº§å“å›¢é˜Ÿï¼Œä¸€èˆ¬ä¸Šä¸ä¼šæœ‰å•ç‹¬çš„å‰ç«¯å¼€å‘ç»„ï¼Œéƒ½æ˜¯ä¸€ä¸ªå›¢é˜Ÿé…ä¸€åˆ°ä¸¤ä¸ªå‰ç«¯æ¥é…åˆåç«¯å¼€å‘ã€‚æ­¤æ—¶ä½œä¸ºå‰ç«¯ï¼Œä½ å°±ä¸éœ€è¦æœ‰å¤ªå¤šè‡ªå·±çš„æƒ³æ³•ï¼Œä¸€åˆ‡ä»ç®€å³å¯ã€‚æ¯”å¦‚ä½¿ç”¨å‰ç«¯é¢„å¤„ç†å™¨Sassæ—¶ï¼Œå¯èƒ½å°±éœ€è¦æ…é‡ä¸€äº›ã€‚åŒæ—¶ä¹Ÿä¸è¦æ ‡æ–°ç«‹å¼‚ï¼Œä½¿ç”¨è¿™ä¸ªå›¢é˜Ÿæ²¡æœ‰ç”¨è¿‡çš„å‰ç«¯æ¡†æ¶ï¼Œè·ŸéšåŸæ¥çš„æŠ€æœ¯æ ˆèµ°å³å¯ã€‚

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;è¿™æ—¶å€™ä½ å¯èƒ½å°±ä¼šæ¯”è¾ƒç—›è‹¦ï¼Œä¸€æ–¹é¢è¦ç»´æŠ¤å‰ä»»å†™çš„ä¹±ä¸ƒå…«ç³Ÿçš„ä»£ç ï¼Œä¸€æ–¹é¢åˆä¸èƒ½ç”¨è‡ªå·±æ“…é•¿çš„æŠ€æœ¯ã€‚ä½œè€…å°±â€œæœ‰å¹¸â€åšè¿‡è¿™æ ·çš„äº§å“ã€‚å½“æ—¶åç«¯çš„è¦æ±‚æ˜¯APIæ¥å£æ˜ å°„åç§°ä¸èƒ½å†™æ­»åˆ°ä»£ç é‡Œï¼Œå‰ç«¯è¦åšæˆå¯é…ç½®å¼çš„ï¼›åç«¯ä¸æ„¿æ„ä¿®æ”¹è¿”å›çš„JSONï¼Œæˆ‘ä¸å¾—ä¸ä¸€å±‚å±‚æ¥è§£æåƒæ— åº•æ´ä¸€æ ·æ·±çš„JSONæ•°æ®ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œä¸å›¢é˜Ÿç§¯ææ²Ÿé€šæ˜¯ä¸€æ–¹é¢ï¼Œå¦ä¸€æ–¹é¢æ˜¯æ‰¾å‡†è‡ªå·±çš„å®šä½æ¥ä½¿ç”¨æŠ€æœ¯ã€‚è¿™æ ·æ‰æ˜¯ä¸€ä¸ªå¥½çš„ç¨‹åºå‘˜çš„åŸºæœ¬ä¿®å…»ï¼Œæ¯•ç«Ÿè¿™ä¸ªç¨‹åºä½ ä¸å¯èƒ½è‡ªå·±ä¸€ä¸ªäººæ‹¿å‡ºå»å–ä¸æ˜¯ã€‚

## 3. ä»é¢å‘ç”¨æˆ·ç¾¤æ¥è€ƒè™‘é€‰å‹
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å‰ç«¯äº§å“é¢å‘çš„ç”¨æˆ·ç¾¤ä½“ä¸åŒï¼Œå±•ç°çš„å½¢å¼ä¼šæœ‰å·®å¼‚ï¼Œç°ä»£äº’è”ç½‘å¼€å‘å¯¹äºåŒä¸€ä¸ªç”¨æˆ·ç¾¤åˆåˆ†ä¸ºPCç«¯å’Œç§»åŠ¨ç«¯äº§å“ä¸¤ç§ã€‚ä¸»è¦åˆ†ç±»æœ‰å¦‚ä¸‹å‡ ç§ï¼šå¤–éƒ¨ç”¨æˆ·PCç«¯. å¤–éƒ¨ç”¨æˆ·ç§»åŠ¨ç«¯. å†…éƒ¨ç”¨æˆ·PCç«¯. å†…éƒ¨ç”¨æˆ·ç§»åŠ¨ç«¯ï¼›åŒæ—¶å›½å†…å¤–ç”¨æˆ·çš„ä½¿ç”¨ä¹ æƒ¯ä¹Ÿä¼šæœ‰ç»†å¾®çš„å·®åˆ«ã€‚

#### å¤–éƒ¨ç”¨æˆ·PCç«¯
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å¯¹äºå¤–éƒ¨ç”¨æˆ·ï¼Œè§†è§‰ä½“éªŒæ˜¯ç¬¬ä¸€ä½çš„ï¼ŒPCç«¯ä¸ŠSSRä¹Ÿæ˜¯å¾ˆæœ‰å¿…è¦çš„ã€‚ä½ å¯èƒ½éœ€è¦ä¸€ä¸ªæ¯”è¾ƒå®Œå–„çš„æ¡†æ¶ï¼Œæ”¯æŒSSRé…ç½®å’ŒUIåŠ¨ç”»åº“ï¼Œè€Œä¸”è¦è°ƒç ”æ¸…æ¥šæ˜¯å¦è¦æ”¯æŒIEç”¨æˆ·ï¼ˆç”šè‡³æ˜¯IE8ï¼‰ï¼Œ`JQuery`(æˆ–**Zepto.js**) æœ‰æ—¶ä¹Ÿæ˜¯æ¯”è¾ƒç®¡ç”¨çš„ã€‚

#### å¤–éƒ¨ç”¨æˆ·ç§»åŠ¨ç«¯
**1. ç§»åŠ¨ç«¯è®¿é—®çš„é¡µé¢**

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å³ç”¨æ‰‹æœºæµè§ˆå™¨è®¿é—®Webé¡µé¢ã€‚é¡µé¢åˆ‡æ¢è¿˜éƒ½æ˜¯ä¼ ç»Ÿé“¾æ¥è·³è½¬ï¼Œå±äºä¼ ç»ŸWebé¡µé¢ï¼Œå‰åç«¯åˆ†ç¦»å¼€å‘ï¼Œé¡µé¢ç›´å‡ºæ¸²æŸ“ï¼Œä¸PCç«¯çš„æ¶æ„åŸºæœ¬ä¸€è‡´ï¼Œåªæ˜¯è¦åšä¸€äº›é€‚é…å·¥ä½œã€‚

**2. ç§»åŠ¨ç«¯Nativeåº”ç”¨**

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;è¿™éƒ¨åˆ†äº§å“ç›®å‰æ¥è¯´å¯¹äºå‰ç«¯å¼€å‘ç”¨çš„æŠ€æœ¯æ ˆæ¯”è¾ƒå¤šçš„æ˜¯`React Native`ï¼Œä½œè€…å°±æ›¾ç»åšè¿‡APPé‡Œçš„å¹¿å‘Šé¡µå’Œæ´»åŠ¨è¯¦æƒ…é¡µé¢ã€‚å¦‚æœä½ çš„äº§å“æœ‰NativeåŒ–çš„è¦æ±‚ï¼Œé‚£ä¹ˆæ•´ä¸ªäº§å“æŠ€æœ¯æ ˆé¦–é€‰Reactï¼Œæ¯•ç«Ÿè¦å’ŒReact Nativeå…¼å®¹ã€‚

#### å†…éƒ¨ç³»ç»Ÿç”¨æˆ·
**1. PCè®¿é—®çš„é¡µé¢**

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å†…éƒ¨ç”¨æˆ·ä½¿ç”¨çš„ç®¡ç†ç³»ç»Ÿã€‚è¯¸å¦‚OA. é¡¹ç›®ç®¡ç†ç³»ç»Ÿç­‰ã€‚è¿™äº›éœ€æ±‚æ¯”è¾ƒé€šç”¨ï¼Œå¯ä»¥ä½¿ç”¨å¿«é€Ÿå¼€å‘çš„æ¶æ„ï¼Œä½ ç”šè‡³éƒ½ä¸éœ€è¦ä½¿ç”¨å…¬å¸å†…éƒ¨çš„ç»„ä»¶åº“ï¼Œå¼€æºçš„æ¡†æ¶ + UIåº“ + å›¾è¡¨åº“å®Œå…¨å¯ä»¥æ»¡è¶³è¦æ±‚ã€‚

**2. ç§»åŠ¨ç«¯è®¿é—®çš„é¡µé¢**

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ä¼ä¸šå†…éƒ¨ä½¿ç”¨çš„ç§»åŠ¨ç«¯äº§å“ï¼Œå¤§å¤šä¾é™„äºä¼ä¸šå¾®ä¿¡ç­‰APPã€‚å°±æ‹¿ä¼ä¸šå¾®ä¿¡ä¸¾ä¾‹ï¼Œå·¥ä½œå°å¼€æ”¾æœ‰APIï¼Œæ”¯æŒäºŒæ¬¡å¼€å‘ã€‚è¿™æ ·çš„å†…åµŒH5é¡µé¢ä¹Ÿå¤šä¸ºå•é¡µåº”ç”¨ï¼Œå•ç‹¬éƒ¨ç½²å¹¶é…ç½®å¾®ä¿¡ç›¸å…³éªŒè¯å³å¯ã€‚

#### æµ·å¤–ç”¨æˆ·
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;é’ˆå¯¹æµ·å¤–ç”¨æˆ·ï¼Œé…ç½®PWAæˆ–è€…AMPåº”è¯¥ä¼šæˆä¸ºæ¶æ„é€‰æ‹©çš„ä¸€ä¸ªå¿…é€‰é¡¹ã€‚ç›®å‰ä¸‰å¤§æ¡†æ¶ä¹Ÿéƒ½æ™®éæ”¯æŒPWAã€‚

## 4. ä»äº§å“é¢„æœŸçš„æ•ˆæœæ¥è€ƒè™‘é€‰å‹

#### çŸ­ç”Ÿå‘½å‘¨æœŸ
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;çŸ­ç”Ÿå‘½å‘¨æœŸçš„äº§å“é€šå¸¸è¦æ±‚å¿«é€Ÿèµ·æ­¥ï¼šé—¨æ§›ä½. ä¹¦å†™è‡ªç”±. ä¸å¼ºåˆ¶éµå¾ªä»»ä½•æœ€ä½³å®è·µï¼Œä½¿ç”¨è¿‡åå°±åºŸå¼ƒã€‚è¿™æ—¶å€™å°±éœ€è¦ä½¿ç”¨ç®€å•çš„. ä¸è¿‡åº¦å°è£…çš„æ¶æ„ï¼Œä¸ä½¿ç”¨`eslint`å’Œ`Typescript`ã€‚ç”šè‡³ä¸éœ€è¦å®‰æ’code reviewï¼Œå› ä¸ºä¸è€ƒè™‘åæœŸç»´æŠ¤ã€‚

#### é•¿æœŸäº§å“
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å¯¹äºé•¿æœŸäº§å“ï¼ŒåæœŸç»´æŠ¤æ˜¯æ¯”è¾ƒé‡è¦çš„ã€‚è¦é€‰æ‹©å…·æœ‰å®Œæ•´ç”Ÿæ€çš„æ¶æ„ï¼Œèƒ½å¤Ÿå¹³ç¨³å‡çº§ï¼Œé‡‡ç”¨æ¨¡å—åŒ–å°è£…ä¸šåŠ¡ç»„ä»¶ï¼Œä¸ç”¨ç¡¬ç¼–ç ï¼Œæ§åˆ¶å•æ–‡ä»¶ä»£ç è¡Œæ•°ç­‰ã€‚åŒä¸€ä¸ªäº§å“çº¿ä¸Šçš„äº§å“è¿‡å¤šï¼Œæ¯”å¦‚é˜¿é‡Œäº‘çš„æ¶æ„ï¼Œä¸Šå¾®æœåŠ¡ä¹Ÿæ˜¯å¿…è¦çš„ã€‚

#### æ¢ç´¢æ€§äº§å“
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æ¢ç´¢å‹äº§å“å¾€å¾€ä¹Ÿæ˜¯çŸ­å‘¨æœŸäº§å“ï¼Œæ˜¯éœ€è¦æ¯”è¾ƒæ¿€è¿›çš„æ¢ç´¢æ–°çš„å‰æ²¿æŠ€æœ¯ã€‚å¦‚æœæˆåŠŸäº†ï¼Œå¯èƒ½ä¼šè¿‡æ¸¡åˆ°é•¿å‘¨æœŸäº§å“ä¸Šå»ã€‚è¿™ä¸­é—´éœ€è¦æ¶æ„å¸ˆåšå¥½å¯ç§»æ¤çš„èƒ½åŠ›ã€‚

## 5. æ¯”è¾ƒé€šç”¨çš„å»ºè®®

#### æ¡†æ¶é€‰æ‹©
> `React` OR `Vue` OR `Angular` ?

ç®€å•ä»‹ç»ï¼š
1. Vueä¸Šæ‰‹éš¾åº¦æœ€ä½ï¼Œå­¦å¥½äº†ä¸å®¹æ˜“ï¼Œ`2.0`å¾€`3.0`è¿ç§»ä¹Ÿä¸æ˜¯æ— åˆ›çš„ï¼Œé€æ¸å¼€å§‹å¯¹`TS`æ”¯æŒï¼Œä½†ä¸æ˜¯å¤©ç„¶æ”¯æŒï¼Œéœ€è¦ä½ åœ¨é…ç½®ä¸€ä¸‹ä¸‹ã€‚
2. Reactæ€§èƒ½å¾ˆå¥½ï¼Œä½†åŒæ—¶ä¹Ÿæ¯”è¾ƒéš¾å­¦ï¼Œç‰ˆæœ¬æ›´æ–°çš„å¾ˆå¿«ï¼Œæ–°ç‰ˆæœ¬çš„`Hooks`å¾ˆå¤šäººä¸èƒ½é€‚åº”ã€‚ä¸å¤æ‚å¯¹åº”çš„æ˜¯ä»–çš„çµæ´»æ€§ï¼Œç”Ÿæ€ä¹Ÿåšå¾—å¾ˆå¥½ï¼ŒåŒæ—¶ä¹Ÿæ”¯æŒ`TS`ã€‚
3. Angularå¤©ç„¶æ”¯æŒ`TS`ï¼Œå†…ç½®`Rxjs`ï¼Œå¯åµŒå…¥. æ³¨å…¥å’Œè‡ªå¸¦å•å…ƒæµ‹è¯•ã€‚ä½¿ç”¨è¿‡`Java`çš„åŒå­¦åº”è¯¥ä¼šæ¯”è¾ƒå®¹æ˜“æ¥å—ã€‚ç›®å‰åœ¨å›½å†…ä½¿ç”¨ç‡æ¯”è¾ƒä½ã€‚

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ä½œè€…çš„å»ºè®®æ˜¯ï¼Œ**ç”¨ä½ å›¢é˜Ÿå¸¸ç”¨çš„**ï¼è¿™æ˜¯æœ€ä¸»è¦çš„ï¼Œæˆ‘ä¹‹å‰çš„å…¬å¸æ˜¯ä»æœ€æ—©çš„å‰ç«¯MVCæ¶æ„æ¼”è¿›æ¥çš„ï¼Œä¿ç•™äº†å¤§é‡` Angular 1.x `çš„é¡¹ç›®ï¼Œé‚£å‡çº§è‡ªç„¶æ˜¯å¾€ `2.x `è¿ç§»ï¼ˆè™½ç„¶å®Œå…¨æ˜¯ä¸¤ä¸ªæ¡†æ¶ï¼Œä½†å¹¶ä¸å®Œå…¨æ˜¯! ğŸ¶ï¼›æ­¤å¤–ï¼Œä½ çš„å›¢é˜Ÿå¯¹äºä¹‹å‰ä½¿ç”¨çš„æ¡†æ¶æœ‰ç€å¤§é‡çš„æŠ€æœ¯ç§¯æ·€ï¼Œå°è£…äº†å¤§é‡çš„å·¥å…·åº“. å›¾è¡¨åº“æ¥æ”¯æŒè¿™ä¸ªæ¡†æ¶ï¼Œè´¸ç„¶åˆ‡æ¢æ¶æ„å¯èƒ½éœ€è¦é‡å¤é€ è½®å­ï¼Œå¢åŠ å­¦ä¹ æˆæœ¬ï¼Œé™¤éä½ çš„å®¢æˆ·æŒ‡æ˜è¦ä½ ç”¨ï¼

#### ä¾èµ–å‡çº§çš„å¹³æ»‘åº¦
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;é¡¹ç›®åœ¨æ¡†æ¶å‡çº§çš„æ—¶å€™ï¼Œä½ çš„package.jsoné‡Œçš„ä¾èµ–åº”èƒ½å¤Ÿå¹³æ»‘å‡çº§ï¼Œä½ åœ¨å¼•ç”¨ä¾èµ–ä¹‹å‰ï¼Œè¦å…ˆçœ‹å…¶ä¸»é¡µä¸Šæè¿°çš„æ”¯æŒçš„æ¡†æ¶ç‰ˆæœ¬ï¼Œå¹¶ä¸”è¦æ¸…æ¥šå…¶å°†æ¥ä¼šä¸ä¼šæ”¯æŒæ–°ç‰ˆæœ¬çš„æ¡†æ¶ã€‚å¯¹äºä¸€äº›å·¥å…·å‹çš„ä¾èµ–éƒ½è¿˜å¥½è¯´ï¼Œä½†æ˜¯æœ‰äº›ä¾èµ–ï¼Œæ¯”å¦‚`moment.js`å“ªä¸€å¤©è¯´å…¶ä¸æ”¯æŒ`React18`äº†ï¼ˆå¼€ä¸ªç©ç¬‘ï¼‰ï¼Œä½ çš„é‡æ„æˆæœ¬å°±ä¼šå¾ˆé«˜ã€‚

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ä½œè€…ç»™çš„å»ºè®®æ˜¯ï¼Œå°å‹é¡¹ç›®ç”¨æˆç†Ÿçš„å¼€æºUIåº“å’Œå·¥å…·åº“æ²¡æœ‰å…³ç³»ï¼Œå°†æ¥é‡æ„çš„æˆæœ¬è¿˜èƒ½æ¥å—ï¼Œå†µä¸”å°†æ¥ä¹Ÿä¸å¤ªä¼šæ¶‰åŠåˆ°ä¸»ç‰ˆæœ¬çš„é¢‘ç¹æ›´æ–°ã€‚å¦‚æœæ˜¯é•¿æœŸç»´æŠ¤çš„é‡è¦é¡¹ç›®ï¼Œå»ºè®®ä¸»è¦çš„ä¾èµ–ï¼Œæ¯”å¦‚UIåº“ç­‰æœ€å¥½ä½¿ç”¨å…¬å¸å†…éƒ¨çš„ï¼Œè¿™æ ·åœ¨æ¡†æ¶å‡çº§çš„æ—¶å€™ï¼ŒUIå¯ä»¥åŒæ­¥è·Ÿç€å‡çº§å°±å¥½ï¼Œè€Œä¸ç”¨çœ‹ç¬¬ä¸‰æ–¹åº“çš„è„¸è‰²äº†ã€‚

#### TS or JS
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å›¢é˜Ÿæ²¡ç”¨è¿‡TSï¼Œå°±ä¸è¦è´¸ç„¶ç”¨ï¼Œä¸€ç›´ç”¨TSçš„è¯å°±ä¸€å®šè¦ç”¨ã€‚å¿«é€Ÿé¡¹ç›®ç”¨JSï¼Œå¤§å‹é¡¹ç›®ç”¨TSã€‚

#### UI/å›¾è¡¨åº“é€‰æ‹©
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æœ‰èƒ½åŠ›å°±å›¢é˜Ÿè‡ªå·±å¼€å‘ï¼Œå·®ä¸€ç‚¹çš„å°±å¯¹å¼€æºåº“ï¼Œæ¯”å¦‚UIåº“åƒ`antd`. `elementUI`. `MaterialUI`ç­‰ï¼Œå›¾è¡¨åº“å¦‚`D3.js`. `Apache ECharts`. `g2plot`è¿›è¡ŒäºŒæ¬¡å°è£…åä½¿ç”¨ã€‚

#### ä½œè€…å¸¸ç”¨çš„æŠ€æœ¯æ ˆ
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ä¸‹é¢æ˜¯ä½œè€…å¸¸ç”¨çš„æŠ€æœ¯æ ˆï¼Œç»è¿‡å…¬å¸åå¤æ‰“ç£¨è¿‡çš„ï¼Œæœ‰ä¸€å®šçš„å‚è€ƒä»·å€¼ï¼Œä½†ä¹Ÿä¸è¦ç›²ç›®ç›¸ä¿¡ã€‚

1. `Angular9+` + `ng-zorro` (æˆ–è€…è‡ªå»ºç»„ä»¶åº“) + `lodash-es` + `echarts` + `jsplumb`.
2. `React17+` + `antd/Material UI`ï¼ˆæˆ–è€…è‡ªå»ºç»„ä»¶åº“ï¼‰ + è‡ªå»ºAPI Serviceåº“ + å…¬å¸è‡ªå»ºå¾®æœåŠ¡æ¶æ„ + `moment.js` + `Typescript` + `webpack`ï¼ŒçŠ¶æ€ç®¡ç†ä½¿ç”¨`mobx`.
3. `Vue2` + `Vuex` + `elementUI` + `echarts` + `axios`.
4. ç±»åº“ä½¿ç”¨ `rollup`

## 6. ç»“è®º
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æ²¡æœ‰æœ€å¥½çš„æ¶æ„é€‰æ‹©ï¼Œåªæœ‰é€‚åˆè‡ªå·±çš„ã€‚ä¹Ÿä¸è¦ç›²ç›®ç›¸ä¿¡åˆ«äººçš„ç»éªŒï¼Œè¿˜æ˜¯è¦åŸºäºè‡ªå·±çš„äº§å“å’Œå›¢é˜Ÿè¿›è¡Œè°ƒç ”åï¼ŒæŒ‰ç…§å®äº‹æ¥åˆ¶å®šç­–ç•¥ã€‚


> æ¬¢è¿è¯„è®ºäº¤æµï¼å¦‚æœå‘ç°æœ‰ä¸è¶³çš„åœ°æ–¹ï¼Œå¸Œæœ›å„ä½å¤§ç¥ä¸åèµæ•™ï¼45:Tbd4,è¿˜è®°å¾—å‡ ä¸ªæœˆå‰ï¼Œæ˜é‡‘ä½œè€… ***@çŒ«é—·å°817*** çš„ Vue3 ç‰ˆä¸Šçº¿äº†ï¼Œåœ°å€æ˜¯è¿™ä¸ªï¼š<https://github.com/maomentai817/pixel-ui> ã€‚ç°åœ¨æˆ‘ä¸ä»–åˆä½œçš„ React ç‰ˆä¹Ÿæ¥äº†ï¼Œgithub åœ°å€ï¼š<https://github.com/maomentai817/pixel-ui-react>

***

![image.png](/img/posts/Pixel-UI-React/1.jpeg)

### 1ï¸âƒ£ é¡¹ç›®åˆè¡·

çº¢ç™½æœºã€GameBoy æ¸¸æˆï¼Œé‚£ç§å—çŠ¶åƒç´  UI æ€»è®©äººå¿ƒé©°ç¥å¾€ã€‚ç°åœ¨è™½ç„¶æ˜¯ç°ä»£ Web æ—¶ä»£ï¼Œä½†åƒç´ é£ UI çš„ç¾å­¦ä¾ç„¶ä»¤äººç€è¿·ã€‚

ç°æœ‰çš„ 8-bit é£ç»„ä»¶åº“ *NES.css* æ˜¯ä¸€ä¸ª CSS æ¡†æ¶, å®ƒåªéœ€è¦ CSSï¼Œä¸ä¾èµ–äºä»»ä½• JavaScript, æ ¸å¿ƒç»˜åˆ¶é€»è¾‘éƒ½æ˜¯åŸºäº *box-shadow* å®ç°, ä½†åœ¨ä¸åŒæµè§ˆå™¨ç¯å¢ƒ, æµè§ˆå™¨ç¼©æ”¾æ—¶ï¼Œ*box-shadow* çš„æµ®ç‚¹åç§»å€¼ç»è¿‡ç¼©æ”¾åæ— æ³•ç²¾å‡†å¯¹é½ç‰©ç†åƒç´ ç½‘æ ¼ï¼Œå¯¼è‡´æ¸²æŸ“å‡ºç°é—´éš™ã€‚å­åƒç´ å®šä½ã€åƒç´ èˆå…¥è¯¯å·®å’Œ *box-shadow* æœ¬èº«ä¸é€‚åˆç²¾ç»†æ‹¼æ¥æ¸²æŸ“ç­‰åŸå› é€ æˆäº†ä¸€äº›å›°æ‰°

![QQ\_1747188289846.png](/img/posts/Pixel-UI-React/2.jpeg)

[NES.css](https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnostalgic-css%2FNES.css "https://github.com/nostalgic-css/NES.css")

äºæ˜¯å°±æœ‰äº†åŸºäº Vue 3 / React + TypeScript + UnoCSS + CSS Houdini æ‰“é€ çš„ä¸€æ¬¾ç»„ä»¶åº“ â€”â€” è®©**åƒç´ é£é‡å›å‰ç«¯è§†é‡**ã€‚

Vue3 é¡¹ç›®åœ°å€ğŸ‘‡\
ğŸ“¦ [pixel-ui](https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmaomentai817%2Fpixel-ui "https://github.com/maomentai817/pixel-ui")

React é¡¹ç›®åœ°å€ğŸ‘‡\
ğŸ“¦ [pixel-ui-react](https://github.com/maomentai817/pixel-ui-react)

ç»„ä»¶åº“é¦–é¡µğŸ‘‡\
ğŸ“ [Home](https://maomentai817.github.io/pixel-ui-react)

***

### 2ï¸âƒ£ æŠ€æœ¯é€‰å‹

| æŠ€æœ¯æ ˆ               | ç”¨é€”                       |
| ----------------- | ------------------------ |
| React19 + *Hooks* | ç»„ä»¶åŒ–å¼€å‘æ ¸å¿ƒ                  |
| TypeScript        | ç±»å‹ç³»ç»Ÿå¢å¼ºå¼€å‘ä½“éªŒ               |
| UnoCSS            | åŸå­åŒ– CSSï¼Œçµæ´»é…ç½®æ ·å¼ç±»          |
| CSS Houdini       | è‡ªå®šä¹‰ Paint Worklet æ¸²æŸ“åƒç´ è¾¹æ¡† |
| Dumi              | ç»„ä»¶å±•ç¤º + æ–‡æ¡£ç³»ç»Ÿ              |
| Vitest            | æµ‹è¯•ç»„ä»¶é€»è¾‘ä¸æ¸²æŸ“                |
| pnpm + Monorepo     | é«˜æ•ˆæ„å»ºä¸å¤šåŒ…ç®¡ç†                |

***

### 3ï¸âƒ£ é¡¹ç›®ç›®å‰è¿›åº¦

å·²è¿ç§»ä¸Šçº¿ç»„ä»¶ï¼š

*   âœ… Button æŒ‰é’®
*   âœ… Icon å›¾æ ‡
*   âœ… Overlay é®ç½©å±‚
*   âœ… Text æ–‡æœ¬
*   âœ… ConfigProvider å…¨å±€é…ç½®
*   âœ… Input è¾“å…¥æ¡†
*   âœ… Popconfirm æ°”æ³¡ç¡®è®¤æ¡†
*   âœ… Tooltip æ–‡å­—æç¤º

å·²å‘å¸ƒ npmï¼Œå¯ä¾›ä¸‹è½½ã€‚

> æ›´è¿‡è§„åˆ’è§ vue ç‰ˆï¼š<https://juejin.cn/post/7503846429081944101>

***

### 4ï¸âƒ£ æ•ˆæœé¢„è§ˆ

![image.png](/img/posts/Pixel-UI-React/3.jpeg)

![image.png](/img/posts/Pixel-UI-React/4.jpeg)

![image.png](/img/posts/Pixel-UI-React/5.jpeg)

æ¬¢è¿å¤§å®¶ï¼š

*   ğŸŒŸ ç‚¹ä¸ª Star
*   ğŸ› æ Issueï¼Œæœ‰ä»€ä¹ˆå¥½çš„ç‚¹å­å’Œæƒ³æ³•éƒ½å¯ä»¥æ
*   ğŸ¤ æ PRï¼Œå¢å¼ºå®Œå–„åŠŸèƒ½
*   ğŸ“¢ åˆ†äº«ç»™åƒç´ æ§æœ‹å‹ï¼

> é¡¹ç›®åœ°å€ï¼š<https://github.com/maomentai817/pixel-ui-react>46:Ta042,## 1. è™šæ‹Ÿ DOM

#### ä¸ºä»€ä¹ˆä½¿ç”¨è™šæ‹Ÿ DOMï¼ˆvdomï¼‰

- DOM æ“ä½œå¾ˆæ…¢ï¼Œè½»å¾®çš„æ“ä½œéƒ½å¯èƒ½å¯¼è‡´é¡µé¢é‡æ–°æ’ç‰ˆï¼Œéå¸¸è€—æ€§èƒ½ã€‚ç›¸å¯¹äº DOM å¯¹è±¡ï¼Œjs å¯¹è±¡å¤„ç†èµ·æ¥æ›´å¿«ï¼Œè€Œä¸”æ›´ç®€å•ã€‚é€šè¿‡ diff ç®—æ³•å¯¹æ¯”æ–°æ—§ vdomï¼ˆjs å¯¹è±¡ï¼‰ ä¹‹é—´çš„å·®å¼‚ï¼Œå¯ä»¥æ‰¹é‡çš„ã€æœ€å°åŒ–çš„æ‰§è¡Œ dom æ“ä½œï¼Œä»è€Œæå‡ç”¨æˆ·ä½“éªŒ
- DOM å†…ç½®å±æ€§å¤ªå¤šï¼Œä½¿ç”¨ vdom å¯ä»¥åªå°è£…è‡ªå·±æƒ³è¦çš„å±æ€§æ¥å‡å°‘è®¡ç®—å¼€é”€
  ![å›¾ç‰‡](/img/posts/react/old-dom.png)

#### react æ¸²æŸ“

åœ¨æŸä¸€æ—¶é—´èŠ‚ç‚¹è°ƒç”¨ React çš„ render() æ–¹æ³•ï¼Œä¼šåˆ›å»ºä¸€æ£µç”± React å…ƒç´ ç»„æˆçš„æ ‘ã€‚åœ¨ä¸‹ä¸€æ¬¡ state æˆ– props æ›´æ–°æ—¶ï¼Œç›¸åŒçš„ render() æ–¹æ³•ä¼šè¿”å›ä¸€æ£µä¸åŒçš„æ ‘ã€‚React éœ€è¦åŸºäºè¿™ä¸¤æ£µæ ‘ä¹‹é—´çš„å·®åˆ«æ¥åˆ¤æ–­å¦‚ä½•æœ‰æ•ˆç‡çš„æ›´æ–° UI ä»¥ä¿è¯å½“å‰ UI ä¸æœ€æ–°çš„æ ‘ä¿æŒåŒæ­¥ã€‚è¿™ç§ç®—æ³•èµ·ä¸ªåå­—ï¼Œå«åš DIFF ç®—æ³•ï¼Œå­—é¢æ„æ€ï¼Œå°±æ˜¯å¯¹æ¯”å·®å¼‚ã€‚

#### DIFF

react æ¸²æŸ“æ ‘ï¼š

![å›¾ç‰‡](/img/posts/react/diff-tree.png)

ç®—æ³•ç­–ç•¥

- æ·±åº¦ä¼˜å…ˆéå†
- åŒçº§æ¯”è¾ƒ
- æ‹¥æœ‰ä¸åŒç±»å‹çš„ä¸¤ä¸ªç»„ä»¶å°†ä¼šç”Ÿæˆä¸åŒçš„æ ‘å½¢ç»“æ„ã€‚
- ä½¿ç”¨ key æ¥ä¿æŒç¨³å®šæ¸²æŸ“

diff åŸåˆ™

- åˆ é™¤ï¼šnewVdom ä¸å­˜åœ¨æ—¶
- æ›¿æ¢ï¼švdom å’Œ newVdom ç±»å‹ä¸åŒæˆ– key ä¸åŒæ—¶
- æ›´æ–°ï¼šæœ‰ç›¸åŒç±»å‹å’Œ key ä½† vdom å’Œ newVdom ä¸åŒæ—¶

## 2. Fiber ç»“æ„

ä¸ºä»€ä¹ˆéœ€è¦ fiber

ä¸€ä¸ªæ–°çš„æ›´æ–°æ¸²æŸ“ç»“æ„ï¼Œæ›´å¥½çš„éå†æ¸²æŸ“æ ‘ï¼Œæé«˜æ€§èƒ½ã€‚

- diff ç®—æ³•é‡‡ç”¨æ·±åº¦ä¼˜å…ˆéå†ï¼ˆé€’å½’ï¼‰çš„æ–¹å¼ï¼Œå¯¹äºå¤§å‹é¡¹ç›®ï¼Œç»„ä»¶æ ‘ä¼šå¾ˆå¤§ï¼Œè¿™ä¸ªæ—¶å€™é€’å½’éå†çš„æˆæœ¬å°±ä¼šå¾ˆé«˜ï¼Œä¼šé€ æˆä¸»çº¿ç¨‹è¢«æŒç»­å ç”¨ï¼Œç»“æœå°±æ˜¯ä¸»çº¿ç¨‹ä¸Šçš„å¸ƒå±€ã€åŠ¨ç”»ç­‰å‘¨æœŸæ€§ä»»åŠ¡å°±æ— æ³•ç«‹å³å¾—åˆ°å¤„ç†ï¼Œé€ æˆè§†è§‰ä¸Šçš„å¡é¡¿ï¼Œå½±å“ç”¨æˆ·ä½“éªŒã€‚

fiber æ ¸å¿ƒæ€æƒ³

1. å¢é‡æ¸²æŸ“ï¼Œç©ºé—²æ›´æ–°ï¼ˆæŠŠæ¸²æŸ“ä»»åŠ¡æ‹†åˆ†æˆå—ï¼ŒåŒ€åˆ°å¤šå¸§ï¼‰ï¼Œä½¿ç”¨é“¾è¡¨å¾ªç¯ä»£æ›¿é€’å½’æ¥è¿›è¡Œæ·±åº¦ä¼˜å…ˆéå†ï¼Œç®—æ³•æ—¶é—´å¤æ‚åº¦ O(n)
2. æ›´æ–°æ—¶èƒ½å¤Ÿæš‚åœï¼Œç»ˆæ­¢ï¼Œå¤ç”¨æ¸²æŸ“ä»»åŠ¡
3. ç»™ä¸åŒç±»å‹çš„æ›´æ–°èµ‹äºˆä¼˜å…ˆçº§
4. ç»™æ–°ç‰ˆ react æä¾›å¹¶å‘çš„åŸºç¡€èƒ½åŠ›

![å›¾ç‰‡](/img/posts/react/fiber-1.jpeg)

fiber æ ‘(åŒå‘é“¾è¡¨)ï¼š

```js
// å‚è€ƒ jsx
<div>
  <article>
    <span></span>
  </article>
  <p>
    <strong></strong>
  </p>
  <a></a>
</div>
```

![å›¾ç‰‡](/img/posts/react/fiber-2.png)

å› ä¸ºè¦å€ŸåŠ© fiberï¼Œæ‰€ä»¥åœ¨ vdom å¤–éœ€è¦åŒ…è£…ä¸€ä¸ª fiber node çš„å°è£…æ¥å‚ä¸è°ƒåº¦ã€‚

## 3. å®ç°ä¸€ä¸ª mini-fiber

### ã€‡ æµç¨‹å›¾

![å›¾ç‰‡](/img/posts/react/fiber.png)

### â‘  Tags

ç”±äºè¦æ¸²æŸ“ä¸åŒçš„ç»„ä»¶å’ŒåŸç”Ÿæ ‡ç­¾ï¼Œç»™å„ä¸ªç±»å‹æ‰“ä¸Šæ ‡ç­¾ï¼š

```js
// ReactWorkTags
export const FunctionComponent = 0;
export const ClassComponent = 1;
export const IndeterminateComponent = 2;
...
export const HostComponent = 5;
export const HostText = 6;
export const Fragment = 7;
```

### â‘¡ Fiber å¯¹è±¡

æ–°å»ºä¸€ä¸ª fiber å°è£…ç±»

```js
// ReactFiber
export function createFiber(vnode, returnFiber) {
  const fiber = {
    type: vnode.type, // è¡¨ç¤ºfiberçš„çœŸå®ç±»å‹ è¿™ä¸ªå’ŒelementTypeå¤§éƒ¨åˆ†æƒ…å†µä¸‹æ˜¯ä¸€æ ·çš„ åœ¨ä½¿ç”¨äº†æ‡’åŠ è½½ä¹‹ç±»çš„åŠŸèƒ½æ—¶å¯èƒ½ä¼šä¸ä¸€æ ·ã€‚ åŒºåˆ«äº tagï¼Œtypeå¯ä»¥è‡ªå®šä¹‰ï¼Œå½“æ˜¯ç»„ä»¶æ—¶ typeå¯ä»¥æ˜¯è¿™ä¸ªç»„ä»¶çš„æ„é€ å‡½æ•°ï¼Œç”¨æˆ·åˆ›å»ºå…ƒç´ æ—¶ä½¿ç”¨
    key: vnode.key,
    props: vnode.props, // å±æ€§
    // ç¬¬ä¸€ä¸ªå­èŠ‚ç‚¹fiber
    child: null,
    // ä¸‹ä¸€ä¸ªå…„å¼Ÿfiber
    sibling: null,
    // çˆ¶fiber
    return: returnFiber,
    // domæˆ–å®ä¾‹
    // å‡½æ•°å¼ç»„ä»¶ä¸ºnullï¼Œä»–çš„å®ä¾‹å­˜åœ¨childé‡Œï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆrenderé‡Œåªèƒ½æœ‰ä¸€ä¸ªè·ŸèŠ‚ç‚¹
    stateNode: null,
    // èŠ‚ç‚¹ä¸‹æ ‡
    index: null,
    // old fiber
    alternate: null,
    flags: Placement,
    tag: null,
  };

  const { type } = vnode;

  // æ‰“ tag
  if (isStr(type)) {
    // åŸç”Ÿæ ‡ç­¾
    fiber.tag = HostComponent; // ä¼ å…¥çš„æ˜¯dom.nodeName
  } else if (isFn(type)) {
    // å‡½æ•°ç»„ä»¶ ç±»ç»„ä»¶
    fiber.tag = type.prototype.isReactComponent
      ? ClassComponent
      : FunctionComponent;
  } else if (isUndefined(type)) {
    // æ­¤æ—¶æ˜¯çº¯æ–‡æœ¬æˆ–æ•°å­—èŠ‚ç‚¹
    fiber.tag = HostText;
    fiber.props = { children: vnode };
  } else {
    fiber.tag = Fragment;
  }

  return fiber;
}
```

å…¶ä¸­ flags ç”¨äºåŒºåˆ†æ¥ä¸‹æ¥è¿›è¡Œä»€ä¹ˆæ“ä½œï¼š

```js
export const Placement = /*                    */ 0b0000000000000000000010; // 2
export const Update = /*                       */ 0b0000000000000000000100; // 4
export const Deletion = /*                     */ 0b0000000000000000001000; // 8
```

> çŸ¥é“ä¸ºä»€ä¹ˆä½¿ç”¨ äºŒè¿›åˆ¶å—ï¼Ÿè€ƒè™‘åˆ°å³å°†è¿›è¡Œçš„æ“ä½œå¯èƒ½ä¼šæœ‰å¤šä¸ªï¼Œä¸ºäº†æé«˜å¯æ‰©å±•æ€§ï¼Œä½¿ç”¨äºŒè¿›åˆ¶æ–¹ä¾¿ä½è¿ç®—ï¼Œç›¸åŠ åŒæ ·å…·æœ‰å”¯ä¸€æ€§ã€‚åˆ¤æ–­ï¼š`state & Update === true`

åŒºåˆ† å‡½æ•°å¼ç»„ä»¶å’Œç±»å¼ç»„ä»¶ï¼Œéœ€è¦é¢å¤–åŠ æ ‡å¿—ã€‚æˆ‘ä»¬éƒ½çŸ¥é“ ç±»å¼ç»„ä»¶æœ€ç»ˆéƒ½ä¼šç»§æ‰¿ Component ç»„ä»¶ï¼Œæˆ‘èƒ½å°±åœ¨è¿™ä¸ªä¸Šè¾¹åšæ‰‹è„šï¼š

```js
export default function Component(props) {
  this.props = props;
}

// ç±»ç»„ä»¶æ ‡è®°
Component.prototype.isReactComponent = {};
```

åªè¦åˆ¤æ–­æœ‰æ²¡æœ‰ isReactComponent å°±å¯ä»¥åŒºåˆ†æ˜¯å¦æ˜¯å‡½æ•°å¼ç»„ä»¶äº†ã€‚

å¦‚æ­¤å°±æ„å»ºäº†ä¸€ä¸ªå¯¹ react vdom äºŒæ¬¡å°è£…çš„ Fiber å¯¹è±¡ã€‚

### â‘¢ æ¸²æŸ“å®¹å™¨

æˆ‘ä»¬éƒ½çŸ¥é“ï¼ŒReact 17+ çš„æ ¹ç»„ä»¶æ¸²æŸ“æ–¹å¼ï¼š

```js
// æ–°çš„æ¸²æŸ“æ–¹å¼ï¼Œå¼€æ”¾å‡ºäº† root å¯¹è±¡å•ä¾‹ï¼Œæ–¹ä¾¿é‡å¤render
const root = ReactDOM.createRoot(document.getElementById("root"));
root.render(jsx);

...
root.render(jsx1);
```

é‚£ä¸å¦‚å°±ä»è¿™é‡Œå…¥æ‰‹ï¼Œæ¥çœ‹çœ‹ fiber æ˜¯æ€ä¹ˆå°è£… dom çš„ã€‚

```js
function createRoot(container) {
  const root = {
    containerInfo: container,
  };

  return new ReactDOMRoot(root);
}

function ReactDOMRoot(internalRoot) {
  this._internalRoot = internalRoot;
}
```

createRoot è¿”å›äº†ä¸€ä¸ªæ–°çš„ ReactDOMRoot å¯¹è±¡:

```js
ReactDOMRoot.prototype.render = function (children) {
  const root = this._internalRoot;

  updateContainer(children, root);
};

function updateContainer(element, container) {
  const { containerInfo } = container;

  // è¿™é‡Œå¯ä»¥çœ‹åˆ°ï¼Œ reactçš„å®¹å™¨æ ¹èŠ‚ç‚¹ä¸€å®šæ˜¯åŸç”Ÿçš„domï¼Œä¸ç„¶ä¸å­˜åœ¨nodeName
  const rootFiber = createFiber(element, {
    type: containerInfo.nodeName.toLocaleLowerCase(),
    stateNode: containerInfo,
  });

  scheduleUpdateOnFiber(rootFiber);
}
```

è¿™ä¸ªå¯¹è±¡å®ç°äº† root çš„ render æ–¹æ³•ï¼Œè°ƒç”¨äº† updateContainer æ–¹æ³•ã€‚è€Œè¿™ä¸ªæ–¹æ³•åˆ›å»ºäº†ä¸€ä¸ª Fiber å¯¹è±¡ï¼Œé€šè¿‡ scheduleUpdateOnFiber åŠ å…¥è°ƒåº¦å™¨ï¼š

```js
export function scheduleUpdateOnFiber(fiber) {
  // work in process
  wip = fiber;
  wipRoot = fiber;
}
```

work in process è¡¨ç¤ºå½“å‰æ­£åœ¨å¤„ç†çš„ fiber èŠ‚ç‚¹ã€‚

æˆ‘ä»¬çœ‹åˆ°äº†ï¼Œåˆå§‹åŒ–å·¥ä½œå®Œæˆåï¼Œä¼¼ä¹æ²¡æœ‰æ¸²æŸ“çš„æ“ä½œï¼Œåªæ˜¯ new äº†ä¸€å †å¯¹è±¡ã€‚æ‰€ä»¥éœ€è¦åˆ›å»ºä¸€ä¸ªè°ƒåº¦ä»»åŠ¡ã€‚

### â‘£ è°ƒåº¦å™¨ä¹‹ä¸€

æµè§ˆå™¨æœ‰è‡ªå·±çš„è°ƒåº¦å·¥å…·ï¼š

> è¿™é‡Œæˆ‘ä»¬æš‚ä¸”ä½¿ç”¨æµè§ˆå™¨è‡ªå¸¦çš„ç©ºé—²æ—¶é—´ç‰‡è°ƒåº¦å·¥å…·ã€‚ç”±äºè€ƒè™‘åˆ°å…¼å®¹æ€§ï¼ŒReact è‡ªå·±å®ç°äº†è¿™ä¸ªå‡½æ•°ï¼Œæ”¾åœ¨ Scheduler é‡Œï¼Œä¸‹è¾¹ä¼šè®²åˆ°ã€‚

```js
// TODOï¼šreact scheduler éƒ¨åˆ†åŸç”Ÿå®ç°äº†ä¸€å¥—ï¼šæµè§ˆå™¨äº‹ä»¶å¾ªç¯ç©ºé—²æ—¶é—´æ®µå†…è°ƒç”¨å‡½æ•°æ’é˜Ÿ
requestIdleCallback(workLoop);
```

æˆ‘ä»¬è¿™é‡Œå…³æ³¨çš„é‡ç‚¹è¿˜æ˜¯åœ¨å¦‚ä½•è°ƒåº¦ä¸Šï¼š

```js
function workLoop(IdleDeadLine) {
  // å¯ä»¥è‡ªå·±å®šä¹‰ä¼˜å…ˆçº§æ¥æ ¸å®æ‰§è¡Œä»€ä¹ˆäº‹ä»¶ï¼Œè¿™é‡Œåˆ¤æ–­åªè¦ç©ºé—²å°±æ’é˜Ÿ
  while (wip && IdleDeadLine.timeRemaining() > 0) {
    // æ‰§è¡Œä»»åŠ¡ï¼šä½¿ç”¨æ–°çš„ O(n) ç®—æ³•
    performUnitOfWork();
  }

  // ç¡®ä¿è°ƒåº¦å™¨åœ¨è¿è¡Œ
  requestIdleCallback(workLoop);

  // å¦‚æœæ‰€æœ‰çš„ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ï¼Œcommitä¸€ä¸‹ï¼Œå°±æ˜¯è¯´è§¦å‘ä¸€æ¬¡æ›´æ–°ã€‚ä» root å¼€å§‹åˆ·æ–°ä¸€éæ¸²æŸ“
  if (!wip && wipRoot) {
    commitRoot();
  }
}
```

ä¸Šè¾¹çš„ä»£ç æ˜¯ä¸€ä¸ªå¾ªç¯è°ƒåº¦ï¼Œåå¤è°ƒç”¨ requestIdleCallbackï¼Œè®© CPU åœ¨ç©ºé—²æ—¶é—´ç‰‡è°ƒç”¨æˆ‘ä»¬è‡ªå·±å®šä¹‰çš„è°ƒåº¦å‡½æ•°æ¥æ¸²æŸ“ç•Œé¢ã€‚å½“æœ‰ç©ºé—²æ—¶é—´æ—¶ï¼Œæ‰§è¡Œ performUnitOfWorkï¼Œå½“æ²¡æœ‰å·¥ä½œä¸­çš„ fiber å®ä¾‹ï¼Œè¯´æ˜æ˜¯æ¸²æŸ“æ ¹èŠ‚ç‚¹ï¼Œæ­¤æ—¶ä¸èƒ½å¤ç”¨ä¸Šè¾¹çš„æ›´æ–°é€»è¾‘ï¼Œå› ä¸ºèŠ‚ç‚¹éƒ½è¿˜æ²¡æœ‰å‘¢ï¼Œè°ˆä¸ä¸Šæ›´æ–°ï¼Œæ­¤æ—¶éœ€è°ƒç”¨ commitRootã€‚

æ‰§è¡Œä»»åŠ¡ä»£ç å¦‚ä¸‹ï¼š

```js
// performUnitOfWork
const { tag } = wip;

// é€šè¿‡ tag åŒºåˆ†æ¸²æŸ“æ¨¡å¼
switch (tag) {
  case HostComponent:
    updateHostComponent(wip);
    break;

  case FunctionComponent:
    updateFunctionComponent(wip);
    break;

  case ClassComponent:
    updateClassComponent(wip);
    break;

  case Fragment:
    updateFragmentComponent(wip);
    break;

  case HostText:
    updateTextComponent(wip);
    break;

  default:
    break;
}

// 2. æ›´æ–°wip å¤šå‰æ ‘æ·±åº¦ä¼˜å…ˆéå†
// ä¼˜å…ˆæ‰¾å­©å­ï¼Œæ²¡æœ‰å­©å­å°±æ‰¾å…„å¼Ÿï¼Œæ²¡æœ‰å…„å¼Ÿæ‰¾çˆ¶çº§çš„å…„å¼Ÿï¼Œç›´åˆ°æ‰¾åˆ°æ ¹èŠ‚ç‚¹ã€‚æ—¶é—´å¤æ‚åº¦ï¼šO(n)
if (wip.child) {
  wip = wip.child;
  return;
}

let next = wip;

while (next) {
  if (next.sibling) {
    wip = next.sibling;
    return;
  }
  next = next.return;
}
wip = null;
```

commitRoot ä»£ç å¦‚ä¸‹ï¼š

```js
// commitRoot
commitWorker(wipRoot);
// é˜²æ­¢è¢« å¤šæ¬¡æ‰§è¡Œ
wipRoot = null;

// fiber æ ‘åˆ›å»ºçš„è¿‡ç¨‹
function commitWorker(wip) {
  // ç›´åˆ°æ‰¾ä¸åˆ° wipï¼Œé€€å‡º
  if (!wip) {
    return;
  }
  // è‡ªå·±
  const { stateNode, flags } = wip;
  // çˆ¶domèŠ‚ç‚¹
  const parentNode = getParentNode(wip.return); //wip.return.stateNode;

  // å…·ä½“ flags çš„è®¾ç½®ï¼Œåœ¨ åè¾¹ diff ç®—æ³•ä¸­å®ç°

  // å³å°†åˆ›å»ºçš„
  if (flags & Placement && stateNode) {
    parentNode.appendChild(stateNode);
  }

  // å³å°†æ›´æ–°çš„
  if (flags & Update && stateNode) {
    updateNode(stateNode, wip.alternate.props, wip.props);
  }

  // å³å°†åˆ é™¤çš„
  if (wip.deletions) {
    commitDeletions(wip.deletions, stateNode || parentNode);
  }

  // 2. ä¸‹ä¸€ä¸ªå­©å­
  commitWorker(wip.child);
  // 3. ä¸‹ä¸€ä¸ªå…„å¼Ÿ
  commitWorker(wip.sibling);
}

function getParentNode(wip) {
  // è‡ªå®šä¹‰ç»„ä»¶æ²¡æœ‰å®ä½“ï¼Œreturné‡Œå…¨æ˜¯childï¼Œéœ€å¾€ä¸Šæ‰¾çˆ¶ç»„ä»¶
  let tem = wip;
  while (tem) {
    if (tem.stateNode) {
      return tem.stateNode;
    }
    tem = tem.return;
  }
}

// prev  {a: 1}
// next { b: 3}
export function updateNode(node, prevVal, nextVal) {
  Object.keys(nextVal).forEach((k) => {
    if (k === 'children') {
      // æœ‰å¯èƒ½æ˜¯æ–‡æœ¬ï¼Œæˆ‘ä»¬è‡ªå·±è®¾ç½®çš„æ–‡æœ¬èŠ‚ç‚¹ props.children
      if (isStringOrNumber(nextVal[k])) {
        node.textContent = nextVal[k] + '';
      }
    } else if (k.slice(0, 2) === 'on') {
      const eventName = k.slice(2).toLocaleLowerCase();
      node.addEventListener(eventName, nextVal[k]);
    } else {
      node[k] = nextVal[k];
    }
  });
}

function commitDeletions(deletions, parentNode) {
  for (let i = 0; i < deletions.length; i++) {
    parentNode.removeChild(getStateNode(deletions[i]));
  }
}

function getStateNode(fiber) {
  let tem = fiber;
  while (!tem.stateNode) {
    tem = tem.child;
  }

  return tem.stateNode;
}
```

### â‘¤ æ¸²æŸ“èŠ‚ç‚¹

ä¸Šè¾¹çš„ commit æ“ä½œæˆ‘ä»¬çœ‹åˆ°äº†ï¼Œæ˜¯æ ¹æ®èŠ‚ç‚¹çš„ flags å’Œ stateNode å®ä¾‹æ¥æ›´æ–°çš„ã€‚åœ¨æ¸²æŸ“çš„æ—¶å€™ï¼Œéœ€è¦å†™å…¥è¿™ä¸¤ä»½å±æ€§ï¼Œ

1. æ¸²æŸ“åŸç”ŸèŠ‚ç‚¹ï¼š

createElement åˆ›å»ºå…ƒç´ ï¼Œprops é€šè¿‡ updateNode æ›´æ–°

```js
export function updateHostComponent(wip) {
  // åˆæ¬¡åŠ è½½ï¼ŒstateNode=null
  if (!wip.stateNode) {
    // type : dom.nodeName.toLowerCase()
    wip.stateNode = document.createElement(wip.type);
    // æœ€ç»ˆéƒ½ä¼šå½’ç±»åˆ°åŸç”ŸèŠ‚ç‚¹
    // åˆå§‹åŒ–åœ¨è¿™é‡Œcommitï¼Œä¹‹åçš„æ›´æ–°åœ¨commitWorkeré‡Œcommit
    updateNode(wip.stateNode, {}, wip.props);
  }

  // åè°ƒå­èŠ‚ç‚¹
  reconcileChildren(wip, wip.props.children);
}
```

2. æ¸²æŸ“æ–‡æœ¬èŠ‚ç‚¹

```js
export function updateTextComponent(wip) {
  // è¿˜è®°å¾—ä¸Šè¾¹åŸç”ŸèŠ‚ç‚¹æ”¾åœ¨äº† props.children ä¸­
  wip.stateNode = document.createTextNode(wip.props.children);
}
```

3. æ¸²æŸ“ç±»å¼ç»„ä»¶

```js
export function updateClassComponent(wip) {
  const { type, props } = wip;

  // type æ˜¯ç±»çš„æ„é€ å™¨
  const instance = new type(props);
  const children = instance.render();

  reconcileChildren(wip, children);
}
```

4. æ¸²æŸ“å‡½æ•°å¼ç»„ä»¶

```js
export function updateFunctionComponent(wip) {
  // è¯»å– hook çš„æ“ä½œä¹‹åè®²hookåŸç†æ—¶ä¼šæåˆ°
  // renderWithHooks(wip);
  const { type, props } = wip;

  const children = type(props);

  reconcileChildren(wip, children);
}
```

5. æ¸²æŸ“ Fragment

```js
export function updateFragmentComponent(wip) {
  reconcileChildren(wip, wip.props.children);
}
```

æœ€åæ˜¯è°ƒèŠ‚å­èŠ‚ç‚¹å‡½æ•°ï¼Œè¿™ä¹Ÿæ˜¯ diff ç®—æ³•å®ç°çš„åœ°æ–¹ï¼Œè®¾ç½® flag ä¹Ÿåœ¨è¿™é‡Œï¼š

```js
function reconcileChildren(wip, children) {
  if (isStringOrNumber(children)) {
    return;
  }

  // åŸç”Ÿ dom åªæœ‰ä¸€ä¸ª childï¼Œä¼šæ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œè¿™é‡Œç»Ÿä¸€æ”¾åœ¨æ•°ç»„é‡Œ
  const newChildren = isArray(children) ? children : [children];

  // è®°å½•ä¸Šä¸€ä¸ªfiber
  let previousNewFiber = null;
  let oldFiber = wip.alternate?.child;
  for (let i = 0; i < newChildren.length; i++) {
    const newChild = newChildren[i];
    if (!newChild) {
      // è§„é¿è¿™æ ·çš„å†™æ³•ï¼š {null}
      continue;
    }
    const newFiber = createFiber(newChild, wip);

    const same = sameNode(newFiber, oldFiber);

    if (same) {
      // æ ‡è®°ï¼šæ›´æ–°èŠ‚ç‚¹
      Object.assign(newFiber, {
        stateNode: oldFiber.stateNode,
        alternate: oldFiber,
        flags: Update,
      });
    }

    if (!same && oldFiber) {
      // ä¸æ–°çš„ä¸ä¸€æ ·ï¼Œæ ‡è®°ï¼šåˆ é™¤
      deleteChild(wip, oldFiber);
    }

    if (oldFiber) {
      oldFiber = oldFiber.sibling;
    }

    // createFiber é»˜è®¤çš„ flagså°±æ˜¯æ ‡è¯†ï¼šPlacement æ–°å»º
    if (i === 0) {
      // å­èŠ‚ç‚¹ä¸­çš„ç¬¬ä¸€ä¸ªï¼ŒæŠŠé“¾è¡¨æ„å»ºèµ·æ¥
      wip.child = newFiber;
    } else {
      previousNewFiber.sibling = newFiber;
    }

    previousNewFiber = newFiber;
  }
}

function deleteChild(returnFiber, childToDelete) {
  const deletions = returnFiber.deletions;

  if (deletions) {
    returnFiber.deletions.push(childToDelete);
  } else {
    returnFiber.deletions = [childToDelete];
  }
}

function sameNode(a, b) {
  return a && b && a.type === b.type && a.key === b.key;
}
```

### â‘¥ è°ƒåº¦å™¨ä¹‹äºŒ

è®²è‡ªå®šä¹‰è°ƒåº¦ CPU ç©ºé—²æ—¶é—´ç‰‡ä¹‹å‰ï¼Œå…ˆå›é¡¾ä¸€ä¸‹ä¹‹å‰åŠ å…¥è°ƒåº¦å™¨çš„å‡½æ•°ï¼š

```js
// rootèŠ‚ç‚¹è°ƒç”¨
export function scheduleUpdateOnFiber(fiber) {
  // work in process
  wip = fiber;
  wipRoot = fiber;

  // æ–°å»ºä¸€ä¸ªè‡ªå®šä¹‰çš„è°ƒåº¦
  scheduleCallback(workLoop);
}
```

ä¸Šè¾¹ä¸ºäº†ä¸ä½¿ç”¨ js è‡ªå¸¦çš„è°ƒåº¦å™¨ requestIdleCallbackï¼Œreact è¿™é‡Œè‡ªå®šä¹‰äº†è°ƒåº¦çš„å®ç°ã€‚æˆ‘ä»¬æ¥ç®€æ˜“å®ç°ä¸€ä¸‹è¿™ä¸ªè°ƒåº¦å™¨ï¼š

---

ï¼ˆè°ƒåº¦å™¨å®ç°å¼€å§‹ï¼‰

```js
// scheduler.js
// ç‰µæ‰¯åˆ°æœ€å°å †çš„ç®—æ³•ï¼Œå¯ä»¥å‚è€ƒçŸ¥è¯†åº“ä¸­åŸºç¡€éƒ¨åˆ†ç®—æ³•
import { push, pop, peek } from './minHeap';

// ä»»åŠ¡é˜Ÿåˆ—
let taskQueue = [];
// ä»»åŠ¡è®¡æ•°
let taskIdCounter = 1;

// ä»»åŠ¡ä¼˜å…ˆçº§ å»¶è¿Ÿæ—¶é—´
export function scheduleCallback(callback) {
  const currentTime = getCurrentTime();

  const timeout = -1; // æºç ä¸­è¿˜ä¼šæœ‰ priorityLevel ä½œä¸ºä¸€ä¸ªæƒé‡ç»´åº¦
  const expirationTime = currentTime + timeout;

  // æ¯æ¬¡è°ƒåº¦ï¼Œidè‡ªå¢ï¼Œpushè¿›å †
  const newTask = {
    id: taskIdCounter++,
    callback, // å›è°ƒå‡½æ•°
    expirationTime, // ä»»åŠ¡å¼€å§‹æ—¶é—´
    sortIndex: expirationTime, // ä»»åŠ¡æ’åºï¼Œå–å†³äºè¿‡æœŸæ—¶é—´ï¼ˆè¿™é‡Œç®€å•çš„ä»»åŠ¡è¿‡æœŸæ—¶é—´è¶Šè¿‘ï¼Œä¼˜å…ˆçº§è¶Šé«˜ï¼‰
  };
  push(taskQueue, newTask);

  // è¯·æ±‚è°ƒåº¦
  requestHostCallback();
}

// MessageChannelå…è®¸æˆ‘ä»¬åœ¨ä¸åŒçš„æµè§ˆä¸Šä¸‹æ–‡ï¼Œæ¯”å¦‚window.open()æ‰“å¼€çš„çª—å£æˆ–è€…iframeç­‰ä¹‹é—´å»ºç«‹é€šä¿¡ç®¡é“ï¼Œå¹¶é€šè¿‡ä¸¤ç«¯çš„ç«¯å£ï¼ˆport1å’Œport2ï¼‰å‘é€æ¶ˆæ¯ã€‚MessageChannelä»¥DOM Eventçš„å½¢å¼å‘é€æ¶ˆæ¯ï¼Œæ‰€ä»¥å®ƒå±äºå¼‚æ­¥çš„å®ä»»åŠ¡ã€‚
const channel = new MessageChannel();
const port = channel.port2;
channel.port1.onmessage = function () {
  handleWorkMessage();
};

function requestHostCallback() {
  port.postMessage(null);
}

function handleWorkMessage() {
  // æ¯æ¬¡å–å‡ºå †é¡¶æœ€å°çš„
  let currentTask = peek(taskQueue);
  while (currentTask) {
    // æš‚ä¸è€ƒè™‘æ‰§è¡Œè¿›åº¦ä»¥åŠä¸­æ–­æ‰§è¡Œ
    const callback = currentTask.callback;
    currentTask.callback = null;
    callback();
    // åˆ é™¤ä»»åŠ¡
    pop(taskQueue);
    // æ‹¿å½“å‰ç­‰å¾…æ—¶é—´æœ€å°çš„ä»»åŠ¡
    currentTask = peek(taskQueue);
  }
}

function getCurrentTime() {
  // Date.now()ï¼šè¿”å›çš„æ—¶é—´æˆ³æ²¡æœ‰è¢«é™åˆ¶åœ¨ä¸€æ¯«ç§’çš„ç²¾ç¡®åº¦å†…ï¼Œå°äº 1ms çš„æµ‹è¯•ä¸å‡ºæ¥ç»“æœã€‚
  // performance.now()ï¼šè¿”å›çš„æ—¶é—´æˆ³ä»¥åŒç²¾åº¦æµ®ç‚¹æ•° double çš„å½¢å¼è¡¨ç¤ºæ—¶é—´ï¼Œç²¾åº¦æœ€é«˜å¯è¾¾å¾®ç§’çº§ã€‚ä¸å—ç³»ç»Ÿå½±å“ã€‚Date.now() çº¦ç­‰äº performance.timing.navigationStart + performance.now()
  return performance.now();
}
```

ï¼ˆè°ƒåº¦å™¨å®ç°ç»“æŸï¼‰

---

æ­¤æ—¶è°ƒåº¦å™¨å¤–è¾¹çš„ loop å‡½æ•°å°±å¯ä»¥ç²¾ç®€äº†ï¼š

```js
function workLoop() {
  while (wip) {
    performUnitOfWork();
  }

  // ç¡®ä¿è°ƒåº¦å™¨åœ¨è¿è¡Œ
  // requestIdleCallback(workLoop);

  if (!wip && wipRoot) {
    commitRoot();
  }
}
```

### ã€‡ æ”¹è¿›çš„æµç¨‹å›¾

![å›¾ç‰‡](/img/posts/react/fiber-3.png)

## 4. Hooks

å†™åœ¨å‰è¾¹ï¼šHooks ä¸¥æ ¼æ¥è¯´ä¹Ÿæ˜¯ fiber çš„ä¸€éƒ¨åˆ†ï¼Œä¹Ÿç‰µæ‰¯åˆ° diff å’Œè°ƒåº¦ï¼Œå•ç‹¬æ‹¿å‡ºæ¥æ˜¯å› ä¸ºä»–ç¡®å®æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„æ¦‚å¿µï¼ŒåŒæ—¶ä¹Ÿé¿å…ä¸Šä¸€ä¸ªç« èŠ‚å¤ªè¿‡è‡ƒè‚¿ã€‚

`Hooks` æœ¬è´¨å°±æ˜¯å¤„ç†å‡½æ•°å¼ç»„ä»¶çš„çŠ¶æ€çš„é›†åˆã€‚çŠ¶æ€ï¼Œæ˜¯ react vdom ä¸­è‡ªå®šä¹‰çš„ä¸€ä¸ªå±æ€§ï¼Œæˆ‘ä»¬åœ¨ fiber åŒ–ä¹‹åä¹Ÿåº”è¯¥æœ‰ï¼Œè¿™é‡ŒåŠ ä¸Šï¼š

```js
export function createFiber(vnode, returnFiber) {
  const fiber = {
    ...
    memorizedState: null
  }
}
```

memorizedState å±æ€§å¯¹äºç±»å¼ç»„ä»¶å­˜æ”¾çš„æ˜¯ state å¯¹è±¡ï¼Œå¯¹äºå‡½æ•°å¼ç»„ä»¶æ¯”è¾ƒéº»çƒ¦ï¼Œå› ä¸º hooks æ˜¯ä¸€ä¸ªä¸€ä¸ªçš„ï¼Œæ‰€ä»¥è¿™é‡Œåˆç”¨äº†é“¾å¼å­˜å‚¨ï¼ŒmemorizedState å­˜æ”¾ç¬¬ä¸€ä¸ª hooks æŒ‡é’ˆå³å¯ã€‚

å› ä¸º hooks æ˜¯å‡½æ•°å¼ç»„ä»¶ç‰¹æœ‰çš„ï¼Œæ‰€ä»¥åªä¼šåœ¨æ¸²æŸ“å‡½æ•°å¼ç»„ä»¶æ—¶ä½¿ç”¨ï¼š

```js
export function updateFunctionComponent(wip) {
  // è¿™é‡Œè°ƒç”¨
  renderWithHooks(wip);

  const { type, props } = wip;
  const children = type(props);
  reconcileChildren(wip, children);
}
```

æˆ‘ä»¬æ–°å»ºä¸€ä¸ª hooks.js æ–‡ä»¶æ¥åŒæ„å¤„ç† hookã€‚

å…ˆå¤„ç† hooks ä¸­çš„å…¨å±€å±æ€§ï¼š

```js
let currentlyRenderingFiber = null;
// è€hook, åœ¨useEffectä¸­ä½¿ç”¨
let currentHook = null;
// å½“å‰å·¥ä½œä¸­çš„hookï¼ŒåŒwipä¸€æ ·ï¼Œhooksä¹Ÿæ˜¯ä¸€ä¸ªé“¾è¡¨ï¼Œéœ€è¦ä¸€ä¸ªå½“å‰çš„æŒ‡é’ˆä½ç½®æ ‡è¯†
let workInProgressHook = null;

export function renderWithHooks(wip) {
  currentlyRenderingFiber = wip;
  currentlyRenderingFiber.memorizedState = null;
  workInProgressHook = null;
}
```

è¿™é‡Œç±»æ¯”å‰é¢çš„ fiber åº”è¯¥å¥½ç†è§£ï¼Œè®²å½“å‰ wip ä¼ å…¥å˜é‡ currentlyRenderingFiberï¼Œå¹¶åˆå§‹åŒ–ã€‚

æ¥ç€å†™ä¸€ä¸ªé€šç”¨çš„æ–¹æ³•æ¥æ„é€ å‡½æ•°å¼ç»„ä»¶ä¸­ hooks çš„é“¾è¡¨å…³ç³»ï¼š

```js
function updateWorkInProgressHook() {
  let hook;

  // æ‹¿åˆ°å½“å‰ fiber åœ¨ diff ä¸­çš„ old fiber
  const current = currentlyRenderingFiber.alternate;

  if (current) {
    // 2.æ›´æ–°
    currentlyRenderingFiber.memorizedState = current.memorizedState;

    if (workInProgressHook) {
      // å½“å‰ hook æŒ‡é’ˆçš„ä½ç½®
      workInProgressHook = hook = workInProgressHook.next;
      currentHook = currentHook.next;
    } else {
      // æ²¡æœ‰æŒ‡é’ˆï¼Œå°±ä» hook0 å¼€å§‹
      workInProgressHook = hook = currentlyRenderingFiber.memorizedState;
      currentHook = current.memorizedState;
    }
  } else {
    // currentHook åªæœ‰åœ¨ fiber å˜æ›´æ—¶æ‰èµ·ä½œç”¨ï¼Œä¸ç„¶ä¸€ç›´æ˜¯ null
    currentHook = null;

    // 1.åˆæ¬¡æ¸²æŸ“
    hook = {
      memorizedState: null, // state
      next: null, // ä¸‹ä¸€ä¸ªhook
    };

    if (workInProgressHook) {
      // å¦‚æœå·²ç»æœ‰hookï¼Œå°±æ‰¾é“¾è¡¨ä¸‹ä¸€ä¸ªï¼Œç§»åŠ¨æŒ‡é’ˆ
      workInProgressHook = workInProgressHook.next = hook;
    } else {
      // ä¸ç„¶å°±åˆå§‹åŒ–memorizedState
      workInProgressHook = currentlyRenderingFiber.memorizedState = hook;
    }
  }

  return hook;
}
```

åˆ°è¿™é‡Œï¼Œä¸€ä¸ªç®€å•çš„ Hooks å°±åˆå§‹åŒ–å®Œæˆå•¦ã€‚æ¥ä¸‹æ¥çœ‹çœ‹å…·ä½“çš„ hooks æ€ä¹ˆç”¨å§ã€‚

### â‘  useReducer

useReducer æ˜¯ useState çš„æ›¿ä»£å“ï¼Œä½¿ç”¨çš„æ–¹å¼å¦‚ä¸‹ï¼š

```js
// å£°æ˜
const initialState = 1;
const reducer = (state: number, action: any | { type: string, value: any }) => {
  return state + 1;
};

const [count, dispatch] = useReducer(reducer, initialState);

// è°ƒç”¨
dispatch('add');
```

åˆ†æä¸€ä¸‹ï¼ŒuseReducer ä¹Ÿæ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œæ¥å—ä¸€ä¸ªå¤„ç†å‡½æ•° reducer å’Œä¸€ä¸ªåˆå§‹å€¼ï¼›åŒäº‹è¿”å›ä¸€ä¸ªå½“å‰çš„æœ€æ–°å€¼å’Œè§¦å‘ reducer çš„å‡½æ•° dispatchï¼Œè¿™ä¸ª dispatch å¯ä»¥æ¥å—ä¸€ä¸ª action å‚æ•°ï¼Œaction å¯ä»¥æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ä¹Ÿå¯ä»¥æ˜¯ ä¸€ä¸ªå¯¹è±¡ï¼š`{ type, value }`ã€‚

æˆ‘ä»¬å®šä¹‰è¿™ä¸ªå‡½æ•°ï¼š

```js
export function useReducer(reducer, initalState) {
  // æ‹¿åˆ°å½“å‰çš„ workInProgressHook
  const hook = updateWorkInProgressHook();
  // ç»™åˆå§‹å€¼
  if (!currentlyRenderingFiber.alternate) {
    // å¦‚æœæ²¡æœ‰ç»è¿‡ diff æ ‡è®°èµ‹å€¼ alternateï¼Œè¯´æ˜è¿˜æ²¡æœ‰åˆå§‹åŒ–è¿‡ stateã€‚æ²¡æœ‰å¯¹æ¯”å°±ä¸ä¼šå­˜åœ¨ state æ”¹å˜
    hook.memorizedState = initalState;
  }

  ...
}
```

æ¥ä¸‹æ¥å°±æ˜¯å®ç° å°† reducer è½¬å˜ä¸º dispatch äº†ã€‚

æˆ‘ä»¬å£°æ˜ä¸€ä¸ªè½¬æ¢å‡½æ•°ï¼š

```js
function dispatchReducerAction(fiber, hook, reducer, action) {
  // hook.memorizedState = reducer ? reducer(hook.memorizedState) : action;
  if (reducer) {
    hook.memorizedState = reducer(hook.memorizedState, action);
  } else {
    // useState: setState(1);
    hook.memorizedState = action;
  }

  // æ›´æ–° alternateï¼Œ fiberå·²ç»æ”¹å˜
  fiber.alternate = { ...fiber };
  // å…„å¼ŸèŠ‚ç‚¹ç½®ç©ºï¼Œæ„æ€æ˜¯åªæ›´æ–°å½“å‰å‡½æ•°èŠ‚ç‚¹å³å¯ã€‚è¿™é‡Œä¸ç”¨æ‹…å¿ƒé“¾è¡¨æ–­æ‰ï¼ŒreconcileChildren ä¸­ä¼šé‡æ–°æ„é€ é“¾è¡¨å…³ç³»ã€‚hook æ›´æ–°åªæ˜¯æ®å±€éƒ¨æ›´æ–°
  fiber.sibling = null;
  scheduleUpdateOnFiber(fiber);
}
```

ç”±äº å‚æ•° fiber, hook, reducer æ˜¯æˆ‘ä»¬å†…éƒ¨å¤„ç†çš„ï¼Œåªæœ‰ action æ˜¯å¤–éƒ¨ä¼ çš„ï¼Œæ‰€ä»¥ï¼Œæˆ‘ä»¬åœ¨ useReducer è¿™é‡Œ bind ä¸€ä¸‹ï¼š

```js
// useReducer å‡½æ•°
...

// bind åˆ° null ä¸Šï¼Œæ˜¯ä¸ºäº†è®© currentlyRenderingFiber æ›´æ–°ï¼Œç›´æ¥è°ƒç”¨ dispatchReducerActionï¼Œå…¶æŒ‡é’ˆæŒ‡å‘æ²¡æœ‰å˜åŒ–ï¼Œæœ‰å¤šä¸ªå‡½æ•°å¼ç»„ä»¶æ—¶ï¼Œä¼šäº§ç”Ÿæ¸²æŸ“é”™ä¹±ã€‚
// currentlyRenderingFiber ä½œä¸ºä¸€ä¸ªå½¢å‚å­˜è¿›æ¥ï¼Œå½¢æˆäº†ä¸€ä¸ªé—­åŒ…ã€‚å¦‚æœæœ‰å¤šä¸ªå‡½æ•°å¼ç»„ä»¶éƒ½æœ‰hooksçš„è¯ï¼Œä»–ä»¬çš„currentlyRenderingFiberæ˜¯å„è‡ªçš„fiberï¼Œä¸ä¼šé€ æˆæŒ‡é’ˆæ··ä¹±ã€‚
const dispatch = dispatchReducerAction.bind(
  null,
  currentlyRenderingFiber,
  hook,
  reducer
);

return [hook.memorizedState, dispatch];
```

### â‘¡ useState

useState æ˜¯ useReducer çš„ä¸€ä¸ªç‰¹æ®Šå½¢æ€ï¼Œæ²¡æœ‰ reducerï¼Œæ¯æ¬¡åªè¿”å› action é‡Œçš„å€¼ã€‚

```js
// reducer ä¸º null
export function useState(initialState) {
  return useReducer(null, initialState);
}
```

### â‘¢ useEffect / useLayoutEffect

useEffect åœ¨é¡µé¢æ¸²æŸ“å®Œæˆåè¿›å…¥è°ƒåº¦é˜Ÿåˆ—æ‰§è¡Œï¼Œæ˜¯å¼‚æ­¥çš„ã€‚useLayoutEffect åˆ™æ˜¯åŒæ­¥æ‰§è¡Œå‰¯ä½œç”¨æ“ä½œï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå®ƒä¼šåœ¨æµè§ˆå™¨æ¸²æŸ“ä¹‹å‰è¿è¡Œã€‚

ç”±äº useEffect ä¹Ÿå¯ä»¥æœ‰å¤šä¸ªï¼Œæ‰€ä»¥ï¼Œä»ç„¶æ˜¯æŒ‰ç…§é“¾è¡¨çš„æ–¹å¼å­˜å‚¨çš„ï¼Œè¿™é‡Œä¸ºäº†ä¾¿äºå¤§å®¶ç†è§£ï¼Œæš‚æ—¶ç”¨æ•°ç»„ä»£æ›¿ï¼š

```js
export function renderWithHooks(wip) {
  // old
  currentlyRenderingFiber = wip;
  currentlyRenderingFiber.memorizedState = null;
  workInProgressHook = null;

  // ä¸ºäº†æ–¹ä¾¿ï¼ŒuseEffectä¸useLayoutEffectåŒºåˆ†å¼€ï¼Œå¹¶ä¸”ä»¥æ•°ç»„ç®¡ç†
  // æºç ä¸­æ˜¯æ”¾ä¸€èµ·çš„ï¼Œå¹¶ä¸”æ˜¯ä¸ªé“¾è¡¨
  currentlyRenderingFiber.updateQueueOfEffect = [];
  currentlyRenderingFiber.updateQueueOfLayout = [];
}
```

ç”±äº useEffect å’Œ useLayoutEffect éƒ½æ˜¯åœ¨ç»„ä»¶åŠ è½½çš„æŸä¸ªæ—¶æœºæ‰§è¡Œä¸€æ®µæ–¹æ³•ã€‚æˆ‘ä»¬æŠŠå…¬å…±çš„å®ç°æå–å‡ºæ¥ï¼š

```js
function updateEffectImp(hooksFlags, create, deps) {
  const hook = updateWorkInProgressHook();

  // åˆå§‹åŒ–æ—¶æ²¡æœ‰ currentHookï¼Œå¿…ç„¶ä¼šèµ°åˆ°ä¸‹è¾¹æ‰§è¡Œå‡½æ•°ï¼Œç»„ä»¶çŠ¶æ€å˜æ›´æ—¶ï¼Œä¼šèµ‹å€¼ currentHookï¼Œç”¨äºæ‹¦æˆªæ˜¯å¦è¦æ›´æ–°
  if (currentHook) {
    // ç”¨äºæ ¡éªŒä¸¤æ¬¡ ä¾èµ– æ˜¯å¦æœ‰å˜åŒ–
    const prevEffect = currentHook.memorizedState;
    if (deps) {
      const prevDeps = prevEffect.deps;
      if (areHookInputsEqual(deps, prevDeps)) {
        return;
      }
    }
  }

  const effect = { hooksFlags, create, deps };

  hook.memorizedState = effect;

  // useEffect
  if (hooksFlags & HookPassive) {
    currentlyRenderingFiber.updateQueueOfEffect.push(effect);
    // useLayoutEffect
  } else if (hooksFlags & HookLayout) {
    currentlyRenderingFiber.updateQueueOfLayout.push(effect);
  }
}

// ! HookFlags
export const HookLayout = /*    */ 0b010;
export const HookPassive = /*   */ 0b100;

export function areHookInputsEqual(nextDeps, prevDeps) {
  if (prevDeps == null) {
    return false;
  }

  // è¿™é‡Œåªæ˜¯ç®€å•çš„æŒ‰ä½ç½®ç´¢å¼•å¯¹æ¯”
  for (let i = 0; i < prevDeps.length && i < nextDeps.length; i++) {
    if (Object.is(nextDeps[i], prevDeps[i])) {
      continue;
    }
    return false;
  }

  return true;
}
```

æœ€å¤–å±‚çš„è°ƒç”¨å¯ä»¥è¿™æ ·å†™ï¼š

```js
export function useEffect(create, deps) {
  return updateEffectImp(HookPassive, create, deps);
}

export function useLayoutEffect(create, deps) {
  return updateEffectImp(HookLayout, create, deps);
}
```

ç»è¿‡ä¸Šé¢çš„å‡½æ•°åï¼Œç»„ä»¶å†…æ‰€æœ‰çš„ useEffect å°±éƒ½æ”¶é›†åœ¨æ•°ç»„ä¸­äº†ã€‚æ¥ä¸‹æ¥å°±æ˜¯æ‰¾ä¸ªæ—¶æœºè¿›åº¦è°ƒåº¦ã€‚åˆ†æä¸€ä¸‹ï¼Œä¼ é€’çš„å‡½æ•°éœ€è¦åœ¨ç•Œé¢æ¸²æŸ“å‰åè°ƒç”¨ï¼Œæ‰€ä»¥åº”è¯¥åœ¨ diff ä¹‹åï¼Œæˆ‘ä»¬å°±æŠŠå®ƒåŠ åœ¨ commit å‡½æ•°ä¸­ï¼š

```js
function commitWorker(wip) {
  // ...

  if (wip.tag === FunctionComponent) {
    invokeHooks(wip);
  }

  // 2. æäº¤å­èŠ‚ç‚¹
  commitWorker(wip.child);
  // 3. æäº¤å…„å¼Ÿ
  commitWorker(wip.sibling);
}
```

åœ¨å½“å‰èŠ‚ç‚¹å˜åŒ–æ›´æ–°å®Œä¹‹åï¼Œè¿˜æ²¡æœ‰æ¸²æŸ“å­èŠ‚ç‚¹ä¹‹å‰ï¼Œæ£€æŸ¥ä¸€ä¸‹æ˜¯å¦æœ‰ useEffect å’Œ useLayoutEffectï¼š

```js
// ä¹‹å‰å†™çš„è°ƒåº¦å‡½æ•°
import { scheduleCallback } from './scheduler';

// æ ¸å¿ƒè°ƒç”¨ä»£ç ç¤ºä¾‹
function invokeHooks(wip) {
  const { updateQueueOfEffect, updateQueueOfLayout } = wip;

  // åŒæ­¥ï¼Œé˜»å¡äº† commitWorker
  for (let i = 0; i < updateQueueOfLayout.length; i++) {
    const effect = updateQueueOfLayout[i];
    // æœªå¤„ç†å…¶è¿”å›å€¼
    effect.create();
  }

  // åŠ å…¥è°ƒåº¦ï¼Œä¸€èˆ¬ä¼šåœ¨æ¸²æŸ“ç»“æŸåæ‰§è¡Œ
  for (let i = 0; i < updateQueueOfEffect.length; i++) {
    const effect = updateQueueOfEffect[i];

    scheduleCallback(() => {
      effect.create();
    });
  }
}
```

> æ€è€ƒï¼šè¿˜è®°å¾— Effect çš„å‡½æ•°æœ‰ return ä¹ˆï¼Ÿåœ¨å‰¯ä½œç”¨æ¶ˆå¤±æ—¶è°ƒç”¨ã€‚è¿™é‡Œï¼Œeffect.create() çš„è¿”å›å€¼å°±æ˜¯é‚£ä¸ª return çš„å‡½æ•°ï¼Œæ‰€ä»¥ï¼Œè¿™é‡Œä¹Ÿåº”è¯¥åŠ å…¥è°ƒåº¦é˜Ÿåˆ—ï¼Œåªæ˜¯è¦æ§åˆ¶è°ƒç”¨æ—¶æœºï¼Œ**å› ä¸ºå…¶åªåœ¨ç»„ä»¶è¢« delete æ—¶è°ƒç”¨**ã€‚

### ã€‡ æ¸²æŸ“æµç¨‹å›¾

![å›¾ç‰‡](/img/posts/react/react-hooks-useReducer.jpg)

![å›¾ç‰‡](/img/posts/react/react-hooks-useEffect.png)

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æŠ›å¼€ fiberï¼Œç®€åŒ–ä¸€ä¸‹æºç é€»è¾‘ï¼ŒåŒæ—¶æ¢ä¸€ç§æ€è·¯æ¥çœ‹ hook æœ¬èº«ï¼Œä½¿ç”¨ preact ä¸­çš„å®ç°æ¥è®²è§£ï¼š

### â‘£ useMemo / useCallback

æˆ‘ä»¬æŠŠ react å†…ç½®çš„ hook éƒ½ç¼–ä¸Šå·ï¼Œä¾¿äº devtool è§£æï¼Œæ¯”å¦‚ useState æ˜¯ 1ï¼ŒuseCallback æ˜¯ 8ï¼ŒuseMemo æ˜¯ 7 ç­‰ç­‰ã€‚äºæ˜¯æœ‰äº†ä¸‹è¡¨ï¼š

| hook                | ç¼–å·ï¼ˆcurrentHookï¼‰ |
| ------------------- | ------------------- |
| useState            | 1                   |
| useReducer          | 2                   |
| useEffect           | 3                   |
| useLayoutEffect     | 4                   |
| useRef              | 5                   |
| useImperativeHandle | 6                   |
| useMemo             | 7                   |
| useCallback         | 8                   |
| useContext          | 9                   |
| useErrorBoundary    | 10                  |
| useId               | 11                  |

æˆ‘ä»¬å¯ä»¥é€šè¿‡ getHookState æ–¹æ³•è·å–åˆ°è¿™ä¸ª hook çš„çŠ¶æ€ï¼š

```js
function getHookState(index, type) {
  // é€šè¿‡ type è®°å½• state ç±»å‹ï¼Œä¾¿äº devTool è§£æ
  ...
  // é€šè¿‡ index è·å–å½“å‰ hook
  const hooks =
		currentComponent.__hooks ||
		(currentComponent.__hooks = {
			_list: [],
			_pendingEffects: []
		});

	if (index >= hooks._list.length) {
		hooks._list.push({ _pendingValue: EMPTY });
	}
	return hooks._list[index];
}
```

ç»™å½“å‰çš„ vnodeï¼ˆcurrentComponentï¼‰è®¾ç½®`__hooks`å±æ€§ï¼Œæ¯ä¸€ä¸ª hook å‘¢ï¼Œåˆæœ‰è‡ªå·±çš„`_list`æ¥æ”¾ç½® hook ä»¬çš„çŠ¶æ€ï¼Œä»¥ useMemo ä¸ºä¾‹ï¼š

```ts
export interface MemoHookState {
  _value?: any;
  _pendingValue?: any;
  _args?: any[];
  _pendingArgs?: any[];
  _factory?: () => any;
}
```

åŒæ—¶æ¯ä¸€ä¸ª hook è¿˜æœ‰è‡ªå·±çš„ \_pendingEffectsï¼š

```ts
export interface EffectHookState {
  _value?: Effect;
  _args?: any[];
  _pendingArgs?: any[];
  _cleanup?: Cleanup | void;
}
```

useMemo:

```js
// hookæŒ‰ç…§é€’å¢é¡ºåºï¼Œä¼šç»™ä¸€ä¸ªcurrentIndex
// factoryï¼šç”¨æˆ·ä¼ å…¥çš„ç¼“å­˜å‡½æ•°
// args: ä¾èµ–æ•°ç»„
export function useMemo(factory, args) {
  /** @type {import('./internal').MemoHookState} */
  const state = getHookState(currentIndex++, 7);
  if (argsChanged(state._args, args)) {
    state._pendingValue = factory();
    state._pendingArgs = args;
    state._factory = factory;
    return state._pendingValue;
  }

  return state._value;
}

// æ£€æµ‹ä¾èµ–æ›´æ–°
// è¿”å›trueçš„æƒ…å†µï¼šæ²¡æœ‰old depsã€ä¾èµ–é•¿åº¦å˜åŒ–ã€æ–°ä¾èµ–ä¸­æœ‰ä¸å’ŒåŸä¾èµ–ä¸€æ ·çš„å¯¹è±¡
function argsChanged(oldArgs, newArgs) {
  return (
    !oldArgs ||
    oldArgs.length !== newArgs.length ||
    newArgs.some((arg, index) => arg !== oldArgs[index])
  );
}
```

æ¥ä¸‹æ¥çœ‹ä¸€ä¸‹ useCallback:

```js
// currentHook å°±æ˜¯ç”¨äº devtool è§£æçš„å˜é‡ï¼Œè¿™é‡Œå¿½ç•¥
export function useCallback(callback, args) {
  currentHook = 8;
  return useMemo(() => callback, args);
}
```

### â‘¤ useDebounce

æ¥ä¸‹æ¥æˆ‘ä»¬æ¥å¼•ç”³ä¸€ä¸‹ç¬¬ä¸‰æ–¹ hook åº“`ahooks`ä¸­çš„ä¸€ä¸ªé˜²æŠ– hookã€‚

ä½¿ç”¨ï¼š

```jsx
import React, { useState } from 'react';
import { useDebounce } from 'ahooks';

export default () => {
  const [value, setValue] = useState<string>();
  const debouncedValue = useDebounce(value, { wait: 500 });

  return (
    <div>
      <input
        value={value}
        onChange={(e) => setValue(e.target.value)}
        placeholder="Typed value"
        style={{ width: 280 }}
      />
      <p style={{ marginTop: 16 }}>DebouncedValue: {debouncedValue}</p>
    </div>
  );
};
```

åŸç†ï¼š

```js
// å¤–å±‚å‡½æ•°å…¥å‚ï¼šfunc, wait, optionsï¼ˆmaxWaitç­‰å‚æ•°ï¼‰
// å†…å±‚å‡½æ•°
function debounced(...args) {
  const time = Date.now();
  const isInvoking = shouldInvoke(time);

  lastArgs = args;
  lastThis = this;
  lastInvokeTime = time;

  if (timerId) {
    cancelTimer();
  }

  if (isInvoking) {
    // é‡å¯å®šæ—¶å™¨å‡½æ•° timerExpired
    timerId = startTimer(timerExpired, wait);
    return invokeFunc(lastInvokeTime);
  }

  return result;
}

function invokeFunc(time) {
  const args = lastArgs;
  const thisArg = lastThis;

  lastArgs = lastThis = undefined;
  lastInvokeTime = time;
  result = func.apply(thisArg, args);
  return result;
}
```

å…¶ä¸­ï¼š

```js
function shouldInvoke(time) {
  const timeSinceLastInvoke = time - lastInvokeTime; // è·ç¦»ä¸Šä¸€æ¬¡è°ƒç”¨çš„æ—¶é—´å·®

  return (
    lastInvokeTime === undefined ||
    timeSinceLastInvoke >= wait ||
    timeSinceLastInvoke < 0 ||
    (maxing && timeSinceLastInvoke >= maxWait)
  );
}

// è¿™äº›éƒ½æ˜¯å†…éƒ¨å¯¹è±¡ï¼Œå…¼å®¹äº†jsä¸åŒè¿è¡Œæ—¶ç¯å¢ƒçš„å…¶é‚£å¥å¯¹è±¡
const root =
  freeGlobalThis || freeGlobal || freeSelf || Function('return this')();
const useRAF =
  !wait && wait !== 0 && typeof root.requestAnimationFrame === 'function';

function startTimer(pendingFunc, wait) {
  if (useRAF) {
    root.cancelAnimationFrame(timerId);
    return root.requestAnimationFrame(pendingFunc);
  }
  return setTimeout(pendingFunc, wait);
}
```

## 5. Diff ç®—æ³•é«˜çº§

è¿™é‡Œè®²è§£ä¸€ä¸‹é«˜é˜¶ç‰ˆ diff ç®—æ³•ã€‚

ä¸Šè¾¹çš„ diff ç®—æ³•ï¼ˆreconcileChildrenï¼‰é—®é¢˜ï¼š

- æŒ‰ä½ç½®å¯¹æ¯”ï¼Œé‡å¤ç»„ä»¶æ²¡åŠæ³•å¤ç”¨ï¼Œæ€§èƒ½è¾ƒä½

å› ä¸ºå¤§å¤šæ•°æƒ…å†µï¼Œé¡µé¢çš„å˜åŒ–éƒ½æ˜¯å¾ˆå°çš„ï¼Œå¤§éƒ¨åˆ† dom æ ‘éƒ½æ˜¯ä¸å˜çš„ï¼Œåªæœ‰ä¸ªåˆ«çš„å˜åŒ–ï¼Œä¹‹å‰çš„ç®—æ³•ä¸­ï¼Œå¦‚æœå¯¹åº”ä½ç½®ä¸ŠèŠ‚ç‚¹ä¸ä¸€æ ·å°±ç›´æ¥åˆ æ‰ï¼Œä¸‹è¾¹æœ‰éœ€è¦è¿™ä¸ªèŠ‚ç‚¹äº†ï¼Œåªå¥½å†åˆ›å»ºï¼Œæˆæœ¬é«˜äº†ä¸å°‘ã€‚

ç®—æ³•æ€è·¯ï¼š

- åˆ›å»ºä¸€ä¸ª hash è¡¨å­˜æ”¾ç¼“å­˜èŠ‚ç‚¹
- éœ€è¦åˆ é™¤çš„èŠ‚ç‚¹åˆ æ‰åå­˜åˆ° hash è¡¨ä¸­
- æ¯éœ€è¦æ–°å¢ä¸€ä¸ªä½ç½®çš„èŠ‚ç‚¹æ—¶ï¼Œä» hash è¡¨ä¸­è¯»å–
- ä¸€è½® diff åšå®Œä¹‹åï¼Œæ¸…ç©º hash è¡¨

è€ƒè™‘åˆ° fiber çš„å•é“¾è¡¨ç»“æ„ï¼Œå°±ä¸ä½¿ç”¨ vue çš„åŒæŒ‡é’ˆä»å‰ååŒæ­¥æŸ¥è¯¢ï¼Œè€Œæ˜¯ä»å·¦è¾¹å¾€å³éå†ï¼Œæ¯”è¾ƒæ–°è€èŠ‚ç‚¹ï¼Œå¦‚æœèŠ‚ç‚¹å¯ä»¥å¤ç”¨ï¼Œç»§ç»­å¾€å³ï¼Œå¦åˆ™å°±åœæ­¢ã€‚

### æµç¨‹å›¾

æ¸²æŸ“æ ‘ï¼ˆpfiber å°±æ˜¯ returnFiberï¼‰ï¼š
![å›¾ç‰‡](/img/posts/react/diff-1.png)

ç¬¬ä¸€æ­¥ï¼šä»å·¦å¾€å³éå†ï¼ŒæŸ¥æ‰¾ç›´æ¥èƒ½ç”¨çš„ï¼Œç›´åˆ°é‡åˆ°ä¸èƒ½ç”¨çš„ä¸ºæ­¢ï¼ˆä¸‹å›¾ä¸­çš„æ•°å­—ä»£è¡¨è¯¥ fiber çš„ indexï¼‰ï¼š

![å›¾ç‰‡](/img/posts/react/diff-2.png)

èƒ½å¤ç”¨çš„ï¼š

```js
const same = sameNode(newChild, oldFiber);

if (same) {
  const newFiber = createFiber(newChild, returnFiber);

  Object.assign(newFiber, {
    stateNode: oldFiber.stateNode,
    alternate: oldFiber,
    flags: Update,
  });
}

// newIndex æŒ‡é’ˆåç§»
// lastPlacedIndex æŒ‡å‘æœ€åæ”¾ç½®çš„ä½ç½®
```

åœæ­¢æ¡ä»¶ï¼š`!sameNode(newChild, oldFiber)`

ç¬¬äºŒæ­¥ï¼šå¦‚æ–°èŠ‚ç‚¹æ²¡æœ‰äº†ï¼ˆnewIndex === newChildren.lengthï¼‰ï¼š

![å›¾ç‰‡](/img/posts/react/diff-3.png)

è€èŠ‚ç‚¹å¾€åçš„åŠ å…¥åˆ é™¤é˜Ÿåˆ—ï¼š

```js
// éå†éšåçš„èŠ‚ç‚¹ï¼ŒåŠ å…¥çˆ¶èŠ‚ç‚¹çš„ deletions
returnFiber.deletions.push(...)
```

ç¬¬ä¸‰æ­¥ï¼šå¦‚æœè€èŠ‚ç‚¹æ²¡æœ‰äº†ï¼š

![å›¾ç‰‡](/img/posts/react/diff-4.png)

æ–°çš„èŠ‚ç‚¹ä¾æ¬¡æ„å»ºé“¾è¡¨ï¼š

```js
...
if (previousNewFiber == null) {
  returnFiber.child = newFiber;
} else {
  previousNewFiber.sibling = newFiber;
}
```

ç¬¬å››æ­¥ï¼šå…¶ä»–æƒ…å†µï¼Œä½¿ç”¨ hash è¡¨ç´¢å¼•

```js
// ä¸¾ä¾‹1
// 0 1 [2 3 4 5 6]
// 0 1 [3 4 5 6 7 2]

// ä¸¾ä¾‹2
// [0 1 2 3 4 5 6]
// [2 1 3 4 5]

// æŠŠè€èŠ‚ç‚¹åŠ å…¥Map
const existingChildren = mapRemainingChildren(oldFiber); // new Map()
// éå†æ–°èŠ‚ç‚¹ï¼Œé€šè¿‡æ–°èŠ‚ç‚¹çš„keyå»å“ˆå¸Œè¡¨ä¸­æŸ¥æ‰¾èŠ‚ç‚¹ï¼Œæ‰¾åˆ°å°±å¤ç”¨èŠ‚ç‚¹ï¼Œå¹¶ä¸”åˆ é™¤å“ˆå¸Œè¡¨ä¸­å¯¹åº”çš„èŠ‚ç‚¹
```

![å›¾ç‰‡](/img/posts/react/diff-5.png)

ç¬¬äº”æ­¥ï¼šæ–°èŠ‚ç‚¹éå†å®Œåï¼Œè‹¥ hash è¡¨ä¸­ä»ç„¶æœ‰èŠ‚ç‚¹ï¼Œåˆ™æŠŠè¿™äº›èŠ‚ç‚¹åŠ å…¥ returnFiber.deletions;

### ç¤ºæ„ä»£ç 

```js
// oldfiberçš„å¤´ç»“ç‚¹
let oldFiber = returnFiber.alternate?.child;
// ä¸‹ä¸€ä¸ªoldFiber | æš‚æ—¶ç¼“å­˜ä¸‹ä¸€ä¸ªoldFiber
let nextOldFiber = null;
// ç”¨äºåˆ¤æ–­æ˜¯returnFiberåˆæ¬¡æ¸²æŸ“è¿˜æ˜¯æ›´æ–°
let shouldTrackSideEffects = !!returnFiber.alternate;
let previousNewFiber = null;
let newIndex = 0;
// ä¸Šä¸€æ¬¡domèŠ‚ç‚¹æ’å…¥çš„æœ€è¿œä½ç½®
// old 0 1 2 3 4
// new 2 1 3 4
let lastPlacedIndex = 0;

// *1. ä»å·¦è¾¹å¾€å³éå†ï¼Œæ¯”è¾ƒæ–°è€èŠ‚ç‚¹ï¼Œå¦‚æœèŠ‚ç‚¹å¯ä»¥å¤ç”¨ï¼Œç»§ç»­å¾€å³ï¼Œå¦åˆ™å°±åœæ­¢
for (; oldFiber && newIndex < newChildren.length; newIndex++) {
  const newChild = newChildren[newIndex];
  if (newChild == null) {
    continue;
  }

  if (oldFiber.index > newIndex) {
    nextOldFiber = oldFiber;
    oldFiber = null;
  } else {
    nextOldFiber = oldFiber.sibling;
  }

  const same = sameNode(newChild, oldFiber);
  if (!same) {
    if (oldFiber == null) {
      oldFiber = nextOldFiber;
    }
    break;
  }
  const newFiber = createFiber(newChild, returnFiber);

  Object.assign(newFiber, {
    stateNode: oldFiber.stateNode,
    alternate: oldFiber,
    flags: Update,
  });

  // èŠ‚ç‚¹æ›´æ–°
  lastPlacedIndex = placeChild(
    newFiber,
    lastPlacedIndex,
    newIndex,
    shouldTrackSideEffects,
  );

  if (previousNewFiber == null) {
    returnFiber.child = newFiber;
  } else {
    previousNewFiber.sibling = newFiber;
  }

  previousNewFiber = newFiber;
  oldFiber = nextOldFiber;
}

// *2. æ–°èŠ‚ç‚¹æ²¡äº†ï¼Œè€èŠ‚ç‚¹è¿˜æœ‰
// 0 1 2
// 0
if (newIndex === newChildren.length) {
  deleteRemainingChildren(returnFiber, oldFiber);
  return;
}

// *3. åˆæ¬¡æ¸²æŸ“
// 1ï¼‰åˆæ¬¡æ¸²æŸ“
// 2ï¼‰è€èŠ‚ç‚¹æ²¡äº†ï¼Œæ–°èŠ‚ç‚¹è¿˜æœ‰
if (!oldFiber) {
  for (; newIndex < newChildren.length; newIndex++) {
    const newChild = newChildren[newIndex];
    if (newChild == null) {
      continue;
    }
    const newFiber = createFiber(newChild, returnFiber);

    lastPlacedIndex = placeChild(
      newFiber,
      lastPlacedIndex,
      newIndex,
      shouldTrackSideEffects,
    );

    if (previousNewFiber === null) {
      // head node
      returnFiber.child = newFiber;
    } else {
      previousNewFiber.sibling = newFiber;
    }

    previousNewFiber = newFiber;
  }
}

// *4 æ–°è€èŠ‚ç‚¹éƒ½è¿˜æœ‰
// å°è€Œä¹±
// old 0 1 [2 3 4]
// new 0 1 [3 4]
// !4.1 æŠŠå‰©ä¸‹çš„oldå•é“¾è¡¨æ„å»ºå“ˆå¸Œè¡¨
const existingChildren = mapRemainingChildren(oldFiber);

// !4.2 éå†æ–°èŠ‚ç‚¹ï¼Œé€šè¿‡æ–°èŠ‚ç‚¹çš„keyå»å“ˆå¸Œè¡¨ä¸­æŸ¥æ‰¾èŠ‚ç‚¹ï¼Œæ‰¾åˆ°å°±å¤ç”¨èŠ‚ç‚¹ï¼Œå¹¶ä¸”åˆ é™¤å“ˆå¸Œè¡¨ä¸­å¯¹åº”çš„èŠ‚ç‚¹
for (; newIndex < newChildren.length; newIndex++) {
  const newChild = newChildren[newIndex];
  if (newChild == null) {
    continue;
  }
  const newFiber = createFiber(newChild, returnFiber);

  // oldFiber
  const matchedFiber = existingChildren.get(newFiber.key || newFiber.index);
  if (matchedFiber) {
    // èŠ‚ç‚¹å¤ç”¨
    Object.assign(newFiber, {
      stateNode: matchedFiber.stateNode,
      alternate: matchedFiber,
      flags: Update,
    });

    existingChildren.delete(newFiber.key || newFiber.index);
  }

  lastPlacedIndex = placeChild(
    newFiber,
    lastPlacedIndex,
    newIndex,
    shouldTrackSideEffects,
  );

  if (previousNewFiber == null) {
    returnFiber.child = newFiber;
  } else {
    previousNewFiber.sibling = newFiber;
  }
  previousNewFiber = newFiber;
}

// *5 oldçš„å“ˆå¸Œè¡¨ä¸­è¿˜æœ‰å€¼ï¼Œéå†å“ˆå¸Œè¡¨åˆ é™¤æ‰€æœ‰old
if (shouldTrackSideEffects) {
  existingChildren.forEach((child) => deleteChild(returnFiber, child));
}
```

å…¶ä¸­å·¥å…·å‡½æ•°ï¼š

```js
// åˆæ¬¡æ¸²æŸ“ï¼Œåªæ˜¯è®°å½•ä¸‹æ ‡
// æ›´æ–°ï¼Œæ£€æŸ¥èŠ‚ç‚¹æ˜¯å¦ç§»åŠ¨
function placeChild(
  newFiber,
  lastPlacedIndex,
  newIndex,
  shouldTrackSideEffects,
) {
  newFiber.index = newIndex;
  if (!shouldTrackSideEffects) {
    // çˆ¶èŠ‚ç‚¹åˆæ¬¡æ¸²æŸ“
    return lastPlacedIndex;
  }
  // çˆ¶èŠ‚ç‚¹æ›´æ–°
  // å­èŠ‚ç‚¹æ˜¯åˆæ¬¡æ¸²æŸ“è¿˜æ˜¯æ›´æ–°å‘¢
  const current = newFiber.alternate;
  if (current) {
    const oldIndex = current.index;
    // å­èŠ‚ç‚¹æ˜¯æ›´æ–°
    // lastPlacedIndex è®°å½•äº†ä¸Šæ¬¡domèŠ‚ç‚¹çš„ç›¸å¯¹æ›´æ–°èŠ‚ç‚¹çš„æœ€è¿œä½ç½®
    // old 0 1 2 3 4
    // new 2 1 3 4
    // 2 1(6) 3 4
    if (oldIndex < lastPlacedIndex) {
      // move
      newFiber.flags |= Placement;
      return lastPlacedIndex;
    } else {
      return oldIndex;
    }
  } else {
    // å­èŠ‚ç‚¹æ˜¯åˆæ¬¡æ¸²æŸ“
    newFiber.flags |= Placement;
    return lastPlacedIndex;
  }
}

// hashè¡¨
function mapRemainingChildren(currentFirstChild) {
  const existingChildren = new Map();

  let existingChild = currentFirstChild;
  while (existingChild) {
    // key: value
    // key||index: fiber
    existingChildren.set(
      existingChild.key || existingChild.index,
      existingChild,
    );
    existingChild = existingChild.sibling;
  }

  return existingChildren;
}
```

åœ¨ commitWorker é‡ŒåŠ å…¥ï¼š

```js
if (flags & Placement && stateNode) {
  // 1
  // 0 1 2 3 4
  // 2 1 3 4
  const before = getHostSibling(wip.sibling);
  insertOrAppendPlacementNode(stateNode, before, parentNode);
  // parentNode.appendChild(stateNode);
}

...
function getHostSibling(sibling) {
  while (sibling) {
    if (sibling.stateNode && !(sibling.flags & Placement)) {
      return sibling.stateNode;
    }
    sibling = sibling.sibling;
  }
  return null;
}
function insertOrAppendPlacementNode(stateNode, before, parentNode) {
  if (before) {
    parentNode.insertBefore(stateNode, before);
  } else {
    parentNode.appendChild(stateNode);
  }
}
```

```jsx
/**
 * compact: true
 * inline: true
 */
import React from 'react';
import Giscus from '@giscus/react';
import { usePrefersColor } from 'dumi';

export default function Main() {
  const [color] = usePrefersColor();

  return (
    <section style={{ marginTop: '32px' }}>
      <Giscus
        id="comments"
        reactionsEnabled="1"
        emitMetadata="0"
        inputPosition="bottom"
        loading="lazy"
        src="https://giscus.app/client.js"
        repo="UMCloud-FE"
        repoId="R_kgDOIYRu5Q"
        category="Announcements"
        categoryId="DIC_kwDOIYRu5c4CU1sl"
        mapping="URL"
        strict="0"
        reactionsEnabled="1"
        emitMetadata="1"
        inputPosition="bottom"
        theme={color === 'dark' ? 'dark_tritanopia' : 'light_tritanopia'}
        lang="zh-CN"
        loading="lazy"
        crossorigin="anonymous"
        async={true}
        // theme={giscusTheme}
      />
    </section>
  );
}
```47:T163a,è€ç”Ÿå¸¸è°ˆçš„é—®é¢˜ï¼Œå›¾ç‰‡å¤ªå¤šå¤ªå¤§çš„ç½‘ç«™ï¼Œå¾€å¾€ç”±äºå›¾ç‰‡åŠ è½½è¿‡æ…¢è€Œå¯¼è‡´é¡µé¢ç™½å±æ—¶é—´è¿‡é•¿ã€‚æœ¬æ¬¡å¹´å‰æœ€åä¸€æ›´ï¼Œæ¥è®²ä¸€ä¸ªåŠ è½½æ–¹æ³•æ¥å¤„ç†è¿™ç§æƒ…å†µã€‚

> åœ¨ä½¿ç”¨ Next.js æ—¶ï¼Œå‘ç°å…¶æ”¯æŒæ¨¡ç³Šå›¾ç‰‡å ä½ç¬¦åŠ è½½çš„æ–¹å¼ï¼Œæœ¬æ–‡å°±æ‰‹åŠ¨å®ç°ä¸€ä¸ª


![ä¼ä¸šå¾®ä¿¡æˆªå›¾_0cbf1b0b-91ee-49ff-bb58-a0d390bc61a2.png](/img/posts/2024-2-7/2024-2-7-1.png)

*å›¾ç‰‡è§£é‡Šï¼šNextjs ä½¿ç”¨ placeholder="blur" æ¥æŒ‡å®šå½“å‰å›¾ç‰‡ä½¿ç”¨æ¨¡ç³Šå›¾ç‰‡å ä½ç¬¦åŠ è½½*

## 1. å‰ç½®å·¥ä½œ

é¦–å…ˆä½ å¾—å‡†å¤‡ä¸€å †å›¾ç‰‡ï¼Œéƒ¨ç½²ä¸€ä¸ªæµ‹è¯•çš„ç½‘é¡µã€‚

```html
<body class="p-12 m-auto">
  <div class="container flex justify-center">
    <img loading="lazy" alt="9" class="w-full object-cover rounded-lg"
      src="http://e.hiphotos.baidu.com/image/pic/item/a1ec08fa513d2697e542494057fbb2fb4316d81e.jpg" />
      ...
      ä¸‹é¢æ˜¯å¹¶åˆ—çš„ä¸€å † imgï¼Œæ•°é‡ 100+
  </div>
</body>
```

é¡µé¢é¢„è§ˆï¼š


![image.png](/img/posts/2024-2-7/2024-2-7-2.png)

ä½†æ˜¯ï¼Œå½“ç½‘é€Ÿæ…¢ä¸€ç‚¹ï¼Œæˆ–è€…å›¾ç‰‡å†é«˜æ¸…ä¸€ç‚¹æ—¶ï¼Œå›¾ç‰‡å°±ä¼šå‡ºç°åŠ è½½ç™½å±ï¼ˆä»ä¸Šå¾€ä¸‹çš„æ‰«æçº¿ï¼‰ã€‚

## 2. è®¾ç½®å»¶è¿ŸåŠ è½½

é¦–å…ˆï¼Œæˆ‘ä»¬åˆ©ç”¨ img æ ‡ç­¾çš„èƒ½åŠ›ï¼Œæ·»åŠ æ‡’åŠ è½½å±æ€§ï¼š

```html
<img loading="lazy" src="image.jpg" alt="..." />
```

å…¼å®¹æ€§ï¼š

![image.png](/img/posts/2024-2-7/2024-2-7-3.png)


è¿™ä¸ªç­–ç•¥æœ‰ä¸€ä¸ªåŠ¨æ€çš„åŸåˆ™ï¼š

1. *Lazy loadingåŠ è½½æ•°é‡ä¸å±å¹•é«˜åº¦æœ‰å…³ï¼Œé«˜åº¦è¶Šå°åŠ è½½æ•°é‡è¶Šå°‘ï¼Œä½†å¹¶ä¸æ˜¯çº¿æ€§å…³ç³»ã€‚4G ç½‘ç»œä¸‹çš„è§†å£è·ç¦»é˜ˆå€¼æ˜¯ 1250 åƒç´ ï¼Œ3G ç½‘ç»œä¸‹æ˜¯ 2500 åƒç´ ã€‚*
2. *Lazy loadingåŠ è½½æ•°é‡ä¸ç½‘é€Ÿæœ‰å…³ï¼Œç½‘é€Ÿè¶Šæ…¢ï¼ŒåŠ è½½æ•°é‡è¶Šå¤šï¼Œä½†å¹¶ä¸æ˜¯çº¿æ€§å…³ç³»*ã€‚
3. *æ»šåŠ¨ä¼šè§¦å‘å›¾ç‰‡æ‡’åŠ è½½ï¼Œä¸ä¼šè¯´æ»šåŠ¨ä¸€å±åå†å»åŠ è½½ã€‚*
4. *çª—å£resizeå°ºå¯¸å˜åŒ–ä¹Ÿä¼šè§¦å‘å›¾ç‰‡æ‡’åŠ è½½ã€‚*
5. *æ ¹æ®æ»šåŠ¨ä½ç½®ä¸åŒï¼ŒLazy loadingä¼šå¿½ç•¥å¤´å°¾çš„å›¾ç‰‡è¯·æ±‚ã€‚*

è¿™ä¸ªç­–ç•¥è·Ÿæµè§ˆå™¨ï¼Œç½‘é€Ÿå’Œè¿è¡Œç¯å¢ƒéƒ½æœ‰å…³ç³»ï¼Œæˆ‘å°±ä»¥æˆ‘æœ¬åœ°ä¸ºå‡†è¿›è¡Œæµ‹è¯•ã€‚ä¸ºäº†æ»¡è¶³æµè§ˆå™¨é˜ˆå€¼ï¼Œæˆ‘ä»¬æ”¾ç½®äº† 100+ çš„ç½‘ç»œå›¾ç‰‡ï¼Œè§ä¸Šé¢é¢„è§ˆå›¾ã€‚åœ¨åˆå§‹åŒ–åŠ è½½æ—¶åªåŠ è½½äº†ä¸€éƒ¨åˆ†ï¼Œç­‰å¾€ä¸‹æ»šåŠ¨ä¸€äº›ï¼Œçœ‹æ•ˆæœï¼š

![1.gif](/img/posts/2024-2-7/2024-2-7-4.gif)


> æ³¨æ„å›¾ç‰‡çš„åµŒå¥—å±‚çº§ï¼Œå¦‚æœ html ä¹¦å†™æœ‰è¯¯ï¼Œæˆ–è€…åµŒå¥—å±‚çº§è¿‡å¤šï¼Œæ‡’åŠ è½½å¯èƒ½ä¸ä¼šè¢«è§¦å‘

## 3. é…ç½®æ¨¡ç³Šå›¾ç‰‡

æˆ‘ä»¬å‡†å¤‡å¥½ä½åƒç´ çš„æ¨¡ç³Šå›¾ç‰‡ï¼Œå°†æ¯ä¸€ä¸ª img ç”¨ div åŒ…è£¹èµ·æ¥ï¼Œå¹¶ç»™ div åŠ ä¸Šé‚£ä¸ªæ¨¡ç³Šçš„èƒŒæ™¯å›¾ç‰‡ï¼ˆnext.js ä¹Ÿæ˜¯è¿™ä¹ˆåšçš„ï¼‰ï¼š
 
```html
<div class="blur-load" style="background-image: url(æ¨¡ç³Šå›¾ç‰‡)">
  <img ... loading="lazy" />
</div>
```

å…¶ä¸­æ¨¡ç³Šå›¾ç‰‡çš„æ ·å¼å¯ä»¥è¿™æ ·å®šä¹‰, ä¿è¯èƒŒæ™¯å›¾ç‰‡ä¸ img èƒ½å¤Ÿé‡åˆï¼š

```css
img {
  width: 100%;
  aspect-ratio: 1/1;
  object-fit: cover;
  object-position: center;
}

.blur-load {
  background-size: cover;
  background-position: center;
}
```

> è¿™ä¸ªæ–¹æ³•çš„åŸç†æ˜¯ img å›¾ç‰‡çš„å±‚çº§è¦é«˜äºå…¶æœ¬èº«æˆ–è€…çˆ¶çº§çš„èƒŒæ™¯å›¾ç‰‡ï¼Œå½“å›¾ç‰‡åŠ è½½å‡ºæ¥åè‡ªåŠ¨è¦†ç›–èƒŒæ™¯å›¾ç‰‡

åˆ¶ä½œæ¨¡ç³Šå›¾ç‰‡ï¼Œå¯ä»¥ä½¿ç”¨ [ffmpeg](https://ffmpeg.org/) å·¥å…·ï¼ˆè‡ªè¡Œè¿›å…¥å®˜ç½‘ä¸‹è½½å®‰è£…å³å¯ï¼‰ã€‚

> mac ç”µè„‘ç›´æ¥ä¸‹è½½ Unix å¯æ‰§è¡Œæ–‡ä»¶åˆ°æœ¬åœ°å°±å¯ä»¥ç”¨å®ƒæ‰§è¡ŒæŒ‡ä»¤äº†ï¼›windows ç”µè„‘ç›´æ¥ä¸‹è½½ build çš„ç›®å½•æ–‡ä»¶ï¼Œæ‰¾åˆ° bin ç›®å½•ä¸‹çš„ ffmpeg.exe å°±å¯ä»¥æ‰§è¡Œäº†ã€‚

è¿è¡ŒæŒ‡ä»¤ï¼š

```sh
# æˆ‘åšäº† 20 å€ç¼©æ”¾ï¼Œä½ å¯ä»¥è‡ªå·±å®šä¹‰ç¼©æ”¾æ¯”ä¾‹
ffmpeg -i 1.jpg -vf scale=20:-1 1-sm.png
```

è¿™æ ·ä¾¿ç”Ÿæˆäº†ä¸€ä¸ªå¾ˆå°çš„å›¾ç‰‡ï¼š


![image.png](/img/posts/2024-2-7/2024-2-7-5.png)

è°ƒæ•´ä»£ç ï¼š

```html
<div class="blur-load rounded-lg" style="background-image: url(./1-sm.png)">
<img loading="lazy" alt="9" class="w-full object-cover rounded-lg"
  src="http://e.hiphotos.baidu.com/image/pic/item/a1ec08fa513d2697e542494057fbb2fb4316d81e.jpg">
</div>
```

æˆ‘ä»¬å°†ç½‘é€Ÿè°ƒæ…¢çœ‹çœ‹æ•ˆæœï¼š


![image.png](/img/posts/2024-2-7/2024-2-7-6.png)

ä½†æ˜¯è¿™æ ·è¿˜æœ‰é—®é¢˜ï¼Œå°±æ˜¯å›¾ç‰‡æ˜¯ä»ä¸Šå¾€ä¸‹é€æ¸åŠ è½½çš„ï¼Œéƒ¨åˆ†åŠ è½½ä¹Ÿä¼šæ˜¾ç¤ºçš„é¡µé¢ä¸Šï¼š


![1.gif](/img/posts/2024-2-7/2024-2-7-7.gif)

æˆ‘ä»¬æƒ³è¦çš„æ•ˆæœæ˜¯å›¾ç‰‡å®Œå…¨åŠ è½½åå†è®©å›¾ç‰‡å‡ºæ¥ï¼Œè¿™è¦å€ŸåŠ© jsï¼š

```js
function loaded(div) {
  div.classList.add('loaded');
}

const blurDivs = document.querySelectorAll('.blur-load');
blurDivs.forEach(div => {
  const img = div.querySelector('img');
  
  // åœ¨åŠ è½½å®Œæˆçš„æ—¶å€™æ·»åŠ æ ·å¼
  if (img.complete) { loaded(div) }
  else { img.addEventListener('load', () => loaded(div)) }
})
```

è¿™æ ·ï¼Œåœ¨åŠ è½½å®Œæˆåæ‰ä¼šæœ‰ 'loaded' æ ·å¼åŠ è½½åœ¨å¤–å›´çš„ div ä¸Šã€‚æˆ‘ä»¬åªéœ€è¦ç»™ div æ·»åŠ æ ·å¼ï¼š

```css
.blur-load.loaded > img {
 opacity: 1;
}

/* åŠ è½½å®Œæˆä¹‹å‰ä¿æŒé€æ˜ */
.blur-load > img {
  opacity: 0;
  transition: opacity 200ms ease-in-out;
}
```

è¿™æ ·åœ¨åŠ è½½å®Œæˆåæ‰ä¼šæœ‰æ¨¡ç³Šå›¾ç‰‡è¿‡æ¸¡æ˜¾ç¤ºä¸ºåŸå›¾çš„æ•ˆæœäº†ï¼š


![1.gif](/img/posts/2024-2-7/2024-2-7-8.gif)

## 4. è‡ªå®šä¹‰ loading åŠ¨ç”»

å¦‚æœä½ è‡ªå·±è§‰å¾—è¿˜ä¸æ»¡æ„ï¼Œæƒ³è¦è‡ªå·±åŠ å…¥æƒ³è¦çš„åŠ¨ç”»æ•ˆæœï¼Œé‚£ä¹ˆä½ å¯ä»¥å­åœ¨è¿™ä¸ªdivä¸Šè‡ªå·±å®šä¹‰æ ·å¼ã€‚ä¸‹é¢ç»™å‡ºä¸€ç§è„‰å†²æ•ˆæœçš„å‚è€ƒæ ·ä¾‹ï¼š

```css
.blur-load {
  position: relative;
}
.blur-load::before {
  content: "";
  position: absolute;
  inset: 0;
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0% {
    background-color: rgba(255, 255, 255, 0);
  }
  
  50% {
    background-color: rgba(255, 255, 255, 0.4);
  }
  
  100% {
    background-color: rgba(255, 255, 255, 0);
  }
}

/* åŠ è½½å®Œæˆåå–æ¶ˆ */
.blur-load.loaded::before {
  content: none;
}
```
æ•ˆæœå›¾å¦‚ä¸‹ï¼š


![1.gif](/img/posts/2024-2-7/2024-2-7-9.gif)48:T812,## ä½¿ç”¨ CSS æ¡†æ¶

å¦‚æœä½ ä¸æƒ³è‡ªå·±é…ç½®è¿™äº›ä¹±ä¸ƒå…«ç³Ÿçš„é…ç½®ï¼Œåˆè‹¦äºä¸ä¼šè®¾è®¡ä¸»é¢˜é¢œè‰²ï¼Œé‚£ä¹ˆ [Tailwindcss](https://tailwindcss.com/docs/dark-mode) å°±å¯ä»¥å¸®ä½ å®Œæˆè¿™ä¸ªä»»åŠ¡ã€‚

> ä½¿ç”¨ css æ¡†æ¶ï¼ŒåŸåˆ™ä¸Šä¸ç®—æ˜¯ä¸€ä¸ªæ–°æŠ€æœ¯åˆ†ç±»ï¼Œä»–è¿˜æ˜¯ä¸Šé¢æ‰€è®²çš„æ–¹æ¡ˆä¸­çš„ä¸€ç§æˆ–å‡ ç§ï¼Œæ˜¯å¯¹è¿™äº›æ–¹æ¡ˆçš„ä¼ä¸šçº§å°è£…

æˆ‘ä»¬å€Ÿç”¨å®˜æ–¹çš„å¤œé—´ä¸»é¢˜çš„ä¾‹å­ï¼š

```js
<div class="bg-white dark:bg-slate-800 rounded-lg px-6 py-8 ring-1 ring-slate-900/5 shadow-xl">
  <div>
    <span class="inline-flex items-center justify-center p-2 bg-indigo-500 rounded-md shadow-lg">
      <svg class="h-6 w-6 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true"><!-- ... --></svg>
    </span>
  </div>
  <h3 class="text-slate-900 dark:text-white mt-5 text-base font-medium tracking-tight">Writes Upside-Down</h3>
  <p class="text-slate-500 dark:text-slate-400 mt-2 text-sm">
    The Zero Gravity Pen can be used to write in any orientation, including upside-down. It even works in outer space.
  </p>
</div>
```

ä½¿ç”¨ `dark:` æ¥å£°æ˜åœ¨ä¸»é¢˜ä¸ºå¤œé—´æ—¶çš„æ ·å¼ï¼Œå¯ä»¥é…ç½®ä¸ºè‡ªåŠ¨è¯†åˆ«ç³»ç»Ÿæ ·å¼æˆ–è€…æ˜¯å¯æ§çš„åˆ‡æ¢æ¨¡å¼ï¼Œåˆ‡æ¢ä¸ºå¤œé—´æ¨¡å¼åï¼Œä¼šåœ¨ html æ ¹å…ƒç´ ä¸Šæ·»åŠ ç±» `dark`ï¼š


![image.png](/img/posts/2024-1-25/2024-1-25-9.png)

è¿™æ ·ï¼ŒTailwind å°±èƒ½è¯†åˆ«å¹¶ä¿®æ”¹æ¸²æŸ“æ ·å¼äº†ï¼š

![image.png](/img/posts/2024-1-25/2024-1-25-10.png)

> è¿™ç§åˆ‡æ¢æ–¹å¼ï¼Œæœ¬è´¨ä¸Šè¿˜æ˜¯ç±»ååˆ‡æ¢æ¨¡å¼ï¼Œåªæ˜¯ä½¿ç”¨æ¡†æ¶æ›´åŠ æ–¹ä¾¿å¿«æ·ï¼Œæ”¯æŒçš„ç”Ÿæ€ä¹Ÿæ›´å¥½

> è¯¦ç»†çš„ Tailwindcss çš„ä½¿ç”¨ï¼Œå¯ä»¥è§ [å°è‚šå¸¦æ‚¨ Tailwind CSS å¿«é€Ÿå…¥é—¨](https://juejin.cn/post/7301910992312549376)

ä¼˜åŠ¿ï¼š

- å¤§åŠ¿æ‰€è¶‹ï¼Œå‰æ™¯å¹¿é˜”
- æ˜“äºç®¡ç†å’Œç»´æŠ¤ï¼Œä½¿å¾—å®šåˆ¶ä¸»é¢˜å˜å¾—éšå¿ƒæ‰€æ¬²
- ä»£ç å†—ä½™å°
- æ›´å¥½çš„æ€§èƒ½ä¸å¯æ‰©å±•æ€§

ä¸è¶³ï¼š

- æ¡†æ¶æœ¬èº«å¯èƒ½ä¼šä¸å·²æœ‰é¡¹ç›®æ¶æ„å†²çª
- æ¡†æ¶çº¦æŸäº†å¯å®šåˆ¶çš„çµæ´»æ€§
- å­¦ä¹ æˆæœ¬è¾ƒé«˜
- éœ€è¦æœ‰é¢å¤–çš„ç»´æŠ¤ç‰ˆæœ¬å‡çº§å·¥ä½œ49:T5d7,## CSS-IN-JS

ä½¿ç”¨è¿‡ React çš„æœ‹å‹åº”è¯¥å¬è¯´è¿‡ emotionï¼Œä»–çš„è®¾è®¡ç†å¿µæ˜¯ `All styles in Js`ï¼Œæˆ‘ä¹‹å‰è®²è¿‡çš„ UIç»„ä»¶åº“ å°±ç”¨çš„æ˜¯è¿™ä¸ªï¼š[æ‰‹æŠŠæ‰‹æ­å»ºåŸºäºReactçš„å‰ç«¯UIåº“ ï¼ˆäºŒï¼‰-- ä¸»é¢˜é…ç½®](https://juejin.cn/post/7076652936331280421).

ä»–ä¸ Antd çš„å®ç°ç†å¿µä¸€è‡´ï¼Œä¹Ÿæ˜¯ç»´æŠ¤ä¸€ä¸ª `ThemeProvider` æ¥å®Œæˆå¯é…ç½®çš„ä¸»é¢˜è®¾ç½®ï¼š

```js
import { ThemeProvider as EThemeProvider } from 'emotion-theming';

render() {
    const { theme: _theme, ...rest } = this.props;
    const { theme } = this.state;
    return <EThemeProvider theme={theme} {...rest} />;
}
```

> Antd æ˜¯åˆ‡æ¢åä½¿ç”¨ä¸åŒçš„ css æ–‡ä»¶ï¼Œemotion æ˜¯åˆ‡æ¢åä½¿ç”¨ä¸åŒçš„æ ·å¼ jsï¼Œæœ¬è´¨ä¸Šæ²¡æœ‰åŒºåˆ«

ä¸Šé¢çš„ theme ä¸»é¢˜å¯ä»¥ä½¿ç”¨ä¸€ä¸ª `designTokens.ts` é…ç½®å„ç§å°ºå¯¸ï¼Œé¢œè‰²ç­‰ï¼š


![image.png](/img/posts/2024-1-25/2024-1-25-8.png)

ç„¶åå°†æ–‡ä»¶å¯¼å‡ºåï¼Œå…¨å±€æ¥è®¿é—®ï¼š

```js
mport { useTheme } from 'emotion-theming';

import { defaultTheme } from '../../style';

const useDesignTokens = () => {
  // æ‹¿åˆ°Themeproviderçš„theme
  const theme = useTheme();
  if (!Object.keys(theme).length) return defaultTheme.designTokens;
  return theme.designTokens;
};

export default useDesignTokens;
```

ä¼˜ç‚¹ï¼š

- ä¸ä¼šå­˜åœ¨ css åŠ è½½éƒ¨ç½²çš„é—®é¢˜ï¼Œé€‚åˆå¾®å‰ç«¯è¿™ç§éœ€è¦éš”ç¦»æ ·å¼çš„åœºæ™¯
- ...\[Antd æ–¹æ¡ˆä¼˜ç‚¹]

ç¼ºç‚¹ï¼š

- å­¦ä¹ æ›²çº¿æ¯”è¾ƒé«˜
- å¢åŠ äº†è¿è¡Œæ—¶çš„å¼€é”€å’Œæ‰“åŒ…ä½“ç§¯
- æºç å¯è¯»æ€§å¯èƒ½ä¼šå˜å·®4a:T573d,éšç€ Nextjs 13+ çš„æ¨å‡ºï¼Œå®˜æ–¹æ¨å‡ºäº†ä¸€ç§å¾ˆæ–°çš„è·¯ç”±æ¨¡å¼ï¼Œå« [App Router](https://nextjs.org/docs/app) çš„ï¼Œä»Šå¤©æ¥çœ‹çœ‹è¿™ç©æ„æ€ä¹ˆä½¿ç”¨å§ã€‚

ä»–ä¸åŒäºä¹‹å‰çš„ pages è·¯ç”±æœºåˆ¶ï¼Œè€Œæ˜¯ä»¥ app æ–‡ä»¶å¤¹ä¸ºæ ¹ç›®å½•ï¼Œä»¥ page.tsxï¼ˆjsxï¼‰ ä¸ºå…¥å£ï¼Œä»¥ layout.tsx (jsx) ä¸ºå¸ƒå±€ç»„ä»¶ï¼Œå‚æ•°è·å–ä¸ä¸€æ ·äº†ï¼ŒåŒæ—¶ä¹Ÿå¼•å…¥äº†ä¸å°‘æ–°çš„APIã€‚

P.S. æ–°ä¸œè¥¿å±‚å‡ºä¸ç©·ï¼ŒçœŸçš„å­¦ä¸åŠ¨äº†å•Š...

![ä¸æ•¢å­å£°.jpeg](/img/posts/2024-1-19/2024-1-19-1.png)

> Node >= v18.17

> ä»¥åå®˜æ–¹çš„æ›´æ–°æ–¹å‘å…¨åœ¨ next å’Œ turbopack äº†ï¼Œæ‰€ä»¥ä¼ ç»Ÿçš„ create-react-app å’Œ react-router æ¸æ¸è¢«æŠ›å¼ƒï¼Œå¦‚æœå°†æ¥ react-router å®˜æ–¹ä¹Ÿä¸æ›´æ–°äº†ï¼Œä¸çŸ¥é“ vite å°†æ¥è¦æ€ä¹ˆæ”¯æŒ react çš„åˆ›å»ºï¼Ÿ

----

## 0. åˆ›å»ºé¡¹ç›®

æ‰§è¡ŒæŒ‡ä»¤ï¼š

```shell
npx create-next-app nextjs-app-router-test
```

æœ€æ–°çš„ CLI ä¼šæœ‰å¾ˆå¤šæç¤ºé€‰é¡¹ï¼Œæˆ‘ä»¬æ˜¯ App router çš„è®²è§£ï¼Œå…¶ä»–æ— å…³çš„é€‰é¡¹å…³æ‰å³å¯ï¼š

```
âœ” Would you like to use TypeScript? â€¦ [No] / Yes  // ä¼ ç»Ÿ js
âœ” Would you like to use ESLint? â€¦ [No] / Yes
âœ” Would you like to use Tailwind CSS? â€¦ [No] / Yes  // ä¸ä½¿ç”¨ css æ¡†æ¶ï¼Œå°±ä¼šç”Ÿæˆ css module æ–‡ä»¶ï¼Œæ¯”å¦‚ page.module.css
âœ” Would you like to use `src/` directory? â€¦ [No] / Yes // æ‰å¹³åŒ–ç®¡ç†
âœ” Would you like to use App Router? (recommended) â€¦ No / [Yes] // å¼€å¯ App Router
âœ” Would you like to customize the default import alias (@/*)? â€¦ No / [Yes]
âœ” What import alias would you like configured? â€¦ [@]/*
```

ç”Ÿæˆåï¼Œå·¥ç¨‹ç›®å½•ä¸»è¦æ–‡ä»¶å¦‚ä¸‹ï¼š

```shell
./app
â”œâ”€â”€ favicon.ico
â”œâ”€â”€ globals.css
â”œâ”€â”€ layout.js
â”œâ”€â”€ page.js
â””â”€â”€ page.module.css
./public
â”œâ”€â”€ next.svg
â””â”€â”€ vercel.svg
next.config.js 
package.json
```

æˆ‘ä»¬å®‰è£…ä¾èµ–åå¯åŠ¨é¡¹ç›®ï¼š

![image.png](/img/posts/2024-1-19/2024-1-19-2.png)

## 1. è·¯ç”±

### è·¯ç”±ç»“æ„

æˆ‘ä»¬ä¿®æ”¹ä¸€ä¸‹ page.js:

```js
import styles from './page.module.css'

export default function Home() {
  return (
    <main className={styles.main}>
      Home
    </main>
  )
}
```

![image.png](/img/posts/2024-1-19/2024-1-19-3.png)

è€Œ layout.js ç»„ä»¶ï¼š

```js
export default function RootLayout({ children }) {
  return (
    <html lang="en">
      <body className={inter.className}>{children}</body>
    </html>
  )
}
```

å¯ä»¥çœ‹åˆ°ä»–æ˜¯é¡¹ç›®çš„ä¸»ä½“ç»“æ„ï¼Œä»–ä¼ å…¥çš„ children æ˜¯ page.js ä¸­çš„å†…å®¹ã€‚

ä»¥ä¸Šä¾¿æ˜¯ App Router çš„ä¸»ä½“ç»“æ„äº† ï¼ˆapp ç›®å½• + page.js + layout.jsï¼‰ã€‚å¯ä»¥å¯¹æ¯” pages è·¯ç”±ï¼ˆpages ç›®å½• + _app.js + _document.jsï¼‰.

æ­¤å¤–è¿˜æœ‰ä¸€ä¸ª public ç›®å½•ï¼Œå®ƒé‡Œè¾¹çš„æ–‡ä»¶æ˜¯å¯ä»¥è¢«ä½¿ç”¨ `/` ç›´æ¥å¼•ç”¨çš„ã€‚

app æ–‡ä»¶å¤¹ä¸­å¯ä»¥åˆ›å»ºå­æ–‡ä»¶å¤¹ç”¨äºåŒºåˆ†å­è·¯ç”±ï¼Œåœ¨appé¡¶å±‚çš„æ–‡ä»¶å°±è¡¨ç¤ºè·Ÿè·¯ç”±æ–‡ä»¶ã€‚æ¯ä¸ªé¡¹ç›®æ–‡ä»¶å¤¹å•å…ƒå¯ä»¥åŒ…å«çš„æ–‡ä»¶å¦‚ä¸‹ï¼š


|       æ–‡ä»¶å        |          å¯é€‰çš„åç¼€           |           åŠŸèƒ½                   |
| ------------------- | ------------------- | ---------------------------- |
| [`layout`](https://nextjs.org/docs/app/api-reference/file-conventions/layout)                     | `.js` `.jsx` `.tsx` | å¸ƒå±€çš„é¡¶å±‚ç»„ä»¶                       |
| [`page`](https://nextjs.org/docs/app/api-reference/file-conventions/page)                         | `.js` `.jsx` `.tsx` | é¡µé¢ä¸»ä½“                         |
| [`loading`](https://nextjs.org/docs/app/api-reference/file-conventions/loading)                   | `.js` `.jsx` `.tsx` | é¡µé¢åŠ è½½æ—¶çš„ loading                   |
| [`not-found`](https://nextjs.org/docs/app/api-reference/file-conventions/not-found)               | `.js` `.jsx` `.tsx` | é¡µé¢ 404 æ—¶æ˜¾ç¤ºï¼Œä»…åœ¨é¡¶å±‚ç”Ÿæ•ˆ            |
| [`error`](https://nextjs.org/docs/app/api-reference/file-conventions/error)                       | `.js` `.jsx` `.tsx` | é¡µé¢é”™è¯¯æ—¶æ˜¾ç¤ºï¼Œä»…åœ¨é¡¶å±‚ç”Ÿæ•ˆ              |
| [`global-error`](https://nextjs.org/docs/app/api-reference/file-conventions/error#global-errorjs) | `.js` `.jsx` `.tsx` | å…¨å±€é”™è¯¯æ—¶æ˜¾ç¤ºï¼Œä»…åœ¨é¡¶å±‚ç”Ÿæ•ˆ             |
| [`route`](https://nextjs.org/docs/app/api-reference/file-conventions/route)                       | `.js` `.ts`         | API è¯·æ±‚å®šåˆ¶æ–‡ä»¶                 |
| [`template`](https://nextjs.org/docs/app/api-reference/file-conventions/template)                 | `.js` `.jsx` `.tsx` | é‡æ¸²æŸ“æ—¶å®šåˆ¶ layout           |
| [`default`](https://nextjs.org/docs/app/api-reference/file-conventions/default)                   | `.js` `.jsx` `.tsx` | å¹³è¡Œè·¯ç”±å›è½é¡µé¢ï¼ˆå®˜æ–¹æ–‡æ¡£è¿˜åœ¨è¡¥å……ä¸­ã€‚ã€‚ã€‚ï¼‰|

> å¦‚æœæŸä¸€çº§ç›®å½•ä¸‹æ²¡æœ‰ layout å’Œ pageï¼Œåˆ™ä¸ä¼šè¢«è®¤ä¸ºæ˜¯ä¸€ä¸ªæ­£ç¡®çš„è·¯ç”±ç»“æ„

ä» app æ–‡ä»¶å¤¹å¼€å§‹å¾€ä¸‹ï¼Œéµä»ç›®å½•è·¯ç”±ç»“æ„ï¼š


![image.png](/img/posts/2024-1-19/2024-1-19-4.png)

æ¯”å¦‚æˆ‘åœ¨ app ä¸‹æ–°å»º dashboard ç›®å½•ï¼Œåœ¨ä¸‹è¾¹å†™ä¸Šè‡ªå·±çš„ layout.js å’Œ page.js æ–‡ä»¶ä»¬å°±å¯ä»¥è¿™æ ·è®¿é—®ï¼š`http://localhost:3000/dashboard` ï¼ˆ`<Link href="/dashboard">Dashboard</Link>`ï¼‰ã€‚æ­¤æ—¶ç›®å½•ç»“æ„å¯èƒ½æ˜¯è¿™ä¸ªæ ·å­çš„ï¼š


![image.png](/img/posts/2024-1-19/2024-1-19-5.png)

æˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨ template.js æ¥ä½œä¸ºä¸­é—´å±‚ï¼Œå®ƒä»‹äº layout.js å’Œå…¶å­©å­ç»„ä»¶ä¹‹é—´ï¼š

```js
// dashboard/template.js
import React from 'react'

export default function template({ children }) {
  return (
    <div>
      æ¥æ”¶æ¥è‡ª page.js çš„æ•°æ®ï¼š
      {children}
    </div>
  )
}
```

ç„¶åé¡µé¢æ˜¾ç¤ºï¼š

![image.png](/img/posts/2024-1-19/2024-1-19-6.png)

template å¯ç”¨äºé¡µé¢å¸ƒå±€ï¼Œæ‹†åˆ†é¡µé¢åŠŸèƒ½ç­‰ã€‚

### è·¯ç”±ç»„

æœ‰æ—¶å€™æˆ‘ä»¬æƒ³ç”¨ä¸€ä¸ªå¤§çš„æ–‡ä»¶å¤¹ç®¡ç†åˆ†ç»„æ–‡ä»¶ï¼Œä½†æ˜¯åˆä¸æƒ³ nextsjs å°†å…¶è¯†åˆ«ä¸ºè·¯ç”±ï¼Œé‚£ä¹ˆå¯ä»¥å°†æ–‡ä»¶å¤¹ç”¨å°æ‹¬å·åŒ…è£¹ï¼š


![image.png](/img/posts/2024-1-19/2024-1-19-7.png)

æ­¤æ—¶å°±å¯ä»¥è¿™æ ·è®¿é—®äº†ï¼š`http://localhost:3000/about`ã€‚

> éœ€æ³¨æ„ï¼Œæœ‰å¤šä¸ªè·¯ç”±ç»„æ—¶ï¼Œå†…éƒ¨çš„äºŒçº§ç›®å½•ï¼Œæ¯”å¦‚ about ä¸èƒ½é‡åï¼Œä¸ç„¶ä¼šè¯†åˆ«é”™è¯¯ã€‚

å½“ç„¶äº†ï¼Œå„ä¸ªè·¯ç”±ç»„é¡¶å±‚ä¹Ÿå¯ä»¥æœ‰è‡ªå·±çš„ layout.js ï¼Œæˆ–è€…å„ä¸ªäºŒçº§è·¯ç”±ï¼ˆæ¯”å¦‚ about æ–‡ä»¶å¤¹ï¼‰ä¸‹åˆ†åˆ«æ”¾ç½®è‡ªå·±çš„ layout.js ä¹Ÿå¯ä»¥ã€‚

### åŠ¨æ€è·¯ç”±

> ä»…åœ¨æœåŠ¡ç«¯ç»„ä»¶ä½¿ç”¨

å¯ä»¥å°†æ–‡ä»¶å¤¹åç§°ç”¨ä¸­æ‹¬å·æ‹¬èµ·æ¥è¡¨ç¤ºåŠ¨æ€è·¯ç”±ï¼š

```shell
./app/posts
â””â”€â”€ [id]
    â””â”€â”€ page.js
```

å…¶ä¸­ page.js:

```js
export default function Post({ params }) {
  return (
    <div>Post: {params.id}</div>
  )
}
```

æ­¤æ—¶å¯é€šè¿‡è·¯ç”± `http://localhost:3000/posts/1` æ¥è®¿é—®:


![image.png](/img/posts/2024-1-19/2024-1-19-8.png)

å½“ç„¶äº†ï¼Œå‚æ•°ä¸æ˜¯åªèƒ½ä¼ é€’ä¸€çº§å‚æ•°ï¼Œæˆ‘ä»¬å¦‚æœè¿™æ ·å®šä¹‰æ–‡ä»¶å¤¹ï¼š`[...ids]`ï¼š

```shell
./app/posts
â””â”€â”€ [...ids]
    â””â”€â”€ page.js
```

æ­¤æ—¶è®¿é—®ï¼š`http://localhost:3000/posts/12/56`ï¼Œæ­¤æ—¶åœ¨æœåŠ¡ç«¯å¯æ‰“å°æ‹¿åˆ°çš„å‚æ•°ï¼š

```js
{ params: { ids: [ '12', '56' ] }, searchParams: {} }
```

ä¸Šé¢çš„å†™æ³•è¿˜æœ‰ä¸€ç§å˜ä½“ï¼š`[[...ids]]`ï¼Œä½¿ç”¨åŒæ‹¬å·å’Œå•æ‹¬å·çš„åŠŸèƒ½æ˜¯ä¸€æ ·çš„ï¼Œè¯†åˆ«çš„åŸºæœ¬æ²¡æœ‰å·®åˆ«ï¼Œå”¯ä¸€çš„ä¸åŒæ˜¯ï¼Œä½¿ç”¨åŒæ‹¬å·å¯ä»¥è¯†åˆ«ä¸å¸¦å‚æ•°çš„è·¯å¾„ï¼š`http://localhost:3000/posts`ï¼Œè€Œå•æ‹¬å·çš„é…ç½®å°± 404 äº†ã€‚

### å¹³è¡Œè·¯ç”±

å¹³è¡Œè·¯ç”±çš„æ–‡ä»¶å¤¹ä»¥ `@` å¼€å¤´ï¼Œå…¶é»˜è®¤ä¹Ÿä¸ä¼šç”Ÿæˆåœ¨è·¯ç”±ä¸­ï¼Œä¸èƒ½ç›´æ¥è®¿é—®ã€‚


æ¯”å¦‚æˆ‘ä»¬æœ‰ä¸¤ä¸ªæ–‡ä»¶å¤¹ï¼š`@dashboard` å’Œ `@login` ï¼Œä¸€ä¸ªè¡¨ç¤ºç™»å½•åçš„æ¬¢è¿ç•Œé¢ï¼Œä¸€ä¸ªè¡¨ç¤ºæ²¡æœ‰æƒé™æ—¶çš„ç™»å½•é¡µé¢ï¼š


![image.png](/img/posts/2024-1-19/2024-1-19-9.png)


æˆ‘ä»¬é‡å†™ä¸€ä¸‹ `app/layout.js`:

```js
import { getUser } from '@/lib/auth'
 
export default function Layout({ dashboard, login }) {
  const isLoggedIn = getUser()
  return isLoggedIn ? dashboard : login
}
```

getUser æ˜¯è·å–å½“å‰ç”¨æˆ·çš„ï¼Œè¿™é‡Œå¿½ç•¥å…¶å®ç°ã€‚è¿™æ ·ï¼Œåœ¨æ ¹è·¯ç”±ä¸‹ï¼Œå°±å¯ä»¥é€šè¿‡æ¡ä»¶è¯­å¥åŠ¨æ€æŒ‚è½½å’Œåˆ é™¤è·¯ç”±ç»„ä»¶ï¼Œå½“ç„¶äº†ï¼Œä»–ä»¬ä¹Ÿå¯ä»¥åŒæ—¶è¢«æ¸²æŸ“åœ¨åŒä¸€ä¸ªé¡µé¢ä¸Šã€‚

### è·¯ç”±æ‹¦æˆª

è·¯ç”±æ‹¦æˆªä¸€èˆ¬é’ˆå¯¹å¼¹å‡ºå±‚ï¼Œåœ¨ nextjs ä¸­ï¼Œå¼¹å‡ºå±‚ modal ä¹Ÿæœ‰è‡ªå·±çš„è·¯ç”±ï¼Œåœ¨å¼¹å‡ºå±‚è·¯ç”±ä¸‹åŸåœ°åˆ·æ–°é¡µé¢ï¼Œä¸åº”è¯¥å†å‡ºç°æ¨¡æ€æ¡†ï¼Œè€Œæ˜¯ç›´æ¥å±•ç¤ºåŸæ¥å¼¹çª—é‡Œè¾¹çš„è¯¦æƒ…ï¼Œè¿™æ ·çš„ä¸€ä¸ªurlå±•ç¤ºä¸¤ç§å½¢æ€çš„è·¯ç”±ï¼Œå«åšæ‹¦æˆªè·¯ç”±ã€‚

è·¯ç”±æ‹¦æˆªï¼Œæ˜¯åœ¨è·¯ç”±ç›®å½•å‘½åå‰é¢åŠ ä¸Šå°æ‹¬å·è¡¨ç¤ºï¼š

-   `(.)`åŒ¹é…**åŒä¸€çº§åˆ«çš„æ®µ**
-   `(..)`åŒ¹é…**ä¸Šä¸€çº§çš„æ®µ**
-   `(..)(..)`åŒ¹é…**ä¸Šé¢ä¸¤çº§çš„æ®µ**
-   `(...)`åŒ¹é…**æ ¹** `app`ç›®å½•ä¸­çš„æ®µ

æˆ‘ä»¬ä¸¾ä¾‹æ¥è¯´æ˜ã€‚


![image.png](/img/posts/2024-1-19/2024-1-19-10.png)

ä¸Šé¢çš„å›¾ç‰‡ä¸­ï¼Œphotoç›®å½•ä¸‹æ”¾ç½®çš„æ˜¯è·¯ç”± `photo/id` è¦å±•ç¤ºçš„å›¾ç‰‡è¯¦æƒ…å†…å®¹ï¼Œ`@modal` ç›®å½•ç”¨äºå°† photo ç›®å½•æ‹¦æˆªå¹¶åŒ…è£¹åœ¨ä¸€ä¸ªæ¨¡æ€æ¡†ä¸­ã€‚è¿™é‡Œ `(..)`ä¼šä» `@modal` ä¸Šä¸€çº§ç›®å½•å¯¼å…¥åŒçº§ç›®å½•ä¸­å»æ‰¾ `photo` ç›®å½•æ¥åŒ¹é…ã€‚

æ­¤æ—¶ï¼Œå½“é€šè¿‡ ```<Link key={id} href={`/photos/${id}`}>``` æ¥è®¿é—®ç›®å½•æ—¶ï¼Œå°±ä¼šå‡ºç°ä¸»é¡µé¢ä¸Šå¼¹å‡ºçš„æ¨¡æ€æ¡†ã€‚

åœ¨åˆ—è¡¨é¡µç‚¹å‡» link è®¿é—®ï¼š


![image.png](/img/posts/2024-1-19/2024-1-19-11.png)

ç›´æ¥é€šè¿‡ url è®¿é—®ï¼š


![image.png](/img/posts/2024-1-19/2024-1-19-12.png)

demo åœ°å€ï¼š[è·¯ç”±æ‹¦æˆª](https://github.com/vercel-labs/nextgram/tree/main)

### è·¯ç”±å¤„ç†ç¨‹åº ï¼ˆAPIè·¯ç”±ï¼‰

æ¯ä¸€å¥—è·¯ç”±ï¼ŒåŒ…æ‹¬æ ¹è·¯ç”±ï¼Œéƒ½æ˜¯å¯ä»¥é…æœ‰ä¸€ä¸ª `route.js` (ts) æ–‡ä»¶ç”¨äºè‡ªå®šä¹‰å¤„ç†æ•°æ®å’Œè·¯ç”±è¿”å›å†…å®¹çš„ã€‚æˆ‘ä»¬çœ‹ä¸€ä¸‹å¦‚ä¸‹çš„è·¯ç”±ç›®å½•ï¼š

```shell
./posts
â””â”€â”€ [...ids]
    â”œâ”€â”€ page.js
    â””â”€â”€ route.js
```

åœ¨ route.js ä¸­æˆ‘ä»¬å†™å…¥ï¼š

```js
export async function GET(
  request,
  params
) {
  const ids = params.params.ids;
  console.log(ids)

  return new Response('Hello, Next.js!', {
    status: 200,
    headers: { 'Set-Cookie': `token=${ids}` },
  })
}
```

å¯ä»¥çœ‹åˆ°ï¼Œä»–æ¥å—äº†è·¯ç”±å‚æ•° idsï¼Œå¹¶ä¸”æ ¹æ®è‡ªå®šä¹‰çš„é€»è¾‘è¿”å›äº†é¡µé¢å“åº”ã€‚é¡µé¢è®¿é—® `http://localhost:3000/posts/111/122` æŸ¥çœ‹æ•ˆæœï¼š


![image.png](/img/posts/2024-1-19/2024-1-19-13.png)

è‡ªå®šä¹‰çš„ cookie è®¾ç½®è¿›å»äº†ã€‚

### è·¯ç”±ä¸­é—´ä»¶

åœ¨é¡¹ç›®ç›®å½•ä¸­æ”¾ç½®æ–‡ä»¶ `middleware.ts`ï¼ˆæˆ– .jsï¼‰æ¥å®šä¹‰ä¸­é—´ä»¶ã€‚æ”¾ç½®ç›®å½•ä¸`pages`æˆ–`app`åŒçº§ï¼Œæˆ–åœ¨å†…éƒ¨`src` é¡¶å±‚ï¼ˆå¦‚æœæœ‰ srcï¼‰ï¼Œnextjs ä¼šè‡ªåŠ¨è¯†åˆ«ä¸­é—´ä»¶æ–‡ä»¶ï¼Œå¹¶åœ¨å†…å®¹ç¼“å­˜å’Œè·¯ç”±åˆ‡æ¢ä¹‹å‰æ‰§è¡Œè¯¥æ–‡ä»¶ã€‚

ä¸¾ä¸€ä¸ªæˆ‘åœ¨é¡¹ç›®ä¸­é…ç½® i18n çš„ä¾‹å­ï¼š

```js
// src/middleware.js
export function middleware(req) {
  let lng
  if (req.cookies.has(cookieName)) {
    lng = acceptLanguage.get(req.cookies.get(cookieName).value)
    console.log('Cookie language:', lng)
  }
  if (!lng) {
    lng = acceptLanguage.get(req.headers.get('Accept-Language'))
    console.log('Accept-Language:', lng)
  }
  if (!lng || !languages.includes(lng)) lng = fallbackLng

  // Redirect if lng in path is not supported
  if (
    !languages.some(loc => req.nextUrl.pathname.startsWith(`/${loc}`)) &&
    !req.nextUrl.pathname.startsWith('/_next')
  ) {
    return NextResponse.redirect(new URL(`/${lng}${req.nextUrl.pathname}`, req.url))
  }

  return NextResponse.next()
}
```

ä¸Šé¢çš„ä»£ç ï¼Œæ‹¦æˆªè¯·æ±‚ reqï¼Œåˆ¤æ–­è¯·æ±‚çš„ cookie é‡Œæœ‰æ²¡æœ‰è¯­è¨€çš„é…ç½®ï¼Œå¦‚æœæ²¡æœ‰å°±ä½¿ç”¨ Accept-Language è·å–æµè§ˆå™¨æ¨èçš„è¯­è¨€ï¼Œå¦‚æœè¿˜æ²¡æœ‰å°±ä½¿ç”¨å›è½å…œåº•æ–¹æ¡ˆï¼›æœ€åä½¿ç”¨ `NextResponse.redirect` é‡å®šå‘åˆ°å¯¹åº”çš„è¯­è¨€è·¯å¾„ã€‚

## 2. æ•°æ®è·å–æ–¹å¼

Next.js ä¹Ÿå¯ä»¥è¯·æ±‚ç¬¬ä¸‰æ–¹çš„æœåŠ¡æ¥è·å–æ•°æ®ã€‚

### æœåŠ¡ç«¯

æœåŠ¡ç«¯ç»„ä»¶ä¸­ï¼Œå®˜æ–¹æ¨èä½¿ç”¨ fetchï¼š

```js
// page.js
async function getData() {
  const res = await fetch('https://api.example.com/...')
  // The return value is *not* serialized
  // You can return Date, Map, Set, etc.
 
  if (!res.ok) {
    // This will activate the closest `error.js` Error Boundary
    throw new Error('Failed to fetch data')
  }
 
  return res.json()
}
 
export default async function Page() {
  const data = await getData()
  console.log(data)
  return <main></main>
}
```
æ­¤å¤–ï¼Œfetch å¯ä»¥ä½¿ç”¨ `{ cache: 'force-cache' }` æ¥ç¼“å­˜æ•°æ®ã€‚

### å®¢æˆ·ç«¯

è¦å£°æ˜ä¸€ä¸ªç»„ä»¶æ˜¯å®¢æˆ·ç«¯ç»„ä»¶ï¼Œéœ€è¦è¿™æ ·å†™:

```js
'use client'
 
export default function ClientComponent({ updateItem }) {
  return <form action={updateItem}>{/* ... */}</form>
}
```

å®¢æˆ·ç«¯ç»„ä»¶å°±è·Ÿå¹³å¸¸çš„ react å¼€å‘ä¸€æ ·ï¼Œå¯ä»¥ä½¿ç”¨ React çš„å„ç§çŠ¶æ€ Hook å’Œ ç¬¬ä¸‰æ–¹å·¥å…·ï¼ˆæ¯”å¦‚ axiosï¼‰æ¥å¤„ç†æ•°æ®ã€‚

å®¢æˆ·ç«¯æˆ‘ä»¬è¿˜å¯ä»¥è¯·æ±‚å‰é¢çš„ API è·¯ç”±æ¥è·å–æ•°æ®ï¼ŒAPI è·¯ç”±ä¸­å¯ä»¥æ˜¯æœåŠ¡ç«¯è°ƒç”¨ç¬¬ä¸‰æ–¹æ¥å£è¯·æ±‚çš„æ•°æ®ã€‚

## 3. æœåŠ¡ç«¯æ¸²æŸ“ä¸å®¢æˆ·ç«¯æ¸²æŸ“

### æœåŠ¡ç«¯ç­–ç•¥

- é»˜è®¤ä¸ºé™æ€æ¸²æŸ“

è·¯ç”±å’ŒæœåŠ¡ç«¯æ•°æ®åœ¨ build æ—¶åŒæ­¥è·å–ï¼Œç»“æœä¼šå­˜åœ¨æœåŠ¡ç«¯ï¼Œæ”¯æŒç¼“å­˜ CDN ä¸­ï¼Œæ­¤æ—¶å°±æ˜¯æ ‡å‡†çš„åç«¯ç›´å‡ºçš„é™æ€é¡µé¢ã€‚

- åŠ¨æ€æ¸²æŸ“

è·¯ç”±åœ¨æ¯æ¬¡è®¿é—®æ—¶åŠ¨æ€è·å–é¡µé¢æ•°æ®ï¼Œé€‚ç”¨äºä¸€äº›éœ€è¦å±•ç¤ºå®æ—¶æ•°æ®çš„åœºæ™¯ï¼ˆæ¯”å¦‚ cookiesã€url paramsç­‰ï¼‰ã€‚

å¦‚æœé¡µé¢ä¸­æœ‰åŠ¨æ€å‡½æ•°æˆ–è€…æœªè¢«ç¼“å­˜çš„æ•°æ®ï¼Œåˆ™è‡ªåŠ¨è½¬æ¢ä¸ºåŠ¨æ€é¡µé¢æ¸²æŸ“ï¼š

Dynamic Functions | Data       | Route                |
| ----------------- | ---------- | -------------------- |
| No                | Cached     | Statically Rendered  |
| Yes               | Cached     | Dynamically Rendered |
| No                | Not Cached | Dynamically Rendered |
| Yes               | Not Cached | Dynamically Rendered|

å…³äºåŠ¨æ€å‡½æ•°ï¼ŒæŒ‡çš„æ˜¯åªæœ‰åœ¨è¯·æ±‚åæ‰çŸ¥é“è¿”å›ç»“æœçš„å‡½æ•°ï¼ŒåŠ¨æ€å‡½æ•°å¿…é¡»æ˜¯å†…ç½®çš„ï¼Œå› ä¸º fetch ä¼šè¢«ç¼“å­˜ï¼š

```js
import { cookies } from 'next/headers'
import { headers } from 'next/headers'
```

- æµå¼åŠ è½½

æ¸è¿›å¼çš„ UI æ¸²æŸ“ç­–ç•¥ï¼Œå¯ä»¥é€šè¿‡ loading.js æ–‡ä»¶ï¼Œæˆ–è€…ä½¿ç”¨ `React.Suspense` æ¥å¼€å¯ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œæµå¼åŠ è½½å†…ç½®äº Next.js App Router ä¸­ï¼ŒåŠ©äºæé«˜åˆå§‹é¡µé¢åŠ è½½æ€§èƒ½ï¼Œæ¯”å¦‚åŠ è½½å“ªäº› ä¾èµ–äºè¾ƒæ…¢æ•°æ®è·å–ï¼ˆä¼šé˜»æ­¢æ¸²æŸ“æ•´ä¸ªè·¯ç”±ï¼‰çš„ UIï¼ˆäº§å“é¡µé¢ä¸Šçš„è¯„è®ºç­‰ï¼‰:

```js
// page.js
import { Suspense } from 'react'
import { PostFeed, Weather } from './Components'
 
export default function Posts() {
  return (
    <section>
      <Suspense fallback={<p>Loading feed...</p>}>
        <PostFeed />
      </Suspense>
      <Suspense fallback={<p>Loading weather...</p>}>
        <Weather />
      </Suspense>
    </section>
  )
}
```

### å®¢æˆ·ç«¯ç­–ç•¥

å®¢æˆ·ç«¯ç»„ä»¶åœ¨ build æ—¶ä¸å‚ä¸è·å–æ•°æ®å’Œé¢„æ¸²æŸ“ï¼Œä»–åœ¨å®¢æˆ·æµè§ˆå™¨è¿è¡Œæ—¶æ‰å¼€å§‹æ‰§è¡Œå¹¶æ¸²æŸ“æ•°æ®ã€‚å®¢æˆ·ç«¯ç»„ä»¶å¯ä»¥ä½¿ç”¨çŠ¶æ€ã€æ•ˆæœå’Œäº‹ä»¶ä¾¦å¬å™¨ï¼Œå¾€å¾€ç”¨äºäº¤äº’ç›¸å¯¹å¤æ‚çš„åœºæ™¯ã€‚

åœ¨éœ€è¦å®¢æˆ·ç«¯æ¸²æŸ“çš„ä»£ç ç‰‡æ®µé¡¶å±‚å†™ä¸Šï¼š`"use client"` ä¾¿å¯ä»¥å£°æ˜å®¢æˆ·ç«¯ç»„ä»¶ï¼š

```js
'use client'
 
import { useState } from 'react'
 
export default function Counter() {
  const [count, setCount] = useState(0)
 
  return (
    <div>
      <p>You clicked {count} times</p>
      <button onClick={() => setCount(count + 1)}>Click me</button>
    </div>
  )
}
```

Next.js æ¸²æŸ“çš„ç­–ç•¥æ˜¯ï¼šåœ¨ç”¨æˆ·å®¢æˆ·ç«¯æ‹‰å–æœåŠ¡ç«¯ç»„ä»¶ä»£ç å’Œå®¢æˆ·ç«¯ç»„ä»¶ä»£ç ï¼Œå…ˆæ¸²æŸ“å‡ºæ— äº¤äº’çš„é¡µé¢ä¿¡æ¯ï¼Œå®Œæˆåˆå§‹é¡µé¢åŠ è½½ï¼Œä¹‹åä½¿ç”¨å®¢æˆ·ç«¯æ°´åˆæŠ€æœ¯ï¼Œæ›´æ–° DOM æ ‘ï¼Œæ¤å…¥äº¤äº’ä¿¡æ¯å’Œäº‹ä»¶ç›‘å¬ã€‚


## 4. å…³äºç¼“å­˜

### è¯·æ±‚ç¼“å­˜

ä¸ºäº†ä¸ç”¨æ¯æ¬¡éƒ½è°ƒç”¨æ¥å£è·å–é‡å¤çš„æ•°æ®ï¼ŒNext.js æ‰©å±•äº† fetch API å»è‡ªåŠ¨ç¼“å­˜è¯·æ±‚æ•°æ®ï¼Œç¼“å­˜å‘½ä¸­ç­–ç•¥æ˜¯ï¼š`ç›¸åŒçš„ urlã€åè®®å’Œè¯·æ±‚ä½“`ã€‚


![image.png](/img/posts/2024-1-19/2024-1-19-14.png)

åœ¨éœ€è¦æ•°æ®çš„åœ°æ–¹ï¼Œå¯ä»¥æ”¾å¿ƒçš„ç›´æ¥ä½¿ç”¨ fetch å³å¯ï¼ŒNext.js ä¼šè¿›è¡Œå…œåº•çš„ã€‚ç¼“å­˜ç­–ç•¥å·¥ä½œæµç¨‹å¦‚ä¸‹ï¼š

1. åœ¨ä¸€ä¸ª route åŠ è½½æ—¶ï¼Œç¬¬ä¸€æ¬¡è¯·æ±‚ï¼Œä¸è¿›è¡Œç¼“å­˜
2. ç¬¬äºŒæ¬¡è¯·æ±‚ï¼Œå¦‚æœæ»¡è¶³æˆ‘ä»¬ä¸Šé¢è¯´çš„æ¡ä»¶ï¼Œåˆ™å‘½ä¸­ç¼“å­˜ï¼Œè¿™æ¬¡è¯·æ±‚è¿”å›æ•°æ®å°±ä»ç¼“å­˜ä¸­å–
3. ä¸€æ—¦ route é‡æ¸²æŸ“äº†ï¼Œç¼“å­˜åˆ™ä¼šæ¸…é™¤ï¼Œé‚£ä¹ˆè°ƒç”¨å°±ä¼šå‘èµ· API è¯·æ±‚äº†ã€‚

å¦‚æœä¸æƒ³ç¼“å­˜è¿™ä¸ªè¯·æ±‚ï¼Œå¯ä»¥è¿™æ ·å†™ï¼š

```js
const { signal } = new AbortController()
fetch(url, { signal })
```

### æ•°æ®çš„ç¼“å­˜

**æ•°æ®ç¼“å­˜å’Œè¯·æ±‚è®°å¿†ä¹‹é—´çš„å·®å¼‚**

å®˜æ–¹è§£é‡Šï¼š

æ•°æ®ç¼“å­˜åœ¨ä¼ å…¥è¯·æ±‚å’Œéƒ¨ç½²ä¸­æ˜¯æŒä¹…çš„ï¼Œè€Œè¯·æ±‚ç¼“å­˜çš„ç”Ÿå‘½å‘¨æœŸä»…æŒç»­åœ¨è¯·æ±‚è¿‡ç¨‹ä¸­ã€‚

é€šè¿‡è¯·æ±‚ç¼“å­˜ï¼Œå¯ä»¥é¿å…é‡å¤è¯·æ±‚ç¼“å­˜æœåŠ¡å™¨ã€CDNç­‰çš„æ•°é‡ã€‚è€Œé€šè¿‡æ•°æ®ç¼“å­˜ï¼Œæˆ‘ä»¬å‡å°‘äº†å¯¹åŸå§‹æ•°æ®æºå‘å‡ºçš„è¯·æ±‚æ•°é‡ã€‚

åƒµå°¸æ ½èŠ±ï¼Œå…·ä½“çš„åŒºåˆ«æˆ‘ä¹Ÿç†è§£ä¸æ·±ï¼Œä¸ºå•¥è¦åšä¸¤å±‚~~ ğŸ˜“

æˆ‘ä»¬çœ‹å›¾ï¼š


![image.png](/img/posts/2024-1-19/2024-1-19-15.png)

è¯·æ±‚ç¼“å­˜æ˜¯åœ¨æ•°æ®ç¼“å­˜å‰è¾¹çš„ï¼Œè¯·æ±‚ç¼“å­˜æ²¡æœ‰å‘½ä¸­ï¼Œæ‰ä¼šå»æ‰¾æ•°æ®ç¼“å­˜ï¼Œè¿˜æ²¡æœ‰å‘½ä¸­æ‰ä¼šå»è¯·æ±‚åŸå§‹æ•°æ®æºã€‚

æˆ‘ä»¬å¯ä»¥è¿™æ ·è¯·æ±‚ï¼š

```js
fetch('https://...', { next: { revalidate: 3600 } })
```

è¡¨ç¤º 3600 ç§’ä¹‹å†…ï¼Œæ•°æ®æ˜¯ç¼“å­˜æœ‰æ•ˆçš„ã€‚3600 ç§’ä¹‹åä¼šè‡ªåŠ¨é‡æ–°éªŒè¯ï¼Œè‹¥æ²¡æœ‰å˜åŒ–åˆ™è¿˜æ˜¯ç”¨ç¼“å­˜ã€‚

æˆ‘ä»¬è¿˜å¯ä»¥ç¦ç”¨ç¼“å­˜:

```js
fetch(`https://...`, { cache: 'no-store' })
```

### å°ç»“

æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å…¨è·¯ç”±ç¼“å­˜çš„æµç¨‹å›¾ï¼š


![image.png](/img/posts/2024-1-19/2024-1-19-16.png)

1. è¿è¡Œæ—¶ï¼Œå®¢æˆ·ç«¯çš„è·¯ç”±ç¼“å­˜ï¼Œæ¯”å¦‚ Suspense.
2. ç¼–è¯‘æ—¶ï¼Œè·¯ç”±å·²ç»ç¡®å®šï¼Œè¯·æ±‚çš„è·¯ç”±å¦‚æœå‘½ä¸­ç¼“å­˜ï¼Œåˆ™ç›´æ¥è¿”å›ã€‚
3. ç¼–è¯‘æ—¶ï¼ŒAPI è¯·æ±‚å·²ç»ç¡®å®šï¼Œè¯·æ±‚çš„ API å¦‚æœå‘½ä¸­ç¼“å­˜ï¼Œåˆ™ç›´æ¥è¿”å›ç»“æœï¼Œä¸å¿…å†æ¬¡å‘èµ·å¯¹æ•°æ®ç¼“å­˜çš„è¯·æ±‚ã€‚
4. ç¼–è¯‘æ—¶ï¼ŒéåŠ¨æ€ API è¿”å›çš„ç»“æœå·²ç»ç¡®å®šï¼Œå¦‚æœè¯·æ±‚ç›¸åŒçš„æ•°æ®ï¼Œä¸”ç¼“å­˜ä¸è¿‡æœŸï¼Œåˆ™ä½¿ç”¨ç¼“å­˜ç»“æœï¼Œä¸å‘å…ƒæ•°æ®è¯·æ±‚ã€‚

## 5. å…³äºæ ·å¼ 

å¯ä»¥ä½¿ç”¨ css æ¨¡å—ï¼š

```js
import styles from './styles.module.css'
 
export default function DashboardLayout({
  children,
}: {
  children: React.ReactNode
}) {
  return <section className={styles.dashboard}>{children}</section>
}
```

ä¹Ÿå¯ä»¥ä½¿ç”¨ CSS-in-JSï¼Œæ¯”å¦‚ emotion ç­‰ï¼Œå½“ç„¶ä¸€äº›é¢„å¤„ç†å™¨ï¼Œæ¯”å¦‚ sassã€less ä¹Ÿå¯ä»¥ä½¿ç”¨ï¼Œä¸è¿‡è¦åœ¨é…ç½®é‡Œå¢åŠ é…ç½®é¡¹ï¼š

```js
const path = require('path')
 
module.exports = {
  sassOptions: {
    includePaths: [path.join(__dirname, 'styles')],
  },
}
```

å½“ç„¶ï¼Œå¯¹äºä¼ä¸šçº§å¤§å‹åº”ç”¨ï¼Œè¿˜æ˜¯æ¨èä½¿ç”¨ Tailwindcssï¼Œä¸‹ä¸€æœŸè®²å®æˆ˜ä¼šè®²è§£ã€‚


## 6. SEO é…ç½®


### meta 

åœ¨å„ä¸ª page.js æ–‡ä»¶ä¸­ï¼Œéƒ½å¯ä»¥é…ç½®å½“å‰é¡µé¢å¯¹åº”çš„ meta ä¿¡æ¯ï¼š

```js
import { Metadata } from 'next'

// ä½¿ç”¨ é™æ€ meta
export const metadata: Metadata = {
  title: '...',
}
 
// ä½¿ç”¨ åŠ¨æ€ meta
export async function generateMetadata({ params }) {
  return {
    title: '...',
  }
}

export default function Page() { return '...'}
```
å½“ç„¶ä½ ä¹Ÿå¯ä»¥ç›´æ¥åœ¨ layout ä¸­å†™å…¥ã€‚

### sitemap

æ¨èå®‰è£… `next-sitemap` åº“ï¼Œä½¿ç”¨æ—¶åªéœ€è¦åœ¨ package.json ä¸­å†™å…¥æŒ‡ä»¤å³å¯ï¼š`"postbuild": "next-sitemap"`ï¼Œè¿™æ ·åœ¨æ‰“åŒ…åå°±ä¼šåœ¨ public æ–‡ä»¶å¤¹ç”Ÿæˆ robots.txt å’Œ sitemap.xml æ–‡ä»¶ã€‚å½“ç„¶äº†ï¼Œå¦‚æœä½ æƒ³è‡ªå®šä¹‰é…ç½®ï¼Œå¯åœ¨æ ¹ç›®å½•åˆ›å»ºä¸€ä¸ªé…ç½®æ–‡ä»¶ `next-sitemap.config`:

```js
/** @type {import('next-sitemap').IConfig} */
module.exports = {
  siteUrl: process.env.SITE_URL || "https://xxx.com",
  generateIndexSitemap: false,
  generateRobotsTxt: true,
  robotsTxtOptions: {
    policies: [{ userAgent: '*', allow: '/' }],
  },
};
```

## 7. é™„å½•ï¼šNext.js 13+ æ–°åŠŸèƒ½ä¸€è§ˆ

### React æœåŠ¡å™¨ç»„ä»¶ ï¼ˆRSCï¼‰

RSCs å…è®¸åœ¨å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¸Šé‡‡ç”¨æ›´ç²¾ç»†çš„æ¸²æŸ“æ–¹å¼ã€‚React å…è®¸å¼€å‘è€…é€‰æ‹©ç»„ä»¶æ˜¯åœ¨æœåŠ¡å™¨ä¸Šè¿˜æ˜¯åœ¨å®¢æˆ·ç«¯æ¸²æŸ“ï¼Œè€Œä¸æ˜¯åœ¨ç”¨æˆ·è¯·æ±‚æ—¶è¢«è¿«å†³å®šåœ¨å®¢æˆ·ç«¯è¿˜æ˜¯æœåŠ¡å™¨ä¸Šæ¸²æŸ“æ•´ä¸ªé¡µé¢ã€‚è¿™å¯ä»¥è®©ä½ åœ¨æœç´¢å¼•æ“ç»“æœé¡µé¢ä¸­è·å¾—å·¨å¤§ä¼˜åŠ¿ã€‚

### Streaming UI

æµå¼ UIï¼ˆStreaming UIï¼‰ä»£ç å—æ˜¯ä¸€ä¸ªæ–°å…´çš„è®¾è®¡æ¨¡å¼ï¼Œç§°ä¸º`å²›å±¿æ¶æ„ï¼ˆthe island architectureï¼‰`ï¼Œæ—¨åœ¨é¦–æ¬¡åŠ è½½æ—¶å°½é‡å‘å®¢æˆ·ç«¯å‘é€æœ€å°‘çš„ä»£ç ã€‚

å…¶å®ç°ç›®æ ‡æ˜¯ï¼šå‘å®¢æˆ·ç«¯å‘é€ä¸€ä¸ªæ— éœ€ JavaScript çš„å®Œå…¨æ¸²æŸ“çš„é¡µé¢ï¼Œç„¶åå†å‘é€å‰©ä½™çš„å†…å®¹ã€‚

å½“ Next.js åœ¨æœåŠ¡å™¨ç«¯æ¸²æŸ“é¡µé¢æ—¶ï¼Œé€šå¸¸ä¼šå°†é¡µé¢çš„æ‰€æœ‰ JavaScript æ†ç»‘å¹¶ä¸ä¹‹ä¸€èµ·å‘é€ã€‚è€Œæµå¼ UI ä»£ç å—çš„å¼•å…¥æ¶ˆé™¤äº†è¿™ç§éœ€è¦ï¼Œå…è®¸å‘å®¢æˆ·ç«¯å‘é€ä¸€ä¸ªéå¸¸å°çš„é™æ€é¡µé¢ï¼Œæ˜¾è‘—æ”¹å–„äº†è¯¸å¦‚é¦–æ¬¡å†…å®¹å‘ˆç°æ—¶é—´å’Œæ•´ä½“é¡µé¢é€Ÿåº¦ç­‰æŒ‡æ ‡ã€‚

æµå¼ UI çš„æ­¥éª¤å¤§è‡´å¦‚ä¸‹ï¼š

-   ç”¨æˆ·å‘èµ·åˆå§‹è¯·æ±‚
-   æ¸²æŸ“å¹¶å‘é€åŸºæœ¬çš„ HTML é¡µé¢ç»™å®¢æˆ·ç«¯
-   æœåŠ¡å™¨å‡†å¤‡ JavaScript æ†ç»‘æ–‡ä»¶
-   åœ¨å®¢æˆ·ç«¯æµè§ˆå™¨ä¸­æ˜¾ç¤ºéœ€è¦ JavaScript çš„é¡µé¢éƒ¨åˆ†
-   ä»…å°†è¯¥ç»„ä»¶æ‰€éœ€çš„ JavaScript æ†ç»‘æ–‡ä»¶å‘é€ç»™å®¢æˆ·ç«¯

### App Router

app ç›®å½•ä¸‹çš„æ‰€æœ‰ä¸œè¥¿éƒ½æ˜¯é¢„å…ˆé…ç½®å¥½çš„ï¼Œä»¥å…è®¸ RSCs å’Œæµå¼ UI çš„å‡ºç°ã€‚ä½ åªéœ€è¦åˆ›å»ºä¸€ä¸ª[loading.js](https://beta.nextjs.org/docs/routing/loading-ui)ç»„ä»¶ï¼Œå®ƒå°†å®Œå…¨åŒ…ä½é¡µé¢ç»„ä»¶å’Œ suspense è¾¹ç•Œå†…çš„ä»»ä½•å­èŠ‚ç‚¹ã€‚

### å‡çº§çš„ Next Image ç»„ä»¶

åˆ©ç”¨äº†æµè§ˆå™¨åŸç”Ÿæ”¯æŒçš„æ‡’åŠ è½½ç­–ç•¥ï¼Œæ·»åŠ äº†ä¸€äº›å¯¹ SEO æœ‰å¾ˆå¤§å¸®åŠ©çš„æ”¹è¿›ï¼š

-   é»˜è®¤éœ€è¦ alt æ ‡ç­¾ã€‚
-   æ›´å¥½çš„éªŒè¯ï¼Œä»¥ç¡®å®šæ¶‰åŠæ— æ•ˆå±æ€§é”™è¯¯ã€‚
-   ç”±äºæœ‰äº†ä¸€ä¸ªæ›´åƒ HTML çš„ç•Œé¢ï¼Œæ›´å®¹æ˜“è¿›è¡Œæ ·å¼è®¾è®¡ã€‚

### Font ç»„ä»¶

ç½‘é¡µæ€§èƒ½ä¸­ï¼ŒCLS æ˜¯ä¸€ä¸ªé‡è¦çš„æŒ‡æ ‡ï¼ˆCLS æ˜¯ Cumulative Layout Shift çš„ç¼©å†™ï¼Œè¡¡é‡åœ¨ç½‘é¡µçš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸå†…å‘ç”Ÿçš„æ‰€æœ‰æ„å¤–å¸ƒå±€åç§»çš„å¾—åˆ†æ€»å’Œã€‚ï¼‰ï¼Œæ ¹æ®ä½ æ‰€ä½¿ç”¨çš„æ¡†æ¶ï¼ˆæ¯”å¦‚ Gatsbyï¼‰ï¼Œè®©å­—ä½“æœ‰æ•ˆåœ°é¢„åŠ è½½å¯èƒ½æ˜¯å¾ˆæ£˜æ‰‹çš„ã€‚ä¸€æ®µæ—¶é—´ä»¥æ¥ï¼Œå‘è°·æ­Œç­‰å­—ä½“åº“å‘å‡ºå¤–éƒ¨è¯·æ±‚æ˜¯ä¸€ä¸ªé¿å…ä¸äº†çš„è¡Œä¸ºï¼Œåœ¨è®¸å¤š SPA åº”ç”¨ç¨‹åºä¸­é€ æˆäº†ä¸€ä¸ªéš¾ä»¥ç®¡ç†çš„ç“¶é¢ˆï¼ˆé¡µé¢æ–‡å­—ä¼šé—ªçƒä¸€ä¸‹ï¼‰ã€‚

Next Font Component æ—¨åœ¨è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå®ƒåœ¨æ„å»ºæ—¶è·å–æ‰€æœ‰çš„å¤–éƒ¨å­—ä½“ï¼Œå¹¶ä»ä½ è‡ªå·±çš„åŸŸä¸­è‡ªæˆ‘æ‰˜ç®¡å®ƒä»¬ã€‚å­—ä½“ä¹Ÿè¢«è‡ªåŠ¨ä¼˜åŒ–ï¼Œå¹¶ä¸”é€šè¿‡è‡ªåŠ¨åˆ©ç”¨ CSS **size-adjustï¼ˆå¤§å°è°ƒæ•´ï¼‰**  å±æ€§å®ç°äº†é›¶ç´¯ç§¯çš„å¸ƒå±€è½¬ç§»ã€‚

æ¯”å¦‚è¿™æ ·ä½¿ç”¨ google å­—ä½“ï¼š

```js
import { Roboto } from 'next/font/google'

const roboto = Roboto({ weight: '400', subsets: ['latin'], display: 'swap',})

...
<html lang="en" className={roboto.className}> <body>{children}</body> </html>
```

å…³äºæ–°åŠŸèƒ½ App router å°±è®²è¿™ä¹ˆå¤šå•¦ï¼Œæ¬¢è¿å¤§å®¶ä¸€èµ·è®¨è®ºäº¤æµï¼Œä¸€èµ·å­¦ä¹ ã€‚4b:T1b89,æœ¬èŠ‚ç»§ç»­ï¼Œä»‹ç»å¾®å‰ç«¯ä¸­ js éš”ç¦»çš„æ–¹æ¡ˆã€‚å‰ä¸€è®²çš„ iframe éš”ç¦»ï¼Œæœ¬è´¨ä¸Šæ˜¯åˆ©ç”¨äº† V8 å¼•æ“çš„éš”ç¦»æœºåˆ¶ï¼Œå€ŸåŠ© iframe å®ç°çš„ï¼›æœ¬èŠ‚è¯´çš„å¿«ç…§éš”ç¦»ï¼Œæœ¬è´¨ä¸Šè¿˜æ˜¯æŠŠå­åº”ç”¨æ‰§è¡Œåœ¨ä¸»åº”ç”¨ä¸Šä¸‹æ–‡ä¸­ï¼Œä½†æ˜¯å¯¹ä¸»åº”ç”¨çš„ winodw åšå¿«ç…§ï¼Œåœ¨å­åº”ç”¨å¸è½½çš„æ—¶å€™æ¢å¤å¿«ç…§å³å¯ã€‚

![image.png](/img/posts/2024-1-11/2024-1-11-1.png)

[ä»“åº“åœ°å€ï¼šsandbox/snapshot-script åˆ†æ”¯](https://github.com/heiheihoho1213/monto-app/tree/sandbox/snapshot-script)

## 2. ä¸»åº”ç”¨æœåŠ¡

æˆ‘ä»¬å¯åŠ¨ä¸»åº”ç”¨æœåŠ¡ï¼š

```js
app.listen(port.main, host);
```
å¹¶åœ¨ä¸»åº”ç”¨é‡Œå†™å…¥æ¥å£è¯·æ±‚ï¼š

```js
app.post("/microapps", function (req, res) {
  // è¿™é‡Œå¯ä»¥æ˜¯ç®¡ç†åå°æ–°å¢èœå•åå­˜å‚¨åˆ°æ•°æ®åº“çš„æ•°æ®
  // ä»è€Œå¯ä»¥é€šè¿‡ç®¡ç†åå°åŠ¨æ€é…ç½®å¾®åº”ç”¨çš„èœå•
  res.json([
    {
      name: "micro1",
      id: "micro1",
      // è¿™é‡Œæš‚æ—¶ä»¥ä¸€ä¸ªå…¥å£æ–‡ä»¶ä¸ºç¤ºä¾‹
      script: `http://${host}:${port.micro}/micro1.js`,
      style: `http://${host}:${port.micro}/micro1.css`,
      // æŒ‚è½½åˆ° window ä¸Šçš„å¯åŠ¨å‡½æ•° window.micro1_mount
      mount: "micro1_mount",
      // æŒ‚è½½åˆ° window ä¸Šçš„å¯åŠ¨å‡½æ•° window.micro1_unmount
      unmount: "micro1_unmount",
      prefetch: true,
    },
    {
      name: "micro2",
      id: "micro2",
      script: `http://${host}:${port.micro}/micro2.js`,
      style: `http://${host}:${port.micro}/micro2.css`,
      mount: "micro2_mount",
      unmount: "micro2_unmount",
      prefetch: true,
    },
  ]);
});
```

### å­åº”ç”¨è®¾ç½®

æˆ‘ä»¬åˆ†åˆ«åœ¨ä¸¤ä¸ªå­åº”ç”¨ä¸­å„è‡ªé…ç½®è‡ªå·±çš„æ‰§è¡Œä»£ç ï¼Œä»»åŠ¡è®¾ç½®å…¨å±€çš„å˜é‡æ¥éªŒè¯æ²™ç®±çš„éš”ç¦»æ•ˆæœï¼š

```js
// micro1.js
let root = document.createElement("h1");
root.textContent = "å¾®åº”ç”¨1";
root.id = 'micro1-dom';
root.onclick = () => {
  console.log("å¾®åº”ç”¨1 çš„ window.a: ", window.a);
};
document.body.appendChild(root);

window.a = 1;

// micro2.js
let root = document.createElement("h1");
root.textContent = "å¾®åº”ç”¨2";
root.id = 'micro2-dom';
root.onclick = () => {
  console.log("å¾®åº”ç”¨2 çš„ window.a: ", window.a);
};
document.body.appendChild(root);

window.a = 2;
```

## 3. ä¸»åº”ç”¨æ¸²æŸ“

æˆ‘ä»¬é…ç½®ä¸»åº”ç”¨çš„å…¥å£ï¼Œå¹¶è®¾ç½®ç”¨äºéªŒè¯çš„åŒåå…¨å±€å˜é‡ï¼š

```html
<!-- ä¸»åº”ç”¨å¯¼èˆª -->
<div id="nav"></div>

<!-- ä¸»åº”ç”¨å†…å®¹åŒº -->
<div id="container"></div>

<script>
  window.a = 3;
</script>
```

æ¥ç€åœ¨ä¸»åº”ç”¨å¯åŠ¨çš„è„šæœ¬å†™å…¥æ²™ç®±é…ç½®ã€‚

## 4. å®ç°æ²™ç®±

æ²™ç®±çš„å®ç°æ­¥éª¤å¯ä»¥å‚è§ iframe æ²™ç®±çš„æµç¨‹ï¼Œå”¯ä¸€ä¸åŒçš„æ˜¯ Sandbox ç±»çš„å®ç°ã€‚

æˆ‘ä»¬å®ç°æ²™ç®±ç±»æ„é€ å‡½æ•°ï¼š

```js
// ç±»ä¸»è¦æˆå‘˜å˜é‡
// å¾®åº”ç”¨ JS è¿è¡Œä¹‹å‰çš„ä¸»åº”ç”¨ window å¿«ç…§
mainWindow = {};
// å¾®åº”ç”¨ JS è¿è¡Œä¹‹åçš„ window å¯¹è±¡ï¼ˆç”¨äºç†è§£ï¼‰
microWindow = {};
// å¾®åº”ç”¨å¤±æ´»åå’Œä¸»åº”ç”¨çš„ window å¿«ç…§å­˜åœ¨å·®å¼‚çš„å±æ€§é›†åˆ
diffPropsMap = {};

constructor(options) {
  this.options = options;
  // é‡æ–°åŒ…è£…éœ€è¦æ‰§è¡Œçš„å¾®åº”ç”¨ JS è„šæœ¬
  this.wrapScript = this.createWrapScript();
}

createWrapScript() {
  // å¾®åº”ç”¨çš„ä»£ç è¿è¡Œåœ¨ç«‹å³æ‰§è¡Œçš„åŒ¿åå‡½æ•°ä¸­ï¼Œéš”ç¦»ä½œç”¨åŸŸ
  return `;(function(window){
    ${this.options.scriptText}
  })(window)`;
}
```

åŒæ ·æ˜¯é—­åŒ…æ‰§è¡Œè„šæœ¬ï¼Œä¸åŒçš„æ˜¯ä¸å†ä½¿ç”¨ window çš„ä»£ç†äº†ï¼Œè¿™é‡Œçš„ window æ˜¯ä¸»åº”ç”¨ window çš„å¿«ç…§ï¼Œä¸‹é¢ä¼šä»‹ç»å®ç°ã€‚

#### æ¿€æ´»

æ²™ç®±åˆ›å»ºå®Œæˆåï¼Œå°±æ˜¯æ¿€æ´»å’Œå¸è½½åŠŸèƒ½äº†ï¼Œå…ˆçœ‹æ¿€æ´»ï¼š

```js
active() {
  // è®°å½•å¾®åº”ç”¨ JS è¿è¡Œä¹‹å‰çš„ä¸»åº”ç”¨ window å¿«ç…§
  this.recordMainWindow();
  // æ¢å¤å¾®åº”ç”¨éœ€è¦çš„ window å¯¹è±¡
  this.recoverMicroWindow();
  if (this.exec) {
    return;
  }
  this.exec = true;
  // æ‰§è¡Œå¾®åº”ç”¨ï¼ˆæ³¨æ„å¾®åº”ç”¨çš„ JS ä»£ç åªéœ€è¦è¢«æ‰§è¡Œä¸€æ¬¡ï¼‰
  this.execWrapScript();
}
```

å…¶ä¸­ recordMainWindow ç”¨äºè®°å½•æŒ‚è½½ä¹‹å‰ä¸»åº”ç”¨çš„ window çŠ¶æ€ï¼š

```js
recordMainWindow() {
  for (const prop in window) {
    if (window.hasOwnProperty(prop)) {
      this.mainWindow[prop] = window[prop];
    }
  }
}
```

recoverMicroWindow æ˜¯æ¢å¤ä¸Šä¸€æ¬¡æŒ‚è½½å­åº”ç”¨æ—¶çš„ window çŠ¶æ€ï¼š

```js
recoverMicroWindow() {
  // å¦‚æœå¾®åº”ç”¨å’Œä¸»åº”ç”¨çš„ window å¯¹è±¡å­˜åœ¨å±æ€§å·®å¼‚
  // ä¸Šä¸€æ¬¡å¾®åº”ç”¨ window = ä¸»åº”ç”¨ window + å·®å¼‚å±æ€§ï¼ˆåœ¨å¾®åº”ç”¨å¤±æ´»å‰ä¼šè®°å½•è¿è¡Œè¿‡ç¨‹ä¸­æ¶‰åŠåˆ°æ›´æ”¹çš„ window å±æ€§å€¼ï¼Œå†æ¬¡è¿è¡Œä¹‹å‰éœ€è¦æ¢å¤ä¿®æ”¹çš„å±æ€§å€¼ï¼‰
  Object.keys(this.diffPropsMap).forEach((p) => {
    // æ›´æ”¹ JS è¿è¡Œä¹‹å‰çš„å¾®åº”ç”¨ window å¯¹è±¡ï¼Œæ³¨æ„å¾®åº”ç”¨æœ¬è´¨ä¸Šå…±äº«äº†ä¸»åº”ç”¨çš„ window å¯¹è±¡ï¼Œå› æ­¤ä¸€ä¸ªæ—¶åˆ»åªèƒ½è¿è¡Œä¸€ä¸ªå¾®åº”ç”¨
    window[p] = this.diffPropsMap[p];
  });

  this.microWindow = window;
}
```

ç„¶åå°±æ˜¯æ‰§è¡Œ è„šæœ¬ äº†ï¼š

```js
execWrapScript() {
  // åœ¨å…¨å±€ä½œç”¨åŸŸå†…æ‰§è¡Œå¾®åº”ç”¨ä»£ç 
  (0, eval)(this.wrapScript);
}
```

(0, eval) æ˜¯ä¸€ä¸ªé€—å·è¡¨è¾¾å¼ï¼Œå…¶è¿”å›æœ€å³è¾¹çš„å€¼ï¼Œç­‰ä»·äº evalï¼Œä¹‹æ‰€ä»¥è¿™ä¹ˆå†™ï¼Œæ˜¯å› ä¸ºé€—å·è¡¨è¾¾å¼ä¹‹åè¿”å›çš„æ˜¯ä¸€ä¸ªå¯¹ eval çš„é—´æ¥è°ƒç”¨ï¼Œè€Œé—´æ¥è°ƒç”¨è®¡ç®—å‡ºæ¥çš„æ˜¯ä¸€ä¸ªå€¼ï¼Œè€Œä¸æ˜¯å¼•ç”¨ï¼Œç›¸å½“äºæŠŠè¿™ä¸ªå‡½æ•°å•ç‹¬å£°æ˜å‡ºæ¥å†æ‰§è¡Œã€‚

ä¸Šé¢çš„ä»£ç  (0, eval)(this.wrapScript)ï¼Œç›¸å½“äºæ”¹å˜äº† eval æ‰§è¡Œå¯¹è±¡ä¸º wrapScriptï¼Œæ”¹å˜äº†å†…éƒ¨æ‰§è¡Œçš„ this æŒ‡é’ˆã€‚

#### å¤±æ•ˆ

æˆ‘ä»¬å†æ¥çœ‹çœ‹è§£é™¤æ¿€æ´»çŠ¶æ€çš„å®ç°ã€‚

```js
inactive() {
  // æ¸…ç©ºä¸Šä¸€æ¬¡è®°å½•çš„å±æ€§å·®å¼‚
  this.diffPropsMap = {};
  // è®°å½•å¾®åº”ç”¨è¿è¡Œåå’Œä¸»åº”ç”¨ Window å¿«ç…§å­˜åœ¨çš„å·®å¼‚å±æ€§
  this.recordDiffPropsMap();
  console.log(
    `${this.options.appId} diffPropsMap: `,
    this.diffPropsMap
  );
}
```

å…¶ä¸­ recordDiffPropsMapï¼š

```js
recordDiffPropsMap() {
  // è¿™é‡Œçš„ microWindow æ˜¯å¾®åº”ç”¨å¤±æ´»ä¹‹å‰çš„ windowï¼ˆåœ¨å¾®åº”ç”¨æ‰§è¡ŒæœŸé—´ä¿®æ”¹è¿‡ window å±æ€§çš„ windowï¼‰
  for (const prop in this.microWindow) {
    // å¦‚æœå¾®åº”ç”¨è¿è¡ŒæœŸé—´å­˜åœ¨å’Œä¸»åº”ç”¨å¿«ç…§ä¸ä¸€æ ·çš„å±æ€§å€¼
    if (
      window.hasOwnProperty(prop) &&
      this.microWindow[prop] !== this.mainWindow[prop]
    ) {
      // è®°å½•å¾®åº”ç”¨è¿è¡ŒæœŸé—´ä¿®æ”¹æˆ–è€…æ–°å¢çš„å·®å¼‚å±æ€§ï¼ˆä¸‹ä¸€æ¬¡è¿è¡Œå¾®åº”ç”¨ä¹‹å‰å¯ç”¨äºæ¢å¤å¾®åº”ç”¨è¿™ä¸€æ¬¡è¿è¡Œçš„ window å±æ€§ï¼‰
      this.diffPropsMap[prop] = this.microWindow[prop];
      // æ¢å¤ä¸»åº”ç”¨çš„ window å±æ€§å€¼
      window[prop] = this.mainWindow[prop];
    }
  }
}
```

å¤§è‡´æµç¨‹å°±æ˜¯è®°å½•ä¸€ä¸‹ä¸åŸæ¥ window çš„å·®å¼‚ï¼Œç„¶åæ¢å¤åŸæ¥è®°å½•çš„ä¸»åº”ç”¨çš„ windowã€‚

æˆ‘ä»¬å°†ä¸Šé¢çš„è®¾è®¡æ€è·¯æ€»ç»“å¦‚ä¸‹ï¼š

![image.png](/img/posts/2024-1-11/2024-1-11-2.png)

å…¶ä½™ç±»çš„å®ç°ä¸ iframe éš”ç¦»ä¸€è‡´ï¼Œå¯ä»¥å‚è§ï¼š[iframe sandbox](/posts/monto-app-sandbox-webcomponents-iframe)

## 5. å°ç»“

æœ¬éš”ç¦»æ–¹å¼å®é™…æ˜¯åŠ¨æ€ script çš„å˜ç§ï¼Œæ²¡æœ‰åˆ›å»º script æ ‡ç­¾ï¼Œè€Œæ˜¯ç›´æ¥åœ¨ window å¿«ç…§ä¸­æ‰§è¡Œå¾®åº”ç”¨çš„ jsï¼Œç¼ºç‚¹å¾ˆæ˜æ˜¾ï¼š

- ä¸èƒ½åŒæ—¶åŠ è½½å¤šä¸ªå­åº”ç”¨
- æ— æ³•å¤„ç†ä¸»å­åº”ç”¨åŒæ—¶æ“ä½œ window äº§ç”Ÿå†²çªçš„é—®é¢˜4c:T386d,æœ¬èŠ‚å¼€å§‹ï¼Œä»‹ç»å¾®å‰ç«¯ä¸­ js éš”ç¦»çš„æ–¹æ¡ˆã€‚

## 1. iframeæ²™ç®±åŸç†

iframe ä¹‹æ‰€ä»¥æ”¯æŒ js éš”ç¦»ï¼Œæ˜¯å› ä¸ºåœ¨ V8 å¼•æ“é‡Œï¼Œæ¯ä¸€ä¸ª iframe éƒ½ç›¸å½“äºå¼€äº†ä¸€ä¸ªæ–°çš„ Isolate å¯¹è±¡ï¼Œæ‰€ä»¥å°±ç›¸å½“äºé—´æ¥ä½¿ç”¨äº† V8 éš”ç¦»ï¼Œä»–ä»¬æ˜¯ä¸åŒçš„ V8 ä¸Šä¸‹æ–‡ã€‚

æœ¬æ–‡ç»“åˆä¹‹å‰çš„ Web Components åŠ è½½æ–¹æ¡ˆå’Œ iframe å¤©ç„¶æ²™ç®±ï¼Œæ¥å®ç°ä¸€ä¸ªéš”ç¦»çš„æ–¹æ¡ˆã€‚ä½¿ç”¨ iframe çš„æœ€ä¸»è¦çš„é—®é¢˜å¦‚ä¸‹ï¼š

- ä¸»å­è·¯ç”±ä¸ç»Ÿä¸€
- å¼¹å‡ºå±‚ä¸ä¼šè‡ªåŠ¨å±…ä¸­
- æ•°æ®çŠ¶æ€åŒæ­¥é—®é¢˜

æˆ‘ä»¬è¿™é‡Œå…ˆè§£å†³ç¬¬ä¸€ä¸ªé—®é¢˜ï¼Œå°†ä¸»åº”ç”¨çš„ history å¯¹è±¡ä»£ç†ä¸€ä¸‹ä¼ é€’ç»™å­åº”ç”¨ï¼š

![image.png](/img/posts/2024-1-10/2024-1-10-1.png)

[ä»“åº“åœ°å€ï¼šsandbox/web-components-proxy åˆ†æ”¯](https://github.com/heiheihoho1213/monto-app/tree/sandbox/web-components-proxy)

æˆ‘ä»¬å®ç°çš„æ­¥éª¤å¦‚ä¸‹ï¼š

1. æ”¹é€ å­åº”ç”¨å…¥å£ï¼Œå£°æ˜è‡ªå·±çš„å®šåˆ¶å…ƒç´ ä¿¡æ¯
2. ä¸»åº”ç”¨å¯åŠ¨æ—¶ï¼Œè·å–å­åº”ç”¨ä¿¡æ¯
3. åˆ›å»º iframe å…ƒç´ 
4. iframeä¸­å­åº”ç”¨æŒ‚è½½æ—¶ï¼Œå°†ä¸»åº”ç”¨çš„ window ä»£ç†åä¼ é€’ç»™å­åº”ç”¨
5. å­åº”ç”¨å¼€å§‹æ¸²æŸ“ï¼Œæ‰§è¡Œè‡ªå·±çš„ jsï¼Œå¹¶æŒ‚è½½è‡ªå·±çš„å®šåˆ¶åŒ–å…ƒç´ 
6. å­åº”ç”¨å¸è½½æ—¶ï¼Œè®¾ç½® display ä¸º none å³å¯ï¼Œjs ä¸ç”¨åˆ é™¤

#### æ”¹é€ å­åº”ç”¨

```js
// æµ‹è¯•ä»£ç ï¼šå…¨å±€å˜é‡çš„æ±¡æŸ“æƒ…å†µ
this.a = 'a';
console.log('å¾®åº”ç”¨1 a: ', a);

var b = 'b';
console.log('å¾®åº”ç”¨1 b: ', window.b);

window.c = 'c';
console.log('å¾®åº”ç”¨1 c: ', window.c);

let root = document.createElement("button");
root.textContent = "å¾®åº”ç”¨ 1 æ›´æ”¹ history ä¸º micro1";
document.body.appendChild(root);

root.onclick = () => {
  // è¿™é‡Œæ¥è¯´æ˜ history ç”¨çš„æ˜¯ä¸»åº”ç”¨æ¥çš„ä»£ç†
  history.pushState({}, '', '/micro1');
}
// endï¼šæµ‹è¯•ä»£ç 

class MicroApp1Element extends HTMLElement {
  constructor() {
    super();
  }

  connectedCallback() {
    console.log(`[micro-app-1]ï¼šæ‰§è¡Œ connectedCallback ç”Ÿå‘½å‘¨æœŸå›è°ƒå‡½æ•°`);
    this.mount();
  }

  disconnectedCallback() {
    console.log(`[micro-app-1]ï¼šæ‰§è¡Œ disconnectedCallback ç”Ÿå‘½å‘¨æœŸå›è°ƒå‡½æ•°`);
    // å¸è½½å¤„ç†
    this.unmount();
  }

  // [ç”Ÿå‘½å‘¨æœŸå›è°ƒå‡½æ•°] å½“ custom element å¢åŠ . åˆ é™¤. ä¿®æ”¹è‡ªèº«å±æ€§æ—¶ï¼Œè¢«è°ƒç”¨
  attributeChangedCallback(attr, oldVal, newVal) {
    console.log(
      `[app:${this.name}]ï¼šæ‰§è¡Œ attributeChangedCallback ç”Ÿå‘½å‘¨æœŸå›è°ƒå‡½æ•°`
    );
    if (this[attr] !== newVal) {
      this[attr] = newVal;
      this.isConnected && this.mount();
    }
  }

  mount() {
    const $micro = document.createElement("h1");
    $micro.textContent = "å¾®åº”ç”¨1";
    // å°†å¾®åº”ç”¨çš„å†…å®¹æŒ‚è½½åˆ°å½“å‰è‡ªå®šä¹‰å…ƒç´ ä¸‹
    this.appendChild($micro);
  }

  unmount() {}
}

window.customElements.define("micro-app-1", MicroApp1Element);
```

åœ¨å­åº”ç”¨é‡Œå®šä¹‰äº† Web Components çš„å…ƒç´ å£°æ˜ï¼Œå…¶æ“ä½œçš„ document ç­‰å¯¹è±¡ï¼Œéƒ½æ˜¯ç›¸å¯¹äºè‡ªå·±çš„ iframe å†…éƒ¨è€Œè¨€çš„ã€‚

#### ä¸»åº”ç”¨é…ç½®å­åº”ç”¨åˆ—è¡¨ä¿¡æ¯

é¦–å…ˆå¯åŠ¨æœåŠ¡å™¨ï¼š

```html
<!-- ä¸»åº”ç”¨å¯¼èˆª -->
<div id="nav"></div>

<!-- ä¸»åº”ç”¨å†…å®¹åŒº -->
<div id="container"></div>
```

```js
app.use(express.static(path.join("public", "main")));
// ...
app.listen(port.main, host);
```

é…ç½®è¯·æ±‚æ¥å£ï¼ˆå­åº”ç”¨å„è‡ªçš„nodeæœåŠ¡éœ€è¦é…ç½®è·¨åŸŸï¼Œè¿™é‡Œç•¥å»ï¼‰ï¼š

```js
app.post("/microapps", function (req, res) {
  res.json([
    {
      name: "micro1",
      id: "micro1",
      // è‡ªå®šä¹‰å…ƒç´ åç§°
      customElement: "micro-app-1",
      // è¿™é‡Œæš‚æ—¶ä»¥ä¸€ä¸ªå…¥å£æ–‡ä»¶ä¸ºç¤ºä¾‹
      script: `http://${host}:${port.micro}/micro1.js`,
      style: `http://${host}:${port.micro}/micro1.css`,
      prefetch: true,
    },
    {
      name: "micro2",
      id: "micro2",
      customElement: "micro-app-2",
      script: `http://${host}:${port.micro}/micro2.js`,
      style: `http://${host}:${port.micro}/micro2.css`,
      prefetch: true,
    },
  ]);
});
```

#### åˆ›å»º iframe

æˆ‘ä»¬å£°æ˜ä¸€ä¸ª IframeSandbox ç±»:

```js
// IframeSandbox
constructor(options) {
  this.options = options;
  // åˆ›å»º iframe æ—¶æµè§ˆå™¨ä¼šåˆ›å»ºæ–°çš„å…¨å±€æ‰§è¡Œä¸Šä¸‹æ–‡ï¼Œç”¨äºéš”ç¦»ä¸»åº”ç”¨çš„å…¨å±€æ‰§è¡Œä¸Šä¸‹æ–‡
  this.iframe = this.createIframe();
  this.iframeWindow = this.iframe.contentWindow;
  // æ‰§è¡Œ history ä»£ç†
  this.proxyIframeWindow();
}
```

åœ¨å­åº”ç”¨æ¿€æ´»æ—¶å¯ä»¥è¿™ä¹ˆå†™ï¼š

```js
new IframeSandbox({
  rootElm: this.rootElm,  // æŒ‚è½½åº”ç”¨çš„æ ¹èŠ‚ç‚¹ï¼Œè¿™é‡Œæ˜¯ #container
  scriptText: this.scriptText,
  url: this.app.script,
  id: this.app.id,
  customElement: this.app.customElement
});
```

åœ¨ IframeSandbox ç±»é‡Œï¼Œæˆ‘ä»¬å¼€å§‹æ„é€ ä¸€ä¸ªå±€éƒ¨çš„ js sandboxã€‚

é¦–å…ˆï¼Œä½¿ç”¨ src = about:blank çš„ iframe å¯ä»¥ä¿è¯å…¶ä¸ä¸»åº”ç”¨åŒæºï¼š

```js
// IframeSandbox
createIframe() {
  const { rootElm, id, url } = this.options;
  const iframe = window.document.createElement("iframe");
  const attrs = {
    src: "about:blank",
    "app-id": id,
    "app-src": url,
    style: "border:none;width:100%;height:100%;",
  };
  Object.keys(attrs).forEach((name) => {
    iframe.setAttribute(name, attrs[name]);
  });
  rootElm?.appendChild(iframe);
  return iframe;
}
```
> app-src æ˜¯ä¸€ç§å®‰å…¨ç­–ç•¥ï¼ŒæŒ‡å®šäº†åªæœ‰å­åº”ç”¨è‡ªå·±çš„ url çš„èµ„æºå¯ä»¥è¢«åŠ è½½

#### åš history ä»£ç†

ç”±äº history æ˜¯åœ¨ window ä¸‹çš„ï¼Œdocument ä¹Ÿæ˜¯åœ¨ window ä¸‹çš„ï¼Œæˆ‘ä»¬å¹²è„†ç›´æ¥ä»£ç†ä¸»åº”ç”¨çš„ window å¯¹è±¡ï¼š

```js
// IframeSandboxï¼Œåœ¨ä¸»åº”ç”¨ä¸­æ‰§è¡Œçš„
proxyIframeWindow() {
  this.iframeWindow.proxy = new Proxy(this.iframeWindow, {
    get: (target, prop) => {
      // åªæ˜¯ç®€å•çš„ä»£ç†ï¼Œä¸»å­åº”ç”¨è·¯ç”±å†²çªæ²¡æœ‰è§£å†³
      // æ€è€ƒï¼šä¸ºäº†é˜²æ­¢ URL å†²çªé—®é¢˜ï¼Œæ˜¯å¦ä¹Ÿå¯ä»¥å½¢æˆè®¾è®¡è§„èŒƒï¼Œæ¯”å¦‚ä¸»åº”ç”¨é‡‡ç”¨ History è·¯ç”±ï¼Œå­åº”ç”¨é‡‡ç”¨ Hash è·¯ç”±ï¼Œä»è€Œç¡®ä¿ä¸»å­åº”ç”¨çš„è·¯ç”±ä¸ä¼šäº§ç”Ÿå†²çªçš„é—®é¢˜
      if (prop === "history" || prop === "location" || prop === "document") {
        // ä½¿ç”¨ä¸»åº”ç”¨ window
        return window[prop];
      }

      if (prop === "window" || prop === "self") {
        return this.iframeWindow.proxy;
      }

      // prop æ˜¯ä¿®æ­£è¿‡çš„æŒ‡å‘
      return this.getTargetValue(target, prop);
    },

    set: (target, prop, value) => {
      target[prop] = value;
      return true;
    },

    has: (target, prop) => !!target[prop],
  });
}
```
æ­¤æ—¶ï¼ŒåŸç”Ÿçš„ä¸€äº› API ä¼šæœ‰é—®é¢˜ï¼Œæ¯”å¦‚ window.alert å†…éƒ¨çš„ this ä¸æ˜¯æŒ‡å‘ iframe çš„ windowï¼Œè€Œæ˜¯æŒ‡å‘è¢«ä»£ç†åçš„ proxyï¼Œå› æ­¤åœ¨è°ƒç”¨ alert ç­‰åŸç”Ÿå‡½æ•°ä¼šæŠ¥é”™ Illegal invocationã€‚
åŒç±»å‹çš„æ–¹æ³•è¿˜æœ‰å¾ˆå¤šï¼Œæ¯”å¦‚ addEventListener. atob ç­‰ã€‚

è¿™é‡Œçš„ getTargetValueï¼Œç”¨äºé‡æ–°å°†è¿™äº›åŸç”Ÿ native api çš„ this ä¿®æ­£ä¸º iframe çš„ windowã€‚

æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å®ç°ï¼š

```js
getTargetValue(target, prop) {
  const value = target[prop];

  // è¿‡æ»¤å‡º window.alert. window.addEventListener ç­‰ API
  if (
    typeof value === "function" &&
    !this.isBoundedFunction(value) &&  // æ˜¯ç›´æ¥å®šä¹‰çš„ functionï¼Œä¸æ˜¯ bind çš„å‡½æ•°ï¼Œå› ä¸º å¦‚æœå‡½æ•°å·²ç»è¿›è¡Œäº† bindï¼Œé‚£ä¹ˆä¸åº”è¯¥è¿›è¡Œå†æ¬¡çš„ç»‘å®šæ“ä½œ
    !this.isConstructable(value) // è¿‡æ»¤æ‰æ„é€ å‡½æ•°ï¼šä¾‹å¦‚åŸç”Ÿçš„ Object. Array ä»¥åŠç”¨æˆ·è‡ªå·±åˆ›å»ºçš„æ„é€ å‡½æ•°ç­‰ã€‚ä¸€äº›æ„é€ å‡½æ•°ä¸éœ€è¦è¿›è¡Œ bind æ“ä½œï¼Œå› ä¸º bind ç”Ÿæˆçš„å‡½æ•°ä¼šå¤±å»åŸæœ‰å‡½æ•°çš„å±æ€§å’Œ prototype
  ) {
    console.log('ä¿®æ­£ this: ', prop);

    // ä¿®æ­£ value çš„ this æŒ‡å‘ä¸º target
    const boundValue = Function.prototype.bind.call(value, target);
    // é‡æ–°æ¢å¤ value åœ¨ bound ä¹‹å‰çš„å±æ€§å’ŒåŸå‹ï¼ˆbind ä¹‹åä¼šä¸¢å¤±ï¼‰
    for (const key in value) {
      boundValue[key] = value[key];
    }
    // å¦‚æœåŸæ¥çš„å‡½æ•°å­˜åœ¨ prototype å±æ€§ï¼Œè€Œ bound ä¹‹åä¸¢å¤±äº†ï¼Œé‚£ä¹ˆé‡æ–°è®¾ç½®å›æ¥
    if (
      value.hasOwnProperty("prototype") &&
      !boundValue.hasOwnProperty("prototype")
    ) {
      boundValue.prototype = value.prototye;
    }
    return boundValue;
  }
  return value;
}
```

å…¶ä¸­ä¸¤ä¸ªåˆ¤æ–­å‡½æ•°å¦‚ä¸‹ï¼š

```js
isBoundedFunction(fn) {
  return (
    // åœ¨ES6åŠä¹‹åçš„ç‰ˆæœ¬ä¸­ï¼Œæ¯ä¸ªå‡½æ•°éƒ½æœ‰ä¸€ä¸ª name å±æ€§, å¦‚æœå‡½æ•°æ˜¯é€šè¿‡ function å…³é”®å­—å®šä¹‰çš„ï¼Œé‚£ä¹ˆå®ƒçš„ name å±æ€§å€¼å°±æ˜¯è¿™ä¸ªå‡½æ•°åã€‚ä½†å¦‚æœå‡½æ•°æ˜¯é€šè¿‡å…¶ä»–æ–¹å¼ï¼ˆä¾‹å¦‚ä½¿ç”¨ Function æ„é€ å‡½æ•°æˆ– Function.prototype.bind æ–¹æ³•ï¼‰åˆ›å»ºçš„ï¼Œé‚£ä¹ˆå®ƒçš„ name å±æ€§å€¼å¯èƒ½ä¼šè¢«ä¿®æ”¹æˆ–æ·»åŠ å‰ç¼€ (æ¯”å¦‚ bound)
    // ä¾‹å­ï¼š
    /**
      let obj = {  
        x: 10,  
        getX: function() {  
          return this.x;  
        }  
      };
        
      let getXBoundToObj = obj.getX.bind(obj);  
      console.log(getXBoundToObj.name); // è¾“å‡º bound getX
    */
    
    // è¢«ç»‘å®šçš„å‡½æ•°æœ¬èº«æ²¡æœ‰ prototype
    fn.name.indexOf("bound ") === 0 && !fn.hasOwnProperty("prototype")
  );
}

isConstructable(fn) {
  // å¯ä»¥è¯†åˆ« Object. Array ç­‰åŸç”Ÿæ„é€ å‡½æ•°ï¼Œä¹Ÿå¯ä»¥è¯†åˆ«ç”¨æˆ·è‡ªå·±åˆ›å»ºçš„æ„é€ å‡½æ•°
  return (
    fn.prototype &&
    // é€šå¸¸æƒ…å†µä¸‹æ„é€ å‡½æ•°å’Œç±»çš„ prototype.constructor æŒ‡å‘æœ¬èº«
    fn.prototype.constructor === fn &&
    // é€šå¸¸æƒ…å†µä¸‹æ„é€ å‡½æ•°å’Œç±»éƒ½ä¼šå­˜åœ¨ prototype.constructorï¼Œå› æ­¤é•¿åº¦å¤§äºç­‰æ–¼ 1
    // éœ€è¦æ³¨æ„æ™®é€šå‡½æ•°ä¸­ä¹Ÿä¼šå­˜åœ¨ prototype.constructorï¼Œ
    // å› æ­¤å¦‚æœ prototypeä¸Š æœ‰è‡ªå®šä¹‰å±æ€§æˆ–è€…æ–¹æ³•ï¼Œé‚£ä¹ˆå¯ä»¥åˆ¤å®šä¸ºç±»æˆ–è€…æ„é€ å‡½æ•°ï¼Œå› æ­¤è¿™é‡Œçš„åˆ¤æ–­æ˜¯å¤§äº 1
    // è‡ªå»ºå‡½æ•°ï¼Œæ¯”å¦‚function Person {}; ï¼ŒåŸå‹é“¾ä¸Šæ²¡æœ‰æ–¹æ³•çš„ class è¯†åˆ«. function Person() {} è¯†åˆ«ç­‰ï¼Œå…¶é•¿åº¦ = 1
    // æ³¨æ„ä¸è¦ä½¿ç”¨ Object.keys è¿›è¡Œåˆ¤æ–­ï¼ŒObject.keys æ— æ³•è·å– Object.defineProperty å®šä¹‰çš„å±æ€§
    (Object.getOwnPropertyNames(fn.prototype).length > 1
      || (Object.getOwnPropertyNames(fn.prototype).length === 1 && Object.getOwnPropertyNames(fn.prototype)[0] === 'constructor'))
  );
  // TODO: æ²¡æœ‰ constructor çš„æ„é€ å‡½æ•°è¯†åˆ«
  // ä¾‹å¦‚ Person.prototype = {}; æ­¤æ—¶æ²¡æœ‰ prototype.constructor å±æ€§
}
```


#### æ¿€æ´»ä¸å¤±æ´»å‡½æ•°

æ¥ä¸‹æ¥åœ¨sandboxä¸­å®šä¹‰ä¸€ä¸‹æ¿€æ´»å­åº”ç”¨çš„å‡½æ•°ï¼š

```js
// IframeSandbox
async active() {
  this.iframe.style.display = "block";
  // å¦‚æœå·²ç»é€šè¿‡ Script åŠ è½½å¹¶æ‰§è¡Œè¿‡ JSï¼Œåˆ™æ— éœ€é‡æ–°åŠ è½½å¤„ç†
  if (this.execScriptFlag) return;
  this.execScript();
  this.mount();
  this.execScriptFlag = true;
}
```

å…¶ä¸­æ ¸å¿ƒçš„æ‰§è¡Œä»£ç å’ŒæŒ‚è½½å‡½æ•°å¦‚ä¸‹ï¼š

```js
execScript() {
  const scriptElement =
    this.iframeWindow.document.createElement("script");
  // ä½¿ç”¨åŒ¿åæ‰§è¡Œæ˜¯ä¸ºäº†ä¿è¯jsä½œç”¨åŸŸä¸ä¼šå¤–æ³„ï¼Œå¹¶ä¸”ä¾¿äºä½¿ç”¨ä»£ç†
  scriptElement.textContent = `
      (function(window) {
        with(window) {
          ${this.options.scriptText}
        }
      }).bind(window.proxy)(window.proxy);
      `;
  this.iframeWindow.document.head.appendChild(scriptElement);
}

mount() {
  if (!this.$webcomponent) {
    const $slot = this.iframeWindow.document.body;
    // åˆ›å»ºç»„ä»¶å…ƒç´ 
    this.$webcomponent = this.iframeWindow.document.createElement(
      this.options.customElement
    );
    this.$webcomponent.setAttribute("micro-id", this.options.id);
    $slot.appendChild(this.$webcomponent);
  }
}
```
ä¸Šé¢çš„å‡½æ•°ä¸­ï¼Œwith è¯­å¥ç”¨äºå°†å½¢å‚windowçš„æ‰€æœ‰å±æ€§å’Œæ–¹æ³•æ·»åŠ åˆ°è‡ªå·±çš„ä½œç”¨åŸŸä¸­ï¼Œå…¶è®¾è®¡çš„æœ¬æ„ç”¨äºç¼©çŸ­æŸ¥æ‰¾ä½œç”¨åŸŸé“¾ã€‚

å¤±æ´»æ¯”è¾ƒç®€å•ï¼š

```js
inactive() {
  this.iframe.style.display = "none";
}
```

æ­¤å¤–è¿˜æœ‰æ²™ç®±æœ¬èº«çš„é”€æ¯å‡½æ•°ï¼Œè¿™é‡Œä¹Ÿæä¸€ä¸‹ï¼š

```js
// IframeSandbox é”€æ¯æ²™ç®±
destroy() {
  this.options = null;
  this.exec = false;
  if (this.iframe) {
    this.iframe.parentNode?.removeChild(this.iframe);
  }
  this.iframe = null;
}
```

åˆ°è¿™é‡Œï¼Œæ²™ç®±çš„è®¾è®¡åŸºæœ¬å®Œæˆï¼

æ¥ä¸‹æ¥æˆ‘ä»¬æŒ‰ç…§åŠ è½½é¡ºåºï¼Œé¦–å…ˆåˆå§‹åŒ–ä¸»åº”ç”¨ï¼Œè·å–å¾®åº”ç”¨åˆ—è¡¨ï¼š

```js
async init() {
  this.microApps = await this.fetchMicroApps();
  this.createNav();
  this.navClickListener();
  this.hashChangeListener();
  // åˆ›å»ºå¾®å‰ç«¯ç®¡ç†å®ä¾‹
  this.microManager = new MicroManager(
    document.getElementById("container"),
    this.microApps
  );
}

// ä»ä¸»åº”ç”¨æœåŠ¡å™¨è·è¯·æ±‚å¾®åº”ç”¨åˆ—è¡¨ä¿¡æ¯
async fetchMicroApps() {
  try {
    const res = await window.fetch("/microapps", {
      method: "post",
    });
    return await res.json();
  } catch (err) {
    console.error(err);
  }
}

...
// åˆ›å»º nav å¯¼èˆªçš„ä»£ç ä¸æ˜¯æ ¸å¿ƒï¼Œç•¥å»
// hash è·¯ç”±å˜åŒ–çš„ç›‘å¬äº‹ä»¶
hashChangeListener() {
  // ç›‘å¬ Hash è·¯ç”±çš„å˜åŒ–ï¼Œåˆ‡æ¢å¾®åº”ç”¨ï¼ˆè¿™é‡Œè®¾å®šä¸€ä¸ªæ—¶åˆ»åªèƒ½åˆ‡æ¢ä¸€ä¸ªå¾®åº”ç”¨ï¼‰
  window.addEventListener("hashchange", () => {
    this.microApps?.forEach(async ({ id }) => {
      id === window.location.hash.replace("#", "")
        ? this.microManager.activeApp(id)
        : this.microManager.inactiveApp(id);
    });
  });
}
```

ä¸Šé¢ä»£ç æåˆ°ä¸€ä¸ª MicroManager ç±»ï¼Œç”¨äºç®¡ç†å¾®å‰ç«¯åº”ç”¨çš„æ¿€æ´»å’Œé”€æ¯ï¼š

```js
appsMap = new Map();

// æ”¾å…¥å…¨éƒ¨çš„å¾®åº”ç”¨åˆ°ä¸€ä¸ªmap
setAppMaps(apps) {
  apps.forEach((app) => {
    this.appsMap.set(app.id, new MicroAppManager(this.rootElm, app));
  });
}

// æ¿€æ´»å¾®åº”ç”¨
activeApp(id) {
  const current = this.appsMap.get(id);
  current && current.active();
}

// å¤±æ´»å¾®åº”ç”¨
inactiveApp(id) {
  const current = this.appsMap.get(id);
  current && current.inactive();
}
```

ä¸ºäº†ä¾¿äºç†è§£ï¼Œä¸Šé¢åˆå•ç‹¬å°è£…äº†ä¸€ä¸ª MicroAppManager ç±»ï¼Œç”¨äºç›´æ¥æ“ä½œæ²™ç®±ï¼š

```js
// è·å– JS æ–‡æœ¬ï¼ˆå¾®åº”ç”¨æœåŠ¡éœ€è¦æ”¯æŒè·¨åŸŸè¯·æ±‚ï¼‰
async fetchScript(src) {
  try {
    const res = await window.fetch(src);
    return await res.text();
  } catch (err) {
    console.error(err);
  }
}

// æ¿€æ´»
async active() {
  // ç¼“å­˜èµ„æºå¤„ç†
  if (!this.scriptText) {
    this.scriptText = await this.fetchScript(this.app.script);
  }

  // å¦‚æœæ²¡æœ‰åˆ›å»ºæ²™ç®±ï¼Œåˆ™å®æ—¶åˆ›å»º
  // éœ€è¦æ³¨æ„åªç»™æ¿€æ´»çš„å¾®åº”ç”¨åˆ›å»º iframe æ²™ç®±ï¼Œå› ä¸ºåˆ›å»º iframe ä¼šäº§ç”Ÿå†…å­˜æŸè€—
  if (!this.sandbox) {
    this.sandbox = new IframeSandbox({
      rootElm: this.rootElm,
      scriptText: this.scriptText,
      url: this.app.script,
      id: this.app.id,
      customElement: this.app.customElement
    });
  }

  this.sandbox.active();
}

// å¤±æ´»
inactive() {
  this.sandbox?.inactive();
}
```

## 2. demo æµ‹è¯•

![image.png](/img/posts/2024-1-10/2024-1-10-2.png)

## 3. å®æˆ˜æµ‹è¯•

#### é€‚é… Vue4d:T1dba,æœ¬èŠ‚ç»§ç»­ä»‹ç»å¾®å‰ç«¯çš„å¦ä¸€ç§æ–¹æ¡ˆï¼šåŠ¨æ€ scriptã€‚é¡¾åæ€ä¹‰ï¼Œå°±æ˜¯å°†å½“å‰çš„å¾®åº”ç”¨æ‰“åŒ…åï¼Œå°†å…¥å£çš„ js æ–‡ä»¶é€šè¿‡ script åŠ è½½è¿›ä¸»åº”ç”¨ï¼Œä»è€Œè¾¾åˆ°å¾®å‰ç«¯çš„æ•ˆæœã€‚ä»–å¯èƒ½æ˜¯ç›®å‰å®ç°èµ·æ¥æœ€ç®€å•çš„ä¸€ç§æ–¹æ¡ˆã€‚

![image.png](/img/posts/2024-1-8/2024-1-8-3.png)

[ä»“åº“åœ°å€ï¼štutorial/dynamic-script åˆ†æ”¯](https://github.com/heiheihoho1213/monto-app/tree/tutorial/dynamic-script)

## 1. ä¸»åº”ç”¨

æˆ‘ä»¬ç”¨ node å¯åŠ¨ä¸€ä¸ªä¸»åº”ç”¨:

```js
app.listen(port.main, host);
```

å¹¶åœ¨ä¸»åº”ç”¨é‡Œå†™å…¥æ¥å£è¯·æ±‚ï¼š

```js
app.post("/microapps", function (req, res) {
  // è¿™é‡Œå¯ä»¥æ˜¯ç®¡ç†åå°æ–°å¢èœå•åå­˜å‚¨åˆ°æ•°æ®åº“çš„æ•°æ®
  // ä»è€Œå¯ä»¥é€šè¿‡ç®¡ç†åå°åŠ¨æ€é…ç½®å¾®åº”ç”¨çš„èœå•
  res.json([
    {
      name: "micro1",
      id: "micro1",
      // è¿™é‡Œæš‚æ—¶ä»¥ä¸€ä¸ªå…¥å£æ–‡ä»¶ä¸ºç¤ºä¾‹
      script: `http://${host}:${port.micro}/micro1.js`,
      style: `http://${host}:${port.micro}/micro1.css`,
      // æŒ‚è½½åˆ° window ä¸Šçš„å¯åŠ¨å‡½æ•° window.micro1_mount
      mount: "micro1_mount",
      // æŒ‚è½½åˆ° window ä¸Šçš„å¯åŠ¨å‡½æ•° window.micro1_unmount
      unmount: "micro1_unmount",
      prefetch: true,
    },
    {
      name: "micro2",
      id: "micro2",
      script: `http://${host}:${port.micro}/micro2.js`,
      style: `http://${host}:${port.micro}/micro2.css`,
      mount: "micro2_mount",
      unmount: "micro2_unmount",
      prefetch: true,
    },
  ]);
});
```

ä¸Šé¢é…ç½®çš„è¿™ä¸¤ä¸ªå­åº”ç”¨ï¼Œè‡ªå·±å„è‡ªå•ç‹¬åœ¨è‡ªå·±ç«¯å£å¯åŠ¨å³å¯ã€‚ï¼ˆè¿™é‡Œå…¬ç”¨äº†ä¸€ä¸ªå­åº”ç”¨ç«¯å£ï¼Œå®é™…æƒ…å†µå¯èƒ½å­åº”ç”¨ç«¯å£ä¸ä¸€æ ·ï¼‰


ç„¶åé…ç½®ä¸»åº”ç”¨çš„ htmlï¼Œå¹¶é…ç½®åŠ è½½åŠŸèƒ½ï¼š

```html
<div class="container">
  <!-- å¾®åº”ç”¨æ¸²æŸ“çš„æ’æ§½ -->
  <div id="micro-app-slot"></div>
</div>
```

```js
loadScript({ script, id }) {
  return new Promise((resolve, reject) => {
    const $script = document.createElement("script");
    $script.src = script;
    $script.setAttribute("micro-script", id);
    $script.onload = resolve;
    $script.onerror = reject;
    document.body.appendChild($script);
  });
}

loadStyle({ style, id }) {
  return new Promise((resolve, reject) => {
    const $style = document.createElement("link");
    $style.href = style;
    $style.setAttribute("micro-style", id);
    $style.rel = "stylesheet";
    $style.onload = resolve;
    $style.onerror = reject;
    document.head.appendChild($style);
  });
}

removeStyle({ id }) {
  const $style = document.querySelector(`[micro-style=${id}]`);
  $style && $style?.parentNode?.removeChild($style);
}

hasLoadScript({ id }) {
  const $script = document.querySelector(`[micro-script=${id}]`);
  return !!$script;
}

hasLoadStyle({ id }) {
  const $style = document.querySelector(`[micro-style=${id}]`);
  return !!$style;
}
```

ä¸»åº”ç”¨åˆå§‹åŒ–ï¼š

```js
init() {
  this.processMicroApps();
  this.navClickListener();
  this.hashChangeListener();
}

processMicroApps() {
  this.getMicroApps().then((res) => {
    this.microApps = res;
    this.prefetchMicroAppStatic();
    this.createMicroAppNav();
  });
}

prefetchMicroAppStatic() {
  const prefetchMicroApps = this.microApps?.filter(
    (microapp) => microapp.prefetch
  );
  prefetchMicroApps?.forEach((microApp) => {
    microApp.script && this.prefetchStatic(microApp.script, "script");
    microApp.style && this.prefetchStatic(microApp.style, "style");
  });
}

createMicroAppNav(microApps) {
  const fragment = new DocumentFragment();
  this.microApps?.forEach((microApp) => {
    // TODO: APP æ•°æ®è§„èŒƒæ£€æµ‹ (ä¾‹å¦‚æ˜¯å¦æœ‰ script. mount. unmount ç­‰ï¼‰
    const button = document.createElement("button");
    button.textContent = microApp.name;
    button.id = microApp.id;
    fragment.appendChild(button);
  });
  nav.appendChild(fragment);
}
```

å…¶ä¸­ getMicroApps æ˜¯æœåŠ¡è·å–å¾®åº”ç”¨åˆ—è¡¨ä¿¡æ¯ï¼Œä¸»åº”ç”¨å§‘ä¸”ä½¿ç”¨ hashchange é…ç½®è·¯ç”±æ£€æµ‹ï¼š

```js
hashChangeListener() {
  // ç›‘å¬ Hash è·¯ç”±çš„å˜åŒ–ï¼Œåˆ‡æ¢å¾®åº”ç”¨
  // è¿™é‡Œè®¾å®šä¸€ä¸ªæ—¶åˆ»é¡µé¢ä¸Šåªæœ‰ä¸€ä¸ªå¾®åº”ç”¨
  window.addEventListener("hashchange", () => {
    this.microApps?.forEach(async (microApp) => {
      // åŒ¹é…éœ€è¦æ¿€æ´»çš„å¾®åº”ç”¨
      if (microApp.id === window.location.hash.replace("#", "")) {
        console.time(`fetch microapp ${microApp.name} static`);
        // åŠ è½½ CSS æ ·å¼
        microApp?.style &&
          !this.hasLoadStyle(microApp) &&
          (await this.loadStyle(microApp));
        // åŠ è½½ Script æ ‡ç­¾
        microApp?.script &&
          !this.hasLoadScript(microApp) &&
          (await this.loadScript(microApp));
        console.timeEnd(`fetch microapp ${microApp.name} static`);
        window?.[microApp.mount]?.("#micro-app-slot");
        // å¦‚æœå­˜åœ¨å¸è½½ API åˆ™è¿›è¡Œåº”ç”¨å¸è½½å¤„ç†
      } else {
        this.removeStyle(microApp);
        window?.[microApp.unmount]?.();
      }
    });
  });
}
```

> è¿™é‡Œåœ¨å­åº”ç”¨å¸è½½æ—¶æ²¡æœ‰ç§»é™¤ jsï¼Œæ˜¯å› ä¸ºé‡æ–°åŠ è½½æ—¶é¡¶çº§ä½œç”¨åŸŸä¼šè¢«é‡æ–°æ‰§è¡Œï¼Œæ¯”å¦‚ let a = 1; è¿™æ ·åå¤å£°æ˜ä¼šæŠ¥é”™ã€‚
> åŒæ—¶ï¼Œä¸å†™ removeScriptï¼Œjs åœ¨ `window` ä¸ŠæŒ‚è½½äº†å­åº”ç”¨çš„ `mount` å’Œ `unmount` æ–¹æ³•ä¹Ÿä¸ä¼šé€ æˆæ±¡æŸ“ï¼Œæ²¡å¿…è¦åˆ é™¤ã€‚

## 2. å­åº”ç”¨æ”¹é€ 

å½“ç„¶ï¼Œå„ä¸ªå­åº”ç”¨å…¥å£æ–‡ä»¶è¦æ”¹é€ ï¼Œæš´éœ²é’©å­å‡½æ•°ï¼š

```js
// micro1.js
// ç«‹å³æ‰§è¡Œçš„åŒ¿åå‡½æ•°å¯ä»¥é˜²æ­¢å˜é‡ root äº§ç”Ÿå†²çª
(function () {
  let root;

  // è¦ä¿è¯å„ä¸ªå­åº”ç”¨åç§°ä¸ä¸€æ ·
  window.micro1_mount = function (slot) {
    // ä»¥ä¸‹å…¶å®å¯ä»¥æ˜¯ React æ¡†æ¶æˆ–è€… Vue æ¡†æ¶ç”Ÿæˆçš„ Document å…ƒç´ ï¼Œè¿™é‡Œåªæ˜¯åšä¸€ä¸ªç®€å•çš„ç¤ºä¾‹
    root = document.createElement("h1");
    root.textContent = "å¾®åº”ç”¨1";
    // åœ¨å¾®åº”ç”¨æ’æ§½ä¸ŠæŒ‚è½½ DOM å…ƒç´ 
    const $slot = document.querySelector(slot);
    $slot?.appendChild(root);
  };

  window.micro1_unmount = function () {
    if (!root) return;
    root.parentNode?.removeChild(root);
  };
})();


// micro1.css
h1 {
  color: green;
}
```

åŒæ—¶å­åº”ç”¨ä¹Ÿè¦å¯åŠ¨èµ·æ¥ï¼š

```js
app.listen(port.micro, host);
```
è¿™æ ·ï¼Œscript æ ‡ç­¾çš„ src æ‰èƒ½å¤Ÿå»æ‰¾åˆ°æœåŠ¡å™¨ä¸Šå­åº”ç”¨çš„ js å…¥å£æ–‡ä»¶ã€‚

> æœ¬æ–‡ç”¨äº†hashè·¯ç”±é…ç½®åˆ‡æ¢ï¼Œæœ¬èº«æœ‰è®¾è®¡ç¼ºé™·ï¼Œå®æˆ˜ä¸­éœ€è¦è‡ªå·±è®¾ç½®æ›´å®Œå–„çš„è·¯ç”±æ–¹æ¡ˆã€‚

åŸºäºä»¥ä¸Šæè¿°ï¼Œå…¶å…·æœ‰ä»¥ä¸‹ä¼˜ç‚¹ï¼š

- ä¸»åº”ç”¨å¯ä»¥åŠ¨æ€å¢å‡. æ›´æ–°å­åº”ç”¨çš„æ•°é‡ï¼Œå®ç°åŠ¨æ€éƒ¨ç½²ã€‚
- å¾®åº”ç”¨å¯ä»¥å¦‚æ­£å¸¸åº”ç”¨ä¸€æ ·è¿›è¡Œä¼˜åŒ–ï¼Œå¦‚ä»£ç åˆ†å‰²ï¼Œé™æ€èµ„æºåˆ†ç¦»ï¼ŒCDNåŠ é€Ÿç­‰ã€‚
- ä¸éœ€è¦å¦‚NPMåº“ä¸€æ ·ï¼Œé…ç½®é¢å¤–çš„é…ç½®æ–‡ä»¶ä½¿å…¶æ‰“åŒ…æˆä¾èµ–åº“ã€‚
- ä¸»å­åº”ç”¨å¤©ç„¶åŒåŸŸï¼ˆé™¤äº†åŠ è½½jsæ—¶è¦è·¨åŸŸï¼‰

å…¶é—®é¢˜ä¹Ÿæ˜¯ä¸npmæ–¹æ¡ˆä¸€æ ·ï¼š

- ä¸»åº”ç”¨ä¸å¾®åº”ç”¨çš„å…¨å±€å˜é‡. CSSæ ·å¼. æœ¬åœ°å­˜å‚¨çš„æ•°æ®æ— æ³•åšåˆ°å¾ˆå¥½çš„éš”ç¦»ã€‚
- å­åº”ç”¨éœ€è¦æ”¹é€ é€‚é…ï¼ŒåŒ NPM æ–¹æ¡ˆä¸€æ ·æ²¡åŠæ³•å®Œå…¨è§£è€¦åˆã€‚

ä¸ NPM æ–¹æ¡ˆå·®å¼‚ï¼š

- æœ¬æ–¹æ¡ˆä¸ç”¨å»é™¤ script
- æœ¬æ–¹æ¡ˆçš„ script å¯ä»¥åš chunkï¼Œè€ŒNPMæ–¹æ¡ˆåªèƒ½åšåˆ° Tree Shakingã€‚åŠ¨æ€ script åˆ†æˆäº†å¤šæ®µ chunkï¼Œä½“ç§¯æ›´å°‘äº†ï¼Œè€Œ NPM åˆ™æ˜¯å…¨é‡æ„å»ºåˆ°åŒ…é‡Œçš„ ï¼ˆä½¿ç”¨ require è‡ªåŠ¨å¼•å…¥å…¨éƒ¨åŒ…ï¼‰ï¼Œæ­¤æ—¶æ€§èƒ½ä¼˜åŒ–ä¸Šåº”è¯¥æ˜¯æœ‰å·®å¼‚çš„ã€‚

> ä½†æ˜¯æ„Ÿè§‰NPMæ–¹æ¡ˆï¼Œåªè¦æ”¾å…¥å…¥å£æ–‡ä»¶ï¼Œæ˜¯ä¸æ˜¯ä¹Ÿèƒ½åšåˆ°åˆ†chunkï¼Ÿæ¯”å¦‚è¿™ä¸ªä¸ä½¿ç”¨ require('react-micro-app')ï¼Œè€Œæ˜¯ä½¿ç”¨åŠ¨æ€å¼•å…¥ï¼š

```js
import("react-micro-app").then(chunk => {})
```

> æ‰“ chunk æ˜¯å°†æ‡’åŠ è½½. å…¬å…±ä¾èµ–åˆ†ç¦»ï¼Œæ˜¯ webpack è‡ªåŠ¨åŒ–å¤„ç†çš„è¿‡ç¨‹ã€‚äº²æµ‹ä¼šæŠ¥é”™ï¼Œç›®å‰è¿˜ä¸çŸ¥é“å¯ä¸å¯è¡Œã€‚4e:T1a00,æœ¬èŠ‚ç»§ç»­ä»‹ç»å¾®å‰ç«¯çš„å¦ä¸€ç§æ–¹æ¡ˆï¼šWeb Componentsã€‚å®ƒæ˜¯æ ¹æ®æµè§ˆå™¨åŸç”Ÿæ”¯æŒçš„ç»„ä»¶åŒ–æ–¹æ¡ˆæ¥å°è£…çš„å¾®åº”ç”¨ã€‚å…¶å®ç°æ–¹å¼ç±»ä¼¼äºåŠ¨æ€ script æ–¹æ¡ˆï¼Œ

![image.png](/img/posts/2024-1-8/2024-1-8-4.png)

[ä»“åº“åœ°å€ï¼štutorial/web-components-cookie åˆ†æ”¯](https://github.com/heiheihoho1213/monto-app/tree/tutorial/web-components-cookie)

## 1. ä¸»åº”ç”¨

è¿˜æ˜¯è€æ ·å­ï¼Œå¯åŠ¨ä¸€ä¸ªnodeæœåŠ¡ï¼š

```js
app.listen(port.main, host);
```

ç„¶åé…ç½®è¯·æ±‚å¾®æœåŠ¡åˆ—è¡¨çš„æ¥å£ï¼š

```js
app.post("/microapps", function (req, res) {

  console.log("main cookies: ", req.cookies);

  // è®¾ç½®ä¸€ä¸ªå“åº”çš„ Cookie æ•°æ®
  res.cookie("main-app", true);

  // è¿™é‡Œå¯ä»¥æ˜¯ç®¡ç†åå°æ–°å¢èœå•åå­˜å‚¨åˆ°æ•°æ®åº“çš„æ•°æ®
  // ä»è€Œå¯ä»¥é€šè¿‡ç®¡ç†åå°åŠ¨æ€é…ç½®å¾®åº”ç”¨çš„èœå•
  res.json([
    {
      name: "micro1",
      id: "micro1",
      // è‡ªå®šä¹‰å…ƒç´ åç§°
      customElement: "micro-app-1",
      // è¿™é‡Œæš‚æ—¶ä»¥ä¸€ä¸ªå…¥å£æ–‡ä»¶ä¸ºç¤ºä¾‹
      script: `http://${host}:${port.micro}/micro1.js`,
      style: `http://${host}:${port.micro}/micro1.css`,
      prefetch: true,
    },
    {
      name: "micro2",
      id: "micro2",
      customElement: "micro-app-2",
      script: `http://${host}:${port.micro}/micro2.js`,
      style: `http://${host}:${port.micro}/micro2.css`,
      prefetch: true,
    },
  ]);
});
```

ä¸»åº”ç”¨çš„ html é¡µé¢ä¸ åŠ¨æ€ script åŸºæœ¬é¡µé¢ä¸€è‡´ï¼Œè¿™é‡Œåªå±•ç¤ºä¸åŒä¹‹å¤„ï¼š

```js
hashChangeListener() {
  // Web Components æ–¹æ¡ˆ
  // å¾®åº”ç”¨çš„æ’æ§½
  const $slot = document.getElementById("micro-app-slot");

  window.addEventListener("hashchange", () => {
    this.microApps?.forEach(async (microApp) => {
      // Web Components æ–¹æ¡ˆ
      const $webcomponent = document.querySelector(
        `[micro-id=${microApp.id}]`
      );

      if (microApp.id === window.location.hash.replace("#", "")) {
        console.time(`fetch microapp ${microApp.name} static`);
        // åŠ è½½ CSS æ ·å¼
        microApp?.style &&
          !this.hasLoadStyle(microApp) &&
          (await this.loadStyle(microApp));
        // åŠ è½½ Script æ ‡ç­¾
        microApp?.script &&
          !this.hasLoadScript(microApp) &&
          (await this.loadScript(microApp));
        console.timeEnd(`fetch microapp ${microApp.name} static`);

        // åŠ¨æ€ Script æ–¹æ¡ˆ
        // window?.[microApp.mount]?.("#micro-app-slot");

        // Web Components æ–¹æ¡ˆ
        // å¦‚æœæ²¡æœ‰åœ¨ DOM ä¸­æ·»åŠ è‡ªå®šä¹‰å…ƒç´ ï¼Œåˆ™å…ˆæ·»åŠ å¤„ç†
        if (!$webcomponent) {
          // Web Components æ–¹æ¡ˆ
          // è‡ªå®šä¹‰å…ƒç´ çš„æ ‡ç­¾æ˜¯å¾®åº”ç”¨å…ˆå®šä¹‰å‡ºæ¥çš„ï¼Œç„¶ååœ¨æœåŠ¡ç«¯çš„æ¥å£é‡Œé€šè¿‡ customElement å±æ€§è¿›è¡Œçº¦å®š
          const $webcomponent = document.createElement(
            microApp.customElement
          );
          $webcomponent.setAttribute("micro-id", microApp.id);
          $slot.appendChild($webcomponent);
        // å¦‚æœå·²ç»å­˜åœ¨è‡ªå®šä¹‰å…ƒç´ ï¼Œåˆ™è¿›è¡Œæ˜¾ç¤ºå¤„ç†
        } else {
          $webcomponent.style.display = "block";
        }
      } else {
        this.removeStyle(microApp);
        // åŠ¨æ€ Script æ–¹æ¡ˆ
        // window?.[microApp.unmount]?.();

        // Web Components æ–¹æ¡ˆ
        // å¦‚æœå·²ç»æ·»åŠ äº†è‡ªå®šä¹‰å…ƒç´ ï¼Œåˆ™éšè—è‡ªå®šä¹‰å…ƒç´ 
        if ($webcomponent) {
          $webcomponent.style.display = "none";
        }
      }
    });
  });
}
```

## 2. å­åº”ç”¨æ”¹é€ 

å­åº”ç”¨ä¹Ÿå¯åŠ¨ä¸€ä¸‹ï¼š

```js
// è¿™é‡Œæå¸¦æ‰‹é…ç½®å­åº”ç”¨ ajax è¯·æ±‚çš„è·¨åŸŸ
app.use((req, res, next) => {
  // è·¨åŸŸè¯·æ±‚ä¸­æ¶‰åŠåˆ° Cookie ä¿¡æ¯ä¼ é€’ï¼Œå€¼ä¸èƒ½ä¸º *ï¼Œå¿…é¡»æ˜¯å…·ä½“çš„åœ°å€ä¿¡æ¯
  res.header("Access-Control-Allow-Origin", `http://ä½ çš„åŸŸå.com:${port.main}`);
  res.header("Access-Control-Allow-Methods", "GET, POST, OPTIONS");
  res.header("Allow", "GET, POST, OPTIONS");
  // å…è®¸è·¨åŸŸè¯·æ±‚æ—¶æºå¸¦ Cookie
  res.header("Access-Control-Allow-Credentials", true);
  next();
});

app.use(
  express.static(path.join("public", "micro"), {
    etag: true,
    lastModified: true,
  })
);

app.post("/cors", function (req, res) {
  console.log("micro cookies: ", req.cookies);

  // å¢åŠ  SameSite å’Œ Secure å±æ€§ï¼Œä»è€Œä½¿æµè§ˆå™¨æ”¯æŒ iframe å­åº”ç”¨çš„è·¨ç«™æºå¸¦ Cookie
  // æ³¨æ„ Secure éœ€è¦ HTTPS åè®®çš„æ”¯æŒ
  const cookieOptions = { sameSite: "none", secure: true };

  // è®¾ç½®ä¸€ä¸ªå“åº”çš„ Cookie æ•°æ®
  res.cookie("micro-app", true, cookieOptions);
  res.json({
    hello: "true",
  });
});

app.listen(port.micro, host);
```

å­åº”ç”¨çš„å…¥å£jsè¦æ”¹é€ ä¸€ä¸‹ï¼Œæš´éœ²å‡ºæ¥ç”Ÿå‘½å‘¨æœŸé’©å­ï¼š

```js
class MicroApp2Element extends HTMLElement {
  constructor() {
    super();
  }

  // [ç”Ÿå‘½å‘¨æœŸå›è°ƒå‡½æ•°] å½“ custom element è‡ªå®šä¹‰æ ‡ç­¾é¦–æ¬¡è¢«æ’å…¥æ–‡æ¡£ DOM æ—¶ï¼Œè¢«è°ƒç”¨
  connectedCallback() {
    console.log(`[micro-app-2]: æ‰§è¡Œ connectedCallback ç”Ÿå‘½å‘¨æœŸå›è°ƒå‡½æ•°`);
    // æŒ‚è½½åº”ç”¨
    // ç›¸å¯¹æ¯”åŠ¨æ€ Scriptï¼Œç»„ä»¶å†…éƒ¨å¯ä»¥è‡ªåŠ¨è¿›è¡Œ mount æ“ä½œï¼Œä¸éœ€è¦å¯¹å¤–æä¾›æ‰‹åŠ¨è°ƒç”¨çš„ mount å‡½æ•°ï¼Œä»è€Œé˜²æ­¢ä¸å¿…è¦çš„å…¨å±€å±æ€§å†²çª
    this.mount();
  }

  // [ç”Ÿå‘½å‘¨æœŸå›è°ƒå‡½æ•°] å½“ custom element ä»æ–‡æ¡£ DOM ä¸­åˆ é™¤æ—¶ï¼Œè¢«è°ƒç”¨
  disconnectedCallback() {
    console.log(
      `[micro-app-2]: æ‰§è¡Œ disconnectedCallback ç”Ÿå‘½å‘¨æœŸå›è°ƒå‡½æ•°`
    );
    // å¸è½½å¤„ç†
    this.unmount();
  }

  mount() {
    const $micro = document.createElement("h1");
    $micro.textContent = "å¾®åº”ç”¨2";
    // å°†å¾®åº”ç”¨çš„å†…å®¹æŒ‚è½½åˆ°å½“å‰è‡ªå®šä¹‰å…ƒç´ ä¸‹
    this.appendChild($micro);

    // æ–°å¢ Ajax è¯·æ±‚ï¼Œç”¨äºè¯·æ±‚ micro1.js æ‰€åœ¨çš„æœåŠ¡
    // éœ€è¦æ³¨æ„ micro1.js åŠ¨æ€åŠ è½½åœ¨ä¸»åº”ç”¨ localhost:4000 ä¸‹ï¼Œå› æ­¤è¯·æ±‚æ˜¯è·¨åŸŸçš„
    window
      .fetch("http://30.120.112.54:3000/cors", {
        method: "post",
        credentials: "include"
      })
      .then((res) => res.json())
      .catch((err) => {
        console.error(err);
      });
  }
}

window.customElements.define("micro-app-2", MicroApp2Element);
```

å¯¹æ¯”äºåŠ¨æ€Scriptæ–¹æ¡ˆï¼ŒWeb Componentsæ–¹æ¡ˆæœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š

- ä¸éœ€è¦å¯¹å¤–æŠ›å‡ºå…¨å±€APIï¼ˆæŒ‚è½½ä¸å¸è½½ï¼‰ï¼ŒWeb Components å¤©ç„¶æ”¯æŒï¼Œå¯å¤ç”¨æ€§æ›´å¼ºã€‚
- æ›´æ ‡å‡†åŒ–ï¼ŒWeb Componentsçš„èƒ½åŠ›åç»­ä¼šéšç€w3cæ ‡å‡†é€æ­¥æå‡ã€‚
- ä¹Ÿæ˜¯åŠ¨æ€ script çš„ä¼˜ç‚¹ï¼šå¯ä»¥éå¸¸ä¾¿æ·çš„è¿›è¡Œç§»æ¤å’Œç»„ä»¶æ›¿æ¢

å½“ç„¶ï¼ŒWeb Componentsè¿˜æ˜¯å­˜åœ¨ä¸€äº›ä¸è¶³ï¼š

- å…¼å®¹æ€§é—®é¢˜ã€‚å¯¹æ—§ç‰ˆæœ¬æµè§ˆå™¨å…¼å®¹æ€§ä¸å¥½ã€‚
- æœ‰ä¸€å®šä¸Šæ‰‹éš¾åº¦ï¼Œéœ€è¦é¢å¤–å­¦ä¹ Web Componentsç›¸å…³çŸ¥è¯†ã€‚
- å­åº”ç”¨æ˜¯ä¾µå…¥å¼çš„4f:T2106,æœ¬èŠ‚ç»§ç»­ä»‹ç»å¾®å‰ç«¯çš„å¦ä¸€ç§æ–¹æ¡ˆï¼šNPM

NPM åŒ…æ˜¯å¾®å‰ç«¯è®¾è®¡æ–¹æ¡ˆä¹‹ä¸€ï¼Œåœ¨è®¾è®¡æ—¶éœ€è¦å°†å¾®åº”ç”¨æ‰“åŒ…æˆç‹¬ç«‹çš„ NPM åŒ…ï¼Œç„¶ååœ¨ä¸»åº”ç”¨ä¸­å¼•å…¥å’Œä½¿ç”¨ã€‚

## 1. èƒŒæ™¯çŸ¥è¯†

æˆ‘ä»¬ä¸€èˆ¬è¿™æ ·åœ¨é¡¹ç›®ä¸­å¼•å…¥ jsï¼š

```html
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
  </head>
  <body>
    <script src="a.js"></script>
    <script src="b.js"></script>
    <script src="c.js"></script>
    <script src="d.js"></script>
  </body>
</html>
```

å¦‚æœæœ‰ç¬¬ä¸‰æ–¹ä¾èµ–ï¼Œé‚£ä¹ˆéœ€è¦æŒ‰ç…§é¡ºåºæ¥åŠ è½½ï¼š

```html
<body>
  <script>
    // æœªåŠ è½½ lodash æ—¶ï¼Œæ— æ³•è·å– _ å˜é‡
    // Uncaught ReferenceError: _ is not defined
    console.log(_); 
  </script>

  <script src="https://cdn.bootcdn.net/ajax/libs/lodash.js/4.17.21/lodash.min.js"></script>
  
  <script>
    // åŠ è½½ lodash ä¹‹åï¼Œå¯ä»¥è·å– _ å˜é‡
    // Æ’ Mc(n,t,r){var e=null==n?X:_e(n,t);return e===X?r:e}
    console.log(_.get); 
  </script>
</body>
```

ä½†æ˜¯è¿™æ ·åŠ è½½æœ‰ä¸ªé—®é¢˜ï¼Œä¼šé€ æˆå˜é‡æ±¡æŸ“ï¼š

```html
<body>
  <script>
    const _ = 111;
  </script>
  
  <script>
    console.log(_); // 111
  </script>
  
  <script src="https://cdn.bootcdn.net/ajax/libs/lodash.js/4.17.21/lodash.min.js"></script>
  
  <script>
    console.log(_); // 111
    console.log(_.get); // undefined
  </script>
</body>
```

## 2. NPM åŠ è½½

ä¸Šé¢çš„ä¾‹å­ï¼Œå…¨å±€åŠ è½½çš„ lodash å°±å¤±æ•ˆäº†ã€‚å¦‚æœé¡¹ç›®å¾ˆå¤æ‚ï¼Œä¸Šè¿°çš„æƒ…å†µå°±å¾ˆä¸å¥½å¤„ç†äº†ã€‚ä¸ºäº†è§£å†³ä¸Šè¿°é—®é¢˜ï¼ŒJavaScript å¼€å§‹æä¾›ä¸€ç§å°†ç¨‹åºæ‹†åˆ†ä¸ºå¯æŒ‰éœ€å¯¼å…¥çš„å•ç‹¬æ¨¡å—ï¼Œæˆ‘ä»¬å°±ä½¿ç”¨ç›®å‰é€šç”¨çš„ ESModule æ¨¡å—æ¥è¿›è¡Œæ‹†åˆ†ã€‚

[ä»“åº“åœ°å€ï¼štutorial/npm-esmodule åˆ†æ”¯](https://github.com/heiheihoho1213/monto-app/tree/tutorial/npm-esmodule)

é¡¹ç›®ç»“æ„ï¼š

```shell
â”œâ”€â”€ public                 # æ‰˜ç®¡çš„é™æ€èµ„æºç›®å½•
â”‚   â”œâ”€â”€ custom_modules/    # è‡ªå®šä¹‰æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ add.js                         
â”‚   â”‚   â””â”€â”€ conflict.js                                        
â”‚   â”œâ”€â”€ node_modules/      # ä¸‰æ–¹æ¨¡å—
â”‚   â”‚   â””â”€â”€ lodash-es/        
â”‚   â””â”€â”€ index.html         # åº”ç”¨é¡µé¢
â””â”€â”€ app.js
```

custom_modules ä¸­æˆ‘ä»¬å†™å…¥å‡ ä¸ªè‡ªå®šä¹‰çš„ä¾èµ–æ–¹æ³•ï¼š

```js
// add.js
export function add(a, b) {
  return a + b;
}

// conflict.js
const _ = 111;
console.log('conflict.js --> ', _)
```

æˆ‘ä»¬å¯åŠ¨ä¸€ä¸ªæœ¬åœ°çš„ node æœåŠ¡æ¥è®¿é—® js æ–‡ä»¶ã€‚åœ¨ index.html ä¸­å†™å…¥ï¼š

```html
<script type="importmap">
  {
    "imports": {
      "custom_modules/": "/custom_modules/",
      "lodash/": "/node_modules/lodash-es/",
      "lodash": "/node_modules/lodash-es/lodash.js"
    }
  }
</script>
```

> import-maps å­˜åœ¨æµè§ˆå™¨å…¼å®¹æ€§é—®é¢˜ï¼Œå¯ä»¥æ‰¾ç›¸åº”çš„ polyfill è¿›è¡Œå…¼å®¹æ€§å¤„ç†ã€‚

å…ˆå£°æ˜ npm åŒ…çš„æ˜ å°„å…³ç³»ã€‚

ç„¶åæŒ‰ç…§æ¨¡å—ä½ å¼•å…¥ï¼š

```html
<script type="module">
  // è‡ªå®šä¹‰æ¨¡å— - add å‡½æ•°
  import { add } from "custom_modules/add.js";
  // è‡ªå®šä¹‰æ¨¡å— - é˜²å†²æ’æµ‹è¯• (_ å˜é‡)
  import "custom_modules/conflict.js";
  // ä¸‰æ–¹æ¨¡å— - æŒ‰éœ€å¼•å…¥ lodash
  import isNull from "lodash/isNull.js";

  console.log(isNull);  // Function
  console.log(add(1, 2)); // 3

  // åœ¨ confilict.js ä¸­å£°æ˜çš„ const _ = 111; ä¸ä¼šä½œç”¨åœ¨å½“å‰è„šæœ¬ä¸­
  console.log(_);  // Uncaught ReferenceError: _ is not defined
</script>
```

æ­¤æ—¶å°±ä¸ä¼šæœ‰å…¨å±€æ±¡æŸ“äº†ï¼Œè‡ªå·±çš„å˜é‡åªåœ¨è‡ªå·±çš„npmä½œç”¨èŒƒå›´å†…ç”Ÿæ•ˆï¼Œç¬¬ä¸‰æ–¹åŒ…ä½¿ç”¨æŒ‰éœ€åŠ è½½å³å¯ã€‚æ­¤æ—¶å°±ä¸ç”¨è€ƒè™‘åŠ è½½é¡ºåºäº†ã€‚

![image.png](/img/posts/2024-1-8/2024-1-8-1.png)

ESM åŠ è½½æ–¹å¼æœ‰å¦‚ä¸‹ä¼˜ç‚¹ï¼š

- ä¸éœ€è¦æ„å»ºå·¥å…·è¿›è¡Œæ‰“åŒ…å¤„ç†ï¼›
- å¤©ç„¶æŒ‰éœ€å¼•å…¥ï¼Œå¹¶ä¸”ä¸éœ€è¦è€ƒè™‘æ¨¡å—çš„åŠ è½½é¡ºåºï¼›
- æ¨¡å—åŒ–ä½œç”¨åŸŸï¼Œä¸éœ€è¦è€ƒè™‘å˜é‡åå†²çªé—®é¢˜ã€‚

## 3. NPM å¾®æœåŠ¡æ–¹æ¡ˆ

åº”ç”¨çš„æ„å»ºéœ€è¦ç”Ÿæˆ HTML æ–‡ä»¶å¹¶æ‰“åŒ… JS. CSS ä»¥åŠå›¾ç‰‡ç­‰é™æ€èµ„æºï¼Œä¸šåŠ¡ç»„ä»¶çš„æ„å»ºæ›´å¤šçš„æ˜¯æ‰“åŒ…æˆåº”ç”¨éœ€è¦é€šè¿‡æ¨¡å—åŒ–æ–¹å¼å¼•å…¥ä½¿ç”¨çš„ JavaScript åº“ã€‚

åº”ç”¨åœ¨æ„å»ºæ—¶ä¸ºäº†æå‡æ„å»ºé€Ÿåº¦ï¼ŒåŒæ—¶ä¹Ÿä¸ºäº†ç®€åŒ–æ„å»ºé…ç½®ï¼Œé€šå¸¸åœ¨ä½¿ç”¨ babel-loader ï¼ˆè½¬è¯‘å·¥å…·ï¼‰è¿›è¡Œè½¬è¯‘æ—¶ ï¼Œ ä¼šå±è”½ node_modules ç›®å½•ä¸‹çš„ NPM åŒ…ï¼Œå› æ­¤éœ€è¦å°†å‘å¸ƒçš„ NPM ç»„ä»¶è½¬è¯‘æˆå¤§å¤šæ•°æµè§ˆå™¨èƒ½å¤Ÿå…¼å®¹çš„ ES5 æ ‡å‡†ã€‚

![image.png](/img/posts/2024-1-8/2024-1-8-2.png)

NPM çš„å¾®å‰ç«¯è®¾è®¡æ–¹æ¡ˆä¸­ï¼Œå„ä¸ªå¾®åº”ç”¨å¯ä»¥é‡‡ç”¨ä¸åŒçš„æŠ€æœ¯æ ˆï¼Œä½†æ˜¯æ„å»ºæ—¶éœ€è¦åƒå‘å¸ƒä¸šåŠ¡ç»„ä»¶ä¸€æ ·è¾“å‡º ES5 & æ¨¡å—åŒ–æ ‡å‡†çš„ JavaScript åº“ï¼ˆå°½ç®¡å¼€å‘çš„æ˜¯åº”ç”¨ï¼Œä½†æ˜¯æ„å»ºçš„ä¸æ˜¯åº”ç”¨ç¨‹åºï¼Œä¸éœ€è¦é¢å¤–ç”Ÿæˆ HTMLï¼‰ï¼Œä»è€Œä½¿ä¸»åº”ç”¨å®‰è£…å„è‡ªçš„ä¾èµ–æ—¶ï¼Œå¯ä»¥é€šè¿‡æ¨¡å—åŒ–çš„æ–¹å¼å¼•å…¥å¾®åº”ç”¨ã€‚ä¸»åº”ç”¨ä¸éœ€è¦å…³å¿ƒå¾®åº”ç”¨çš„æŠ€æœ¯æ ˆï¼Œä¸éœ€è¦å…³å¿ƒå¾®åº”ç”¨çš„æ„å»ºé…ç½®é¡¹ã€‚

æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ª [demo](https://github.com/heiheihoho1213/monto-app/tree/tutorial/npm-micro)

ä¸»åº”ç”¨æˆ‘ä»¬å‡è®¾ä½¿ç”¨ vueï¼Œè®¾ç½®å­åº”ç”¨çš„è·¯ç”±ï¼š

```js
import ReactApp from "./React";
import VueApp from "./Vue";
const router = createBrowserRouter([
  {
    path: "/",
    element: <App />,
    children: [
      {
        path: "react",
        element: <ReactApp />,
      },
      {
        path: "vue",
        element: <VueApp />,
      },
    ],
  },
]);
```

å„ä¸ªå­åº”ç”¨çš„å…¥å£éœ€è¦æ”¹é€ ï¼Œæˆ‘ä»¬ä»¥ react ä¸ºä¾‹ï¼š

```js
// package.json åç§°ï¼šreact-micro-app
let root;

export function mount(containerId) {
  console.log("react app mount");
  root = ReactDOM.createRoot(document.getElementById(containerId));
  root.render(
    <React.StrictMode>
      <App />
    </React.StrictMode>
  );
}

export function unmount() {
  console.log("react app unmount: ", root);
  root && root.unmount();
}
```

å­åº”ç”¨éƒ¨ç½²ä¸º npm å¹¶å‘å¸ƒåï¼Œä¸»åº”ç”¨ç›´æ¥å¼•å…¥ï¼ˆè¿™é‡Œä½¿ç”¨ lernaï¼‰ç®¡ç†ï¼š

```js
// ä¸»åº”ç”¨å¼•å…¥
// React.js
const { mount, unmount } = require("react-micro-app");
import React, { useEffect } from "react";

const containerId = 'react-app';

function ReactApp() {
  useEffect(() => {
    mount(containerId);
    return () => {
      unmount();
    };
  }, []);
  return <div id={containerId}></div>;
}

export default React.memo(ReactApp);
```
å¦‚æœä¸æƒ³é¢å¤–å¼•å…¥å¾®åº”ç”¨çš„ CSS æ ·å¼ï¼Œé‚£ä¹ˆå¯ä»¥å°†æ ·å¼å†…è”åˆ° JS ä¸­ï¼Œå½“ç„¶å…¶å®ƒçš„ä¸€äº›é™æ€èµ„æºä¹Ÿéœ€è¦å†…è”åˆ° JS ä¸­ï¼Œé€šè¿‡ Webpack å¯ä»¥è¿›è¡Œå¾ˆå¥½çš„å¤„ç†ã€‚
ç”±äºéœ€è¦æ„å»ºæˆç±»ä¼¼äºåº“åŒ…çš„æ¨¡å—åŒ–è§„èŒƒï¼Œå­åº”ç”¨éœ€è¦æ›´æ”¹ Webpack çš„é…ç½® (ä»¥ vue ä¸ºä¾‹)ï¼š

```js
module.exports = defineConfig({
  transpileDependencies: true,
  // å†…è” CSS æ ·å¼å¤„ç†
  css: { extract: false }
});
```

> æ€è€ƒï¼šæœ‰æ²¡æœ‰æ–¹æ³•å¯ä»¥åšåˆ°ä¸»åº”ç”¨å¼•å…¥æ–¹å¼ä¸å˜çš„æƒ…å†µä¸‹ï¼Œåœ¨å¼€å‘æ€å¼•å…¥çš„æ˜¯å¾®åº”ç”¨çš„æºç ï¼ˆä¿®æ”¹å¾®åº”ç”¨çš„ä»£ç åä¸éœ€è¦æ„å»ºï¼Œç›´æ¥åœ¨ä¸»åº”ç”¨ä¸­ä¼šçƒ­æ›´æ–°å˜æ›´ï¼‰ï¼Œè€Œåœ¨ç”Ÿäº§æ€å¼•å…¥çš„æ˜¯å¾®åº”ç”¨æ„å»ºåå‘å¸ƒçš„ NPM åŒ…ï¼Œè¿™ç§é…ç½®åœ¨å•ä¸ªä¸šåŠ¡ç»„ä»¶çš„å¼€å‘ä¸­å°¤ä¸ºé‡è¦ ?

> å¼€å‘æ—¶å°†ä¾èµ–çš„åº”ç”¨æ‹‰ä¸‹æ¥åˆ°æœ¬åœ°ï¼Œå¹¶åšå…³è”ï¼ˆæ¯”å¦‚ lernaï¼‰åå¯åŠ¨å¼€å‘åº”ç”¨ã€‚å¯åŠ¨å™¨ä¸­æ£€æµ‹æœ¬åœ°æœ‰å°±ä½¿ç”¨æœ¬åœ°ï¼Œæ²¡æœ‰å°±ä½¿ç”¨ npm ä¸‹è½½ä½¿ç”¨ï¼Ÿ

NPM æ–¹æ¡ˆä¼˜ç‚¹ï¼š

- å¯ä»¥æŒ‰ç…§ UMD. CommonJS æˆ–è€… ESM ç­‰ä¸åŒè§„èŒƒè¿›è¡Œå¼•å…¥ï¼Œä¸åŒä¾èµ–åº“é—´ä¹Ÿæ²¡æœ‰å¼ºä¾èµ–
- ä¸éœ€è¦å•ç‹¬çš„æœåŠ¡å™¨è¿›è¡Œéƒ¨ç½²ä»¥åŠèµ„æºæ‰˜ç®¡ï¼Œåªéœ€è¦å‘å¸ƒåˆ°npmä»“åº“å³å¯ã€‚
- å¤ç”¨æ€§å¥½ï¼Œå¯ä»¥ä»»æ„ç»„åˆæˆä¸åŒçš„å¾®å‰ç«¯ç³»ç»Ÿã€‚
- å¯ä»¥å…±äº«åŒä¸€ä¸ªæ¸²æŸ“è¿›ç¨‹ï¼Œå¤©ç„¶å…±äº« windowï¼Œä¸Šä¸‹æ–‡åŠå†…å­˜æ•°æ®ã€‚
- ä¸»å­åº”ç”¨å¤©ç„¶åŒåŸŸ


ç¼ºç‚¹ï¼š

- ä¸»åº”ç”¨éœ€è¦ä¸€ä¸ªå¸¦è·¯ç”±çš„æ¡†æ¶ï¼Œæ— æ³•åšåˆ°æŠ€æœ¯æ— å…³ã€‚
- æ— æ³•å¤„ç†ä¸»å­åº”ç”¨æ ·å¼å†²çª
- å¾®åº”ç”¨çš„æ„å»ºéœ€è¦åšé¢å¤–çš„é…ç½®ï¼Œå› ä¸ºæ„å»ºçš„ä¸æ˜¯åº”ç”¨ï¼Œè€Œæ˜¯ä¾èµ–åº“ã€‚
- å¾®åº”ç”¨å‘å¸ƒæ–°ç‰ˆæœ¬åï¼Œä¸»åº”ç”¨éƒ½éœ€è¦é‡æ–°å®‰è£…å¹¶æ„å»ºéƒ¨ç½²ï¼Œæ— æ³•åšåˆ°å­åº”ç”¨ç‹¬ç«‹å¯åŠ¨å’Œéƒ¨ç½²ã€‚
- ä¾èµ– webpack ç­‰æ‰“åŒ…å·¥å…·
- å½“å¾®åº”ç”¨è¿‡å¤šï¼Œè¿˜éœ€è¦è€ƒè™‘ä½“ç§¯è¿‡å¤§çš„ä¼˜åŒ–é—®é¢˜ï¼Œæ¯”å¦‚å…¬å…±æ¡†æ¶æŠ½ç¦»ï¼Œä»£ç åˆ†å‰²ç­‰ã€‚
- å­åº”ç”¨æ— æ³•ç‹¬ç«‹éƒ¨ç½²å’Œå¼€å‘

é—ç•™é—®é¢˜ï¼š

- ä¸»åº”ç”¨ä¸å­åº”ç”¨å…¨å±€å˜é‡æ±¡æŸ“
- CSS æ ·å¼å†²çª
- å­˜å‚¨æ•°æ®å†²çª50:T2645,æœ¬èŠ‚å¼€å§‹å¾®å‰ç«¯é¡¹ç›®çš„ä»‹ç»ã€‚

## 1. èƒŒæ™¯çŸ¥è¯†

ä¸€ä¸ªå¥½çš„å¾®å‰ç«¯æ¶æ„ï¼Œåº”è¯¥å…·å¤‡å¦‚ä¸‹ç‰¹ç‚¹ï¼š

- SPA ä½“éªŒï¼šå¾®å‰ç«¯å¯ä»¥ä½¿æ‰€æœ‰çš„åº”ç”¨ä¿æŒåŸæœ‰çš„ SPA ä½“éªŒï¼Œç»Ÿä¸€å“ç‰Œè®¤çŸ¥ï¼›
- æŠ€æœ¯æ ˆæ— å…³ï¼šå¯ä»¥ä½¿ç”¨ä¸åŒçš„æŠ€æœ¯æ ˆï¼ˆä¾‹å¦‚ React. Vue. Svelte ï¼‰å¼€å‘ï¼Œæ”¯æŒç‹¬ç«‹éƒ¨ç½²ï¼›
- æ€§èƒ½ä¼˜åŒ–ï¼š åœ¨ MPA å’Œ iframe ä¸­å¦‚æœæƒ³è¦åšæ€§èƒ½ä¼˜åŒ–ï¼Œå¾€å¾€éœ€è¦ä¾èµ–æµè§ˆå™¨å’Œ HTTP çš„èƒ½åŠ›ï¼Œè€Œåœ¨å¾®å‰ç«¯ä¸­å¯ä»¥å¤„ç†åº”ç”¨èµ„æºçš„å»é‡. åº”ç”¨è‡ªèº«çš„é¢„åŠ è½½. é¢„æ¸²æŸ“å’Œç¼“å­˜å¤„ç†ï¼Œä¹Ÿå¯ä»¥å¯¹å·²åŠ è½½çš„é¡µé¢è¿›è¡Œä¿æ´»å¤„ç†ï¼Œå¢åŠ äº†æ€§èƒ½ä¼˜åŒ–çš„æ‰‹æ®µï¼›
- è§£è€¦é‡æ„ï¼šéƒ¨åˆ†ä½ä»£ç é¡µé¢æ— æ³•æ»¡è¶³æ€§èƒ½è¦æ±‚æ—¶ï¼Œå¯ä»¥é€šè¿‡æ–°çš„æŠ€æœ¯æ ˆå°†é¡µé¢è¿›è¡Œé‡æ„ï¼Œä¸å½±å“å…¶ä»–ä½ä»£ç é¡µé¢çš„è¿è¡Œï¼Œä»è€Œå¯ä»¥å‡å°‘é‡æ„å¸¦æ¥çš„å½±å“é¢ã€‚
- ç‹¬ç«‹æ€§ï¼šç‹¬ç«‹å¼€å‘. ç‹¬ç«‹éƒ¨ç½²å’Œç‹¬ç«‹è¿è¡Œ

**ä¸ºä»€ä¹ˆä½¿ç”¨å¾®å‰ç«¯**ï¼šå¾®å‰ç«¯å¯ä»¥é™ä½å¤§å‹å¤æ‚åº”ç”¨çš„å¼€å‘. å‡çº§. ç»´æŠ¤ä»¥åŠå›¢é˜Ÿåä½œçš„æˆæœ¬ã€‚å½“ç„¶ï¼Œè§£å†³å†å²é—ç•™çš„éš¾ä»¥å¼€å‘. å‡çº§å’Œç»´æŠ¤çš„å¤§å‹åº”ç”¨ï¼Œä¹Ÿæ˜¯ä½¿ç”¨å¾®å‰ç«¯çš„ä¸€ä¸ªé‡è¦åŸå› ã€‚

web æ¶æ„æ¼”è¿›ï¼š

![image.png](/img/posts/2024-1-3/2024-1-3-2.png)

ä½¿ç”¨å¾®å‰ç«¯ï¼š

![image.png](/img/posts/2024-1-3/2024-1-3-3.png)

å…¶åœ¨ä¼ä¸šä¸­çš„ä¸šåŠ¡åœºæ™¯ï¼š

![image.png](/img/posts/2024-1-3/2024-1-3-4.png)

ç„¶è€Œå¾®å‰ç«¯ä¸æ˜¯ä¸‡èƒ½çš„ï¼Œä¾‹å¦‚ä»¥ä¸‹åœºæ™¯å¯èƒ½å¹¶ä¸éœ€è¦å¾®å‰ç«¯ï¼š

- åº”ç”¨çš„ä¸šåŠ¡å•ä¸€ï¼Œä¸å­˜åœ¨å¤šä¸ªå›¢é˜Ÿå¹¶è¡Œå¼€å‘çš„æƒ…å†µï¼Œä¸éœ€è¦å…¼å®¹ä¸åŒçš„æŠ€æœ¯æ ˆï¼›
- åº”ç”¨çš„åŠŸèƒ½å·²ç»éå¸¸å®Œå–„ï¼Œä¸å­˜åœ¨å¤§é‡æ–°éœ€æ±‚å¼€å‘çš„å¯èƒ½æ€§ï¼›
- é¡¹ç›®ç»„ä¸æƒ³èŠ±è´¹å¤§é‡çš„æ—¶é—´åœ¨åº”ç”¨çš„æ”¹é€ ä¸Šï¼Œä»¥ç°æœ‰åº”ç”¨çš„ç¨³å®šæ€§ä¸ºä¸»ï¼›
- åº”ç”¨è¿›è¡Œå¾®å‰ç«¯æ”¹é€ çš„æˆæœ¬è¿˜ä¸å¦‚ç›´æ¥æ”¹é€ å½“å‰å­˜é‡åº”ç”¨å¸¦æ¥çš„æ”¶ç›Šå¤§ï¼›
- å›¢é˜Ÿå†…å¼€å‘äººå‘˜ä¸ç†Ÿæ‚‰å¾®å‰ç«¯ï¼Œæ— æ³•åº”å¯¹å¾®å‰ç«¯æ¶æ„çš„å¤æ‚æ€§ã€‚

## 2. æµè§ˆå™¨éš”ç¦»

æµè§ˆå™¨æ˜¯å¤šè¿›ç¨‹æ¶æ„ï¼Œåœ¨æ¸²æŸ“é¡µé¢æ—¶ï¼Œç†è®ºä¸Šä¸åŒçš„ç«™ç‚¹ä¼šå¯ç”¨ä¸åŒçš„æ¸²æŸ“è¿›ç¨‹ï¼ˆRendererï¼‰ï¼Œä»–ä»¬ä¹‹é—´æ˜¯ç›¸äº’éš”ç¦»çš„ã€‚Chrome æµè§ˆå™¨åœ¨è¿›è¡Œæ²™ç®±è®¾è®¡æ—¶ï¼Œä¼šå°½å¯èƒ½çš„å¤ç”¨ç°æœ‰æ“ä½œç³»ç»Ÿçš„æ²™ç®±æŠ€æœ¯ï¼Œä¾‹å¦‚ä»¥ Windows æ“ä½œç³»ç»Ÿçš„æ²™ç®±æ¶æ„ä¸ºä¾‹ï¼Œæ‰€æœ‰çš„æ²™ç®±éƒ½ä¼šåœ¨è¿›ç¨‹ç²’åº¦è¿›è¡Œæ§åˆ¶ï¼Œæ‰€æœ‰çš„è¿›ç¨‹éƒ½é€šè¿‡ IPC è¿›è¡Œé€šä¿¡ã€‚

![image.png](/img/posts/2024-1-3/2024-1-3-5.png)

åœ¨ Chrome æµè§ˆå™¨ä¸­æ²™ç®±éš”ç¦»ä»¥ Renderer è¿›ç¨‹ä¸ºå•ä½ï¼Œè€Œåœ¨æ—§ç‰ˆçš„æµè§ˆå™¨ä¸­ä¼šå­˜åœ¨å¤šä¸ª **Web åº”ç”¨å…±äº«åŒä¸€ä¸ª Renderer è¿›ç¨‹**çš„æƒ…å†µï¼Œæ­¤æ—¶æµè§ˆå™¨ä¼šä¾é åŒæºç­–ç•¥æ¥é™åˆ¶ä¸¤ä¸ªä¸åŒæºçš„æ–‡æ¡£è¿›è¡Œäº¤äº’ï¼Œå¸®åŠ©éš”ç¦»æ¶æ„æ–‡æ¡£æ¥å‡å°‘å®‰å…¨é£é™©ã€‚

ä½†æ˜¯è€å¼æµè§ˆå™¨æœªå¯ç”¨ç«™ç‚¹éš”ç¦»ï¼Œæ ‡ç­¾é¡µåº”ç”¨å’Œå†…éƒ¨çš„ iframe åº”ç”¨ä¼šå¤„äºåŒä¸€ä¸ª Renderer è¿›ç¨‹ï¼ŒWeb åº”ç”¨æœ‰å¯èƒ½å‘ç°å®‰å…¨æ¼æ´å¹¶ç»•è¿‡åŒæºç­–ç•¥çš„é™åˆ¶ï¼Œè®¿é—®åŒä¸€ä¸ªè¿›ç¨‹ä¸­çš„å…¶ä»– Web åº”ç”¨ï¼Œå› æ­¤å¯èƒ½äº§ç”Ÿå¦‚ä¸‹å®‰å…¨é£é™©ï¼š

- è·å–è·¨ç«™ç‚¹ Web åº”ç”¨çš„ Cookie å’Œ HTML 5 å­˜å‚¨æ•°æ®ï¼›
- è·å–è·¨ç«™ç‚¹ Web åº”ç”¨çš„ HTML. XML å’Œ JSON æ•°æ®ï¼›
- è·å–æµè§ˆå™¨ä¿å­˜çš„å¯†ç æ•°æ®ï¼›
- å…±äº«è·¨ç«™ç‚¹ Web åº”ç”¨çš„æˆæƒæƒé™ï¼Œä¾‹å¦‚åœ°ç†ä½ç½®ï¼›
- ç»•è¿‡ X-Frame-Options åŠ è½½ iframe åº”ç”¨ï¼ˆä¾‹å¦‚ç™¾åº¦çš„é¡µé¢è¢« iframe åµŒå¥—ï¼‰ï¼›
- è·å–è·¨ç«™ç‚¹ Web åº”ç”¨çš„ DOM å…ƒç´ ã€‚

## 3. iframe æ–¹æ¡ˆ

[ä»“åº“åœ°å€ï¼šdemo/iframe-isolate åˆ†æ”¯](https://github.com/heiheihoho1213/monto-app/tree/tutorial/iframe-isolate)

åœ¨ Chrome 67 ç‰ˆæœ¬ä¹‹åï¼Œä¸ºäº†é˜²å¾¡å¤šä¸ªè·¨ç«™çš„ Web åº”ç”¨å¤„äºåŒä¸€ä¸ª Renderer è¿›ç¨‹è€Œå¯èƒ½äº§ç”Ÿçš„å®‰å…¨é£é™©ï¼Œ**æµè§ˆå™¨ä¼šç»™æ¥è‡ªä¸åŒç«™ç‚¹çš„ Web åº”ç”¨åˆ†é…ä¸åŒçš„ Renderer è¿›ç¨‹**ã€‚ä¾‹å¦‚å½“å‰æ ‡ç­¾é¡µåº”ç”¨ä¸­åŒ…å«äº†å¤šä¸ªä¸åŒç«™ç‚¹çš„ iframe åº”ç”¨ï¼Œé‚£ä¹ˆæµè§ˆå™¨ä¼šä¸ºå„è‡ªåˆ†é…ä¸åŒçš„ Renderer è¿›ç¨‹ï¼Œä»è€Œå¯ä»¥åŸºäºæ²™ç®±ç­–ç•¥è¿›è¡Œåº”ç”¨çš„è¿›ç¨‹éš”ç¦»ï¼Œç¡®ä¿æ”»å‡»è€…éš¾ä»¥ç»•è¿‡å®‰å…¨æ¼æ´ç›´æ¥è®¿é—®è·¨ç«™ Web åº”ç”¨ã€‚

ä¸»åº”ç”¨é‡Œå®šä¹‰ï¼š

```html
<body>
  <h1>main åº”ç”¨</h1>
  <button onclick="javascript:window.open('<%= iframeUrl %>')">åœ¨æ–°çš„æ ‡ç­¾é¡µæ‰“å¼€ iframe åº”ç”¨</button>
  <br>
  <!-- åŒç«™åº”ç”¨ï¼šiframe.html -->
  <iframe src="<%= iframeUrl %>"></iframe>
  <!-- è·¨ç«™åº”ç”¨: -->
  <iframe src="https://nextjs.org/"></iframe>
</body>
```

å­åº”ç”¨é‡Œå®šä¹‰ï¼š

```html
<body>
  <h1>åŒç«™çš„ iframe åº”ç”¨</h1>
  <button onclick="javascript:alert('æˆ‘æ˜¯å¼¹çª—')">ç‚¹æˆ‘æœ‰å¼¹çª—</button>
</body>
```

ç„¶ååœ¨ä¸»æœåŠ¡é‡Œå†™å…¥å­åº”ç”¨çš„åœ°å€ï¼š

```js
app.get("/", function (req, res) {
  // ä½¿ç”¨ ejs æ¨¡ç‰ˆå¼•æ“å¡«å……ä¸»åº”ç”¨ views/main.html ä¸­çš„ iframeUrl å˜é‡ï¼Œå¹¶å°†å…¶æ¸²æŸ“åˆ°æµè§ˆå™¨
  res.render("main", {
    // å¡«å…… iframe åº”ç”¨çš„åœ°å€ï¼Œåªæœ‰ç«¯å£ä¸åŒï¼Œiframe åº”ç”¨å’Œ main åº”ç”¨è·¨åŸŸä½†æ˜¯åŒç«™ï¼Œå¯ä»¥ä½¿ç”¨ åŒç«™åº”ç”¨é€šè¿‡ä¿®æ”¹ document.domain è¿›è¡Œé€šä¿¡
    iframeUrl: `http://${host}:${port.micro}`
  });
});
```

å­åº”ç”¨ä¹Ÿä½¿ç”¨å•ç‹¬çš„æœåŠ¡å¯åŠ¨å³å¯ï¼š

![image.png](/img/posts/2024-1-3/2024-1-3-1.png)

## 4. iframe æµè§ˆä¸Šä¸‹æ–‡

åˆ¤æ–­ä¸€ä¸ªé¡µé¢æ˜¯ä¸æ˜¯åœ¨ iframe ä¸­è¢«æ‰“å¼€ï¼Œå¯ä»¥é€šè¿‡å¦‚ä¸‹ä»£ç ï¼š

```js
// é€šè¿‡è®¿é—® window.top å¯ä»¥è·å–å½“å‰æµè§ˆä¸Šä¸‹æ–‡çš„é¡¶çº§æµè§ˆä¸Šä¸‹æ–‡ window å¯¹è±¡ï¼Œé€šè¿‡è®¿é—® window.parent å¯ä»¥è·å–çˆ¶æµè§ˆä¸Šä¸‹æ–‡çš„ window å¯¹è±¡ã€‚
if(window.top !== window) {}
```

å¦‚æœä¸»åº”ç”¨æ˜¯åœ¨ç©ºç™½çš„æ ‡ç­¾é¡µæ‰“å¼€ï¼Œé‚£ä¹ˆä¸»åº”ç”¨æ˜¯ä¸€ä¸ªé¡¶çº§æµè§ˆä¸Šä¸‹æ–‡ï¼Œé¡¶çº§æµè§ˆå™¨ä¸Šä¸‹æ–‡æ—¢ä¸æ˜¯åµŒå¥—çš„æµè§ˆä¸Šä¸‹æ–‡ï¼Œè‡ªèº«ä¹Ÿæ²¡æœ‰çˆ¶æµè§ˆä¸Šä¸‹æ–‡ã€‚

**iframe æœ‰å¾ˆå¤šä¼˜ç‚¹ï¼š**

- å¤©ç„¶çš„ js. css éš”ç¦»ï¼Œçœçš„å†™ sandbox äº†
- ç§»æ¤æ€§å’Œå¤ç”¨æ€§å¥½ï¼ŒæŠ€æœ¯æ ˆç‹¬ç«‹ï¼Œå¯ä»¥ä¾¿æ·åœ°åµŒåœ¨ä¸åŒçš„ä¸»åº”ç”¨ä¸­
- å¯ä»¥åœ¨è¿è¡Œæ—¶åšåˆ°åŠ¨æ€åŒ–ä¿®æ”¹
- åˆ‡æ¢å¾®åº”ç”¨ä¸éœ€è¦åˆ·æ–°ä¸»åº”ç”¨
- å¤©ç„¶çš„åº”ç”¨é—´èµ„æºæ‡’åŠ è½½ï¼Œæ²¡æœ‰åŠ è½½å­åº”ç”¨ï¼Œå…¶èµ„æºä¹Ÿä¸ä¼šè¢«åŠ è½½ã€‚

> ç„¶è€Œ iframe æ–¹æ¡ˆæœ‰å“ªäº›é—®é¢˜å‘¢ï¼Ÿ

**ä¸è¶³ï¼š**

- é¦–æ¬¡åŠ è½½ iframe åº”ç”¨æ—¶ï¼Œä¼šå› ä¸ºæœåŠ¡ç«¯è¯·æ±‚è€Œå¯¼è‡´å†…å®¹åŒºå¸¦æ¥çŸ­æš‚çš„ç™½å±æ•ˆæœ
- ä¸»åº”ç”¨åˆ·æ–°æ—¶ï¼Œiframe æ— æ³•ä¿æŒ URL çŠ¶æ€ï¼ˆä¼šé‡æ–°åŠ è½½ src å¯¹åº”çš„åˆå§‹ URLï¼‰ï¼›
- ä¸»åº”ç”¨å’Œ iframe å¤„äºä¸åŒçš„æµè§ˆä¸Šä¸‹æ–‡ï¼Œæ— æ³•ä½¿ iframe ä¸­çš„æ¨¡æ€æ¡†ç›¸å¯¹äºä¸»åº”ç”¨å±…ä¸­ï¼›
- ä¸»åº”ç”¨å’Œ iframe å¾®åº”ç”¨çš„æ•°æ®çŠ¶æ€åŒæ­¥é—®é¢˜ï¼šæŒä¹…åŒ–æ•°æ®å’Œé€šä¿¡ã€‚
- å¯¹äºéåå°ç®¡ç†ç³»ç»Ÿè€Œè¨€ï¼Œä½¿ç”¨ iframe è¿˜éœ€è¦è€ƒè™‘ SEO. ç§»åŠ¨ç«¯å…¼å®¹æ€§. åŠ è½½æ€§èƒ½ç­‰é—®é¢˜ã€‚
- ä¸»/å­åº”ç”¨ cookie å…±äº«é—®é¢˜ï¼ˆæ¯”å¦‚å…ç™»ï¼‰

## 5. iframe æ–¹æ¡ˆ cookie å…±äº«

> å…¶ä»–æ–¹æ¡ˆçš„ cookie å…±äº«ä¹Ÿç±»ä¼¼

#### åŒåŸŸ

```js
app.get("/", function (req, res) {
  // è®¾ç½®ä¸»åº”ç”¨çš„ cookie æ ‡è¯†
  res.cookie("cookie-test", "123");
  // ä½¿ç”¨ ejs æ¨¡ç‰ˆå¼•æ“å¡«å……ä¸»åº”ç”¨ public/main.html ä¸­çš„ micro å˜é‡ï¼Œå¹¶å°†å…¶æ¸²æŸ“åˆ°æµè§ˆå™¨
  res.render("main", {
    // micro æŒ‡å‘å¾®åº”ç”¨çš„æ‰“å¼€åœ°å€
    micro: `http://${host}:${port.main}/micro`,
  });
});

// å¾®åº”ç”¨å’Œä¸»åº”ç”¨åŒåŸŸï¼Œåªæ˜¯æœåŠ¡è·¯ç”±ä¸åŒ
app.get("/micro", function (req, res) {
  // è®¾ç½® iframe å¾®åº”ç”¨çš„ cookie æ ‡è¯†ï¼Œé¡ºä¾¿è§‚å¯Ÿèƒ½å¦è¦†ç›–ä¸»åº”ç”¨çš„ cookie æ ‡è¯†
  // åŒåŸŸæ—¶å…±äº«cookieï¼Œå­åº”ç”¨ä¼šæ”¹åŠ¨ä¸»åº”ç”¨çš„cookie
  res.cookie("micro-app", "true").cookie("cookie-test", "456");
  // æ¸²æŸ“ views/micro.html
  res.render("micro");
});
```

ç»“è®ºï¼šä¸»å­åº”ç”¨å¯ä»¥å…±äº« Cookie æ•°æ®ï¼Œä½†æ˜¯å­˜åœ¨åŒåå±æ€§å€¼è¢«è¦†ç›–çš„é£é™©

#### åŒç«™ä¸åŒåŸŸ

ä¸»åº”ç”¨ï¼š

```js
// ä½¿ç”¨ iHosts é…ç½® example.com æŒ‡å‘æœ¬æœºçš„ ip åœ°å€ï¼Œæ¨¡æ‹ŸåŒç«™
// ä¸»åº”ç”¨è®¿é—®åœ°å€ï¼šhttp://example.com:4000
app.get("/", function (req, res) {
  res.cookie("cookie-test", "456");
  // ä½¿å­åŸŸçš„å¾®åº”ç”¨å¯ä»¥å…±äº« Cookie
  // åœ¨è®¾ç½® Cookie æ—¶ï¼Œå¯ä»¥ä½¿ç”¨ Domainå’Œ Path æ¥æ ‡è®°ä½œç”¨åŸŸ
  // é»˜è®¤ä¸æŒ‡å®šçš„æƒ…å†µä¸‹ï¼ŒDomain å±æ€§ä¸ºå½“å‰åº”ç”¨çš„ hostï¼Œç”±äº xiaodududududuo.example.com å’Œ example.com ä¸åŒ
  // å› æ­¤é»˜è®¤æƒ…å†µä¸‹ä¸¤è€…ä¸èƒ½å…±äº« Cookieï¼Œå¯ä»¥é€šè¿‡è®¾ç½® Domain ä½¿å…¶ä¸ºå­åŸŸè®¾ç½® Cookieï¼Œä¾‹å¦‚ Domain=example.comï¼Œåˆ™ Cookie ä¹ŸåŒ…å«åœ¨å­åŸŸ xiaodududududuo.example.com ä¸­
  res.cookie("main-cookie-test", "true", { domain: "example.com" }); // æ ¸å¿ƒä»£ç 
  res.render("main", {
    // ä½¿ç”¨ iHosts é…ç½® xiaodududududuo.example.com æŒ‡å‘æœ¬æœºçš„ ip åœ°å€
    // å­åº”ç”¨è®¿é—®åœ°å€ï¼š http://xiaodududududuo.example.com:3000
    micro: `http://xiaodududududuo.example.com:${port.micro}`,
  });
});
```

å­åº”ç”¨ï¼š

```js
app.get("/", function (req, res) {
  // è®¾ç½® iframe å¾®åº”ç”¨çš„ cookie æ ‡è¯†ï¼Œé¡ºä¾¿è§‚å¯Ÿèƒ½å¦è¦†ç›–ä¸»åº”ç”¨çš„ cookie æ ‡è¯†
  res.cookie("micro-app", "true").cookie("cookie-test", "123");
  res.render("micro");
});
```

ç»“è®ºï¼šé»˜è®¤æƒ…å†µæ— æ³•å…±äº«ï¼Œä½†æ˜¯é€šè¿‡è®¾ç½® Domain ä½¿å¾—ä¸¤ä¸ªåº”ç”¨å¯ä»¥å…±äº«å½¼æ­¤çš„ Cookieã€‚

#### è·¨ç«™

ä»£ç å°±ä¸ç”¨æ¼”ç¤ºäº†ï¼Œä¸¤ä¸ªå®Œå…¨ä¸åŒçš„åœ°å€ä½œä¸ºä¸»/å­æœåŠ¡ï¼Œç›´æ¥è¯´ç»“è®ºï¼šå­åº”ç”¨é»˜è®¤æ— æ³•æºå¸¦ Cookieï¼ˆé˜²æ­¢ CSRF æ”»å‡»ï¼‰ï¼Œéœ€è¦ä½¿ç”¨ HTTPS åè®®å¹¶è®¾ç½®æœåŠ¡ç«¯ Cookie çš„ SameSite å’Œ Secure è®¾ç½®æ‰è¡Œï¼Œå¹¶ä¸”å­åº”ç”¨æ— æ³•å’Œä¸»åº”ç”¨å½¢æˆ Cookie å…±äº«

> æœ¬åœ°å¯ä»¥ä½¿ç”¨ ngrok æ¨¡æ‹Ÿè·¨ç«™

## 6. å‰©ä½™ç¼ºç‚¹

- é¦–æ¬¡åŠ è½½ç™½å±æ•ˆæœï¼ˆå¯ä»¥ä½¿ç”¨é¢„åŠ è½½. é¢„æ¸²æŸ“ç­‰ä¼˜åŒ–æªæ–½ï¼‰
- iframe æ— æ³•ä¿æŒ URL çŠ¶æ€ï¼ˆä¸»å­åº”ç”¨éœ€è¦åš history çš„ä»£ç†ï¼Œå…¨å±€ä½¿ç”¨ä¸€ä¸ªå•ä¾‹ï¼‰
- æ¨¡æ€æ¡†ç›¸å¯¹äºä¸»åº”ç”¨å±…ä¸­é—®é¢˜ï¼ˆåŒä¸Šï¼Œä¸»å­åº”ç”¨éœ€åš window å¯¹è±¡ä»£ç†ï¼Œå¼¹çª—ç›¸å¯¹äº body ç½®äºé¡¶å±‚ï¼‰
- æ•°æ®çŠ¶æ€åŒæ­¥é—®é¢˜ï¼ˆåŒä¸Šï¼Œä¸»å­åº”ç”¨éœ€åš window å¯¹è±¡ä»£ç†ï¼Œä¸»å­åº”ç”¨è®¾ç½®é€šä¿¡æœºåˆ¶ä¼ é€’äº‹ä»¶å¯¹è±¡ç­‰ï¼‰
- SEO. ç§»åŠ¨ç«¯å…¼å®¹æ€§. åŠ è½½æ€§èƒ½ï¼š ï¼Ÿ

----51:T17d8,äºŒå‰æ ‘æ˜¯ä¸€ç§è®¡ç®—æœºåŸºç¡€æ•°æ®ç»“æ„ï¼Œæœ€è¿‘åœ¨å†™æ ‘ç»„ä»¶çš„æ—¶å€™æœ‰ç”¨åˆ°äº†è¿™ä¸ªåŸºæœ¬çŸ¥è¯†ï¼Œè¿™é‡Œæ€»ç»“ä¸€ä¸‹ã€‚

## 1. å¼•

å®ƒçš„å®é™…ä½¿ç”¨åœºæ™¯éå¸¸å¹¿æ³›ã€‚ä»¥ä¸‹æ˜¯ä¸€äº›å¸¸è§çš„äºŒå‰æ ‘åº”ç”¨åœºæ™¯ï¼š

*   æ–‡ä»¶ç³»ç»Ÿï¼šæ–‡ä»¶ç³»ç»Ÿçš„ç›®å½•ç»“æ„å¯ä»¥ä½¿ç”¨äºŒå‰æ ‘è¡¨ç¤ºï¼Œæ¯ä¸ªèŠ‚ç‚¹ä»£è¡¨ä¸€ä¸ªæ–‡ä»¶æˆ–ç›®å½•ï¼Œé€šè¿‡å·¦å­èŠ‚ç‚¹å’Œå³å­èŠ‚ç‚¹è¿æ¥å½¢æˆå±‚çº§ç»“æ„ã€‚
*   æ•°æ®åº“ç´¢å¼•ï¼šæ•°æ®åº“ç´¢å¼•é€šå¸¸ä½¿ç”¨äºŒå‰æ ‘å®ç°ï¼Œæ¯”å¦‚äºŒå‰æœç´¢æ ‘ï¼ˆBSTï¼‰ç”¨äºå¿«é€Ÿæœç´¢å’Œæ£€ç´¢æ•°æ®ã€‚
*   è¡¨è¾¾å¼è§£æå’Œè®¡ç®—ï¼šäºŒå‰æ ‘å¯ä»¥ç”¨äºè§£æå’Œè®¡ç®—è¡¨è¾¾å¼ï¼Œå¦‚æ•°å­¦è¡¨è¾¾å¼. å¸ƒå°”è¡¨è¾¾å¼ç­‰ã€‚
*   å›¾åƒå¤„ç†ï¼šåœ¨å›¾åƒå¤„ç†ä¸­ï¼ŒäºŒå‰æ ‘å¸¸ç”¨äºå›¾åƒå‹ç¼©ç®—æ³•ï¼ˆå¦‚å“ˆå¤«æ›¼ç¼–ç ï¼‰å’Œå›¾åƒæ¸è¿›å¼åŠ è½½ã€‚
*   è·¯ç”±ç®—æ³•ï¼šåœ¨ç½‘ç»œè·¯ç”±ä¸­ï¼ŒäºŒå‰æ ‘å¯ä»¥ç”¨äºæ„å»ºè·¯ç”±è¡¨ï¼Œå¸®åŠ©ç¡®å®šæ•°æ®åŒ…çš„ä¼ è¾“è·¯å¾„ã€‚
*   è§£ææ ‘ï¼šäºŒå‰æ ‘å¯ä»¥ç”¨äºæ„å»ºè§£ææ ‘ï¼Œç”¨äºè§£æå’Œç†è§£è‡ªç„¶è¯­è¨€. ç¼–ç¨‹è¯­è¨€ç­‰ç»“æ„åŒ–æ•°æ®ã€‚
*   äººå·¥æ™ºèƒ½å’Œå†³ç­–æ ‘ï¼šå†³ç­–æ ‘æ˜¯ä¸€ç§ç‰¹æ®Šçš„äºŒå‰æ ‘ï¼Œå¸¸ç”¨äºäººå·¥æ™ºèƒ½ä¸­çš„åˆ†ç±»å’Œå†³ç­–é—®é¢˜ã€‚
*   å †å’Œä¼˜å…ˆé˜Ÿåˆ—ï¼šäºŒå‰å †æ˜¯ä¸€ç§ç‰¹æ®Šçš„äºŒå‰æ ‘ç»“æ„ï¼Œç”¨äºå®ç°ä¼˜å…ˆé˜Ÿåˆ—å’Œå †æ’åºç®—æ³•ã€‚
*   ç¼–è¯‘å™¨å’Œè§£é‡Šå™¨ï¼šåœ¨ç¼–è¯‘å™¨å’Œè§£é‡Šå™¨ä¸­ï¼ŒäºŒå‰æ ‘å¸¸ç”¨äºè¯­æ³•åˆ†æå’Œæ„å»ºæŠ½è±¡è¯­æ³•æ ‘ï¼ˆASTï¼‰ã€‚
*   æ•°æ®å‹ç¼©ï¼šäºŒå‰æ ‘å¸¸ç”¨äºæ•°æ®å‹ç¼©ç®—æ³•ï¼Œå¦‚éœå¤«æ›¼ç¼–ç ï¼ˆHuffman Codingï¼‰ï¼Œé€šè¿‡æ ‘çš„æ„å»ºå’Œè·¯å¾„ç¼–ç æ¥å®ç°æ•°æ®çš„é«˜æ•ˆå‹ç¼©å’Œè§£å‹ç¼©ã€‚
*   çº¿æ®µæ ‘ï¼šçº¿æ®µæ ‘æ˜¯ä¸€ç§ç‰¹æ®Šçš„äºŒå‰æ ‘ï¼Œç”¨äºå¤„ç†åŒºé—´æŸ¥è¯¢é—®é¢˜ï¼Œå¦‚åŒºé—´æœ€å°å€¼. åŒºé—´å’Œç­‰ã€‚
*   ç´¢å¼•ç»“æ„ï¼šäºŒå‰æ ‘å¯ç”¨äºæ„å»ºå„ç§ç´¢å¼•ç»“æ„ï¼Œå¦‚Bæ ‘å’ŒB+æ ‘ï¼Œç”¨äºå¿«é€Ÿçš„æ•°æ®åº“æŸ¥è¯¢å’Œç´¢å¼•æ“ä½œã€‚
*   çº¿ç´¢äºŒå‰æ ‘ï¼šçº¿ç´¢äºŒå‰æ ‘æ˜¯ä¸€ç§ä¼˜åŒ–çš„äºŒå‰æ ‘ç»“æ„ï¼Œé€šè¿‡æ·»åŠ é¢å¤–çš„çº¿ç´¢ä¿¡æ¯ï¼Œå¯ä»¥å¿«é€Ÿè¿›è¡Œä¸­åºéå†. å‰åºéå†ç­‰æ“ä½œã€‚
*   ç¼“å­˜å®ç°ï¼šLRU Cacheï¼ˆæœ€è¿‘æœ€å°‘ä½¿ç”¨ç¼“å­˜ï¼‰å¸¸ä½¿ç”¨åŒå‘é“¾è¡¨å’ŒäºŒå‰æ ‘ï¼ˆå¦‚çº¢é»‘æ ‘ï¼‰ç›¸ç»“åˆçš„æ–¹å¼å®ç°ï¼Œä»¥å¿«é€Ÿæ’å…¥. åˆ é™¤å’ŒæŸ¥æ‰¾æœ€è¿‘ä½¿ç”¨çš„æ•°æ®ã€‚

äºŒå‰æ ‘ä¸€ä¸ªé‡è¦çš„ç®—æ³•å°±æ˜¯ä»–çš„çš„éå†ï¼Œåœ¨ASTç¼–è¯‘å™¨å¼€å‘. è·¯ç”±å¯¼èˆª. æ–‡ä»¶ç³»ç»Ÿç­‰ç­‰ä¸šåŠ¡åœºæ™¯ä¸­éƒ½åœ¨å¹¿æ³›çš„ä½¿ç”¨ã€‚

## 2. æ„å»ºä¸€ä¸ªäºŒå‰æ ‘

äºŒå‰æ ‘æœ‰ä¸€ä¸ªæ ¹èŠ‚ç‚¹ï¼Œæ‰€æœ‰çš„çˆ¶èŠ‚ç‚¹æœ€å¤šåªèƒ½æœ‰ä¸¤ä¸ªå­©å­ã€‚æˆ‘ä»¬å¯ä»¥æ„é€ ä¸€ä¸ªäºŒå‰æ ‘å¦‚ä¸‹ï¼š

![image.png](/img/posts/2023-12-6/2023-12-6-1.png)

ä»£ç ç»“æ„å¦‚ä¸‹ï¼š

```js
const tree = {
  name: 1,
  children: [
    {
      name: 2,
      children: [
        {
          name: 4,
          children: [{ name: 8 }],
        },
        { name: 5 },
      ],
    },
    {
      name: 3,
      children: [{ name: 6 }, { name: 7 }],
    },
  ],
};
```

æ¥ä¸‹æ¥ç»“åˆå›¾å½¢ï¼Œç”¨ä»£ç æ¥å®ç°ä¸€ä¸‹ä»–çš„éå†ï¼š

## 3. éå†

### å±‚æ¬¡éå†

æŒ‰ç…§å±‚çº§éå†

ç®—æ³•æ€è·¯ï¼š

*   å»ºç«‹ä¸€ä¸ªé˜Ÿåˆ—ï¼Œä»æ ¹èŠ‚ç‚¹å¼€å§‹ï¼Œå°†å…¶å­èŠ‚ç‚¹çš„å­èŠ‚ç‚¹ä»å·¦è‡³å³å…¥é˜Ÿ
*   éå†é˜Ÿåˆ—å¹¶å‡ºé˜Ÿï¼Œé‡å¤ç¬¬äºŒæ­¥ååŠéƒ¨åˆ†
*   é˜Ÿåˆ—ä¸ºç©ºåˆ™éå†ç»“æŸ


![image.png](/img/posts/2023-12-6/2023-12-6-2.png)

```js
function traverse(node) {
  if (!node) {
    return;
  }

  const queue = [];
  queue.unshift(node);

  while (queue.length > 0) {
    const printNode = queue.pop();
    console.log(printNode.name);
    if (printNode.children && printNode.children.length > 0) {
      queue.unshift(...printNode.children.slice().reverse());
    }
  }
}
```

### å…ˆåºéå†

é€’å½’å®ç°

*   ä»æ ¹èŠ‚ç‚¹å¼€å§‹
*   å°†å·¦å³èŠ‚ç‚¹å½“åšå­æ ‘ï¼Œå…ˆéå†å·¦èŠ‚ç‚¹ï¼Œå†éå†å³èŠ‚ç‚¹
*   ç›´åˆ°å½“å‰èŠ‚ç‚¹æ²¡æœ‰å­èŠ‚ç‚¹ä¸ºæ­¢

```js
function preOrderTraverse(root) {
  if (root != null) {
    const children = root.children || [];
    console.log(root.name);
    preOrderTraverse(children[0]);
    preOrderTraverse(children[1]);
  }
}
```

éé€’å½’å®ç°

*   å»ºç«‹ä¸€ä¸ªæ ˆï¼Œå…¥æ ˆæ ¹èŠ‚ç‚¹
*   å‡ºæ ˆå½“å‰èŠ‚ç‚¹ï¼Œå°†å½“å‰èŠ‚ç‚¹å­èŠ‚ç‚¹é›†åˆé€†å‘å…¥æ ˆ
*   é‡å¤ç¬¬äºŒæ­¥ï¼Œç›´åˆ°æ ˆç©º


![image.png](/img/posts/2023-12-6/2023-12-6-3.png)

```js
function preOrderTraverse(node) {
  if (!node) return;

  const track = [];
  track.push(node);

  while (track.length > 0) {
    const node = track.pop();
    console.log(node.name);
    const children = node.children;
    if (children && children.length > 0) {
      track.push(...children.reverse());
    }
  }
}
```

> æ€è€ƒï¼šå­¦ä¼šäº†å…ˆåºéå†ï¼Œç›¸ä¿¡ä½ åº”è¯¥èƒ½å¤Ÿå¾ˆå®¹æ˜“çš„å†™å‡ºååºéå†çš„å®ç°ï¼

### ä¸­åºéå†

éé€’å½’å®ç°

*   å»ºç«‹ä¸€ä¸ªæ ˆï¼Œå…¥æ ˆæ ¹èŠ‚ç‚¹
*   è‹¥æœ‰å·¦å­èŠ‚ç‚¹ï¼Œåˆ™å…¥æ ˆï¼Œç›´åˆ°æ²¡æœ‰å·¦å­èŠ‚ç‚¹æ—¶å‡ºæ ˆæ ˆé¡¶å…ƒç´ å¹¶æ‰“å°ï¼Œå…¥æ ˆæ ˆé¡¶å…ƒç´ çš„å³å­èŠ‚ç‚¹
*   é‡å¤ç¬¬äºŒæ­¥ï¼Œç›´åˆ°æ²¡æœ‰å¯ç”¨å…ƒç´ ä¸”æ ˆç©ºä¸ºæ­¢


![image.png](/img/posts/2023-12-6/2023-12-6-4.png)

```js
function middleOrderTraverse(node) {
  if (!node) return;

  const stack = [];
  let currentNode = node;
  while (currentNode || stack.length > 0) {
    if (currentNode) {
      stack.push(currentNode);
      currentNode =
        currentNode && currentNode.children ? currentNode.children[0] : null;
    } else {
      const poped = stack.pop();
      console.log(poped.name);
      currentNode = poped.children ? poped.children[1] : null;
    }
  }
}
```

### é“¾è¡¨å®ç°

é“¾è¡¨ä¸é€‚åˆåšå¹¿åº¦ä¼˜å…ˆéå†ï¼Œä¸‹é¢ç¤ºæ„å›¾ä¸­ï¼Œæ·±åº¦ä¼˜å…ˆä¼šéå¸¸çš„æ–¹ä¾¿ã€‚æˆ‘ä»¬æ‹¿ react fiber çš„ç»“æ„æ¥ä¸¾ä¾‹ã€‚


![image.png](/img/posts/2023-12-6/2023-12-6-5.png)

*   éå†æ€è·¯ï¼šä»æ ¹èŠ‚ç‚¹å¼€å§‹ï¼Œä»¥æ­¤éå†æ¯ä¸€ä¸ªç»è¿‡çš„èŠ‚ç‚¹çš„ child å’Œ sibling

ä¼ªä»£ç å®ç°ï¼š

```js
function linkedListTraverse(root) {
  let wip = root;

  while (wip) {
    console.log(wip);

    if (wip.child) {
      temp = wip.child;
      wip.child = null; // éå†è¿‡å°±å‰”é™¤
      wip = temp;
      continue;
    }

    if (wip.sibling) {
      temp = wip.sibling;
      wip.sibling = null; // éå†è¿‡å°±å‰”é™¤
      wip = temp;
      continue;
    }

    wip = wip.return;
  }
}
```52:T68a2,2023 å¹´ï¼Œ CSS é¢†åŸŸæœ‰äº†æ–°çš„å˜åŒ–ï¼Œæ•´ä½“è¶‹åŠ¿æ˜¯æ›´åŠ çš„æ˜“ç”¨ï¼Œå¹¶è´´åˆæµè¡Œçš„æ¡†æ¶åšäº†æ‰©å±•ã€‚Chrome çš„å¼€å‘è€… blog å’Œ MDN é‡Œæ›´æ–°äº†ä¸€äº›æ¯”è¾ƒæœ‰æ„æ€çš„ CSS 2023 åŠ¨å‘çš„å†…å®¹ï¼Œæ–‡ç« æ¯”è¾ƒé•¿ï¼Œå†…å®¹æœ‰ç‚¹ä¹±ï¼Œè¿™é‡Œæ€»ç»“åˆ†äº«ä¸€ä¸‹ç»™å¤§å®¶ã€‚

## 1. æ‘˜è¦

æœ¬æ–‡æ˜¯ â€œ2023 å¹´åº¦æŠ€æœ¯ç›˜ç‚¹â€ ç³»åˆ—æ–‡ç« ï¼Œä¸»è¦ä»‹ç»å‰ç«¯ CSS é¢†åŸŸåœ¨ 2023 å¹´çš„é‡è¦è¿›å±•ã€‚æœ¬æ–‡ä» CSS åŸºç¡€åŠŸèƒ½ã€æ’ç‰ˆã€é¢œè‰²ã€è‡ªé€‚åº”è®¾è®¡ã€äº¤äº’å’Œç»„ä»¶ç­‰æ–¹é¢è¿›è¡Œç›˜ç‚¹ã€‚

> å¯ä»¥æŸ¥çœ‹æ–‡ç« ç›®å½•ä»¥é€‰æ‹©æŸ¥çœ‹è‡ªå·±æ„Ÿå…´è¶£çš„æ›´æ–°

## 2. åŸºç¡€åŠŸèƒ½

css æ–°å¢äº†ä¸‰è§’å‡½æ•°ç›¸å…³å‡½æ•°ï¼š`sin()`ã€`cos()`ã€`tan()`ã€`asin()`ã€`acos()`ã€`atan()` å’Œ `atan2()`ã€‚

ä¸‰è§’å‡½æ•°çš„ä½¿ç”¨è¦å’Œ `calc` ç»“åˆæ‰èƒ½å‡ºæ•ˆæœã€‚

#### ä¸‰è§’å‡½æ•°

![image.png](/img/posts/2024-1-2/2024-1-2-1.png)

-   `cos()`ï¼šè¿”å›è§’åº¦çš„ä½™å¼¦å€¼ï¼Œè¯¥å€¼ä»‹äºÂ `-1`Â å’ŒÂ `1`Â ä¹‹é—´ã€‚
-   `sin()`ï¼šè¿”å›è§’åº¦çš„æ­£å¼¦å€¼ï¼Œè¯¥å€¼ä»‹äºÂ `-1`Â å’ŒÂ `1`Â ä¹‹é—´ã€‚
-   `tan()`ï¼šè¿”å›è§’åº¦çš„æ­£åˆ‡å€¼ï¼Œå–å€¼ä»‹äºÂ `âˆ’âˆ`Â å’ŒÂ `+âˆ`Â ä¹‹é—´ã€‚

ä»¥æ­£å¼¦ä¸ºä¾‹ï¼Œä½ å¯ä»¥è¿™ä¹ˆå†™ï¼š`width: calc(sin(var(--angle)) * 200px);` æ¥è®¡ç®—å®½åº¦å€¼ã€‚

æˆ‘ä»¬å®ç°ä¸€ä¸ªè®¡ç®—è§’åº¦å‚çº¿é•¿åº¦çš„é—®é¢˜æ¥è¯´æ˜ sin çš„ç”¨æ³•ã€‚ä¸‹é¢çš„ä¾‹å­é‡Œï¼Œç»¿è‰²è™šçº¿çš„é•¿åº¦å°±æ˜¯ `æ–œè¾¹ï¼ˆ200pxï¼‰* sin(è§’åº¦)` è®¡ç®—å‡ºæ¥çš„ï¼š

[å®ç° sin è®¡ç®—ä¸‰è§’å½¢è¾¹é•¿](https://code.juejin.cn/pen/7317184041529114662)

> ç”±äº chrome çš„ css ä¸æ”¯æŒ rem() å’Œ mod() ç­‰å–æ¨¡å‡½æ•°ï¼Œæ‰€ä»¥ç”¨äº†ä¸¤ä¸ª css å˜é‡è¡¨ç¤º 180deg å‰åçš„è§’åº¦

> ç ä¸Šæ˜é‡‘æ€ä¹ˆä¸æ”¯æŒç›´æ¥é¢„è§ˆäº†ï¼Œæˆ‘æ”¾ä¸ªæˆªå›¾å§...


![image.png](/img/posts/2024-1-2/2024-1-2-2.png)


åŒç†ï¼Œcos å’Œ tan å¯ä»¥å¦‚ä¸‹ä½¿ç”¨ï¼š

```css
transform: scaleX(cos(var(--angle)))
transform: scaleX(tan(var(--angle)));
```

å®˜æ–¹demoï¼šhttps://codepen.io/web-dot-dev/pen/NWLxROo

#### åä¸‰è§’å‡½æ•°

åä¸‰è§’å‡½æ•°æ˜¯ä¸‰è§’å‡½æ•°çš„é€†è¿ç®—ï¼ŒåŒ…å«ï¼š`asin()`ã€`acos()`ã€`atan()`Â å’ŒÂ `atan2()`ã€‚å‰ä¸‰ä¸ªæ¥å—ä¸€ä¸ªæ•°å€¼ï¼Œè¿”å›å¯¹åº”çš„è§’åº¦å€¼ã€‚

ç¬¬å››ä¸ª `atan2()`ï¼Œæ¥å—ä¸¤ä¸ªå‚æ•°Â `A`Â å’ŒÂ `B`ã€‚è¿”å› X è½´æ­£è½´ä¸Â `(B, A)`Â ç‚¹ä¹‹é—´çš„è§’åº¦ã€‚

> atan2å¯¹è±¡é™æ•æ„Ÿï¼Œæ ¹æ®ä¸¤ä¸ªå‚æ•°åˆ¤æ–­å®ƒæ˜¯å±äºå“ªä¸ªè±¡é™å¹¶ç»™å‡ºå¯¹åº”çš„è§’åº¦å€¼ï¼Œå€¼åŸŸèŒƒå›´[-pi, pi]ï¼›atanå¯¹è±¡é™ä¸æ•æ„Ÿï¼Œå€¼åŸŸèŒƒå›´ä¸º[-pi/2, pi/2]

ä¸‹é¢è¿˜æ˜¯ä¸¾ä¸ªä¾‹å­æ¥è¯´æ˜ `atan()`Â å’ŒÂ `atan2()` çš„åŒºåˆ«ã€‚

[åä¸‰è§’å‡½æ•°ç¤ºä¾‹](https://code.juejin.cn/pen/7317462707643351092)

ä¸‹ä¸€ä¸ªæ–°åŠŸèƒ½æ˜¯ `n-*` çš„é€‰æ‹©å™¨ã€‚å¤§å®¶ä¹‹å‰ä¹Ÿéƒ½ç”¨è¿‡è¯¸å¦‚ :nth-of-type è¿™æ ·çš„ä¼ªç±»æ¥å®ç°å…ƒç´ é€‰æ‹©ï¼Œç°åœ¨å®˜æ–¹å¢å¼ºäº†è¿™ä¸ªåŠŸèƒ½ï¼Œä½¿ç”¨ S è¯­æ³•æ¥æ›´å¥½åœ°æ§åˆ¶ :nth-child() é€‰æ‹©ï¼š `:nth-child()`Â å’ŒÂ `:nth-last-child()`ã€‚

#### n-* é€‰æ‹©å™¨ ä¸ S è¯­æ³•


![image.png](/img/posts/2024-1-2/2024-1-2-3.png)

ä½¿ç”¨ä¾‹å­ï¼š

-   `:nth-child(2)`ï¼šé€‰æ‹©ç¬¬äºŒä¸ªå­çº§ã€‚
-   `:nth-child(2n)`ï¼šé€‰æ‹©æ‰€æœ‰å¶æ•°å­é¡¹ï¼ˆä¾‹å¦‚ 2ndã€4thã€6thã€8th ç­‰ï¼‰ã€‚**
-   `:nth-child(2n+1)`ï¼šé€‰æ‹©æ‰€æœ‰å¥‡æ•°å­é¡¹ï¼ˆç¬¬ 1ã€3ã€5ã€7ï¼Œä¾æ­¤ç±»æ¨ï¼‰ã€‚**
-   `:nth-child(5n+1)`ï¼šé€‰æ‹©ç¬¬ 1 ä¸ªÂ  *(=(5Ã—0)+1)* ã€ç¬¬ 6 ä¸ªÂ  *(=(5Ã—1)+1)* ã€ç¬¬ 11 ä¸ªÂ  *(=(5Ã—2)+1)* ...å­çº§ã€‚
-   `:nth-child(5n+2)`ï¼šé€‰æ‹©ç¬¬ 2 ä¸ªÂ  *(=(5Ã—0)+2)* ã€ç¬¬ 7 ä¸ªÂ  *(=(5Ã—1)+2)* ã€ç¬¬ 12 ä¸ªÂ  *(=(5Ã—2)+2)* ... å­é¡¹ã€‚

é‡Œè¾¹çš„é€‰æ‹©é¡¹å¯ä»¥æ˜¯ç­‰å·®æ•°åˆ—ï¼Œç­‰æ¯”æ•°åˆ—ï¼Œæˆ–è€…æ˜¯è‡ªå®šä¹‰çš„ä»»æ„æ•°åˆ—ï¼Œç”šè‡³å¯ä»¥ç»„åˆä½¿ç”¨ï¼š

-   `:nth-child(n+3)`ï¼šé€‰æ‹©ä»ç¬¬ 3 ä¸ªå¼€å§‹çš„æ¯ä¸ªå­çº§ã€‚
-   `:nth-child(-n+5)`ï¼šé€‰æ‹©ä¸è¶…è¿‡ç¬¬ 5 ä¸ªå­çº§ï¼ˆç¬¬ 1 ä¸ªã€ç¬¬ 2 ä¸ªã€ç¬¬ 3 ä¸ªã€ç¬¬ 4 ä¸ªã€ç¬¬ 5 ä¸ªã€‚
-   `:nth-child(n+3):nth-child(-n+5)`ï¼šé€‰æ‹©ç¬¬ 3 ä¸ªåˆ°ç¬¬ 5 ä¸ªï¼ˆç¬¬ 3 ä¸ªã€ç¬¬ 4 ä¸ªã€ç¬¬ 5 ä¸ªï¼‰çš„æ¯ä¸ªå­çº§ã€‚

åŒç†ï¼Œ`:nth-last-child()`Â ï¼Œä¹Ÿå¯ä»¥è¿›è¡Œç±»ä¼¼çš„é€‰æ‹©ï¼Œä½†ä¸æ˜¯ä»å¤´å¼€å§‹è®¡æ•°ï¼Œè€Œæ˜¯ä»å¤´å¼€å§‹è®¡æ•°ã€‚

ä¸‹é¢ç»™ä¸€ä¸ªåˆ›å»ºæ–‘é©¬çº¹ç¤ºä¾‹ï¼š

```css
tr:nth-child(even) {
Â  background-color: #E9E9E9;
}

// å¦ä¸€ç§å†™æ³•
tr:nth-of-type(even){ 
  background: #E9E9E9;
}
```

> â€œnth-of-typeâ€å’Œâ€œnth-childâ€çš„åŒºåˆ«ï¼šp:nth-of-type(7)é€‰æ‹©çš„på…ƒç´ æ‰€åœ¨çš„çˆ¶å…ƒç´ ä¸‹çš„ç¬¬7ä¸ªPå…ƒç´ å³ï¼šç¬¬7ä¸ªpï¼›p:nth-child(6)é€‰æ‹©çš„på…ƒç´ æ‰€åœ¨çš„çˆ¶å…ƒç´ ä¸‹çš„ç¬¬6ä¸ªå­å…ƒç´ ï¼Œä¸”è¯¥å…ƒç´ æ˜¯På…ƒç´ ã€‚

nth-child è¿˜å¯ä»¥ç»“åˆ S è¯­æ³•ä½¿ç”¨ï¼š

```css
:nth-child(An+B [of S]?)
:nth-last-child(An+B [of S]?)
```
æŒ‡å®šÂ `of S`Â åï¼Œ`An+B`Â é€»è¾‘ä»…åº”ç”¨äºä¸ç»™å®šé€‰æ‹©å™¨åˆ—è¡¨Â `S`Â åŒ¹é…çš„å…ƒç´ ã€‚è¿™å®é™…ä¸Šæ„å‘³ç€ï¼Œæ‚¨å¯ä»¥åœ¨Â `An+B`Â æ‰§è¡Œæ“ä½œä¹‹å‰é¢„å…ˆè¿‡æ»¤å­é¡¹ï¼š

```css
:nth-child(2 of .highlight) {
  /* = Select the 2nd child element that has the class .highlight applied to it */
  outline: 0.3rem dashed hotpink;
  outline-offset: 0.7rem;
}
```
ä¸Šé¢çš„ä¾‹å­ï¼Œé€‰æ‹©äº†çˆ¶å…ƒç´ ç›’å­ä¸­ï¼Œç±»åå« highlight ä¸­çš„ç¬¬äºŒä¸ªå­å…ƒç´ ï¼ˆæ³¨æ„ä¸æ˜¯ç‰©ç†é¡ºåºçš„ç¬¬äºŒä¸ªï¼‰æ¥èµ‹å€¼æ ·å¼ã€‚

å†ä¸¾ä¸ªä¾‹å­ï¼Œä¸Šé¢çš„æ–‘é©¬çº¹è¿˜å¯ä»¥å¢å¼ºï¼š

```css
// ç­›é€‰æ²¡æœ‰ hidden å±æ€§çš„åˆ—ï¼Œç„¶åå†è®¡ç®—æ–‘é©¬çº¹
tr:nth-child(even of :not([hidden])) {
Â  background-color: lightgrey;
}
```

#### `@scope`

![image.png](/img/posts/2024-1-2/2024-1-2-4.png)

Chrome 118+ å¢åŠ äº†å¯¹Â `@scope`Â çš„æ”¯æŒï¼Œè¿™æ˜¯ä¸€é¡¹ @ è§„åˆ™ï¼Œå¯å°†é€‰æ‹©å™¨çš„èŒƒå›´é™å®šä¸ºæ–‡æ¡£çš„ç‰¹å®šå­æ ‘ï¼Œä»è€Œæ§åˆ¶ css ä½œç”¨åŸŸï¼Œè¿™å¯¹äºå°†æ¥éœ€è¦åš css éš”ç¦»çš„ä¸šåŠ¡åœºæ™¯æœ‰å¤§ç”¨å¤„ï¼š

```css
@scope (html) {
  .warning {
    display: none;
  }
}

/* Only match elements in the card component, but donâ€™t target those in nested components */
@scope (.card) to ([data-component]) {
  img {
    border: 0.25em solid #6300ff;
    border-radius: 0.5em;
  }
}
```

ä¸Šé¢çš„ç¬¬äºŒä¸ªä¾‹å­ï¼Œåªä½œç”¨äº card ç±»ï¼Œè€Œä¸ä½œç”¨äºå…¶åŒ…å«data-componentå±æ€§çš„å­å…ƒç´ ï¼Œå³ cardç±» å’Œ \[data-component] ä¹‹é—´çš„å…ƒç´ ã€‚


å®˜ç½‘demoï¼šhttps://codepen.io/web-dot-dev/pen/YzdOydZ

#### `@layer åµŒå¥—`


![image.png](/img/posts/2024-1-2/2024-1-2-5.png)

> å…¶å®è¿™ä¸ªç‰¹æ€§22å¹´å°±æœ‰äº†

å®˜æ–¹ css æ˜¾ç„¶æ˜¯å¸å–äº†å„ä¸ªå‰ç«¯æ¡†æ¶å’Œé¢„å¤„ç†å™¨çš„ç»éªŒï¼Œå¹¶è¿›è¡Œäº†å‡çº§ï¼Œç°åœ¨ css ä¹Ÿè¦æ”¯æŒåµŒå¥—äº†ã€‚


ä¹‹å‰è¿™æ ·çš„å†™æ³•ï¼š

```css
ul li {}
ul li .child {
  color: red;
}
```

ç°åœ¨å¯ä»¥è¿™æ ·å†™äº†ï¼š

```css
@layer test {
    ul {
      li {
        & .child {
          color: red;
        }
      }
    }
    
    .card {
      &--header {
        /* is not equal to ".card--header" */
      }
    }
}
```

> å½“ç„¶ç›´æ¥åµŒå¥—ï¼Œä¸ä½¿ç”¨ @layer ä¹Ÿæ˜¯å¯ä»¥çš„

ä½¿ç”¨å…·å `@layer` åŒ…è£¹çš„ css ç‰‡æ®µå¯ä»¥æ”¯æŒåµŒå¥—ä¼˜å…ˆçº§é…ç½®ã€‚

```css
@layer base, special;

@layer special {
  .item {
    color: red;
  }
}

@layer base {
  .item {
    color: green;
    border: 5px solid green;
    font-size: 1.5em;
    padding: 0.5em;
  }
}
```
é¢„å…ˆå®šä¹‰å„ä¸ªå…·ålayerçš„ä¼˜å…ˆçº§ï¼Œä»å·¦åˆ°å³ä¾æ¬¡é™ä½ï¼Œä¸Šé¢çš„ item ç±»å…ƒç´ ï¼Œæœ€åä¼šè¢«åŠ ä¸Šçº¢è‰²çš„é¢œè‰²ï¼Œè€Œä¸æ˜¯ç»¿è‰²ã€‚

#### å­ç½‘æ ¼å¸ƒå±€

![image.png](/img/posts/2024-1-2/2024-1-2-6.png)

æˆ‘ä»¬éƒ½çŸ¥é“æœ‰ grid å¸ƒå±€ï¼Œç°åœ¨è¿æ¥äº†å¢å¼ºï¼ŒåŠ å…¥äº† subgrid å¸ƒå±€ã€‚

æˆ‘ä»¬è¿™ä¹ˆå®šä¹‰ä¸€ä¸ªç½‘æ ¼å¸ƒå±€ï¼š

```css
.container {
Â  display: grid;
Â  gap: 1rem;
Â  grid-template-columns: [column-1] 20ch [column-2] 1fr;
}
```
ç½‘æ ¼æœ‰ä¸¤åˆ—ï¼Œä¸€åˆ—ç»™20chï¼Œä¸€åˆ—å é¢†å‰©ä½™ç©ºé—´ï¼š


![image.png](/img/posts/2024-1-2/2024-1-2-7.png)

æˆ‘ä»¬ç°åœ¨å®šä¹‰å­ç½‘æ ¼ï¼š

```css
.container > div {
Â  grid-column: span 2;

Â  display: grid;
Â  grid-template-columns: subgrid; /* 20ch 1fr */
}
```

![image.png](/img/posts/2024-1-2/2024-1-2-8.png)

è¿™æ ·ä¸€æ¥ï¼Œå­ div è™½ç„¶è¿˜æ˜¯å äº†ä¸€è¡Œï¼Œä½†æ˜¯ä»–ç»§æ‰¿äº†çˆ¶å…ƒç´ çš„ç½‘æ ¼å¸ƒå±€ï¼Œå³çˆ¶ç½‘æ ¼çš„åˆ—å·²ç»æœ‰æ•ˆå‘ä¸‹ä¼ é€’åˆ°å­ç½‘æ ¼ï¼Œåœ¨å„ä¸ªå­ div å†…éƒ¨å†å®ç°å¸ƒå±€æ—¶å°±å¯ä»¥ç›´æ¥ä½¿ç”¨ã€‚æœ€æ–°çš„æµè§ˆå™¨ä¸­ä¹Ÿæ ‡æ˜äº†è¿™ç§å¸ƒå±€ï¼š


![image.png](/img/posts/2024-1-2/2024-1-2-9.png)

demo å¦‚ä¸‹ï¼š[å­ç½‘æ ¼å¸ƒå±€ demo](https://code.juejin.cn/pen/7317532251985313830)

çœ‹çœ‹ä½ çš„æµè§ˆå™¨æ”¯ä¸æ”¯æŒï¼Œå¯ä»¥è¿™æ ·ï¼š

```css
@supports (grid-template-columns: subgrid) {
  /* safe to enhance to */
}
```

å®˜æ–¹demoï¼šhttps://codepen.io/web-dot-dev/pen/MWLENzm

## 3. æ’ç‰ˆ

2023 å¹´ï¼Œcss ä¹Ÿå¼€å§‹é’ˆå¯¹æ’ç‰ˆæ›´æ–°äº†ï¼Œå¯èƒ½æ˜¯å€Ÿé‰´äº† Tailwind çš„ç»éªŒ...

#### é¦–å­—æ¯

![image.png](/img/posts/2024-1-2/2024-1-2-10.png)

Chrome 110 ä¸­æ¨å‡ºäº†Â `initial-letter`Â å±æ€§ï¼Œå¯ä»¥å°†é¦–å­—æ¯æŠ¬èµ·æˆ–é™ä½ã€‚

ç¤ºä¾‹ï¼š`<p>Lorem ipsum dolor ...</p>`

```css
p {
  &::first-letter {
    initial-letter: 3 2;
    color: green;
  }
}
```

æ ¸å¿ƒç‚¹æ˜¯ `first-letter` ä¼ªå…ƒç´ ï¼Œä»–åœ¨ DOM ç»“æ„æ ‘ä¸­ä¸ä¼šä½“ç°å‡ºæ¥ï¼ˆæ‰€ä»¥æœ‰äº›è¿·ï¼Œè°ƒè¯•æœ‰å›°éš¾ï¼Œå¹½çµå…ƒç´ ï¼Ÿï¼‰ï¼Œå…¶ä¸­å¯é€‰é¡¹ initial-letter å¯ä»¥è®¾ç½®å…¶åç§»é‡ï¼Œä¸Šé¢çš„ä¾‹å­è¡¨ç¤ºé¦–å­—æ¯é«˜åº¦å ç”¨ 3 è¡Œï¼Œä¸‹æ²‰ 2 è¡Œï¼š


![image.png](/img/posts/2024-1-2/2024-1-2-11.png)

> é¦–å­—æ¯å±æ€§åŒæ ·æ”¯æŒä¸­æ–‡

#### æ–‡å­—æŠ˜è¡Œä¼˜åŒ–

![image.png](/img/posts/2024-1-2/2024-1-2-12.png)

æ–°å¢ä¸¤ç§å†™æ³• `text-wrap: balance` å’Œ `text-wrap: pretty`ï¼Œå®˜æ–¹è§£é‡Šè¯·ç§»æ­¥ï¼šhttps://www.w3.org/TR/css-text-4/#text-wrapã€‚

å‰è€…æ˜¯æµè§ˆå™¨ä¸ºæ–‡æœ¬æ‰¾å‡ºæœ€ä½³çš„å‡è¡¡æ¢è¡Œè§£å†³æ–¹æ¡ˆï¼š


![image.png](/img/posts/2024-1-2/2024-1-2-13.png)

emmï¼Œæ€ä¹ˆæ„Ÿè§‰è¿˜ä¸å¦‚åŸæ¥ã€‚ã€‚ã€‚æ¨èä½¿ç”¨ prettyï¼Œè‡³å°‘èƒ½å·¦å³å¯¹é½ã€‚

## 4. é¢œè‰²

é¢œè‰²æ–¹é¢æ˜¯å·²æœ‰é¢œè‰²åº“çš„æ‰©å……ï¼Œå¢åŠ äº†æ›´å¤šçš„é¢œè‰²å’Œå¯é€‰é¡¹ã€‚å®˜æ–¹çš„è¯´æ³•æ˜¯ï¼ŒåŸæ¥çš„ CSS ä¸æ”¯æŒé«˜æ¸…ç”»è´¨ï¼Œè€Œå¤§å¤šæ•°äººæ”¾åœ¨å£è¢‹é‡Œã€æ”¾åœ¨èº«ä¸Šæˆ–å®‰è£…åœ¨å¢™ä¸Šçš„æ˜¾ç¤ºå±å…·æœ‰å¹¿è‰²åŸŸå’Œé«˜æ¸…è‰²å½©ã€‚æ˜¾ç¤ºå±çš„é¢œè‰²å¤„ç†é€Ÿåº¦æ¯” CSS å¿«ï¼Œç°åœ¨ CSS çš„æ›´æ–°å¯ä»¥ä¸ä¹‹ä¸€è¾ƒé«˜ä½äº†ã€‚

#### é«˜æ¸… CSS

CSSÂ [Color Level 4](https://www.w3.org/TR/css-color-4) æå‡ºäº†é«˜æ¸… CSS æ–¹æ¡ˆï¼Œä» Chrome 111 å¼€å§‹æ”¯æŒè‰²å½©ç©ºé—´å’Œè‰²åŸŸï¼Œä»–æ˜¯åœ¨å·²æœ‰è‰²åŸŸçš„åŸºç¡€ä¸Šçš„é¢œè‰²æ‰©å……ï¼Œä»¥é€‚åº”ç°åœ¨æ›´åŠ é«˜æ¸…æ˜¾ç¤ºçš„æ˜¾ç¤ºè®¾å¤‡ã€‚

å®˜æ–¹æ¨å‡º 7 ä¸­è‰²åŸŸï¼š

-   [sRGB](https://developer.chrome.com/docs/css-ui/high-definition-css-color-guide?hl=zh-cn#srgb)
-   [RGB 98](https://developer.chrome.com/docs/css-ui/high-definition-css-color-guide?hl=zh-cn#a98-rgb)
-   [Display p3](https://developer.chrome.com/docs/css-ui/high-definition-css-color-guide?hl=zh-cn#display-p3)
-   [Rec2020](https://developer.chrome.com/docs/css-ui/high-definition-css-color-guide?hl=zh-cn#rec2020)
-   [ProPhoto](https://developer.chrome.com/docs/css-ui/high-definition-css-color-guide?hl=zh-cn#prophoto-rgb)
-   [ç¾å›½å•†ä¸šè¡Œä¸šä¿¡æ¯ç½² (CIE)](https://en.wikipedia.org/wiki/CIE_1931_color_space)
-   [HVS](https://www.cs.rochester.edu/courses/572/colorvis/gamutvis.html)ï¼ˆäººåƒè‰²åŸŸï¼‰

é¢œè‰²ç©ºé—´æ˜¯è‰²åŸŸçš„æ’åˆ—ï¼Œå®ƒå»ºç«‹äº†å½¢çŠ¶ä»¥åŠè·å–é¢œè‰²çš„æ–¹æ³•ã€‚é¢œè‰²çº§åˆ« 4 å¼•å…¥äº† 12ä¸­é¢œè‰²ç©ºé—´ç”¨äºä»è‰²åŸŸä¸­æŸ¥æ‰¾é¢œè‰²ï¼š

-   [sRGB çº¿æ€§](https://developer.chrome.com/docs/css-ui/high-definition-css-color-guide?hl=zh-cn#linear-srgb)
-   [LCH](https://developer.chrome.com/docs/css-ui/high-definition-css-color-guide?hl=zh-cn#lch)
-   [okLCH](https://developer.chrome.com/docs/css-ui/high-definition-css-color-guide?hl=zh-cn#oklch)
-   [å®éªŒ](https://developer.chrome.com/docs/css-ui/high-definition-css-color-guide?hl=zh-cn#lab)
-   [okLAB](https://developer.chrome.com/docs/css-ui/high-definition-css-color-guide?hl=zh-cn#oklab)
-   [Display p3](https://developer.chrome.com/docs/css-ui/high-definition-css-color-guide?hl=zh-cn#display-p3)
-   [Rec2020](https://developer.chrome.com/docs/css-ui/high-definition-css-color-guide?hl=zh-cn#rec2020)
-   [a98 RGB](https://developer.chrome.com/docs/css-ui/high-definition-css-color-guide?hl=zh-cn#a98-rgb)
-   [ProPhoto RGB](https://developer.chrome.com/docs/css-ui/high-definition-css-color-guide?hl=zh-cn#prophoto-rgb)
-   [XYZ](https://developer.chrome.com/docs/css-ui/high-definition-css-color-guide?hl=zh-cn#xyz-xyz-d50-xyz-d65)
-   [XYZ d50](https://developer.chrome.com/docs/css-ui/high-definition-css-color-guide?hl=zh-cn#xyz-xyz-d50-xyz-d65)
-   [XYZ d65](https://developer.chrome.com/docs/css-ui/high-definition-css-color-guide?hl=zh-cn#xyz-xyz-d50-xyz-d65)

ä¹‹å‰åªæœ‰å››ç§é¢œè‰²ç©ºé—´ï¼š

-   [Hex](https://developer.chrome.com/docs/css-ui/high-definition-css-color-guide?hl=zh-cn#hex), å³ 16è¿›åˆ¶é¢œè‰²
-   [RGB](https://developer.chrome.com/docs/css-ui/high-definition-css-color-guide?hl=zh-cn#rgb)
-   [HSL](https://developer.chrome.com/docs/css-ui/high-definition-css-color-guide?hl=zh-cn#hsl)
-   [HWB](https://developer.chrome.com/docs/css-ui/high-definition-css-color-guide?hl=zh-cn#hwb)

çŸ¥é“äº†æ¦‚å¿µï¼Œæˆ‘ä»¬æ¥çœ‹å‡ ç§æ–°çš„é¢œè‰²å®šä¹‰ã€‚

###### HWB


![image.png](/img/posts/2024-1-2/2024-1-2-14.png)

HWBï¼ˆè‰²ç›¸ã€ç™½åº¦ã€é»‘åº¦ï¼‰æ˜¯é¢å‘äººç±»æè¿°é¢œè‰²çš„ sRGB è‰²åŸŸé¢œè‰²ç©ºé—´ï¼š

```css
--modern: hwb(200deg 25% 25%);
```

###### `color()`Â å‡½æ•°


![image.png](/img/posts/2024-1-2/2024-1-2-15.png)

color() æ˜¯ä¸€ä¸ªæ ‡å‡†åŒ–ç©ºé—´ï¼Œç”¨äºè®¿é—®ä½¿ç”¨ RGB é€šé“çš„é¢œè‰²ç©ºé—´ã€‚è€Œä¸”å¯æ‰©å®¹è‡³åŸºäº RGB çš„ä»»ä½•å¹¿è‰²åŸŸè‰²å½©ç©ºé—´ã€‚ä½¿ç”¨ä¸¾ä¾‹ï¼š

```css
--display-p3: color(display-p3 1 1 1);
--srgb: color(srgb 1 1 1);
```

ç”šè‡³ä¹‹å‰çš„ rgb ä¹Ÿå¯ä»¥è¿™ä¹ˆç»Ÿä¸€æ¥å†™ï¼š

```css
--rgb: color(rgb 25 25 25)
```

###### å…¶ä»–

æ­¤å¤–è¿˜æœ‰ lch / lab / oklch / OKLAB / dispaly-p3 ç­‰é¢œè‰²ç©ºé—´ï¼Œç”±äºä¸œè¥¿å¤ªå¤šäº†ï¼Œå°±ä¸ä¸€æ ·åˆ—å‡ºï¼Œä¸Šé¢æœ‰é“¾æ¥ï¼Œå¯ä»¥è‡ªè¡Œç‚¹å‡»æŸ¥çœ‹ã€‚è¿™ç±»CIE ç©ºé—´é¢œè‰²éƒ½èƒ½å¤Ÿæ›´å¥½çš„è¡¨ç¤ºæ•´ä¸ªäººç±»å¯è§çš„è‰²è°±ã€‚ä½¿ç”¨æ–°çš„é¢œè‰²ç©ºé—´è¿˜ä¼šå½±å“é¢œè‰²æ¸å˜å’Œæ’å€¼ç­‰åŠŸèƒ½ã€‚

#### color-mix()

![image.png](/img/posts/2024-1-2/2024-1-2-16.png)

ä»–æ˜¯ç”¨äºé¢œè‰²æ··æ·†çš„å‡½æ•°ï¼Œçµæ„Ÿå¯èƒ½ä¹Ÿæ˜¯æ¥è‡ªcssé¢„å¤„ç†å™¨ã€‚

å®˜æ–¹demoï¼šhttps://codepen.io/web-dot-dev/pen/JjBZLrm

ä¸ºäº†ä¾¿äºç†è§£ï¼Œæˆ‘ä»¬è¿™é‡Œå®ç°ä¸€ä¸ªç®€å•çš„åˆ‡æ¢é¢œè‰²çš„ä¾‹å­ï¼š

[ä¸»é¢˜é¢œè‰²åˆ‡æ¢](https://code.juejin.cn/pen/7317573307016806435)

ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œå„ä¸ªä¸»é¢˜çš„é¢œè‰²ï¼Œé€šè¿‡æ··æ·†å¾—æ¥ã€‚æˆ‘ä»¬æ‹¿ä¸€ä¸ªæ¥è¯´æ˜ä½¿ç”¨æ–¹å¼ã€‚

`color-mix(in oklab, #0af 25%, black)`ï¼šåœ¨ oklab è‰²åŸŸç©ºé—´å†…ï¼Œå°†å¤©è“è‰²çš„25%ä¸é»‘è‰²æ··åˆã€‚æ­¤æ—¶æ–‡å­—çš„é¢œè‰²å¦‚ä¸‹ï¼š


![image.png](/img/posts/2024-1-2/2024-1-2-17.png)

çœ‹ç€æ˜¯é»‘è‰²çš„ï¼Œå…¶å®æœ‰ç‚¹è“éŸµã€‚å¦‚æœå°† 25% è°ƒæ•´åˆ° 75% å°±ä¼šæ˜æ˜¾äº†ï¼š


![image.png](/img/posts/2024-1-2/2024-1-2-18.png)

#### from å…³é”®å­—

å¯ä»¥çœ‹åšæ˜¯ color-mix çš„æ‰©å±•å¢å¼ºï¼š

`color: rgb(from green r g b)`

ç­‰ä»·äº ` color: rgb(0 128 0)`ï¼Œæ„æ€æ˜¯ä» green å¼€å§‹ï¼Œæ‹¿åˆ° rgb çš„å€¼ï¼Œå¹¶åœ¨ä¹‹åçš„å‚æ•°ä¸­ä½¿ç”¨ï¼Œä»–è®¡ç®—çš„æ˜¯è½¬æ¢åçš„ç›¸å¯¹é¢œè‰²ã€‚äºæ˜¯ä¼šæœ‰å¦‚ä¸‹å†™æ³•ï¼š

```css
// r g b æ˜¯ä¸‰ä¸ªå˜é‡ï¼Œå¯ä»¥æ¢é¡ºåºä½¿ç”¨
rgb(from green g g g) /* rgb(128 128 128) */
rgb(from green b r g) /* rgb(0 0 128) */
rgb(from green 0 0 g) /* rgb(0 0 128) */
```
å½“ç„¶èªæ˜çš„ä½ ä¹Ÿèƒ½çŒœåˆ°ï¼Œé€æ˜åº¦ä¹Ÿèƒ½å½“åšå˜é‡ï¼š

```css
rgb(from rgba(0, 128, 0, .5) r g b / alpha) /* alpha=50% */
```
ä¸Šé¢å°±ç›¸å½“äºå°†é¢œè‰²æ‰“æˆå„ä¸ªé€šé“åˆ†é‡æ¥å®ç°æ··æ·†ã€‚æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªï¼š`background: hsl(from blue calc(h + 180) s l)`.

è¿™ä¸ªæ˜¯ hsl çš„è½¬å˜ï¼Œå…¶ä¸­ç¬¬ä¸€ä¸ªé€šé“åˆ†é‡åŠ äº† 180 åè¿”å›ï¼Œå…¶å®æ˜¯æ±‚è“è‰²çš„äº’è¡¥è‰²ï¼š


![image.png](/img/posts/2024-1-2/2024-1-2-19.png)

## 5. å“åº”å¼è®¾è®¡

æ–°çš„ä¸€å¹´ï¼Œå“åº”å¼å¸ƒå±€åˆæœ‰äº†æ–°çš„å†™æ³•ã€‚

#### æŸ¥è¯¢å®¹å™¨å¤§å°


![image.png](/img/posts/2024-1-2/2024-1-2-20.png)

ç›¸æ¯”äºä¼ ç»Ÿçš„åª’ä½“æŸ¥è¯¢ï¼Œå®¹å™¨æŸ¥è¯¢æ›´åŠ ç»†ç²’åº¦ï¼Œä»–å¯ä»¥åº”ç”¨åœ¨å±€éƒ¨å®¹å™¨æˆ–è€…æŒ‡å®šå®¹å™¨å†…:

```css
container: card / inline-size;
```

è¿™æ ·å°±åˆ›å»ºäº†ä¸€ä¸ªå«åš card çš„é€‚åº”å†…åµŒå¤§å°çš„å“åº”å¼å®¹å™¨ï¼Œå¯ä»¥è¿™æ ·ä½¿ç”¨æŸ¥è¯¢ï¼š

```css
/* åªæœ‰ä¸€ä¸ªå®¹å™¨æ—¶ï¼Œåå­— card å¯ä»¥çœç•¥ */
@container card (max-width: 400px) {

}
```

æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªä¾‹å­ï¼š[å“åº”å¼å®¹å™¨](https://code.juejin.cn/pen/7317593902143012902)

#### å®¹å™¨æ ·å¼

æ­¤å¤–ï¼Œåœ¨ Chrome 111 ä¸­ï¼Œæ ·å¼æŸ¥è¯¢å·²éƒ¨åˆ†å®ç°ï¼šå¯ä»¥ä½¿ç”¨Â `@container style()`Â æŸ¥è¯¢çˆ¶å…ƒç´ ä¸Šçš„è‡ªå®šä¹‰å±æ€§çš„å€¼ã€‚æˆ‘ä»¬æ¥çœ‹ä¸ªä¾‹å­ï¼ˆå…¼å®¹æ€§ä¸å¥½ï¼‰ï¼š


![image.png](/img/posts/2024-1-2/2024-1-2-21.png)

```css
@container style(--theme: pink) {
  .demo-btn {
    background: linear-gradient(45deg, pink, violet);
    border: 4px double #f452dc;
  }
}
```
ä¸Šé¢çš„ä¾‹å­ï¼Œæ ¹æ®å˜é‡ theme çš„å€¼åŠ¨æ€æ·»åŠ æ ·å¼ï¼Œå®Œæ•´ demo å¦‚ä¸‹ï¼š

https://codepen.io/web-dot-dev/pen/GRXZLvW


#### :has()


![image.png](/img/posts/2024-1-2/2024-1-2-22.png)

å­—é¢æ„æ€å°±æ˜¯è¯´é€‰ä¸­æ‹¥æœ‰æŸä¸ªå±æ€§çš„å…ƒç´ ï¼š

```css
.card:has(.card__media) {
  --color: #6300ff;
}
```
ä¸Šé¢çš„ä»£ç ï¼Œæ˜¯é€‰ä¸­æ‹¥æœ‰ä¸€ä¸ªç±»å« card__media çš„ card å…ƒç´ ã€‚ä»–å¯ä»¥è®©ä½ åœ¨ä¼—å¤šç›¸åŒçš„ç±»åå« card çš„å…ƒç´ ä¸­é€‰ä¸­ä½ æƒ³è¦çš„ã€‚

å…¶ä¸ä½†å¯ä»¥åœ¨ DOM æ ‘ä¸­å‘ä¸Šé€‰æ‹©çˆ¶çº§å…ƒç´ ï¼Œä¹Ÿå¯ä»¥è¿›è¡Œæ¨ªå‘é€‰æ‹©ã€‚

æ¯”å¦‚æœ‰ä¸ªåˆ—è¡¨ï¼š

```html
<ul class="dock">
  <li></li>
  ...
  <li></li>
</ul>
```
æ¯ä¸€ä¸ª li é‡Œæ˜¯ä¸€ä¸ªåˆ—è¡¨å›¾ç‰‡ï¼Œæˆ‘ä»¬æƒ³å®ç°é¼ æ ‡æ»‘åŠ¨å˜å¤§ï¼Œè¿™ä¹ˆå†™ï¼š

```css
.dock li:hover {
  width: 3em;
}
.dock li:hover img {
  translate: 0% -15%;
}
```


![image.png](/img/posts/2024-1-2/2024-1-2-23.png)

å¦‚æœæƒ³å®ç° mac ç³»ç»Ÿé‚£ç§ï¼Œå·¦å³å›¾ç‰‡ä¹Ÿä¼šå˜å¤§çš„åŠ¨ç”»ï¼Œå¯ä»¥è¿™ä¹ˆå†™ï¼š

```css
.dock li:hover + li,
.dock li:has(+ li:hover) {
  width: 2.5em;
}
```
ä¸ä½†é€‰æ‹©å…¶ä¸‹ä¸€ä¸ªå…„å¼ŸèŠ‚ç‚¹ï¼Œè¿˜ä½¿ç”¨ has é€‰æ‹©å…¶ä¸Šä¸€ä¸ªå…„å¼ŸèŠ‚ç‚¹ï¼š


![image.png](/img/posts/2024-1-2/2024-1-2-24.png)

#### åª’ä½“æŸ¥è¯¢æœ‰äº†æ–°åŠŸèƒ½

åŸæ¥å·²æœ‰çš„åª’ä½“æŸ¥è¯¢åŠŸèƒ½å¾—åˆ°äº†å²è¯—çº§åŠ å¼ºã€‚

###### é€‚åº”è®¾å¤‡åˆ·æ–°ç‡

![image.png](/img/posts/2024-1-2/2024-1-2-25.png)

æ–°å¢å¦‚ä¸‹å†™æ³•ï¼š

```css
@media (update: none) {

}
```

å¯¹äºå¤§å¤šæ•°æ–°ç‰ˆè®¾å¤‡ï¼Œå…¶æ›´æ–°ä¸€èˆ¬æ˜¯ fastï¼Œä½†æ˜¯é’ˆå¯¹ç”µå­é˜…è¯»å™¨ä»¥åŠä½èƒ½è€—ä»˜æ¬¾ç³»ç»Ÿç­‰è®¾å¤‡ï¼Œå…¶åˆ·æ–°ç‡å¯èƒ½è¾ƒæ…¢ï¼Œå¯ä»¥ä½¿ç”¨ slow é€‚é…ï¼Œå…¶ä½™çš„åƒæ‰“å°æœºä¸€ç±»çš„ï¼Œå¯ä»¥è®¾ç½®ä¸º noneã€‚[demo](https://codepen.io/web-dot-dev/pen/PoyPMBw)

æ ¹æ®ä¸åŒçš„è®¾å¤‡åˆ·æ–°ç‡é‡‡ç”¨ä¸åŒçš„ CSS è¡¨ç°å½¢å¼ï¼Œæ„å‘³ç€æ‚¨å¯ä»¥èŠ‚çœç”µæ± ç”µé‡æˆ–å‡å°‘é”™è¯¯çš„è§†å›¾æ›´æ–°ã€‚ç”±äºä½“éªŒè€…ä¸å¯èƒ½å‡‘é½åˆ·æ–°ç‡ä¸åŒçš„è®¾å¤‡ä¸å¤ªå®¹æ˜“ï¼Œè¿™é‡Œä½¿ç”¨jsæ¥æ¨¡æ‹Ÿè¯´æ˜ï¼š

[å®˜æ–¹demoï¼šå°é¸­å­æ‘‡å¤´](https://code.juejin.cn/pen/7319044288761823258)

> demo æ˜¯ä½¿ç”¨jsæ¨¡æ‹Ÿåˆ·æ–°ç‡ä¸åŒçš„è®¾å¤‡ï¼Œå¹¶ä¸æ˜¯å¯¹ update çš„ä½¿ç”¨è¯´æ˜

###### åª’ä½“æŸ¥è¯¢æ£€æŸ¥jsè„šæœ¬


![image.png](/img/posts/2024-1-2/2024-1-2-26.png)

è„šæœ¬åª’ä½“æŸ¥è¯¢å¯ç”¨äºæ£€æŸ¥ JavaScript æ˜¯å¦å¯ç”¨ã€‚è¿™å¯¹äºæ¸è¿›å¼å¢å¼ºéå¸¸æœ‰ç”¨ã€‚åœ¨æ­¤åª’ä½“æŸ¥è¯¢æ¨å‡ºä¹‹å‰ï¼Œä¸€ä¸ªç”¨äºæ£€æµ‹ JavaScript æ˜¯å¦å¯ç”¨çš„ç­–ç•¥æ˜¯åœ¨ HTML ä¸­æ”¾ç½®ä¸€ä¸ªÂ `nojs`Â ç±»ï¼Œç„¶åä½¿ç”¨ JavaScript å°†å…¶ç§»é™¤ã€‚ç°åœ¨å¯ä»¥ä½¿ç”¨ css æ¥æ£€æµ‹äº†ï¼š

```css
@media (scripting: enabled) {
  .steam {
    opacity: 1;
  }
}
```

###### ç”¨äºå‡ä½é€æ˜åº¦çš„åª’ä½“æŸ¥è¯¢


![image.png](/img/posts/2024-1-2/2024-1-2-27.png)

éä¸é€æ˜ç•Œé¢å¯èƒ½ä¼šå¼•èµ·å¤´ç—›ï¼Œæˆ–è€…è®©å„ç±»è§†åŠ›ç¼ºé™·äººç¾¤é€ æˆè§†è§‰éšœç¢ã€‚å› æ­¤ï¼ŒWindowsã€macOS å’Œ iOS è®¾æœ‰ç³»ç»Ÿåå¥½è®¾ç½®ï¼Œå¯ä»¥é™ä½æˆ–ç§»é™¤ç•Œé¢çš„é€æ˜åº¦ã€‚è¿™ä¸ªé’ˆå¯¹Â `prefers-reduced-transparency`Â çš„åª’ä½“æŸ¥è¯¢éå¸¸é€‚åˆä½¿ç”¨å…¶ä»–åå¥½è®¾ç½®åª’ä½“æŸ¥è¯¢ï¼š

```css
svg {
    --transparency: 50%;
    
    @media (prefers-reduced-transparency: reduce) {
      --transparency: 95%;
    }
}
```

## 6. äº¤äº’

#### è§†å›¾è½¬æ¢ API


![image.png](/img/posts/2024-1-2/2024-1-2-28.png)

å®˜æ–¹è¯´æ˜æ˜¯å¢å¼ºcssè¿‡æ¸¡ï¼Œæ›´å¥½çš„å‡å°‘å¡é¡¿å’Œå›¾å½¢äº¤å ã€‚

ä½¿ç”¨ï¼š`const viewTransition = document.startViewTransition(updateCallback)`

ä½¿ç”¨æ–¹å¼å¾ˆåƒ requestAnimationFrameï¼Œè¿™ä¸ªæ˜¯åœ¨å½“å‰äº‹ä»¶å¾ªç¯ç»“æŸå‰æ‰§è¡Œå›è°ƒï¼Œè€Œæˆ‘ä»¬ä»Šå¤©çš„è¿™ä¸ª APIï¼Œä¼šæ•è·ç½‘é¡µçš„å½“å‰çŠ¶æ€ã€‚è¿™åŒ…æ‹¬æˆªå–å±å¹•æˆªå›¾ã€‚å®Œæˆåï¼Œç³»ç»Ÿä¼šè°ƒç”¨ä¼ é€’ç»™Â `.startViewTransition()`Â çš„å›è°ƒ updateCallbackã€‚è¿™æ­£æ˜¯ DOM å‘ç”Ÿå˜åŒ–çš„åœ°æ–¹ã€‚ç„¶åï¼ŒAPI ä¼šæ•è·ç½‘é¡µçš„æ–°çŠ¶æ€ã€‚

å®˜æ–¹è¯´æ˜å¦‚ä¸‹ï¼š[startViewTransition](https://developer.chrome.com/docs/web-platform/view-transitions/?hl=zh-cn#why_do_we_need_this_feature)ï¼Œ æœ‰å…´è¶£çš„å¯ä»¥è‡ªè¡ŒæŸ¥çœ‹ã€‚

#### linear()


![image.png](/img/posts/2024-1-2/2024-1-2-29.png)

è¯¥å‡½æ•°ç”¨äºæ¨¡æ‹Ÿçº¿æ€§æ’å€¼æ¥è¿‘ä¼¼è®¡ç®—åŠ /å‡é€Ÿç±»å‹çš„åŠ¨ç”»ã€‚ä½¿ç”¨æ–¹å¼å¦‚ä¸‹ï¼š

```css
:root {
  --custom-easing: linear(
    0,
    0.06,
    0.25 18%,
    1 36%,
    0.81,
    0.75,
    0.81,
    1,
    0.94,
    1,
    1
  );
}
```
å¯ä»¥æŸ¥çœ‹åœ¨çº¿ [demo](https://linear-easing-generator.netlify.app/) æ¥åˆ›å»ºä¸€ä¸ªä½¿ç”¨æ¡ˆä¾‹ã€‚

#### Scroll End API


![image.png](/img/posts/2024-1-2/2024-1-2-30.png)

å®˜æ–¹å¯¹æ»šåŠ¨äº‹ä»¶çš„å¢å¼ºï¼Œç»ˆäºæœ‰äº†è‡ªå·±çš„æ»šåŠ¨åˆ°åº•çš„æ£€æµ‹äº†ï¼Œè¿™å¯¹äºé•¿åˆ—è¡¨æ¸²æŸ“å¾ˆæœ‰å¸®åŠ©ï¼š

```js
document.onscrollend = event => {
  Toast('scroll end')
}
```

#### æ»šåŠ¨æ¡é©±åŠ¨åŠ¨ç”»

è¿™ä¸ªæ˜¯æ¯”è¾ƒæƒŠè‰³çš„æ›´æ–°äº†ï¼Œå¤§å¤šæ•°é—¨æˆ·ç½‘ç«™éƒ½æœ‰æ»šåŠ¨æ‡’åŠ è½½æˆ–è€…æ·¡å…¥æ·¡å‡ºçš„åŠ¨ç”»æ•ˆæœï¼Œè¿™æ¬¡æ”¹åŠ¨è¡¥å…¨äº†ä¹‹å‰åŸç”Ÿ css æ²¡æœ‰æ»šåŠ¨æ£€æµ‹çš„ç©ºç™½ã€‚

å®˜æ–¹æ¼”ç¤º demoï¼š[Scroll-driven Animations (scroll-driven-animations.style)](https://scroll-driven-animations.style/)

å…¶ä¸»è¦æ˜¯é€šè¿‡ `animation-timeline` å±æ€§è®¾ç½®é©±åŠ¨ï¼Œå¯é€‰çš„é©±åŠ¨æ–¹å¼æœ‰ `scoll` å’Œ `view`ã€‚æˆ‘ä»¬çœ‹ä¸‹é¢çš„ä¾‹å­ï¼š[æ»šåŠ¨åŠ¨ç”»](https://code.juejin.cn/pen/7319093484529877007)

`animation: text steps(var(--chars)) forwards;` æ¥æ£€æµ‹æ»šåŠ¨çš„åç§»é‡ï¼Œå¹¶ä¼ ç»™å˜é‡ --charsmï¼Œç„¶åå¯ä»¥é€šè¿‡åç§»é‡è®¾ç½®æ–‡å­—èƒŒæ™¯è‰²çš„å®½åº¦ï¼š

![image.png](/img/posts/2024-1-2/2024-1-2-31.png)

å¦ä¸€ç§é©±åŠ¨æ–¹å¼ view è¿™ä¹ˆå®šä¹‰ï¼š`animation-timeline: view();`ï¼Œå¯é€šè¿‡ animation-range è®¾ç½®å˜åŒ–èŒƒå›´ï¼Œç”¨äºç›‘æµ‹å½“å‰å…ƒç´ æ˜¯å¦åœ¨å¯è§†åŒºåŸŸï¼Œå®˜æ–¹ demoï¼š[CSS Wrapped 2023: Scroll-Driven Animations: View Timeline #CSSWrapped2023 (codepen.io)](https://codepen.io/web-dot-dev/pen/XWOqovr)

#### ç»™ display: none æ·»åŠ åŠ¨ç”»


![image.png](/img/posts/2024-1-2/2024-1-2-32.png)

chrome æ–°å¢åŠŸèƒ½ï¼š`transition-behavior`ï¼Œæ¥å—ä¸¤ä¸ªå€¼ï¼š`normal`Â å’ŒÂ `allow-discrete`ï¼Œå…¶ä¸­ `allow-discrete`Â æ¨¡å¼å¯å®ç°ç¦»æ•£è½¬æ¢ã€‚ä½¿ç”¨æ–¹å¼ï¼š

```css
.card {
  transition: opacity 0.25s, display 0.25s;
  transition-behavior: allow-discrete;
}
```

demo: [åˆ é™¤å¡ç‰‡](https://codepen.io/web-dot-dev/pen/poQMLrN)

#### `@starting-style`


![image.png](/img/posts/2024-1-2/2024-1-2-33.png)

`@starting-style`Â CSS è§„åˆ™ä»¥æ–°çš„ Web åŠŸèƒ½ä¸ºåŸºç¡€ï¼Œç”¨äºåœ¨Â `display: none`Â ä¹‹é—´æ·»åŠ åŠ¨ç”»æ•ˆæœï¼Œä½†ä¹Ÿå¯ä»¥ç”¨äºå…¶ä»–çš„ transitionã€‚å¯ä»¥çœ‹è¿™ä¸ª [demo](https://codepen.io/web-dot-dev/pen/OJdjjdX)

å¼¹çª—é»˜è®¤æ˜¯éšè—åœ¨å±å¹•ä¹‹ä¸‹çš„ï¼š

```css
dialog {
  transition: translate 0.7s ease-out, overlay 0.7s ease-out, display 0.7s ease-out allow-discrete;
  translate: 0 100vh;
}
```

è®¾ç½®å¼€å…³ï¼š

```css
dialog[open] {
  translate: 0 0;
}
```

ä½†æ˜¯è¿™ä¸ªæ˜¯çªç„¶å‡ºç°çš„ï¼Œæ˜æ˜è®¾ç½®äº† transition: translateï¼Œè¿‡æ¸¡å´æ²¡å‡ºæ¥ï¼Œåº”è¯¥æ˜¯ h5 çš„ dialog çš„ open çœ‹åš display çš„ä¿®æ”¹äº†å§ã€‚æˆ‘ä»¬è®¾ç½®è¿‡æ¸¡ï¼š

```css
@starting-style {
  dialog[open] {
    translate: 0 100vh;
  }
}
```
æ­¤æ—¶å°±æœ‰åŠ¨ç”»äº†ã€‚

#### overlayÂ ã€:popover-open ä¸Â ::backdrop

![image.png](/img/posts/2024-1-2/2024-1-2-34.png)

css åŸç”Ÿä¹Ÿå¼€å§‹æ”¯æŒå¼¹å‡ºå±‚äº†ï¼Œé™¤äº†ä¸Šé¢ h5 çš„ dialogï¼Œè¿™é‡Œè¿˜æœ‰ popover çš„ css å±æ€§ã€‚

å®˜æ–¹ demoï¼š[CSSWrapped2023 Overlay (codepen.io)](https://codepen.io/web-dot-dev/pen/zYeJbgw)

## 7. ç»„ä»¶

#### popover


![image.png](/img/posts/2024-1-2/2024-1-2-35.png)

è¯¥ç»„ä»¶æœ‰å¦‚ä¸‹ç‰¹ç‚¹ï¼š

-   **æ™‹å‡åˆ°é¡¶å±‚**ã€‚å¼¹å‡ºå¼çª—å£ä¼šæ˜¾ç¤ºåœ¨ç½‘é¡µå…¶ä½™éƒ¨åˆ†ä¹‹ä¸Šçš„å•ç‹¬å›¾å±‚ä¸Šï¼Œå› æ­¤æ— éœ€è°ƒæ•´ z-indexã€‚
-   **è½»å…³é—­åŠŸèƒ½**ã€‚ç‚¹å‡»å¼¹å‡ºçª—å£åŒºåŸŸä»¥å¤–çš„ä½ç½®å°†å…³é—­å¼¹å‡ºçª—å£å¹¶è¿”å›ç„¦ç‚¹ã€‚
-   **é»˜è®¤ç„¦ç‚¹ç®¡ç†**ã€‚æ‰“å¼€å¼¹å‡ºå¼çª—å£ä¼šä½¿ä¸‹ä¸€ä¸ªæ ‡ç­¾é¡µåœæ­¢åœ¨å¼¹å‡ºå¼çª—å£å†…æ˜¾ç¤ºã€‚
-   **æ— éšœç¢é”®ç›˜ç»‘å®šã€‚** ç‚¹æŒ‰Â `esc`Â é”®æˆ–åŒé‡åˆ‡æ¢æŒ‰é’®ä¼šå…³é—­å¼¹å‡ºå¼çª—å£å¹¶è¿”å›ç„¦ç‚¹ã€‚
-   **å¯è®¿é—®çš„ç»„ä»¶ç»‘å®š**ã€‚ä»è¯­ä¹‰ä¸Šå°†å¼¹å‡ºå¼çª—å£å…ƒç´ è¿æ¥åˆ°å¼¹å‡ºå¼çª—å£è§¦å‘å™¨ã€‚

åªéœ€è¦ç»™ä¸€ä¸ªæ™®é€šçš„ div åŠ ä¸Š `popover` å±æ€§ï¼Œç„¶åç»™æŒ‰é’®å‘¢åŠ ä¸Š `popovertarget` å¯¹åº”è¿™ä¸ª div çš„ id å³å¯ã€‚è¯¦æƒ…å¯ä»¥æŸ¥çœ‹ [demo](https://code.juejin.cn/pen/7319331878450757670):


![image.png](/img/posts/2024-1-2/2024-1-2-36.png)

#### hr æ ‡ç­¾ç„•å‘æ–°æ˜¥

ä¹‹å‰å¯¹ hr æ ‡ç­¾çš„ç†è§£å°±æ˜¯å¾ˆä¸‘çš„æ¨ªçº¿ï¼Œæ¯”è¾ƒé¸¡è‚‹ï¼ŒUIåº“éƒ½ä¼šå»è‡ªå·±å®ç°åˆ†å‰²çº¿ï¼Œè¿™ä¸ H5 çš„åˆè¡·ç›¸è¿èƒŒï¼Œåˆ¶å®šæ ‡å‡†çš„äººéƒ½å¸Œæœ›è‡ªå·±çš„ç»„ä»¶èƒ½è¢«å„ä¸ªä¸»æµ UI åº“ä½¿ç”¨æ¥è¿›è¡ŒäºŒæ¬¡å¼€å‘ã€‚

> ä½†ç°åœ¨è·¯è¿˜å¾ˆé•¿ï¼Œselect ç»„ä»¶è¿˜æ˜¯åŠŸèƒ½æ¬ ç¼ºï¼Œå„ä¸ªUIåº“ä¸å¾—ä¸è‡ªå·±å®ç°

ç°åœ¨ hr å¯ä»¥å’Œ select ç»“åˆä½¿ç”¨äº†ï¼š

```html
<select name="majors" id="major-select">
  <option value="">Select a favorite feature</option>
  <hr>
  <optgroup label="Foundations">
    <option value="trig">Trigonometric functions</option>
    <option value="nth">Complex nth-* selection</option>
    <option value="nesting">Nesting</option>
    <option value="subgrid">Subgrid</option>
    <option value="mq-ranges">Media query range syntax</option>
  </optgroup>
  ...
```

æ„Ÿè§‰è¿˜ä¸é”™ï¼ˆä½†æ˜¯åŸç”Ÿ select è¿æœç´¢éƒ½ä¸æ”¯æŒï¼Œå¯èƒ½ä¼ä¸šçº§è½åœ°è¿˜æœ‰äº›å›°éš¾ï¼‰ï¼š


![image.png](/img/posts/2024-1-2/2024-1-2-37.png)

#### `:user-valid`Â å’ŒÂ `:user-invalid`

![image.png](/img/posts/2024-1-2/2024-1-2-38.png)

è¿™ä¸¤ä¸ªä¼ªç±»æ˜¯ç”¨äºç”¨æˆ·ä¸è¾“å…¥å†…å®¹æ ¡éªŒçš„ï¼Œåœ¨è¿›è¡Œæ˜æ˜¾äº’åŠ¨åæ ¡éªŒè¡¨å•æ˜¯å¦æ— æ•ˆã€‚

ä¸‹é¢æ˜¯ä¸ªä¾‹å­ï¼ˆæ ¡éªŒåŸç”Ÿ h5 è¡¨å•çš„è§„åˆ™ï¼‰ï¼Œå¯ç”¨äºè¯´æ˜ä¸ :valid çš„åŒºåˆ«ï¼š[è¡¨å•æ ¡éªŒ](https://code.juejin.cn/pen/7319341325450412067)

#### æ‰‹é£ç´ç»„ä»¶


![image.png](/img/posts/2024-1-2/2024-1-2-39.png)

è¿™ä¸ªç»„ä»¶ç”¨çš„è¿˜æ˜¯ h5 çš„ details æ ‡ç­¾ï¼Œä¸æ˜¯ä¸ªæ–°ä¸œè¥¿äº†ï¼Œä½†æ˜¯å…¶å¢åŠ äº†`name`Â å±æ€§çš„æ”¯æŒã€‚ä½¿ç”¨æ­¤å±æ€§æ—¶ï¼Œå…·æœ‰ç›¸åŒÂ `name`Â å€¼çš„å¤šä¸ªÂ `<details>`Â å…ƒç´ ä¼šå½¢æˆè¯­ä¹‰ç»„ã€‚

æˆ‘ä»¬æ¥çœ‹ [demo](https://code.juejin.cn/pen/7319383154270142479)

----

## 8. æ€»ç»“

å‰ç«¯ CSS çš„å‘å±•è¶‹åŠ¿æ˜¯ç´§è´´ç”¨æˆ·ä¸»æµä½¿ç”¨ä¹ æƒ¯ï¼Œå¹¶å€Ÿé‰´å„ä¸ª UI åº“å’Œæ¡†æ¶çš„ä½¿ç”¨æ–¹å¼æ”¹é€ ï¼Œä¸ H5 æ ‡ç­¾ç»“åˆï¼ŒåŠ›å›¾å®Œå–„è‡ªå·±çš„ç»„ä»¶ä½“ç³»ï¼Œè·Ÿä¸Šæ—¶ä»£çš„å˜åŒ–æ½®æµã€‚æ•´ä½“æ–¹å‘å¦‚ä¸‹ï¼š

- å“åº”å¼å’Œç§»åŠ¨ä¼˜å…ˆè®¾è®¡
- CSS å˜é‡ä¸æµç¨‹æ§åˆ¶æ“ä½œè¶Šæ¥è¶Šå¤šï¼Œæ‰“é€šä¸ js çš„å±éšœ
- åŠ¨ç”»ä¸è¿‡æ¸¡ä¼˜åŒ–
- é¢œè‰²ç©ºé—´æ‰©å……
- æ˜“ç”¨æ€§å¢å¼ºï¼Œå‡½æ•°æ‰©å……
- æ€§èƒ½ä¼˜åŒ–53:T6237,Tailwind CSSæ˜¯ä¸€ä¸ªåŠŸèƒ½ç±»ä¼˜å…ˆçš„CSSæ¡†æ¶ï¼Œå¸®åŠ©å¼€å‘è€…å¿«é€Ÿå¼€å‘ CSSï¼Œçµæ´»å¯å®šåˆ¶ã€‚é‰´äºå®˜ç½‘çš„æè¿°æ¯”è¾ƒæ™¦æ¶©ï¼Œæ–°æ‰‹ä¸Šæ‰‹æ¯”è¾ƒéš¾ï¼Œæœ‰å„ç§å‘éœ€è¦è¸©ï¼Œå®æ“æ€§ä¸å¼ºï¼Œæœ¬æœŸå°±å¸¦å¤§å®¶äº†è§£ä¸€ä¸‹è¿™ä¸ª CSS å¿«é€Ÿå¼€å‘æ¡†æ¶çš„ä½¿ç”¨ä»¥åŠä¸€äº›å¸¸ç”¨çš„é…ç½®ã€‚

> æœ¬æ–‡å†™ç»™æ²¡æ—¶é—´æŸ¥é˜…æ–‡æ¡£ï¼Œä½†åˆæƒ³å¿«é€Ÿä¸Šæ‰‹çš„å¼€å‘è€…ã€‚æœ¬æ–‡æ¶‰åŠåˆ°çš„çŸ¥è¯†ï¼Œè¦†ç›–äº†å¹³æ—¶ä¸šåŠ¡å¼€å‘çš„å¤§å¤šæ•°åœºæ™¯ï¼Œå¯ä¾›å‚è€ƒæŸ¥é˜…
>  
> å¼€å‘ç¯å¢ƒï¼šnode16+ | VS Code
> 
> [å®˜ç½‘ä¸­æ–‡é•œåƒ](https://tailwind.nodejs.cn/)

å¦‚æœæ‚¨å·²ç»æŒæ¡äº† Tailwind çš„åŸºæœ¬åŸç†ï¼Œåªæƒ³çŸ¥é“å…·ä½“æ¡†æ¶å¦‚ä½•é…ç½®ï¼Œå¯ä»¥ç›´æ¥è·³è½¬åˆ°ä¸‹é¢å¯¹åº”ç« èŠ‚æŸ¥é˜…ã€‚


----

## 1. VS Code æ’ä»¶


![image.png](/img/posts/2023-11-11/2023-11-11-1.png)

å®‰è£…å¥½åå°±å¯ä»¥æœ‰è‡ªåŠ¨æç¤ºäº†ï¼š

![image.png](/img/posts/2023-11-11/2023-11-11-2.png)

æ’ä»¶è¿˜å¯ä»¥é«˜äº®é”™è¯¯. é¢„è§ˆå†…ç½®cssæ ·å¼. è®¾ç½®è¯­è¨€ç¯å¢ƒç­‰ï¼Œæ¨è VS Code ç”¨æˆ·ä½¿ç”¨ã€‚


## 2. Tailwind CLI

æ–°å»ºä¸€ä¸ªæ–‡ä»¶å¤¹ï¼Œåœ¨æ–‡ä»¶å¤¹æ ¹ç›®å½•ä¸‹ï¼š

```shell
yarn add --dev tailwindcss
npx tailwindcss init
```

æˆ‘ä»¬ä¼šçœ‹åˆ°ä¸€ä¸ªé…ç½®æ–‡ä»¶ `tailwind.config.js` åœ¨æ ¹ç›®å½•ä¸‹ç”Ÿæˆï¼Œæˆ‘ä»¬æ·»åŠ è¦æ£€ç´¢çš„æ–‡ä»¶ï¼š

```js
/** @type {import('tailwindcss').Config} */
module.exports = {
  content: ['./index.html'],
  theme: {
    extend: {},
  },
  plugins: [],
}
```

è¿™æ ·ï¼ŒTailwind å°±åªä¼šæ£€æµ‹ index.html ä¸­æ˜¯å¦ä½¿ç”¨äº† tailwindcssï¼Œå¹¶å£°ç§°æœ€å° css é›†åˆã€‚æˆ‘ä»¬å†™ä¸€ä¸‹è¿™ä¸ª index.html:

```html
<!doctype html>
<html>
<head>
  <title>hello</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="/dist/output.css" rel="stylesheet">
</head>
<body>
  <h1 class="text-3xl font-bold underline">
    Hello world!
  </h1>
  <button class="underline bg-violet-500 hover:bg-violet-600 active:bg-violet-700 focus:outline-none focus:ring focus:ring-violet-300 ...">
    Save changes
  </button>
</body>
</html>
```
ç„¶ååœ¨ src ç›®å½•ä¸‹å†™ä¸€ä¸ª input.css æ–‡ä»¶ï¼š

```js
@tailwind base;  // å¼•å…¥åŸºç¡€æ ·å¼ï¼Œæ¯”å¦‚ bodyçš„margin. æ ·å¼ç»§æ‰¿è§„åˆ™ç­‰
@tailwind components;  // å¼•å…¥å¸¸ç”¨çš„ç»„ä»¶æ ·å¼ï¼Œä¸€èˆ¬åœ¨å…¶ä»–å‰ç«¯æ¡†æ¶ä¸­ä½¿ç”¨
@tailwind utilities; // å·¥å…·æ ·å¼ï¼Œæ¯”å¦‚ä¸‹åˆ’çº¿. å­—ä½“é¢œè‰²ç­‰
```

æ‰§è¡Œ cliï¼š

```shell
npx tailwindcss -i ./src/input.css -o ./dist/output.css --watch --config ./tailwind.config.js
```

è¿™é‡Œçš„ `--config ./tailwind.config.js` å¯ä»¥ä¸å†™ï¼Œé»˜è®¤ä¼šæ£€ç´¢æ ¹ç›®å½•ä¸‹çš„åŒåæ–‡ä»¶ã€‚


> è¿™é‡Œæœ‰ä¸€ä¸ªå‘ï¼Œå¦‚ä¸‹å›¾

![image.png](/img/posts/2023-11-11/2023-11-11-3.png)

å¦‚æœä½ æ‰§è¡ŒæŒ‡ä»¤åå‡ºç° cliï¼Œæœ‰å¯èƒ½æ˜¯è¾“å…¥è¾“å‡ºçš„æ–‡ä»¶è·¯å¾„ä¸å¯¹ï¼Œä¹Ÿæœ‰å¯èƒ½æ˜¯ç›®æ ‡é…ç½®æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè¿˜æœ‰å¯èƒ½æ˜¯ä½ é…ç½®æ–‡ä»¶æ£€æµ‹çš„ content ä¸å­˜åœ¨æˆ–æ²¡æœ‰ä½¿ç”¨ tailwincssã€‚æˆ‘ç¬¬ä¸€æ¬¡å‡ºç°è¿™ä¸ªé”™è¯¯ï¼Œæ˜¯è¯¯æŠŠ `--config` å†™æˆäº† `--content`...

åˆ°æ­¤ä¸ºæ­¢ï¼Œå°±ç”Ÿæˆä¸€ä¸ªè¾“å‡ºæ–‡ä»¶ï¼Œå·¥ç¨‹ç›®å½•å¦‚ä¸‹ï¼š


![image.png](/img/posts/2023-11-11/2023-11-11-4.png)
 
ç”±äº tailwindcss åªèƒ½è¿è¡Œåœ¨æœåŠ¡å™¨ç¯å¢ƒï¼Œæˆ‘ä»¬è¿™é‡Œå°±æ­å»ºä¸€ä¸ªå¼€å‘æœåŠ¡å™¨æ¥è¯´æ˜é—®é¢˜ï¼š

```shell
yarn add --dev http-server

npx http-server
```
æœåŠ¡è·‘èµ·æ¥ï¼š


![image.png](/img/posts/2023-11-11/2023-11-11-5.png)

æˆ‘ä»¬æ‰“å¼€ 8080 ç«¯å£æŸ¥çœ‹ï¼š


![image.png](/img/posts/2023-11-11/2023-11-11-6.png)

æ ·å¼å·²ç»ä¸Šå»äº†ã€‚

## 3. ä¸ postcss å’Œ sass ç»“åˆä½¿ç”¨

postcss ç”¨äºæ ¼å¼åŒ–æ ·å¼ï¼Œä½¿çš„æ ·å¼æ›´åŠ è§„èŒƒç»Ÿä¸€ï¼Œä¸ä¼šæ ·å¼æ±¡æŸ“ã€‚æˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ªä¾èµ– postcss çš„ autoprefixer ä¸ºæ ·å¼è‡ªåŠ¨å¢åŠ å‰ç¼€ï¼Œæ‰§è¡Œå¦‚ä¸‹æŒ‡ä»¤ï¼š

```shell
yarn add --dev postcss autoprefixer postcss-nesting postcss-import
```
åä¸¤ä¸ªä¾èµ–æ˜¯å®ç°çº§è” css çš„è§£æ å’Œ è§£æ @import è¯­å¥çš„ã€‚æˆ‘ä»¬åœ¨æ ¹ç›®å½•ä¸‹æ–°å»ºæ–‡ä»¶ `postcss.config.js`ï¼Œä»¥æ’ä»¶çš„å½¢å¼å¼•å…¥ä¾èµ–:

```js
module.exports = {
  plugins: {
    'postcss-import': {},
    'tailwindcss/nesting': 'postcss-nesting',
    tailwindcss: {},
    autoprefixer: {},
  }
}
```

å°† input.css æ”¹ä¸º input.scssï¼Œå¹¶ä¿®æ”¹æ–‡ä»¶ï¼š

```scss
@tailwind base;
@tailwind components;
@tailwind utilities;

body {
  h1 {
    font-size: 64px !important;
  }
}

@media (min-resolution: 2dppx) {
  .image {
    background-image: url(image@2x.png);
  }
}
```

ç„¶åæ‰§è¡Œ cli æŒ‡ä»¤ï¼ŒæŒ‡æ˜è¿™ä¸ªé…ç½®æ–‡ä»¶ï¼š

```shell
npx tailwindcss -i ./src/input.scss -o ./dist/output.css --watch --postcss postcss.config.js
```

æˆ‘ä»¬çœ‹çœ‹è¾“å‡ºçš„ output.cssï¼š

```css
body h1 {
  font-size: 64px !important;
}

@media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 2dppx) {
  .image {
    background-image: url(image@2x.png);
  }
}
```
å¯ä»¥çœ‹åˆ°å·²ç»è§£æä¸ºæ™®é€šçš„ cssï¼Œå¹¶æ·»åŠ äº†å…¼å®¹æ€§å‰ç¼€å’Œè‡ªåŠ¨è®¡ç®—å…¼å®¹æ€§å•ä½ã€‚

## 4. å†…ç½®æ ·å¼ç±»é€ŸæŸ¥è¡¨

> å¦‚æœä¸æƒ³çœ‹é€ŸæŸ¥ï¼Œç›´æ¥è°ƒåˆ°åè¾¹æ¡†æ¶ä½¿ç”¨å³å¯

æœ‰ä¸€ä¸ªåˆæ­¥è®¤è¯†åï¼Œæˆ‘ä»¬è¿™é‡Œæ¥åˆ†ç±»æ€»ç»“ä¸€ä¸‹ tailwindcss çš„å¸¸ç”¨æ ·å¼ç±»ï¼Œå¦‚æœæƒ³è¦çœ‹å…¨éƒ¨çš„æ ·å¼ï¼Œå‚è§ï¼š[tailwind](https://tailwind.nodejs.cn/docs/preflight)ã€‚

#### ï¼ˆ1. é¢„æ£€æ ·å¼

`@tailwind base;`

ä»–å¼•å…¥åï¼Œè‡ªåŠ¨è®¾ç½®é»˜è®¤è¾¹è·æ˜¯0. æ‰€æœ‰çš„æ ‡é¢˜æ ‡ç­¾çš„å­—ä½“å¤§å°å’Œæƒé‡ç»§æ‰¿ä»–çš„åŒ…å«å—. åˆ—è¡¨æ ·å¼æ¸…é™¤. å›¾ç‰‡. iframeç­‰å¤šåª’ä½“æ ‡ç­¾è‡ªåŠ¨ä¸ºå—çº§. å›¾ç‰‡è§†é¢‘è‡ªåŠ¨è¢«é™åˆ¶ä¸ºæœ€å¤§çˆ¶çº§å®½åº¦. é‡å†™é»˜è®¤è¾¹æ¡†æ ·å¼ç­‰ã€‚

å½“ç„¶ä½ ä¹Ÿå¯ä»¥æ‰©å±•é¢„æ£€èŒƒå›´ï¼š

```css
@tailwind base;
@layer base { h1 { @apply text-2xl; } }
```

é¢„æ£€æ ·å¼è¡¨å¦‚ä¸‹ï¼šhttps://unpkg.com/tailwindcss@3.3.5/src/css/preflight.css

#### ï¼ˆ2. å¸ƒå±€

çºµæ¨ªæ¯”ï¼š

Class         | Properties            |
| ------------- | --------------------- |
| aspect-auto   | aspect-ratio: auto;   |
| aspect-square | aspect-ratio: 1 / 1;  |
| aspect-video  | aspect-ratio: 16 / 9;|

å“åº”å¼å®¹å™¨ï¼š

Class        | Breakpoint         | Properties   |
| ------------ | ------------------ | ------------ |
| container    | None               | width: 100%; |
|| smÂ (640px)   | max-width: 640px;  |            
|| mdÂ (768px)   | max-width: 768px;  |            
|| lgÂ (1024px)  | max-width: 1024px; |             
|| xlÂ (1280px)  | max-width: 1280px; |             
|| 2xlÂ (1536px) | max-width: 1536px;|

ä½¿ç”¨ä¸¾ä¾‹ï¼š


![image.png](/img/posts/2023-11-11/2023-11-11-7.png)

#### ï¼ˆ3. åˆ—å¸ƒå±€

Class     | Properties  | note |
| --------- | ----------- | -- |
| columns-`{num}` | columns: 1; | numå¯å–ï¼š `[1-12]` |
| columns-auto | columns: auto; |  |
columns-3xs | columns: 16rem; /* 256px */ ||
| columns-2xs | columns: 18rem; /* 288px */||
columns-xs | columns: 20rem; /* 320px */ ||
| columns-sm | columns: 24rem; /* 384px */ ||
| columns-md | columns: 28rem; /* 448px */ ||
| columns-lg | columns: 32rem; /* 512px */ ||
| columns-xl | columns: 36rem; /* 576px */||
| columns-`{num}`xl | columns: 36rem çš„ num å€ |numå¯å–ï¼š `[2-7]` |

æ–‡ç« æœ€åæˆ‘ä»¬ä¼šæœ‰ä¸€ä¸ªå®æˆ˜è¯´æ˜

#### ï¼ˆ4. æº¢å‡ºå¤„ç†

Class              | Properties           |
| ------------------ | -------------------- |
| overflow-auto      | overflow: auto;      |
| overflow-hidden    | overflow: hidden;    |
| overflow-clip      | overflow: clip;      |
| overflow-visible   | overflow: visible;   |
| overflow-scroll    | overflow: scroll;    |
| overflow-x-auto    | overflow-x: auto;    |
| overflow-y-auto    | overflow-y: auto;    |
| overflow-x-hidden  | overflow-x: hidden;  |
| overflow-y-hidden  | overflow-y: hidden;  |
| overflow-x-clip    | overflow-x: clip;    |
| overflow-y-clip    | overflow-y: clip;    |
| overflow-x-visible | overflow-x: visible; |
| overflow-y-visible | overflow-y: visible; |
| overflow-x-scroll  | overflow-x: scroll;  |
| overflow-y-scroll  | overflow-y: scroll;|

#### ï¼ˆ5. å®šä½

| Class    | Properties          |
| -------- | ------------------- |
| static   | position: static;   |
| fixed    | position: fixed;    |
| absolute | position: absolute; |
| relative | position: relative; |
| sticky   | position: sticky;|

#### ï¼ˆ6. display

Class        | Properties             |
| ------------ | ---------------------- |
| block        | display: block;        |
| inline-block | display: inline-block; |
| inline       | display: inline;       |
| flex         | display: flex;|
|...||

flex å¯¹å…¶æ–¹å¼ï¼š

justify-center  | justify-content: center;        |
| --------------- | ------------------------------- |
| justify-between | justify-content: space-between; |
| justify-around  | justify-content: space-around;|
| items-start  | align-items: flex-start; |
| items-end    | align-items: flex-end;   |
| items-center | align-items: center;|


#### ï¼ˆ7. è¾¹è·

Class | Properties                             |
| ----- | -------------------------------------- |
| p-0   | padding: 0px;                          |
| px-0  | padding-left: 0px; padding-right: 0px; |
| py-0  | padding-top: 0px; padding-bottom: 0px;|
|...||

Class | Properties                           |
| ----- | ------------------------------------ |
| m-0   | margin: 0px;                         |
| mx-0  | margin-left: 0px; margin-right: 0px; |
| my-0  | margin-top: 0px; margin-bottom: 0px;|
|...||

å¦‚æœè®¾ç½®å•ä¸ªè¾¹è·ï¼Œå¯ä½¿ç”¨ç¼©å†™ï¼špl-1ï¼špadding-left: 1pxï¼Œä»¥æ­¤ç±»æ¨

#### ï¼ˆ8. æ–‡æœ¬ç±»

| Class         | Properties                                                      |
| ------------- | --------------------------------------------------------------- |
| truncate      | overflow: hidden; text-overflow: ellipsis; white-space: nowrap; |
| text-ellipsis | text-overflow: ellipsis;                                        |
| text-clip     | text-overflow: clip;|
|...||

#### ï¼ˆ9. è¾¹æ¡†

Class    | Properties         |
| -------- | ------------------ |
| border-0 | border-width: 0px; |
| border-2 | border-width: 2px; |
| border-4 | border-width: 4px; |
| border-8 | border-width: 8px; |
| border   | border-width: 1px;|
| rounded-md| border-radius: 0.375rem |
...

#### ï¼ˆ10. åŠ¨ç”»

Class          | Properties                                                                                                                                                                                                                                     |
| -------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| animate-none   | animation: none;                                                                                                                                                                                                                               |
| animate-spin   | animation: spin 1s linear infinite; `@keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }`                                                                                                                    |
| animate-ping   | animation: ping 1s cubic-bezier(0, 0, 0.2, 1) infinite; `@keyframes ping { 75%, 100% { transform: scale(2); opacity: 0; } }    `                                                                                                                 |
| animate-pulse  | animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; `@keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } } `                                                                                                                 |
| animate-bounce | animation: bounce 1s infinite; `@keyframes bounce { 0%, 100% { transform: translateY(-25%); animation-timing-function: cubic-bezier(0.8, 0, 1, 1); } 50% { transform: translateY(0); animation-timing-function: cubic-bezier(0, 0, 0.2, 1); } }`|


#### ï¼ˆ11. é¢œè‰²

- bg å¼€å¤´ (css ä¸­ theme(textColor.) æˆ– theme(colors.) å¼€å¤´) è¡¨ç¤ºèƒŒæ™¯è‰²ï¼Œé€šè¿‡æ’ä»¶å¯ä»¥è‡ªå·±é€‰æ‹©ï¼š


![image.png](/img/posts/2023-11-11/2023-11-11-8.png)

- text (css ä¸­ theme(textColor.) æˆ– theme(colors.)) å¼€å¤´è¡¨ç¤ºæ–‡å­—é¢œè‰²ï¼š


![image.png](/img/posts/2023-11-11/2023-11-11-9.png)

#### ï¼ˆ12. äº‹ä»¶

- snap æˆ– scroll å¼€å¤´ï¼šç›‘å¬æ»šåŠ¨äº‹ä»¶ï¼Œå‚è€ƒ [æ»šåŠ¨](https://tailwind.nodejs.cn/docs/scroll-snap-align)
- hover: å¼€å¤´ï¼šç›‘å¬é¼ æ ‡æ‚¬æµ®äº‹ä»¶
- active: å’Œ focus: å¼€å¤´ï¼šæ•è·æ¿€æ´»çš„å’Œèšç„¦çš„å…ƒç´ 
- first: æ•è·ç¬¬ä¸€ä¸ªå…ƒç´ 
- odd: å’Œ even: æ•è·å¥‡å¶å…ƒç´ 
- è¿˜å¯ä»¥æ•è·ä¼ªå…ƒç´ ï¼šafter: ç­‰ï¼š[ä¼ªå…ƒç´ ](https://tailwind.nodejs.cn/docs/hover-focus-and-other-states#pseudo-elements)

#### ï¼ˆæ’ä»¶

[æ’ç‰ˆæ’ä»¶](https://tailwind.nodejs.cn/docs/typography-plugin)ï¼š

```
yarn add --dev @tailwindcss/typography
```

æ·»åŠ é…ç½®æ–‡ä»¶ï¼š

```js
plugins: [ require('@tailwindcss/typography') ],
```

ä½¿ç”¨ï¼š

```html
<article class="prose lg:prose-xl">
```

[è¡¨å•æ’ä»¶](https://github.com/tailwindlabs/tailwindcss-forms):

```shell
yarn add --dev @tailwindcss/forms
```

é…ç½®ï¼š

```js
plugins: [
  require('@tailwindcss/forms'),
  // ...
],
```

ä½¿ç”¨ï¼š

```html
<input type="email" class="form-input px-4 py-3 rounded-full">

<select class="form-select px-4 py-3 rounded-full">
<!-- ... -->
</select>
```

å¯ç”¨æ ·å¼ï¼š

|å…ƒç´ |class|
| ------------------- | ------------------ |
|`input`     | `form-input`       |
| `textarea`          | `form-textarea`    |
| `select`            | `form-select`      |
| `select[multiple]`  | `form-multiselect` |
| `[type='checkbox']` | `form-checkbox`    |
| `[type='radio']`    | `form-radio`|


## 5. è‡ªå®šä¹‰æ ·å¼

åœ¨é…ç½®æ–‡ä»¶ä¸­å¯ä»¥è¿™æ ·å†™ï¼š

```js
theme: {
    extend: {
      spacing: {
        '8xl': '96rem',
        '9xl': '128rem',
      },
    },
    screens: {
        'sm': '640px', // => @media (min-width: 640px) 
        ...
    },
    colors: {
      'text-blue': '#4848ff'
    }
  },
```

è¿™æ ·å°±å¯ä»¥ä½¿ç”¨äº†ã€‚

åœ¨ css ä¸­ä½¿ç”¨ï¼š

```css
color: theme('colors.text-blue');
max-width: theme('spacing.8xl');
@media (min-width: theme('screens.sm')) {}
```

åœ¨ html ä¸­ä½¿ç”¨ï¼š

```html
<p class="text-text-blue">
<div class="mb-8xl"> <!-- mb æ˜¯ margin bottom -->
<div class="sm:flex"> <!-- è¿™ä¸ªå…ƒç´ åœ¨å±å¹•å®½åº¦å¤§äºç­‰äº 'md' æ—¶å°†ä½¿ç”¨ flex å¸ƒå±€ -->
```

> ç±»åä¸­ï¼Œé¢œè‰²ä¼šè‡ªåŠ¨åŠ å…¥ text å‰ç¼€ã€‚ç”±äºç±»åæ²¡æœ‰è§„åˆ™ï¼Œä¸å¤ªå¥½è®°ï¼Œæ¨èæ–°æ‰‹ä½¿ç”¨ css æ¥å¼•å…¥è‡ªå·±çš„è‡ªå®šä¹‰ä¸»é¢˜

## 6. Nextjs ä¸­ä½¿ç”¨

æ‰§è¡Œå‘½ä»¤è¡Œï¼š

```sh
npx create-next-app@latest
```

å¯é€‰æ‹©é¡¹é€‰æ‹©å¦‚ä¸‹ï¼š

![image.png](/img/posts/2023-11-11/2023-11-11-10.png)

> App router æ˜¯å¦ä¸€ç§è·¯ç”±æ–¹å¼ï¼Œæ¯ä¸€ä¸ªæ–‡ä»¶å¤¹æ˜¯ä¸€ä¸ªé¡µé¢ï¼Œå…¥å£æ–‡ä»¶éƒ½æ˜¯ page.tsxï¼Œå¯å‚è€ƒï¼šhttps://nextjs.org/docs/app/building-your-application/routing/route-groups

å·¥ç¨‹ç›®å½•ç”Ÿæˆåï¼Œé¡¹ç›®ä¼šè‡ªåŠ¨åœ¨æ ¹ç›®å½•ä¸‹å»ºç«‹ postcss.config.js å’Œ tailwind.config.jsã€‚

é¡¹ç›®ç›®å½•å¦‚ä¸‹ï¼š

![image.png](/img/posts/2023-11-11/2023-11-11-11.png)

æˆ‘ä»¬é…ç½®å…¥å£ page.tsx:

```tsx
export default function Home() {
  return (
    <main className="flex min-h-screen flex-col items-center justify-between p-24">
      <h1 className="text-3xl font-bold underline">
        Hello world!
      </h1>
    </main>
  )
}
```
é¡µé¢ä¸ŠæŸ¥çœ‹ï¼š


![image.png](/img/posts/2023-11-11/2023-11-11-12.png)

#### åœ¨ css module ä¸­ä½¿ç”¨

æˆ‘ä»¬åœ¨ dashboard/index.module.css ä¸­å†™å…¥ï¼š

```css
.container {
  color: theme(textColor.purple.400);
}
```
åœ¨ dashboard/page.tsx ä¸­å¼•å…¥ï¼š

```tsx
import styles from './index.module.css';

export default function Page() {
  return <h1 className={`${styles['container']}`}>Hello, Dashboard page!</h1>
}
```

æˆ‘ä»¬è®¿é—®é¡µé¢æŸ¥çœ‹ï¼š


![image.png](/img/posts/2023-11-11/2023-11-11-13.png)

#### åœ¨ mdx æ–‡ä»¶ä¸­ä½¿ç”¨

è‹¥è¦åœ¨ mdx æ–‡ä»¶ä¸­ä½¿ç”¨ï¼ŒApp Router éœ€è¦å¦‚ä¸‹é…ç½®ï¼š

å®‰è£…ä¾èµ–ï¼š

```sh
yarn add  @next/mdx @mdx-js/loader @mdx-js/react @types/mdx
```

åœ¨ src ç›®å½•ä¸‹é…ç½® mdx-components.tsxï¼š

```tsx
import type { MDXComponents } from 'mdx/types'
 
export function useMDXComponents(components: MDXComponents): MDXComponents {
  return {
    ...components,
  }
}
```
ç„¶åæ–°å»ºä¸€ä¸ªåŒ…å« mdx æ–‡ä»¶çš„ç›®å½•ï¼š


![image.png](/img/posts/2023-11-11/2023-11-11-14.png)

page.mdx å†™é“ï¼š

```mdx
<div className="bg-blue-500 p-4">
  This is a styled div.
</div>

Hello Mdx
```

é¡µé¢æŸ¥çœ‹ï¼š


![image.png](/img/posts/2023-11-11/2023-11-11-15.png)

æ ·å¼ç”Ÿæ•ˆäº†ï¼


## 7. vite é¡¹ç›®ä¸­ä½¿ç”¨

æˆ‘ä»¬å…ˆé€šè¿‡ vite åˆ›å»ºä¸€ä¸ª vue é¡¹ç›®ï¼š

```sh
npm create vite@latest my-project -- --template vue
```

ç„¶åè¿›å…¥å·¥ç¨‹æ ¹ç›®å½•ä¸‹ï¼Œå®‰è£…ä¾èµ–å’Œåˆå§‹åŒ–é…ç½®ï¼š

```sh
yarn add --dev tailwindcss postcss autoprefixer
npx tailwindcss init -p
```

é…ç½®æ–‡ä»¶ tailwind.config.js ä¸­å†™å…¥ä½ è¦æ‹¦æˆªçš„ä½¿ç”¨äº†cssèµ„æºçš„æ–‡ä»¶å†…å®¹ï¼š

```js
export default {
  content: [
    "./index.html",
    "./src/**/*.{vue,js,ts,jsx,tsx}",
  ],
  theme: {
    extend: {},
  },
  plugins: [],
}
```

åœ¨ style.css ä¸­å¼•å…¥ï¼š

```css
@tailwind base;
@tailwind components;
@tailwind utilities;
```

æˆ‘ä»¬æŠŠ App.vue ä¸­è‡ªå¸¦çš„æ‰€æœ‰æ ·å¼æ¸…ç©ºï¼Œå†™ä¸‹å¦‚ä¸‹çš„æµ‹è¯•ä»£ç ï¼š

```vue
// æ–‡å­—ç²—ä½“. å¸¦ä¸‹åˆ’çº¿. 3xlå¤§å°
<h1 class="text-3xl font-bold underline"> Hello world! </h1>
```

è¿è¡ŒæœåŠ¡ï¼Œå¯ä»¥çœ‹åˆ°æ•ˆæœå·²ç»å‡ºæ¥ï¼š


![image.png](/img/posts/2023-11-11/2023-11-11-16.png)


## 8. Nuxtjs é¡¹ç›®ä¸­ä½¿ç”¨

nuxtjs æ¨èä½¿ç”¨æ”¯æŒ vue3 çš„æ¨¡å—åŒ–æ–¹æ¡ˆ nuxiã€‚æˆ‘ä»¬å…ˆåˆå§‹åŒ–é¡¹ç›®ï¼š

```sh
npx nuxi init my-project
```

ç„¶åè¿›å…¥æ ¹ç›®å½•ä¸‹å®‰è£…ä¾èµ–ï¼š

```sh
yarn
npx nuxi module add @nuxtjs/tailwindcss
npx tailwindcss init
```
è¿™é‡Œä¸éœ€è¦æ‰‹åŠ¨ä¿®æ”¹ tailwin.config.jsï¼Œä½¿ç”¨é»˜è®¤å€¼å°±å¯ä»¥ï¼Œçœ‹æ¥ nuxt çš„é›†æˆåº¦è¿˜æŒºé«˜çš„ã€‚ç›´æ¥å¯åŠ¨é¡¹ç›®ï¼Œä¿®æ”¹ app.vue:

```vue
<template>
<h1 class="text-3xl font-bold underline">
  Hello world!
</h1>
</template>
```

æŸ¥çœ‹æ•ˆæœï¼š


![image.png](/img/posts/2023-11-11/2023-11-11-17.png)

## 9. å®æˆ˜

#### ï¼ˆ1. åˆ‡æ¢ä¸»é¢˜

tailwindcss å†…ç½®äº† dark å¤œé—´æ¨¡å¼ï¼Œå¯ä»¥æ”¯æŒç™½å¤©å’Œé»‘å¤œçš„åˆ‡æ¢ã€‚æ¯”å¦‚ä½¿ç”¨å®˜æ–¹çš„è¿™ä¸ªä¾‹å­ï¼Œä½¿ç”¨æµè§ˆå™¨Â `prefers-color-scheme` åª’ä½“åŠŸèƒ½è¿›è¡Œå˜æ¢ï¼š

```html
<div class="bg-white dark:bg-slate-800 rounded-lg px-6 py-8 ring-1 ring-slate-900/5 shadow-xl">
  <div>
    <span class="inline-flex items-center justify-center p-2 bg-indigo-500 rounded-md shadow-lg">
      <svg class="h-6 w-6 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true"><!-- ... --></svg>
    </span>
  </div>
  <h3 class="text-slate-900 dark:text-white mt-5 text-base font-medium tracking-tight">Writes Upside-Down</h3>
  <p class="text-slate-500 dark:text-slate-400 mt-2 text-sm">
    The Zero Gravity Pen can be used to write in any orientation, including upside-down. It even works in outer space.
  </p>
</div>
```

ä»–ä¼šè‡ªåŠ¨è¯†åˆ«æ“ä½œç³»ç»Ÿæ˜¯å¦æ˜¯å¤œé—´æ¨¡å¼ï¼Œå¹¶åº”ç”¨ dark:åè¾¹çš„å±æ€§ã€‚

å¦‚æœæƒ³è¦æ‰‹åŠ¨åˆ‡æ¢å¤œé—´æ¨¡å¼ï¼Œå¯ä»¥åœ¨é…ç½®æ–‡ä»¶é‡Œè¿™æ ·é…ç½®ï¼š

```js
module.exports = {
  darkMode: 'class', // media æ˜¯è‡ªåŠ¨è¯†åˆ«
}
```

æ­¤æ—¶å°† html è®¾ç½®ä¸ºå¤œé—´æ¨¡å¼å³å¯ï¼š

```html
<html class="dark">
```

> æ³¨æ„ï¼šé…ç½®é¡¹ä¸­ä½¿ç”¨äº† darkMode åï¼Œä¸èƒ½å†å‡ºç° theme å­—æ®µï¼Œå¦åˆ™ä¸‹é¢çš„ä¼šè¦†ç›–ä¸Šé¢çš„é…ç½®


![image.png](/img/posts/2023-11-11/2023-11-11-18.png)

ä½ å¯ä»¥ä½¿ç”¨ç”¨æˆ·çš„ç³»ç»Ÿåå¥½ï¼ˆé¡µé¢ä¸Šæ”¾ç½®å¼€å…³æ§åˆ¶ localStorage é‡Œ theme å˜åŒ–ï¼‰æˆ–ä½¿ç”¨Â [`Window.matchMedia()`Â API](https://developer.mozilla.org/en-US/docs/Web/API/Window/matchMedia) æ¥è·å–å½“å‰æ“ä½œç³»ç»Ÿæ˜¯å¦ä¸ºå¤œé—´æ¨¡å¼ï¼š

```js
window.matchMedia('(prefers-color-scheme: dark)').matches
```
æ£€æµ‹åˆ°å½“å‰ä¸ºå¤œé—´æ¨¡å¼æ—¶ï¼Œä¿®æ”¹ html æ ‡ç­¾çš„ classï¼Œæ·»åŠ  `dark` å³å¯ã€‚

è¿™é‡Œæœ‰ä¸ªé—®é¢˜ï¼Œå°±æ˜¯ä¸¤ç§æ¨¡å¼æ¯ä¸€ä¸ªæ–‡å­—. èƒŒæ™¯éƒ½è¦æŒ‡å®šé¢œè‰²ï¼Œè¿™ä¸ªå¯ä»¥æå‡ºåˆ°å…¬å…±æ ·å¼ä¸­ä½¿ç”¨ï¼š

```scss
.box {
  @apply bg-white text-black;
}

html.dark {
  .box {
    @apply bg-slate-800 text-white;
  }
}
```

è¿™æ ·åœ¨å®šä¹‰ç±»çš„æ—¶å€™ï¼Œå°±ä¼šå®¹æ˜“ä¸€äº›ï¼š

```html
// ç™½å¤©
<html>
  <div class="box"></box>
</html>

// å¤œæ™š
<html class="dark">
  <div class="box"></box>
</html>
```

#### ï¼ˆ2. ç€‘å¸ƒæµå¸ƒå±€

> è¿™æ˜¯å®˜ç½‘æ ·ä¾‹

ç€‘å¸ƒæµçš„ç²¾é«“åœ¨äºå„ç§ä¸åŒå°ºå¯¸çš„å›¾ç‰‡èƒ½å¤Ÿå®Œç¾çš„è®¡ç®—é«˜åº¦å¹¶é€æ¬¡æ’é˜Ÿã€‚æˆ‘ä»¬å‡è®¾è¦æ˜¾ç¤ºä¸‰åˆ—å›¾ç‰‡ï¼Œæˆ‘ä»¬å°±è®¾ç½®ä¸€ä¸ªå“åº”å¼çš„åˆ—å¸ƒå±€ç›’å­å®¹å™¨ï¼š

```html
<div class="columns-2 sm:columns-3 gap-8">
```
æ­¤æ—¶ï¼Œæ ·å¼å¦‚ä¸‹ï¼š

![image.png](/img/posts/2023-11-11/2023-11-11-19.png)

è¡¨ç¤ºåœ¨ å¤§äº sm å°ºå¯¸ä¸‹ï¼Œä½¿ç”¨ 3åˆ—å¸ƒå±€ï¼Œå¦åˆ™ä½¿ç”¨ 2åˆ—å¸ƒå±€ã€‚gap è¡¨ç¤ºæ¯ä¸€åˆ—ä¹‹é—´çš„é—´è·ï¼Œä¸è®¾ç½®çš„è¯é»˜è®¤ 16px (ç»§æ‰¿å±æ€§ï¼Œchrome æ˜¯ 16px)ã€‚

å®¹å™¨å†…æ”¾ç½®ä¸€ä¸ªä¸€ä¸ªçš„å›¾ç‰‡ã€‚æˆ‘ä»¬åˆ†åˆ«ä½¿ç”¨ div æ¥åŒ…è£¹å›¾ç‰‡ï¼š

```html
<div class="aspect-w-16 aspect-h-9">
  <img class="w-full object-cover rounded-lg" src="">
</div>
```
-   `aspect-w-16`: è¿™ä¸ªç±»è¡¨ç¤ºè®¾ç½®ä¸€ä¸ªå…ƒç´ çš„å®½åº¦ï¼Œä½¿å…¶å®½åº¦ä¸ºé«˜åº¦çš„16å€ã€‚
-   `aspect-h-9`: è¿™ä¸ªç±»è¡¨ç¤ºè®¾ç½®ä¸€ä¸ªå…ƒç´ çš„é«˜åº¦ï¼Œä½¿å…¶é«˜åº¦ä¸ºå®½åº¦çš„9å€ã€‚

å½“ç„¶è¿™ä¸¤ä¸ªç±»æ˜¯å·²çŸ¥å›¾ç‰‡é•¿å®½æ¯”æ—¶å¯ä»¥è¿™ä¹ˆå†™ï¼Œä¸çŸ¥é“çš„è¯å°±ä¸å†™ã€‚.w-full è¡¨ç¤ºå®½åº¦æ’‘æ»¡è¯¥åˆ—ï¼Œobject-cover å…ƒç´ è¢«ç¼©æ”¾ä»¥è¦†ç›–æ•´ä¸ªå®¹å™¨æ¡†ï¼Œä½†å¯èƒ½ä¼šè¢«è£å‰ªã€‚

å› ä¸ºæ˜¯åˆ—å¼å¸ƒå±€ï¼Œæ˜¯ä»å·¦å¼€å§‹ï¼Œä»ä¸Šå¾€ä¸‹å¸ƒå±€çš„ï¼Œæ‰€ä»¥ä¹‹åçš„å…ƒç´ éƒ½éœ€è¦åŠ ä¸Š marginï¼š

```html
<div class="aspect-w-1 aspect-h-1 mt-8">
```
ç„¶åæˆ‘ä»¬å†åŠ ä¸Šå¤–è¾¹æ¡†å’Œå±…ä¸­æ ·å¼ç¾åŒ–ï¼Œå…¨éƒ¨ä»£ç å¦‚ä¸‹ï¼š

```html
<body class="p-12 m-auto">
  <div class="container flex justify-center">
    <div class="columns-2 sm:columns-3 gap-8">
      <div>
        <img class="w-full object-cover rounded-lg" src="https://images.unsplash.com/photo-1454496522488-7a8e488e8606?ixlib=rb-1.2.1&amp;ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&amp;auto=format&amp;fit=crop&amp;w=2952&amp;q=80">
      </div>
      <div class=" aspect-w-1 aspect-h-1 mt-8">
        <img class="w-full object-cover rounded-lg" src="https://images.unsplash.com/photo-1434394354979-a235cd36269d?ixlib=rb-1.2.1&amp;ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&amp;auto=format&amp;fit=crop&amp;w=2902&amp;q=80">
      </div>
      <div class="aspect-w-1 aspect-h-1 mt-8">
        <img class="w-full object-cover rounded-lg" src="https://images.unsplash.com/photo-1491904768633-2b7e3e7fede5?ixlib=rb-1.2.1&amp;ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&amp;auto=format&amp;fit=crop&amp;w=3131&amp;q=80">
      </div>
      <div class="sm:block  aspect-w-1 aspect-h-1 mt-8">
        <img class="w-full object-cover rounded-lg" src="https://images.unsplash.com/photo-1463288889890-a56b2853c40f?ixlib=rb-1.2.1&amp;ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&amp;auto=format&amp;fit=crop&amp;w=3132&amp;q=80">
      </div>
      <div class="sm:block  aspect-w-16 aspect-h-9 mt-8">
        <img class="w-full object-cover rounded-lg" src="https://images.unsplash.com/photo-1611605645802-c21be743c321?ixlib=rb-1.2.1&amp;ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&amp;auto=format&amp;fit=crop&amp;w=2940&amp;q=80">
      </div>
      <div class="sm:block  aspect-w-1 aspect-h-1 mt-8">
        <img class="w-full object-cover rounded-lg" src="https://images.unsplash.com/photo-1498603993951-8a027a8a8f84?ixlib=rb-1.2.1&amp;ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&amp;auto=format&amp;fit=crop&amp;w=2936&amp;q=80">
      </div>
      <div class="sm:block  aspect-w-1 aspect-h-1 mt-8">
        <img class="w-full object-cover rounded-lg" src="https://images.unsplash.com/photo-1526400473556-aac12354f3db?ixlib=rb-1.2.1&amp;ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&amp;auto=format&amp;fit=crop&amp;w=2940&amp;q=80">
      </div>
      <div class="sm:block  aspect-w-1 aspect-h-1 mt-8">
        <img class="w-full object-cover rounded-lg" src="https://images.unsplash.com/photo-1617369120004-4fc70312c5e6?ixlib=rb-1.2.1&amp;ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&amp;auto=format&amp;fit=crop&amp;w=1587&amp;q=80">
      </div>
      <div class="sm:block  aspect-w-16 aspect-h-9 mt-8">
        <img class="w-full object-cover rounded-lg" src="https://images.unsplash.com/photo-1518892096458-a169843d7f7f?ixlib=rb-1.2.1&amp;ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&amp;auto=format&amp;fit=crop&amp;w=2940&amp;q=80">
      </div>
    </div>
  </div>
</body>
```

æ•ˆæœå›¾ï¼š

å¤§å±ï¼š


![image.png](/img/posts/2023-11-11/2023-11-11-20.png)

å°å±ï¼š


![image.png](/img/posts/2023-11-11/2023-11-11-21.png)

#### ï¼ˆ3. å†™ä¸€ä¸ªå¸¦åŠ¨ç”»çš„ç»„ä»¶

tailwindcss å†…ç½®äº†ä¸€ä¸ªå°å‹çš„åŠ¨ç”»åº“ï¼Œå¯ä»¥ä½¿ç”¨ç±»æ¥æ§åˆ¶ã€‚ä¸‹é¢çš„ä»£ç æ˜¯ä¸€ä¸ªå¼¹è·³çš„æŒ‰é’®ï¼š

```html
<button type="button" class="animate-bounce bg-indigo-500 text-white p-2 rounded-md">
  Hello World
</button>
```

æ•ˆæœå¦‚ä¸‹ï¼š

![å±å¹•å½•åˆ¶2023-11-16-ä¸‹åˆ2.37.29.gif](/img/posts/2023-11-11/2023-11-11-22.gif)


-----

å¤§è‡´è®²è§£å°±è¿™ä¹ˆå¤šå•¦ï¼Œå€ºè§ï¼54:T3797,## 1. Hooks

### use

`use` æ˜¯ä¸€ä¸ªå¯ä»¥åœ¨åˆ†æ”¯è·Ÿå¾ªç¯ä¸­ä½¿ç”¨çš„ React Hookï¼Œå®ƒå¯ä»¥è®©ä½ è¯»å–ç±»ä¼¼äº [Promise](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Promise) æˆ– [context](https://zh-hans.react.dev/learn/passing-data-deeply-with-context) çš„èµ„æºçš„å€¼ã€‚

> `use` Hook ç›®å‰ä»…åœ¨ canary ä¸ experimental æ¸ é“ä¸­å¯ç”¨

- ä½¿ç”¨ use è¯»å– context çš„å€¼

```js
const theme = use(ThemeContext);
```
æ­¤æ—¶ç±»ä¼¼äº useContextï¼Œä¸è¿‡ use æ›´åŠ çµæ´»ã€‚React ä¼šæœç´¢ç»„ä»¶æ ‘å¹¶æ‰¾åˆ° æœ€æ¥è¿‘çš„ context provider ä»¥ç¡®å®šéœ€è¦è¿”å›çš„ context å€¼ã€‚å®ƒå‘ä¸Šæœç´¢å¹¶å¿½ç•¥è°ƒç”¨ `use(context)` çš„ç»„ä»¶æœ¬èº«ä¸­çš„ context providerã€‚

- ä¼ é€’ promise çš„å€¼

å¦‚æœä½ ä½¿ç”¨äº†æœåŠ¡ç«¯æ¸²æŸ“ API æ¥æ‰‹åŠ¨é…ç½® SSRï¼Œä½ å¯èƒ½ä¼šåœ¨æœåŠ¡ç«¯æ¨é€ä¸€ä¸ªæµå¼ï¼ˆstreamï¼‰æ•°æ®ï¼Œåœ¨å®¢æˆ·ç«¯å¯ä»¥ä½¿ç”¨ use æ¥å—ã€‚

```js
// æ ¹ç»„ä»¶é€šè¿‡ fetchMessage è·å–æµï¼ŒåŒ…è£…ä¸º promise ç»™åˆ° Messageç»„ä»¶
export default function App() {
  const messagePromise = fetchMessage();
  return (
    <Suspense fallback={<p>waiting for message...</p>}>
      <Message messagePromise={messagePromise} />
    </Suspense>
  );
}
```

Messageç»„ä»¶ä¸­ï¼š

```js
// message.js
'use client';

import { use } from 'react';

export function Message({ messagePromise }) {
  const messageContent = use(messagePromise);
  return <p>Here is the message: {messageContent}</p>;
}
```

use å¯ä»¥å’Œ Suspense è”åŠ¨ï¼Œå½“ä¼ é€’çš„ promise æ²¡æœ‰ fullfill æ—¶ï¼Œloading ä¸€ç›´ç”Ÿæ•ˆï¼Œå½“ promise æˆåŠŸä»¥åï¼Œæ˜¾ç¤º resolve çš„å€¼ã€‚

> å°†æ¥è‡ªæœåŠ¡å™¨ç»„ä»¶çš„ Promise ä¼ é€’è‡³å®¢æˆ·ç«¯ç»„ä»¶æ—¶ï¼Œå…¶è§£æå€¼å¿…é¡»å¯åºåˆ—åŒ–ä»¥åœ¨æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯ä¹‹é—´ä¼ é€’ã€‚åƒå‡½æ•°è¿™æ ·çš„æ•°æ®ç±»å‹ä¸å¯åºåˆ—åŒ–ï¼Œä¸èƒ½æˆä¸ºè¿™ç§ Promise çš„è§£æå€¼ã€‚

- å¤„ç† promise é”™è¯¯è¾¹ç•Œ

å½“ promise æŠ¥é”™æ—¶ï¼Œuse éœ€è¦æ‰‹åŠ¨è®¾ç½®æ•è·é”™è¯¯ï¼š

```js
import { ErrorBoundary } from "react-error-boundary";

<ErrorBoundary fallback={<p>âš ï¸Something went wrong</p>}>
  <Suspense fallback={<p>âŒ›Downloading message...</p>}>
    <Message messagePromise={messagePromise} />
  </Suspense>
</ErrorBoundary>
```

ä¸Šé¢çš„ç¤ºä¾‹ä½¿ç”¨äº†ç¬¬ä¸‰æ–¹åº“ï¼Œå¦‚æœä¸ä½¿ç”¨ ErrorBoundary åŒ…è£¹ï¼Œè¿˜å¯ä»¥è¿™æ ·å†™ï¼š

```js
  const messagePromise = new Promise((resolve, reject) => {
    reject();
  }).catch(() => {
    return "no new message found.";
  });
```
ä½¿ç”¨ promise è‡ªå¸¦çš„ catch æ•è·é”™è¯¯ã€‚catch ä¸­ return çš„å†…å®¹ï¼Œä¼šè¢«è§†ä½œæ­£å¸¸çš„è¿”å›ã€‚

> ä¸èƒ½åœ¨ React ç»„ä»¶æˆ– Hook å‡½æ•°ä¹‹å¤–è°ƒç”¨ `use`ï¼Œæˆ–è€…åœ¨ try-catch å—ä¸­è°ƒç”¨ `use`

### useOptimistic

> `useOptimistic`Â Hook ç›®å‰ä»…åœ¨ canary ä¸ experimental æ¸ é“ä¸­å¯ç”¨

è¿™ä¸ª hook ç”¨äºä¼˜åŒ– UI çš„æ›´æ–°ã€‚

è€ƒè™‘ä¸‹é¢çš„åœºæ™¯ï¼Œç•Œé¢ä¸Šä¸€ä¸ªæŒ‰é’®ï¼Œç‚¹å‡»å¯ä»¥å¼‚æ­¥è°ƒç”¨å‘é€æ¥å£ï¼š

```js
<form action={formAction} ref={formRef}>
  <input type="text" name="message" placeholder="Hello!" />
  <button type="submit">Send</button>
</form>
```

è¡¨å•å“åº”ï¼Œåœ¨å‘é€å®Œæ•°æ®åæ˜¾ç¤ºå‘é€çš„æ•°æ®ï¼š

```js
async function formAction(formData) {
  // è¿™ä¸€æ¡ç°åœ¨æ²¡æœ‰ï¼Œä¸‹é¢å¼•å…¥ä¹è§‚æ¶ˆæ¯æ—¶åŠ å…¥
  addOptimisticMessage(formData.get("message"));
  formRef.current.reset();
  await sendMessage(formData);
}

async function sendMessage(formData) {
  // deliverMessage æ˜¯ API çš„è°ƒç”¨
  const sentMessage = await deliverMessage(formData.get("message"));
  setMessages([...messages, { text: sentMessage }]);
}
```
è¿™é‡Œæœ‰ä¸ªé—®é¢˜ï¼ŒsendMessage æ˜¯ä¸ªå¼‚æ­¥ä»»åŠ¡ï¼Œåœ¨å‘é€å®Œæˆåï¼Œè°ƒç”¨ setMessages æ”¹å˜ state çš„å€¼ï¼Œè¿™æ—¶åœ¨å‘é€è®°å½•åˆ—è¡¨é‡Œå°±ä¼šæœ‰ä¸€æ¡è®°å½•ã€‚ä½†æ˜¯åœ¨å‘é€è¿‡ç¨‹ä¸­ï¼Œè¯¥è®°å½•æ˜¯ä¸ä¼šå‡ºç°çš„ã€‚

æ­¤æ—¶ï¼Œæˆ‘ä»¬å£°æ˜ä¸€ä¸ªä¹è§‚çŠ¶æ€ï¼š

```js
 const [optimisticMessages, addOptimisticMessage] = useOptimistic(
    messages,
    (state, newMessage) => [
      ...state,
      {
        text: newMessage,
        sending: true
      }
    ]
  );
```
ä»–ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯åˆšåˆšçš„ stateï¼šmessagesï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯ä¸€ä¸ªå›è°ƒï¼Œå®æ—¶æ¥å—æœ€æ–°çš„çŠ¶æ€å¹¶è¿”å›è‡ªå®šä¹‰çš„ç»“æ„ã€‚

æˆ‘ä»¬åœ¨åˆ—è¡¨æ¸²æŸ“çš„åœ°æ–¹å°±å¯ä»¥è¿™æ ·å†™äº†ï¼š

```js
{optimisticMessages.map((message, index) => (
    <div key={index}>
      {message.text}
      {!!message.sending && <small> (Sending...)</small>}
    </div>
))}
```
è¿™æ ·ï¼Œåœ¨å‘é€çš„è¿‡ç¨‹ä¸­ï¼ŒaddOptimisticMessage è¢«è°ƒç”¨äº†ï¼Œæ•°ç»„è¿½åŠ çš„é‚£ä¸ªå…ƒç´ å¤„äº sending ä¸­ï¼Œå°±ä¼šæ˜¾ç¤º sending çš„æ–‡æœ¬ï¼›åœ¨æ¥å£è¯·æ±‚æˆåŠŸåï¼ŒoptimisticMessages ä¼šæ£€æµ‹åˆ°è¯·æ±‚å®Œæ¯•ï¼Œè‡ªåŠ¨ç¦»åœºã€‚æˆ‘ä»¬å®éªŒä¸¤æ¬¡ï¼Œæ‰“å°ä¸€ä¸‹è¿™ä¸ª optimisticMessages çŠ¶æ€çš„å€¼ï¼š


![image.png](/img/posts/2023-11-9/2023-11-9-1.png)

å½“æ¥å£è°ƒç”¨å®Œæ¯•åï¼Œå› ä¸ºè°ƒç”¨äº† sendMessageï¼Œæ‰€ä»¥ addOptimisticMessages å’Œ messages ä¸¤ä¸ªçŠ¶æ€å°±è¶‹äºä¸€è‡´äº†ã€‚

> **useOptimistic** æ˜¯ä¸€ç§ä¹è§‚æ›´æ–°æœºåˆ¶ï¼Œä¸»è¦åº”ç”¨äºéœ€è¦ä¸æœåŠ¡å™¨è¿›è¡Œå¼‚æ­¥äº¤äº’çš„åœºæ™¯ï¼Œå¦‚æ¶ˆæ¯å‘é€ã€‚åœ¨è¿™ç§æœºåˆ¶ä¸‹ï¼Œé€šå¸¸å¸Œæœ›ä¼˜å…ˆæ˜¾ç¤ºæ–°æ•°æ®æˆ–æ–°çŠ¶æ€ï¼Œè€Œä¸æ˜¯ç­‰å¾…æœåŠ¡å™¨è¿”å›å“åº”åå†è¿›è¡Œæ›´æ–°ï¼›
> 
> **useTransition** ä¸»è¦è§£å†³çš„æ˜¯åœ¨ç•Œé¢åˆ‡æ¢è¿‡ç¨‹ä¸­å¯èƒ½å‡ºç°çš„å†…å®¹åŠ è½½é—®é¢˜ã€‚å®ƒå…è®¸ç»„ä»¶åœ¨åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªç•Œé¢ä¹‹å‰ç­‰å¾…å†…å®¹åŠ è½½ï¼Œä»è€Œé¿å…å‡ºç°ä¸å¿…è¦çš„åŠ è½½çŠ¶æ€ã€‚

### useFormState

> `useFormState` Hook ç›®å‰ä»…åœ¨ canary ä¸ experimental æ¸ é“ä¸­å¯ç”¨

`useFormState` æ˜¯ react-dom åº“ä¸‹çš„ hookï¼Œå…è®¸æ ¹æ®è¡¨å•æ“ä½œçš„ç»“æœæ›´æ–°çŠ¶æ€ã€‚æˆ‘ä»¬å¯ä»¥è¿™æ ·ä½¿ç”¨ï¼š

```js
function AddToCartForm({itemID, itemTitle}) {
  const [message, formAction] = useFormState(addToCart, null);
  return (
    <form action={formAction}>
      <h2>{itemTitle}</h2>
      <input type="hidden" name="itemID" value={itemID} />
      <button type="submit">Add to Cart</button>
      {message}
    </form>
  );
}
```
å…¶ä¸­ action.js

```js
"use server";

// æ¨¡æ‹ŸæœåŠ¡ç«¯å…¥åº“å“åº”
export async function addToCart(prevState, queryData) {
  const itemID = queryData.get('itemID');
  if (itemID === "1") {
    return "Added to cart";
  } else {
    return "Couldn't add to cart: the item is sold out.";
  }
}
```

useFormState ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯actionè§¦å‘å‡½æ•°ï¼Œç¬¬äºŒä¸ªæ˜¯ åˆå§‹å€¼ã€‚å½“è§¦å‘ action æäº¤æ—¶ï¼Œç¬¬ä¸€ä¸ªå‚æ•°ä¼šè¢«è°ƒç”¨ï¼ŒaddToCart æ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªæ˜¯å˜åŒ–å‰ message çš„å€¼ï¼Œç¬¬äºŒä¸ªæ˜¯ formData å¯¹è±¡ï¼Œå…¶è¿”å›çš„å€¼ä¼šå¤åˆ¶åˆ° message é‡Œï¼Œå¹¶æ˜¾ç¤ºåœ¨ç•Œé¢ä¸Šã€‚
 
message å¯ä»¥ç†è§£ä¸ºéªŒè¯è¡¨å•åçš„è¿”å›å€¼ã€‚

ä¸Šé¢ä»£ç æ‰§è¡Œæµç¨‹ï¼š

ç‚¹å‡»æäº¤ ==> è§¦å‘ addToCart ==> è¿”å›è¡¨å•å¤„ç†çš„ç»“æœï¼Œè‡ªåŠ¨èµ‹å€¼ç»™ message

> è¿™ä¸ª hook å¯ä»¥ç”¨äºè¡¨å•æ ¡éªŒåçš„é”™è¯¯/ä¿¡æ¯å±•ç¤ºï¼Œåªæ”¯æŒåœ¨å®¢æˆ·ç«¯ä½¿ç”¨

### useFormStatus

> `useFormStatus`Â Hook ç›®å‰ä»…åœ¨ canary ä¸ experimental æ¸ é“ä¸­å¯ç”¨

ä¸ useFormState éƒ½æ˜¯ react-dom åº“ä¸‹çš„ hookï¼Œä½†æ˜¯ä¸å‰è€…ç»Ÿä¸€æ”¶é›†è¡¨å•æ ¡éªŒçŠ¶æ€ä¸åŒï¼Œ`useFormStatus` æ˜¯ä¸€ä¸ªæä¾›è¡¨å•æäº¤åçŠ¶æ€ä¿¡æ¯çš„ Hookã€‚

å…¶ä½¿ç”¨åœ¨è¡¨å•å†…éƒ¨ï¼š

```js
<form action={submitForm}>
  <UsernameForm />
</form>

...

export async function submitForm(query) {
  await new Promise((res) => setTimeout(res, 1000));
}
```
æˆ‘ä»¬åœ¨ UsernameForm ä¸­å®šä¹‰ä¸€ä¸ªï¼š

```js
const {pending, data} = useFormStatus();

...
<button type="submit" disabled={pending}>
  {pending ? 'æäº¤ä¸­â€¦â€¦' : 'æäº¤'}
</button>
{showSubmitted ? (
  <p>æäº¤è¯·æ±‚ç”¨æˆ·åï¼š{submittedUsername.current}</p>
) : null}
```

è¡¨å•çš„æäº¤ action æ˜¯ä¸€ä¸ªå¼‚æ­¥è¯·æ±‚ï¼Œæ¯”å¦‚ Promiseï¼Œå½“å¼‚æ­¥è¯·æ±‚æ²¡æœ‰ç»“æŸæ—¶ï¼Œpending å°±ä¼šæ˜¯ trueï¼Œè¯¥è¿‡ç¨‹ä¸­ data ä¾¿æ˜¯æ•´ä¸ªè¡¨å•æäº¤çš„æ•°æ®ä¿¡æ¯ã€‚è¿™ä¸ª hook ç›¸å½“äºåœ¨æäº¤è¿‡ç¨‹ä¸­å°†è¡¨å•æ•°æ®å’Œæäº¤è¿›åº¦æš´éœ²äº†å‡ºæ¥ï¼Œä¾¿äºå‰ç«¯å±•ç¤ºå¯¹åº”çš„å“åº”å¼é¡µé¢ã€‚

## 2. APIs

### cache

`cache` å…è®¸ç¼“å­˜æ•°æ®è·å–æˆ–è®¡ç®—çš„ç»“æœã€‚ä»–å¯ä»¥åœ¨**ä»»ä½•ç»„ä»¶ä¹‹å¤–**è°ƒç”¨ï¼Œæ˜¯ç¼“å­˜ hook çš„é€šç”¨å½¢å¼ã€‚

> `cache` ä»…åœ¨ React çš„ [Canary](https://zh-hans.react.dev/community/versioning-policy#canary-channel) å’Œ [experimental](https://zh-hans.react.dev/community/versioning-policy#experimental-channel) æ¸ é“ä¸­å¯ç”¨

- ç¼“å­˜é‡å¤è®¡ç®—

æ¯”å¦‚æˆ‘ä»¬æœ‰ä¸€ä¸ªå¾ˆå¤æ‚çš„è®¡ç®—ï¼š

```js
import calculateUserMetrics from 'lib/user';

const getUserMetrics = cache(calculateUserMetrics);
```
ä½¿ç”¨ cache ç¼“å­˜ä»¥åï¼Œåœ¨å‡½æ•°é‡Œç›´æ¥å¼•ç”¨å³å¯ï¼š

```js
function TeamReport({users}) {
  for (let user in users) {
    const metrics = getUserMetrics(user);
    // ...
  }
  // ...
}
```

cache æ¥å—ä¸€ä¸ªå‡½æ•°å½“åšè®¡ç®—å‡½æ•°ï¼Œcache è¿”å›çš„å€¼ä¸ºä¸€ä¸ªå•ä¾‹å‡½æ•°ï¼Œå†³å®šè¿™ä¸ªå‡½æ•°æ˜¯å¦è·å–ç¼“å­˜çš„å”¯ä¸€æŒ‡æ ‡å°±æ˜¯ä¼ å…¥çš„å€¼æ˜¯å¦ä¸€è‡´ï¼Œå¦‚æœä¸¤æ¬¡æ¢å…¥çš„å‚æ•°ï¼ˆä¸Šé¢çš„ä¾‹å­æ˜¯ user å¯¹è±¡ï¼‰å¼•ç”¨ç›¸åŒï¼Œåˆ™ç¬¬äºŒæ¬¡ä½¿ç”¨ç¼“å­˜ã€‚

- ç¼“å­˜ API æ•°æ®

```js
const getTemperature = cache(async (city) => {
	return await fetchTemperature(city);
});

// ä½¿ç”¨
async function AnimatedWeatherCard({city}) {
	const temperature = await getTemperature(city);
	// ...
}
```

ç±»ä¼¼åœ°ï¼Œä»–å¯ä»¥æ¥å—å¼‚æ­¥å‡½æ•°ä½œä¸ºè®¡ç®—å‡½æ•°ä¼ å…¥ï¼Œä¼ å…¥çš„ city ä¸ºç›¸åŒçš„å€¼æ—¶ï¼Œç›´æ¥å–ç¼“å­˜ã€‚

- é¢„åŠ è½½æ•°æ®

å¯ä»¥ç”¨ cache æ‰‹åŠ¨é…ç½®é¢„åŠ è½½ï¼Œåœ¨é¡µé¢åˆå§‹åŒ–æ—¶é¢„å…ˆè·å–æ•°æ®ï¼š

```js
const getUser = cache(async (id) => {
  return await db.user.query(id);
})
...
function Home({id}) {
  // âœ… æ­£ç¡®ç¤ºä¾‹ï¼šå¼€å§‹è·å–ç”¨æˆ·æ•°æ®ã€‚
  getUser(id);
  // â€¦â€¦ä¸€äº›è®¡ç®—å·¥ä½œ
  return (
    <>
      <Profile id={id} />
    </>
  );
}
```
è¿™æ ·ï¼Œåœ¨æ”¹ç™»å½•ç”¨æˆ·çš„ä»»æ„é¡µé¢ï¼Œéƒ½å¯ä»¥æˆ‘å»¶æ—¶è·å–ç”¨æˆ·ä¿¡æ¯ï¼š

```js
const user = await getUser(id);
```

### experimental_taintObjectReference

è¿™ä¸ª API è¿˜ä¸ç¨³å®šï¼Œè¿˜åœ¨å¼€å‘ä¸­ï¼Œç”¨äºé˜»æ­¢ç‰¹å®šç”¨æˆ·æ•°æ®å¯¹è±¡å®ä¾‹è¢«ä¼ é€’ç»™å®¢æˆ·ç«¯ç»„ä»¶ï¼Œä¾‹å¦‚ `user` å¯¹è±¡ã€‚

```js
import {experimental_taintObjectReference} from 'react';

export async function getUser(id) {
  const user = await db`SELECT * FROM users WHERE id = ${id}`;
  experimental_taintObjectReference(
    'Do not pass the entire user object to the client. ' +
      'Instead, pick off the specific properties you need for this use case.',
    user,
  );
  return user;
}
```
ä»–çš„å­—é¢æ„æ€æ˜¯æ±¡æŸ“å¯¹è±¡å¼•ç”¨ï¼Œå°±æ˜¯è¯´å°† user åŠ«æŒäº†ï¼Œä¸ç»™ä½ å®¢æˆ·ç«¯ç”¨äº†ã€‚ç›®å‰è½åœ°å®ç°è¿˜ä¸æ˜ç¡®ï¼ŒæœŸå¾…æ­£å¼ç‰ˆæœ¬ã€‚

### experimental_taintUniqueValue

è¿™ä¸ª API è¿˜ä¸ç¨³å®šï¼Œè¿˜åœ¨å¼€å‘ä¸­ï¼Œç”¨äºé˜²æ­¢å°†å”¯ä¸€å€¼ä¼ é€’ç»™å®¢æˆ·ç«¯ç»„ä»¶ï¼Œä¾‹å¦‚å¯†ç ã€å¯†é’¥æˆ–ä»¤ç‰Œã€‚

```js
import {experimental_taintUniqueValue} from 'react';

export async function getUser(id) {
  const user = await db`SELECT * FROM users WHERE id = ${id}`;
  experimental_taintUniqueValue(
    'Do not pass a user session token to the client.',
    user,
    user.session.token
  );
  return user;
}
```

å®˜æ–¹åªç»™äº†è¿™ä¹ˆä¸ªä¾‹å­ï¼Œå…·ä½“ä½¿ç”¨ç»†èŠ‚è¿˜æœ‰å¾…è€ƒè¯ã€‚

## 3. æŒ‡ä»¤

æŒ‡ä»¤è¿™ä¸ªæ¦‚å¿µåœ¨ react ä¸­ç®—æ˜¯ä¸€ä¸ªç¨€å¥‡äº‹ï¼Œvue ä¸­æœ‰ v-ifï¼Œng ä¸­å¤©ç„¶å†…ç½® Directiveï¼Œreact ä¸­è¿™ä¹Ÿå¼€å§‹å¼•å…¥æŒ‡ä»¤çš„æ¦‚å¿µäº†ã€‚

### use client

ç”¨äºæœåŠ¡ç«¯æ¸²æŸ“ä»£ç é‡Œã€‚React æœåŠ¡ç«¯ç»„ä»¶é»˜è®¤æ˜¯èµ° SSR çš„ï¼Œä½¿ç”¨è¿™ä¸ªæŒ‡ä»¤æŒ‡å®šå½“å‰æ–‡ä»¶æ˜¯å±äºå®¢æˆ·ç«¯çš„ã€‚

å¯ä»¥è¿™æ ·ä½¿ç”¨ï¼š

```js
'use client';

import { useState } from 'react';
import inspirations from './inspirations'; // å­—åº“ï¼Œè¿™é‡Œå¯å¿½ç•¥
import FancyText from './FancyText';  // å±•ç¤ºæ–‡å­—çš„ç»„ä»¶

export default function InspirationGenerator({children}) {
  const [index, setIndex] = useState(0);
  const quote = inspirations[index];
  const next = () => setIndex((index + 1) % inspirations.length);

  return (
    <>
      <p>Your inspirational quote is:</p>
      <FancyText text={quote} />
      <button onClick={next}>Inspire me again</button>
      {children}
    </>
  );
}
```
ä¸Šé¢çš„ç»„ä»¶æ˜¯ä¸€ä¸ªå°è£…çš„æ–‡å­—ç”Ÿæˆå™¨ç»„ä»¶ï¼Œæˆ‘ä»¬åœ¨å…¥å£æ–‡ä»¶ä¸­å¼•å…¥ï¼š

```js
import FancyText from './FancyText';
import InspirationGenerator from './InspirationGenerator';
import Copyright from './Copyright';

export default function App() {
  return (
    <>
      <FancyText title text="Get Inspired App" />
      <InspirationGenerator>
        <Copyright year={2004} />
      </InspirationGenerator>
    </>
  );
}
```
è¿™å°±åšäº†éš”ç¦»äº†ï¼Œæ€»çš„ä»£ç éƒ½æ˜¯æœåŠ¡ç«¯ç›´å‡ºçš„ï¼Œä½†æ˜¯ InspirationGenerator æ ‡è®°äº†ä½¿ç”¨åœ¨å®¢æˆ·ç«¯ã€‚æˆ‘ä»¬å€Ÿç”¨å®˜ç½‘çš„è°ƒç”¨æ ‘è¯´æ˜ç°åœ¨çš„å¼•ç”¨å…³ç³»ï¼š



![image.png](/img/posts/2023-11-9/2023-11-9-2.png)

InspirationGenerator æ ‡è®°äº†ä¸ºå®¢æˆ·ç«¯æ¸²æŸ“ï¼Œåˆ™å…¶ä½œä¸ºå…¶å®èŠ‚ç‚¹çš„æ‰€æœ‰å¶å­èŠ‚ç‚¹éƒ½ä¼šé‡‡ç”¨å®¢æˆ·ç«¯æ¸²æŸ“äº†ã€‚

æˆ‘ä»¬å†æ¥çœ‹ä¸€ä¸‹æ¸²æŸ“å…³ç³»ï¼š


![image.png](/img/posts/2023-11-9/2023-11-9-3.png)

å¯ä»¥çœ‹åˆ°ï¼ŒCopyright è™½ç„¶æ˜¯ InspirationGenerator ç»„ä»¶å†…éƒ¨çš„ childrenï¼Œä½†æ˜¯ä»å¼•ç”¨å…³ç³»æ¥çœ‹ï¼Œæ²¡æœ‰è¢« 'use client' æ ‡è®°ï¼Œæ‰€ä»¥å°±èµ°æœåŠ¡ç«¯æ¸²æŸ“ã€‚

### use server

ç”¨äºæœåŠ¡ç«¯æ¸²æŸ“ä»£ç é‡Œã€‚React æœåŠ¡ç«¯ç»„ä»¶é»˜è®¤æ˜¯èµ° SSR çš„ï¼Œä½¿ç”¨è¿™ä¸ªæŒ‡ä»¤æŒ‡å®šå½“å‰æ–‡ä»¶æ˜¯å±äºæœåŠ¡ç«¯çš„ã€‚

è¿™å°±ç±»ä¼¼äº next.js é‡Œè¾¹çš„ getServerSidePropsï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹ç¤ºä¾‹ä»£ç ï¼š

```js
// App.js

async function requestUsername(formData) {
  'use server';
  const username = formData.get('username');
  // ...
}

export default App() {
  <form action={requestUsername}>
    <input type="text" name="username" />
    <button type="submit">Request</button>
  </form>
}
```

åœ¨æœåŠ¡ç«¯æ¸²æŸ“æ—¶ï¼Œæˆ‘ä»¬äººä¸ºæ ‡è®° requestUsername å‡½æ•°æ˜¯å±äºæœåŠ¡ç«¯çš„ï¼Œè¿™æ ·åœ¨é¡¹ç›®ä»£ç æ‰“åŒ…ä¸º bundle æ—¶å°±ä¼šç›´æ¥é¢„å…ˆè°ƒç”¨ requestUsernameï¼Œç›¸å½“äºé»˜è®¤æäº¤äº†ä¸€æ¬¡è¡¨å•ã€‚

è€Œä¸”ï¼Œæ ‡è®°ä¸ºæœåŠ¡ç«¯çš„å‡½æ•°å¯ä»¥è®¾ç½®ä¸ºå¼‚æ­¥ï¼š

```js
// actions.js
'use server';

let likeCount = 0;
export default async incrementLike() {
  likeCount++;
  return likeCount;
}
```

è¿™æ ·åœ¨å®¢æˆ·ç«¯ä»£ç ä¸­å°±å¯ä»¥å¼‚æ­¥æ¥æ”¶äº†ï¼š


```js
startTransition(async () => {
  const currentCount = await incrementLike();
});
```

> å…³äº use client å’Œ use serverï¼Œå®˜æ–¹çš„ä½¿ç”¨æ¡ˆä¾‹è¾ƒå°‘ï¼Œä¹Ÿæ²¡æœ‰å¦å¤–çš„å‚è€ƒã€‚å¦‚æœåæœŸè¿™ä¸ª API è¾ƒä¸ºæˆç†Ÿåï¼Œæˆ‘ä¼šè¡¥å……ä½¿ç”¨æ¡ˆä¾‹
-----55:T4fa4,## 1. æœåŠ¡ç«¯æ¸²æŸ“

æœåŠ¡ç«¯æ¸²æŸ“æ˜¯æœåŠ¡ç«¯è¿”å›æ¸²æŸ“å‡ºçš„ html å­—ç¬¦ä¸²ï¼ˆæˆ–æ•°æ®æµï¼‰ï¼Œæµè§ˆå™¨æ¥è§£æ html ä»¥æ„å»ºé¡µé¢ã€‚åœ¨ React å¼€å‘ä¸­ï¼Œè¦æƒ³ä½¿ç”¨ SSRï¼Œæœ‰ä¸¤ç§æ–¹å¼ï¼š

1. ä½¿ç”¨ Nextjs
2. æ‰‹åŠ¨æ­å»ºæœåŠ¡ç«¯æ¸²æŸ“

å®˜ç½‘æåˆ°çš„æœåŠ¡ç«¯ API å°±æ˜¯ React æä¾›çš„æ”¯æŒæ‰‹åŠ¨æ­å»ºæœåŠ¡ç«¯æ¸²æŸ“çš„ã€‚å…¶**æœ¬è´¨æ˜¯æœåŠ¡ç«¯ç›´æ¥å°†ä¸€ä¸ªç”Ÿæˆå¥½çš„ HTML ç»™åˆ°å‰ç«¯ï¼Œå‰ç«¯ä¸€æ¬¡æ€§æ¸²æŸ“**ï¼Œä¾¿äºåŠ é€Ÿé¦–å±åŠ è½½å’Œè¿›è¡Œ SEOã€‚è¿™é‡Œæœ‰ä¸ªé—®é¢˜ï¼Œå®¢æˆ·ç«¯å·¥ä½œå¹¶ä¸ä»…ä»…æ˜¯æ¸²æŸ“æœåŠ¡å™¨è¿”å›çš„ htmlï¼Œä¸ºäº†ä¿è¯æœåŠ¡ç«¯è¿”å›çš„ html åœ¨å®¢æˆ·ç«¯èƒ½å¤Ÿå¤„ç†äº‹ä»¶å’Œäº¤äº’ï¼Œå®¢æˆ·ç«¯è¦é‡æ–°è¿›è¡Œ vdom çš„æ„å»ºå’Œäº‹ä»¶ç»‘å®šï¼Œå³ï¼Œ**åœ¨æ¸²æŸ“å‡º html åï¼ŒæŠŠç›¸åº”ç»„ä»¶å…³è”åˆ°å…¶å¯¹åº”çš„ç»„ä»¶ä¸Šï¼Œå¹¶æ·»åŠ äº¤äº’é€»è¾‘å’Œç®¡ç†ä¹‹åçš„æ¸²æŸ“ï¼ˆhtml æ˜ å°„ä¸º React æ ‘ï¼‰**ã€‚

ä¹Ÿå°±æ˜¯è¯´ï¼Œå‰ç«¯ç»„ä»¶é€»è¾‘åœ¨æœåŠ¡ç«¯æ¸²æŸ“ä¸€æ¬¡åï¼Œåœ¨å®¢æˆ·ç«¯ä¹Ÿè¦é’ˆå¯¹æ€§çš„æ¸²æŸ“ä¸€æ¬¡ï¼Œè¿™ä¸ªè¿‡ç¨‹å«æ°´åˆï¼ˆhydrateï¼‰ï¼Œè¿™ä¸¤æ¬¡æ¸²æŸ“å«åšåŒæ„æ¸²æŸ“ã€‚

> å°½ç®¡æœåŠ¡ç«¯æ¸²æŸ“ï¼ˆSSRï¼‰å¹¶ hydrate çš„è¿‡ç¨‹æ¯”çº¯ç²¹çš„å®¢æˆ·ç«¯æ¸²æŸ“ï¼ˆCSRï¼‰çœ‹èµ·æ¥æ›´ç¹çï¼Œä½†æ˜¯å®ƒå®é™…ä¸Šå¯ä»¥èŠ‚çœæ¸²æŸ“æ—¶é—´ï¼Œç‰¹åˆ«æ˜¯åœ¨å¤æ‚çš„ React åº”ç”¨ä¸­ã€‚

### SSR vs CSR

æœåŠ¡ç«¯ç”¨æ¥å­˜å‚¨å’Œå“åº”æ•°æ®ï¼Œå®¢æˆ·ç«¯ç”¨äºè¯·æ±‚å’Œå±•ç¤ºæ•°æ®ï¼Œä»–ä»¬éƒ½æœ‰è‡ªå·±çš„æ¸²æŸ“æ–¹å¼ã€‚å°½ç®¡è¿™ä¸¤ç§æ–¹æ³•éƒ½æ¶‰åŠåˆ°ä»æœåŠ¡å™¨è·å– HTML å¹¶åœ¨æµè§ˆå™¨ä¸­è§£æï¼Œä½†å®ƒä»¬ä¹‹é—´å­˜åœ¨ä¸€äº›é‡è¦çš„åŒºåˆ«ã€‚

1.  åˆå§‹æ¸²æŸ“ï¼šSSR ç³»ç»Ÿä¸­ï¼ŒæœåŠ¡ç«¯å·²ç»è¿”å›äº†å®Œæ•´çš„é¡µé¢ï¼Œå®¢æˆ·ç«¯åªéœ€è¦åšå°‘é‡çš„æ°´åˆæ“ä½œå³å¯ï¼›CSR ç³»ç»Ÿä¸­ï¼ŒæœåŠ¡å™¨è¿”å›çš„æ˜¯å…¥å£çš„æœ€å°åŒ–çš„ html (index.html)ï¼Œå®¢æˆ·ç«¯éœ€è¦é€šè¿‡ä¸‹è½½å¥½çš„ cssã€js æ–‡ä»¶é€è¡Œè§£æå¹¶æ„å»º DOM å’Œ CSSOMï¼Œæœ€ç»ˆç”Ÿæˆå®Œæ•´çš„ htmlã€‚
2.  äº¤äº’æ€§ï¼šåœ¨ SSR ä¸­ï¼Œç”±äº HTML æ˜¯åœ¨æœåŠ¡å™¨ä¸Šé¢„å…ˆæ¸²æŸ“çš„ï¼Œæ‰€ä»¥ä»ä¸€å¼€å§‹å°±å…·æœ‰äº¤äº’æ€§ã€‚è¿™æ„å‘³ç€ç”¨æˆ·å¯ä»¥åœ¨é¡µé¢åŠ è½½åç«‹å³çœ‹åˆ°æ‰€æœ‰çš„åŠŸèƒ½å’Œå†…å®¹ï¼Œè€Œä¸éœ€è¦ç­‰å¾…å®¢æˆ·ç«¯ JavaScript ä»£ç æ‰§è¡Œã€‚è€Œåœ¨ CSR ä¸­ï¼Œç”¨æˆ·å¯èƒ½éœ€è¦ç­‰å¾…ä¸€æ®µæ—¶é—´ï¼ˆjsæ‰§è¡Œï¼ŒDOMæ„å»ºç­‰è€—æ—¶æ“ä½œï¼‰æ‰èƒ½çœ‹åˆ°äº¤äº’åŠŸèƒ½ã€‚
3.  SEOï¼šç”±äºæœç´¢å¼•æ“é€šå¸¸æ›´æ“…é•¿è§£æ HTMLï¼Œè€Œä¸æ˜¯ JavaScriptï¼Œå› æ­¤ SSR å¯ä»¥æé«˜æœç´¢å¼•æ“ä¼˜åŒ–ï¼ˆSEOï¼‰ã€‚æœç´¢å¼•æ“å¯ä»¥æ›´å®¹æ˜“åœ°è¯»å–å’Œç†è§£ SSR ç”Ÿæˆçš„ HTML ä¸­çš„å†…å®¹ã€‚è€Œ CSR åˆå§‹åŒ–çš„ html ä»…ä»…æ˜¯ä¸€ä¸ªå…¥å£æ–‡ä»¶ï¼Œæ²¡æœ‰çˆ¬å–çš„æ„ä¹‰ã€‚å¯ä»¥å‚è§è¿™ç¯‡ä¼˜åŒ– [SEO ä¼˜åŒ–](https://juejin.cn/post/7295651353854132239)
4.  æ€§èƒ½ï¼šSSR åœ¨æœåŠ¡å™¨ä¸Šå®Œæˆæ¸²æŸ“ï¼Œè¿™æ„å‘³ç€æœåŠ¡å™¨éœ€è¦æ›´å¤šçš„è®¡ç®—èµ„æºã€‚è€Œ CSR å°†æ¸²æŸ“å·¥ä½œè½¬ç§»åˆ°äº†å®¢æˆ·ç«¯ï¼Œè¿™å¯ä»¥å‡è½»æœåŠ¡å™¨çš„è´Ÿæ‹…ã€‚ç„¶è€Œï¼Œéšç€ç¡¬ä»¶æ€§èƒ½çš„æé«˜å’Œä¼˜åŒ–æŠ€æœ¯çš„è¿›æ­¥ï¼Œè¿™ç§å·®å¼‚å˜å¾—è¶Šæ¥è¶Šå°ã€‚
5.  å¤æ‚æ€§ï¼šSSR éœ€è¦æ›´å¤šçš„å¼€å‘å·¥ä½œï¼Œå› ä¸ºå®ƒæ¶‰åŠåˆ°åœ¨æœåŠ¡å™¨ç«¯å¤„ç†æ¸²æŸ“å’Œåœ¨å®¢æˆ·ç«¯å¤„ç† hydrateï¼ˆå°† HTML è½¬æ¢ä¸º React ç»„ä»¶ï¼‰ã€‚è€Œ CSR æ›´ç®€å•ï¼Œå› ä¸ºå®ƒåªéœ€è¦åœ¨å®¢æˆ·ç«¯å¤„ç†æ¸²æŸ“ã€‚

æ€»çš„æ¥è¯´ï¼Œè™½ç„¶ SSR å’Œ CSR åœ¨æŠ€æœ¯ä¸Šæœ‰ä¸€äº›åŒºåˆ«ï¼Œä½†å®ƒä»¬éƒ½å¯ä»¥æœ‰æ•ˆåœ°æ¸²æŸ“ React åº”ç”¨ã€‚é€‰æ‹©å“ªç§æ–¹æ³•å–å†³äºå…·ä½“çš„åº”ç”¨éœ€æ±‚å’Œåœºæ™¯ã€‚

ä¸‹é¢å›¾è§£è¯´æ˜ä¸€ä¸‹ï¼š

SSR:


![æ— æ ‡é¢˜-2023-10-11-1617.png](/img/posts/2023-11-3/2023-11-3-1.png)

----

CSR:

![æ— æ ‡é¢˜-2023-10-11-1617.png](/img/posts/2023-11-3/2023-11-3-2.png)

### SSR é€‚ç”¨çš„åœºæ™¯

- éœ€è¦ SEO ä¼˜åŒ–çš„åœºæ™¯
- éœ€è¦æ›´å¿«çš„é¦–å±æ—¶é—´
- é™æ€é¡µé¢æˆ–è€…blogç±»å†…å®¹å±•ç¤ºç±»ç½‘é¡µ
- éœ€è¦å¢å¼ºç”¨æˆ·å¯è®¿é—®æ€§çš„é¡µé¢ï¼šèƒ½å¤Ÿå¿«é€Ÿè·å–é¡µé¢å†…å®¹å¹¶è¿›è¡Œæµè§ˆ

### CSR é€‚ç”¨çš„åœºæ™¯

- é«˜äº¤äº’æ€§ã€å®æ—¶æ›´æ–°çš„åœºæ™¯ï¼š
- å¤æ‚å‰ç«¯é€»è¾‘åœºæ™¯ï¼šCSR å¯¹äºå¤æ‚çš„äº¤äº’å’ŒåŠ¨æ€æ•ˆæœçš„æ”¯æŒè¾ƒå¥½ï¼Œå¼€å‘ä¹Ÿç›¸å¯¹ç®€å•ã€‚
- APIé©±åŠ¨çš„åº”ç”¨ç¨‹åºï¼šCSR å…è®¸å®¢æˆ·ç«¯è·å–æ•°æ®æ¥å¤„ç†ï¼Œå¯ä»¥å‡å°‘æœåŠ¡å™¨è´Ÿè½½å¹¶æä¾›å“åº”å¼ä½“éªŒã€‚

## 2. React SSR çš„å‡ ç§ API

å®˜ç½‘æä¾›äº†è¿™ä¹ˆå‡ ä¸ª API ç”¨äºåœ¨æœåŠ¡ç«¯æ¸²æŸ“ React ç»„ä»¶ï¼š

### renderToString

å®ƒå¯ä»¥å°† React ç»„ä»¶æ¸²æŸ“æˆå­—ç¬¦ä¸²ï¼Œæœ€å¸¸ç”¨çš„ SSR APIã€‚å®ƒè¿”å›ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œå…¶ä¸­åŒ…å« HTML å’Œ React ç»„ä»¶çš„æ ‡è®°ã€‚è¿™ä¸ª API å¯ä»¥åœ¨æœåŠ¡å™¨ç«¯ä½¿ç”¨ï¼Œå°† React ç»„ä»¶æ¸²æŸ“æˆ HTMLï¼Œç„¶åå°† HTML å‘é€åˆ°å®¢æˆ·ç«¯ã€‚

æœåŠ¡ç«¯è¿™æ ·å†™ï¼ˆnodejsä¸ºä¾‹ï¼‰


```js
import { renderToString } from 'react-dom/server';

app.use('/', (request, response) => {
  const html = renderToString(<App />);
  response.send(html);
});
```

åœ¨å®¢æˆ·ç«¯æµè§ˆå™¨æ¥æ”¶åˆ°å®ƒåï¼Œè¦ä½¿ç”¨ React è¯­è¨€æ¸²æŸ“å‡ºæ¥ï¼š


```js
import { hydrateRoot } from 'react-dom/client';

hydrateRoot(document.getElementById('root'), <App/>);
```

hydrate ä¼šåœ¨æ¸²æŸ“çš„è¿‡ç¨‹ä¸­ï¼Œä¸åˆ›å»º html æ ‡ç­¾ï¼Œè€Œæ˜¯ç›´æ¥å…³è”å·²æœ‰çš„ã€‚è¿™æ ·å°±é¿å…äº†æ²¡å¿…è¦çš„æ¸²æŸ“ã€‚

### renderToPipeableStream

å®ƒå¯ä»¥å°† React ç»„ä»¶æ¸²æŸ“ä¸ºå¯è¯»çš„ Streamã€‚ä½¿ç”¨æ–¹å¼æœ‰ç•¥å¾®ä¸åŒï¼š

```js
import { renderToPipeableStream } from 'react-dom/server';

const stream = renderToPipeableStream(<App />);  
response.set('Content-Type', 'text/html');  
stream.pipe(res);  
```

ä¸åŒäº renderToStringï¼Œä»–å¯ä»¥ä½œä¸ºä¸€ä¸ªç®¡é“ä¸æ–­å¾€æœåŠ¡å™¨å“åº”é‡Œè¾“å‡ºå†…å®¹ã€‚`renderToPipeableStream`æä¾›äº†æ›´é«˜çº§çš„ç‰¹æ€§ï¼Œä¾‹å¦‚è·¯ç”±æ§åˆ¶ã€å¼‚æ­¥æ•°æ®åŠ è½½ç­‰ã€‚å®ƒè¿”å›ä¸€ä¸ªå¯è¯»çš„Streamå¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡å¯ä»¥ç”¨äºå°†Reactç»„ä»¶æ¸²æŸ“ä¸ºHTMLæ–‡æ¡£çš„æµå¼ä¼ è¾“ã€‚ä½¿ç”¨`renderToPipeableStream`å¯ä»¥åœ¨æœåŠ¡å™¨ç«¯å®ç°æ›´å¤æ‚çš„æ¸²æŸ“é€»è¾‘ï¼Œä¾‹å¦‚**æ ¹æ®è·¯ç”±è·¯å¾„åŠ¨æ€åŠ è½½ç»„ä»¶ã€æŒ‰éœ€åŠ è½½æ•°æ®**ç­‰ã€‚

### renderToReadableStream

ä»–æ˜¯ renderToPipeableStream çš„ä¸€ç§æ›¿ä»£æ–¹æ¡ˆã€‚

ä½¿ç”¨æ–¹å¼ï¼š

```js
import { renderToReadableStream } from 'react-dom/server';

async function handler(request) {
  const stream = await renderToReadableStream(<App />, {
    bootstrapScripts: ['/main.js']
  });
  return new Response(stream, {
    headers: { 'content-type': 'text/html' },
  });
}
```
è¿™ä¸ª API è¿”å›çš„æ˜¯ä¸€ä¸ª Promiseï¼Œä¾èµ– web æµï¼Œç›®å‰çš„å…¼å®¹æ€§å­˜åœ¨é—®é¢˜ã€‚å¯ä»¥å‚è€ƒ web æµçš„æ¦‚å¿µï¼š[Stream API](https://developer.mozilla.org/en-US/docs/Web/API/Streams_API)

### renderToStaticMarkup

`renderToStaticMarkup` ä¼šå°†éäº¤äº’çš„ React ç»„ä»¶æ ‘æ¸²æŸ“æˆ HTML å­—ç¬¦ä¸²ã€‚å…¶è¾“å‡ºæ— æ³•è¿›è¡ŒäºŒæ¬¡æ¸²æŸ“ï¼Œä¸”å¯¹ Suspense çš„æ”¯æŒæœ‰é™ã€‚ä¸å»ºè®®åœ¨å®¢æˆ·ç«¯ä»£ç ä¸­ä½¿ç”¨å®ƒã€‚

ä½¿ç”¨æ–¹å¼ï¼š

```js
import { renderToStaticMarkup } from 'react-dom/server';

// è·¯ç”±å¤„ç†ç¨‹åºè¯­æ³•å–å†³äºä½ çš„åç«¯æ¡†æ¶
app.use('/', (request, response) => {
  const html = renderToStaticMarkup(<Page />);
  response.send(html);
});
```

å¦‚æœè¦æ¸²æŸ“çš„æ˜¯çº¯é™æ€å†…å®¹ï¼Œåˆ™éå¸¸åˆé€‚ã€‚


### renderToStaticNodeStream

`renderToStaticNodeStream` å¯ä»¥ä¸º [Node.js åªè¯»æµ](https://nodejs.org/api/stream.html#readable-streams) æ¸²æŸ“éäº¤äº’å¼ React æ ‘ã€‚

å…¶ä½¿ç”¨ä¹Ÿæ˜¯ä¸€ä¸ªç®¡é“ï¼Œå¹¶å£°ç§°é™æ€çš„éäº¤äº’å¼ç½‘é¡µã€‚ä¸åŒçš„æ˜¯ï¼Œä»–éœ€è¦ç­‰å¾…æ‰€æœ‰ [Suspenseè¾¹ç•Œ](https://zh-hans.react.dev/reference/react/Suspense) å®Œæˆåæ‰è¿”å›è¾“å‡ºï¼Œä¸”è¿”å›ç»™å®¢æˆ·ç«¯çš„è¾“å‡ºç»“æœä¸æ”¯æŒ hydrateã€‚è¿™ä¸ªæ–¹æ³•çš„ä½œç”¨åœ¨äºç¼“å†²æ‰€æœ‰è¾“å‡ºï¼Œè¿™ä¸ªè¾“å‡ºæ˜¯ä¸€ä¸ªutf-8 ç¼–ç çš„å­—èŠ‚æµï¼Œ

----

ä¸Šé¢çš„ API ç”¨äºåœ¨è‡ªå®šä¹‰çš„æœåŠ¡å™¨ä¸­æ‰‹åŠ¨éƒ¨ç½² SSRï¼Œä½†æ˜¯ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæ¨èä½¿ç”¨ Nextjs éƒ¨ç½²ä¸€ä¸ª SSR åº”ç”¨ã€‚

## 3. React SSR/SSG æœ€ä½³å®è·µæ–¹æ¡ˆ - Next

å®˜æ–¹æ–‡æ¡£æ¨èä½¿ç”¨ Nextjs æ¥é…ç½® SSR é¡µé¢ï¼Œæœ€æ–°ç‰ˆçš„ React ä¹Ÿæ¨èä½¿ç”¨ [Nextjs](https://www.nextjs.cn/learn/basics/create-nextjs-app/setup) æ¥åˆ›å»º React Appã€‚æˆ‘ä»¬æ¥å®æˆ˜ä¸€ä¸‹ã€‚

> Node >= v18ï¼Œï¼Œæœ€æ–°ç‰ˆçš„ next éœ€è¦ node18+

### â‘ . æ–°å»ºä¸€ä¸ªç©ºçš„ npm ä»“åº“

```shell
npm init
```

### â‘¡. å®‰è£…ä¾èµ–

```shell
yarn add next react react-dom
```

### â‘¢. ä¿®æ”¹ `package.json`

```json
"scripts": {
  "dev": "next dev",
  "build": "next build",
  "start": "next start",
  "lint": "next lint"
}
```

### â‘£. åˆ›å»ºé¡µé¢æ–‡ä»¶

- é¡¹ç›®ä¸­åˆ›å»ºä¸€ä¸ªÂ `pages`Â ç›®å½•
- ç›®å½•ä¸­å†™ä¸€ä¸ª index.js


```js
function HomePage() {
  return <div>Welcome to Next.js!</div>
}

export default HomePage
```

- ç›®å½•ä¸­å†å†™ä¸€ä¸ªé¡µé¢ about.js


```js
function AboutPage() {
  return <div>Welcome to My blog!</div>
}

export default AboutPage
```

- å¯åŠ¨é¡¹ç›® `yarn dev`
- é€šè¿‡è·¯ç”±è®¿é—®é¡µé¢çœ‹çœ‹ï¼š`localhost:3000/about`


### â‘¤. æ·»åŠ åŠ¨æ€è·¯ç”±

pages ç›®å½•ä¸­åˆ›å»ºä¸€ä¸ªæ–‡ä»¶å¤¹å« postsï¼Œåœ¨ä¸‹é¢åˆ›å»ºåŠ¨æ€è·¯ç”±é¡µé¢ \[pid].js

```js
import { useRouter } from 'next/router'

const Post = () => {
  const router = useRouter()
  const { pid } = router.query

  return <p>Post: {pid}</p>
}

export default Post
```

ä½¿ç”¨ `localhost:3000/post/abc` è®¿é—®æŸ¥çœ‹é¡µé¢æ•ˆæœ


![image.png](/img/posts/2023-11-3/2023-11-3-3.png)

### â‘¥. é…ç½®é¢„æ¸²æŸ“

- SSG

å¦‚æœä½ çš„é¡µé¢æ˜¯çº¯é™æ€é¡µï¼Œä½¿ç”¨ SSG æ—¶ï¼ŒHTML æ–‡ä»¶å°†åœ¨æ¯ä¸ªé¡µé¢è¯·æ±‚æ—¶è¢«é‡ç”¨ï¼Œè¿˜å¯ä»¥è¢« CDN ç¼“å­˜ã€‚å¦‚æœä½ çš„é¡µé¢ä¸éœ€è¦è·å–å¤–éƒ¨æ•°æ®ï¼Œå¯ä»¥è¿™ä¹ˆå†™ï¼Œposts ä¸‹æ–°å»ºä¸€ä¸ª blog.jsï¼š


```js
function Blog() {
  const posts = [...];
  return (
    <ul>
      {posts.map((post) => (
        <li>{post.title}</li>
      ))}
    </ul>
  )
}

export default Blog
```

åšå®¢æ¸²æŸ“è‡ªç„¶ä¼šä¾èµ–å¤–éƒ¨æ¥å£ï¼Œå¯ä»¥è¿™ä¹ˆé…ç½®ï¼Œåœ¨åŒæ–‡ä»¶ï¼ˆblog.jsï¼‰ä¸­å¯¼å‡ºä¸€ä¸ªasyncå‡½æ•°ï¼š

```js
// posts æ˜¯å¤–éƒ¨æ¥å£è·å–åˆ°åï¼Œ getStaticProps ä¼ å…¥çš„
function Blog({ posts }) {...}

export async function getStaticProps() {
  // è°ƒç”¨å¤–éƒ¨ API è·å–åšæ–‡åˆ—è¡¨ (ç¼–è¯‘å’Œæ‰“åŒ…æ—¶å°±ä¼šè°ƒç”¨)
  const res = await fetch('https://.../posts')
  const posts = await res.json()

  // é€šè¿‡è¿”å› { props: { posts } } å¯¹è±¡ï¼ŒBlog ç»„ä»¶
  // åœ¨æ„å»ºæ—¶å°†æ¥æ”¶åˆ° `posts` å‚æ•°
  return {
    props: {
      posts,
    },
  }
}
```
> getStaticProps å‡½æ•°ï¼Œåœ¨é¡µé¢æ‰“åŒ…æ—¶å°±ä¼šæ‰§è¡Œå¹¶ç¼“å­˜ï¼Œåœ¨çº¿ä¸Šæ¨¡å¼ä¾¿ä¸ä¼šåå¤æ‰§è¡Œã€‚è€Œåœ¨å¼€å‘ç¯å¢ƒï¼Œæ¯æ¬¡åˆ·æ–°é¡µé¢æ—¶ï¼Œæ•´ä¸ªé¡µé¢ä¼šç­‰å¾… fetch è¿”å›æ•°æ®åæ‰åŠ è½½ã€‚


æ­¤å¤–ï¼ŒåŠ¨æ€è·¯ç”±é¡µ \[pid].js çš„æ¸²æŸ“ï¼Œä¹Ÿä¼šä¾èµ–å¤–éƒ¨åŠ¨æ€æ¥å£ï¼Œä¼ å…¥ abcï¼Œå°±è¡¨ç¤ºå±•ç¤º abc è¿™ä¸€ç¯‡æ–‡ç« çš„ä¿¡æ¯ï¼Œç°åœ¨æ¥é…ç½®è·¯å¾„é¢„æ¸²æŸ“ï¼ˆpages/posts/\[pid].js ä¸­ï¼‰ï¼š


```js
// æ­¤å‡½æ•°åœ¨æ„å»ºæ—¶è¢«è°ƒç”¨
export async function getStaticPaths() {
  // è°ƒç”¨å¤–éƒ¨ API è·å–åšæ–‡åˆ—è¡¨
  const res = await fetch('https://.../posts')
  const posts = await res.json()

  // æ®åšæ–‡åˆ—è¡¨ç”Ÿæˆæ‰€æœ‰éœ€è¦é¢„æ¸²æŸ“çš„è·¯å¾„
  const paths = posts.map((post) => ({
    params: { pid: post.id },
  }))

  // We'll pre-render only these paths at build time.
  // { fallback: false } means other routes should 404.
  return { paths, fallback: false }
}

// åœ¨æ„å»ºæ—¶ä¹Ÿä¼šè¢«è°ƒç”¨
export async function getStaticProps({ params }) {
  // params åŒ…å«æ­¤ç‰‡åšæ–‡çš„ `pid` ä¿¡æ¯ã€‚
  // å¦‚æœè·¯ç”±æ˜¯ /posts/1ï¼Œé‚£ä¹ˆ params.pid å°±æ˜¯ 1
  const res = await fetch(`https://.../posts/${params.pid}`)
  const post = await res.json()

  // é€šè¿‡ props å‚æ•°å‘é¡µé¢ä¼ é€’åšæ–‡çš„æ•°æ®
  return { props: { post } }
}
```

ä¸Šé¢çš„ä»£ç ï¼ŒgetStaticPaths è¿”å›å…è®¸è®¿é—®çš„ pid é›†åˆï¼Œæ¯”å¦‚æ¥å£è¿”å›äº†æ•°æ® paths: \[1,2,3,4], é‚£ä¹ˆä½ è¯·æ±‚ `localhost:3000/posts/5` å°±ä¼š 404; getStaticProps çš„é€»è¾‘ä¸ä¸Šé¢ä¸€æ ·ï¼Œå®é™…è®¿é—®äº† pid=1çš„è·¯å¾„ï¼Œé‚£ä¹ˆ params å°±æ˜¯ `{pid: 1}`ï¼Œç„¶åé˜»å¡é¡µé¢å»è·å–æ•°æ®ã€‚

- SSR

å¦‚æœä½ è¦ä½¿ç”¨Â **æœåŠ¡å™¨ç«¯æ¸²æŸ“**ï¼Œåˆ™ä¼šåœ¨Â **æ¯æ¬¡é¡µé¢è¯·æ±‚æ—¶**Â é‡æ–°ç”Ÿæˆé¡µé¢çš„ HTMLï¼Œè™½ç„¶é€Ÿåº¦ä¸åŠå‰è€…ï¼Œä½†æ˜¯é¢„æ¸²æŸ“çš„é¡µé¢å°†å§‹ç»ˆæ˜¯æœ€æ–°çš„ã€‚

ç±»ä¼¼åœ°ï¼Œä¹Ÿåœ¨é¡µé¢æ–‡ä»¶å¯¼å‡ºä¸€ä¸ªasyncå‡½æ•°ï¼š


```js
function Blog({ data }) {
  // Render data...
}

// This gets called on every request
export async function getServerSideProps() {
  // Fetch data from external API
  const res = await fetch(`https://.../data`)
  const data = await res.json()

  // Pass data to the page via props
  return { props: { data } }
}
```
æ‰§è¡Œè¿‡ç¨‹å¤§åŒå°å¼‚ï¼Œä¸åŒçš„æ˜¯æ¯æ¬¡çº¿ä¸Šè¯·æ±‚é¡µé¢éƒ½ä¼šå»è°ƒç”¨ getServerSideProps æ¥è¯·æ±‚æ¥å£ã€‚

### â‘¦. é…ç½®å…¥å£ç»„ä»¶

åœ¨ pages ç›®å½•ä¸‹é…ç½®ä¸€ä¸ªæ–‡ä»¶ _app.js:

```js
// å¦‚æœæœ‰ css å°±å¼•å…¥
import '../styles.css'

// æ–°åˆ›å»ºçš„ `pages/_app.js` æ–‡ä»¶ä¸­å¿…é¡»æœ‰æ­¤é»˜è®¤çš„å¯¼å‡ºï¼ˆexportï¼‰å‡½æ•°
export default function MyApp({ Component, pageProps }) {
  return <Component {...pageProps} />
}
```
_app.js é»˜è®¤æ˜¯æ‰€æœ‰é¡µé¢æ–‡ä»¶çš„æ€»å…¥å£ï¼Œä»–å¯ä»¥æ¥å—ä¸¤ä¸ªå‚æ•°ï¼ŒComponent æ˜¯å½“å‰çš„ç»„ä»¶ï¼ŒpageProps æ˜¯è¿™ä¸ªç»„ä»¶çš„ propsã€‚ä½œä¸ºç»Ÿä¸€çš„å…¥å£ï¼Œåœ¨è¿™é‡Œä½ å°±å¯ä»¥é…ç½®å¾ˆå¤šå‚æ•°äº†ï¼Œæ¯”å¦‚ seoé…ç½®ã€å…¬å…±æ ·å¼ã€å¸ƒå±€èœå•ç­‰ã€‚

### â‘§. é…ç½®æ ·å¼

åœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»º style.cssï¼Œå¹¶åœ¨ _app.js ä¸­å¼•å…¥ï¼š


```css
body {
  font-family: 'SF Pro Text', 'SF Pro Icons', 'Helvetica Neue', 'Helvetica',
    'Arial', sans-serif;
  margin: 0 auto;
}
```

å¦‚æœè¦ä½¿ç”¨ sassï¼Œå¯ä»¥å…ˆå®‰è£…ä¾èµ–ï¼š

```
yarn add sass
```

åœ¨é¡¹ç›®ä¸­å¼•å…¥ sass æ¨¡å—ï¼š

```js
import variables from '../styles/variables.module.scss'
```

### â‘¨. é¡µé¢å¸ƒå±€

åœ¨ _app.js ä¸­å¼•å…¥è‡ªå®šä¹‰çš„å¸ƒå±€ç»„ä»¶ï¼š

```js
import Layout from '../components/layout'

export default function MyApp({ Component, pageProps }) {
  return (
    <Layout>
      <Component {...pageProps} />
    </Layout>
  )
}
```

Layout å¯ä»¥æ˜¯ä¸‹é¢çš„å½¢å¼ï¼š

```js
import useSWR from 'swr'
import Navbar from './navbar'
import Footer from './footer'

export default function Layout({ children }) {
  const { data, error } = useSWR('/api/navigation', fetcher)

  if (error) return <div>Failed to load</div>
  if (!data) return <div>Loading...</div>

  return (
    <>
      <Navbar links={data.links} />
      <main>{children}</main>
      <Footer />
    </>
  )
}
```

è¿™é‡Œç”¨äº†ç¬¬ä¸‰æ–¹åº“æ¥è¯·æ±‚ï¼Œå…¶ä¸­çš„ fetcher å¯ä»¥è¿™ä¹ˆå†™ï¼š

```js
const fetcher = (url) => fetch(url).then((res) => res.json());
```

### â‘©. é…ç½®é™æ€èµ„æº

åœ¨æ ¹ç›®å½•ä¸‹æ–°å»º public ç›®å½•ã€‚

- å¼•å…¥æœ¬åœ°å›¾ç‰‡

```js
import Image from 'next/image'
import profilePic from '../public/me.png'

<Image
    src={profilePic}
    alt="Picture of the author"
/>
```
- åŠ è½½è¿œç¨‹å›¾ç‰‡

```js
<Image
    src="/me.png"
    alt="Picture of the author"
    width={500}
    height={500}
    priority
/>
```
è¿œç¨‹èµ„æºåŸŸåé…ç½®æœ‰ä¸¤ç§æ–¹å¼ï¼Œåœ¨æ ¹ç›®å½•ä¸‹æ–°å»ºé…ç½®æ–‡ä»¶ next.config.js:

ç¬¬ä¸€ç§ï¼š
```js
module.exports = {
  images: {
    domains: ['example.com', 'example2.com'],
  },
}
```
è¿™ä¸ªé…ç½®ä¸“é—¨ç”¨äºåŠ è½½å›¾ç‰‡ï¼Œè®¾ç½®åŸŸååªæ˜¯å…¶ä¸­ä¸€ä¸ªé€‰æ‹©é¡¹ï¼Œé»˜è®¤ä½¿ç”¨æ•°ç»„ç¬¬ä¸€ä¸ªåŸŸåï¼Œåœ¨å…·ä½“ä½¿ç”¨æ—¶ï¼Œå¯ä»¥æ‰‹åŠ¨æŒ‡å®šæ•°ç»„ä¸­çš„æšä¸¾é¡¹ï¼š`<Image src="my-image.jpg?domain=https://example2.com" alt="My Image" />`

ç¬¬äºŒç§ï¼š

```js
async rewrites() {
    return {
      fallback: [
        {
          source: '/home/:image*',
          destination: `https://${isProd ? CDNPath : filePath}/home/:image*`
        }
      ]
    }
}
```
è¿™ä¸ªé…ç½®ç”¨äºé‡å†™è§„åˆ™ï¼Œä½œç”¨åŸŸæ¯”è¾ƒå¹¿ï¼Œè¿˜å¯ä»¥ç”¨æ¥æ‹¦æˆª API è¯·æ±‚ç­‰ã€‚

- ä½¿ç”¨å¤–æŒ‚å­—ä½“

åœ¨ pages æ–°å»ºä¸€ä¸ª _document.js æ–‡ä»¶ï¼š

```js
import Document, { Html, Head, Main, NextScript } from 'next/document'

class MyDocument extends Document {
  render() {
    return (
      <Html>
        <Head>
          <link
            href="https://fonts.googleapis.com/css2?family=Inter&display=optional"
            rel="stylesheet"
          />
        </Head>
        <body>
          <Main />
          <NextScript />
        </body>
      </Html>
    )
  }
}

export default MyDocument
```

> _document.js ç”¨äºè‡ªå®šä¹‰ \<head> æ ‡ç­¾ã€å®šä¹‰ CSS æ ·å¼ã€æ·»åŠ å…ƒæ•°æ®ï¼ˆmetadataï¼‰ç­‰

- ä½¿ç”¨å¤–éƒ¨è„šæœ¬

```js
class MyDocument extends Document {
...
    <Head>
        <Script src="https://connect.facebook.net/en_US/sdk.js" strategy="lazyOnload" />
    </Head>
    <body>
      <Main />
      <NextScript />
    </body>
}
```

### â‘ª. ç¯å¢ƒå˜é‡é…ç½®

Next.js å†…ç½®æ”¯æŒå°†ç¯å¢ƒå˜é‡ä»Â `.env.local`Â åŠ è½½åˆ°Â `process.env`Â ä¸­ã€‚ä½ å¯ä»¥åœ¨æœ¬åœ°æ ¹ç›®å½•æ–‡ä»¶ `.env.local` ä¸­å†™å…¥è‡ªå®šä¹‰çš„å˜é‡ï¼š

```
environment=development
```

ç„¶åå¯ä»¥åœ¨é…ç½®æ–‡ä»¶ä¸­è·å–ï¼š`process.env.environment`

ä½ ä¹Ÿå¯ä»¥ç›´æ¥åŠ ä¸Šå‰ç¼€ï¼šNEXT_PUBLIC

```
NEXT_PUBLIC_ANALYTICS_ID=abcdefghijk
```
è¿™æ ·çš„å˜é‡ä¼šåŠ è½½åœ¨nodejsä¸­ï¼Œä½ åœ¨jsæ–‡ä»¶é‡Œä¹Ÿå¯ä»¥é€šè¿‡ process æ¥è®¿é—®äº†ã€‚

### â‘«. é…ç½®i18n

å®‰è£…ä¾èµ–ï¼š`yarn add react-i18next i18next next-i18next`

åœ¨ _app.js ä¸­å¼•å…¥ï¼š

```js
import { appWithTranslation } from 'next-i18next';

...
export default memo(appWithTranslation(MyApp));
```

åœ¨ public æ–‡ä»¶å¤¹é‡Œå†™å…¥ä¸­è‹±æ–‡æ–‡æ¡ˆï¼š

![image.png](/img/posts/2023-11-3/2023-11-3-4.png)

![image.png](/img/posts/2023-11-3/2023-11-3-5.png)

![](/img/posts/2023-11-3/2023-11-3-6.png)

æ ¹ç›®å½•ä¸‹æ·»åŠ é…ç½®æ–‡ä»¶ next-i18next.config.jsï¼š

```js
module.exports = {
  i18n: {
    localeDetection: false, // ä¸æ£€æµ‹æµè§ˆå™¨è¯­è¨€ç¯å¢ƒ
    defaultLocale: 'en',
    locales: ['en' , 'zh']
  },
  localePath: typeof window === 'undefined'
    ? require('path').resolve('./public/locales')
    : require('path').resolve('./public/locales'),
  reloadOnPrerender: process.env.NEXT_PUBLIC_DOMAIN_ENV === 'development',
};
```
å¹¶åœ¨ next-config.js ä¸­å¼•å…¥ï¼š

```js
const { i18n } = require('./next-i18next.config');

module.exports = () => {

  return {
    i18n,
  }
}
```

åœ¨ç»„ä»¶ä¸­ä½¿ç”¨ï¼š

```js
import { serverSideTranslations } from 'next-i18next/serverSideTranslations';
import { useTranslation } from 'next-i18next';

const { t } = useTranslation(['common']);

...
// æ¸²æŸ“æ—¶ä½¿ç”¨
<button className={`${Style['btn-link']} mr-16 primary button-outlined`}>
  {t('login')}
</button>
...

export const getStaticProps = async ({
  locale,
}) => {
  return {
    props: {
      ...(await serverSideTranslations(locale ?? 'en', [
        'common'
      ])),
    },
  }
}

```
i18n ä¼šåœ¨é¢„ç¼–è¯‘çš„æ—¶å€™ï¼Œå¾€ getStaticProps ä¼ å…¥å›½é™…åŒ–æ–‡æ¡ˆå‚æ•°ã€‚æ§åˆ¶æ˜¾ç¤ºå“ªä¸€ä¸ªæ–‡æ¡ˆï¼Œæ˜¯æ ¹æ®é…ç½®çš„ç›®å½•å’Œè®¿é—®è·¯å¾„æ¥çš„ï¼Œæ¯”å¦‚è¦æ˜¾ç¤ºä¸­æ–‡ï¼Œlocalesä¸‹æœ‰ä¸ªzhæ–‡ä»¶å¤¹ï¼Œä½ çš„è®¿é—®è·¯å¾„ä¹Ÿåº”è¯¥å¯¹åº”ï¼š


![image.png](/img/posts/2023-11-3/2023-11-3-12.png)

æ‰€ä»¥å¯ä»¥å†™ä¸€ä¸ªå…¨å±€çš„åˆ‡æ¢æŒ‰é’®ï¼Œæ¥æ§åˆ¶è·¯ç”±å˜åŒ–ï¼š`window.location.href = '/zh';`


### â‘¬. è‡ªå®šä¹‰é…ç½®

nextjs æä¾›è‡ªå®šä¹‰é…ç½®æ–‡ä»¶ next.config.js (æˆ– mjsï¼Œä½¿ç”¨ ESM) ç”¨äºé«˜çº§é…ç½®:

```js
// å¸¸ç”¨é…ç½®
const { PHASE_DEVELOPMENT_SERVER } = require('next/constants')

module.exports = (phase, { defaultConfig }) => {
  // å¼€å‘ç¯å¢ƒé…ç½®
  if (phase === PHASE_DEVELOPMENT_SERVER) {
    return {
        env: {
          env: 'dev', // å¯åœ¨é¡µé¢ä½¿ç”¨ï¼š<h1>env is: {process.env.env}</h1>
        },
        basePath: '/docs', // åŸºç¡€è·¯å¾„ï¼Œæ‰€æœ‰çš„Linkè·³è½¬ä¼šä»¥è¿™ä¸ªä¸ºåŸºç¡€
        compress: false, // å‹ç¼©ä»£ç 
        generateEtags: false, // ç¦ç”¨ ETag ï¼Ÿ
        distDir: 'build', // è‡ªå®šä¹‰è¾“å‡ºç›®å½•
        async redirects() {  // é‡å®šå‘
          return [
            {
              source: '/about',
              destination: '/',
              permanent: true,
            },
          ]
        },
        async rewrites() { // é‡å†™èµ„æºè·¯å¾„ï¼Œé»˜è®¤æ˜¯åœ¨æ£€æŸ¥æ–‡ä»¶ç³»ç»Ÿï¼ˆé¡µé¢å’Œ`/public`æ–‡ä»¶ï¼‰ä¹‹åã€åŠ¨æ€è·¯ç”±ä¹‹å‰åº”ç”¨çš„ï¼›ä½¿ç”¨ fallback è¡¨ç¤ºæ¯æ¬¡æ£€æŸ¥æ–‡ä»¶å’ŒåŠ¨æ€è·¯ç”±ä¹‹åè§¦å‘
          return {
            fallback: [
              {
                source: '/home/:image*',
                destination: `https://${isProd ? CDNPath : filePath}/home/:image*`
              },
            ]
          }
        },
      }
  }

  return {
    // åŒä¸Š...
  }
}
```
### â‘­. éƒ¨ç½²

- å°†ä»£ç æ¨é€åˆ° github
- æ³¨å†Œä¸€ä¸ª vercelè´¦å·ï¼šhttps://vercel.com/signup
- é€‰æ‹©å…³è”ä»“åº“ï¼Œé€‰ä¸­ä½ çš„ä»“åº“


![image.png](/img/posts/2023-11-3/2023-11-3-7.png)


![image.png](/img/posts/2023-11-3/2023-11-3-8.png)

- ç‚¹å‡»éƒ¨ç½²åä¼šè‡ªåŠ¨éƒ¨ç½²


![image.png](/img/posts/2023-11-3/2023-11-3-9.png)

- ç„¶ååœ¨ github ä»“åº“å³ä¾§ä¼šå‡ºç°é“¾æ¥ï¼š


![image.png](/img/posts/2023-11-3/2023-11-3-10.png)ã€

- æŸ¥çœ‹åšå®¢


![image.png](/img/posts/2023-11-3/2023-11-3-11.png)56:T391a,ç°ä»£æµè§ˆå™¨çš„åº•å±‚åŸç†ç‰¹åˆ«çš„å¤æ‚ï¼Œå¯ä»¥è¯´æ˜¯ä¸€ä¸ªå°å‹çš„æ“ä½œç³»ç»Ÿã€‚ä»¥ chrome ä¸ºä¾‹ï¼Œä»–æ˜¯å¤šè¿›ç¨‹çš„æµè§ˆå™¨ï¼Œå…¶ä¸­æ¸²æŸ“é¡µé¢æ˜¯ä¸€ä¸ªå•ç‹¬çš„è¿›ç¨‹ï¼Œå«åšæ¸²æŸ“è¿›ç¨‹ã€‚ç›®å‰ç”¨çš„æœ€å¤šçš„æ–¹å¼æ˜¯ä¸€ä¸ª tab é¡µå•ç‹¬åˆ†é…ä¸€ä¸ªæ¸²æŸ“è¿›ç¨‹æ¥ç»´æŠ¤ã€‚æ¯ä¸€ä¸ªæ¸²æŸ“è¿›ç¨‹ä¸­ï¼Œæœ‰ä¸€ä¸ªæ¸²æŸ“ä¸»çº¿ç¨‹ç”¨äºæ— é˜»å¡åœ°æ‰§è¡Œæ¸²æŸ“ä»»åŠ¡ã€‚

æ¸²æŸ“ï¼Œé€šä¿—çš„è§£é‡Šå°±æ˜¯**å°† html å­—ç¬¦ä¸²è§£æä¸ºå›¾å½¢åƒç´ ä¿¡æ¯**çš„è¿‡ç¨‹ã€‚ä½ è¾“å…¥ä¸€ä¸ª url åœ°å€åï¼Œä¼šé€šè¿‡ä¸€ç³»åˆ—è§£æï¼Œä»ç›®æ ‡æœåŠ¡å™¨ç›´æ¥æˆ–é—´æ¥è·å–åˆ°è¿™ä¸ª html å­—ç¬¦ä¸²ï¼Œè€Œæ¸²æŸ“è¿›ç¨‹è¦åšçš„å°±æ˜¯è¿™ä¸ªç¿»è¯‘ä¸ºåƒç´ ä¿¡æ¯çš„è¿‡ç¨‹ã€‚

æœ¬æ–‡å°±é€šè¿‡å›¾è§£æ¥è®²è¿°æµè§ˆå™¨çš„æ¸²æŸ“ä¸»çº¿ç¨‹çš„å·¥ä½œè¿‡ç¨‹ã€‚

[chromium å†…æ ¸æºç ](https://github.com/chromium/chromium)

----

## 0. æ¸²æŸ“æµæ°´çº¿

ä¾æ®æ¶ˆæ¯å¾ªç¯çš„æ¦‚å¿µï¼Œæµè§ˆå™¨æ¸²æŸ“ä¸»çº¿ç¨‹æŒ‰ç…§å„ä¸ªä»»åŠ¡é˜Ÿåˆ—ï¼ˆå¾®ä»»åŠ¡é˜Ÿåˆ—ã€äº¤äº’é˜Ÿåˆ—ï¼Œå»¶æ—¶é˜Ÿåˆ—ç­‰ï¼‰ä¼˜å…ˆçº§ï¼Œå–ç”¨ä»»åŠ¡åŒ…å¹¶æ‰§è¡Œã€‚é‚£ä¹ˆï¼Œæ‰§è¡Œçš„è¿™äº›åŒ…åçš„å˜æ›´ï¼Œä½•æ—¶ä¼šçœŸæ­£å‘ˆç°åœ¨é¡µé¢ä¸Šå‘¢ï¼Ÿæˆ‘ä»¬çœ‹å›¾ï¼š


![æ— æ ‡é¢˜-2023-10-06-1925.png](/img/posts/2023-10-26/2023-10-26-1.png)

åœ¨æµè§ˆå™¨å‘å‰ç«¯æœåŠ¡å™¨è¯·æ±‚åˆ° html å­—ç¬¦ä¸²åï¼Œå°±æ‰“åŒ…ä¸ºä¸€ä¸ªæ¶ˆæ¯å¾ªç¯ä¸­çš„ä¸€ä¸ªæ¸²æŸ“ä»»åŠ¡ï¼Œäº¤ç”±æ¸²æŸ“ä¸»çº¿ç¨‹æ‰§è¡Œæ¸²æŸ“å·¥ä½œã€‚

é‚£ä¹ˆæµè§ˆå™¨æ˜¯å¦‚ä½•è§£æè¿™ä¸ª html å­—ç¬¦ä¸²çš„å‘¢ï¼Ÿæˆ‘ä»¬å…ˆæ¥æ€»è§ˆä¸€ä¸‹ä»–çš„è§£ææµæ°´çº¿ï¼Œä¹‹åçš„å°èŠ‚å†åˆ†æ­¥æ¥è®²è§£ï¼š


![æ— æ ‡é¢˜-2023-10-06-1925.png](/img/posts/2023-10-26/2023-10-26-2.png)

## 1. è§£æ HTML

æˆ‘ä»¬è·å–ä¸€ä¸ªé¡µé¢ï¼Œä¸€èˆ¬éƒ½æ˜¯é€šè¿‡ç½‘ç»œè¯·æ±‚æ‹¿åˆ° html å­—ç¬¦ä¸²æœ¬èº«çš„ï¼š


![image.png](/img/posts/2023-10-26/2023-10-26-3.png)

æˆ‘ä»¬ä¹Ÿå¯ä»¥åŠ ä¸Š `view-source` å‰ç¼€æ¥è®¿é—®è¿™ä¸ªå­—ç¬¦ä¸²ï¼š`view-source:https://www.ucloud.cn`


![image.png](/img/posts/2023-10-26/2023-10-26-4.png)

ä»–ä¸éšåè·å–åˆ°çš„ cssã€js æ–‡ä»¶å…±åŒå½±å“äº†é¡µé¢çš„æ¸²æŸ“ã€‚

æµè§ˆå™¨è·å–åˆ° HTMLåï¼Œäº§ç”Ÿæ¸²æŸ“ä»»åŠ¡ï¼Œäº¤ç»™æ¸²æŸ“ä¸»çº¿ç¨‹çš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚éšåçš„æ¸²æŸ“è§£æå™¨ä¼šå°†è¿™ä¸ªç»“æ„è§£æä¸º DOM æ ‘ å’Œ CSSOM æ ‘ã€‚

å…ˆè§£é‡Šæ¦‚å¿µï¼š

- DOMæ ‘ï¼šæ–‡æ¡£å¯¹è±¡æ¨¡å‹ï¼Œæ˜¯ç½‘é¡µä¸­ htmlå…ƒç´ ä¸ºæ ¹èŠ‚ç‚¹çš„ä¸€é¢—å…ƒç´ å…³è”å…³ç³»çš„é›†åˆ


![æ— æ ‡é¢˜-2023-10-06-1925.png](/img/posts/2023-10-26/2023-10-26-5.png)

- CSSOMæ ‘: æ˜¯ç½‘é¡µCSSå¯¹è±¡æ¨¡å‹ï¼Œæè¿°é¡µé¢DOMç»“æ„å±‚é›†ä¸­çš„cssæ ·å¼


![æ— æ ‡é¢˜-2023-10-06-1925.png](/img/posts/2023-10-26/2023-10-26-6.png)

å…¶ä¸­ï¼š

- StyleSheetList æ˜¯é¡µé¢ CSSOM æ ¹èŠ‚ç‚¹ï¼Œä»£è¡¨é¡µé¢æ‰€æœ‰çš„æ ·å¼è¡¨ï¼Œå…¶åŒ…å«å¤šå¥—ä¸åŒä¼˜å…ˆçº§çš„æ ·å¼è¡¨ 
- CSSStyleSheet æ˜¯é¡µé¢æ ·å¼è¡¨ï¼Œæœ‰è¿™å‡ ç§ï¼šå†…è”ï¼ˆ`<div style="">`ï¼‰ã€å¤–éƒ¨ï¼ˆ`<link>`ï¼‰ã€å†…éƒ¨ï¼ˆ`<style>`ï¼‰å’Œé»˜è®¤æ ·å¼è¡¨ ï¼ˆä¹Ÿå«ç”¨æˆ·ä»£ç†æ ·å¼è¡¨ï¼Œæ¯ä¸ªæµè§ˆå™¨å†…ç½®æ ·å¼ï¼‰ï¼Œé€šè¿‡ `document.styleSheets` å¯ä»¥è·å–ä¸Šä¸‹æ–‡ä¸­æ‰€æœ‰çš„æ ·å¼è¡¨ã€‚
- CSSStyleRuleï¼šcss è§„åˆ™ï¼Œæ¯”å¦‚ï¼š`body { margin: 0 }` å°±æ˜¯ä¸€ä¸ªè§„åˆ™

> æµè§ˆå™¨çš„ API ä½¿ç”¨ C++ å®ç°ï¼Œå…¶ä½¿ç”¨ js è¿›è¡Œäº†å°è£…ï¼Œä½¿å¾— DOM æ“ä½œå¯ä»¥ä½¿ç”¨ js å®Œæˆ

çŸ¥é“äº†ä¸Šè¿°æ¦‚å¿µï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹æµè§ˆå™¨è§£æ html çš„è¿‡ç¨‹ï¼š


![æ— æ ‡é¢˜-2023-10-06-1925.png](/img/posts/2023-10-26/2023-10-26-7.png)

æˆ‘ä»¬æ¥çœ‹å›¾è¯´è¯ï¼š

1. æ¸²æŸ“ä¸»çº¿ç¨‹æ— é˜»å¡çš„è¯»å– html å­—ç¬¦ä¸²
2. é‡åˆ°cssï¼Œäº¤ç”±é¢„è§£æçº¿ç¨‹çº¿ç¨‹å‡†å¤‡cssèµ„æºï¼Œå‡†å¤‡å¥½åæ— é˜»å¡è§£æï¼Œå¹¶æ¨é€ä»»åŠ¡ã€‚æ¸²æŸ“ä¸»çº¿ç¨‹é€šè¿‡cssæ„é€ CSSOM
3. é‡åˆ°jsï¼Œäº¤ç”±é¢„è§£æçº¿ç¨‹å‡†å¤‡jsèµ„æºï¼Œå‡†å¤‡å¥½åå¼€å§‹æ‰§è¡Œjsï¼Œjsä¼šå½±å“CSSOM/DOMæ ‘çš„ç»“æ„ï¼Œæ‰€ä»¥ä¸»çº¿ç¨‹éœ€è¦é˜»å¡ç­‰å¾…ï¼Œæ‰§è¡Œå®Œæ¯•åï¼Œé‡æ–°æ„å»ºCSSOM/DOMæ ‘
4. æ¸²æŸ“ä¸»çº¿ç¨‹ç»§ç»­å‘ä¸‹æ‰§è¡Œï¼Œé‡å¤ä¸Šé¢çš„æ­¥éª¤ï¼Œç›´åˆ°ç»“æŸã€‚

è¿™ä¸€æ­¥çš„äº§å‡ºï¼šDOM/CSSOM

## 2. æ ·å¼è®¡ç®—

è¿™ä¸€æ­¥çš„ç›®çš„æ˜¯éå† DOMæ ‘ï¼Œæ‰¾åˆ°é¡µé¢å„ä¸ªå…ƒç´ çš„æœ€ç»ˆè®¡ç®—æ ·å¼ï¼ˆComputed Styleï¼‰ï¼š


![image.png](/img/posts/2023-10-26/2023-10-26-8.png)

åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼š

- é¢„è®¾å€¼ä¼šå˜ä¸ºç»å¯¹å€¼ã€‚æ¯”å¦‚ 100% -> pxï¼Œ0.125rem -> pxï¼Œred -> rgb(255, 0, 0)ç­‰
- åŒä¸€å…ƒç´ æŒ‰ç…§ä¼˜å…ˆçº§å±‚å ã€ç»§æ‰¿ç­‰å„ç§å› ç´ å†³å®šæœ€ç»ˆçš„æ ·å¼
- è®¡ç®—æ ·å¼ä¼šå±•ç¤ºæ‰€æœ‰çš„å¯èƒ½æ ·å¼ï¼Œå³ä½¿æ²¡æœ‰è®¾ç½®è¿‡ï¼Œä¹Ÿä¼šæ˜¯ none æˆ–è€… unset

è·å–è®¡ç®—æ ·å¼æœ‰å“ªäº›ï¼Œå¯ä»¥ä½¿ç”¨ APIï¼š`getComputedStyle`


![image.png](/img/posts/2023-10-26/2023-10-26-9.png)

## 3. å¸ƒå±€

å¸ƒå±€çš„è¿‡ç¨‹ï¼Œå°±æ˜¯é€šè¿‡ CSSOM/DOM æ ‘ç”ŸæˆçœŸæ­£åœ¨é¡µé¢å±•ç¤ºçš„ç»“æ„å¸ƒå±€æ ‘ã€‚æˆ‘ä»¬çœ‹å›¾ï¼š


![æ— æ ‡é¢˜-2023-10-06-1925.png](/img/posts/2023-10-26/2023-10-26-10.png)

ä¸Šå›¾è¿™ä¸ªä¾‹å­å°±å¾ˆå¥½çš„è¯´æ˜äº† DOM æ ‘å’Œå¸ƒå±€æ ‘çš„åŒºåˆ«ã€‚å¸ƒå±€æ ‘ä¸­çš„å„ä¸ªèŠ‚ç‚¹éƒ½æ˜¯ä¼šæœ‰è‡ªå·±çš„åŒ…å«å—çš„ã€‚

> åŒ…å«å—ï¼š100% è®¡ç®—çš„ç›¸å¯¹å°ºå¯¸å°±æ˜¯è¯¥å…ƒç´ çš„åŒ…å«å—ã€‚å¦‚æœæ˜¯ absolute å®šä½å…ƒç´ ï¼Œå…¶åŒ…å«å—æ˜¯ç¦»ä»–æœ€è¿‘çš„è®¾ç½®äº†é static å®šä½çš„ç¥–å…ˆå…ƒç´ 


å…¶å®åœ¨ chrome æºç ä¸­ä¹Ÿè§„å®šäº†å„ä¸ªæ ‡ç­¾çš„å†…ç½®æ ·å¼ï¼Œä»–ä»¬éƒ½ä¼šåœ¨å¸ƒå±€é˜¶æ®µè¿›è¡Œåˆ¤æ–­ï¼š

![image.png](/img/posts/2023-10-26/2023-10-26-11.png)

å¦å¤–ä¸€ä¸ªå¸ƒå±€ä¸ DOM ä¸ä¸€æ ·çš„æ˜¯ï¼šæ–‡æœ¬å†…å®¹å¿…é¡»åœ¨è¡Œç›’ä¸­ï¼Œå…·åçš„è¡Œç›’å’Œå—ç›’åœ¨å¸ƒå±€æ ‘ä¸­ä¸èƒ½ç›¸é‚»ï¼Œæ¯”å¦‚ä¸€ä¸ª `inline-block` å’Œä¸€ä¸ª `flex`ï¼Œä»–ä»¬è‚¯å®šæ˜¯åˆ†ä¸¤è¡Œæ˜¾ç¤ºçš„ï¼Œæµè§ˆå™¨ä¸€ç§å¤„ç†æ–¹å¼æ˜¯æ’å…¥ä¸€ä¸ªæˆ–å¤šä¸ªåŒ¿åçš„ç›’å­æ¥åšé—´éš”ï¼š


![æ— æ ‡é¢˜-2023-10-06-1925.png](/img/posts/2023-10-26/2023-10-26-12.png)

> å¸ƒå±€éœ€è¦è€ƒè™‘çš„å› ç´ æœ‰å¾ˆå¤šï¼Œå®šä½ã€æ ·å¼ã€ BFC ç­‰ï¼›åŒæ—¶åœ¨å¸ƒå±€æ ‘é‡Œä¹Ÿä¼šæš´éœ²ä¸€äº›å¸¸ç”¨ä¿¡æ¯ï¼Œæ¯”å¦‚ clientHeightã€offsetHeight ç­‰

> å¸ƒå±€çš„ä¾‹å­è¿˜æœ‰å¾ˆå¤šï¼Œä¸Šé¢çš„ä¾‹å­æ—¨åœ¨è¯´æ˜ DOM æ ‘ï¼ˆjsonï¼‰å’Œ å¸ƒå±€æ ‘çš„ç»“æ„ï¼ˆc++ å¯¹è±¡ï¼‰å¾€å¾€æ˜¯ä¸ä¸€æ ·çš„

## 4. åˆ†å±‚

ç°ä»£æµè§ˆå™¨ä¸ºäº†æå‡æ¸²æŸ“æ•ˆç‡ï¼Œå°†äºŒç»´æå‡åˆ°ä¸‰ç»´ï¼Œå¢åŠ ç»´åº¦ï¼Œå¼€è¾Ÿæ–°çš„ç©ºé—´ã€‚ç±»ä¼¼äº PS ä¸­çš„å›¾å±‚ï¼Œä¾¿äºå±€éƒ¨æ¸²æŸ“ã€‚

åœ¨å¸ƒå±€ç¡®å®šäº†å…ƒç´ çš„ä½ç½®å’Œæ ·å¼ä»¥åï¼Œæµè§ˆå™¨ä¼šæ ¹æ®æ¸²æŸ“å¼•æ“çš„ä¸åŒé‡‡ç”¨ä¸åŒçš„åˆ†å±‚æ–¹å¼ã€‚



![å±å¹•å½•åˆ¶2023-10-26 ä¸‹åˆ4.29.57 (2).gif](/img/posts/2023-10-26/2023-10-26-13.gif)

> ä¸Šå›¾ä¸­å¯ä»¥çœ‹åˆ°ï¼Œæ˜¯æœ‰åˆ†å±‚çš„ã€‚è‡³å°‘æ»šåŠ¨æ¡æ˜¯é»˜è®¤å±‚çº§é«˜äºé¡µé¢çš„ã€‚

åˆ†å±‚ä¸€èˆ¬æ˜¯è·Ÿ css å±æ€§æœ‰å…³ç³»ï¼Œä¸€èˆ¬åœ°ï¼Œå †å ä¸Šä¸‹æ–‡ç›¸å…³çš„å±æ€§ä¼šå½±å“åˆ†å±‚ã€‚ æ¯”å¦‚ z-index å¼ºåˆ¶æé«˜å±‚çº§ï¼›whil-change åˆ™é€‚ç”¨äºåˆ†å±‚æ¸²æŸ“çš„æµè§ˆå™¨ï¼Œå‘Šè¯‰æµè§ˆå™¨ï¼Œæ ¹æ®å®é™…æƒ…å†µå°†å…¶å•ç‹¬åˆ†å±‚ã€‚

åˆ†å±‚çš„ä½œç”¨ï¼š

- æé«˜æ¸²æŸ“æ•ˆç‡ï¼šé€‚ç”¨äºä½ç½®åå¤å˜åŒ–çš„å…ƒç´ ï¼Œå›æµé‡ç»˜åªåœ¨åŒå±‚å‡ºç°ï¼Œè®¡ç®—é‡ä¼šå‡å°‘

åˆ†å±‚ä¸èƒ½æ»¥ç”¨ï¼š

- åˆ†å±‚ä¼šå¢åŠ å†…å­˜æ¶ˆè€—ï¼Œè¿‡å¤šçš„åˆ†å±‚ä¼šå¯¼è‡´æµè§ˆå™¨éå†å’Œè®¡ç®—çš„è€—æ—¶å˜é•¿ã€‚æ‰€ä»¥åº”è¯¥é¿å…æ— æ„ä¹‰çš„åˆ†å±‚æˆ–è€…ä¸åˆç†çš„åˆ†å±‚


## 5. ç»˜åˆ¶æŒ‡ä»¤

è¿™ä¸€æ­¥æ˜¯æ¸²æŸ“ä¸»çº¿ç¨‹çš„æœ€åä¸€æ­¥æ“ä½œï¼Œ**ä»–é’ˆå¯¹æ¯ä¸€å±‚å…ƒç´ ï¼Œç”Ÿæˆå¯¹åº”çš„ç»˜åˆ¶æŒ‡ä»¤ï¼šæ¯”å¦‚å°†ç¬”ç§»åŠ¨åˆ° (x, y)ï¼Œç»˜åˆ¶å®½åº¦100pxçš„é»‘è‰²ç›´çº¿...**ï¼ˆç±»ä¼¼ canvasï¼‰ã€‚

ä»è¿™ä¸€æ­¥å¾€åï¼Œæ¸²æŸ“ä¸»çº¿ç¨‹çš„å·¥ä½œå°±å®Œæˆäº†ï¼Œæ¸²æŸ“ä¸»çº¿ç¨‹ä¼šå¸¦ç€æ‰€æœ‰ç”Ÿæˆçš„ç»˜åˆ¶æŒ‡ä»¤é›†ï¼Œå°†ä»»åŠ¡äº¤ç»™å…¶ä»–çº¿ç¨‹å®Œæˆã€‚

![æ— æ ‡é¢˜-2023-10-11-1617.png](/img/posts/2023-10-26/2023-10-26-14.png)


## 6. åˆ†å—ï¼ˆtilingï¼‰

åˆ°äº†è¿™ä¸€æ­¥ï¼Œæµè§ˆå™¨ä¼šå°†æ¯ä¸€å±‚ä¸Šçš„å…ƒç´ åˆ†æˆä¸åŒçš„å—ï¼Œç¡®å®šå„ä¸ªå—çš„ä¼˜å…ˆçº§ã€‚ä¸€èˆ¬é è¿‘è§†å£çš„å—ä¼˜å…ˆçº§ä¼šç›¸å¯¹è¾ƒé«˜ã€‚


![æ— æ ‡é¢˜-2023-10-11-1617.png](/img/posts/2023-10-26/2023-10-26-15.png)

åˆ†å—ä¸€èˆ¬æ˜¯äº¤ç»™åˆ†å—çº¿ç¨‹æ¥å®Œæˆçš„ï¼Œä»–ä¼šç»´æŠ¤å¾ˆå¤šä¸ªåˆæˆå™¨æ¥ç®¡ç†è¿™äº›å—çš„åˆå¹¶å’Œå±•å¼€ã€‚


## 7. å…‰æ …åŒ–ï¼ˆGPUè®¡ç®—ä¸ºä¸»ï¼‰

å…‰æ …åŒ–ï¼ˆRasterï¼‰æ˜¯å›¾åƒå¤„ç†çš„ä¸€ä¸ªæ¦‚å¿µï¼Œä»–å°†æŒ‰ç…§æ¯ä¸€ä¸ªå—çš„ä¼˜å…ˆçº§ï¼Œå°†å„ä¸ªå—å…ƒç´ è§£æä¸ºä½å›¾æ ¼å¼ã€‚å¦‚å›¾å±•ç¤ºäº†ä¸€ä¸ªåƒç´ ç‚¹åŠå…¶å‘¨è¾¹è¿é€šåŒºåŸŸåƒç´ ç‚¹çš„ç¤ºæ„å›¾ï¼š


![æ— æ ‡é¢˜-2023-10-11-1617.png](/img/posts/2023-10-26/2023-10-26-16.png)

æˆ‘ä»¬æ‰€è¯´çš„ GPUè®¡ç®—ä¸»è¦å°±æ˜¯åœ¨è¿™ä¸€ä¸ªç¯èŠ‚ï¼ŒGPU æ¯” CPU æ›´æ“…é•¿å…‰æ …åŒ–è®¡ç®—ï¼Œå…¶æœ¬è´¨æ˜¯çŸ©é˜µçš„è¿ç®—ã€‚åœ¨æµè§ˆå™¨ä¸­ï¼Œè¿™ä¸€è¿‡ç¨‹å°†åˆ†é…ç»™ GPU è¿›ç¨‹æ¥å¤„ç†ã€‚

## 8. æœ€ç»ˆç»˜åˆ¶ï¼ˆGPUè®¡ç®—ä¸ºä¸»ï¼‰

åˆæˆçº¿ç¨‹è´Ÿè´£è®¡ç®—å‡ºæ¯ä¸€ä¸ªä½å›¾åœ¨å±å¹•ä¸Šçš„ä½ç½®ï¼Œäº¤ç»™ GPU è¿›è¡Œæœ€ç»ˆå‘ˆç°ã€‚


è¿™é‡Œæ¥è§£é‡Šä¸€ä¸‹ï¼Œæ¸²æŸ“è¿›ç¨‹å®é™…ä¸Šæ˜¯åœ¨æ²™ç›’é‡Œè¾¹è¿è¡Œçš„ï¼Œå…¶æ²¡æœ‰æ“ä½œç¡¬ä»¶çš„èƒ½åŠ›ï¼Œæ‰€ä»¥è¿™é‡Œå¿…é¡»è¦äº¤ç»™ GPU è¿›ç¨‹è¿‡æ¸¡ã€‚

æ¯”è¾ƒç¥å¥‡çš„æ˜¯ï¼Œcss æ ·å¼ **transform** å¹¶ä¸æ˜¯åœ¨å…‰æ …åŒ–ä¸­ç”Ÿæˆåƒç´ ç‚¹ï¼Œè€Œæ˜¯åœ¨è¿™ä¸€æ­¥çœŸæ­£è¦ç”»çš„æ—¶å€™å†³å®šçš„ï¼Œå°±æ˜¯åœ¨ GPU åšä¸€ä¸ªçŸ©é˜µå˜æ¢ã€‚

æˆ‘ä»¬ä¸¾ä¸€ä¸ªçŸ©é˜µä¹˜æ³• åš **skewX** çš„ä¾‹å­ã€‚æˆ‘ä»¬å°† google é¦–é¡µçš„ logo æ¨ªå‘æ‰­æ›²ä¸€ä¸‹ï¼š


![image.png](/img/posts/2023-10-26/2023-10-26-17.png)


æˆ‘ä»¬ç”¨ä¸€ä¸ªç‚¹ P(x, y, 1) æ¥è¯´æ˜é—®é¢˜ï¼Œå°†å…¶è¡¨ç¤ºä¸ºé½æ¬¡åæ ‡å½¢å¼ [x, y, 1]ã€‚ï¼ˆæ¨¡å‹å‚è€ƒï¼š[skewX() - CSSï¼šå±‚å æ ·å¼è¡¨ | MDN (mozilla.org)](https://developer.mozilla.org/zh-CN/docs/Web/CSS/transform-function/skewX)ï¼‰

```
P = [x, y, 1] 
```

ä½¿ç”¨ä¹˜æ³•ç®—å­ T è¡¨ç¤ºè½¬æ¢çŸ©é˜µï¼š 

```
T = \begin{bmatrix}  
1 &  tan(25deg) & 0 \\  
0 & 1 & 0 \\  
0 & 0 & 1  \\  
\end{bmatrix}
```
![image.png](/img/posts/2023-10-26/1.png)


ç°åœ¨ï¼Œæˆ‘ä»¬è¦å°†è¿™ä¸ªç‚¹åº”ç”¨Â `transform: skewX(25deg)`Â å˜æ¢ã€‚

```
P' = T * P^{\text{T}} = [x', y', z']
```
![image.png](/img/posts/2023-10-26/2.png)

è®¡ç®—åå¾—ï¼š

```
x' = x + tan(25deg) * y  
```
```
y' = y  
```
```
z' = z = 1
```
![image.png](/img/posts/2023-10-26/3.png)


å¯ä»¥çœ‹åˆ°ï¼ŒskewX åï¼Œçºµåæ ‡æ²¡æœ‰å˜ï¼Œæ¨ªåæ ‡æ•´ä½“å‘å³ç§»åŠ¨äº† `tan(25deg) * y` çš„è·ç¦»ï¼Œæ ¹æ®ä¸‰è§’å‡½æ•°å…¬å¼å¯ä»¥çœ‹å‡ºï¼Œç¡®å®æ˜¯å‘å³å€¾æ–œäº† 25 åº¦ã€‚

> skewX å€¾æ–œæ˜¯æ ¹æ®å›¾å½¢çš„ä¸­å¿ƒç‚¹è¿›è¡Œçš„ï¼Œä¸‹åŠéƒ¨åˆ†å‘å³å¹³ç§»ï¼Œä¸ŠåŠéƒ¨åˆ†å‘å·¦å¹³ç§»ï¼›ä¸Šé¢çš„ä¾‹å­åªä¸¾ä¾‹äº†ä¸‹åŠéƒ¨åˆ†çš„æƒ…å†µã€‚

> åŒç±»å‹çš„æ“ä½œè¿˜æœ‰ ç¼©æ”¾(`scale`)ï¼Œæ—‹è½¬(`rotate`)ä»¥åŠä½ç§»(`translate`) ç­‰

--------------
å†æ¥çœ‹ä¸€ä¸‹å®Œæ•´çš„è¿‡ç¨‹ï¼Œå¸®åŠ©å›å¿†ï¼š


![æ— æ ‡é¢˜-2023-10-06-1925.png](/img/posts/2023-10-26/2023-10-26-18.png)

-----

## 9. Q & A

#### ä»€ä¹ˆæ˜¯ reflow ï¼Ÿ

å›æµçš„æœ¬è´¨æ˜¯é‡æ–°è®¡ç®—å¸ƒå±€æ ‘ã€‚æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å›æµçš„æ‰§è¡Œè¿‡ç¨‹ï¼š


![æ— æ ‡é¢˜-2023-10-11-1617.png](/img/posts/2023-10-26/2023-10-26-19.png)

å½“è¿›è¡Œäº†å½±å“å¸ƒå±€çš„æ“ä½œåï¼ˆcssomæ”¹å˜ï¼‰ï¼Œä¼šå¼•å‘ä¸€æ¬¡ layoutã€‚

æµè§ˆå™¨æœ‰è‡ªå·±çš„ä¼˜åŒ–ç­–ç•¥ï¼Œå¾€å¾€å°†å¤šæ¬¡å›æµåˆå¹¶æ‰§è¡Œï¼ˆæµè§ˆå™¨ä¼šåœ¨æ¶ˆæ¯é˜Ÿåˆ—åšä¼˜åŒ–ï¼‰ï¼Œæ¯”å¦‚åœ¨ js ä»£ç å…¨éƒ¨æ‰§è¡Œå®Œæ¯•åè¿›è¡Œç»Ÿä¸€æ‰§è¡Œï¼Œæ‰€ä»¥ reflow æ˜¯å¼‚æ­¥æ‰§è¡Œçš„ã€‚æ‰€ä»¥ï¼Œåœ¨æŸç§åœºæ™¯ä¸‹ï¼Œjs å¯èƒ½ä¸èƒ½å®æ—¶è·å–ï¼ˆåŒæ­¥è·å–ï¼‰æœ€æ–°çš„å¸ƒå±€ä¿¡æ¯ã€‚ï¼ˆå¯ä»¥é€šè¿‡ç›´æ¥åŒæ­¥è¯»å–å±æ€§æ¥å¼ºåˆ¶è§¦å‘å›æµï¼‰

> å¼€å‘è¿‡ç¨‹ä¸­ï¼Œä»£ç åº”è¯¥é¿å…é¢‘ç¹ä¿®æ”¹å¸ƒå±€æ ‘ï¼ˆheight/width/margin/padding...ï¼‰

#### ä»€ä¹ˆæ˜¯ repaint ï¼Ÿ

é‡ç»˜çš„æœ¬è´¨æ˜¯é‡æ–°æ ¹æ®åˆ†å±‚ä¿¡æ¯è®¡ç®—ç»˜åˆ¶çš„æŒ‡ä»¤ã€‚ä»–å¼€å§‹çš„èŠ‚ç‚¹ä¸€èˆ¬æ˜¯ paintï¼ŒæŸç§æƒ…å†µä¹Ÿä¼šå¼•èµ·åˆ†å±‚å˜åŒ–ã€‚

å›æµä¸€å®šä¼šå¼•èµ·é‡ç»˜ã€‚


![æ— æ ‡é¢˜-2023-10-11-1617.png](/img/posts/2023-10-26/2023-10-26-20.png)

#### ä¸ºä»€ä¹ˆ transform æ•ˆç‡é«˜ ï¼Ÿ

å› ä¸ºè®¡ç®— transform æ˜¯åœ¨æœ€åä¸€æ­¥ï¼ˆdrawï¼‰æ—¶ï¼Œé’ˆå¯¹æœ¬å±‚çº§çš„å…ƒç´ ï¼Œåœ¨ GPU ä¸­æ‰§è¡Œå˜æ¢çš„ï¼Œä¸ä¼šå¼•èµ·å›æµå’Œé‡ç»˜ã€‚


![æ— æ ‡é¢˜-2023-10-11-1617.png](/img/posts/2023-10-26/2023-10-26-21.png)

ä¸Šå›¾å¯ä»¥çœ‹åˆ°ï¼Œtransform ä¸åœ¨æ¸²æŸ“ä¸»çº¿ç¨‹ä¸­æ‰§è¡Œä»»åŠ¡ï¼Œæ‰€ä»¥ï¼Œå³ä½¿é¡µé¢ js è¿›å…¥äº†æ­»å¾ªç¯ï¼ŒåŠ¨ç”»ä¹Ÿå¯ä»¥æ­£ç¡®æ‰§è¡Œã€‚


## 10. é™„ï¼šrequestAnimationFrame ä¸ requestIdleCallback

#### æ¸²æŸ“ä»»åŠ¡å‡ºç°çš„æ—¶æœº

è§†å…·ä½“æƒ…å†µè€Œå®šï¼Œå¹¶ä¸æ˜¯æ¯ä¸€è½®æ¶ˆæ¯å¾ªç¯ç»“æŸæ—¶éƒ½ä¼šäº§ç”Ÿä¸€ä¸ª**æ¸²æŸ“ä»»åŠ¡**ã€‚è¿™è¦æ ¹æ®å±å¹•åˆ·æ–°ç‡ã€é¡µé¢æ€§èƒ½ã€é¡µé¢æ˜¯å¦åœ¨åå°è¿è¡Œç­‰æ¥å…±åŒå†³å®šï¼Œé€šå¸¸æ¥è¯´è¿™ä¸ªæ¸²æŸ“é—´éš”æ˜¯å›ºå®šçš„ã€‚é€šå¸¸å†³å®šæ¸²æŸ“æ—¶æœºçš„å› ç´ æœ‰å¦‚ä¸‹å‡ ç‚¹ï¼š

1. æ˜¾ç¤ºå™¨ä¸€èˆ¬å¸§ç‡ä¸º 60fpsï¼ˆæ¯ 16.66ms æ¸²æŸ“ä¸€æ¬¡ï¼‰ï¼Œå¦‚æœé¡µé¢æ€§èƒ½ç»´æŒä¸äº† 60fpsï¼Œæµè§ˆå™¨ä¼šé™åˆ° 30fps ä»¥ä¿è¯æ¸²æŸ“èƒ½å¤Ÿè¿›è¡Œä¸‹å»ã€‚
2. å¦‚æœæµè§ˆå™¨ä¸Šä¸‹æ–‡ä¸å¯è§ï¼Œé‚£ä¹ˆé¡µé¢ä¼šé™ä½åˆ° 4fps å·¦å³ç”šè‡³æ›´ä½ã€‚
3. å¦‚æœæµè§ˆå™¨åˆ¤å®šå½“å‰æ”¹åŠ¨ä¸ä¼šå¼•èµ·è§†è§‰å˜åŒ–æˆ–è€… **`requestAnimationFrame`** å›è°ƒä¸ºç©ºæ—¶ï¼Œåˆ™ä¼šè·³è¿‡æ¸²æŸ“ã€‚
4. åœ¨é¡µé¢ resizeã€é¡µé¢ scrollã€**`requestAnimationFrame`** è°ƒç”¨ã€IntersectionObserver è§¦å‘æ˜¾ç¤ºã€å…ƒç´ æ˜¾ç¤ºã€éšè—æˆ–ç»“æ„å˜åŒ–æ—¶ï¼Œä¸€èˆ¬åœ¨æ¸²æŸ“é—´éš”åˆ°æ¥æ—¶ä¼šæ¨é€ä¸€ä¸ªæ¸²æŸ“ä»»åŠ¡ã€‚

#### requestAnimationFrame

requestAnimationFrame çš„å›è°ƒæœ‰ä¸¤ä¸ªç‰¹ç‚¹ï¼š

1.  åœ¨é‡æ–°æ¸²æŸ“å‰è°ƒç”¨ã€‚
2.  å›è°ƒåˆå¹¶æ‰§è¡Œã€‚

ç¬¬ä¸€æ¡ï¼Œä¿è¯äº†åœ¨æ¸²æŸ“ä»»åŠ¡æ‰§è¡Œä¹‹å‰æ‰§è¡Œå®Œæƒ³è¦æ”¹å˜çš„å…ƒç´ ï¼Œä¿è¯äº†åŠ¨ç”»çš„æµç•…ï¼Œä¸ä¼šæ‹–å»¶åˆ°ä¸‹ä¸€å¸§å†æ¸²æŸ“ã€‚ç¬¬äºŒæ¡æˆ‘ä»¬å¯ä»¥çœ‹ä¸€æ®µä»£ç ï¼š

```js
// requestAnimationFrame åœ¨æ¸²æŸ“ä»»åŠ¡æ‰§è¡Œä¹‹å‰æ‰§è¡Œ
setTimeout(() => {
  console.log(1)
  requestAnimationFrame(() => console.log(2))
})
setTimeout(() => {
  console.log(3)
  requestAnimationFrame(() => console.log(4))
})

queueMicrotask(() => console.log(5))
queueMicrotask(() => console.log(6))

/** è¾“å‡º
5
6
1
3
2
4
*/
```

> queueMicrotask æ˜¯ web APIï¼Œç”¨äºåˆ›å»ºä¸€ä¸ªå¾®ä»»åŠ¡

#### requestIdleCallback

requestIdleCallback æ˜¯ç©ºé—²è°ƒåº¦ç®—æ³•ï¼ŒæŠŠä¸€äº›è®¡ç®—é‡è¾ƒå¤§ä½†æ˜¯åˆæ²¡é‚£ä¹ˆç´§æ€¥ï¼ˆä»»åŠ¡é˜Ÿåˆ—çš„ä¼˜å…ˆçº§å†³å®šï¼‰çš„ä»»åŠ¡æ”¾åˆ°ç©ºé—²æ—¶é—´å»æ‰§è¡Œã€‚ä¸è¦å»å½±å“æµè§ˆå™¨ä¸­ä¼˜å…ˆçº§è¾ƒé«˜çš„ä»»åŠ¡ï¼Œæ¯”å¦‚åŠ¨ç”»ç»˜åˆ¶ã€ç”¨æˆ·è¾“å…¥ã€å¾®ä»»åŠ¡ç­‰ç­‰ã€‚


```js
// å®šä¹‰ä½ çš„è®¡ç®—å¯†é›†å‹ä»»åŠ¡  
function computeIntensiveTask() {  
  // æ‰§è¡Œä¸€äº›å¤æ‚çš„è®¡ç®—...  
}  
  
// ä½¿ç”¨ requestIdleCallback åœ¨ç©ºé—²æ—¶æ‰§è¡Œä»»åŠ¡  
requestIdleCallback(function() {  
  computeIntensiveTask();  
}, {  
  timeout: 1000, // è®¾ç½®è¶…æ—¶æ—¶é—´ï¼Œå¦‚æœåœ¨è¿™æ®µæ—¶é—´å†…æ²¡æœ‰ç©ºé—²æ—¶é—´ï¼Œå›è°ƒå‡½æ•°å°†è¢«å–æ¶ˆ  
  dependencies: [] // å¯ä»¥è®¾ç½®ä¾èµ–é¡¹ï¼Œå½“æ‰€æœ‰ä¾èµ–é¡¹éƒ½å®Œæˆæ—¶ï¼Œæ‰ä¼šæ‰§è¡Œå›è°ƒå‡½æ•°  
});
```

ä½†æ˜¯ï¼Œå…¶å…¼å®¹æ€§è¿˜ä¸å¥½ï¼Œå¯¼è‡´ React çš„ fiber ä¸å¾—ä¸è‡ªå·±å®ç°äº†ä¸€å¥—è¿™ä¸ª APIã€‚


![image.png](/img/posts/2023-10-26/2023-10-26-22.png)


## 11. æ€»ç»“

#### æµè§ˆå™¨æ˜¯å¦‚ä½•æ¸²æŸ“é¡µé¢çš„ï¼Ÿ

1. æ¥å— HTMLï¼Œäº§ç”Ÿæ¸²æŸ“ä»»åŠ¡ï¼Œäº¤ç»™æ¸²æŸ“ä¸»çº¿ç¨‹çš„æ¶ˆæ¯é˜Ÿåˆ—
2. åœ¨æ¶ˆæ¯å¾ªç¯æœºåˆ¶ä¸‹ï¼Œæ¸²æŸ“ä¸»çº¿ç¨‹ä¾æ¬¡å–å‡ºä»»åŠ¡å¹¶å¼€å§‹æ¸²æŸ“
3. æ¸²æŸ“ä»»åŠ¡åˆ†ä¸ºå¤šä¸ªé˜¶æ®µä¸²è¡Œæµæ°´æ‰§è¡Œ:

```js
1. htmlè§£æ
2. æ ·å¼è®¡ç®—
3. å¸ƒå±€
4. åˆ†å±‚
5. ç»˜åˆ¶æŒ‡ä»¤
6. åˆ†å—
7. å…‰æ …åŒ–
8. ç”»å‡ºåƒç´ ç‚¹ã€‚
```57:T2812,äº‹ä»¶å¾ªç¯ ï¼ˆEvent loopï¼Œåˆå«æ¶ˆæ¯å¾ªç¯ Message loopï¼‰æ˜¯æµè§ˆå™¨çš„æ ¸å¿ƒæ¦‚å¿µä¹‹ä¸€ï¼Œæ˜¯å‰ç«¯å­¦ä¹ å’ŒæŠ€æœ¯æå‡ç»•ä¸è¿‡å»çš„çŸ¥è¯†ã€‚æœ¬æ–‡é€šè¿‡å›¾è§£çš„æ–¹å¼ï¼Œè®²è¿°ä¸€ä¸‹ç°ä»£æµè§ˆå™¨äº‹ä»¶å¾ªç¯çš„è¿è¡ŒåŸç†ã€‚

## 1. æµè§ˆå™¨çš„è¿›ç¨‹ä¸çº¿ç¨‹

è¿›ç¨‹æ˜¯è®¡ç®—æœºæ“ä½œç³»ç»Ÿèµ„æºåˆ†é…çš„æœ€å°å•ä½ã€‚ç°ä»£æµè§ˆå™¨ï¼Œä»¥ chrome ä¸ºä¾‹ï¼Œå¹¿æ³›é‡‡ç”¨çš„æ˜¯å¤šè¿›ç¨‹æ¶æ„ã€‚ä¸ºäº†å‡å°‘è¿ç¯å´©æºƒçš„å‡ ç‡ï¼Œå¯åŠ¨æµè§ˆå™¨åï¼Œä¼šå°†å„ä¸ªä»»åŠ¡æ‹†åˆ†ä¸ºå¤šä¸ªè¿›ç¨‹ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š


![è¿›ç¨‹.png](/img/posts/2023-10-12/2023-10-12-1.png)

chrome å°†æµè§ˆå™¨ä»»åŠ¡æ‹†åˆ†ä¸ºå¤šä¸ªè¿›ç¨‹ï¼š

- æµè§ˆå™¨è¿›ç¨‹ï¼ˆBrowser processï¼‰ï¼šæˆ‘è´Ÿè´£ç•Œé¢æ˜¾ç¤ºã€ç”¨æˆ·äº¤äº’ã€å­è¿›ç¨‹ç®¡ç†ç­‰ä¸šåŠ¡ã€‚
- ç½‘ç»œè¿›ç¨‹ï¼ˆNetwork processï¼‰ï¼šæˆ‘è´Ÿè´£åŠ è½½ç½‘ç»œèµ„æºä¸šåŠ¡ã€‚
- æ¸²æŸ“è¿›ç¨‹ï¼ˆRendering processï¼‰ï¼šæˆ‘æ˜¯æ¸²æŸ“çš„ä¸»è§’ï¼Œè´Ÿè´£æ‰§è¡Œ HTMLã€cssã€js ä»£ç ã€‚é»˜è®¤æƒ…å†µï¼Œæµè§ˆå™¨ä¼šä¸ºæ¯ä¸€ä¸ª tab é¡µç­¾å¼€å¯ä¸€ä¸ªæ¸²æŸ“è¿›ç¨‹ï¼Œä»¥ç¡®ä¿ç›¸äº’ä¸å½±å“ã€‚
- ...

> é¢‘ç¹å¼€å¯è¿›ç¨‹ä¼šé€ æˆå†…å­˜å ç”¨è¿‡å¤šçš„æƒ…å†µï¼Œchrome åç»­ä¼šè¿›è¡Œæ”¹è¿›ï¼Œè€ƒè™‘ç›¸åŒç«™ç‚¹ï¼ˆç›¸åŒé¡¶çº§åŸŸåå’ŒäºŒçº§åŸŸåï¼‰å…±ç”¨ä¸€ä¸ªæ¸²æŸ“è¿›ç¨‹ã€‚

![æ— æ ‡é¢˜-2023-10-06-19251.png](/img/posts/2023-10-12/2023-10-12-2.png)


æ¸²æŸ“è¿›ç¨‹ä¼šå¼€å¯ä¸€ä¸ªæ¸²æŸ“ä¸»çº¿ç¨‹ï¼Œç”¨äºæ— é˜»å¡æ¸²æŸ“ä»»åŠ¡ã€‚å…¶ä½™çº¿ç¨‹ååŠ©ä¸»çº¿ç¨‹å®Œæˆä»»åŠ¡ã€‚

**æ¸²æŸ“ä¸»çº¿ç¨‹ï¼ˆMain threadï¼‰** è´Ÿè´£æ‰§è¡Œä»£ç ã€æ ·å¼ä¸å¸ƒå±€ï¼ˆé€šè¿‡ä¼˜å…ˆçº§ã€ç™¾åˆ†æ¯”æ¢ç®—ã€å®½é«˜ç­‰å‡ ä½•ä¿¡æ¯é«˜åŠ¨æ€è®¡ç®—ã€ç›¸å¯¹ä½ç½®ç­‰è®¡ç®—æœ€ç»ˆæ ·å¼è¡¨ï¼‰ã€å¤„ç†å›¾å±‚ã€æ§åˆ¶60å¸§åˆ·æ–°ã€æ‰§è¡Œå„ç§å›è°ƒå‡½æ•°ç­‰ï¼Œæ˜¯æœ€å¿™çš„ä¸€ä¸ªï¼Œä¸€åˆ»ä¹Ÿæ²¡æœ‰åœæ­‡ã€‚


![æ— æ ‡é¢˜-2023-10-06-19252.png](/img/posts/2023-10-12/2023-10-12-3.png)

æ­¤æ—¶å°±æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œä¸»æ¸²æŸ“ä»»åŠ¡éƒ½äº¤ç»™ä¸€ä¸ªçº¿ç¨‹ï¼Œæ•ˆç‡ä¼šé«˜å—ï¼Ÿä¸ºä»€ä¹ˆä¸å¤šçº¿ç¨‹ä¸€èµ·æ¸²æŸ“ï¼Ÿ

è¿™æ˜¯å› ä¸ºæµè§ˆå™¨æ¸²æŸ“å’Œ JavaScript æ‰§è¡Œå…±ç”¨ä¸€ä¸ªçº¿ç¨‹ï¼Œè€Œé»˜è®¤æƒ…å†µä¸‹ï¼Œ JavaScript æ‰§è¡Œåˆä¼šå½±å“ CSSOM/DOM æ ‘çš„æ¸²æŸ“å’Œç»“æ„ï¼Œæ‰€ä»¥å¿…é¡»é˜»å¡æ¸²æŸ“ï¼Œä»–ä»¬ä¹Ÿå¿…é¡»æ˜¯å•çº¿ç¨‹æ“ä½œã€‚åœ¨æ„å»º DOM æ—¶ï¼ŒHTML è§£æå™¨è‹¥é‡åˆ°äº† JavaScriptï¼Œå®ƒä¼šæš‚åœæ„å»ºDOMï¼Œå°†æ§åˆ¶æƒç§»äº¤ç»™ JavaScript å¼•æ“ï¼Œç­‰ JavaScript å¼•æ“è¿è¡Œå®Œæ¯•ï¼Œæµè§ˆå™¨å†ä»ä¸­æ–­çš„åœ°æ–¹æ¢å¤ DOM æ„å»ºã€‚å¦‚æœä½¿ç”¨å¤šçº¿ç¨‹å¤„ç†å¯èƒ½ä¼šå¯¼è‡´æ¸²æŸ“DOMçš„å†²çªï¼Œå¤æ‚åº¦ä¼šå¤§å¹…åº¦æå‡ï¼š


![æ— æ ‡é¢˜-2023-10-06-19254.png](/img/posts/2023-10-12/2023-10-12-4.png)

## 2. æ¶ˆæ¯å¾ªç¯

ä¸Šé¢ä½¿ç”¨å•çº¿ç¨‹ï¼Œä½¿å¾—åœ¨ç¼–å†™ä»£ç æ—¶æ— éœ€è€ƒè™‘å¤æ‚çš„çº¿ç¨‹åŒæ­¥å’Œäº’æ–¥é—®é¢˜ï¼Œä»è€Œé™ä½äº†å¼€å‘çš„å¤æ‚æ€§ï¼Œä½†æ˜¯ç»ˆå½’æ•ˆç‡æ˜¯ä¸Šä¸å»çš„ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œè¿™é‡Œå·§å¦™åœ°å¼•å…¥äº†æ¶ˆæ¯å¾ªç¯æ¥ç»Ÿä¸€è§£å†³è¿™ä¸ªé—®é¢˜ã€‚

**æ ¸å¿ƒæ€æƒ³**ï¼šæ¸²æŸ“ä¸»çº¿ç¨‹æ°¸ä¹…è½®è¯¢æ‰§è¡Œä»»åŠ¡ï¼›å•ç‹¬å¼€è¾Ÿä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ï¼ˆMessage queueï¼‰ç©ºé—´ç”¨äºå­˜æ”¾å„ä¸ªçº¿ç¨‹åŠ å…¥çš„ä»»åŠ¡ï¼›æ¸²æŸ“ä¸»çº¿ç¨‹åªæ˜¯ç®€å•çš„æ‹¿å–ä»»åŠ¡æ‰§è¡Œï¼Œè€Œä¸ç”¨æ“å¿ƒè¿™ä¸ªä»»åŠ¡æ˜¯è°é€è¿‡æ¥çš„ã€‚åœ¨ Chrome çš„æºç ä¸­ï¼Œä½¿ç”¨çš„æ˜¯ä¸€ä¸ªæ­»å¾ªç¯æ¥å®Œæˆçš„ï¼š

```cpp
for(;;) {}
```

> æ¶ˆæ¯é˜Ÿåˆ—çš„æ— é™è½®è¯¢å°±å«æ¶ˆæ¯å¾ªç¯ï¼Œæ¶ˆæ¯å¾ªç¯å°±å‘ç”Ÿåœ¨æ¸²æŸ“ä¸»çº¿ç¨‹é‡Œ

![æ— æ ‡é¢˜-2023-09-15-1456.png](/img/posts/2023-10-12/2023-10-12-5.png)

1. æœ€å¼€å§‹ï¼Œæ¸²æŸ“ä¸»çº¿ç¨‹å¼€å§‹è½®è¯¢
2. æ¯ä¸€æ¬¡å‘¢å¾ªç¯æ£€æŸ¥æ¶ˆæ¯é˜Ÿåˆ—æ˜¯å¦æœ‰ä»»åŠ¡ï¼Œæœ‰åˆ™å–å‡ºç¬¬ä¸€ä¸ªä»»åŠ¡æ‰§è¡Œã€‚
3. å…¶ä»–æ‰€æœ‰çº¿ç¨‹éƒ½å¯ä»¥è¿½åŠ ä»»åŠ¡è¿›æ¶ˆæ¯é˜Ÿåˆ—çš„æœ«å°¾ã€‚

### å¼‚æ­¥

åœ¨æ¶ˆæ¯å¾ªç¯ä¸­ï¼Œè‚¯å®šä¼šå­˜åœ¨ä¸€äº›éœ€è¦å»¶æ—¶æ‰§è¡Œçš„ä»£ç ï¼Œjsåœ¨æ‰§è¡Œåˆ°ä»–ä»¬æ—¶ä¸ä¼šç«‹å³è§¦å‘å›è°ƒï¼Œè€Œæ˜¯éœ€è¦æŸç§è®¡æ—¶æœºåˆ¶æˆ–è€…è§¦å‘æœºåˆ¶æ¥å®šæ—¶è§¦å‘ï¼Œä»–ä»¬ä¸€èˆ¬æ˜¯é€šè¿‡å›è°ƒå‡½æ•°æ¥è¿”å›æ‰§è¡Œçš„ç»“æœï¼Œå¤§è‡´åˆ†ç±»å¦‚ä¸‹ï¼š

1. å‰ç«¯APIè®¡æ—¶å™¨ï¼šsetTimeoutã€setInterval
2. å‰ç«¯å¼‚æ­¥ APIï¼šPromiseç­‰
3. ç½‘ç»œé€šä¿¡ï¼šXHRã€fetchç­‰
4. ç”¨æˆ·äº¤äº’å›è°ƒï¼šaddEventListener

> å¼‚æ­¥ä¸åŒæ­¥æœ€å¤§çš„ä¸åŒæ˜¯ï¼Œå¼‚æ­¥å›è°ƒè§¦å‘å‰çš„å»¶æ—¶å¯¹ç”¨æˆ·æ˜¯æ²¡æœ‰å¿…è¦çš„ã€‚è®¾è®¡æµè§ˆå™¨æ—¶ï¼Œå¼‚æ­¥è§¦å‘å‰çš„é‚£æ®µå»¶æ—¶åº”è¯¥å¦å¤–å¼€è¾Ÿçº¿ç¨‹ï¼ˆæ¯”å¦‚è®¡æ—¶çº¿ç¨‹ï¼‰å•ç‹¬è®¡æ•°ï¼Œè€Œä¸é˜»å¡æ¸²æŸ“ä¸»çº¿ç¨‹

å¼‚æ­¥çš„æ¸²æŸ“è¿‡ç¨‹å¦‚ä¸‹ï¼š


![æ— æ ‡é¢˜-2023-09-15-1456.png](/img/posts/2023-10-12/2023-10-12-6.png)

å¯ä»¥çœ‹åˆ°ï¼Œå¼‚æ­¥ä»»åŠ¡åœ¨æ‰§è¡Œå®Œæ¯•åè¿›å…¥æ¶ˆæ¯é˜Ÿåˆ—æœ«å°¾æ’é˜Ÿå³å¯ï¼ä¸»çº¿ç¨‹åªç®¡æ‹¿æ¶ˆæ¯ä»»åŠ¡ï¼Œè€Œä¸ç”¨ç®¡è®¡æ—¶ä»»åŠ¡æ˜¯å¦å®Œæˆã€‚

> è®¡æ—¶çº¿ç¨‹å…¶å®ä½¿ç”¨çš„æ˜¯æ“ä½œç³»ç»Ÿåº•å±‚çš„é€»è¾‘ï¼Œè¿™é‡Œä¸åšæ·±ç©¶ã€‚


#### å¼‚æ­¥æ¡ˆä¾‹

çœ‹ä¸‹é¢çš„ä»£ç ï¼š

```js
function delay(duration) { /* æ­»å¾ªç¯ duration ç§’ */ }

const btn = document.querySelector('button');
const h1 = document.querySelector('h1');

btn.onclick = function() {
    h1.textContent = 'hello message queue !'
    delay(3000)
}
```
ä»–æ‰§è¡Œåä¼šæœ‰ä»€ä¹ˆè¡¨ç°ï¼Ÿæ˜¯é¡µé¢æ ‡é¢˜å˜ä¸º 'hello message queue !' åå‡æ­»3ç§’é’Ÿå—ï¼Ÿæˆ‘ä»¬ç”¨å›¾è§£æ¥åˆ†æä¸€ä¸‹ï¼š


![æ— æ ‡é¢˜-2023-09-15-1456.png](/img/posts/2023-10-12/2023-10-12-7.png)

æˆ‘ä»¬æ¥çœ‹å›¾è¯´è¯ï¼š

1. ç”¨æˆ·ç‚¹å‡»ï¼Œç‚¹å‡»çš„å›è°ƒè¿›å…¥æ¶ˆæ¯é˜Ÿåˆ—
2. è¿™ä¸ªå›è°ƒäº‹ä»¶åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼ŒåŒæ­¥ä»£ç  `h1.textContent = 'hello message queue !'` ç«‹å³æ‰§è¡Œï¼Œå»¶æ—¶ä»£ç å¼€å§‹æ‰§è¡Œè¿›å…¥æ­»å¾ªç¯
3. æœ€åå…¥é˜Ÿä¸€ä¸ªç»˜åˆ¶ä»»åŠ¡ï¼Œåœ¨å…¶ä»–ä»£ç æ‰§è¡Œå®Œæ¯•åå¼€å§‹ç»˜åˆ¶

æ˜¯ä¸æ˜¯çœ‹å‡ºé—®é¢˜æ¥å•¦ï¼Ÿæµè§ˆå™¨å®é™…æ•ˆæœæ˜¯å…ˆå‡æ­»3ç§’é’Ÿå†æ”¹å˜æ ‡é¢˜æ–‡å­—ï¼

> ç»˜åˆ¶ä»»åŠ¡ä¾§é‡äºæ¸²æŸ“åŸç†ï¼Œä¸æ˜¯æœ¬æ–‡é‡ç‚¹ï¼Œä¸åšèµ˜è¿°ã€‚ä»–å‡ºç°åœ¨å¾ªç¯çš„æ¯ä¸€æ¬¡è¿­ä»£ä¹‹åã€‚åœ¨æ¯ä¸€ä¸ªäº‹ä»¶å¾ªç¯çš„è¿­ä»£ä¸­ï¼Œæµè§ˆå™¨ä¼šå…ˆå¤„ç†æ‰€æœ‰çš„åŒæ­¥ä»»åŠ¡ï¼ˆä¾‹å¦‚ï¼šè§£æHTMLï¼Œå¤„ç†DOMæ“ä½œç­‰ï¼‰ï¼Œç„¶åå¤„ç†å¼‚æ­¥ä»»åŠ¡ï¼ˆä¾‹å¦‚ï¼šç½‘ç»œè¯·æ±‚ï¼Œå®šæ—¶å™¨å›è°ƒç­‰ï¼‰ã€‚åœ¨è¿™ä¸ªå¼‚æ­¥ä»»åŠ¡å®Œæˆåï¼Œæµè§ˆå™¨ä¼šè¿›å…¥ä¸‹ä¸€ä¸ªäº‹ä»¶å¾ªç¯è¿­ä»£ã€‚

#### ç†è§£å¼‚æ­¥

å…³äºå¼‚æ­¥ï¼Œæˆ‘ä»¬æ˜¯æ€ä¹ˆç†è§£çš„å‘¢ï¼Ÿ

ä¸€èˆ¬æ¥è¯´ï¼Œå•çº¿ç¨‹è¯­è¨€æ˜¯æ²¡æœ‰ä¸¥æ ¼æ„ä¹‰çš„å¼‚æ­¥çš„ï¼Œä»£ç æ˜¯ä»ä¸Šè‡³ä¸‹ä¾æ¬¡æ‰§è¡Œçš„ã€‚ä¸Šé¢è®²çš„å¼‚æ­¥ï¼Œæ˜¯åœ¨æµè§ˆå™¨ç»´åº¦æ¥è®²çš„ï¼Œjsæ²¡æœ‰å¤šçº¿ç¨‹ï¼Œä½†æ˜¯æµè§ˆå™¨å¯ä»¥å¼€è¾Ÿå¤šä¸ªçº¿ç¨‹æ¥ç»´æŠ¤å¼‚æ­¥çš„ä»»åŠ¡ã€‚

æ¸²æŸ“ä¸»çº¿ç¨‹æ‰§è¡Œ js ä»»åŠ¡ï¼ˆjsçº¿ç¨‹é˜»å¡æ‰§è¡Œï¼‰ï¼Œä¸»çº¿ç¨‹æœ‰æ‰¿æ‹…æ¸²æŸ“çš„å…¶ä»–ä»»åŠ¡ï¼Œå¦‚æœéƒ½åŒæ­¥æ‰§è¡Œï¼Œä¸»çº¿ç¨‹å°±ä¼šç™½ç™½æ¶ˆè€—æ—¶é—´ï¼Œé¡µé¢ç»å¸¸æ€§å‡æ­»ã€‚

é‡‡ç”¨æ¶ˆæ¯å¾ªç¯+å¼‚æ­¥æ—¶ï¼Œåœ¨å¼‚æ­¥ä»»åŠ¡å‘ç”Ÿæ—¶ï¼Œä¸»çº¿ç¨‹å°†è¿™ä¸ªä»»åŠ¡äº¤ç»™å…¶ä»–çº¿ç¨‹æ¥æ‰§è¡Œï¼Œè·³è¿‡è¿™ä¸ªä»»åŠ¡å¾€åæ‰§è¡Œï¼›å…¶ä»–çº¿ç¨‹æ‰§è¡Œå®Œæ¯•åå°†å›è°ƒåŒ…è£…æˆä»»åŠ¡æ”¾å…¥æ¶ˆæ¯é˜Ÿåˆ—æœ«å°¾ï¼Œç­‰å¾…ä¸»çº¿ç¨‹è°ƒç”¨ã€‚

è¿™å°±ä¿è¯äº†å•çº¿ç¨‹æ¸²æŸ“æ—¶ï¼Œæ°¸ä¸é˜»å¡æ¸²æŸ“ã€‚æœ€å¤§é™åº¦ä¿è¯ä¸»çº¿ç¨‹æµç•…ã€‚


### ä¼˜å…ˆçº§

ä»»åŠ¡æœ¬èº«æ²¡æœ‰ä¼˜å…ˆçº§ï¼Œæ¸²æŸ“ä¸»çº¿ç¨‹ä¾æ¬¡ä»å¯¹å¤´æ‹¿å–ä»»åŠ¡æ‰§è¡Œã€‚æœ‰ä¼˜å…ˆçº§çš„æ˜¯æ¶ˆæ¯é˜Ÿåˆ—ã€‚

åœ¨æœ€æ–°ç‰ˆçš„ chrome ä¸­ï¼Œæ¶ˆæ¯é˜Ÿåˆ—å…¶å®ä¸æ˜¯ä¸€ä¸ªé˜Ÿåˆ—ï¼Œè€Œæ˜¯å¤šä¸ªï¼Œä»–ä»¬æœ‰ä¼˜å…ˆçº§ï¼Œè¿™ä¸ªä¼˜å…ˆçº§å†³å®šäº†è°å…ˆè¿›å…¥æ¸²æŸ“ä¸»çº¿ç¨‹è¢«æ‰§è¡Œï¼š

- å»¶æ—¶é˜Ÿåˆ—ï¼ˆDelay queueï¼‰ï¼šè®¡æ—¶å™¨å›è°ƒä»»åŠ¡é˜Ÿåˆ—ï¼Œä¼˜å…ˆçº§ã€ä¸­ã€‘
- äº¤äº’é˜Ÿåˆ—ï¼ˆInteractive queueï¼‰ï¼šç”¨æˆ·äº¤äº’åå›è°ƒäº‹ä»¶é˜Ÿåˆ—ï¼Œä¼˜å…ˆçº§ã€é«˜ã€‘
- å¾®ä»»åŠ¡é˜Ÿåˆ—ï¼ˆMicro queueï¼‰ï¼šç”¨æˆ·æ•°æ®æœ€å¿«æ‰§è¡Œé˜Ÿåˆ—ï¼Œä¾‹å¦‚ Promiseã€MutationObserver ç­‰ï¼Œå…¶ä¼˜å…ˆçº§ã€æœ€é«˜ã€‘
- ...


> æ ¹æ® W3C æœ€æ–°æ ‡å‡†ï¼Œç°ä»£æµè§ˆå™¨å°†å®ä»»åŠ¡é˜Ÿåˆ—çš„æ¦‚å¿µè¿›ä¸€æ­¥åšäº†ç»†åˆ†ã€‚åŸæ¥çš„å®ä»»åŠ¡ä¸»è¦åŒ…å«ï¼š`script(æ•´ä½“ä»£ç )ã€setTimeoutã€setIntervalã€I/Oã€UIäº¤äº’äº‹ä»¶ã€postMessageã€MessageChannelã€setImmediate(Node.js ç¯å¢ƒ)`ç­‰ã€‚

#### ä¼˜å…ˆçº§æ¡ˆä¾‹

æˆ‘ä»¬ç”¨ä¸€ä¸ªä¾‹å­æ¥è§£é‡Šï¼š

```js
setTimeout(function() {
  console.log(1);
}, 0);

console.log(2);

Promise.resolve().then(function() {
  console.log(3);
});

console.log(4);
```

æˆ‘ä»¬å°†ä»£ç æ‹†åˆ†å‡ å—æ¥åˆ†æï¼š


![æ— æ ‡é¢˜-2023-10-11-1617.png](/img/posts/2023-10-12/2023-10-12-8.png)

js ä»£ç æ˜¯åŒæ­¥æ‰§è¡Œçš„ï¼Œæ‰€ä»¥è¿™ 4 å—ä¼šè¢« js æ‰§è¡Œå¼•æ“å¿«é€Ÿæ‰«æåˆ°å¹¶åŠ å…¥å“åº”çš„é˜Ÿåˆ—é‡Œï¼š


![æ— æ ‡é¢˜-2023-10-11-1617.png](/img/posts/2023-10-12/2023-10-12-9.png)

ç„¶åæ¸²æŸ“ä¸»çº¿ç¨‹ä¼šæŒ‰ç…§é˜Ÿåˆ—çš„ä¼˜å…ˆçº§æ‹¿å–ä»»åŠ¡ï¼Œç”±äº 2 å’Œ 4 å·ä»»åŠ¡æ˜¯åŒæ­¥ä»£ç ï¼Œç›´æ¥å…¥æ¸²æŸ“ä¸»çº¿ç¨‹ï¼Œå¯ç›´æ¥æ‰§è¡Œï¼Œæ‰“å° 2 å’Œ 4ï¼›æ¥ä¸‹æ¥æ‹¿å–ä¼˜å…ˆçº§æœ€é«˜çš„å¾®å¯¹åˆ—çš„ä»»åŠ¡ 3 å¹¶æ‰§è¡Œï¼Œè¾“å‡º 3ï¼Œæ¥ä¸‹æ¥æ‹¿äº¤äº’é˜Ÿåˆ—ï¼Œæ²¡æœ‰ä»»åŠ¡ï¼›æœ€åè·å–å»¶æ—¶é˜Ÿåˆ—çš„ä»»åŠ¡ï¼Œå¹¶ä¾æ¬¡æ‰§è¡Œã€‚

æ³¨æ„ï¼Œè¿™é‡Œ 1 å·å»¶æ—¶ä»»åŠ¡æ‰§è¡Œæ—¶ï¼Œä¼šå¼€è¾Ÿè®¡æ—¶çº¿ç¨‹æ¥è®¡æ•°ï¼Œè®¡æ•°å®Œæˆåï¼Œå°†é‡Œè¾¹çš„åŒæ­¥ä»£ç  `console.log(1);` åŠ å…¥åŒæ­¥çš„æ¶ˆæ¯é˜Ÿåˆ— (è¿™é‡Œå°±æ˜¯ç›´æ¥åŠ å…¥æ¸²æŸ“ä¸»çº¿ç¨‹ï¼‰åŒæ­¥æ‰§è¡Œï¼Œå°±å¯ä»¥è¾“å‡º 1 äº†ã€‚æ‰€ä»¥è¾“å‡ºç»“æœæ˜¯ï¼š`2 4 3 1`

----

## 3. æ€»ç»“

**æ¦‚å¿µä¸€**ï¼šæ¶ˆæ¯å¾ªç¯åˆå«äº‹ä»¶å¾ªç¯ï¼Œæ˜¯æµè§ˆå™¨å¤„ç†å¼‚æ­¥çš„ä¸€ç§è°ƒåº¦ç­–ç•¥ã€‚

**æ¦‚å¿µäºŒ**ï¼šæ¸²æŸ“ä¸»çº¿ç¨‹ä¼šåå¤è½®è¯¢ï¼ˆforå¾ªç¯ï¼‰ï¼Œä¸æ–­æ‹¿å–æ¶ˆæ¯é˜Ÿåˆ—çš„ä»»åŠ¡æ¥æ‰§è¡Œï¼›å…¶ä»–çº¿ç¨‹è·å–åˆ°ä»»åŠ¡åï¼Œåœ¨åˆé€‚çš„æ—¶æœºå°†å…¶è¿½åŠ åœ¨æ¶ˆæ¯é˜Ÿåˆ—æœ«å°¾ã€‚

**æ¦‚å¿µä¸‰**ï¼šä»»åŠ¡é˜Ÿåˆ—åˆ†ä¸º å»¶æ—¶é˜Ÿåˆ—ã€äº¤äº’é˜Ÿåˆ—ã€å¾®ä»»åŠ¡é˜Ÿåˆ—ï¼›ä¸åŒä»»åŠ¡é˜Ÿåˆ—æœ‰ä¸åŒçš„ä¼˜å…ˆçº§ã€‚

### Q&A

#### å»¶æ—¶é˜Ÿåˆ—æ˜¯æ€ä¹ˆè®¡æ—¶çš„ï¼Ÿæ—¶é—´ç²¾ç¡®å—ï¼Ÿ

å»¶æ—¶é˜Ÿåˆ—è°ƒç”¨çš„æ˜¯æ“ä½œç³»ç»Ÿçš„åŠŸèƒ½ï¼Œè€Œè®¡ç®—æœºç¡¬ä»¶å¹¶æ²¡æœ‰ç±»ä¼¼åŸå­é’Ÿçš„è®¾å¤‡ï¼ˆä½¿ç”¨çš„æ˜¯CPUå¯„å­˜å™¨è®¡æ—¶ï¼‰ï¼Œæ²¡æœ‰åŠæ³•åšåˆ°ç™¾åˆ†ç™¾ç²¾å‡†ã€‚

æŒ‰ç…§ W3C æ ‡å‡†ï¼Œæµè§ˆå™¨å®ç°è®¡æ—¶å™¨æ—¶ï¼Œå¦‚æœåµŒå¥—å±‚çº§è¶…è¿‡ 5 å±‚ï¼Œåˆ™ä¼šå¸¦æœ‰ 4 æ¯«ç§’çš„æœ€å°é—´éš”æ—¶é—´ï¼Œè¿™åˆè¿›ä¸€æ­¥åŠ å¤§äº†å»¶æ—¶çš„è¯¯å·®ã€‚è€Œä¸”è®¡æ—¶å™¨å›è°ƒä¹Ÿåªä¼šåœ¨æ¸²æŸ“ä¸»çº¿ç¨‹ç©ºé—²æ—¶æ‰§è¡Œï¼Œå¦‚æœå»¶æ—¶ä»»åŠ¡ä¹‹å‰æœ‰ä¸€ä¸ªå¾ˆé•¿çš„ js åŒæ­¥é˜»å¡ï¼Œä¹Ÿä¼šé€ æˆå®šæ—¶ä¸å‡†ç¡®ã€‚


Chrome å…³äºæœ€å°å»¶æ—¶çš„æºç ï¼š

![image.png](/img/posts/2023-10-12/2023-10-12-10.png)



----

## 4. ç»ƒä¸€ç»ƒ

ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—çš„ç†å¿µï¼Œå£ç®—ä¸€ä¸‹è¾“å‡ºæ˜¯ä»€ä¹ˆå§ï¼


```js
function test() {
  console.log(1);
  Promise.resolve().then(function() {
    console.log(2);  
  });
}

setTimeout(function() {
  console.log(3);
  Promise.resolve().then(test);
});

Promise.resolve().then(function() {
  console.log(4);
  setTimeout(() => {
    console.log(5);
  });
});

console.log(6);
```58:T12d6,æœ¬æœŸæ¥è®²è§£ä¸€ä¸‹ react-dom åº“ä¸­ç”¨äºå®¢æˆ·ç«¯æ¸²æŸ“çš„ API ä»¬ã€‚

## 1. çº¯å®¢æˆ·ç«¯æ¸²æŸ“ createRoot

createRoot ç”¨äºå®¢æˆ·ç«¯åˆ›å»º React æ¸²æŸ“çš„æ ¹èŠ‚ç‚¹ã€‚ï¼ˆæœåŠ¡ç«¯æ¸²æŸ“æ— æ•ˆï¼‰

è¿™é‡Œä¸»è¦ä»‹ç»ä½¿ç”¨æ–¹å¼ã€‚

### ä½¿ç”¨æ–¹å¼ 

1. åˆå§‹åŒ–ä¸€ä¸ª React é¡¹ç›®

```js
import { createRoot } from 'react-dom/client';
import App from './App.js';
import './styles.css';

const root = createRoot(document.getElementById('root'));
root.render(<App />);
```

ä¸Šé¢çš„äººä»£ç ï¼ŒcreateRoot è·å–ä¸€ä¸ªçœŸå®çš„ DOM å…ƒç´ å¯¹è±¡æœ¬èº«ä½œä¸ºå…¥å‚ï¼Œè¿”å› React æ¸²æŸ“æ ‘çš„æ ¹èŠ‚ç‚¹ï¼Œä»–æœ‰ `render` å’Œ `unmount` ä¸¤ä¸ªæ–¹æ³•ã€‚ä»–ä½œä¸ºé¡¹ç›®çš„å…¥å£ï¼Œåªå»ºè®®ä½¿ç”¨ä¸€æ¬¡ã€‚

å…¶æ‰§è¡Œæµç¨‹å¦‚ä¸‹ï¼š

- æŸ¥æ‰¾ HTML ä¸­ä¼ å…¥çš„ DOM node.
- åœ¨è¯¥ DOM ä¸­æ”¾ç½®ç»„ä»¶ App ï¼ˆä¼šæ¸…ç©ºå·²æœ‰å…ƒç´ ï¼‰

2. é¡¹ç›®ä¸­éƒ¨åˆ†æ¸²æŸ“

æ¯”å¦‚é¡¹ç›®ä¸­æœ‰ä¸€ä¸ª html é¡µé¢ï¼š

```html
<nav id="navigation"></nav>
<main>
  <p>This paragraph is not rendered by React (open index.html to verify).</p>
  <section id="comments"></section>
</main>
```

æˆ‘ä»¬å¼•å…¥ä¸€ä¸ªjsæ–‡ä»¶ï¼š

```js
const navDomNode = document.getElementById('navigation');
const navRoot = createRoot(navDomNode); 
navRoot.render(<Navigation />);

const commentDomNode = document.getElementById('comments');
const commentRoot = createRoot(commentDomNode); 
commentRoot.render(<Comments />);
```
è¿™æ ·ï¼Œåœ¨ nav å’Œ main ä¸­å°±å„è‡ªäº§ç”Ÿäº†ä¸€ä¸ª React çš„æ¸²æŸ“æ ‘ï¼š


![image.png](/img/posts/2023-9-17/2023-9-17-1.png)

å¦‚æœä½ æƒ³è¦æ’¤é”€ä¸Šè¿°æ¸²æŸ“å·¥ä½œï¼Œå¯ä»¥è¿™æ ·å†™ï¼š

```js
root.unmount();
```

3. æ›´æ–°å·²ç»æ¸²æŸ“è¿‡çš„Reactæ ‘

å·²ç»åˆ›å»ºå‡ºæ¥çš„ rootï¼Œå¦‚æœæƒ³è¦æ›¿æ¢å…¶æ¸²æŸ“å†…å®¹ï¼Œå¯ä»¥è¿™æ ·ï¼š

```js
root.render(<App counter={i} />);
```

è¿™ä¼šé”€æ¯åŸæ¥çš„æ¸²æŸ“ï¼Œè€Œé‡æ–°å»ºç«‹æ–°çš„æ¸²æŸ“æ ‘ã€‚ä¸‹é¢çš„ä¾‹å­å°±æ˜¯åˆ©ç”¨è¿™ç§åŸç†å®ç°çš„é¡µé¢è®¡æ—¶å™¨ï¼š

```js
setInterval(() => {
  root.render(<App counter={i} />);
  i++;
}, 1000);
```
æ¯è¿‡ä¸€ç§’å°±åˆ·æ–°ä¸€ä¸‹é¡µé¢æ¸²æŸ“çš„ç»„ä»¶ã€‚


## 2. æ°´åˆæœåŠ¡ç«¯æ¸²æŸ“ä»£ç  hydrateRoot

`hydrate`Â çš„ä¸»è¦ä½œç”¨æ˜¯åœ¨å®¢æˆ·ç«¯æ¥ç®¡ä»æœåŠ¡å™¨ç«¯æ¸²æŸ“çš„åº”ç”¨ç¨‹åºï¼Œå¹¶å°†åº”ç”¨ç¨‹åºçš„çŠ¶æ€ä¸æœåŠ¡å™¨ç«¯ä¿æŒä¸€è‡´ã€‚

åœ¨ä¼ ç»Ÿçš„ SSR è¿‡ç¨‹ä¸­ï¼ŒæœåŠ¡å™¨ç«¯ä¼šæ¸²æŸ“å‡º HTML å­—ç¬¦ä¸²ï¼Œå¹¶å°†å…¶å‘é€ç»™å®¢æˆ·ç«¯ã€‚ç„¶åï¼Œå®¢æˆ·ç«¯çš„ JavaScript ä»£ç ä¼šæ¥ç®¡è¿™ä¸ªå·²ç»æ¸²æŸ“å¥½çš„é¡µé¢ï¼Œå¹¶å¯¹å…¶è¿›è¡Œäº¤äº’å¤„ç†ã€‚ä½†æ˜¯ï¼Œåœ¨å®¢æˆ·ç«¯æ¥ç®¡é¡µé¢ä¹‹å‰ï¼Œç”¨æˆ·å¯èƒ½ä¼šçœ‹åˆ°ä¸€ä¸ªç©ºç™½å±å¹•æˆ–è€…ä¸å®Œå…¨æ¸²æŸ“çš„é¡µé¢ï¼Œè¿™è¢«ç§°ä¸ºâ€œé—ªçƒâ€ç°è±¡ã€‚

`hydrate`Â æ–¹æ³•å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚å®ƒå…è®¸åœ¨æœåŠ¡å™¨ç«¯æ¸²æŸ“çš„ HTML ä¸­æ’å…¥ä¸€äº›ç‰¹æ®Šçš„æ³¨é‡Šï¼ˆç§°ä¸ºâ€œhydration markersâ€ï¼‰ï¼Œè¿™äº›æ³¨é‡ŠåŒ…å«äº†å®¢æˆ·ç«¯ JavaScript éœ€è¦çš„ä¸€äº›ä¿¡æ¯ï¼Œä¾‹å¦‚åº”ç”¨ç¨‹åºçš„çŠ¶æ€ã€ç»„ä»¶çš„ç±»å‹ç­‰ç­‰ã€‚å½“å®¢æˆ·ç«¯åŠ è½½é¡µé¢æ—¶ï¼Œå®ƒä¼šæŸ¥æ‰¾è¿™äº›æ³¨é‡Šï¼Œå¹¶ä½¿ç”¨è¿™äº›ä¿¡æ¯æ¥æ¢å¤åº”ç”¨ç¨‹åºçš„çŠ¶æ€ï¼Œä»è€Œå¿«é€Ÿæ¥ç®¡é¡µé¢ï¼Œå¹¶å‡å°‘â€œé—ªçƒâ€ç°è±¡ã€‚

ä½¿ç”¨Â `hydrate`ï¼ˆæ°´åˆï¼‰Â æ–¹æ³•ï¼Œå¯ä»¥ä½¿ SSR çš„åº”ç”¨ç¨‹åºæ›´åŠ æµç•…åœ°è¿‡æ¸¡åˆ°å®¢æˆ·ç«¯ï¼Œæé«˜ç”¨æˆ·ä½“éªŒã€‚

### ä½¿ç”¨æ–¹å¼

1. æ¥æ”¶æœåŠ¡ç«¯è¿‡æ¥çš„ html

æˆ‘ä»¬å‡è®¾ä¸€æ®µæœåŠ¡ç«¯è¿‡æ¥çš„ä»£ç ï¼š

```html
<!--
  HTML content inside <div id="root">...</div>
  was generated from App by react-dom/server.
-->
<div id="root"><h1>Hello, world!</h1><button>You clicked me <!-- -->0<!-- --> times</button></div>
```

å¯ä»¥çœ‹åˆ°ï¼Œæœ‰ä¸ª id å«åš root çš„æ ¹å…ƒç´ ï¼Œæˆ‘ä»¬å°±åœ¨å…¥å£æ–‡ä»¶ä¸­æ¸²æŸ“ï¼š

```js
import { hydrateRoot } from 'react-dom/client';
import App from './App.js';

hydrateRoot(
  document.getElementById('root'),
  <App />
);
```

è¿™é‡Œ App è¿™ä¸ªç»„ä»¶åœ¨ æœåŠ¡ç«¯è¿”å›çš„ html ä¸­å°±æœ‰æ¸²æŸ“å¥½çš„ç‰ˆæœ¬ï¼ŒReact ä¼šæ ¹æ®ä¼ è¿›æ¥çš„ç¬¬äºŒä¸ªå‚æ•°ï¼ˆAppæºç ï¼‰é‡æ„æ¸²æŸ“æ ‘è¿›è¡Œæ¸²æŸ“ã€‚

2. å¤„ç†æ°´åˆæ—¶çš„å·®å¼‚é”™è¯¯

å¦‚æœå•ä¸ªå…ƒç´ çš„å±æ€§æˆ–æ–‡æœ¬å†…å®¹åœ¨æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯ä¹‹é—´ä¸å¯é¿å…åœ°å­˜åœ¨å·®å¼‚ï¼ˆä¾‹å¦‚æ—¶é—´æˆ³ï¼‰ï¼Œæ‚¨å¯ä»¥ç¦æ­¢æ°´åˆä¸åŒ¹é…çš„è­¦å‘Šã€‚è¦ç¦æ­¢æŸä¸ªå…ƒç´ çš„æ°´åˆè­¦å‘Šï¼Œè¯·æ·»åŠ  `suppressHydrationWarning={true}`ï¼š

```js
hydrateRoot(document.getElementById('root'), <App />);
```

3. åŒºåˆ†æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯çš„ä¸åŒ

å¦‚æœä½ ç¡®å®éœ€è¦åœ¨å®¢æˆ·ç«¯æ¸²æŸ“ä¸€äº›ä¸æœåŠ¡ç«¯ä¸åŒçš„ä¸œè¥¿ã€‚ å¯ä»¥åœ¨å®¢æˆ·ç«¯é‡Œè¿™æ ·å†™ï¼š

```js
export default function App() {
  const [isClient, setIsClient] = useState(false);

  useEffect(() => {
    setIsClient(true);
  }, []);

  return (
    <h1>
      {isClient ? 'Is Client' : 'Is Server'}
    </h1>
  );
}
```

è¿™æ ·ï¼Œåœ¨æ°´åˆçš„è¿‡ç¨‹ä¸­ï¼Œå°±ä¼šé’ˆå¯¹æ€§çš„æ¸²æŸ“äº†ã€‚è¿™ç§æ–¹å¼å°±æ˜¯è¯´å¯ä»¥åœ¨ SSR çš„åŸºç¡€ä¸Šï¼Œå®¢æˆ·ç«¯å†å¢é‡æ›´æ–°åªéœ€è¦å®¢æˆ·ç«¯æ¸²æŸ“çš„å†…å®¹ï¼Œæ¯”å¦‚ä¸Šé¢æåˆ°çš„è®¡æ•°å™¨ç­‰ã€‚59:T1a16,## 1. createPortal

createPortal ç”¨äºæ‰‹åŠ¨æ¸²æŸ“åŠ¨æ€ç»„ä»¶ã€‚

### æ¥å—å‚æ•°

-   `children`: ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªå¯ä»¥è¢« render çš„ React DOM.
-   `domNode`: ç¬¬äºŒä¸ªå‚æ•°æ˜¯ä¸€ä¸ªçœŸå®çš„ DOM èŠ‚ç‚¹ï¼Œç”¨äºå½“åšæ¸²æŸ“çš„çˆ¶å®¹å™¨.
-   å¯é€‰é¡¹ `key`: ç¬¬ä¸‰ä¸ªå‚æ•°å¯é€‰ï¼Œä½œä¸ºåŠ¨æ€ç»„ä»¶çš„ key.

### è¿”å›å€¼

`createPortal`è¿”å›ä¸€ä¸ª React node. åœ¨æ¸²æŸ“æ—¶ï¼ŒReact ä¼šå°†æŒ‡å®šçš„æ¸²æŸ“ç»„ä»¶æ”¾ç½®åœ¨æŒ‡å®šçš„ DOM å®¹å™¨ï¼ˆdomNodeï¼‰å†…ã€‚

### æ³¨æ„äº‹é¡¹

-   ä½¿ç”¨ createPortal æ˜¯ä¼šäº‹ä»¶å†’æ³¡çš„. ä¸¾ä¸ªä¾‹å­ï¼Œå¦‚æœä½ åœ¨ portal å†…éƒ¨ç‚¹å‡»é¼ æ ‡, è¿™ä¸ª portal åˆè¢« `<div onClick>` åŒ…è£¹, åˆ™ `onClick` äº‹ä»¶ä¹Ÿä¼šè¢«è§¦å‘. 

### ä½¿ç”¨æ¡ˆä¾‹

1. å¾€åˆ«çš„ div é‡Œæ¸²æŸ“ä¸€ä¸ªç»„ä»¶

```jsx
export default function MyComponent() {
  return (
    <div style={{ border: '2px solid black' }}>
      <p>This child is placed in the parent div.</p>
      {createPortal(
        <p>This child is placed in the document body.</p>,
        document.body
      )}
    </div>
  );
}
```
çœ‹çœ‹ç•Œé¢ï¼Œç¡®å®æ¸²æŸ“åœ¨ body ä¸‹ï¼ŒåŸæ¥çš„ä½ç½®ç©ºç©ºå¦‚ä¹Ÿï¼š


![image.png](/img/posts/2023-9-15/2023-9-15-1.png)

2. å®ç°ä¸€ä¸ªå¼¹çª—

å¦‚æœä½ å†™è¿‡ UI åº“ï¼Œä¸Šé¢çš„ DOM ç»“æ„ä½ å¯èƒ½ä¼šæ¯”è¾ƒç†Ÿæ‚‰ï¼Œè¿™å°±æ˜¯å¼¹å‡ºå±‚ç»„ä»¶å¸¸ç”¨çš„æ’å…¥æ–¹å¼ã€‚æˆ‘ä»¬å°±ç”¨ä¸Šé¢çš„åŸç†ï¼Œå®ç°ä¸€ä¸ªç®€å•çš„å¼¹çª—ï¼Œ

```js
export default function PortalExample() {
  const [showModal, setShowModal] = useState(false);
  return (
    <>
      <button onClick={() => setShowModal(true)}>
        Show modal using a portal
      </button>
      {showModal && createPortal(
        <ModalContent onClose={() => setShowModal(false)} />,
        document.body
      )}
    </>
  );
}
```
å¦‚æœä¸ä½¿ç”¨ createPortalï¼Œåœ¨ showModal æ—¶ï¼ŒModalContent ç»„ä»¶ä¼šè¿½åŠ åœ¨æŒ‰é’®ä¸‹é¢ï¼Œå¦‚æœè®¾ç½®äº†ç»å¯¹å®šä½åï¼Œä¹Ÿåªæ˜¯é’ˆå¯¹ä¸Šä¸€çº§ç»„ä»¶çš„åç§»ï¼Œè€Œå¼¹çª—ç†åº”æ˜¯ä¸ªå…¨å±€æ€§çš„ç»„ä»¶ã€‚æˆ‘ä»¬çœ‹çœ‹è¿è¡Œæ•ˆæœï¼š


![image.png](/img/posts/2023-9-15/2023-9-15-2.png)


3. æœåŠ¡ç«¯æ¸²æŸ“æ—¶ï¼Œå¾€ç‹¬ç«‹çš„ html ä¸­æ¸²æŸ“

æœåŠ¡ç«¯æ¸²æŸ“æ—¶ï¼Œä¼šå­˜åœ¨è„±ç¦» React ç¯å¢ƒçš„é¡µé¢ (æ¯”å¦‚ React root åªä½œä¸º web é¡¹ç›®çš„ä¸€éƒ¨åˆ†æ—¶)ï¼Œä½¿ç”¨è¿™ä¸ªæ–¹æ³•å°±å¯ä»¥å®ç°æ¸²æŸ“ï¼š

```js
const sidebarContentEl = document.getElementById('sidebar-content');

...
<>
  <MainContent />
  {createPortal(
    <SidebarContent />,
    sidebarContentEl
  )}
</>
```

4. **å°†åªæ”¯æŒ js å¼•å…¥æ–¹å¼çš„ç¬¬ä¸‰æ–¹åº“æ¸²æŸ“ä¸º React ç»„ä»¶**

æœ‰çš„ç¬¬ä¸‰æ–¹åº“åªæä¾›äº† js å¼•å…¥æ–¹å¼ï¼Œæ¯”å¦‚ åœ°å›¾ç»„ä»¶ leafletï¼š

```js
// map-widget.js
import 'leaflet/dist/leaflet.css';
import * as L from 'leaflet';

export function createMapWidget(containerDomNode) {
  const map = L.map(containerDomNode);
  map.setView([0, 0], 0);
  L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: 'Â© OpenStreetMap'
  }).addTo(map);
  return map;
}

export function addPopupToMapWidget(map) {
  const popupDiv = document.createElement('div');
  L.popup()
    .setLatLng([0, 0])
    .setContent(popupDiv)
    .openOn(map);
  return popupDiv;
}
```

ä¸Šé¢çš„ä¸¤ä¸ªå‡½æ•°éƒ½ä¸æ˜¯ç»„ä»¶ï¼Œæˆ‘ä»¬ä¸èƒ½åœ¨Reactç»„ä»¶ä¸­ç›´æ¥å¼•ç”¨ã€‚

çœ‹ä¸‹é¢çš„å¤„ç†ï¼š

```js
import { useRef, useEffect, useState } from 'react';
import { createPortal } from 'react-dom';
import { createMapWidget, addPopupToMapWidget } from './map-widget.js';

export default function Map() {
  const containerRef = useRef(null);
  const mapRef = useRef(null);
  const [popupContainer, setPopupContainer] = useState(null);

  useEffect(() => {
    if (mapRef.current === null) {
      const map = createMapWidget(containerRef.current);
      mapRef.current = map;
      const popupDiv = addPopupToMapWidget(map);
      setPopupContainer(popupDiv);
    }
  }, []);

  return (
    <div style={{ width: 250, height: 250 }} ref={containerRef}>
      {popupContainer !== null && createPortal(
        <p>Hello from React!</p>,
        popupContainer
      )}
    </div>
  );
}
```

ä¸Šé¢çš„ä»£ç ï¼Œä½¿ç”¨ React çŠ¶æ€ popupContainer æ¥å—äº†åœ°å›¾è¿”å›çš„å®¹å™¨ divï¼Œå¹¶åŒ…è£¹åœ¨ç»„ä»¶ Map ä¸­è¿”å›ã€‚å¦‚æ­¤ï¼Œè¿™ä¸ªç»„ä»¶å°±å¯ä»¥è¢«å¤–éƒ¨ç»„ä»¶è°ƒç”¨äº†ã€‚

## 2. flushSync

flushSync ç”¨äºå¼ºåˆ¶åˆ·æ–° React æ‰€æœ‰å·²ç»æŒ‚èµ·çš„æ¸²æŸ“å·¥ä½œï¼Œå¹¶åŒæ­¥æ›´æ–°ç»„ä»¶æ ‘ã€‚

åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼ŒReact ä½¿ç”¨å¼‚æ­¥æ›´æ–°ç­–ç•¥ï¼Œè¿™æ„å‘³ç€åœ¨è°ƒç”¨ `setState` æˆ– `forceUpdate` ç­‰æ›´æ–°æ–¹æ³•åï¼ŒReact å°†åœ¨äº‹ä»¶å¾ªç¯çš„å½“å‰è¿­ä»£ä¸­æ‰¹é‡æ›´æ–°ç»„ä»¶ï¼Œè€Œä¸æ˜¯ç«‹å³æ›´æ–°ï¼ˆå¯ä»¥äº†è§£ä¸€ä¸‹ fiber çš„è°ƒåº¦åŸç†ï¼‰ã€‚è¿™ç§å¼‚æ­¥æ›´æ–°ç­–ç•¥å¯ä»¥æé«˜æ€§èƒ½ï¼Œä½†æœ‰æ—¶å€™æˆ‘ä»¬éœ€è¦ç«‹å³æ›´æ–°ç»„ä»¶ï¼Œè¿™å°±æ˜¯ `flushSync` çš„ç”¨é€”ã€‚

`flushSync` æ–¹æ³•å¯ä»¥å¼ºåˆ¶ React ç«‹å³æ‰§è¡Œå½“å‰æ‰¹æ¬¡çš„æ‰€æœ‰æ›´æ–°ï¼Œè€Œä¸æ˜¯ç­‰å¾…äº‹ä»¶å¾ªç¯çš„ä¸‹ä¸€ä¸ªè¿­ä»£ã€‚

> æ»¥ç”¨ä¼šæŸå®³æ€§èƒ½ï¼Œæœ€å¥½ä¸ç”¨ã€‚

### æ¥å—å‚æ•°

-   `callback`: æ¥å—ä¸€ä¸ªå‡½æ•°ã€‚ä¼šç«‹å³è¢«è°ƒç”¨ï¼Œå¹¶åˆ·æ–°çŠ¶æ€ã€‚åŒæ—¶ä¹Ÿä¼šåˆ·æ–°é˜»å¡çš„æ›´æ–°ä»»åŠ¡ã€å‰¯ä½œç”¨ç­‰ã€‚

### æ³¨æ„äº‹é¡¹

-   `flushSync`Â ä¼šæ˜¾è‘—å½±å“æ€§èƒ½.
-   `flushSync`Â å¯èƒ½å¼ºåˆ¶é˜»å¡ Suspense ç»„ä»¶ï¼Œä»¥è‡³äº fallback æ— æ³•æ˜¾ç¤º.

### ä½¿ç”¨æ¡ˆä¾‹

1. åŒä¸€å‘¨æœŸå†…æ¸²æŸ“çš„é—®é¢˜

æœ‰æ—¶å€™æƒ³è¦åœ¨åŒä¸€ä¸ªæ¸²æŸ“å‘¨æœŸå†…è·å–åˆ°æœ€æ–°çš„ state çš„å€¼ï¼Œæ¯”å¦‚ä¸‹é¢çš„æ‰“å°æœºçš„ä¾‹å­ï¼š

```js
import { useState, useEffect } from 'react';

export default function PrintApp() {
  const [isPrinting, setIsPrinting] = useState(false);

  useEffect(() => {
    function handleBeforePrint() {
      setIsPrinting(true);
    }

    function handleAfterPrint() {
      setIsPrinting(false);
    }

    window.addEventListener('beforeprint', handleBeforePrint);
    window.addEventListener('afterprint', handleAfterPrint);
    return () => {
      window.removeEventListener('beforeprint', handleBeforePrint);
      window.removeEventListener('afterprint', handleAfterPrint);
    }
  }, []);

  return (
    <>
      <h1>isPrinting: {isPrinting ? 'yes' : 'no'}</h1>
      <button onClick={() => window.print()}>
        Print
      </button>
    </>
  );
}
```
beforeprint äº‹ä»¶åœ¨è°ƒç”¨æ‰“å°é¡µé¢æ—¶ä¼šè¢«ç«‹å³è°ƒç”¨ï¼Œä½†æ˜¯ä½ ä¼šå‘ç°ï¼Œåœ¨ç•Œé¢ä¸Šï¼ŒisPrinting å´æ˜¯ noã€‚è¿™æ˜¯å› ä¸ºæ›´æ–° state çš„ä»»åŠ¡æ”¾å…¥é˜Ÿåˆ—åï¼Œæ‰“å°å¼¹çª—æ‰“å¼€äº†ï¼Œé˜»å¡äº†ä»»åŠ¡ã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦å¼ºåˆ¶æ¸²æŸ“ï¼š

```js
function handleAfterPrint() {
  flushSync(() => {
    setIsPrinting(false);
  })
}
```

è¿™æ ·ï¼Œå°±ä¼šåœ¨æ‰“å°å¼¹çª—æ‰“å¼€çš„åŒæ—¶ï¼ŒåŒæ­¥æ¸²æŸ“ UI äº†ã€‚

----

åˆ°è¿™é‡Œï¼Œå¸¸è§„çš„ API å°±ä»‹ç»å®Œäº†ï¼Œä¹‹åçš„ç³»åˆ—æ–‡ç« å°±å¼€å§‹ä»‹ç»å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯æ¸²æŸ“çš„ç›¸å…³APIäº†ï¼Œæ•¬è¯·æœŸå¾…~~5a:T1a9d,å®˜ç½‘åœ°å€ï¼š[React](https://react.dev/)

## 1. memo

ç»„ä»¶çº§åˆ«çš„ç¼“å­˜å‡½æ•°ï¼Œä½¿ç”¨å®ƒåŒ…è£¹çš„ç»„ä»¶ç»„æˆçš„æ–°ç»„ä»¶å¯ä»¥åœ¨ props æ²¡æœ‰å˜åŒ–æ—¶é˜»æ­¢é‡æ¸²æŸ“ï¼Œä»è€Œæé«˜æ€§èƒ½ã€‚ç±»ä¼¼äºVueçš„ keepAliveã€‚

### æ¥å—å‚æ•°

- æ¥å—ä¸€ä¸ª react ç»„ä»¶ã€‚`memo` ä¸ä¼šæ”¹å˜è¿™ä¸ªç»„ä»¶æœ¬èº«çš„å±æ€§ï¼Œä»»ä½•æœ‰æ•ˆçš„ React ç»„ä»¶ï¼ŒåŒ…æ‹¬å‡½æ•°å’Œ `forwardRef` ç»„ä»¶ï¼Œéƒ½å¯ä»¥è¢«æ¥å—ã€‚
- ç¬¬äºŒä¸ªå‚æ•°æ˜¯å¯é€‰å‚æ•°ï¼šç»„ä»¶ä»¥å‰çš„ props å’Œå®ƒçš„æ–° propsã€‚

### è¿”å›å€¼

`memo` è¿”å›ä¸€ä¸ªæ–°çš„ React ç»„ä»¶ã€‚å®ƒçš„è¡Œä¸ºä¸æä¾›ç»™çš„ç»„ä»¶ç›¸åŒï¼Œåªæ˜¯ React ä¸ä¼šæ€»æ˜¯åœ¨å…¶çˆ¶çº§è¢«é‡æ–°æ¸²æŸ“æ—¶æ‰§è¡Œé‡æ–°æ¸²æŸ“ï¼Œé™¤éå®ƒçš„ props å‘ç”Ÿäº†å˜åŒ–ï¼ˆObject.is æ¯”è¾ƒï¼‰ã€‚

### æ³¨æ„äº‹é¡¹

**memo ä¸æ˜¯ä¸‡èƒ½çš„ï¼š**

1.  å½“ä¸€ä¸ªç»„ä»¶åœ¨åŒ…è£…å…¶ä»–ç»„ä»¶æ—¶ï¼Œè®©å®ƒæ¥å— JSX ä½œä¸ºå­ç»„ä»¶ã€‚è¿™æ ·ï¼Œå½“çˆ¶ç»„ä»¶æ›´æ–°è‡ªå·±çš„çŠ¶æ€æ—¶ï¼Œéœ€è¦è®© React çŸ¥é“å®ƒçš„å­ç»„ä»¶æ˜¯å¦ä¸éœ€è¦é‡æ–°æ¸²æŸ“æ—¶ï¼Œä½ æ‰è¦è€ƒè™‘ä½¿ç”¨ memoã€‚
2. æ›´æ¨èä½¿ç”¨ç»„ä»¶çº§åˆ«çš„ stateï¼Œè€Œä¸è¦æŠŠæ‰€æœ‰çŠ¶æ€éƒ½ç»´æŠ¤åœ¨é¡¶çº§ç»„ä»¶ï¼Œå†å¤§é‡ä½¿ç”¨ memo æ¥æŒ½å›æ€§èƒ½ã€‚
3. ä¿æŒç»„ä»¶çš„çº¯å‡€æ€§ã€‚å¦‚æœä½ çš„ç»„ä»¶å¤šæ¬¡æ¸²æŸ“è¿”å›çš„ä¸åŒçš„çŠ¶æ€ï¼Œä½ åº”è¯¥è®¸ä¿®å¤ä½ ç»„ä»¶çš„ bugï¼Œè€Œä¸æ˜¯åŠ ä¸€ä¸ª memoã€‚
4. é¿å…ä¸å¿…è¦çš„çŠ¶æ€æ›´æ–°ï¼Œè¿™äº›æ›´æ–°æœ‰æ—¶å€™ä¼šé€ æˆå­ç»„ä»¶åå¤æ¸²æŸ“ã€‚
5. åˆ é™¤ useEffect ä¸­ä¸å¿…è¦çš„ä¾èµ–é¡¹ï¼Œä»–æœ‰æ—¶å€™ä¹Ÿä¼šé€ æˆè¿‡å¤šçš„æ¸²æŸ“ã€‚
6. props å¦‚æœæ˜¯å‡½æ•°ï¼Œçˆ¶ç»„ä»¶åº”å°†è¯¥å‡½æ•°ç¼“å­˜ï¼ˆuseCallbackç­‰ï¼‰ï¼Œå¦åˆ™çˆ¶ç»„ä»¶æ¸²æŸ“ï¼Œè¯¥å‡½æ•°å¼•ç”¨ä¼šå˜åŒ–ï¼Œå¯¼è‡´å­ç»„ä»¶çš„ memo å¤±æ•ˆã€‚

### ä½¿ç”¨æ¡ˆä¾‹

1. éƒ¨åˆ†å±æ€§å˜åŒ–æ›´æ–°ç»„ä»¶

React ç»„ä»¶éƒ½æ˜¯çº¯å‡½æ•°ï¼Œæˆ–è€…è¯´åº”è¯¥æ˜¯çº¯å‡½æ•°ï¼Œæ‰€ä»¥å¯ä»¥è®¤ä¸º props æ²¡æœ‰å˜åŒ–çš„æ—¶å€™ï¼Œå…¶è¾“å‡ºä¹Ÿä¸åº”è¯¥å˜åŒ–ã€‚è¿™å°±æ˜¯ memo èƒ½å¤Ÿç¼“å­˜è€Œä¸é€ æˆé”™ä¹±çš„ç†è®ºåŸºç¡€ã€‚ 

ä¸‹é¢çš„ä¾‹å­ï¼Œåªè¦å…¥å‚ name æ²¡æœ‰å˜åŒ–ï¼ŒGreeting ç»„ä»¶å†…éƒ¨æ˜¯ä¸ä¼šé‡æ–°æ¸²æŸ“çš„ã€‚

```js
const Greeting = memo(function Greeting({ name }) {
  return <h1>Hello, {name}!</h1>;
});

export default Greeting;

// å…¶ä»–ç»„ä»¶å¼•ç”¨
<Greeting name={name} />
```

2. ä¸ context ç»“åˆçš„ç¼“å­˜

ä¸‹é¢çš„ä¾‹å­ï¼Œå­ç»„ä»¶ Greeting æ˜¯ä¸€ä¸ªä½¿ç”¨äº†memåŒ…è£¹çš„ç»„ä»¶ï¼Œä½†æ˜¯å½“çˆ¶ç»„ä»¶å±æ€§ theme å˜åŒ–æ—¶ï¼Œè¿˜æ˜¯ä¼šå¼•èµ·å­ç»„ä»¶é‡æ¸²æŸ“ã€‚ 

```js
export default function MyApp() {
  const [theme, setTheme] = useState('dark');

  function handleClick() {
    setTheme(theme === 'dark' ? 'light' : 'dark'); 
  }

  return (
    <ThemeContext.Provider value={theme}>
      <button onClick={handleClick}>
        Switch theme
      </button>
      <Greeting name="Taylor" />
    </ThemeContext.Provider>
  );
}
```
è‹¥è¦ä½¿ç»„ä»¶ä»…åœ¨æŸäº› context å±æ€§æ”¹å˜æ—¶é‡æ–°æ¸²æŸ“ï¼Œè¯·å°†ç»„ä»¶ä¸€åˆ†ä¸ºäºŒã€‚ä»å¤–éƒ¨ç»„ä»¶çš„ context ä¸­è¯»å–æ‚¨éœ€è¦çš„å†…å®¹ï¼Œå¹¶å°†å…¶ä½œä¸º props ä¼ é€’ç»™è®°å¿†çš„å­ç»„ä»¶ã€‚

3. ç»„ä»¶è§„èŒƒï¼šå°½é‡å‡å°‘ç»„ä»¶æˆå‘˜çš„åå¤å˜åŒ–

React çš„é‡æ¸²æŸ“åˆ¤æ–­éƒ½æ˜¯ä½¿ç”¨ Object.is æ¥åˆ¤æ–­çš„ï¼Œä½†æ˜¯ `Object.is({}, {})` å¯æ˜¯ä¼šè¿”å› false çš„ã€‚æ‰€ä»¥ç»„ä»¶çš„äººæˆå‘˜æ–¹æ³•åº”è¯¥åšå¿…è¦çš„ç¼“å­˜ï¼Œè®©ç»„ä»¶åœ¨é‡æ¸²æŸ“æ—¶è¿™ä¸ªæ–¹æ³•è¿˜èƒ½ä¿æŒè¿‡å»çš„å†…å­˜å¼•ç”¨ã€‚

```js
function Page() {
  const [name, setName] = useState('Taylor');
  const [age, setAge] = useState(42);

  const person = useMemo(
    () => ({ name, age }),
    [name, age]
  );

  return <Profile person={person} />;
}

const Profile = memo(function Profile({ person }) {
  // ...
});
```
ä¸Šé¢çš„ä¾‹å­ï¼Œperson è¢«ç¼“å­˜äº†ï¼Œå½“Pageç»„ä»¶é‡æ¸²æŸ“æ—¶ï¼Œä¸ä¼šå› ä¸º person çš„å†…å­˜å¼•ç”¨å˜åŒ–äº†è€Œå¯¼è‡´ Profile ä¸å¿…è¦çš„æ¸²æŸ“ã€‚

4. ä½¿ç”¨ç¬¬äºŒä¸ªå‚æ•°æ¥æ¯”å¯¹ props

æˆ‘ä»¬å†™ä¸ªè‡ªå®šä¹‰çš„å‡½æ•°æ¥æ¯”å¯¹ propsï¼Œä»è€Œå†³å®šæ˜¯å¦è¦é‡æ¸²æŸ“ã€‚æ­¤å‡½æ•°ä½œä¸ºç¬¬äºŒä¸ªå‚æ•°ä¼ é€’ç»™å­ç»„ä»¶ã€‚ä»…å½“è¿”å› true æ—¶ä¸åšé‡æ¸²æŸ“ï¼Œå¦åˆ™å°±è¿›è¡Œé‡æ¸²æŸ“ã€‚

```js
const Chart = memo(function Chart({ dataPoints }) {
  // ...
}, arePropsEqual);

function arePropsEqual(oldProps, newProps) {
  return (
    oldProps.dataPoints.length === newProps.dataPoints.length &&
    oldProps.dataPoints.every((oldPoint, index) => {
      const newPoint = newProps.dataPoints[index];
      return oldPoint.x === newPoint.x && oldPoint.y === newPoint.y;
    })
  );
}
```
å½“ç”¨åˆ°è‡ªå®šä¹‰å‡½æ•°æ—¶ï¼Œä¸€å®šè¦æµ‹è¯•ä¸€ä¸‹æ˜¯å¦æ€§èƒ½æ¯”é»˜è®¤çš„æ¯”å¯¹æ–¹å¼æ›´å¥½ã€‚è¿™é‡Œè¾¹å‘æ¯”è¾ƒå¤šï¼Œå°½é‡é¿å…æ·±åº¦æ£€æŸ¥ï¼Œ**æ·±åº¦ç›¸ç­‰æ€§æ£€æŸ¥å¯èƒ½ä¼šä½¿ç»„ä»¶å˜å¾—éå¸¸æ…¢**ã€‚

## 2. forwardRef

forwardRef ä½¿ç»„ä»¶å‘çˆ¶ç»„ä»¶æš´éœ²å‡ºè‡ªå·±çš„ DOM ç»“æ„ã€‚

### æ¥æ”¶å‚æ•°

-  å‡½æ•°å¼ç»„ä»¶ã€‚React ä¼šåœ¨çˆ¶ç»„ä»¶ä¸­å¸¦ç€ props å’Œ ref è°ƒç”¨è¿™ä¸ªå‡½æ•°ã€‚

### è¿”å›å€¼

- `forwardRef` è¿”å›åŸå‡½æ•°å¼ç»„ä»¶ï¼Œä¸è¿‡ä¼šåœ¨ props ä¸­å¸¦å…¥ ref ä¿¡æ¯ã€‚

### ä½¿ç”¨æ¡ˆä¾‹

1. çˆ¶ç»„ä»¶è·å–å­ç»„ä»¶ DOM å®ä¾‹

```js
// å­ç»„ä»¶
const MyInput = forwardRef(function MyInput(props, ref) {
  const { label, ...otherProps } = props;
  return (
    <label>
      {label}
      <input {...otherProps} ref={ref} />
    </label>
  );
});

// çˆ¶ç»„ä»¶
function Form() {
  const ref = useRef(null);

  function handleClick() {
    ref.current.focus();
  }

  return (
    <form>
      <MyInput label="Enter your name:" ref={ref} />
      <button type="button" onClick={handleClick}>
        Edit
      </button>
    </form>
  );
}
```
ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œå­ç»„ä»¶å°† ref æ‰“åœ¨ input æ ‡ç­¾ä¸­ï¼Œå¹¶æš´éœ²å‡ºå»ï¼›çˆ¶ç»„ä»¶ä¸­ï¼ŒåŒæ ·ä½¿ç”¨ ref å±æ€§æ¥å—ã€‚`useRef` çš„ä½¿ç”¨ï¼Œå¯ä»¥å‚çœ‹ä¹‹å‰çš„æ–‡ç« ï¼š[useRef](https://juejin.cn/post/7249607108044357690#heading-14)

> ä½¿ç”¨ forwardRef å°±ç›¸å½“äº ref é€ä¼ ã€‚çˆ¶ç»„ä»¶ä¸­çš„ useRef ç›´æ¥æ‰“åœ¨å­ç»„ä»¶ä¸­çš„ input

2. æ’­æ”¾å™¨æ§åˆ¶

ä¸Šé¢æ˜¯æ§åˆ¶æ–‡æœ¬æ¡†èšç„¦ï¼Œä¸‹é¢æ˜¯å¦å¤–çš„ H5 API çš„è°ƒç”¨ä¾‹å­ï¼Œçˆ¶ç»„ä»¶ä¸­æ§åˆ¶æ’­æ”¾å™¨ï¼š

```js
// å­ç»„ä»¶
<video width={width} ref={ref}>
  <source
    src={src}
    type={type}
  />
</video>

// çˆ¶ç»„ä»¶
<button onClick={() => ref.current.play()}>
    Play
</button>
```

3. æš´éœ²å­ç»„ä»¶æˆå‘˜æ–¹æ³•

useImperativeHandle çš„ä½¿ç”¨å¯ä»¥å‚è§ [useImperativeHandle](https://juejin.cn/post/7249607108044357690#heading-21)

```js
const MyInput = forwardRef(function MyInput(props, ref) {
  const inputRef = useRef(null);

  useImperativeHandle(ref, () => {
    return {
      focus() {
        inputRef.current.focus();
      },
      scrollIntoView() {
        inputRef.current.scrollIntoView();
      },
      handleClick() {
        handleClick();
      }
    };
  }, []);
  
  function handleClick() {
    // è‡ªå®šä¹‰çš„æˆå‘˜æ–¹æ³•
    alert('click');
  }

  return <input {...props} ref={inputRef} />;
});
```
è¿™æ ·åœ¨çˆ¶ç»„ä»¶ä¸­å°±å¯ä»¥è¿™æ ·è°ƒç”¨äº†ï¼š`ref.current.scrollIntoView();`


----
å®Œ ï¼ï¼5b:T1449,å®˜ç½‘åœ°å€ï¼š[React](https://react.dev/)

## 1. startTransition

æˆ‘ä»¬åœ¨è®² [useTransition](https://juejin.cn/post/7268530145202700303) çš„ä¸€èŠ‚æˆ‘ä»¬è®²è¿‡ï¼Œé€šè¿‡ hook å¯ä»¥è·å–åˆ°è¿™ä¸ª APIï¼Œæ¨èç»“åˆ hook ä¸€èµ·ä½¿ç”¨ã€‚

å½“ç„¶ä¹Ÿå¯ä»¥ç›´æ¥å¼•å…¥ï¼š

```js
import { startTransition } from 'react';

function TabContainer() {
  const [tab, setTab] = useState('about');

  function selectTab(nextTab) {
    startTransition(() => {
      setTab(nextTab);
    });
  }
  // ...
}
```
ä»–çš„ä½œç”¨æ˜¯é˜²æ­¢ UI é˜»å¡ï¼Œåšåˆ°å‰ç«¯å¼‚æ­¥éé˜»å¡æ¸²æŸ“ã€‚å…·ä½“ä½¿ç”¨æ–¹å¼è§ useTransitionã€‚

### æ³¨æ„äº‹é¡¹

-  `startTransition` ä¸ä¼šè¿½è¸ªæ¸²æŸ“ pending çš„çŠ¶æ€. æƒ³è¦è·å–æ¸²æŸ“å®æ—¶çŠ¶æ€ï¼Œè¯·ä½¿ç”¨ [`useTransition`](https://juejin.cn/post/7268530145202700303) .
-  ä½¿ç”¨å®ƒåŒ…è£¹ state çš„ `set` å‡½æ•°æ¥å®ç°è·Ÿè¯¥ state ç›¸å…³çš„æ¸²æŸ“è¿‡æ¸¡ã€‚ å¦‚æœæƒ³è¦å“åº” props å˜åŒ–æ¥å®ç°æ¸²æŸ“è¿‡æ¸¡ï¼Œè¯·ä½¿ç”¨ [`useDeferredValue`](https://juejin.cn/post/7268530145202700303).
-  `startTransition` å†…éƒ¨å‡½æ•°å¿…é¡»æ˜¯åŒæ­¥çš„.
-  æ ‡è®°ä¸º transition çš„ state æ›´æ–°ä¼šè¢«å…¶ä»– state çš„æ›´æ–°æ‰“æ–­æ¸²æŸ“ï¼Œåœ¨å…¶ä»–æ¸²æŸ“è°ƒåº¦ç»“æŸåå†æ¬¡æƒ³é‡æ–°æ‰§è¡Œè¯¥æ¸²æŸ“.
-  ä¸èƒ½ç”¨äºæ§åˆ¶æ–‡æœ¬è¾“å…¥ç»„ä»¶.
-  å¦‚æœåŒæ—¶æœ‰å¤šä¸ªåœ¨è¿è¡Œçš„è¿‡æ¸¡ï¼ŒReact ä¼šæŠŠä»–ä»¬åˆå¹¶ä¸€èµ·å¤„ç†ã€‚è¿™ä¸ªæ–¹æ¡ˆä¼¼ä¹æ˜¯ä¸ªæ€§èƒ½ç¼ºé™·ï¼Œéšåçš„ç‰ˆæœ¬å¯èƒ½ä¼šä¿®å¤å®ƒã€‚

## 2. createContext

é¡¾åæ€ä¹‰ï¼Œå°±æ˜¯åˆ›å»ºä¸€ä¸ª context å¯¹è±¡ï¼Œä¸€èˆ¬ç»“åˆ hook ä¸€èµ·ä½¿ç”¨ï¼Œå¯ä»¥å‚è€ƒæˆ‘ [useContext](https://juejin.cn/post/7249607108044357690) çš„æ–‡ç« ã€‚

å®˜ç½‘çš„éƒ¨åˆ†æè¿°ä¸ useContext æœ‰é‡å¤ï¼Œè¿™é‡ŒåŠç›´æ¥è®²ä½¿ç”¨æ¡ˆä¾‹ã€‚

### ä½¿ç”¨æ¡ˆä¾‹

1. é…ç½®å…¨å±€å˜é‡

```js
// æ”¾åœ¨å…¨å±€ï¼Œåˆ›å»ºæ—¶çš„é»˜è®¤å€¼ä¸€èˆ¬å¯ä»¥ä¸ç”¨ä¼ é€’ï¼Œåœ¨ provider æ—¶ä¼šé…ç½®åˆå§‹å€¼çš„
const ThemeContext = createContext();  
const AuthContext = createContext();
```
æˆ‘ä»¬å®šä¹‰ä¸»é¢˜ä¿¡æ¯å’Œè®¤è¯ä¿¡æ¯ï¼Œç”¨å®ƒåŒ…è£¹æ ¹ç»„ä»¶ï¼š

```jsx
const [theme, setTheme] = useState('dark');
const [currentUser, setCurrentUser] = useState({ id: 1 });

<ThemeContext.Provider value={theme}>
  <AuthContext.Provider value={currentUser}>
    <Page />
  </AuthContext.Provider>
</ThemeContext.Provider>
```

åœ¨åŒ…è£¹çš„å†…éƒ¨ç»„ä»¶ä¸­ï¼Œæ— è®ºå¤šæ·±çš„å±‚çº§ï¼Œéƒ½å¯ä»¥è¿™æ ·ä½¿ç”¨æ¥è·å– value å€¼ï¼š

```js
const theme = useContext(ThemeContext); // dark
```

> ç¡®ä¿ ThemeContext æ˜¯ä¸€å¼€å§‹å®šä¹‰çš„é‚£ä¸ªå•ä¾‹

ä»–è¸¢åŠ¨äº†ä¸€ä¸ªå•å‘æ•°æ®æµï¼Œå¯ä»¥ä»é¡¶å‘ä¸‹ä¼ é€’åŠ¨æ€å“åº”å¼æ•°æ®ã€‚å¦‚æœåœ¨å…¥å£å¤„ç»´æŠ¤ä¸€äº› stateï¼Œæš´éœ²å‡ºäº‹ä»¶æ¥ç»™å„ä¸ªä¸šåŠ¡æ¨¡å—è°ƒç”¨ï¼Œå°±å¯ä»¥å®ç°ä¸€ä¸ªç±»ä¼¼ redux çš„åŠŸèƒ½ã€‚

2. å±€éƒ¨å¼•ç”¨

```js
// Button.js  
import { ThemeContext } from './Contexts.js';
```

æ¯”å¦‚ä¸Šé¢çš„ä¾‹å­ï¼Œæˆ‘ä»¬å…¨å±€é…ç½®äº†ä¸»é¢˜ä¸º darkï¼Œä½†æ˜¯æœ‰ä¸€ä¸ª Button ç»„ä»¶ï¼Œå…¶éœ€è¦ç‰¹æ®Šå¤„ç†ï¼Œå°±å¯ä»¥è¿™æ ·å†™ï¼Œåœ¨ Button å†…éƒ¨å†æ¬¡ Provider è‡ªå·±æƒ³è¦çš„ä¸»é¢˜å³å¯ï¼Œç›¸åŒçš„ context éµå¾ªå°±è¿‘åŸåˆ™ã€‚

## 3. lazy

å»¶è¿ŸåŠ è½½ç»„ä»¶çš„å·¥å…·ï¼Œå¾€å¾€ä¸ [\<Suspense>](https://juejin.cn/post/7270648629378252840#heading-4) ç»„ä»¶ä¸€èµ·ä½¿ç”¨ã€‚


ç®€å•ä½¿ç”¨ï¼š

```js
const MarkdownPreview = lazy(() => import('./MarkdownPreview.js'));
```

### æ¥å—å‚æ•°

æ¥å—ä¸€ä¸ªå‡½æ•°ï¼Œè¿”å› Promise æˆ–è€… å…¶ä»–ç±» *thenable* çš„å¼‚æ­¥å‡½æ•°ã€‚React é»˜è®¤ä¸ä¼šå»åŠ è½½ lazy åŒ…è£¹çš„ç»„ä»¶ï¼Œé™¤éæ˜ç¡®çš„åœ¨ç•Œé¢ä¸Šéœ€è¦æ¸²æŸ“ä»–ã€‚å½“å¼€å§‹åŠ è½½æ—¶ï¼ŒReact ä¼šç­‰å¾…å…¶è§£æï¼Œè§£æè¿‡ç¨‹ä¸­ç”± Suspense æä¾›è¿‡æ¸¡å“åº”ï¼Œè§£æå®Œæ¯•åå³å¯æ¸²æŸ“ã€‚è¿”å›çš„ Promise å’Œ Promise ä¸­ resolve çš„å€¼éƒ½ä¼šè¢«ç¼“å­˜ï¼ˆæ¯”å¦‚æ‰“åŒ…çš„jsæ–‡ä»¶ï¼‰ï¼Œå†æ¬¡æ¸²æŸ“å°±ä¸ä¼šé‡å¤è¯·æ±‚èµ„æºã€‚ä½†æ˜¯è¿™ä¸ªç»„ä»¶æœ¬èº«çš„é‡æ¸²æŸ“è¿˜æ˜¯ä¼šè¢«è§¦å‘ã€‚å¦‚æœè¯¥ Promise reject è¯·æ±‚ï¼Œå¼‚å¸¸ä¼šå†’æ³¡è‡³æœ€è¿‘çš„å¤„ç†å‡½æ•°ï¼ˆError Boundaryï¼‰æŠ›å‡ºã€‚

### è¿”å›å€¼

è¿”å›ä¸€ä¸ªå¯ä»¥æ¸²æŸ“åœ¨ fiber æ ‘ä¸­çš„ç»„ä»¶ã€‚

### æ³¨æ„äº‹é¡¹

- lazy è¦åœ¨ js æ¨¡å—é¡¶å±‚ä½¿ç”¨ï¼Œä¸è¦åœ¨ç»„ä»¶å†…éƒ¨ä½¿ç”¨
- 

### ä½¿ç”¨æ¡ˆä¾‹

1. åŠ¨æ€å¼•å…¥åŠ è½½

```js
const MarkdownPreview = lazy(() => import('./MarkdownPreview.js'));

<Suspense fallback={<Loading />}>
  <h2>Preview</h2>
  <MarkdownPreview />
</Suspense>
```
æ•ˆæœï¼š

åŠ è½½ä¸­ï¼š


![image.png](/img/posts/2023-9-6/2023-9-6-1.png)

åŠ è½½åï¼š

![image.png](/img/posts/2023-9-6/2023-9-6-2.png)

åŠ è½½ä¸€æ¬¡åä¾¿ä¸ä¼šå†å‡ºç° loading

2. è·¯ç”±æ‡’åŠ è½½

ä»‹ç»ä½œè€…åœ¨å·¥ä½œä¸­ç”¨è¿‡çš„ä¸€ä¸ªä½¿ç”¨ js æ•°ç»„é…ç½®è·¯ç”±æ‡’åŠ è½½çš„æ¡ˆä¾‹ï¼š

```jsx
// route.js
const Loadable = (Component) => (props) => (
    <Suspense fallback={<Loader />}>
      <Component {...props} />
    </Suspense>
);

const Home = Loadable(lazy(() => import('views/pages')));
const User = Loadable(lazy(() => import('views/pages/common/user')));

const routes = [
    {
      path: 'home',
      children: [
        {
          path: '/',
          element: <Home />
        }
      ]
    },
    {
      path: 'setting',
      children: [
        {
          path: 'user-setting',
          element: <User />
        }
      ]
    }
]

useRoutes(routes);

// ä½¿ç”¨
import Routes from 'route.js';

<Routes />
```
---

å®Œ ï¼5c:T18ef,æ–‡ç« ç»§æ‰¿è‡ª [è®°ä¸€æ¬¡å‰ç«¯åº”ç”¨éƒ¨ç½²åï¼Œåˆ·æ–°é™æ€èµ„æºä¸¢å¤±é—®é¢˜](https://juejin.cn/post/7269694294597287971) çš„æ–¹æ¡ˆï¼Œè¿™é‡Œæ¢ä¸€ç§å†™æ³•é‡æ–°é˜è¿°ï¼ŒåŠ ä¸Šä¸€äº›è‡ªå·±çš„æ€è€ƒå’Œå›¾æ–‡è§£é‡Šã€‚

## 1. åœºæ™¯é‡ç°

å‰ç«¯å®ç°ä¸€ä¸ªè·¯ç”±æ‡’åŠ è½½æ—¶ï¼Œç‚¹å‡» menu åˆ‡æ¢é¡µé¢æ—¶å‡ºç°èµ„æº 404 é—®é¢˜ï¼š

![image.png](/img/posts/2023-8-27/2023-8-27-1.png)

é¡¹ç›®ä¾‹å­å¦‚ä¸‹ï¼š

```js
const AFunction = lazy(() => import('./page/a.js'))
const BFunction = lazy(() => import('./page/b.js'))

function App() {

  return (
    <div className="App">
        <HashRouter basename="/">
          <Link style={{marginRight: 20}} to="/">Home</Link>
          <Link to="/about">About</Link>
          <Suspense fallback={<div>Loading...</div>}>
            <Routes>
              <Route path="/" element={<AFunction />}></Route>
              <Route path="/about" element={<BFunction />} />
            </Routes>
          </Suspense>
        </HashRouter>
    </div>
  );
}
```

ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œè®¿é—® `/` è·¯å¾„æ—¶ï¼Œ`BFunction` ç»„ä»¶æ˜¯ä¸ä¼šè¢«åŠ è½½çš„ï¼Œåªä¼šåŠ è½½ webpack å¯¹åº”è·¯ç”±çš„ chunkï¼š


![image.png](/img/posts/2023-8-27/2023-8-27-2.png)

åœ¨åˆ‡æ¢è·¯ç”±åˆ° `/about` æ—¶ï¼Œä¼šåŠ è½½è¿™ä¸ªè·¯ç”±å¯¹åº”çš„ chunk æ–‡ä»¶ï¼Œåå¤åˆ‡æ¢åˆ™ä¸ä¼šé‡å¤åŠ è½½ã€‚

é¡¹ç›®ä¸ä½¿ç”¨åœºæ™¯æè¿°å®Œæ¯•ï¼

## 2. é—®é¢˜åˆ†æ

ç†è®ºä¸Šï¼Œåˆ‡æ¢èµ„æºæ˜¯ä¼šå»æœåŠ¡å™¨è·å–åˆ°å¯¹åº” chunk çš„ js èµ„æºçš„ï¼Œå‡ºç° 404ï¼Œè¦ä¹ˆæ˜¯æœåŠ¡å™¨æ–‡ä»¶è¢«åˆ é™¤ï¼Œè¦ä¹ˆæ˜¯æ–‡ä»¶è¢«é‡æ–°æ‰“åŒ…ï¼Œhash å€¼è¢«æ”¹å˜äº†ã€‚

ç¬¬ä¸€ç§æƒ…å†µï¼Œèµ„æºè¢«åˆ é™¤æˆ‘ä»¬ä¸è€ƒè™‘ï¼Œä¸å¯æ§å› ç´ ï¼Œæˆ‘ä»¬è‡ªå·±ä¹Ÿä¸ä¼šæ²¡äº‹å»åˆ é™¤è¿˜åœ¨ä½¿ç”¨çš„èµ„æºçš„ã€‚ç¬¬äºŒç§æƒ…å†µå°±æœ‰å¯èƒ½äº†ï¼Œæˆ‘ä»¬æœ¬åœ°æ‰“äº†åŒ…ï¼Œæ›¿æ¢äº†èµ„æºæ–‡ä»¶ï¼Œæ˜¯ä¼šé€ æˆ hash å˜åŒ–çš„ï¼Œæ¯æ¬¡æ‰“åŒ…éƒ½ä¼šé’ˆå¯¹ä¸åŒçš„åˆ†åŒ… chunk æ‰“ä¸åŒçš„ hash å€¼ã€‚

## 3. é—®é¢˜åŸç†

çŸ¥é“é—®é¢˜åï¼Œæˆ‘ä»¬å°±æ¥çœ‹ä¸€ä¸‹æ‰“åŒ…éƒ¨ç½²æµç¨‹å‡ºç°äº†é‚£äº›çº°æ¼ã€‚

å‰ç«¯é¡¹ç›®ç®€æ˜“éƒ¨ç½²æµç¨‹å¦‚ä¸‹ï¼š

```mermaid
graph TD
CIæ‰“åŒ… --> æœåŠ¡å™¨èµ„æºæ–‡ä»¶æ›¿æ¢
æœåŠ¡å™¨èµ„æºæ–‡ä»¶æ›¿æ¢ --> æµè§ˆå™¨è·å–èµ„æº
```

![](/img/posts/2023-8-27/2023-8-27-3.png)

è€Œæ‰“åŒ…åç›®å‰åœ¨èµ„æºæœåŠ¡å™¨å­˜æ”¾ç›®å½•å¦‚ä¸‹ï¼š

```shell
â”œâ”€console-fe
â”‚  â”œâ”€bundle
â”‚  â”œâ”€static
â”‚  â”œâ”€main.sdf67hda.js
â”‚  â””â”€index.html
```

`index.html` é‡Œå¼•å…¥äº†è¯¥æ¬¡æ‰“åŒ…çš„å…¥å£æ–‡ä»¶ï¼š`main.[hash].js`ï¼Œstatic æ˜¯é™æ€èµ„æºæ–‡ä»¶å¤¹ï¼Œbundle æ˜¯æ‰“åŒ…å¥½çš„ js æ–‡ä»¶å¤¹ã€‚

ç”±äº æµè§ˆå™¨æœ‰ç¼“å­˜ï¼Œåœ¨ç”¨æˆ·å·²ç»æ¸²æŸ“å‡º index.html åä¼šäº§ç”Ÿç¼“å­˜ï¼ˆæ¯”å¦‚å…¥å£ main.28cb0dcd.jsï¼‰ï¼Œç”¨æˆ·æ™®é€šåˆ·æ–°é¡µé¢æ—¶ï¼Œæµè§ˆå™¨é»˜è®¤å»æ‹¿ç¼“å­˜çš„ å…¥å£ jsï¼Œè€Œåˆ†å‘çš„å„ä¸ª chunk è·¯å¾„æ˜¯å†™åœ¨ å…¥å£ js æ–‡ä»¶çš„ï¼Œæ‰€ä»¥å°±æ‹¿ä¸åˆ°äº†ã€‚


ç”¨æµç¨‹å›¾æè¿°å¦‚ä¸‹ï¼š

```mermaid
journey
title  å‰ç«¯èµ„æºéƒ¨ç½²ä¸ç”¨æˆ·è®¿é—®ä¸åŒæ­¥
section å‘å¸ƒé˜¶æ®µ
æ‰“åŒ…: 5: æ—§ç‰ˆæœ¬
èµ„æºæ›¿æ¢: 5: æ—§ç‰ˆæœ¬
æ›´æ–°æœåŠ¡å™¨: 3: å¯èƒ½å‡ºç°é—®é¢˜
section å‘å¸ƒå®Œæˆå
ç”¨æˆ·åˆ·æ–°é¡µé¢: 3: å¼ºåˆ·æ­£å¸¸
ç”¨æˆ·ä¸åˆ·æ–°ï¼ŒåŸåœ°ç‚¹å‡»è·¯ç”±èµ„æº: 1: ç‰ˆæœ¬ä¸¢å¤± 404
```

![](/img/posts/2023-8-27/2023-8-27-4.png)

## 4. è§£å†³æ–¹æ¡ˆ

1. å–æ¶ˆç¼“å­˜ index.html


æˆ‘ä»¬è¯•ç€ä»æœåŠ¡ç«¯æç¤ºé˜»æ­¢ index.html ç¼“å­˜ï¼š

```shell
# nginx
location ~ \.html$ { add_header Cache-Control "no-cache, no-store, must-revalidate"; }
```

å†æ¬¡éƒ¨ç½²åï¼Œå‘ç°åˆ·æ–°é¡µé¢çš„æƒ…å†µå¯ä»¥æ‹¿åˆ°æ–°çš„èµ„æºäº†ï¼Œä½†æ˜¯å¦‚æœç”¨æˆ·åœç•™åœ¨è€é¡µé¢ï¼ŒåŸåœ°ç‚¹å‡»è·¯ç”±è·³è½¬è¿˜æ˜¯ä¸è¡Œã€‚è¿™ä¸ªæƒ³æƒ³ä¹Ÿæ˜¯å¯ä»¥ç†è§£çš„ï¼Œæ²¡æœ‰åˆ·æ–°ï¼Œå…¥å£ main.js æ²¡æœ‰æ”¹å˜ï¼Œæ‰€ä»¥è¿˜éœ€è¦ç‰¹æ®Šå¤„ç†ã€‚

2. å‰åç«¯ç»Ÿä¸€ç‰ˆæœ¬å·ï¼Œè·³è½¬æ—¶æç¤ºéœ€è¦æ›´æ–°

åç«¯è¿”å›çš„ API ä¸­ä¼šå¸¦ç€çº¦å®šå¥½çš„é€‚ç”¨äºå‰ç«¯çš„ç‰ˆæœ¬å·ï¼Œè€Œå‰ç«¯æ‰“åŒ…æ—¶ä¹Ÿä¼šé€šè¿‡ CI å†™å…¥è¯¥ç‰ˆæœ¬ï¼ˆå¯ä»¥æ˜¯ reduxã€ cookie æˆ–è€… æœ¬åœ°å­˜å‚¨ç­‰ï¼‰ï¼Œåœ¨ä»»ä¸€è¯·æ±‚ API çš„åœ°æ–¹ï¼Œå‰ç«¯ç»Ÿä¸€æ‹¦æˆªæ¯”å¯¹ä¸¤ä¸ªç‰ˆæœ¬å·æ˜¯å¦ç»Ÿä¸€ï¼Œè‹¥ä¸ç»Ÿä¸€åˆ™è‡ªåŠ¨åˆ·æ–°é¡µé¢ï¼Œæµç¨‹å›¾å¦‚ä¸‹ï¼š


```mermaid
graph TD
å‰ç«¯æ‰“åŒ…å†™å…¥ç‰ˆæœ¬ --> ç”¨æˆ·ç‚¹å‡»åˆ‡æ¢è·¯ç”±æ—¶è·å–APIå®æ—¶ç‰ˆæœ¬å·
ç”¨æˆ·ç‚¹å‡»åˆ‡æ¢è·¯ç”±æ—¶è·å–APIå®æ—¶ç‰ˆæœ¬å· --> ä¸å‰ç«¯ç‰ˆæœ¬å·ä¸ç›¸åŒæ—¶æç¤ºåˆ·æ–°
```
![](/img/posts/2023-8-27/2023-8-27-5.png)

è¿™ç§æ–¹æ¡ˆå°±æ˜¯ç»å¸¸è¦æç¤ºç”¨æˆ·ï¼Œåœ¨å¤šæ¬¡å‘å¸ƒæ–°ç‰ˆæœ¬æ—¶å¯¹ç”¨æˆ·ä½“éªŒä¸å¤ªå‹å¥½ï¼Œä½†æ˜¯å¯ä»¥ä¿è¯ç”¨æˆ·å§‹ç»ˆæ‹¿åˆ°æƒ³è¦çš„ç‰ˆæœ¬ã€‚

3. æœåŠ¡å™¨æ‰“åŒ…å­˜æ”¾å†å²èµ„æº

å°±åƒæ–‡ç« å¼€å¤´å¼•ç”¨æ–‡ç« æ‰€è¯´ï¼Œèµ„æºæœåŠ¡å™¨å¯ä»¥è¿™æ ·å­˜æ”¾èµ„æºï¼š

```shell
â”€console-fe
â”‚  â”œâ”€20230101
â”‚  â”‚  â”œâ”€bundle
â”‚  â”‚  â”œâ”€static
â”‚  â”‚  â””â”€main.sdf67hda.js
â”‚  â”œâ”€20230302
â”‚  â”‚  â”œâ”€bundle
â”‚  â”‚  â”œâ”€static
â”‚  â”‚  â””â”€main.qd52s5f7.js
â”‚  â”œâ”€index.html
...
```
åœ¨éƒ¨ç½²æ—¶ï¼ŒCI æ‰“åŒ…æ—¶è®¾ç½®ä¸€ä¸ªç‰ˆæœ¬ï¼š`BUILD_PATH = "20230101"`ï¼Œåœ¨é¡¹ç›®ä¸­ï¼Œåªæœ‰ä¸€ä¸ªç»Ÿä¸€çš„ `index.html`ï¼ŒCI éƒ¨ç½²æ—¶ï¼Œåœ¨è¯¥æ–‡ä»¶å†™å…¥åˆ¶å®šç›®å½•ä¸‹çš„è„šæœ¬å…¥å£ï¼š

```js
<script src="/20230302/main.qd52s5f7.js"></script>
```
è¿™æ ·ï¼Œå°±ç®—ç”¨æˆ·ä¸åˆ·æ–°é¡µé¢ï¼Œæ–°éƒ¨ç½²çš„èµ„æºä¸ä¼šå½±å“æ—§çš„èµ„æºï¼Œåªè¦æ§åˆ¶å¥½æ‰“åŒ…çš„å¤§å°ï¼Œå®šæœŸæ¸…ç†è€æ—§ç‰ˆæœ¬æ–‡ä»¶å°±å¯ä»¥äº†ã€‚

è¿™ä¸ªæ–¹æ¡ˆçš„ç¼ºç‚¹æ˜¯ç”¨æˆ·ä¾§ç‰ˆæœ¬å¯èƒ½ä¸ç»Ÿä¸€ï¼Œç”¨æˆ·å¯èƒ½ä¼šçœ‹åˆ°æ—§çš„ç‰ˆæœ¬ã€‚ä½†æ˜¯æ¥å…¥ç°åº¦ç³»ç»Ÿå°±ä¼šæ¯”è¾ƒæ–¹ä¾¿ï¼Œæœ‰åˆ©æœ‰å¼Šã€‚


**ç»¼åˆæ–¹æ¡ˆ**

ç»¼ä¸Šæ‰€è¿°ï¼Œæˆ‘ä»¬å¯ä»¥æ€»ç»“ä¸Šè¿°æ–¹æ¡ˆçš„ä¼˜ç‚¹ï¼Œæå‡ºä¸€ä¸ªç»¼åˆæ–¹æ¡ˆï¼š

- è®¾ç½®ä¸ç¼“å­˜ index.html
- CI æ‰“åŒ…æ—¶æŒ‰ç…§æ–¹æ¡ˆ3ï¼Œå®ç°å†å²èµ„æºå…±å­˜
- æ¥å…¥ç°åº¦ç³»ç»Ÿï¼Œå®ç°æ¥å£è·å–å½“å‰ç”¨æˆ·å‰ç«¯èµ„æºç›®å½•ï¼Œæ¯”å¦‚ï¼š`/20230302/main.qd52s5f7.js`
- å‰åç«¯çº¦å®šå¥½å½“å‰ç™»å½•çš„ç°åº¦ç”¨æˆ·çš„ç‰ˆæœ¬ï¼ŒAPI è¿”å›ç‰ˆæœ¬ä¿¡æ¯ã€‚

è¿™æ ·ï¼Œåœ¨ç”¨æˆ·ç¬¬ä¸€æ¬¡è¯·æ±‚é¡µé¢æ—¶ï¼Œå‰ç½®è°ƒç”¨ç°åº¦ APIï¼Œ[ç°åº¦ç³»ç»Ÿ](https://juejin.cn/post/7212054600162132029)å‘ŠçŸ¥ nginx æœåŠ¡å™¨è½¬å‘ç»™å‰ç«¯é¡µé¢ã€‚

åœ¨ç”¨æˆ·åˆ·æ–°é¡µé¢æ—¶ï¼Œä¼šå†æ¬¡è°ƒç”¨ç°åº¦ API å¹¶æ›´æ–°å‰ç«¯ç¼“å­˜ï¼Œæ‹¿åˆ°æœ€æ–°çš„èµ„æºã€‚åœ¨ç”¨æˆ·åŸåœ°ç‚¹å‡» menu è·³è½¬è·¯ç”±æ—¶ï¼Œèµ„æºä¹Ÿä¸ä¼šä¸¢å¤±ï¼Œåœ¨ API ä¸­è·å–ç°åº¦ç³»ç»Ÿä¸­ç™»å½•ç”¨æˆ·ç‰ˆæœ¬å·ï¼Œè¿”å›ç»™å‰ç«¯è¯¥çº¦å®šå¥½çš„ç‰ˆæœ¬ï¼ˆBUILD_PATHï¼‰ï¼Œå‰ç«¯åˆ¤æ–­ç‰ˆæœ¬ä¸ä¸€è‡´æ—¶æç¤ºç”¨æˆ·åˆ·æ–°æˆ–è€…è‡ªè¡Œåˆ·æ–°é¡µé¢å³å¯ã€‚

----

ä¸çŸ¥é“å¤§å®¶è¿˜æœ‰ä»€ä¹ˆæ›´å¥½çš„æ–¹æ¡ˆå—ï¼Ÿæ¬¢è¿ä¸€èµ·å­¦ä¹ äº¤æµï¼5d:T2f67,å®˜ç½‘åœ°å€ï¼š[React](https://react.dev/)


## 1. \<Profiler>
  

`<Profiler>` å¸®åŠ©å¼€å‘è€…ç¨‹å¼åŒ–åœ°è®¡ç®—æ¸²æŸ“æ€§èƒ½ã€‚

### æ¥å— props

-   `id`: æƒ³è¦æµ‹é‡æ€§èƒ½çš„ç»„ä»¶çš„å”¯ä¸€æ ‡è¯†ç¬¦
-   `onRender`: ç»„ä»¶æ ‘æ›´æ–°æ—¶è°ƒç”¨ï¼Œä¼ é€’çš„æ“¦å‡€ä¹¦ä¸­åŒ…å«æµ‹è¯•ç»„ä»¶ä¿¡æ¯å’Œæ€§èƒ½ä¿¡æ¯ã€‚å‚æ•°ä¿¡æ¯å¦‚ä¸‹ï¼š

|å‚æ•°|æè¿°|
|-|-|
|id|è¯¥æ¸²æŸ“å…ƒç´ çš„å”¯ä¸€æ ‡è¯†ï¼Œå°±æ˜¯ä½ è‡ªå·±åœ¨Profilerä¸­æ‰“çš„id|
|phase|æšä¸¾ï¼š `mount`, `update` or `nested-update`ã€‚æ ‡è¯†æ¸²æŸ“ç»„ä»¶æ¸²æŸ“çš„ç±»å‹|
|actualDuration|æ¸²æŸ“åŒ…è£¹ç»„ä»¶åŠå…¶å­ç»„ä»¶æ‰€èŠ±è´¹çš„æ¯«ç§’æ•°ã€‚è¿™å¯ä»¥æµ‹è¯•å­æ ‘åˆ©ç”¨è®°å¿†å‡½æ•°ï¼ˆä¾‹å¦‚ memo å’Œ useMemoï¼‰çš„ä½¿ç”¨æƒ…å†µã€‚ç†æƒ³æƒ…å†µä¸‹ï¼Œæ­¤å€¼åœ¨åˆå§‹æŒ‚è½½ååº”æ˜¾è‘—é™ä½ï¼Œå› ä¸ºè®¸å¤šåä»£èŠ‚ç‚¹åªéœ€è¦åœ¨å…¶ç‰¹å®šä¾èµ–å‘ç”Ÿå˜åŒ–æ—¶æ‰éœ€è¦é‡æ–°æ¸²æŸ“ã€‚|
|baseDuration|ä¼°è®¡åœ¨æ²¡æœ‰ä»»ä½•ä¼˜åŒ–çš„æƒ…å†µä¸‹é‡æ–°å‘ˆç°æ•´ä¸ªå­æ ‘æ‰€éœ€çš„æ—¶é—´çš„æ¯«ç§’æ•°ã€‚å®ƒæ˜¯é€šè¿‡æ±‡æ€»æ ‘ä¸­æ¯ä¸ªç»„ä»¶çš„æœ€æ–°æ¸²æŸ“æŒç»­æ—¶é—´æ¥è®¡ç®—çš„ã€‚æ­¤å€¼ä¼°è®¡æ¸²æŸ“çš„æœ€åæƒ…å†µæˆæœ¬ï¼ˆä¾‹å¦‚ï¼Œåˆå§‹æŒ‚è½½æˆ–æ²¡æœ‰è®°å¿†å‡½æ•°çš„æ ‘ï¼‰ã€‚å°†å®é™…æŒç»­æ—¶é—´ä¸å®ƒè¿›è¡Œæ¯”è¾ƒï¼Œçœ‹çœ‹è®°å¿†å‡½æ•°æ˜¯å¦æœ‰æ•ˆã€‚|
|startTime|react å¼€å§‹æ¸²æŸ“æ—¶çš„æ—¶é—´æˆ³|
|endTime|React å½“å‰æ›´æ–°ç»„ä»¶è¢« commit ï¼ˆç†è§£ä¸º fiber è°ƒåº¦ç»Ÿä¸€æ›´æ–°çœŸå® domï¼‰æ—¶çš„æ—¶é—´æˆ³ã€‚æ­¤å€¼åœ¨ commit ä¸­çš„æ‰€æœ‰ profiler ä¹‹é—´å…±äº«ï¼Œä»¥ä¾¿åœ¨éœ€è¦æ—¶å¯¹å®ƒä»¬è¿›è¡Œåˆ†ç»„ã€‚|

### æ³¨æ„äº‹é¡¹

æ€§èƒ½åˆ†æä¼šå¢åŠ ä¸€äº›é¢å¤–çš„å¼€é”€ï¼Œå› æ­¤é»˜è®¤æƒ…å†µä¸‹åœ¨ç”Ÿäº§ç‰ˆæœ¬ä¸­ä¼šç¦ç”¨å®ƒã€‚

### ä½¿ç”¨æ¡ˆä¾‹

1. è®¡ç®—å•ä¸ªç»„ä»¶æ¸²æŸ“æ€§èƒ½

```js
<App>
  <Profiler id="Sidebar" onRender={onRender}>
    <Sidebar />
  </Profiler>
  <PageContent />
</App>
```
æ­¤æ—¶ï¼Œä½ è¿˜å¯ä»¥åœ¨ [React Developer Tools](https://react.dev/learn/react-developer-tools) ä¸­æŸ¥çœ‹ Profiler é¡µç­¾ï¼Œé‡Œè¾¹æœ‰å…·ä½“ä¿¡æ¯ï¼š


![image.png](/img/posts/2023-8-24/2023-8-24-1.png)

2. å¤šä¸ªç»„ä»¶æ€§èƒ½æµ‹è¯•

```js
<App>
  <Profiler id="Sidebar" onRender={onRender}>
    <Sidebar />
  </Profiler>
  <Profiler id="Content" onRender={onRender}>
    <Content>
      <Profiler id="Editor" onRender={onRender}>
        <Editor />
      </Profiler>
      <Preview />
    </Content>
  </Profiler>
</App>
```
å¯ä»¥çœ‹åˆ°ï¼Œä½¿ç”¨åŒä¸€ä¸ªå‡½æ•°å°±è¡Œã€‚

> Profiler ä¼šå½±å“æ€§èƒ½ï¼Œä¸è¦åœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨


## 2. \<Suspense>

`<Suspense>` åŒ…è£¹ä¸€ä¸ªéœ€è¦æ‡’åŠ è½½çš„ç»„ä»¶ã€‚

### æ¥æ”¶ props

- `children`: æ‡’åŠ è½½çš„ç»„ä»¶ã€‚åœ¨æ¸²æŸ“è¿‡ç¨‹ä¸­ä¼šç”¨ fallback å‡½æ•°å¡«å……ç©ºç™½åŒºåŸŸ.
- `fallback`: æ‡’åŠ è½½ç»„ä»¶æ¸²æŸ“è¿‡ç¨‹ä¸­çš„æ›¿ä»£å“ï¼ˆplaceholderï¼‰ï¼Œæ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå…¶è¿”å›å€¼å¯ä»¥æ¥å—ä»»ä½•æœ‰æ•ˆçš„ React Nodeï¼Œæ¯”å¦‚ loading å›¾æ ‡æˆ–è€…éª¨æ¶å±ç­‰ã€‚å½“ ç»„ä»¶å»¶è¿ŸåŠ è½½è¿‡ç¨‹ä¸­ï¼ŒSuspense ä¼šè‡ªåŠ¨åˆ‡æ¢åˆ°Â fallbackï¼ŒåŠ è½½ç»“æŸåè‡ªåŠ¨æ¢å›åˆ° childrenã€‚å¤šå±‚ Suspense åŒ…è£¹çš„æƒ…å†µæ—¶ï¼Œä¼šå›è½åˆ°æœ€è¿‘çš„ä¸€å±‚ fallbackã€‚

### æ³¨æ„äº‹é¡¹

- React ä¸ä¼šä¸ºåœ¨é¦–æ¬¡æŒ‚è½½ä¹‹å‰è¢« Suspense çš„æ¸²æŸ“ä¿ç•™ä»»ä½•çŠ¶æ€ã€‚å½“ç»„ä»¶åŠ è½½å®Œæ¯•åï¼ŒReact å°†ä»å¤´å¼€å§‹é‡è¯•æ¸²æŸ“æŒ‚èµ·çš„æ¸²æŸ“æ ‘ã€‚
- å¦‚æœ Suspense æ¸²æŸ“æ ‘çš„å†…å®¹å·²ç»æ˜¾ç¤ºåå†æ¬¡æŒ‚èµ·ï¼Œåˆ™â€œfallbackâ€å°†å†æ¬¡æ˜¾ç¤ºï¼Œé™¤éå¯¼è‡´å®ƒçš„æ›´æ–°æ˜¯ç”±startTransition å¼•èµ·çš„ã€‚
- å¦‚æœ React éœ€è¦éšè—å·²ç»å¯è§çš„å†…å®¹ï¼Œç”±äºå®ƒå†æ¬¡æŒ‚èµ·äº†ï¼Œæ‰€ä»¥ä¼šæ¸…ç†æ¸²æŸ“æ ‘ä¸­çš„å¸ƒå±€æ•ˆæœã€‚å½“å†…å®¹å‡†å¤‡å¥½å†æ¬¡æ˜¾ç¤ºæ—¶ï¼ŒReact å°†å†æ¬¡è§¦å‘å¸ƒå±€é‡ç»˜ã€‚è¿™æ ·ï¼Œåœ¨ç»„ä»¶éšè—æ—¶å°±ä¸ä¼šå†åšå¸ƒå±€é‡ç»˜çš„è®¡ç®—äº†ã€‚
- React åœ¨ Suspense ä¸­é›†æˆäº†ä¸€äº›åº•å±‚ä¼˜åŒ–ï¼Œå¦‚*æµæœåŠ¡å™¨æ¸²æŸ“*å’Œ*é€‰æ‹©æ€§æ°´åˆ*ï¼ˆHydrationï¼‰ã€‚åœ¨æœåŠ¡ç«¯æ¸²æŸ“æ—¶å¯ä»¥ç”¨åˆ°ã€‚

> Suspense **ä¸åœ¨** Effect å‰¯ä½œç”¨ æˆ–è€… event handler ä¸­ç›‘æµ‹

### ä½¿ç”¨æ¡ˆä¾‹

1. ä½¿ç”¨ fallback çš„ loading æ•ˆæœ

```js
const [show, setShow] = useState(false);

<button onClick={() => setShow(true)}></button>
...

if (show) {
    return (
        <Suspense fallback={<Loading />}>
          <Albums artistId={artist.id} />
        </Suspense>
    )
}

...
function Loading() {
  return <h2>ğŸŒ€ Loading...</h2>;
}
```

2. ä¸€æ¬¡æ€§æ‡’åŠ è½½å¤šä¸ªç»„ä»¶

```js
<Suspense fallback={<Loading />}>
    <Biography artistId={artist.id} />
    <Panel>
      <Albums artistId={artist.id} />
    </Panel>
</Suspense>
```

è¢« Suspense åŒ…è£¹çš„èŒƒå›´è§†ä¸ºä¸€ä¸ªç»Ÿä¸€çš„æ›´æ–°å•å…ƒã€‚ä¸¤ä¸ªç»„ä»¶åªæœ‰ä¸€ä¸ªå¤„äºåŠ è½½ä¸­æ—¶ï¼Œæ•´ä¸ªæ˜¾ç¤ºéƒ½ä¼šå˜ä¸ºæŒ‡ç¤ºå™¨ fallbackã€‚åœ¨æ‰€æœ‰ç»„ä»¶å‡†å¤‡å®Œæ¯•åï¼Œä¼šä¸€æ¬¡æ€§æ¸²æŸ“å‡ºæ¥ã€‚

æ¢ç§æ€è€ƒæ–¹æ¡ˆï¼Œä¸Šé¢çš„ä»£ç æ˜¯æœ‰é—®é¢˜çš„ï¼Œå¤šä¸ªå¼‚æ­¥ç»„ä»¶ä¸å»ºè®®åˆ†å¼€å†™ï¼Œåº”è¯¥æŒ‰ç…§ä¸šåŠ¡åŒºåˆ†ï¼Œç»Ÿä¸€ä½¿ç”¨ Details ç»„ä»¶å°è£…ï¼š

```js
<Suspense fallback={<Loading />}>
  <Details artistId={artist.id} />
</Suspense>
```

3. ä½¿ç”¨åµŒå¥— Suspense

```js
<Suspense fallback={<BigSpinner />}>
    <Biography artistId={artist.id} />
    <Suspense fallback={<AlbumsGlimmer />}>
      <Panel>
        <Albums artistId={artist.id} />
      </Panel>
    </Suspense>
</Suspense>
```

ä¸Šé¢çš„ Biography ç»„ä»¶çš„åŠ è½½ä¸ä¼šå—åˆ° Albums åŠ è½½çš„å½±å“ã€‚sequence çš„è¿ä½œæµç¨‹ï¼š

- å½“ `Biography` æœªåŠ è½½æ—¶,Â ç»Ÿä¸€æ˜¾ç¤º `BigSpinner` æ–¹æ¡ˆã€‚
- ä¸€æ—¦Â `Biography`Â åŠ è½½ç»“æŸ,Â `BigSpinner`Â å°±ä¼šè¢«æ›¿æ¢æ‰ã€‚
- æ­¤æ—¶ `Albums` å¼€å§‹åŠ è½½Â `AlbumsGlimmer`Â æ˜¾ç¤ºåœ¨å¯¹åº”åŒºåŸŸã€‚
- ä¸€æ—¦Â `Albums`Â åŠ è½½ç»“æŸï¼Œåˆ™ç»“æŸæ¸²æŸ“ã€‚

Suspense è¾¹ç•Œè®¾ç½®å°±ç±»ä¼¼äºå †æ ˆçš„ pop æ“ä½œï¼Œæ˜¯æœ‰å±‚çº§å…³ç³»çš„ï¼Œæœ€ä¸Šå±‚çš„æœ€å…ˆåŠ è½½ã€‚ç†è®ºä¸Š Suspense å¯ä»¥ç”¨åœ¨ä»»ä¸€ä¸ªç»„ä»¶çš„ä»»ä½•ä¸€ä¸ªåœ°æ–¹ï¼Œä½†æ˜¯ä¸å»ºè®®åœ¨å„ä¸ªä¸šåŠ¡ç»„ä»¶å¹¿æ³›çš„ä½¿ç”¨ï¼Œå…·ä½“çš„ç”¨æˆ·ä½“éªŒè®¾è®¡ä¸­çš„æ¸²æŸ“é¡ºåºåº”è¯¥ç»†ç²’åº¦åˆ°å…·ä½“çš„ç»„ä»¶æ§åˆ¶å‡½æ•°ï¼ˆusetate/useEffect ç­‰ï¼‰ï¼Œè€Œä¸æ˜¯ä½¿ç”¨æ‡’åŠ è½½æŠ€æœ¯ã€‚

4. è¾“å…¥æ¡†è¾“å…¥æ—¶ï¼Œå‰ç«¯æ¨¡æ‹Ÿå¼‚æ­¥æŸ¥è¯¢æœç´¢ç»“æœ

å¦‚ä¸‹ï¼š

```js
const [query, setQuery] = useState('');
...
<>
  <label>
    Search albums:
    <input value={query} onChange={e => setQuery(e.target.value)} />
  </label>
  <Suspense fallback={<h2>Loading...</h2>}>
    <SearchResults query={query} />
  </Suspense>
</>
```
ä¸Šé¢çš„ä¾‹å­ï¼ŒsetQuery è§¦å‘äº†ç»„ä»¶çš„é‡æ¸²æŸ“ï¼ŒSearchResults å°±ä¼šå‡ºç°åŠ è½½ç•Œé¢ã€‚è¿™å¯ä»¥ç”¨æ¥åœ¨å‰ç«¯æœç´¢çš„ç»„ä»¶ä¸­æ¨¡æ‹ŸåŠ è½½åŠ¨ç”»ã€‚

å½“ç„¶ï¼Œä½ è¿˜å¯ä»¥ä½¿ç”¨ useDeferredValue æ¥sä½¿UIæ¸²æŸ“æ›´æµç•…ï¼š

```js
const deferredQuery = useDeferredValue(query);

...
// ä¸€ä¸ªåŠé€æ˜çš„åŠ è½½åŠ¨ç”»
<div style={{
  opacity: query !== deferredQuery ? 0.5 : 1 
}}>
    <SearchResults query={deferredQuery} />
</div>
```

5. é˜»æ­¢å·²æ¸²æŸ“å…ƒç´ è¢«éšè— [ä¾‹å­](https://codesandbox.io/s/s5tn9m?file=%2FApp.js&utm_medium=sandpack)

æˆ‘ä»¬å¯ä»¥è¿™æ ·å†™æ¥æ‡’åŠ è½½ä¸€ä¸ªè·¯ç”± ï¼š

```js
export default function App() {
  return (
    <Suspense fallback={<BigSpinner />}>
      <Router />
    </Suspense>
  );
}

function Router() {
  const [page, setPage] = useState('/');
  const [isPending, startTransition] = useTransition();

  function navigate(url) {
    startTransition(() => {
      setPage(url);
    });
  }

  let content;
  
  // å¤„ç†æ¨¡æ‹Ÿè·¯ç”±é€»è¾‘èµ‹å€¼å¹¶contentçš„æ“ä½œçœç•¥
  
  return (
    <Layout isPending={isPending}>
      {content}
    </Layout>
  );
}
``` 

ä¸Šé¢çš„ä¾‹å­ï¼Œä½ å¯èƒ½ä¼šè®¤ä¸ºç»„ä»¶åŠ è½½æ—¶ï¼Œ Layout ç»„ä»¶ä¹Ÿä¼šæ¶ˆå¤±å¹¶æ›¿æ¢ä¸º BigSpinnerã€‚ ä½†æ˜¯ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œè¢«åŒ…è£¹çš„ç»„ä»¶ä½¿ç”¨äº† `startTransition`ï¼Œè¿™å‘Šè¯‰ Reactï¼Œ Router ç»„ä»¶çš„æ¸²æŸ“ä¸æ˜¯ç´§æ€¥çš„ï¼Œå¯ä»¥ç¼“ä¸€ç¼“ï¼Œæ­¤æ—¶ï¼Œåœ¨ä¸‹ä¸€æ¬¡æ¸²æŸ“ç»“æŸä¹‹å‰ï¼Œç•Œé¢ä¼šä¿ç•™ä¸Šä¸€æ¬¡æ¸²æŸ“çš„å›¾å½¢ã€‚æ‰€ä»¥å³ä½¿ Suspense åŒ…è£¹äº†æœ€å¤–å±‚ï¼Œä½† Layout ç»„ä»¶å¹¶ä¸ä¼šé‡æ¸²æŸ“ï¼Œç›´åˆ°ä¸‹ä¸€æ¬¡æ¸²æŸ“ç»“æŸåæ‰å˜åŒ–ã€‚

6. åœ¨ navigate æ—¶é‡ç½® Suspense

ä¸Šé¢çš„ä¾‹å­æˆ‘ä»¬çŸ¥é“ï¼Œåœ¨ transition æ¸²æŸ“é˜¶æ®µï¼ŒUI ä¼šé¿å…éšè—æ‰å·²ç»æ¸²æŸ“å‡ºæ¥çš„æ•°æ®ï¼Œä½†æ˜¯åœ¨è·¯ç”±å¯¼èˆªæ—¶ï¼Œæ°æ°éœ€è¦å‘Šè¯‰ React ç»™æˆ‘ç«‹å³é”€æ¯åŸæ¥çš„æ•°æ®å¹¶å±•ç¤ºä½ å‡†å¤‡å¥½çš„ fallbackã€‚ä½ å¯ä»¥è¿™æ ·åšï¼š

```jsx
<ProfilePage key={queryParams.id} />
```

æˆ‘ä»¬ä¸¾ä¸€ä¸ªä½¿ç”¨åœºæ™¯ä¾‹å­ï¼Œä¸€ä¸ªç”¨æˆ·çš„ ProfilePage ä¸å¦ä¸€ä¸ªç”¨æˆ·çš„ ProfilePage å†…å®¹ä¸åŒã€‚é€šè¿‡æŒ‡å®šä¸€ä¸ªé”®ï¼Œä½ å¯ä»¥ç¡®ä¿ React å°†ä¸åŒç”¨æˆ·çš„ ProfilePage è§†ä¸ºä¸åŒçš„ç»„ä»¶ï¼Œå¹¶åœ¨å¯¼èˆªè¿‡ç¨‹ä¸­é‡ç½® Suspense è¾¹ç•Œã€‚

> ä¸Šé¢æ˜¯å®˜ç½‘çš„è§£é‡Šï¼Œç”¨äººè¯è¯´ï¼Œå°±æ˜¯ key å˜åŒ–äº†ï¼Œtransition ä¸ä¼šç¼“å­˜åŸæ¥æ¸²æŸ“çš„ UI äº†ï¼Œè€Œæ˜¯éšç€è·¯ç”±åˆ‡æ¢è¿›å…¥æ‡’åŠ è½½çš„ fallback

7. æ˜¾ç¤ºæœåŠ¡å™¨é”™è¯¯

å¦‚æœä½ ä½¿ç”¨äº†æœåŠ¡ç«¯æ¸²æŸ“ï¼Œå¹¶ä¸”ä¸€ä¸ªç»„ä»¶åœ¨æœåŠ¡ç«¯æŠ¥äº†é”™åï¼ŒReact ä¸ä¼šç»ˆæ­¢æœåŠ¡ç«¯çš„æ¸²æŸ“ï¼Œè€Œæ˜¯å¾€ä¸Šå±‚æ‰¾æœ€è¿‘çš„\<Suspense>ï¼Œä½¿ç”¨å…¶ fallback è¿›è¡Œæ›¿æ¢é”™è¯¯åŒºåŸŸï¼›å¦ä¸€æ–¹é¢ï¼Œåœ¨å®¢æˆ·ç«¯å‡ºç°é”™è¯¯åï¼Œå®¢æˆ·ç«¯ä¼šç›´æ¥æŠ›å‡ºé”™è¯¯ï¼Œå¦‚æœå®¢æˆ·ç«¯å¹¶æœªå‡ºç°é”™è¯¯ï¼Œåˆ™ç”¨æˆ·æ— æ³•æ„ŸçŸ¥æœåŠ¡ç«¯å‡ºé”™äº†ã€‚

å¯ä»¥åœ¨æœåŠ¡ç«¯ä½¿ç”¨å¦‚ä¸‹ä»£ç ï¼š

```js
<Suspense fallback={<Loading />}>
  <Chat />
</Suspense>

function Chat() {
  if (typeof window === 'undefined') {
    throw Error('Chat should only render on the client.');
  }
  // ...
}
```
æ­¤æ—¶ï¼Œåœ¨æœåŠ¡ç«¯åˆ™ä¼šæŠ›å‡ºé”™è¯¯ï¼Œåœ¨å®¢æˆ·ç«¯åˆ™æ­£å¸¸æ˜¾ç¤º Chatã€‚

8. åšå…¨å±€è·¯ç”±æ‡’åŠ è½½

å¯ä»¥ç»“åˆ lazy ä½¿ç”¨ï¼Œåšè·¯ç”±çš„æ‡’åŠ è½½æ¥æé«˜é¡µé¢æ€§èƒ½ï¼š

```js
const container = document.getElementById('root');
const root = createRoot(container); // createRoot(container!) if you use TypeScript

root.render(
  <BrowserRouter basename={config.basename}>
    <CustomRoutes />
  </BrowserRouter>
);
```

åœ¨ `<CustomRoutes />` ä¸­ï¼š

```js
const Home = lazy(() => import('./Home'))
const About = lazy(() => import('./About'))

<Routes>
  <Suspense fallback={<Loading type="home" />}>
    <Route path="/" element={<Home />} />
  </Suspense>
  <Suspense fallback={<Loading type="about" />}>
    <Route path="about" element={<About />} /> 
  </Suspense>
</Routes>
```
ä¸Šé¢çš„ä¾‹å­ï¼Œåœ¨ location pathname åˆ‡æ¢æ—¶ï¼Œä¼šåŠ è½½ä¸åŒçš„ fallback åŠ è½½åŠ¨ç”»ï¼ŒåŠ è½½ç»“æŸåï¼Œæ˜¾ç¤ºå¯¹åº”çš„æ¸²æŸ“å…ƒç´ ã€‚

----

æ­¤å¤–ï¼Œ react ä¸­è¿˜æœ‰ä¸¤ä¸ªç»„ä»¶ï¼š`<Fragment>`,`<StrictMode>`ï¼Œå› ä¸ºåŠŸèƒ½æ¯”è¾ƒå•ä¸€ï¼ŒèŒ„ä½¿ç”¨è¾ƒä¸ºç®€å•ï¼Œè¿™é‡Œåšç®€å•æè¿°ã€‚

## 3. \<Fragment>

ç”±äº react æ¸²æŸ“å¿…é¡»æœ‰ä¸€ä¸ªæ ¹ç»„ä»¶ï¼Œä½†æ˜¯åˆä¸æƒ³ç ´ååŸæ¥çš„ dom ç»“æ„ï¼Œreact å®ç°äº†è¿™ä¹ˆä¸ªè™šæ‹Ÿçš„å®¹å™¨ã€‚ä½¿ç”¨æ–¹å¼å¦‚ä¸‹ï¼š

```js
function Post() {
  return (
    <>
      <PostTitle />
      <PostBody />
    </>
  );
}
```
åœ¨ fiber å®é™…æ¸²æŸ“çœŸå® dom æ—¶ï¼ŒFragment ä¼šè¢«æ¸…é™¤æ‰ï¼Œä¸ä¼šå ç”¨ dom æ ‘ç©ºé—´ã€‚å½“éœ€è¦å†å¾ªç¯åˆ—è¡¨ä¸­ä½¿ç”¨æ—¶ï¼Œå¾€å¾€éœ€è¦æ·»åŠ å…ƒç´ çš„ key å±æ€§ï¼Œè¿™å°±ä¸èƒ½ä½¿ç”¨åŒ¿åæ ‡ç­¾ï¼Œè€Œè¦ä½¿ç”¨å…¨åï¼š

```js
function Blog() {
  return posts.map(post =>
    <Fragment key={post.id}>
      <PostTitle title={post.title} />
      <PostBody body={post.body} />
    </Fragment>
  );
}
```

> Fragment æ²¡æœ‰ä»»ä½•å±æ€§ï¼Œæ·»åŠ æ ·å¼ä¹Ÿæ˜¯ä¸ä¼šç”Ÿæ•ˆçš„ã€‚ä¸€çº§ Fragment çš„æ¸²æŸ“ä¸ä¼šè§¦å‘ç»„ä»·é‡æ¸²æŸ“ï¼Œä½†æ˜¯å¤šçº§ Fragment åˆ™ä¼šå¯¼è‡´é‡æ¸²æŸ“ï¼Œä¾‹å¦‚ä» `<><><Child /></></>` åˆ° `<Child />`ï¼Œå­ç»„ä»¶ state ä¼šé‡ç½®ã€‚

## 4. \<StrictMode>

å¸®åŠ©åœ¨å¼€å‘æ¨¡å¼å‘ç°æ›´å¤šçš„æ½œåœ¨ bugã€‚ä½¿ç”¨æ–¹å¼ï¼š

```js
const root = createRoot(document.getElementById('root'));
root.render(
  <StrictMode>
    <App />
  </StrictMode>
);
```

ä¸¥æ ¼æ¨¡å¼ä¸‹ï¼Œå¼€å‘ç¯å¢ƒä¼šæœ‰å¦‚ä¸‹å˜åŒ–ï¼š

-   ç»„ä»¶éƒ½ä¼šè¢«æ¸²æŸ“ä¸¤æ¬¡ï¼Œä»¥å‘ç°ä¸€äº›éçº¯å‡½æ•°ã€‚ä¾‹å¦‚ï¼š

```js
// é”™è¯¯å†™æ³•
export default function StoryTray({ stories }) {
  const items = stories;
  items.push({ id: 'create', label: 'Create Story' });
  return (
    <ul>
      {items.map(story => (
        <li key={story.id}>
          {story.label}
        </li>
      ))}
    </ul>
  );
}
```
-   å‰¯ä½œç”¨å‡½æ•°ä¼šè¢«æ‰§è¡Œä¸¤éï¼Œä»¥å‘ç°æ²¡æœ‰è¢«æ¸…ç†ï¼ˆclean upï¼‰çš„å‰¯ä½œç”¨è®¢é˜…ã€‚
-   ä¼šæ£€æŸ¥æ˜¯å¦ç”¨äº†ä¸€äº›ä¸åˆé€‚çš„ APIï¼Œæ¯”å¦‚ findDOMNode

å½“ç„¶ï¼Œä¸¥æ ¼æ¨¡å¼ä¹Ÿå¯ä»¥éƒ¨åˆ†åŠ åœ¨å±€éƒ¨ç»„ä»¶ä¸Šï¼š

```js
<StrictMode>
    <main>
      <Sidebar />
      <Content />
    </main>
</StrictMode>
```
----

å®Œï¼ï¼5e:T2df4,å®˜ç½‘åœ°å€ï¼š[React](https://react.dev/)


## 1. useTransition

useTransition å¯ä»¥è®©ä½ ä¸é˜»å¡ UI æ¸²æŸ“æ¥æ›´æ–° state çš„å€¼ã€‚å¯ä»¥ç†è§£ä¸ºå®ç°æ›´æµç•…çš„é¡µé¢è¿‡æ¸¡ã€‚ä½¿ç”¨æ–¹å¼ä¸ºï¼š

```js
// ä¸€ä¸ªåˆ‡æ¢ tab é¡µç­¾çš„ä¾‹å­
function TabContainer() {
  const [isPending, startTransition] = useTransition();
  const [tab, setTab] = useState('about');

  function selectTab(nextTab) {
    startTransition(() => {
      setTab(nextTab);
    });
  }
  // ...
}
```

å…¶ä¸­ï¼š

- isPendingï¼šä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºå½“å‰æ˜¯å¦é˜»å¡
- startTransitionï¼šå¼€å¯è¿‡æ¸¡ï¼Œå¹¶å¯ä¿®æ”¹ state

### æ³¨æ„äº‹é¡¹

- ä½œä¸ºä¸€ä¸ª hookï¼Œåªèƒ½åœ¨å‡½æ•°å¼ç»„ä»¶æˆ–è€…è‡ªå®šä¹‰ hook é‡Œè¢«è°ƒç”¨ï¼Œå¦‚æœæƒ³è¦å•ç‹¬ä½œä¸º API è°ƒç”¨ï¼Œå¯ä½¿ç”¨ [`startTransition`](https://react.dev/reference/react/startTransition)
- ä»…ä»…å¯ä»¥åœ¨ setState ä¸­è§¦å‘ï¼Œè‹¥æƒ³è¦åœ¨ props å˜åŒ–åè§¦å‘ï¼Œéœ€ä½¿ç”¨ [`useDeferredValue`](https://react.dev/reference/react/useDeferredValue)
- startTransition é‡Œçš„æ–¹æ³•ä¸èƒ½æœ‰å¼‚æ­¥å‡½æ•°ï¼Œè®¾ç½®å¼‚æ­¥ä¼šæ‰“ä¹±æ¸²æŸ“é¡ºåºï¼Œè¿™ä¸ªæ¸²æŸ“å°±å¤±å»ä½œç”¨äº†ã€‚
- æ ‡è®°ä¸º transition çš„ state ä¼šè¢«å…¶ä»– state çš„æ›´æ–°æ‰“æ–­ã€‚å¦‚æœæ‚¨åœ¨ transition ä¸­æ›´æ–°å›¾è¡¨ç»„ä»¶ï¼Œä½†åœ¨å›¾è¡¨å¤„äºé‡æ–°æ¸²æŸ“è¿‡ç¨‹ä¸­å¼€å§‹åœ¨å¦å¤–çš„ input ä¸­é”®å…¥è¾“å…¥ï¼Œåˆ™ React å°†åœ¨å¤„ç†è¾“å…¥æ›´æ–°åé‡æ–°å¯åŠ¨å›¾è¡¨ç»„ä»¶çš„æ¸²æŸ“å·¥ä½œã€‚
- ä¸èƒ½ç”¨äºæ§åˆ¶æ–‡æœ¬è¾“å…¥
- å¦‚æœæœ‰å¤šä¸ªæ­£åœ¨è¿›è¡Œçš„ transitionï¼ŒReact ç›®å‰ä¼šå°†å®ƒä»¬æ‰¹å¤„ç†åœ¨ä¸€èµ·ã€‚æ­¤åŠŸèƒ½å¯èƒ½ä¼šåœ¨å°†æ¥çš„ç‰ˆæœ¬ä¸­åˆ é™¤

### ä½¿ç”¨æ¡ˆä¾‹

1. åˆ‡æ¢ tab å¡é¡¿é—®é¢˜ï¼š

è¿™é‡Œæœ‰å‡ ä¸ªtabï¼Œtabå†…å®¹å¦‚ä¸‹ï¼š

```js
// tab 1 ä¸€ä¸ªæŒ‰é’®
<button onClick={() => {
  onClick();
}}>
  {children}
</button>

// tab 2 ä¸€ä¸ª p
return (
    <p>Welcome to my profile!</p>
);

// tab 3 ä¸€ä¸ªå¤æ‚åˆ—è¡¨
let items = [];
for (let i = 0; i < 500; i++) {
    items.push(<SlowPost key={i} index={i} />);
}
return (
    <ul className="items">
      {items}
    </ul>
);

function SlowPost({ index }) {
  let startTime = performance.now();
  while (performance.now() - startTime < 1) {
    // äººä¸ºæ¨¡æ‹Ÿçš„å¡é¡¿
  }

  return (
    <li className="item">
      Post #{index + 1}
    </li>
  );
}
```

å¯ä»¥çœ‹åˆ°ï¼Œtab3åŒ…å« 500 ä¸ªå…ƒç´ ï¼Œé¡µé¢æ¸²æŸ“åŠ¿å¿…ä¼šå¡é¡¿1-2ç§’ï¼Œæˆ‘ä»¬å†™ä¸€ä¸ª tab åˆ‡æ¢ç»„ä»¶ï¼š

```js
export default function TabContainer() {
  const [isPending, startTransition] = useTransition();
  const [tab, setTab] = useState(1);

  function selectTab(nextTab) {
    setTab(nextTab);      
  }

  return (
    <>
      <TabButton
        isActive={tab === 1}
        onClick={() => selectTab(1)}
      >
        About
      </TabButton>
      ...
      <TabButton
        isActive={tab === 3}
        onClick={() => selectTab(3)}
      >
        Posts (slow)
      </TabButton>
      ...
    </>
  );
}
```
ä¸Šé¢çš„ä¾‹å­ï¼ŒTabButton æ˜¯ä¸€ä¸ªå…¬å…±å­ç»„ä»¶ï¼Œæ˜¯å‡ ä¸ªé¡¶éƒ¨çš„æŒ‰é’®ï¼Œç”¨äºæ¥å—äº‹ä»¶åˆ‡æ¢ tabï¼š

```js
<button onClick={() => {
  // è°ƒç”¨çˆ¶ç»„ä»¶TabContainerçš„ selectTab æ–¹æ³•
  onClick();
}}>
  {children}
</button>
```

Posts é¡µç­¾ï¼ˆtab3ï¼‰åœ¨ active çš„æ—¶å€™å°±ä¼šåŠ è½½æ¸²æŸ“ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹é¡µé¢çš„ååº”ï¼š


![image.png](/img/posts/2023-8-18/2023-8-18-1.png)

æˆ‘ä»¬æ¥å…¥ useTransition è¯•è¯•ï¼š

```js
const [isPending, startTransition] = useTransition();
  const [tab, setTab] = useState('about');

  function selectTab(nextTab) {
    startTransition(() => {
      setTab(nextTab);      
    });
  }
```

å†æ¬¡åˆ‡æ¢ tab çœ‹çœ‹æ•ˆæœï¼š

![image.png](/img/posts/2023-8-18/2023-8-18-2.png)

æˆªå›¾çœ‹çš„ä¸æ˜æ˜¾ï¼Œæˆ‘åœ¨å›¾ä¸ŠæŠŠæ•ˆæœç”¨æ–‡å­—æ ‡è¯†å‡ºæ¥äº†ã€‚ä¹Ÿå°±æ˜¯è¯´è·Ÿ startTransition ç›¸å…³çš„ state çš„å˜åŒ–å¼•èµ·çš„æ¸²æŸ“éƒ½ä¼šè¿›å…¥è¿‡æ¸¡ä¸­ã€‚

2. å­ç»„ä»¶æ›´æ”¹çˆ¶ç»„ä»¶ state

ä¸Šé¢çš„ä¾‹å­ï¼Œä½ ä¹Ÿå¯ä»¥å°†æ›´æ”¹ state çš„æ“ä½œæ”¾åœ¨å­ç»„ä»¶ä¸­ï¼Œæ•ˆæœæ˜¯ä¸€æ ·çš„ã€‚æˆ‘ä»¬æ”¹å†™ tabButton ç»„ä»¶ï¼š

```js
<button onClick={() => {
  startTransition(() => {
    // è°ƒç”¨çˆ¶ç»„ä»¶TabContainerçš„ selectTab æ–¹æ³•
    onClick();
  });
}}>
  {children}
</button>
```
è€Œåœ¨çˆ¶ç»„ä»¶ä¸­ï¼Œå°±å¯ä»¥ç›´æ¥è®¾ç½® state äº†ï¼š

```js
function selectTab(nextTab) { 
  setTab(nextTab); 
}
```

3. é¡µé¢ä¸Šæ˜¾ç¤ºé˜»å¡æ¸²æŸ“æ—¶çš„è¿›åº¦

è¿™ä¸ªå°±æ˜¯ useTransition çš„è¿”å›å€¼ isPending çš„åº”ç”¨ï¼Œä»–ä¸º true æ—¶è¡¨ç¤ºè¿™ä¸ªè¿‡æ¸¡åŠ¨ç”»è¿˜åœ¨è¿›è¡Œä¸­ã€‚

```js
const [isPending, startTransition] = useTransition();
 
if (isPending) {
  return <b className="pending">{children}</b>;
}
```

4. ä¸ Suspends ç»“åˆï¼Œåšç»„ä»¶æ‡’åŠ è½½

æ²¿ç”¨ç¬¬äºŒä¸ªä¾‹å­çš„ä»£ç ï¼Œå­ç»„ä»¶tabButtonå®ç°useTransitionï¼Œæˆ‘ä»¬åªæ”¹çˆ¶ç»„ä»¶ï¼š

```js
<Suspense fallback={<h1>ğŸŒ€ Loading...</h1>}>
  <TabButton
    isActive={tab === 'about'}
    onClick={() => setTab('about')}
  >
    About
  </TabButton>
  ...
</Suspense>
```
è¿™æ ·åœ¨ç¬¬ä¸€æ¬¡åŠ è½½æ—¶å°±ä¼šå‡ºç° fallbackæç¤ºï¼š


![image.png](/img/posts/2023-8-18/2023-8-18-3.png)

ä½¿ç”¨ Suspense çš„å¥½å¤„åœ¨äºï¼Œå¤æ‚ç»„ä»¶åªéœ€åŠ è½½ä¸€æ¬¡ï¼Œç¬¬äºŒæ¬¡åˆ‡æ¢åŠ è½½æ—¶å°±è¢«ç¼“å­˜äº†ï¼Œå¯ä»¥å¾ˆå¿«çš„æ¸²æŸ“.

5. è‡ªå®šä¹‰ä¸€ä¸ªè‡ªå·±çš„ react è·¯ç”±ï¼ï¼ˆå½“ç„¶ä¸æ˜¯çœŸçš„è·¯ç”±ï¼‰


æˆ‘ä»¬å¯ä»¥åƒä¸‹é¢è¿™æ ·å®šä¹‰ä¸€ä¸ª Router å‡½æ•°ï¼š

```js
function Router() {
  const [page, setPage] = useState('/');
  const [isPending, startTransition] = useTransition();

  function navigate(url) {
    startTransition(() => {
      setPage(url);
    });
  }

  let content;
  if (page === '/') {
    content = (
      <IndexPage navigate={navigate} />
    );
  } else if (page === '/the-beatles') {
    content = (
      <ArtistPage
        artist={{
          id: 'the-beatles',
          name: 'The Beatles',
        }}
      />
    );
  }
  return (
    <Layout isPending={isPending}>
      {content}
    </Layout>
  );
}
```
æ¥åˆ†æä¸€ä¸‹ï¼Œä¸Šé¢ Layout ç»„ä»¶æ˜¯è‡ªå·±å®šä¹‰çš„ä¸€ä¸ªå®¹å™¨ç»„ä»¶ï¼Œå†…éƒ¨ç›´æ¥æŠ›å‡º children å±æ€§å³å¯ï¼›ä¸Šé¢åˆ¤æ–­å½“å‰çš„çŠ¶æ€ page æ˜¯ `'/the-beatles'` å’Œ `'/'` æ—¶ï¼Œè‡ªåŠ¨æ¸²æŸ“ä¸åŒçš„ç»„ä»¶ï¼›å…¶ä¸­ï¼Œ`navigate` å‡½æ•°ç”¨äºå¯¼èˆªè·³è½¬ï¼Œä»–å…¶å®æ“ä½œçš„å°±æ˜¯ä¸€ä¸ªå¸¦ Transition çš„ setPageï¼Œè¿™æ ·å°±å®ç°äº†ä¸€ä¸ªå¹³æ»‘çš„è·¯ç”±åˆ‡æ¢ã€‚


### Q&A

1. ä¸ºå•¥æˆ‘çš„ input ä¸­ useTransition ä¸ç”Ÿæ•ˆï¼Ÿï¼Ÿ

å› ä¸ºä½ è¯•å›¾ç”¨ä»–æ¥æ§åˆ¶è¾“å…¥æ¡†ï¼Œè¿™æ˜¯ä¸æ”¯æŒçš„ï¼š

```js
const [text, setText] = useState('');
// ...
function handleChange(e) {
  // âŒ Can't use transitions for controlled input state
  startTransition(() => {
    setText(e.target.value);
  });
}
// ...
return <input value={text} onChange={handleChange} />;
```
è¿™æ˜¯å› ä¸º useTransition æ˜¯éé˜»å¡æ¸²æŸ“çš„ï¼Œä½†æ˜¯è¾“å…¥æ¡†æ¯”è¾ƒç‰¹æ®Šï¼Œä»–çš„ change äº‹ä»¶å¿…é¡»æ˜¯åŒæ­¥æ›´æ–°çš„ï¼Œå¦‚æœä½ éè¦ä½¿ç”¨å¹³æ»‘è¿‡æ¸¡æ¥æ§åˆ¶è¾“å…¥ç»„ä»¶ï¼Œæœ‰å¦‚ä¸‹ä¸¤ç§æ–¹æ¡ˆï¼š

- å®šä¹‰ä¸¤ä¸ª stateï¼Œä¸€ä¸ªç”¨äºæ§åˆ¶è¾“å…¥ï¼Œä¸€ä¸ªç”¨äºç›‘å¬è¾“å…¥å€¼å˜åŒ–ååŒæ­¥æ›´æ–°
- ä½¿ç”¨ [`useDeferredValue`](https://react.dev/reference/react/useDeferredValue) æ¥ä»£æ›¿

2. æˆ‘çš„ state å˜åŒ–ä¼¼ä¹æ²¡æœ‰å®ç°è¿‡æ¸¡ï¼Œè¿˜æ˜¯è¢«é˜»å¡äº†ï¼Ÿ

å› ä¸ºä½ åœ¨ startTransition ä½¿ç”¨å¼‚æ­¥äº†ï¼š

```js
// æ¡ˆä¾‹1
startTransition(() => {
  // âŒ Setting state *after* startTransition call
  setTimeout(() => {
    setPage('/about');
  }, 1000);
});

// æ¡ˆä¾‹2
startTransition(async () => {
  await someAsyncFunction();
  // âŒ Setting state *after* startTransition call
  setPage('/about');
});
```
å¦‚æœéå¾—ä½¿ç”¨ setTimeoutï¼Œå¯ä»¥è¿™æ ·ï¼š

```js
// æ¡ˆä¾‹1
setTimeout(() => {
  startTransition(() => {
    // âœ… Setting state *during* startTransition call
    setPage('/about');
  });
}, 1000);

// æ¡ˆä¾‹2
await someAsyncFunction();
startTransition(() => {
  // âœ… Setting state *during* startTransition call
  setPage('/about');
});
```

3. æˆ‘çš„ä»£ç æ‰§è¡Œé¡ºåºä¸å¤ªå¯¹ï¼šit will print 1, 2, 3:

```js
console.log(1);
startTransition(() => {
  console.log(2);
  setPage('/about');
});
console.log(3);
```
ä½†æ˜¯ï¼Œ1 2 3 å°±åº”è¯¥æ˜¯æœŸæœ›çš„é¡ºåºï¼Œä¸åŒäº setTimeoutï¼ŒstartTransition è¿˜æ˜¯ç«‹å³æ‰§è¡Œå‡½æ•°çš„ï¼Œåªæ˜¯æ¸²æŸ“ä¸åŒæ­¥è€Œå·²ï¼Œä»–çš„ç®€å•å®ç°ç±»ä¼¼äºï¼š

```js
let isInsideTransition = false;

function startTransition(scope) {
  isInsideTransition = true;
  scope();
  isInsideTransition = false;
}

function setState() {
  if (isInsideTransition) {
    // ... schedule a transition state update ...
  } else {
    // ... schedule an urgent state update ...
  }
}
```
å…¶å®šä¹‰ä¸€ä¸ªå…¨å±€å˜é‡ isInsideTransition = trueï¼Œåœ¨æ‰§è¡Œå®Œå›è°ƒå‡½æ•°åï¼Œç½®ä¸º falseï¼›è®¾ç½® state æ—¶åˆ¤æ–­ä¸º true æ—¶è¡¨ç¤ºåœ¨è¿‡æ¸¡ä¸­ï¼Œæ­¤æ—¶æ‰§è¡Œè¿‡æ¸¡çš„æ“ä½œã€‚æ‰€ä»¥å¯ä»¥çœ‹åˆ°ï¼Œä»–å¹¶ä¸é˜»å¡ scope çš„æ‰§è¡Œã€‚


## 2. useDeferredValue

ä¸€ä¸ªå¯ä»¥è®©ä½ å»¶è¿Ÿï¼ˆdeferï¼‰æ›´æ–°UIçš„ hookã€‚

- æ¥æ”¶å‚æ•° valueï¼šä½ æƒ³è¦å»¶è¿Ÿçš„å€¼ï¼Œå¯ä»¥æ˜¯ä»»ä½•ç±»å‹ã€‚
- è¿”å›å€¼ï¼šåœ¨åˆå§‹æ¸²æŸ“æœŸé—´ï¼Œè¿”å›çš„å»¶è¿Ÿå€¼å°†ä¸ä½ æä¾›çš„å€¼ç›¸åŒã€‚åœ¨æ›´æ–°æœŸé—´ï¼ŒReact å°†é¦–å…ˆå°è¯•ä½¿ç”¨æ—§å€¼é‡æ–°æ¸²æŸ“ï¼ˆå› æ­¤å®ƒå°†è¿”å›æ—§å€¼ï¼‰ï¼Œç„¶åå°è¯•ä½¿ç”¨æ–°å€¼åœ¨åå°é‡æ–°æ¸²æŸ“ï¼ˆå› æ­¤å®ƒå°†è¿”å›æ›´æ–°çš„å€¼ï¼‰ã€‚

### ä½¿ç”¨æ¡ˆä¾‹

1. å¼¥è¡¥useTransitionä¸è¶³ï¼šç›‘å¬inputè¾“å…¥å¹¶å¹³æ»‘è¿‡æ¸¡

```js
import { Suspense, useState } from 'react';
import SearchResults from './SearchResults.js';

export default function App() {
  const [query, setQuery] = useState('');
  const deferredQuery = useDeferredValue(query);
  
  return (
    <>
      <label>
        Search albums:
        <input value={query} onChange={e => setQuery(e.target.value)} />
      </label>
      <Suspense fallback={<h2>Loading...</h2>}>
        <SearchResults query={deferredQuery} />
      </Suspense>
    </>
  );
}
```
ä¸Šé¢çš„ä¾‹å­ï¼Œæ¯å½“è¾“å…¥æ¡†è¾“å…¥æ—¶ï¼ŒSuspense çš„ fallback å°†ä¸å†æ¸²æŸ“ï¼Œè€Œæ˜¯ç›´æ¥å¹³æ»‘è¿‡æ¸¡æ˜¾ç¤ºæœ€æ–°çš„å€¼ï¼Œè¿™å°±ä½¿å¾—æ˜¾ç¤ºæ›´åŠ ç¨³å®šï¼Œä¸ä¼šæŠ–åŠ¨ã€‚


![image.png](/img/posts/2023-8-18/2023-8-18-4.png)

ä¸Šå›¾ä¸­ï¼Œè¾“å…¥å€¼ï¼Œè¾“å…¥æ¡†ç«‹é©¬å˜åŒ–ï¼Œä¸‹é¢æ˜¾ç¤ºåŒºåŸŸæ¼”ç¤ºå˜åŒ–ï¼Œä½†ä¸ä¼šæ˜¾ç¤º fallback çš„ loadingã€‚

2. æ·»åŠ æ¸²æŸ“è¿‡åº¦åŠ¨ç”»

åœ¨ä¸Šé¢ä¾‹å­çš„åŸºç¡€ä¸Šï¼Œæ·»åŠ ä¸€ä¸ªé€æ˜æ•ˆæœï¼š

```js
 // æ—§å€¼å’Œæ–°å€¼ä¸ä¸€æ ·ï¼Œè¡¨ç¤ºåœ¨è¿‡æ¸¡ä¸­ï¼Œè¿‡æ¸¡å®Œæ¯•å query ä¼šå˜ä¸ºä¸ deferredQuery ä¸€æ ·
 const isStale = query !== deferredQuery;
 ...
 <Suspense fallback={<h2>Loading...</h2>}>
    <div style={{
      opacity: isStale ? 0.5 : 1,
      transition: isStale ? 'opacity 0.2s 0.2s linear' : 'opacity 0s 0s linear'
    }}>
      <SearchResults query={deferredQuery} />
    </div>
</Suspense>
```
å¦‚å›¾ï¼Œåœ¨è¾“å…¥è¿‡ç¨‹ä¸­ï¼Œç»“æœæ–‡å­—å˜ä¸ºåŠé€æ˜ï¼š

![image.png](/img/posts/2023-8-18/2023-8-18-5.png)

3. ä¼˜åŒ–é•¿åˆ—è¡¨æ¸²æŸ“

SlowList å¯ä»¥ç†è§£ä¸ºä¸€ä¸ªè‚¥è‚ å¤šæ•°æ®çš„é•¿åˆ—è¡¨ï¼Œæ¯ä¸€ä¸ªåˆ—è¡¨éƒ½æœ‰ä¸€ä¸ªå…¬å…±çš„å€¼è¦æ§åˆ¶ï¼Œå«åš deferredTextï¼Œæˆ‘ä»¬è¿™æ ·å®ç°ï¼š

```js
export default function App() {
  const [text, setText] = useState('');
  const deferredText = useDeferredValue(text);
  return (
    <>
      <input value={text} onChange={e => setText(e.target.value)} />
      <SlowList text={deferredText} />
    </>
  );
}

```
è¿™æ ·è¿‡æ¸¡æ˜¯å°±ä¸ä¼šå‡ºç°çŸ­æ—¶é—´ç•Œé¢å¡é¡¿ä¸å¯äº¤äº’çš„æƒ…å†µï¼Œä¸ç„¶å°±ä¼šè¿™æ ·ï¼š

![image.png](/img/posts/2023-8-18/2023-8-18-6.png)

ä¸Šå›¾ä¸ä½¿ç”¨useDeferredValueï¼Œæ²¡è¾“å…¥ä¸€ä¸‹ï¼Œå°±ä¼šå¡ä¸€ä¸‹ï¼Œé¡µé¢é˜»å¡ã€‚ä½¿ç”¨äº† useDeferredValue å°±ä¼šä¸€æ­¥æ¸²æŸ“ï¼Œä¸ä¼šé˜»å¡ä½ è¾“å…¥å•¦ï¼å¯ä»¥å»å®˜ç½‘ä¾‹å­è¯•è¯•ï¼š[codesandbox.io/s/r6hcz2?file=%2FApp.js&utm_medium=sandpack](https://codesandbox.io/s/r6hcz2?file=%2FApp.js&utm_medium=sandpack)

> `SlowList` ç»„ä»¶åº”è¯¥æ”¾åœ¨ memo é‡Œï¼Œä¸ç„¶ä¼˜åŒ–ä¼šå¤±æ•ˆã€‚æ¯æ¬¡deferredTextå˜åŒ–æ—¶ï¼ŒAppç»„ä»·ç”±äºçŠ¶æ€å˜åŒ–äº†ï¼Œä¼šé‡æ–°æ¸²æŸ“ï¼Œå¯¼è‡´ SlowList å˜ä¸ºäº†æ–°çš„ç»„ä»¶äº†ã€‚

-----
å®Œï¼5f:T1850,å®˜ç½‘åœ°å€ï¼š[React](https://react.dev/)

## 1. useId

`useId` æ˜¯ä¸€ä¸ªç”Ÿæˆå”¯ä¸€Idçš„hookã€‚

å…¶ä¸æ¥æ”¶å‚æ•°ï¼Œè¿”å›å€¼å°±æ˜¯ç”Ÿæˆçš„Idï¼Œè¿™ä¸ªIdå¯ä»¥ä¿è¯åœ¨å½“å‰çš„ç»„ä»¶å†…éƒ¨ä¸é‡å¤ï¼Œä¸ç®¡ç»„ä»¶åå¤æ¸²æŸ“å¤šå°‘æ¬¡ã€‚

> æ³¨æ„ï¼Œè¿™å¯æ˜¯ä¸€ä¸ª hookï¼Œä¸èƒ½åœ¨ for å¾ªç¯ä¸­ä½¿ç”¨ï¼Œè¿™å°±å¼ºåˆ¶ä½ å…»æˆå¥½ä¹ æƒ¯ï¼šé¢å‘ç»„ä»¶ç¼–ç¨‹ã€‚

#### ä½¿ç”¨æ¡ˆä¾‹

ä¸€ä¸ªå¯†ç æ¡†ç»„ä»¶ï¼š

```jsx
import { useId } from 'react';

function PasswordField() {
  const passwordHintId = useId();
  return (
    <>
      <label>
        Password:
        <input
          type="password"
          aria-describedby={passwordHintId}
        />
      </label>
      <p id={passwordHintId}>
        The password should contain at least 18 characters
      </p>
    </>
  );
}
```

ä¸Šé¢ä¾‹å­ä¸­ï¼Œaria-describedby æ˜¯ [HTML accessibility](https://developer.mozilla.org/en-US/docs/Web/Accessibility/ARIA)å±æ€§ï¼Œç”¨äºå’Œå…¶ä»–å…ƒç´ å…³è”ä»¥æ–¹ä¾¿é˜…è¯»å™¨è¯»å–ã€‚
 
> ç¬”è€…è®¤ä¸º React ä¸­ useId å¾ˆé¸¡è‚‹ï¼Œä¸èƒ½ç”¨äºå¾ªç¯æ¸²æŸ“åˆ—è¡¨ï¼Œå¤§å¤šæ•°åœºæ™¯éƒ½ä¸å¤ªç”¨çš„ä¸Šï¼Œè‡³å°‘ç›®å‰æ˜¯è¿™æ ·ã€‚

## 2. useSyncExternalStore

ç”¨äºè®¢é˜…ç¬¬ä¸‰æ–¹ store çš„hookã€‚è¿™ä¸ª hook å¯ä»¥è®©æˆ‘ä»¬ä¸ä½¿ç”¨ redux/useReducer/useState æ¥è·å¾—å­˜å‚¨çŠ¶æ€çš„èƒ½åŠ›ã€‚

ä½¿ç”¨æ–¹å¼ï¼š

```js
const snapshot = useSyncExternalStore(subscribe, getSnapshot, getServerSnapshot)
```

å…¶ä¸­ï¼š

- `subscribe`ï¼šè®¢é˜…çš„å›è°ƒå‚æ•°ï¼Œå¯ç”¨äºå­˜å‚¨ storeã€‚å…¶å¿…é¡»è¿”å›ä¸€ä¸ª å–æ¶ˆè®¢é˜…çš„æ¸…ç†å‡½æ•°ã€‚
- `getSnapshot`ï¼šç”¨äºè¿”å›ç»„ä»¶æ‰€éœ€çš„å­˜å‚¨åŒºä¸­çš„æ•°æ®å¿«ç…§çš„å‡½æ•°ã€‚å½“å­˜å‚¨æœªæ›´æ”¹æ—¶ï¼Œå¯¹ getSnapshot çš„é‡å¤è°ƒç”¨å¿…é¡»è¿”å›ç›¸åŒçš„å€¼ã€‚å¦‚æœå­˜å‚¨æ›´æ”¹å¹¶ä¸”è¿”å›å€¼ä¸åŒï¼ˆObject.is ï¼‰ï¼Œå³ä¸æ˜¯çº¯å‡½æ•°ï¼ŒReact å°†é‡æ–°æ¸²æŸ“ç»„ä»¶
- `getServerSnapshot`ï¼šå¯é€‰å‚æ•°ã€‚è¿”å›å­˜å‚¨ä¸­æ•°æ®çš„åˆå§‹å¿«ç…§çš„å‡½æ•°ã€‚ä»…åœ¨ æœåŠ¡ç«¯æ¸²æŸ“æœŸé—´æˆ–è€…å®¢æˆ·ç«¯ hydration æ—¶ä½¿ç”¨ã€‚å¦‚æœçœç•¥æ­¤å‚æ•°ï¼ŒSSRåº”ç”¨ä¸­ï¼ŒæœåŠ¡å™¨ä¸Šå‘ˆç°ç»„ä»¶å°†å¼•å‘é”™è¯¯ã€‚
- `snapshot`: å½“å‰ store çš„å¿«ç…§ (æ˜¯ store çš„æ·±æ‹·è´)

### ä½¿ç”¨æ¡ˆä¾‹

- 1ã€è‡ªå®šä¹‰ store å®ç° todoListï¼š

```js
import { useSyncExternalStore } from 'react';
import { todosStore } from './todoStore.js';

export default function TodosApp() {
  const todos = useSyncExternalStore(todosStore.subscribe, todosStore.getSnapshot);
  return (
    <>
      <button onClick={() => todosStore.addTodo()}>Add todo</button>
      <hr />
      <ul>
        {todos.map(todo => (
          <li key={todo.id}>{todo.text}</li>
        ))}
      </ul>
    </>
  );
}

// todoStore.js
let nextId = 0;
let todos = [{ id: nextId++, text: 'Todo #1' }];
let listeners = [];

export const todosStore = {
  addTodo() {
    todos = [...todos, { id: nextId++, text: 'Todo #' + nextId }]
    emitChange();
  },
  subscribe(listener) {
    listeners = [...listeners, listener];
    return () => {
      listeners = listeners.filter(l => l !== listener);
    };
  },
  getSnapshot() {
    return todos;
  }
};

function emitChange() {
  for (let listener of listeners) {
    listener();
  }
}
```

ä¸Šé¢çš„ä¾‹å­ï¼Œè‡ªå®šä¹‰çš„ subscribe è¯»å–äº†æ‰€æœ‰ç›‘å¬å™¨å‡½æ•°ï¼Œä½¿ç”¨æ•°ç»„æ¥ç»´æŠ¤ã€‚æ¸…ç†å‡½æ•°ä¸­ï¼Œè¿‡æ»¤æ‰äº†å½“å‰çš„ç›‘å¬å™¨ï¼› getSnapshot åˆ™è¿”å›äº† storeã€‚

> ä¸€èˆ¬ä¸Šï¼Œ`useSyncExternalStore` API é€šå¸¸ç”¨äºé›†æˆ non-React ä»£ç .

- 2,ã€ä¼ é€’ä¸€ä¸ªç›‘å¬äº‹ä»¶ï¼Œåˆ¤æ–­å½“å‰ç½‘ç»œè¿æ¥çŠ¶æ€ï¼š

```js
import { useSyncExternalStore } from 'react';

export default function ChatIndicator() {
  const isOnline = useSyncExternalStore(subscribe, getSnapshot);
  return <h1>{isOnline ? 'âœ… Online' : 'âŒ Disconnected'}</h1>;
}

function getSnapshot() {
  return navigator.onLine;
}

function subscribe(callback) {
  window.addEventListener('online', callback);
  window.addEventListener('offline', callback);
  return () => {
    window.removeEventListener('online', callback);
    window.removeEventListener('offline', callback);
  };
}
```
ä¸Šé¢çš„è®¢é˜…äº‹ä»¶ä¸­ï¼Œç›‘å¬äº†åŸç”Ÿ online äº‹ä»¶ï¼Œå°†ç›‘å¬å™¨å½“åšå›è°ƒ callbackï¼Œè¿™æ ·ï¼Œå½“ navigator.onLine å˜åŒ–æ—¶ï¼ŒisOnline å°±ä¼šæ”¹å˜ã€‚

- 3ã€ä¸è‡ªå®šä¹‰ hook ç»„åˆ

ä¸Šé¢çš„ä¾‹å­ï¼Œæˆ‘ä»¬å°†è¿™ä¸ªå°è£…åœ¨ä¸€ä¸ª hook é‡Œï¼š

```js
export function useOnlineStatus() {
  const isOnline = useSyncExternalStore(subscribe, getSnapshot);
  return isOnline;
}

...
```
ç°åœ¨å°±å¯ä»¥åœ¨å…¶ä»–ç»„ä»¶ä¸­ä½¿ç”¨äº†ï¼š

```js
function StatusBar() {
  const isOnline = useOnlineStatus();
  return <h1>{isOnline ? 'âœ… Online' : 'âŒ Disconnected'}</h1>;
}
```

- 4ã€æœåŠ¡ç«¯æ¸²æŸ“æ—¶é…ç½®

å¦‚æœä½¿ç”¨äº†æœåŠ¡ç«¯æ¸²æŸ“ï¼Œè¿™å°±æ„å‘³ç€ä½ ä¸èƒ½å†ä½¿ç”¨æµè§ˆå™¨è‡ªå¸¦çš„APIï¼Œä¸Šé¢åˆ¤æ–­æ˜¯å¦åœ¨çº¿çš„ä¾‹å­å°±ä¸æˆç«‹äº†ã€‚æˆ‘ä»¬å¯ä»¥å¦‚ä¸‹å†™ï¼š

```js
import { useSyncExternalStore } from 'react';

export function useOnlineStatus() {
  const isOnline = useSyncExternalStore(subscribe, getSnapshot, getServerSnapshot);
  return isOnline;
}

function getSnapshot() {
  return navigator.onLine;
}

function getServerSnapshot() {
  return true; // Always show "Online" for server-generated HTML
}

function subscribe(callback) {
  // ...
}
```
ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œé€šè¿‡ç¬¬ä¸‰ä¸ªå‚æ•° getServerSnapshot é…ç½®SSRï¼Œreturn å€¼å°±æ˜¯æ¸²æŸ“æ—¶è·å–åˆ°çš„ store çš„å€¼ã€‚

getServerSnapshot å‡½æ•°ç±»ä¼¼äº getSnapshotï¼Œä½†å®ƒä»…åœ¨ä¸¤ç§æƒ…å†µä¸‹æ‰§è¡Œï¼š

1. ç”Ÿæˆ HTML æ—¶ï¼Œåœ¨æœåŠ¡å™¨ä¸Šè¿è¡Œã€‚
2. å®ƒåœ¨ [hydration](https://react.dev/reference/react-dom/client/hydrateRoot) æœŸé—´åœ¨å®¢æˆ·ç«¯ä¸Šè¿è¡Œï¼Œå³å½“ React è·å–æœåŠ¡å™¨ HTML å¹¶ä½¿å…¶äº¤äº’æ—¶ã€‚

ä»–æä¾›ä¸€ä¸ªåœ¨é¡µé¢å¯äº¤äº’ä¹‹å‰çš„åˆå§‹å¿«ç…§å€¼ã€‚å¦‚æœæœåŠ¡å™¨å‘ˆç°æ²¡æœ‰æœ‰æ„ä¹‰çš„åˆå§‹å€¼ï¼Œåˆ™ä¼šå¿½ç•¥æ­¤å‚æ•°å¹¶å¼ºåˆ¶åœ¨å®¢æˆ·ç«¯ä¸Šæ¸²æŸ“ã€‚

> ä½¿ç”¨æ—¶éœ€ç¡®ä¿ getServerSnapshot åœ¨åˆå§‹å®¢æˆ·ç«¯æ¸²æŸ“ä¸Šè¿”å›çš„æ•°æ®ä¸åœ¨æœåŠ¡å™¨ä¸Šè¿”å›çš„æ•°æ®å®Œå…¨ç›¸åŒã€‚

> ä¾‹å¦‚ï¼Œå¦‚æœ getServerSnapshot åœ¨æœåŠ¡å™¨ä¸Šè¿”å›äº†ä¸€äº›é¢„å¡«å……çš„å­˜å‚¨å†…å®¹ï¼Œåˆ™éœ€è¦å°†æ­¤å†…å®¹ä¼ è¾“åˆ°å®¢æˆ·ç«¯ã€‚ä¸€ç§æ–¹æ³•æ˜¯åœ¨æœåŠ¡å™¨æ¸²æŸ“æœŸé—´æ‰“ä¸€ä¸ª\<script>æ ‡ç­¾ï¼Œç”¨äºè®¾ç½®å…¨å±€å˜é‡ï¼Œç±»ä¼¼ `window.MY_STORE_DATA`ï¼Œç„¶ååœ¨ getServerSnapshot ä¸­ä»å®¢æˆ·ç«¯ä¸Šå…¨å±€è¯»å–ã€‚

----
å®Œï¼60:T2984,- å®˜ç½‘åœ°å€ï¼š[React](https://beta.reactjs.org/)

## 1. useContext

`useContext` æ˜¯ä¸€ä¸ªä¼ é€’ç»„ä»¶ä¸Šä¸‹æ–‡çš„é’©å­ï¼Œæä¾›è¯»å–å’Œè®¢é˜…åŠŸèƒ½ã€‚


### æ¥æ”¶å‚æ•°

- contextï¼šæ˜¯ [`createContext`](https://react.dev/reference/react/createContext) åˆ›å»ºå‡ºæ¥çš„å¯¹è±¡ï¼Œä»–ä¸ä¿æŒä¿¡æ¯ï¼Œä»–æ˜¯ä¿¡æ¯çš„è½½ä½“ã€‚å£°æ˜äº†å¯ä»¥ä»ç»„ä»¶è·å–æˆ–è€…ç»™ç»„ä»¶æä¾›ä¿¡æ¯ã€‚åœ¨ provider ä¸­å¯ä»¥ä¼ é€’å…·ä½“çš„å€¼ã€‚

### è¿”å›å€¼

- contextValueï¼šè¿”å›ä¼ é€’çš„åªè¯»contextè½½ä½“çš„å€¼ã€‚æ˜¯è°ƒç”¨å †æ ˆä¸­ç»„ä»¶ä¸Šæ–¹æœ€è¿‘çš„ SomeContext.Provider å‡ºæ¥çš„å€¼ã€‚å¦‚æœæ²¡æœ‰è¿™æ ·çš„Providerï¼Œåˆ™è¿”å›çš„å€¼å°†æ˜¯ä¼ é€’ç»™è¯¥contextçš„ createContext çš„ defaultValueã€‚å…¶è¿”å›çš„å€¼å§‹ç»ˆæ˜¯æœ€æ–°çš„ã€‚å¦‚æœä¸Šä¸‹æ–‡å‘ç”Ÿå˜åŒ–ï¼ŒReact ä¼šè‡ªåŠ¨é‡æ–°æ¸²æŸ“è¯»å–contextçš„ç»„ä»¶ã€‚

### æ³¨æ„äº‹é¡¹

- useContext() ä¸å—åŒä¸€ç»„ä»¶å†…`<Context.Provider>`çš„å½±å“ã€‚useContext è¦æƒ³æ‹¿åˆ° provideræä¾›çš„ä¸Šä¸‹æ–‡ï¼Œä¸€å®šæ”¾åœ¨`<Context.Provider>`å†…éƒ¨åµŒå¥—çš„ç»„ä»¶ä¸­ã€‚
- `<Context.Provider>`ä¼ é€’çš„contextçš„å€¼ï¼Œå¦‚æœå€¼å˜åŒ–äº†ï¼ˆObject.is åˆ¤æ–­æ³•ï¼‰ï¼Œå…¶ä¸‹å„çº§ç»„ä»¶å°±ä¼šè§¦å‘é‡æ–°æ¸²æŸ“ã€‚å¯ä½¿ç”¨ memo è¿™ä¸ªAPIæ¥é˜»æ­¢é‡æ¸²æŸ“ã€‚
- ç¡®ä¿ä¼ é€’contextçš„å¯¹è±¡å’Œè¯»å–contextçš„å¯¹è±¡æ˜¯åŒä¸€ä¸ªcontextï¼Œæœ€å¥½æå–ä¸ºå…¬å…±ç»„ä»¶ï¼Œä½¿ç”¨æ—¶å¼•ç”¨è¿™ä¸ªå•ä¾‹å³å¯ã€‚

> useContext() æ€»æ˜¯åœ¨è°ƒç”¨å®ƒçš„ç»„ä»¶ä¸Šçº§å¯»æ‰¾æœ€æ¥è¿‘çš„Providerã€‚å®ƒé€çº§å‘ä¸Šæœç´¢ï¼Œå¹¶ä¸”æ’é™¤æ‰ ä½¿ç”¨ useContext() çš„åŒçº§ç»„ä»¶ä¸­çš„Providerã€‚

### å„ç§å‚è€ƒæ¡ˆä¾‹

#### 1. ä¼ é€’ä¸»é¢˜é¢œè‰²

åˆ›å»ºä¸€ä¸ª contextï¼š

```js
const ThemeContext = createContext(null);
```

å®šä¹‰æ ¹ç»„ä»¶ï¼š

```js
export default function MyApp() {
  return (
    <ThemeContext.Provider value="dark">
      <Form />
    </ThemeContext.Provider>
  )
}
```
ä»–å¾€ä¸‹æä¾›äº†ä¸€ä¸ª context çš„åˆå§‹å€¼ï¼Œå« darkã€‚åœ¨å­ç»„ä»¶ä¸­ï¼Œä½¿ç”¨ useContext å¼•å…¥ ThemeContextï¼Œè·å–åˆ°è¿™ä¸ªcontextè½½ä½“å…·ä½“çš„å€¼ï¼š

```js
function Panel({ title, children }) {
  const theme = useContext(ThemeContext);
  const className = 'panel-' + theme;
  return (
    <section className={className}>
      <h1>{title}</h1>
      {children}
    </section>
  )
}
```

#### 2. åˆ‡æ¢ä¸»é¢˜é¢œè‰²

åœ¨ä¸Šé¢çš„åŸºç¡€ä¸Šï¼Œæˆ‘ä»¬æ·»åŠ æ›´æ–°ä¸»é¢˜é¢œè‰²çš„åŠŸèƒ½ã€‚é¦–å…ˆåœ¨æ ¹ç»„ä»¶åŠ å…¥ä¸»é¢˜çš„stateå’Œæ”¹å˜çš„è¡¨å•å…ƒç´ ï¼š

```js
// MyApp
const [theme, setTheme] = useState('light');

// ...
<ThemeContext.Provider value={theme}>
   // ...
   <input
      type="checkbox"
      checked={theme === 'dark'}
      onChange={(e) => {
        setTheme(e.target.checked ? 'dark' : 'light')
      }}
    />
// ...
</ ThemeContext.Provider>
```

ç”±äº context æ˜¯åªè¯»çš„ï¼Œæ‰€ä»¥å­ç»„ä»¶ä¸éœ€è¦ä»»ä½•ä¿®æ”¹ã€‚æ ¹ç»„ä»¶ä¸­ç‚¹å‡» checkbox å°±å¯ä»¥æ”¹å˜å­ç»„ä»¶ä¸­çš„ classname äº†ã€‚


#### 3. å¤šcontextåµŒå¥—çš„æƒ…å†µ

æˆ‘ä»¬åœ¨æ ¹ç»„ä»¶ä¸­å®šä¹‰ä¸¤ä¸ª Providerï¼š

```js
const ThemeContext = createContext(null);
const CurrentUserContext = createContext(null);

// ...

<ThemeContext.Provider value={theme}>
  <CurrentUserContext.Provider
    value={{
      currentUser,
      setCurrentUser
    }}
  >
    <WelcomePanel />
// ...
  </ CurrentUserContext.Provider>
</ ThemeContext.Provider>
```

è¿™æ ·åœ¨å­ç»„ä»¶ WelcomePanel ä¸­å°±å¯ä»¥è·å–ï¼š

```js
const {currentUser} = useContext(CurrentUserContex);
const {theme} = useContext(ThemeContext);
```
å¯ä»¥çœ‹åˆ°ï¼Œé€šè¿‡ä¸åŒçš„ context è½½ä½“ï¼Œå¯ä»¥è·å–åˆ°ä¸åŒä½œç”¨åŸŸçš„å€¼ã€‚

#### 4. å°è£…ä¸ºé«˜é˜¶ç»„ä»¶ï¼

ä¸Šé¢çš„ä»£ç ï¼Œcontext éƒ½äº¤ç»™æ ¹ç»„ä»¶ç»´æŠ¤ï¼Œä»£ç è€¦åˆæ€§æ¯”è¾ƒé«˜ï¼Œå¯ä»¥ç»Ÿä¸€æå‡ºæ¥ä¸€ä¸ªæ–°ç»„ä»¶MyProvidersï¼š

```js
function MyProviders({ children, theme }) {
  const [currentUser, setCurrentUser] = useState(null);
  return (
    <ThemeContext.Provider value={theme}>
      <CurrentUserContext.Provider
        value={{
          currentUser,
          setCurrentUser
        }}
      >
        {children}
      </CurrentUserContext.Provider>
    </ThemeContext.Provider>
  );
}
```

è¿™æ ·å†åº”ç”¨è¿™ä¸ªç»„ä»¶å°±ä¼šæ–¹ä¾¿å¾ˆå¤šï¼š

```js
<MyProviders theme={theme} setTheme={setTheme}>
  // ...
</MyProviders>
```

> P.S. ä¸Šé¢çš„ä¾‹å­æœ‰æ²¡æœ‰æ³¨æ„åˆ°ï¼Œä¸€ä¸ªå…¨å±€çš„ Contextï¼ŒåŠ ä¸Š useReducerï¼ˆuseStateï¼‰ å°±æ˜¯ä¸€ä¸ªå°å‹çš„ reduxï¼Œæ¯”å¦‚ä¸‹é¢çš„[ä¾‹å­](https://codesandbox.io/s/3pzgg8?file=/AddTask.js&utm_medium=sandpack)ï¼š

```js
export function TasksProvider({ children }) {
  const [tasks, dispatch] = useReducer(
    tasksReducer,
    initialTasks
  );

  return (
    <TasksContext.Provider value={tasks}>
      <TasksDispatchContext.Provider value={dispatch}>
        {children}
      </TasksDispatchContext.Provider>
    </TasksContext.Provider>
  );
}
```

#### 5. åŒä¸€ä¸ªcontextï¼Œå±€éƒ¨ä¿®æ”¹çŠ¶æ€

æ¯”å¦‚åœ¨å…¨å±€ç™½è‰²èƒŒæ™¯ä¸‹ï¼Œæƒ³è¦åœ¨å±€éƒ¨çš„ç»„ä»¶ä¸­ä½¿ç”¨å…¶ä»–ä¸»é¢˜è‰²ï¼Œå¯ä»¥è¿™æ ·å®šä¹‰ï¼š

```js
<ThemeContext.Provider value="light">
  ...
  <ThemeContext.Provider value="dark">
    <Footer />
  </ThemeContext.Provider>
  ...
</ThemeContext.Provider>
```

#### 6. æ€§èƒ½ä¼˜åŒ–ï¼šåœ¨ä¼ å€¼æ—¶é¿å…ä¸å¿…è¦çš„é‡æ¸²æŸ“

è€ƒè™‘ä¸‹é¢çš„ä¾‹å­ï¼š

```js
<AuthContext.Provider value={{ currentUser, login }}></ AuthContext.Provider>
```

ä¼ é€’çš„contextæ˜¯ä¸€ä¸ªå¯¹è±¡(currentUser)å’Œä¸€ä¸ªå‡½æ•°(login)ï¼Œåœ¨é¡¶å±‚ç»„ä»¶é‡æ¸²æŸ“æ—¶ï¼Œä»–ä»¬å¯èƒ½ä¼šè¢«é‡æ–°åˆ›å»ºï¼Œè¿›è€Œé€ æˆcontexté‡æ¸²æŸ“ã€‚æ‰€ä»¥è¿™é‡Œå¯¹æ³¨å…¥çš„è¢«å­—é¢é‡å€¼ä¹Ÿè¦åšç¼“å­˜ï¼š

```js
const login = useCallback((response) => {...})

const contextValue = useMemo(() => ({  
  currentUser,  
  login  
}), [currentUser, login]);

// ä½¿ç”¨
<AuthContext.Provider value={contextValue}></ AuthContext.Provider>
// ...
```

### Q&A

#### 1. æˆ‘çš„ç»„ä»¶ä¸ºä»€ä¹ˆæ‹¿ä¸åˆ°contextæä¾›çš„æ•°æ®

æ’æŸ¥å¯èƒ½çš„åŸå› ï¼š

- ä½ åœ¨ `<SomeContext.Provider>` åŒä¸€çº§ç»„ä»¶ä¸­ä½¿ç”¨äº† useContext() 
- ä½ æ²¡æœ‰ç”¨ `<SomeContext.Provider>` åŒ…è£¹ä¸Šçº§ç»„ä»¶
- ç”±äºæ‰“åŒ…é—®é¢˜æˆ–è€…ä»£ç å¼•å…¥çš„é—®é¢˜ï¼Œä½ æä¾›contextçš„åœ°æ–¹å’Œä½¿ç”¨contextçš„åœ°æ–¹ï¼Œå¼•ç”¨çš„ä¸æ˜¯ä¸€ä¸ªContextå¯¹è±¡ã€‚æ¯”å¦‚ä½ ä½¿ç”¨å…¨å±€å˜é‡æŒ‚è½½äº†å¤šä¸ª contextï¼š`window.SomeContext1`Â andÂ `window.SomeContext2`ï¼Œä½ éœ€è¦ä½¿ç”¨ `===` æå‰åˆ¤æ–­æ˜¯å¦ç›¸åŒã€‚


#### 2. å³ä½¿æˆ‘è®¾ç½®äº†åˆå§‹å€¼ï¼Œä½†æ˜¯æ€»æ˜¯åœ¨è·å–å€¼çš„æ—¶å€™æ‹¿åˆ° `undefined`

ä½ åœ¨ Provider æ—¶å¿˜è®°ä¼ é€’ value å±æ€§äº†ã€‚

## 2. useRef

ç”¨äºè®¾ç½®ä¸€ä¸ªå¯å˜çš„å¼•ç”¨å€¼ï¼Œä¸éšç»„ä»¶æ¸²å˜åŒ–ã€‚ä¸ `useState` ä¸åŒï¼Œ`useRef` è¿”å›çš„å¼•ç”¨å¯¹è±¡åœ¨ç»„ä»¶é‡æ–°æ¸²æŸ“æ—¶ä¿æŒä¸å˜ï¼Œè®¾ç½®å¼•ç”¨å€¼ä¹Ÿä¸ä¼šè§¦å‘ç»„ä»¶çš„é‡æ–°æ¸²æŸ“ã€‚

> P.S. ç”±äº useRef æ˜¯ä¸€ä¸ªå¼•ç”¨ï¼Œå…¶å†…éƒ¨çš„å€¼æ˜¯ä¸€ä¸ª current å¯¹è±¡æ¥æ¥å—çš„ï¼Œæ‰€ä»¥æœ‰äº›ä¸ç¡®å®šæ˜¯å¦æœ‰åˆå§‹å€¼çš„æƒ…å†µä¸‹ï¼Œéœ€è¦åˆ¤æ–­ ref.current æ˜¯å¦ä¸ºç©ºã€‚

### å‚è€ƒæ¡ˆä¾‹

###### 1. ç‚¹å‡»è®¡æ•°å™¨

æ³¨æ„ï¼Œè¿™ä¸ªè®¡æ•°å€¼çš„å˜åŒ–ï¼Œä¸ä¼šå¼•èµ·ç»„ä»¶é‡æ¸²æŸ“ï¼Œåœ¨ä¸éœ€è¦æ¸²æŸ“çš„åœºåˆé€‚ç”¨ã€‚æ‰€ä»¥åœ¨jsxä¸­è¿™ä¹ˆå†™æ˜¯ä¸ä¼šèµ·ä½œç”¨çš„ âŒï¼š`<span>{ref.current}</span>`

```js
let ref = useRef(0);

function handleClick() {
  ref.current = ref.current + 1;
  alert('You clicked ' + ref.current + ' times!');
}
```

###### 2. è·å–inputçš„ç„¦ç‚¹

useRef å¯ä»¥æŒ‚è½½åœ¨åŸç”Ÿå…ƒç´ ä¸Šæ¥è·å–å…¶DOMå¯¹è±¡æœ¬èº«ã€‚

```js
const inputRef = useRef(null);

function handleClick() {
  inputRef.current.focus();
}

<input ref={inputRef} />
```

###### 3. æ§åˆ¶å…ƒç´ æ»šåŠ¨

H5 æœ‰ä¸ªAPIå« `scrollIntoView`, è·å–åˆ° DOM å…ƒç´ åå¯ä»¥æ§åˆ¶å°†å…¶æ»šåŠ¨åˆ°ç‰¹å®šçš„ä½ç½®ï¼š

```js
const listRef = useRef(null);

function scrollToIndex(index) {
    const listNode = listRef.current;
    // This line assumes a particular DOM structure:
    const imgNode = listNode.querySelectorAll('li > img')[index];
    imgNode.scrollIntoView({
      behavior: 'smooth',
      block: 'nearest',
      inline: 'center'
    });
}

// ...
<ul ref={listRef}>
  <li onClick={scrollToIndex(0)}><img ... /></li>
  <li onClick={scrollToIndex(1)}><img ... /></li>
  <li onClick={scrollToIndex(2)}><img ... /></li>
</ul>
```

###### 4. æ§åˆ¶ video æ’­æ”¾

```js
// æ§åˆ¶æ–¹æ³•ä»£ç ç‰‡æ®µ
if (!isPlaying) {
  ref.current.play();
} else {
  ref.current.pause();
}

...
// dom å®šä¹‰
<video
    width="250"
    ref={ref}
    onPlay={() => setIsPlaying(true)}
    onPause={() => setIsPlaying(false)}
  >
    <source
      src="https://interactive-examples.mdn.mozilla.net/media/cc0-videos/flower.mp4"
      type="video/mp4"
    />
</video>
```

###### 5. è‡ªå®šä¹‰ç»„ä»¶è®¾ç½® ref å±æ€§

å› ä¸ºé»˜è®¤å‡½æ•°å¼ç»„ä»¶ä¸ä¼šå¾€å¤–æš´éœ² refs å±æ€§ï¼Œæ‰€ä»¥æˆ‘ä»¬é¦–å…ˆè¦ç”¨ `forwardRef` å°†æˆ‘ä»¬çš„è‡ªå®šä¹‰ç»„ä»¶åŒ…è£¹åå¯¼å‡ºï¼š

```js
// å°† ref ç»™åˆ° input
const MyInput = forwardRef((props, ref) => {
  return <input {...props} ref={ref} />;
});
```
æ¥ç€åœ¨çˆ¶ç»„ä»¶ä¸­ä½¿ç”¨åŒ…è£¹å¥½çš„ç»„ä»¶ï¼š

```js
<MyInput ref={inputRef} />
```
ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œæƒ³è¦æ‹¿åˆ°å­ç»„ä»¶å†…éƒ¨çš„ input å…ƒç´ å®ä¾‹ï¼Œåªéœ€ï¼š

```js
inputRef.current.focus();
```

## 3. useImperativeHandle

è¿™ä¸ª hook éœ€è¦ç»“åˆ ref ä½¿ç”¨ï¼Œç”¨äºæ§åˆ¶åœ¨è‡ªå®šä¹‰ç»„ä»¶ä¸­å‘å¤–æš´éœ²å“ªäº›ç»„ä»¶å±æ€§æˆ–æ–¹æ³•ã€‚

ä¸Šé¢çš„ useRef åªèƒ½æ§åˆ¶è‡ªå®šä¹‰ç»„ä»¶æœ¬èº«çš„ DOMï¼Œå¦‚æœæƒ³è¦åœ¨çˆ¶ç»„ä»¶è°ƒç”¨å­ç»„ä»¶æœ¬èº«çš„æˆå‘˜æ–¹æ³•ï¼Œå°±éœ€è¦ç»“åˆ `useImperativeHandle` æ¥ä½¿ç”¨äº†ã€‚

### æ¥æ”¶å‚æ•°

- refï¼šç»„ä»¶forwardRefåŒ…è£¹åæš´éœ²å‡ºæ¥çš„ref
- æ§åˆ¶å‡½æ•°ï¼šå…¶è¿”å›å€¼æ˜¯ä¸ªå¯¹è±¡ï¼Œåˆ—ä¸¾äº†æš´éœ²çš„æ–¹æ³•çš„å˜é‡

### å‚è€ƒæ¡ˆä¾‹

###### 1. å°è£…ä¸€ä¸‹ä¸Šé¢èšç„¦inputçš„åŠŸèƒ½

æˆ‘ä»¬å°†ä¸Šé¢åœ¨çˆ¶ç»„ä»¶ä¸­ä½¿ç”¨ `inputRef.current.focus();` çš„è¿‡ç¨‹ï¼Œåœ¨å­ç»„ä»¶ä¸­æš´éœ²æˆä¸€ä¸ªæ–¹æ³•ï¼š

```js
// MyInput
useImperativeHandle(ref, () => {
    return {
      focus() {
        inputRef.current.focus();
      },
    }
})
```

åœ¨çˆ¶ç»„ä»¶ä¸­ä½¿ç”¨ï¼š

```jsx
ref.current.focus();

...
<MyInput label="Enter your name:" ref={ref} />
```

###### 2. æš´éœ²å­ç»„ä»¶çš„æ–¹æ³•ç»™çˆ¶ç»„ä»¶

å­ç»„ä»¶ï¼š

```js
useImperativeHandle(ref, () => ({
  getData: () => getData(filter),
  refreshTable: () => refreshTable()
}));
```

çˆ¶ç»„ä»¶ï¼š

```js
tableRef.current && tableRef.current.refreshTable();

...
<CommonTable loading={loading} ref={tableRef}>...</CommonTable>
```

ä¸Šé¢çš„ä»£ç ï¼Œå®ç°äº†åœ¨è‡ªå®šä¹‰è¡¨æ ¼ç»„ä»¶æ—¶ï¼Œé€šè¿‡çˆ¶ç»„ä»¶æ¥è°ƒç”¨è¡¨æ ¼ç»„ä»¶å†…éƒ¨æ–¹æ³•é‡æ–°è·å–æ•°æ®å’ŒåŸåœ°åˆ·æ–°çš„åŠŸèƒ½ã€‚

> P.S. ä¸è¦è¿‡åº¦ä½¿ç”¨ refs åŠŸèƒ½ã€‚ä»…ä»…éœ€è¦åœ¨ä¸€äº›èšç„¦ã€æ»šåŠ¨ã€åŠ¨ç”»å’Œé€‰ä¸­ç­‰ç­‰ä¸èƒ½é€šè¿‡propsä¼ é€’çš„å‘½ä»¤å¼çš„è¡Œä¸ºä¸Šä½¿ç”¨å³å¯ã€‚ä¸Šé¢çš„çˆ¶ç»„ä»¶è°ƒç”¨å­ç»„ä»¶çš„ä¾‹å­ï¼Œå®Œå…¨å¯ä»¥ç”¨ useEffect + props æˆ–è€… Events è§£å†³ã€‚61:T3fca,- å®˜ç½‘åœ°å€ï¼š[React](https://beta.reactjs.org/)

## 1. ä½¿ç”¨åœºæ™¯å¯¹æ¯”

- `useEffect`: ç”¨äºå‰¯ä½œç”¨æ•è·ï¼Œåœ¨ dom å…ƒç´ æ¸²æŸ“ä¹‹åè°ƒç”¨ï¼Œå¸¸ç”¨äºé¡µé¢æ•°æ®å¤„ç†å·¥ä½œã€‚
- `useLayoutEffect`: useEffect çš„ä¸€ä¸ªç‰ˆæœ¬ï¼Œåœ¨ DOM æ›´æ–°ä¹‹ååŒæ­¥æ‰§è¡Œï¼Œä½†åœ¨æµè§ˆå™¨ç»˜åˆ¶ä¹‹å‰æ‰§è¡Œï¼Œå¸¸ç”¨äºé¡µé¢å…ƒç´ å¸ƒå±€å·¥ä½œï¼Œå¯èƒ½ä¼šé˜»å¡é¡µé¢æ¸²æŸ“ã€‚
- `useInsertionEffect`: useEffect çš„ä¸€ä¸ªç‰ˆæœ¬ï¼Œåœ¨ DOM æ›´æ–°å‰æ‰§è¡Œã€‚å¸¸ç”¨äº CSS-in-JS æ’å…¥åŠ¨æ€æ ·å¼ã€‚


## 2. useEffect

useEffect æ˜¯ä¸€ä¸ªæ•è·å‰¯ä½œç”¨çš„å‡½æ•°ï¼Œç”¨æ¥ä»£æ›¿ç±»å¼ç»„ä»¶ä¸­ç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸå‡½æ•°ã€‚å£°æ˜æ–¹å¼å¦‚ä¸‹ï¼š

```js
useEffect(setup, dependencies)
```

### å‚è€ƒèŒƒä¾‹

æ³¨æ„éœ€åœ¨ç»„ä»¶é¡¶å±‚ä½¿ç”¨

```js
function ChatRoom({ roomId }) {
  const [serverUrl, setServerUrl] = useState('https://localhost:1234');

  useEffect(() => {
    const connection = createConnection(serverUrl, roomId);
    connection.connect();
    return () => {
      connection.disconnect();
    };
  }, [serverUrl, roomId]);
  // ...
}
```

### æ¥æ”¶å‚æ•°

1. setupï¼šå…·æœ‰ Effect é€»è¾‘çš„è®¾ç½®å‡½æ•°ã€‚å½“ä½ çš„ç»„ä»¶è¢«æ·»åŠ åˆ° DOM æ—¶ï¼ŒReact å°†è¿è¡Œä½ çš„è®¾ç½®å‡½æ•°ã€‚åœ¨æ¯æ¬¡ä½¿ç”¨æ›´æ”¹çš„ä¾èµ–é¡¹é‡æ–°æ¸²æŸ“åï¼ŒReact å°†é¦–å…ˆä½¿ç”¨æ—§å€¼è¿è¡Œæ¸…ç†å‡½æ•°ï¼ˆå¦‚æœä½ æä¾›äº†å®ƒï¼‰ï¼Œç„¶åä½¿ç”¨æ–°å€¼è¿è¡Œä½ çš„è®¾ç½®å‡½æ•°ã€‚åœ¨ä½ çš„ç»„ä»¶ä» DOM ä¸­ç§»é™¤åï¼ŒReact å°†è¿è¡Œä½ çš„æ¸…ç†å‡½æ•°ã€‚

å…¶ä¸­æ¸…ç†å‡½æ•°èŒƒä¾‹å¦‚ä¸‹ï¼š

```js
useEffect(
    // è®¾ç½®å‡½æ•°
    () => {
        const connection = createConnection(serverUrl, roomId);
        connection.connect();

        // æ¸…ç†å‡½æ•°
        return () => {
            connection.disconnect();
        };
    },
    // ä¾èµ–
    [serverUrl, roomId]
);
```
2. ä¾èµ–é¡¹ï¼ˆå¯é€‰ï¼‰ï¼šæ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œé€šè¿‡ `Object.is` æ¥ä¾æ¬¡åˆ¤æ–­å„ä¸ªä¾èµ–é¡¹æ˜¯å¦å˜åŒ–ï¼Œè‹¥æœ‰è‡³å°‘ä¸€ä¸ªå‘ç”Ÿå˜åŒ–ï¼Œåˆ™æ‰§è¡Œè®¾ç½®å‡½æ•°å’Œæ¸…ç†å‡½æ•°ã€‚å¦‚æœæœ‰å¤šä¸ªä¾èµ–é¡¹æ›´æ–°ï¼Œåœ¨ä¸€ä¸ªfiberæ›´æ–°å‘¨æœŸå†…ï¼Œè®¾ç½®å‡½æ•°å’Œæ¸…ç†å‡½æ•°ä¹Ÿ**åªä¼šæ‰§è¡Œä¸€æ¬¡**ã€‚è‹¥çœç•¥æ­¤å‚æ•°ï¼Œè®¾ç½®å‡½æ•°å’Œæ¸…ç†å‡½æ•°å°†åœ¨æ¯æ¬¡ç»„ä»¶æ¸²æŸ“æ—¶æ‰§è¡Œã€‚

### è¿”å›å‚æ•°

undefined

### æ³¨æ„äº‹é¡¹

1. ä»–æ˜¯ä¸€ä¸ªhookï¼Œåªèƒ½åœ¨å‡½æ•°å¼ç»„ä»¶æœ€å¤–å±‚ä½¿ç”¨ï¼Œä¸”ä¸èƒ½æ”¾åœ¨å¾ªç¯å’Œæ¡ä»¶è¯­å¥ä¸­ã€‚
2. ä»–çš„ä½œç”¨æ˜¯æ£€æµ‹ä¾èµ–é¡¹å˜åŒ–åæ‰§è¡Œï¼Œè‹¥ä¸ºç©ºæ•°ç»„ä¾èµ–ï¼Œåˆ™é»˜è®¤åœ¨ç»„ä»¶æŒ‚è½½æ—¶æ‰§è¡Œä¸€æ¬¡ã€‚
3. ä¸¥æ ¼æ¨¡å¼ä¸‹ `useEffect` æœ‰ä¸€ç§ç‰¹æ®Šè¡Œä¸ºï¼Œå³åœ¨ç¬¬ä¸€æ¬¡æ¸²æŸ“ä¹‹å‰ä¼šè¿è¡Œä¸€ä¸ªé¢å¤–çš„è®¾ç½®å’Œæ¸…ç†å¾ªç¯ï¼Œè¿™ä¸ªå¾ªç¯çš„ç›®çš„æ˜¯ä¸ºäº†éªŒè¯è®¾ç½®é€»è¾‘å’Œæ¸…ç†é€»è¾‘æ˜¯å¦ç›¸äº’åŒ¹é…ï¼Œä»¥åŠæ¸…ç†é€»è¾‘æ˜¯å¦èƒ½å¤Ÿæ­£ç¡®åœ°åœæ­¢æˆ–æ’¤é”€è®¾ç½®é€»è¾‘æ‰€åšçš„æ“ä½œã€‚å¦‚æœä½ åœ¨ä¸¥æ ¼æ¨¡å¼ä¸‹é‡åˆ°äº†ä¸ `setup å’Œ cleanup` ç›¸å…³çš„é—®é¢˜ï¼Œå®˜æ–¹å»ºè®®ä½ å®ç°é€‚å½“çš„æ¸…ç†å‡½æ•°æ¥è§£å†³ã€‚è¿™æ ·å¯ä»¥ç¡®ä¿åœ¨ç»„ä»¶å¸è½½æˆ–é‡æ–°æ¸²æŸ“æ—¶è¿›è¡Œå¿…è¦çš„æ¸…ç†æ“ä½œï¼Œé¿å…æ½œåœ¨çš„é—®é¢˜å’Œé”™è¯¯ã€‚
4. å¦‚æœä¾èµ–é¡¹ä¸­çš„éƒ¨åˆ†å˜é‡æˆ–è€…å‡½æ•°å®šä¹‰åœ¨äº†ç»„ä»¶å†…éƒ¨ï¼Œå°±ä¼šæœ‰é£é™©ï¼šç»„ä»¶æ¯æ¬¡æ¸²æŸ“å¯¼è‡´è¿™ä¸ªå‡½æ•°æˆ–è€…å˜é‡é‡æ–°åŠ è½½ï¼Œè¿›è€Œå¯¼è‡´ `useEffect` æ¯æ¬¡éƒ½æ‰§è¡Œã€‚è€ƒè™‘æå–ä¿®æ”¹é€»è¾‘ä»£ç æˆ–è€…ä½¿ç”¨ `useCallback` æŠ€æœ¯ã€‚
5. `useEffect` æ˜¯åœ¨ dom æµç»˜åˆ¶å®Œæˆåæ‰§è¡Œçš„ï¼Œå¦‚æœä½ æƒ³è¦é¡µé¢åˆå§‹åŒ–è¿‡ç¨‹ä¸­åœ¨è¯¥å‡½æ•°ä¸­å¤„ç† dom ç»“æ„ï¼Œå¯ä»¥è€ƒè™‘æ”¾åœ¨ useLayoutEffect ä¸­ã€‚
6. `useEffect` ä»…åœ¨å®¢æˆ·ä¾§èƒ½ä½¿ç”¨ï¼ŒæœåŠ¡ä¾§ä½¿ç”¨è¯¦è§æˆ‘ä¹‹åçš„æ–‡ç« ã€‚

### è¿è¡Œæµç¨‹

æˆ‘ä»¬ä½¿ç”¨ä¸Šé¢çš„èŠå¤©å®¤çš„ä¾‹å­æ¥è§£é‡Šä¸€ä¸‹ `useEffect` è¿è¡Œæµç¨‹ã€‚React ä¼šåœ¨å¿…è¦æ—¶è°ƒç”¨ä¸€æ¬¡æˆ–å¤šæ¬¡ä½ çš„è®¾ç½®å’Œæ¸…ç†å‡½æ•°ã€‚

1. ç»„ä»¶åˆå§‹åŒ–æ—¶ï¼ŒuseEffect çš„è®¾ç½®å‡½æ•°æ‰§è¡Œä¸€æ¬¡
2. ä¾èµ–é¡¹æ›´æ–°æ—¶ï¼š
- ä½¿ç”¨æ—§çš„propså’Œstateï¼Œæ¸…ç†å‡½æ•°æ‰§è¡Œä¸€æ¬¡
- ä½¿ç”¨æ–°çš„propså’Œstateï¼Œè®¾ç½®å‡½æ•°æ‰§è¡Œä¸€æ¬¡
3. ç»„ä»¶é”€æ¯æˆ–è€…é‡æ¸²æŸ“æ—¶ï¼Œæ¸…ç†å‡½æ•°ä¼šæ‰§è¡Œä¸€æ¬¡

> useEffect çš„ä½œç”¨åœ¨äºæä¾›ä¸€ç§å°† `React`éå—æ§çš„ç³»ç»Ÿä¸ `React` çš„çŠ¶æ€é“¾æ¥çš„ä¸€ä¸ªåª’ä»‹ã€‚`React`éå—æ§ç³»ç»Ÿæ¯”å¦‚ setIntervalã€addEventListenerã€animation.start() ç­‰ã€‚å¦‚æœæ²¡æœ‰éå—æ§ç³»ç»Ÿå‚ä¸ï¼ŒuseEffect å¾€å¾€ä¸æ˜¯å¿…é¡»çš„ã€‚

### å„ç§ä½¿ç”¨ä¾‹å­

#### 1. ç›‘å¬é¼ æ ‡äº‹ä»¶

ä¸‹é¢çš„ä¾‹å­ï¼Œç›‘å¬äº†é¼ æ ‡æŒ‡é’ˆæ»‘åŠ¨äº‹ä»¶ï¼Œå¹¶åœ¨é¼ æ ‡æŒ‡é’ˆä¸‹æ–¹è®¾ç½®è·Ÿéšçš„åœ†å½¢é˜´å½±è£…é¥°ï¼š

```js
import { useState, useEffect } from 'react';

export default function App() {
  const [position, setPosition] = useState({ x: 0, y: 0 });

  useEffect(() => {
    function handleMove(e) {
      setPosition({ x: e.clientX, y: e.clientY });
    }
    window.addEventListener('pointermove', handleMove);
    return () => {
      window.removeEventListener('pointermove', handleMove);
    };
  }, []);

  return (
    <div style={{
      position: 'absolute',
      backgroundColor: 'pink',
      borderRadius: '50%',
      opacity: 0.6,
      transform: `translate(${position.x}px, ${position.y}px)`,
      pointerEvents: 'none',
      left: -20,
      top: -20,
      width: 40,
      height: 40,
    }} />
  );
}
```

#### 2. è®¾ç½®ä¸€æ®µåŠ¨ç”»ï¼ˆéƒ¨åˆ†ä»£ç ï¼‰

ç‚¹å‡»æŒ‰é’®ï¼Œåœ¨é¡µé¢æ¸å˜çš„æ˜¾ç¤ºä¸€ä¸ªå—çº§å…ƒç´ ï¼ˆ[å®Œæ•´ä»£ç ](https://codesandbox.io/s/ld0mxv?file=/animation.js:463-472&utm_medium=sandpack)ï¼‰ï¼š

```js
useEffect(() => {
    const animation = new FadeInAnimation(ref.current);
    animation.start(1000);
    return () => {
      animation.stop();
    };
  }, []);
```

#### 3. è¿½è¸ªå…ƒç´ ç»è¿‡å¯è§†åŒºåŸŸï¼ˆéƒ¨åˆ†ä»£ç ï¼‰

ä¸‹é¢çš„ä»£ç ï¼Œåœ¨æ‰“äº† ref çš„ div è¿›å…¥å¯è§†åŒºåŸŸåï¼Œæ·»åŠ èƒŒæ™¯è‰²å’Œå­—ä½“è‰²ï¼Œç¦»å¼€å¯è§†åŒºåŸŸåæ ·å¼å¤åŸï¼š

```js
useEffect(() => {
    const div = ref.current;
    const observer = new IntersectionObserver(entries => {
      const entry = entries[0];
      if (entry.isIntersecting) {
        document.body.style.backgroundColor = 'black';
        document.body.style.color = 'white';
      } else {
        document.body.style.backgroundColor = 'white';
        document.body.style.color = 'black';
      }
    });
    observer.observe(div, {
      threshold: 1.0
    });
    return () => {
      observer.disconnect();
    }
  }, []);
```

#### 4. åœ¨è‡ªå®šä¹‰ Hook ä¸­ä½¿ç”¨

æˆ‘ä»¬è¿˜ä»¥ä¸Šé¢èŠå¤©å®¤çš„ä¾‹å­åšè¯´æ˜ã€‚ä¸Šé¢çš„åŠŸèƒ½æ˜¯ roomId å’Œ service åˆ‡æ¢å°±è‡ªåŠ¨å…³é—­æ—§çš„é“¾æ¥ï¼Œæ‰“å¼€æ–°çš„é“¾æ¥ï¼Œæ‰€æœ‰çš„èŠå¤©é“¾æ¥åŠ¨ä½œéƒ½ä¸€æ ·ï¼Œå¯ä»¥æå–æˆå…¬å…±ç»„ä»¶æ¥ä½¿ç”¨ï¼š

```js
function useChatRoom({ serverUrl, roomId }) {
  useEffect(() => {
    const options = {
      serverUrl: serverUrl,
      roomId: roomId
    };
    const connection = createConnection(options);
    connection.connect();
    return () => connection.disconnect();
  }, [roomId, serverUrl]);
}
```

è¿™æ ·ï¼Œåªéœ€è¦ä½¿ç”¨è¿™ä¸ªå‡½æ•°å°±èƒ½å®ŒæˆèŠå¤©å®¤çš„é“¾æ¥å·¥ä½œï¼š

```js
useChatRoom({  
    roomId: roomId,  
    serverUrl: serverUrl  
});
```

å½“ç„¶äº†ï¼Œ[å…¨å±€éå—æ§äº‹ä»¶ï¼ˆaddEventListenerï¼‰](https://codesandbox.io/s/b006ec?file=/useWindowListener.js&utm_medium=sandpack)ã€[å¯è§†åŒºåŸŸç›‘å¬](https://codesandbox.io/s/m9drvd?file=/useIntersectionObserver.js&utm_medium=sandpack)ä¹Ÿå¯ä»¥å°è£…ä¸ºä¸€ä¸ªç‹¬ç«‹çš„ Hook æ¥ä½¿ç”¨ã€‚

#### 5. ä½¿ç”¨å®šæ—¶å™¨æ“ä½œ state

å¦‚æœæƒ³è¦åœ¨ `useState` é‡Œä½¿ç”¨å®šæ—¶å™¨æ“ä½œçŠ¶æ€å€¼ï¼Œä½ å¯èƒ½ä¼šè¿™æ ·å†™ï¼š

```js
unction Counter() {  
    const [count, setCount] = useState(0);  

    useEffect(() => {  
        const intervalId = setInterval(() => {  
            setCount(count + 1); // You want to increment the counter every second...  
        }, 1000)  

        return () => clearInterval(intervalId);  
    }, [count]); // ğŸš© ... but specifying `count` as a dependency always resets the interval.  
    // ...  
}
```

ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œcount æ˜¯ä¸€ä¸ªå“åº”å€¼ï¼Œåœ¨ useEffect ä¸­å¼•å…¥äº†ä»–çš„ä¾èµ–ï¼ŒåŒæ—¶ï¼Œè¿™æ˜¯å‡½æ•°ä¸­åˆæ”¹å˜äº†ä»–çš„å€¼ï¼Œè¿™å°±å¯¼è‡´äº† setInterval å‡½æ•°ä¼šè¢«åå¤çš„æ‰§è¡Œï¼Œå®šæ—¶å™¨æ¯æ¬¡éƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„å‡ºæ¥ã€‚ä»£ç é€»è¾‘å‡ºç°é”™è¯¯ä¸è¯´ï¼Œä¹Ÿæµªè´¹äº†å†…å­˜ç©ºé—´ã€‚

è§£å†³æ–¹æ¡ˆå…¶å®å¾ˆç®€å•ï¼Œä¸Šä¸€ç¯‡æ–‡ç« è®² `useState` çš„æ—¶å€™æåˆ°è¿‡ï¼ŒuseState å†…éƒ¨å¯ä»¥ä¼ ä¸€ä¸ªå‡½æ•°ï¼Œä»–çš„å‚æ•°å°±æ˜¯ä¸Šä¸€æ¬¡æ›´æ–°å®Œä¹‹åçš„çŠ¶æ€å€¼ï¼Œæ‰€ä»¥è¿™é‡Œå¹¶ä¸éœ€è¦å»æ‹¿ count è¿™ä¸ªå˜é‡ï¼š

```js
useEffect(() => {
  const intervalId = setInterval(() => {
    setCount(c => c + 1); // âœ… Pass a state updater
  }, 1000);
  return () => clearInterval(intervalId);
}, []); // âœ… Now count is not a dependency
```

### å…³äºä¾èµ–

ä¸æ¨èä¸å¼•å…¥å¿…é¡»çš„ä¾èµ–æˆ–è€…æ·»åŠ é¢å¤–çš„ä¸éœ€è¦çš„ä¾èµ–é¡¹ã€‚ä½ çš„ä¾èµ–é¡¹çš„é€‰æ‹©å–å†³äº `useEffect` åŒ…è£¹çš„ä»£ç ã€‚

ä¾èµ–çš„é€‰æ‹©ä¸ä»…åŒ…æ‹¬è®¾ç½®å‡½æ•°å†…æ‰€åº”ç”¨çš„å˜é‡ã€å‡½æ•°ï¼Œè¿˜åº”è€ƒè™‘åˆ°å„ä¸ªå˜é‡ã€å‡½æ•°å„è‡ªçš„å¼•ç”¨ä¾èµ–ã€‚å¦‚æœå¼•ç”¨çš„å‡½æ•°å†…çš„å˜é‡å˜åŒ–å¼•èµ·äº†è¯¥å‡½æ•°é‡æ–°è®¾ç½®ï¼Œè¿›è€Œä¾¿ä¼šè§¦å‘ `useEffec` æ‰§è¡Œã€‚

åœ¨ä¸Šé¢çš„èŠå¤©å®¤ä¾‹å­ä¸­ï¼ŒrootId æ˜¯é€šè¿‡ç”¨æˆ·ä¸‹æ‹‰åˆ‡æ¢å¾—æ¥çš„ï¼Œå¯ä»¥çœ‹åšæ˜¯ä¸€ä¸ªå“åº”å¼æ•°æ®ï¼›ä½†æ˜¯ serverUrl æ˜¯ä¸€ä¸ªå¸¸é‡å­—ç¬¦ä¸²ï¼Œå®Œå…¨ä¸éœ€è¦æ”¾åœ¨ state é‡Œï¼Œè¿›è€Œä¹Ÿå¯ä»¥ç§»å‡ºä¾èµ–é¡¹ï¼š

```js
useEffect(() => {  
    const connection = createConnection(serverUrl, roomId);  
    connection.connect();  

    return () => connection.disconnect();  
}, [roomId]); // âœ… All dependencies declared
```

å¦‚æœåŒ…è£¹çš„å‡½æ•°æ²¡æœ‰ä»»ä½•å¯å“åº”çš„æ•°æ®ï¼Œé‚£ä¹ˆå°±ç”¨ä¸€ä¸ªç©ºæ•°ç»„å³å¯ã€‚

### é£é™©é¡¹

å¯ä»¥é€šè¿‡ä¸€å®šçš„æ³¨é‡Šæ¬ºéª—ä¾èµ–é¡¹æ£€æŸ¥ï¼Œæ¯”å¦‚ï¼š

```js
useEffect(() => {
  // ...
  // ğŸ”´ Avoid suppressing the linter like this:
  // eslint-ignore-next-line react-hooks/exhaustive-deps
}, []);
```

è¿™ç§æƒ…å†µåœ¨ä½ è‚¥è‚ æ˜ç¡®åŒ…è£¹å‡½æ•°çš„ä¾èµ–å…³ç³»æ—¶æ‰å¯ä½¿ç”¨ï¼Œä½†æ˜¯è¿™åŒæ ·ä¸åˆ©äºå›¢é˜Ÿåˆä½œä¸­çš„ä»£ç ç»´æŠ¤ã€‚å¦‚æœåŒ…è£¹å‡½æ•°ä¸­çš„å˜é‡æˆ–è€…å‡½æ•°åœ¨ä»£ç è¿­ä»£ç»´æŠ¤è¿‡ç¨‹ä¸­å˜æˆäº†å“åº”å¼çš„ï¼Œä½†æ˜¯è¿™é‡ŒåˆæŠ‘åˆ¶äº†å‘Šè­¦æç¤ºï¼Œå¯èƒ½ä¼šå‡ºç°éš¾ä»¥æ’æŸ¥çš„é—®é¢˜ã€‚

> P.S. å¯èƒ½ä½ ä¼šè§‰å¾—: æˆ‘ä½¿ç”¨ç©ºæ•°ç»„å°±æ˜¯è¡¨ç¤ºç»„ä»¶åˆå§‹åŒ–åŠ è½½æ—¶è°ƒç”¨çš„å•Šï¼Œä¸ºä»€ä¹ˆè¿˜è¦ç»™æˆ‘å¼¹è­¦å‘Šï¼Ÿè¿™é‡Œï¼Œä½œè€…å»ºè®®ï¼Œä¸è¦åœ¨å‡½æ•°å¼ç»„ä»¶é‡Œè°ˆç”Ÿå‘½å‘¨æœŸï¼Œè¿™é‡Œåªæœ‰å“åº”å¼å‰¯ä½œç”¨å’Œå¸¸é‡ã€‚

## 3. å®éªŒæ€§APIï¼šuseEffectEvent

> è¯¥APIè¿˜å¤„äºè¯•éªŒé˜¶æ®µï¼Œæ­£å¼releaseç‰ˆå°šæœªå‘å¸ƒã€‚

ç†è®ºä¸Šï¼Œä¾èµ–æ›´æ–°äº†ï¼Œè®¾ç½®å‡½æ•°å°±ä¼šé‡æ–°æ‰§è¡Œï¼Œè€ƒè™‘ä¸‹é¢è®°å½•é¡µé¢è®¿é—®é‡çš„ä»£ç ï¼š

```js
function Page({ url, shoppingCart }) {  
    useEffect(() => { 
        // ...
        logVisit(url, shoppingCart.length);  
    }, [url, shoppingCart]); // âœ… All dependencies declared  
    // ...  
}
```
urlå’ŒshoppingCartå˜åŒ–ï¼Œéƒ½ä¼šé‡æ–°è°ƒç”¨logVisitå‡½æ•°æ¥å¢åŠ è®¿é—®è®¡æ•°ã€‚ä½†æ˜¯ï¼Œä½ åªå¸Œæœ›è®¿é—®urlå˜åŒ–æ—¶æ‰å¢åŠ è®¿é—®é‡ï¼ŒshoppingCartå˜åŒ–æ—¶logVisitä¸è¦é‡æ–°æ‰§è¡Œï¼Œä½†æ˜¯åœ¨æ‰§è¡Œæ—¶ï¼Œè´­ç‰©è½¦åˆå¾—æ˜¯æœ€æ–°çš„æ•°æ®ï¼Œæ€ä¹ˆåšå‘¢ï¼Ÿ

ç›´æ¥ç§»é™¤ä¾èµ–å¯èƒ½ä¼šå½±å“å‡½æ•°å†…éƒ¨å…¶ä»–åœ°æ–¹çš„å˜åŒ–ã€‚æ­¤æ—¶å¯ä»¥ä½¿ç”¨ `useEffectEvent`:

```js
function Page({ url, shoppingCart }) {
  const onVisit = useEffectEvent(visitedUrl => {
    // éå“åº”å¼çš„ï¼Œå³å¯ä»¥æ‹¿åˆ°å®æ—¶å…¶ä»–å“åº”å¼æ•°æ®ï¼Œåˆé¿å…äº†ä»–çš„å˜åŒ–å¼•èµ·å¤–éƒ¨æ›´æ–°
    logVisit(visitedUrl, shoppingCart.length)
  });

  useEffect(() => {
    onVisit(url);
  }, [url]); // âœ… All dependencies declared
  // ...
}
```
ä¸Šé¢çš„ä»£ç ï¼Œåœ¨urlå˜åŒ–åï¼Œä¼šæ‰§è¡ŒonVisit -> logVisitå‡½æ•°ï¼Œè¢« `useEffectEvent` åŒ…è£¹çš„å‡½æ•°ä¸æ˜¯å“åº”å¼çš„ï¼Œæ‰€ä»¥è¿™é‡Œä½¿ç”¨äº†å“åº”å€¼shoppingCartï¼Œæ—¢å¯ä»¥åŠæ—¶æ‹¿åˆ°æœ€æ–°çš„è´­ç‰©è½¦ä¿¡æ¯ï¼Œåˆé¿å…äº†è´­ç‰©è½¦å˜åŒ–å¼•èµ·åŒ…è£¹onVisitå‡½æ•°çš„ç»„ä»¶çš„å˜åŒ–ã€‚

> P.S. ä»–çš„ä½¿ç”¨æ–¹å¼åŒ useEvent

## 4. useLayoutEffect

`useLayoutEffect` æ˜¯ `useEffect` çš„ä¸€ä¸ªç‰ˆæœ¬ã€‚ä¸€èˆ¬ç”¨åœ¨æ§åˆ¶é¡µé¢æ¸²æŸ“çš„å·¥ä½œä¸­ï¼Œå…¶åœ¨é¡µé¢æ¸²æŸ“è¿‡ç¨‹ä¹‹å‰è°ƒç”¨ã€‚ï¼ˆä¼šå½±å“æ€§èƒ½ï¼‰

### ä½¿ç”¨åœºæ™¯

#### 1.é¡µé¢åˆå§‹åŒ–æ—¶è·å–çŸ©å½¢çš„é«˜åº¦

åœ¨å…ƒç´ æ¸²æŸ“ä¹‹å‰ï¼Œè·å–ä¸€ä¸ª ref æŒ‡å‘å…ƒç´ çš„é«˜åº¦ï¼Œå¹¶è®¾ç½®ç»™ç»„ä»¶çš„stateï¼š

```js
import { useState, useRef, useLayoutEffect } from 'react';

function Tooltip() {
  const ref = useRef(null);
  const [tooltipHeight, setTooltipHeight] = useState(0);

  useLayoutEffect(() => {
    const { height } = ref.current.getBoundingClientRect();
    setTooltipHeight(height);
  }, []);
  // ...
}
```

#### 2. åœ¨é¡µé¢é‡ç»˜ä¹‹å‰æ”¹åŠ¨å¸ƒå±€

ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œtooltip ç»„ä»¶éœ€è¦åœ¨é¡µé¢æ¸²æŸ“æ—¶è·å–æŒ‚è½½å…ƒç´ çš„é«˜åº¦ï¼Œè¿›è€Œç¡®è®¤åœ¨å“ªä¸ªæ–¹å‘ä¸Šæ¸²æŸ“ï¼š

```js
useLayoutEffect(() => {
    const { height } = ref.current.getBoundingClientRect();
    setTooltipHeight(height);
    console.log('Measured tooltip height: ' + height);
  }, []);

  let tooltipX = 0;
  let tooltipY = 0;
  if (targetRect !== null) {
    tooltipX = targetRect.left;
    tooltipY = targetRect.top - tooltipHeight;
    if (tooltipY < 0) {
      // It doesn't fit above, so place below.
      tooltipY = targetRect.bottom;
    }
  }
  
  // ...
  
  return createPortal(
    <TooltipContainer x={tooltipX} y={tooltipY} contentRef={ref}>
      {children}
    </TooltipContainer>,
    document.body
  );
```
å®Œæ•´ä¾‹å­è§[å®˜ç½‘demo](https://codesandbox.io/s/bj8hpt?file=/TooltipContainer.js&utm_medium=sandpack)

### æ³¨æ„äº‹é¡¹

åœ¨ä½¿ç”¨react SSRæ—¶ï¼Œåˆå§‹çš„ HTMLæ¸²æŸ“ä¼šæ—©äº js è„šæœ¬ï¼Œä½†æ˜¯åœ¨æœåŠ¡ç«¯æ²¡æœ‰å¸ƒå±€ä¿¡æ¯ï¼Œæ‰€ä»¥åœ¨ js è„šæœ¬åŠ è½½å®Œæ¯•åï¼Œé¡µé¢å¯èƒ½ä¼šå‡ºç°é—®é¢˜ï¼Œæ±‡æ€»å¦‚ä¸‹ï¼š

1.  ä¸ä¸€è‡´çš„æ¸²æŸ“ç»“æœï¼šç”±äºæœåŠ¡ç«¯æ¸²æŸ“å’Œå®¢æˆ·ç«¯æ¸²æŸ“çš„æ‰§è¡Œç¯å¢ƒä¸åŒï¼Œ`useLayoutEffect` åœ¨æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯å¯èƒ½ä¼šäº§ç”Ÿä¸ä¸€è‡´çš„ç»“æœã€‚è¿™å¯èƒ½å¯¼è‡´åœ¨æœåŠ¡ç«¯æ¸²æŸ“æ—¶å‡ºç°é—ªçƒã€å¸ƒå±€é”™ä¹±æˆ–ä¸ç¬¦åˆé¢„æœŸçš„è¡Œä¸ºã€‚
2.  æ— æ•ˆçš„ DOM æ“ä½œï¼š`useLayoutEffect` åœ¨æœåŠ¡ç«¯æ‰§è¡Œæ—¶ï¼Œæ— æ³•ç›´æ¥è®¿é—®åˆ°çœŸå®çš„ DOMã€‚å› æ­¤ï¼Œåœ¨è¿™ä¸ªé˜¶æ®µå¯¹ DOM è¿›è¡Œçš„æ“ä½œå¯èƒ½ä¼šå¯¼è‡´é”™è¯¯æˆ–æ— æ•ˆçš„ç»“æœã€‚
3.  æ€§èƒ½é—®é¢˜ï¼šç”±äº `useLayoutEffect` çš„æ‰§è¡Œæ˜¯åŒæ­¥çš„ï¼Œå¹¶ä¸”åœ¨æ¯ä¸ªæ¸²æŸ“å‘¨æœŸéƒ½ä¼šè¢«è°ƒç”¨ï¼Œå¯èƒ½ä¼šå¯¹æœåŠ¡å™¨çš„æ€§èƒ½äº§ç”Ÿè´Ÿé¢å½±å“ã€‚åœ¨å¤§è§„æ¨¡çš„ SSR é¡¹ç›®ä¸­ï¼Œé¢‘ç¹çš„åŒæ­¥ DOM æ“ä½œå¯èƒ½ä¼šå¯¼è‡´æ€§èƒ½ä¸‹é™å’Œå“åº”æ—¶é—´å»¶é•¿ã€‚

> å»ºè®®ï¼šæœåŠ¡ç«¯æ¸²æŸ“çš„é¡¹ç›®ä¸­ä½¿ç”¨ `useEffect` æ›¿ä»£ï¼Œå¹¶ä½¿ç”¨ [`<Suspense>`](https://react.dev/reference/react/Suspense) æ‡’åŠ è½½ç»„ä»¶ï¼Œæˆ–è€…ä½¿ç”¨ hydration æ¨¡å¼å¼€å‘ã€‚

## 5. useInsertionEffect

`useInsertionEffect` æ˜¯ `useEffect` çš„ä¸€ä¸ªç‰ˆæœ¬ã€‚å…¶åœ¨ DOM å˜æ›´ä¹‹å‰è§¦å‘ï¼Œæ˜¯ä¸€ä¸ªç»“åˆ CSS-in-JS çš„æ ·å¼ä¿®æ”¹çš„è‡ªå®šä¹‰ hookã€‚

### ä½¿ç”¨åœºæ™¯

###### ä» CSS-in-JS åº“ä¸­æ’å…¥åŠ¨æ€æ ·å¼

åœ¨è¿è¡Œä¸­çš„ä»£ç ä¸­ï¼ŒåŠ¨æ€æ’å…¥ style æ ·å¼ï¼Œæœ‰ä¸¤ä¸ªå¼Šç«¯ï¼š

1. è¿«ä½¿æµè§ˆå™¨æ›´é¢‘ç¹åœ°é‡æ–°è®¡ç®—æ ·å¼ã€‚
2. å¦‚æœè¿è¡Œæ—¶æ³¨å…¥å‘ç”Ÿåœ¨ React ç”Ÿå‘½å‘¨æœŸçš„é”™è¯¯æ—¶é—´ï¼Œå®ƒå¯èƒ½ä¼šéå¸¸æ…¢ã€‚

ä½¿ç”¨ useInsertionEffect å¯ä»¥ä¸ºæˆ‘ä»¬æä¾›ä¸€ç§æ–¹æ¡ˆï¼Œè§£å†³ä¸Šé¢ç¬¬äºŒä¸ªé—®é¢˜ã€‚ï¼ˆç¬¬ä¸€ä¸ªé—®é¢˜ç›®å‰ä¸å¯è§£ï¼‰ï¼š

```js
let isInserted = new Set();
function useCSS(rule) {
  useInsertionEffect(() => {
    // As explained earlier, we don't recommend runtime injection of <style> tags.
    // But if you have to do it, then it's important to do in useInsertionEffect.
    if (!isInserted.has(rule)) {
      isInserted.add(rule);
      document.head.appendChild(getStyleForRule(rule));
    }
  });
  return rule;
}

function Button() {
  const className = useCSS('...');
  return <div className={className} />;
}
```

useInsertionEffect åŒæ ·ä¸é€‚ç”¨äºæœåŠ¡ç«¯æ¸²æŸ“ï¼Œåœ¨ä¹¦å†™æ—¶éœ€è¦é¢å¤–åˆ¤æ–­ï¼š

```js
let collectedRulesSet = new Set();

function useCSS(rule) {
  if (typeof window === 'undefined') {
    collectedRulesSet.add(rule);
  }
  useInsertionEffect(() => {
    // ...
  });
  return rule;
}
```

> P.S. ä»–æ˜¯å¦‚ä½•è§£å†³ç¬¬äºŒæ¡é—®é¢˜çš„ï¼šå¦‚æœåœ¨æ¸²æŸ“æœŸé—´æ’å…¥æ ·å¼å¹¶ä¸” React æ­£åœ¨å¤„ç†éé˜»å¡æ›´æ–°ï¼Œåˆ™æµè§ˆå™¨å°†åœ¨æ¸²æŸ“ç»„ä»¶æ ‘æ—¶æ¯å¸§é‡æ–°è®¡ç®—æ ·å¼ï¼Œè¿™å¯èƒ½ä¼šéå¸¸æ…¢ã€‚useInsertionEffect æ¯”åœ¨ useLayoutEffect æˆ– useEffect ä¸­æ’å…¥æ ·å¼è¦å¥½ï¼Œå› ä¸ºå®ƒç¡®ä¿å½“å…¶ä»– Effects åœ¨ç»„ä»¶ä¸­è¿è¡Œæ—¶ï¼Œ\<style\> æ ‡ç­¾å·²ç»è¢«æ’å…¥ã€‚å¦åˆ™ï¼Œå¸¸è§„ Effects ä¸­çš„å¸ƒå±€è®¡ç®—å°†ç”±äºè¿‡æ—¶çš„æ ·å¼è€Œå‡ºé”™ã€‚

----

æœ¬æœŸå®Œäº†ï¼Œå€ºè§ï¼62:T3988,å®˜ç½‘åœ°å€ï¼š[React](https://beta.reactjs.org/)

## 1. useState

useState å¯ä»¥è¯´æ˜¯ä½¿ç”¨çš„æœ€é¢‘ç¹çš„ä¸€ä¸ª hook äº†ã€‚æ¥ä¸‹æ¥çœ‹çœ‹å®˜ç½‘æ€ä¹ˆè§£é‡Šä»–çš„ç”¨æ³•ã€‚ä»–æ˜¯ä¸€ä¸ªåœ¨å‡½æ•°å¼ç»„ä»¶å†…æ·»åŠ æš‚å­˜çŠ¶æ€çš„å‡½æ•°ï¼Œåœ¨ç»„ä»¶æ›´æ–°æ¸²æŸ“æ—¶ï¼Œèƒ½å¤Ÿä¿ç•™stateé‡Œå˜é‡çš„çŠ¶æ€ä¸è¢«åˆå§‹åŒ–ã€‚

åŒå…¶ä»– hook ä¸€æ ·ï¼Œä¸èƒ½åœ¨å¾ªç¯å’Œåˆ¤æ–­æ¡ä»¶é‡Œä½¿ç”¨ï¼Œå®˜æ–¹æ¨èåœ¨ç»„ä»¶é¡¶éƒ¨ä½¿ç”¨ï¼š

```js
import { useState } from 'react';  

function MyComponent() {  
    const [age, setAge] = useState(28);  
    const [name, setName] = useState('Taylor');  
    const [todos, setTodos] = useState(() => createTodos());  
    // ...
}
```

### æ¥å—å‚æ•°ï¼šinitialState

æ¥å—ä¸€ä¸ªåˆå§‹åŒ–çš„å€¼ã€‚åœ¨stateåˆ›å»ºæ—¶ï¼Œä¼šå°†å€¼è®°å½•ä¸ºè¿™ä¸ªåˆå§‹åŒ–çš„å€¼ï¼Œä¸ä¼ é»˜è®¤æ˜¯ `undefined`ã€‚

> P.S. å¦‚æœåˆå§‹åŒ–å€¼ä¼ ä¸ºä¸€ä¸ªå‡½æ•°ï¼Œå®ƒå°†è¢«ä½œä¸ºåˆå§‹åŒ–å‡½æ•°ã€‚è¦æ±‚å¿…é¡»æ˜¯çº¯å‡½æ•°ï¼Œä¸å¸¦ä»»ä½•å‚æ•°ï¼Œå¹¶ä¸”åº”è¯¥æœ‰è¿”å›å€¼ã€‚åˆå§‹åŒ–å‡½æ•°çš„è¿”å›å°†è¢«è®°å½•ä¸ºåˆå§‹çŠ¶æ€ã€‚è¯¥åˆå§‹åŒ–å‡½æ•°åªä¼šåŠ è½½ä¸€æ¬¡ï¼Œåœ¨ä¸‹ä¸€ä¸ªç»„ä»¶æ¸²æŸ“æ—¶ï¼Œä¸ä¼šè¢«é‡æ–°æ‰§è¡Œ

### è¿”å›å€¼

ä»–çš„è¿”å›å€¼æ˜¯ä¸€ä¸ªæ•°ç»„è§£æ„çš„å˜é‡ã€‚

- çŠ¶æ€

ç¬¬ä¸€ä¸ªå˜é‡æ˜¯çŠ¶æ€å˜é‡æœ¬èº«

- è®¾ç½®çŠ¶æ€å‡½æ•°

ç¬¬äºŒä¸ªå˜é‡æ˜¯è®¾ç½®çŠ¶æ€çš„å‡½æ•°ï¼Œè°ƒç”¨è¿™ä¸ªå‡½æ•°ä¼šé‡æ–°è®¾ç½®stateå€¼å¹¶è§¦å‘ç»„ä»¶çš„ re-render.

è®¾ç½®çŠ¶æ€çš„å‡½æ•°ä½¿ç”¨èŒƒä¾‹ï¼š

```js
const [name, setName] = useState('Edward');  

function handleClick() {  
    setName('Taylor');  
    setAge(a => a + 1);  
    // ...
}
```

### å…³äºè®¾ç½®å‡½æ•°ï¼ˆæ¯”å¦‚ setNameï¼‰

- å…¥å‚

å‚æ•°æ˜¯è¦è®¾ç½®çš„æ–°çŠ¶æ€çš„å€¼ï¼Œå¯ä»¥æ˜¯ä»»ä½•ç±»å‹ã€‚

> P.S. å¦‚æœä½ ä¼ äº†ä¸€ä¸ªå‡½æ•°è¿›å»ï¼ˆæ¯”å¦‚ä¸Šé¢çš„ setNameï¼‰ï¼Œè¿™ä¸ªå‡½æ•°ä¼šè¢«ä½œä¸ºæ›´æ–°å‡½æ•°å¯¹å¾…ã€‚åŒæ ·å¿…é¡»æ˜¯çº¯å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°çš„å‚æ•°æ˜¯æ›´æ–°ä¹‹å‰çš„çŠ¶æ€å€¼ï¼Œå‡½æ•°çš„è¿”å›å€¼ä¼šè¢«ä½œä¸ºæ–°çš„çŠ¶æ€å€¼ã€‚React ä¼šæŠŠä½ çš„æ›´æ–°å‡½æ•°æ”¾åˆ°ä¸€ä¸ªä»»åŠ¡é˜Ÿåˆ—é‡Œï¼ˆfiberè°ƒåº¦å™¨ï¼‰ï¼Œåœ¨ä¸‹ä¸€ä¸ªæ¸²æŸ“å‘¨æœŸåˆ°æ¥æ—¶ï¼Œfiberä¼šéå†é˜Ÿåˆ—ï¼ŒæŒ‰ç…§ä¸€å®šçš„ä¼˜å…ˆçº§æ‰§è¡Œå‡½æ•°å¹¶æ¸…ç©ºå¯¹åˆ—ã€‚

- è¿”å›å€¼

### æ–°çš„çŠ¶æ€å€¼

- â­ï¸ è®¾ç½®çŠ¶æ€å‡½æ•°çš„æ³¨æ„äº‹é¡¹

1. çŠ¶æ€åªåœ¨ä¸‹æ¬¡æ›´æ–°æ—¶å¼‚æ­¥å˜åŒ–ï¼Œå¦‚æœåœ¨è®¾ç½®çŠ¶æ€åç«‹å³è¯»å–çŠ¶æ€å€¼ï¼Œè¯»å–åˆ°çš„è¿˜æ˜¯è€çš„çŠ¶æ€ã€‚
2. å¦‚æœæä¾›çš„æ–°å€¼ä¸å½“å‰çŠ¶æ€ç›¸åŒï¼ˆç”± Object.is æ¯”è¾ƒç¡®å®šï¼‰ï¼Œ`React` å°†è·³è¿‡é‡æ–°æ¸²æŸ“ç»„ä»¶åŠå…¶å­ç»„ä»¶ã€‚
3. `React` æ˜¯æ‰¹é‡åˆå¹¶æ›´æ–° state çš„ã€‚å¤šä¸ªçŠ¶æ€æ›´æ–°æ“ä½œä¼šè¢«æ”¾å…¥ä¸€ä¸ªé˜Ÿåˆ—ä¸­ï¼Œç„¶ååœ¨é€‚å½“çš„æ—¶æœºè¿›è¡Œåˆå¹¶å’Œæ‰¹é‡å¤„ç†ã€‚è¿™å¯ä»¥é˜²æ­¢åœ¨å•ä¸ªäº‹ä»¶æœŸé—´å¤šæ¬¡é‡æ–°æ¸²æŸ“ã€‚åœ¨æå°‘æ•°æƒ…å†µä¸‹ï¼Œéœ€è¦å¼ºåˆ¶ `React` æå‰æ›´æ–°ç•Œé¢ï¼Œä¾‹å¦‚è®¿é—® DOMï¼Œå¯ä»¥ä½¿ç”¨ flushSyncã€‚
4. åœ¨æ¸²æŸ“æœŸé—´è°ƒç”¨ set å‡½æ•°åªå…è®¸åœ¨å½“å‰æ¸²æŸ“ç»„ä»¶ä¸­ã€‚ `React` å°†ä¸¢å¼ƒå…¶è¾“å‡ºå¹¶ç«‹å³ä½¿ç”¨æ–°çŠ¶æ€å†æ¬¡æ¸²æŸ“ã€‚ï¼ˆä¸‹è¾¹æœ‰åœ¨æ¸²æŸ“æ—¶è®¾ç½®çŠ¶æ€å€¼çš„ä¾‹å­ï¼‰
5. åœ¨ä¸¥æ ¼æ¨¡å¼ + å¼€å‘ç¯å¢ƒä¸‹ï¼Œåˆå§‹åŒ–å‡½æ•°ä¼šè¢«è°ƒç”¨ä¸¤æ¬¡æ¥å¸®åŠ©ä½ è°ƒè¯•é”™è¯¯ã€‚å¦‚æœä½ ä½¿ç”¨çš„æ˜¯çº¯å‡½æ•°ï¼Œç¬¬äºŒæ¬¡ç»“æœä¼šè¢«å¿½ç•¥æ‰ã€‚

### æ³¨æ„äº‹é¡¹

1. ä½œä¸ºä¸€ä¸ªhookï¼Œä»–åœ¨å‡½æ•°å¼ç»„ä»¶å†…æ˜¯å•å‘é“¾è¡¨å­˜å‚¨çš„ï¼Œæ‰€ä»¥å¿…é¡»æ”¾åœ¨ç»„ä»¶é¡¶å±‚ä½¿ç”¨ã€‚å¦‚æœä½ éœ€è¦åœ¨å¾ªç¯æˆ–è€…æ¡ä»¶è¯­å¥é‡Œä½¿ç”¨ï¼Œå°±æå–æˆå•ç‹¬çš„ç»„ä»¶ä½¿ç”¨ã€‚
2. åœ¨ä¸¥æ ¼æ¨¡å¼ + å¼€å‘ç¯å¢ƒä¸‹ï¼Œåˆå§‹åŒ–å‡½æ•°ä¼šè¢«è°ƒç”¨ä¸¤æ¬¡æ¥å¸®åŠ©ä½ è°ƒè¯•é”™è¯¯ã€‚å¦‚æœä½ ä½¿ç”¨çš„æ˜¯çº¯å‡½æ•°ï¼Œç¬¬äºŒæ¬¡ç»“æœä¼šè¢«å¿½ç•¥æ‰ã€‚

### å„ç§ä½¿ç”¨ä¾‹å­

#### 1. åœ¨è®¾ç½®çŠ¶æ€åç«‹å³è¯»å–çŠ¶æ€å€¼

```js
function handleClick() {
    const [name, setName] = useState('Taylor');
    //...
    setName('Robin');  
    console.log(name); // Still "Taylor"!  
}
```

å¦‚æœæƒ³è¦è·å–åˆ°å˜åŒ–åçš„å€¼ï¼Œå¯ä»¥ä½¿ç”¨ `useEffect`

#### 2. åŸºç¡€ä½¿ç”¨ï¼šå¤šçŠ¶æ€ä¸è¡¨å•ç»“åˆ

```jsx
import { useState } from 'react';

export default function Form() {
  const [name, setName] = useState('Taylor');
  const [age, setAge] = useState(42);

  return (
    <>
      <input
        value={name}
        onChange={e => setName(e.target.value)}
      />
      <button onClick={() => setAge(age + 1)}>
        Increment age
      </button>
      <p>Hello, {name}. You are {age}.</p>
    </>
  );
}
```

#### 3. åœ¨å®šæ—¶å™¨ä¸­ä½¿ç”¨

åœ¨å®šæ—¶å™¨å›è°ƒå‡½æ•°ä¸­ä½¿ç”¨ç»„ä»¶ï¼š

```js
const [count, setCount] = useState(0);

const counterIntervalFunction = () => {
  console.log(count);
  setCount(count + 1)
};

// ...
const interval = setInterval(counterIntervalFunction, 1000);
```

ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œå®šæ—¶å™¨ä¸­è¯•å›¾ä¿®æ”¹stateçš„å€¼ï¼Œä½†æ˜¯ï¼Œå› ä¸ºé—­åŒ…çš„åŸå› ï¼ŒcounterIntervalFunctionä¸­æ‰“å°çš„ç»“æœæ¯æ¬¡éƒ½æ˜¯ 1ï¼Œå¹¶æ²¡æœ‰å®ç°ç´¯åŠ çš„æ•ˆæœã€‚

æ­¤æ—¶å¯ä»¥ä½¿ç”¨ç¬¬äºŒç§å†™æ³•ï¼š

```js
setCount(prev => prev + 1)
```

ä¹Ÿå¯ä»¥å€ŸåŠ© useRefï¼š

```js
const ref = useRef({ count });
useEffect(() => { 
    ref.current = { count }
}, [count]);
```
è¿™æ ·ï¼Œåœ¨ counterIntervalFunction é‡Œæ‹¿ ref.current.count å°±å¯ä»¥å•¦ã€‚å½“ç„¶äº†ï¼Œä½ ä¹Ÿå¯ä»¥æŠŠæ•´ä¸ªå®šæ—¶å™¨éƒ½æ”¾åœ¨åŸºäºcountçš„ `useEffect` ä¸­ï¼Œä¸€æ ·å¯ä»¥å®ç°ç›¸åŒçš„åŠŸèƒ½ã€‚

#### 4. åŸºäºä¸Šä¸€æ¬¡çŠ¶æ€æ›´æ–°çŠ¶æ€å€¼

```js
function handleClick() {  
    // é”™è¯¯å†™æ³•
    setAge(age + 1); // setAge(42 + 1)  
    setAge(age + 1); // setAge(42 + 1)  
    setAge(age + 1); // setAge(42 + 1)  
    
    // æ­£ç¡®å†™æ³• âœ…
    setAge(a => a + 1); // setAge(42 => 43)  
    setAge(a => a + 1); // setAge(43 => 44)  
    setAge(a => a + 1); // setAge(44 => 45)
}
```

#### 5. stateæ˜¯ä¸€ä¸ªå¯¹è±¡æ—¶ï¼Œä¿®æ”¹stateéœ€è¦æ”¹å˜å¼•ç”¨

```js
// ä¸ç”Ÿæ•ˆ
form.firstName = 'Taylor';

// æ¨è
setForm({  
    ...form,  
    firstName: 'Taylor'  
});
```

#### 6. é¿å…åˆå§‹åŒ–å‡½æ•°é‡å¤æ‰§è¡Œ

è€ƒè™‘ä¸‹é¢çš„ä¾‹å­ï¼š

```js
function TodoList() {  
    const [todos, setTodos] = useState(createInitialTodos());  
    // ...
}
```

è™½ç„¶createInitialTodosæœ‰æ•ˆæ‰§è¡Œåªæœ‰ç»„ä»¶æŒ‚è½½æ—¶ä¸€æ¬¡ï¼Œä½†åœ¨ä¹‹åç»„ä»¶å†æ¬¡re-renderæ—¶éƒ½ä¼šè¢«æ‰§è¡Œï¼Œè¿™å°±é€ æˆäº†èµ„æºæµªè´¹ã€‚å…¶å®ä½ åªéœ€è¦ä¼ é€’åˆå§‹åŒ–å‡½æ•°å£°æ˜å°±è¡Œäº†ï¼š

```js
function TodoList() {  
    const [todos, setTodos] = useState(createInitialTodos);  
    // ...
}
```

#### 7. é‡ç½®çŠ¶æ€å€¼

å¯ä»¥å€ŸåŠ© `React` æœ€å¸¸è§çš„ key å€¼æ¥é‡ç½®çŠ¶æ€ï¼š

```js
import { useState } from 'react';

export default function App() {
  const [version, setVersion] = useState(0);

  function handleReset() {
    setVersion(version + 1);
  }

  return (
    <>
      <button onClick={handleReset}>Reset</button>
      <Form key={version} />
    </>
  );
}

function Form() {
  const [name, setName] = useState('Taylor');

  return (
    <>
      <input
        value={name}
        onChange={e => setName(e.target.value)}
      />
      <p>Hello, {name}.</p>
    </>
  );
}
```

ä¸Šé¢çš„ä¾‹å­ä¸­ï¼ŒæŠŠä¸€ä¸ª state å½“åškeyä¼ é€’ç»™è¡¨å•ç»„ä»¶ï¼Œå½“éœ€è¦é‡ç½®è¡¨å•ç»„ä»¶æ—¶ï¼Œæ”¹å˜è¿™ä¸ªkeyå€¼ï¼ŒReactç»„ä»¶å°±ä¼šè‡ªè‡ªåŠ¨ re-create ä¸€æ¬¡è¡¨å•ï¼Œè¾¾åˆ°äº†é‡ç½®çš„ç›®çš„ï¼Œé‡ç½®åï¼Œè¡¨å•ç»„ä»¶é‡Œçš„æ‰€æœ‰stateéƒ½ä¼šé‡ç½®ã€‚

#### 8. ç»„ä»¶æ¸²æŸ“æœŸé—´ æ”¹å˜ state

ä¸€èˆ¬ä¸Šï¼ŒçŠ¶æ€å€¼çš„ä¿®æ”¹éƒ½ä¼šæ”¾åœ¨ä¸€ä¸ªäº‹ä»¶çš„handleBaré‡Œï¼Œä½†æ˜¯ï¼Œæœ‰æ—¶å€™ä½ æƒ³è¦åœ¨é™¤äº†äº‹ä»¶ä»¥å¤–çš„å“åº”ä¸­æ”¹å˜çŠ¶æ€å€¼ ï¼ˆæ¯”å¦‚ props æ”¹å˜çš„æ—¶å€™ï¼‰ï¼Œåº”è¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿä¸‹é¢ç»™å‡ºä¸€ä¸ªèŒƒä¾‹ï¼š

```js
import { useState } from 'react';

export default function CountLabel({ count }) {
  const [prevCount, setPrevCount] = useState(count);
  const [trend, setTrend] = useState(null);
  if (prevCount !== count) {
    setPrevCount(count);
    setTrend(count > prevCount ? 'increasing' : 'decreasing');
  }
  return (
    <>
      <h1>{count}</h1>
      {trend && <p>The count is {trend}</p>}
    </>
  );
}
```
ä¸Šé¢çš„ä¾‹å­ä½¿ç”¨èµ·æ¥éœ€æ³¨æ„ï¼Œ`prevCount !== count`çš„åˆ¤æ–­æ¡ä»¶ä¸èƒ½çœå»ï¼Œä¸ç„¶å°±ä¼šé™·å…¥åå¤ set çŠ¶æ€çš„æ­»å¾ªç¯é‡Œã€‚

å½“ç„¶äº†ï¼Œä½ ä¹Ÿå¯ä»¥åƒä¸Šä¸€ç¯‡æ–‡ç« é‚£æ ·ï¼Œä½¿ç”¨ useMemo è·å¾—è®¡ç®—å±æ€§ã€‚

### Q&A

#### 1. æˆ‘å·²ç»æ›´æ–°äº†çŠ¶æ€ï¼Œä½†æ˜¯console.logæ‰“å°äº†æ—§çš„å€¼

```js
function handleClick() {  
    console.log(count); // 0  
    setCount(count + 1); // Request a re-render with 1  
    console.log(count); // Still 0!  
    
    setTimeout(() => {  
        console.log(count); // Also 0!  
    }, 5000);  
}
```

å› ä¸ºReact çš„stateç±»ä¼¼äºå¿«ç…§ï¼Œæ›´æ–°äº†çŠ¶æ€åï¼Œå¹¶ä¸å½±å“ä¹‹å‰å·²ç»åœ¨fiberä»»åŠ¡äº‹ä»¶å¾ªç¯é‡Œçš„çŠ¶æ€ã€‚å¦‚æœéœ€è¦ç«‹å³ä½¿ç”¨ï¼Œå¯ä»¥å€ŸåŠ©ä¸´æ—¶å˜é‡ï¼š

```js
const nextCount = count + 1;  

setCount(nextCount);  

console.log(count); // 0  

console.log(nextCount); // 1
```

#### 2. æˆ‘å·²ç»æ›´æ–°äº†çŠ¶æ€ï¼Œä½†æ˜¯ç•Œé¢ä¸å˜åŒ–

å‰åä¸¤æ¬¡ä¿®æ”¹çš„çŠ¶æ€ï¼Œå¦‚æœç›¸ç­‰ï¼ˆObject.isï¼‰çš„è¯ï¼Œå°±ä¸ä¼šå»è§¦å‘æ¸²æŸ“ã€‚é”™è¯¯ç¤ºèŒƒï¼š

```js
obj.x = 10; // ğŸš© Wrong: mutating existing object  
setObj(obj); // ğŸš© Doesn't do anything
```

æ­£ç¡®ä½¿ç”¨æ–¹å¼ï¼š

```js
// âœ… Correct: creating a new object
setObj({
  ...obj,
  x: 10
});
```

#### 3. æ§åˆ¶å°æŠ¥é”™ â€œToo many re-renders. React limits the number of renders to prevent an infinite loop.â€

ä¸€èˆ¬è¿™ç§æƒ…å†µå°±æ˜¯ç»„ä»¶æ¸²æŸ“è¿›å…¥äº†æ­»å¾ªç¯ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªå¯èƒ½çš„ä¾‹å­åŠè§£å†³æ–¹æ¡ˆï¼š

```js
// ğŸš© Wrong: calls the handler during render
return <button onClick={handleClick()}>Click me</button>

// âœ… Correct: passes down the event handler
return <button onClick={handleClick}>Click me</button>

// âœ… Correct: passes down an inline function
return <button onClick={(e) => handleClick(e)}>Click me</button>
```

#### 4. æˆ‘æƒ³è¦æŠŠä¸€ä¸ªå‡½æ•°ä½œä¸º stateï¼Œä½†æ˜¯å´å½“æˆäº†åˆå§‹å‡½æ•°æ‰§è¡Œäº†

ä¸Šé¢çš„è®²è¿‡ï¼ŒuseState çš„å…¥å‚å¦‚æœæ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œåˆ™ä¼šå°†å‡½æ•°æ‰§è¡Œç»“æœä½œä¸ºåˆå§‹å‡½æ•°ã€‚å¦‚æœä¸€å®šè¦ä¼ ä¸€ä¸ªå‡½æ•°ä½œä¸ºçŠ¶æ€ï¼Œå¯ä»¥ä½¿ç”¨é«˜é˜¶å‡½æ•°ï¼š

```js
const [fn, setFn] = useState(() => someFunction);

function handleClick() {
  setFn(() => someOtherFunction);
}
```

## 2. useReducer

useReducer æ˜¯ä¸€ä¸ªä¸€èˆ¬åŒ–çš„ useStateï¼Œæ¯” useState å¤šäº†ä¸€ä¸ªå¤„ç†å‡½æ•°ï¼Œè¯¥å‡½æ•°å¯ä»¥æ ¹æ®ä¸åŒçš„åˆ†å‘çŠ¶æ€æ¥ç›¸åº”çš„æ”¹å˜çŠ¶æ€ã€‚å¯ä»¥è¿™ä¹ˆç†è§£ï¼ŒuseReducer æ˜¯ä¸€ä¸ªæå‰å†™å¥½äº†æ€ä¹ˆå¤„ç† state çš„å‡½æ•°çš„ useStateã€‚

å£°æ˜æ ¼å¼ï¼š

```js
const [state, dispatch] = useReducer(reducer, initialArg, init)
```

### æ¥æ”¶å‚æ•°

1. reducer

reducer å‡½æ•°æŒ‡å®šå¦‚ä½•æ›´æ–°çŠ¶æ€ï¼Œå¿…é¡»æ˜¯ä¸€ä¸ªçº¯å‡½æ•°ã€‚

2. initialArg

çŠ¶æ€çš„åˆå§‹å€¼

3. init

å¯é€‰åˆå§‹åŒ–å¤„ç†å‡½æ•°ã€‚å¦‚æœæœªæŒ‡å®šï¼Œåˆ™åˆå§‹çŠ¶æ€è®¾ç½®ä¸º initialArgã€‚å¦åˆ™ï¼Œåˆå§‹çŠ¶æ€è®¾ç½®ä¸ºè°ƒç”¨ `init(initialArg)` çš„ç»“æœã€‚

### è¿”å›å€¼

1. state ä¸ºå½“å‰çš„çŠ¶æ€å€¼
2. dispatch å‡½æ•°ï¼Œç”¨äºæ›´æ–°çŠ¶æ€

### æ³¨æ„äº‹é¡¹

ä½¿ç”¨æ–¹å¼åŒ useState

### åŸºæœ¬ä½¿ç”¨

```js
import { useReducer } from 'react';

function reducer(state, action) {
  // ...
}

const [state, dispatch] = useReducer(reducer, { age: 42 });

function handleClick() {
  dispatch({ type: 'incremented_age' });
  // ...
}
```

#### dispatch å‡½æ•°

æ¥å—ä¸€ä¸ª state å’Œ actionã€‚action å¯ä»¥æ˜¯ä»»æ„ç±»å‹çš„å€¼ï¼Œå¯ä»¥æ˜¯ä¸€ä¸ªæ ‡å¿—ä½ + payload çš„å½¢å¼ï¼›åŒæ—¶ï¼Œdispatch å‡½æ•°æ²¡æœ‰è¿”å›å€¼ã€‚

### ä½¿ç”¨ä¾‹å­

###### 1. ä¸formè¡¨å•ç»“åˆ

```jsx
import { useReducer } from 'react';

function reducer(state, action) {
  switch (action.type) {
    case 'incremented_age': {
      return {
        ...state,
        age: state.age + 1
      };
    }
    case 'changed_name': {
      return {
        name: action.nextName,
        age: state.age
      };
    }
  }
  
  // è¿™é‡Œå¤„ç†æœªçŸ¥æƒ…å†µï¼Œå¯ä»¥è¿”å›ä¸€ä¸ªè‡ªå®šä¹‰å¯¹è±¡ï¼Œä¹Ÿå¯ä»¥æŠ›å‡ºé”™è¯¯
  throw Error('Unknown action: ' + action.type);
}

const initialState = { name: 'Taylor', age: 42 };

export default function Form() {
  const [state, dispatch] = useReducer(reducer, initialState);

  function handleButtonClick() {
    dispatch({ type: 'incremented_age' });
  }

  function handleInputChange(e) {
    dispatch({
      type: 'changed_name',
      nextName: e.target.value
    }); 
  }

  return (
    <>
      <input
        value={state.name}
        onChange={handleInputChange}
      />
      <button onClick={handleButtonClick}>
        Increment age
      </button>
      <p>Hello, {state.name}. You are {state.age}.</p>
    </>
  );
}
```

è¡¨å•å…ƒç´ çš„ value æ˜¯ stateå†…éƒ¨çš„å€¼ï¼Œåœ¨è¡¨å•å…ƒç´ æ”¹å˜çš„äº‹ä»¶ä¸­ï¼Œdispatchè¿™ä¸ªreducerï¼Œdispatché‡Œä¼ äº†ä¸ª typeå’Œä¸€ä¸ª payload é¡¹ï¼šnextNameï¼Œæ­¤æ—¶ï¼Œreducerå°±å¯ä»¥æ¥æ”¶å‚æ•°äº†ï¼šstateå°±æ˜¯å½“å‰å˜æ›´å‰çš„çŠ¶æ€å€¼ï¼Œactionå°±æ˜¯ dispatch ä¼ é€’çš„å‚æ•°ã€‚

> P.S. reducer å‡½æ•°é‡Œä¸èƒ½ç›´æ¥æ”¹ stateï¼š`state.age = state.age + 1;`ï¼Œä»–åº”è¯¥è¿”å›ä¸€ä¸ªæ–°çš„å¼•ç”¨çš„å¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡ä¼šè‡ªåŠ¨è¢« useReducer è®¾ç½®ã€‚

###### 2. é¿å…é‡æ–°æ‰§è¡Œåˆå§‹å‡½æ•°

è€ƒè™‘ä¸‹é¢çš„ä¾‹å­ï¼š

```js
function createInitialState(username) {  
    // ...  
}  

function TodoList({ username }) {  
    const [state, dispatch] = useReducer(reducer, createInitialState(username));  
    // ...
}
```

ç¬¬äºŒä¸ªå‚æ•°æœ¬æ¥æ˜¯åˆå§‹åŒ–çŠ¶æ€çš„ä½ç½®ï¼Œä¼ äº†ä¸ªå‡½æ•°è°ƒç”¨ï¼Œè€Œä¸æ˜¯å‡½æ•°å£°æ˜ï¼Œåœ¨æ¯æ¬¡ç»„ä»¶re-renderæ—¶éƒ½ä¼šè¢«æ‰§è¡Œï¼Œå½±å“æ€§èƒ½ã€‚

è€ƒè™‘å¦‚ä¸‹æ”¹é€ ï¼š

```js
const [state, dispatch] = useReducer(reducer, username, createInitialState);
```
ç¬¬äºŒä¸ªå‚æ•°è¿˜æ˜¯é™æ€çš„åˆå§‹å€¼ï¼Œç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯è‡ªå®šä¹‰çš„åˆå§‹åŒ–å¤„ç†å‡½æ•°ï¼Œåœ¨åˆå§‹åŒ–æ—¶ï¼Œä¼šå°† `createInitialState(username)` çš„è¿”å›å€¼ä½œä¸ºåˆå§‹å€¼ã€‚

### Q&A

###### 1. dispatch åå¦‚ä½•ä½¿ç”¨æœ€æ–°çš„çŠ¶æ€å€¼

ä¸ useState ç±»ä¼¼ï¼Œéœ€ä½¿ç”¨å±€éƒ¨å˜é‡ï¼š

```js
const action = { type: 'incremented_age' };
dispatch(action);

const nextState = reducer(state, action);
console.log(state);     // { age: 42 }
console.log(nextState); // { age: 43 }
```

###### 2. æˆ‘çš„ reducer ä¸ºä»€ä¹ˆæ€»æ˜¯è¢«æ‰§è¡Œäº†å¤šæ¬¡ï¼Ÿ

è¿™ä¸ªè¿˜æ˜¯è·Ÿä¸¥æ ¼æ¨¡å¼å’Œå¼€å‘ç¯å¢ƒæœ‰å…³ç³»çš„ã€‚å¼€å‘ç¯å¢ƒä¼šå¸®ä½ æ£€æµ‹ä½ çš„ reducer æ˜¯å¦æ˜¯çº¯å‡½æ•°ã€‚è€ƒè™‘ä¸‹é¢çš„ä¾‹å­ï¼š

```js
function reducer(state, action) {
  switch (action.type) {
    case 'added_todo': {
      // ğŸš© Mistake: mutating state
      state.todos.push({ id: nextId++, text: action.text });
      return state;
    }
    // ...
  }
}
```
ä¸Šé¢çš„ reducer å°±ä¸æ˜¯ä¸€ä¸ªçº¯å‡½æ•°ï¼Œåœ¨å¼€å‘ç¯å¢ƒä¸­ï¼Œæ‰§è¡Œä¸¤æ¬¡ï¼Œtodosæ•°ç»„æ•°æ®å°±ä¼šé”™ä¹±ï¼Œå¼€å‘è€…å°±å¾ˆå®¹æ˜“å‘ç°é—®é¢˜å¹¶åŠæ—¶æ”¹æ­£ã€‚ä¸‹é¢ç»™å‡ºæ­£ç¡®çš„å‚è€ƒï¼š

```js
// âœ… Correct: replacing with new state
return {
  ...state,
  todos: [
    ...state.todos,
    { id: nextId++, text: action.text }
  ]
};
```

> ä¸çŸ¥ä¸è§‰ï¼Œå†™åˆ°è¿™é‡Œå·²ç» 1W å­—äº†...

----

æœ¬æœŸçš„å®˜ç½‘è§£è¯»å°±åˆ°è¿™é‡Œå•¦ï¼Œå€ºè§ï¼63:T2d8e,React å®˜ç½‘å‡ºäº† beta ç‰ˆçš„æ–°ç‰ˆæœ¬ï¼Œä»æ—§æ²¡æœ‰ä¸­æ–‡ç‰ˆã€‚å¯¹äºå›½å†…ä¸å°‘å¼€å‘è€…æ¥è¯´å¢åŠ äº†ä¸å°‘éº»çƒ¦ã€‚æˆ‘è¿™é‡Œä»¥å‰ç«¯å¼€å‘çš„è§’åº¦å½’çº³æ€»ç»“ä¸€ä¸‹ï¼ŒæŠŠå…¶ä¸­å¤§å®¶é‡ç‚¹ä½¿ç”¨çš„éƒ¨åˆ†ä»‹ç»ç»™å¤§å®¶ã€‚

å®˜ç½‘åœ°å€ï¼š[React](https://beta.reactjs.org/)

æˆ‘ä»¬å…ˆä»ç”¨çš„æœ€å¤šçš„ hook éƒ¨åˆ†å¼€å§‹ã€‚

## 1. [useCallback]

useCallback è¿”å›ä¸€ä¸ªè®°å¿†åŒ–çš„å›è°ƒå‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°åªæœ‰åœ¨ä¾èµ–é¡¹æ”¹å˜æ—¶æ‰ä¼šå‘ç”Ÿå˜åŒ–ã€‚è¿™æ˜¯å¯¹å›è°ƒå‡½æ•°è¿›è¡Œæ€§èƒ½ä¼˜åŒ–çš„ä¸€ç§æ–¹å¼ï¼Œä»¥ç¡®ä¿å­ç»„ä»¶ä¸ä¼šåœ¨çˆ¶ç»„ä»¶é‡æ–°æ¸²æŸ“æ—¶é‡å¤æ¸²æŸ“ã€‚

å®šä¹‰ï¼š

```js
const cachedFn = useCallback(fn, dependencies);
```

### ä½¿ç”¨

```js
import { useCallback } from 'react';

export default function ProductPage({ productId, referrer, theme }) {
  const handleSubmit = useCallback(
    (orderDetails) => {
      post('/product/' + productId + '/buy', {
        referrer,
        orderDetails,
      });
    },
    [productId, referrer],
  );
}
```

### å‚æ•°

- fnï¼šæƒ³è¦ç¼“å­˜çš„å‡½æ•°
- ä¾èµ–é¡¹ï¼šç¼“å­˜æ›´æ–°çš„æ¡ä»¶

### è¿”å›å€¼

- åˆå§‹åŒ–æ—¶ï¼Œè¿”å›ç¼“å­˜çš„åŸå§‹å‡½æ•°
- ä¾èµ–é¡¹æ²¡æœ‰å˜åŒ–ï¼ˆObject.is åˆ¤æ–­ï¼‰ï¼Œè¿”å›ä¸Šæ¬¡ç¼“å­˜çš„å‡½æ•°ï¼Œå¦åˆ™è¿”å›æœ€æ–°çš„å‡½æ•°

### æ³¨æ„äº‹é¡¹

- ç»„ä»¶æ–‡ä»¶ä¿®æ”¹åï¼Œç¼“å­˜ä¼šå¤±æ•ˆ
- åˆå§‹åŒ–åï¼Œsuspends åŠ è½½å‰çš„ç»„ä»¶ï¼Œä¸ä¼šç¼“å­˜å‡½æ•°

### Future

- æœ‰æœ›åœ¨è™šæ‹Ÿåˆ—è¡¨å®ç°æ»šåŠ¨åŒºåŸŸå¤–çš„å…ƒç´ åœæ­¢ç¼“å­˜

### ä½¿ç”¨åœºæ™¯

#### åœ¨ç»„ä»¶ re-render æ—¶è·³è¿‡é‡æ¸²æŸ“

å®˜æ–¹æ¡ˆä¾‹ï¼š

```js
// å‡è®¾æ²¡æœ‰ä½¿ç”¨ useCallback çš„ ProductPage
export default function ProductPage({ productId, referrer, theme }) {
  const handleSubmit = (orderDetails) => {
    post('/product/' + productId + '/buy', {
      referrer,
      orderDetails,
    });
  }

  return (
    <div className={theme}>
      <ShippingForm onSubmit={handleSubmit} />
    </div>
  );
}
```

å½“ theme å˜åŒ–æ—¶ï¼ŒShippingForm ä¼šè¢«é‡æ–°æ¸²æŸ“ï¼Œé¡µé¢éš¾å…é€ æˆé˜»å¡ã€‚æ¥ä¸‹æ¥ä¼˜åŒ– ShippingFormã€‚

> å®˜æ–¹æ³¨é‡Šï¼šBy default, when a component re-renders, React re-renders all of its children recursively. 

ä¸ºäº†è§„é¿ç”± props å˜åŒ–é€ æˆçš„ä¸å¿…è¦çš„æ¸²æŸ“ï¼Œå¯ä»¥ä½¿ç”¨ memoï¼š

```js
const ShippingFormMemo = memo(function ShippingForm({ onSubmit }) {
  // ...
});
```

ä¸Šé¢è¿™ç§æƒ…å†µä¸‹ï¼Œå½“ props æ£€æµ‹å‡ºå˜åŒ–å‰åä¸€æ ·æ—¶ï¼Œè¢« memo åŒ…è£¹çš„ç»„ä»¶ä¸åšé‡æ–°æ¸²æŸ“ã€‚æ­¤æ—¶ï¼Œ**useCallback å°±èƒ½èµ·åˆ°ä½œç”¨äº†**ã€‚ä¸Šé¢çš„ä¾‹å­ï¼Œå¦‚æœä½ ä¸ä½¿ç”¨ useCallbackï¼Œç»„ä»¶æ¸²æŸ“å‰åï¼Œjs ä¼šåˆ›å»ºä¸¤æ¬¡ handleSubmitï¼Œä»–ä»¬åœ¨å†…å­˜ä¸­åœ°å€ä¸ä¸€æ ·ï¼Œè‡ªç„¶æ˜¯ä¸åŒçš„æ•°æ®ï¼Œæ­¤æ—¶ memo å°±å¤±æ•ˆäº†ï¼

æ‰€ä»¥ä¸ºäº† memo èƒ½å¤Ÿèµ·ä½œç”¨ï¼Œè¢«ä»–åŒ…è£¹çš„ ç»„ä»¶ä¸­çš„propsçš„å±æ€§åº”è¯¥ä½¿ç”¨ useCallbackã€‚

#### åœ¨ç¼“å­˜ä¸­ä½¿ç”¨ state

```js
function TodoList() {
  const [todos, setTodos] = useState([]);

  const handleAddTodo = useCallback(
    (text) => {
      const newTodo = { id: nextId++, text };
      setTodos([...todos, newTodo]);
    },
    [todos],
  );
  // ...
}
```

è®¾ç½® state çš„è¯­å¥å¯ä»¥å†™æˆä¸‹é¢å½¢å¼ï¼š

```js
const handleAddTodo = useCallback((text) => {
  const newTodo = { id: nextId++, text };
  setTodos((todos) => [...todos, newTodo]);
}, []); // âœ… No need for the todos dependency
```

#### é˜²æ­¢ useEffect è¿‡å¤šè§¦å‘

çœ‹ä¸‹é¢èŠå¤©å®¤çš„ä¾‹å­ï¼š

```js
function createOptions() {
  return {
    serverUrl: 'https://localhost:1234',
    roomId: roomId,
  };
}

useEffect(() => {
  const options = createOptions();
  const connection = createConnection();
  connection.connect();
  return () => connection.disconnect();
}, [createOptions]);
```

ç”¨ createOptions ä¼šé€ æˆå¾ªç¯æ£€æµ‹ï¼Œå¯¼è‡´ä¸€ç›´è°ƒç”¨ useEffect çš„æ­»å¾ªç¯ã€‚æ­¤æ—¶ï¼Œå¯ä»¥å°† createOptions ä¹Ÿç¼“å­˜ä¸€ä¸‹å³å¯ï¼š

```js
const createOptions = useCallback(() => {
  return {
    serverUrl: 'https://localhost:1234',
    roomId: roomId,
  };
}, [roomId]);
```

æ­¤æ—¶ï¼Œæ—¢ç„¶æœ‰ä¸€ä¸ªå¼•ç”¨é“¾ï¼Œæ ¹æºéƒ½ä¾èµ– roomIdï¼Œæ‰€ä»¥å¯ä»¥åˆå¹¶ï¼Œå› æ­¤æœ‰æ›´è¿›ä¸€æ­¥çš„æ”¹è¿›æ–¹æ¡ˆï¼š

```js
useEffect(() => {
  function createOptions() {
    // âœ… No need for useCallback or function dependencies!
    return {
      serverUrl: 'https://localhost:1234',
      roomId: roomId,
    };
  }

  const options = createOptions();
  const connection = createConnection();
  connection.connect();
  return () => connection.disconnect();
}, [roomId]); // âœ… Only changes when roomId changes
```

#### è‡ªå®šä¹‰ hook æ—¶ä½¿ç”¨

è‡ªå®šä¹‰ hook æ—¶ï¼Œæ¨èæ‰€æœ‰çš„å‡½æ•°ç¼“å­˜ä¸€ä¸‹ï¼Œä»¥ä¾¿äºåœ¨å¤–éƒ¨ä½¿ç”¨æ—¶ä¸ç•™æ€§èƒ½é—®é¢˜çš„å‘ï¼Œä¾¿äºéšæ—¶ä¼˜åŒ–æ€§èƒ½ï¼š

```js
function useRouter() {
  const { dispatch } = useContext(RouterStateContext);

  const navigate = useCallback(
    (url) => {
      dispatch({ type: 'navigate', url });
    },
    [dispatch],
  );

  const goBack = useCallback(() => {
    dispatch({ type: 'back' });
  }, [dispatch]);

  return {
    navigate,
    goBack,
  };
}
```

### QA

- å¦‚ä½•åœ¨å¾ªç¯åˆ—è¡¨é‡Œä½¿ç”¨ useCallback

ä¸å¯ä»¥ç›´æ¥ä½¿ç”¨ï¼Œä¼šç ´å hook çš„é“¾è¡¨ç»“æ„ã€‚æ¨èçš„åšæ³•æ˜¯å°†å…¬å…±ç»„ä»¶æå–å‡ºæ¥ï¼Œåœ¨æå–çš„å…¬å…±ç»„ä»¶ä¸­ä½¿ç”¨ã€‚

## 2. [useMemo]

useMemo ä¸ useCallback çš„åŸç†ç±»ä¼¼ã€‚å®ƒæ˜¯ç”¨æ¥ç¼“å­˜è®¡ç®—ç»“æœçš„ï¼Œç±»ä¼¼äº vue çš„è®¡ç®—å±æ€§ã€‚

å®šä¹‰ï¼š

```js
const cachedValue = useMemo(calculateValue, dependencies)
```

### ä½¿ç”¨

```js
import { useMemo } from 'react';  

function TodoList({ todos, tab }) {  
    const visibleTodos = useMemo(  
        () => filterTodos(todos, tab),  
        [todos, tab]  
    );  
    // ...  
}
```

### å‚æ•°

- fnï¼šç”¨æˆ·è¿”å›æƒ³è¦ç¼“å­˜çš„æ•°å€¼ï¼Œå¯ä»¥ä¼ é€’å‚æ•°
- ä¾èµ–é¡¹ï¼šç¼“å­˜æ›´æ–°çš„æ¡ä»¶

### å“åº”å¼è¿”å›å€¼

- åˆå§‹åŒ–æ—¶ï¼Œè¿”å›ä¸€æ¬¡ fn çš„è¿”å›å€¼
- ä¾èµ–é¡¹æ²¡æœ‰å˜åŒ–ï¼ˆObject.is åˆ¤æ–­ï¼‰ï¼Œè¿”å›ä¸Šæ¬¡ç¼“å­˜çš„å€¼ï¼Œå¦åˆ™è¿”å›æœ€æ–°çš„è®¡ç®—å€¼ï¼Œå¹¶å†æ¬¡ç¼“å­˜

### æ³¨æ„äº‹é¡¹

- åªèƒ½åœ¨å‡½æ•°å¼ç»„ä»¶é¡¶éƒ¨ä½¿ç”¨
- åœ¨ä¸¥æ ¼æ¨¡å¼ä¸‹ï¼ŒReactä¼šè°ƒç”¨è®¡ç®—å‡½æ•°ä¸¤æ¬¡ï¼Œä»¥å¸®åŠ©æ‚¨æŸ¥æ‰¾æ„å¤–æ‚è´¨ã€‚è¿™åªæ˜¯**å¼€å‘è¡Œä¸º**ï¼Œä¸å½±å“ç”Ÿäº§ã€‚å¦‚æœæ‚¨çš„è®¡ç®—å‡½æ•°æ˜¯çº¯çš„ï¼Œè¿™ä¸ä¼šå½±å“ç»„ä»¶çš„é€»è¾‘ã€‚å…¶ä¸­ä¸€ä¸ªè°ƒç”¨çš„ç»“æœå°†è¢«å¿½ç•¥ã€‚
- ç¼“å­˜è¢«ä¸¢å¼ƒçš„æƒ…å†µï¼šåœ¨å¼€å‘ä¸­ï¼Œå½“ç¼–è¾‘ç»„ä»¶æ–‡ä»¶æ—¶ï¼ŒReactä¼šä¸¢å¼ƒç¼“å­˜ã€‚åœ¨å¼€å‘å’Œç”Ÿäº§ç¯å¢ƒä¸­ï¼Œåœ¨ suspends åŠ è½½å‰çš„ç»„ä»¶ï¼Œä¸ä¼šç¼“å­˜å‡½æ•°ï¼ŒReactå°†ä¸¢å¼ƒç¼“å­˜ã€‚

### Future

- æœªæ¥æœŸæœ›æ·»åŠ å¯¹è™šæ‹ŸåŒ–åˆ—è¡¨çš„å†…ç½®æ”¯æŒã€‚æ­¤æ—¶ä¼šè‡ªåŠ¨ä¸¢å¼ƒä¸åœ¨å¯è§†çª—å£å†…çš„åˆ—è¡¨ç¼“å­˜ã€‚

### ä½¿ç”¨åœºæ™¯

#### è·³è¿‡æ²¡å¿…è¦çš„å€¼é‡è®¡ç®—

è¿™ä¸ªæ˜¯æœ€å¸¸ç”¨çš„ä½¿ç”¨åœºæ™¯ï¼Œåœ¨ä¾èµ–æ²¡æœ‰å˜åŒ–æ—¶ï¼Œä½¿ç”¨ç¼“å­˜å€¼ï¼Œè€Œä¸ç”¨é‡æ–°è®¡ç®—ï¼š

```js
import { useMemo } from 'react';

function TodoList({ todos, tab, theme }) {
  const visibleTodos = useMemo(() => filterTodos(todos, tab), [todos, tab]);
  // ...
}
```

è¿™é‡Œçš„è®¡ç®—å‡½æ•°ï¼Œå¯ç®€å•å¯å¤æ‚ã€‚å¦‚æœè®¡ç®—å‡½æ•°å¾ˆç®€å•ï¼Œé‚£ä¹ˆä¸ç¼“å­˜ä¸æ˜¯é—®é¢˜ï¼Œå› ä¸ºè®¡ç®—ä¼šå¾ˆå¿«ã€‚ç„¶è€Œï¼Œå¦‚æœè¦è¿‡æ»¤æˆ–è½¬æ¢å¤§å‹æ•°ç»„æˆ–è€…å¤æ‚çš„æ•°æ®ç»“æ„æ—¶ï¼Œæˆ–è¿›è¡Œä¸€äº›è€—æ—¶çš„è®¡ç®—ï¼ˆ`console.time`æ¥æµ‹è¯•ï¼‰æ—¶ï¼Œç¼“å­˜å°±å¾ˆæœ‰å¿…è¦äº†ã€‚

#### è·³è¿‡æ²¡å¿…è¦çš„ç»„ä»¶é‡æ¸²æŸ“

è¿˜ä»¥ä¸Šé¢çš„å¾…åŠåˆ—è¡¨çš„ä¾‹å­ï¼š

```js
export default function TodoList({ todos, tab, theme }) {
  // Every time the theme changes, this will be a different array...  
  const visibleTodos = filterTodos(todos, tab);
  
  return (
    <div className={theme}>
      <List items={visibleTodos} />
    </div>
  );
}
```

ä¸Šé¢çš„ä»£ç ï¼ŒåŸºäº React çš„æ¸²æŸ“åŸç†ï¼Œå½“ä¸€ä¸ªç»„ä»¶é‡æ¸²æŸ“ï¼Œå…¶å­ç»„ä»¶ä¼šå…¨éƒ¨é‡æ¸²æŸ“ã€‚æ‰€ä»¥ theme å˜åŒ–åï¼ŒList ç»„ä»¶å°±ä¼šè¢«é‡æ¸²æŸ“ã€‚æˆ‘ä»¬ä½¿ç”¨ memo æ£€æµ‹ props å˜åŒ–ï¼š

```js
import { memo } from 'react';

const List = memo(function List({ items }) {
  // ...
});
```

ä½†è¿˜æ˜¯ä¹‹å‰çš„é—®é¢˜ï¼Œprops ä¼ å…¥çš„å¯¹è±¡ä¹Ÿåº”è¯¥ç¼“å­˜ã€‚æ¯æ¬¡ TodoList é‡æ¸²æŸ“ï¼ŒvisibleTodos åˆ—è¡¨æ˜¯ä¸€ä¸ªä¸åŒçš„å€¼äº†ï¼Œæ‰€ä»¥ï¼ŒList çš„ memo ä¼šå¤±æ•ˆã€‚å› ä¸º visibleTodos ä¸æ˜¯å‡½æ•°ï¼Œæˆ‘ä»¬ä¸ç”¨ useCallbackï¼Œæˆ‘ä»¬ä½¿ç”¨ useMemoï¼š

```js
const visibleTodos = useMemo(
  () => filterTodos(todos, tab),
  [todos, tab] // ...so as long as these dependencies don't change...
);
```

#### ç¼“å­˜ä¸€ä¸ª hook çš„ä¾èµ–å…³ç³»

å‡è®¾æœ‰ä¸ªåœ¨ç»„ä»¶å†…éƒ¨æ–°åˆ›å»ºçš„å¯¹è±¡ï¼š

```js
function Dropdown({ allItems, text }) {
  const searchOptions = { matchMode: 'whole-word', text };

  const visibleItems = useMemo(() => {
    return searchItems(allItems, searchOptions);
  }, [allItems, searchOptions]); // ğŸš© Caution: Dependency on an object created in the component body
  // ...
}
```
ä¸Šé¢ä¾‹å­ä¸­ï¼ŒsearchOptions å°±æ˜¯ä¸€ä¸ªæ–°çš„å¯¹è±¡ï¼Œæ¯æ¬¡æ¸²æŸ“ç»„ä»¶éƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ã€‚è¿™å°±åˆä¼šé€ æˆ ä¸‹è¾¹ useMemo å¤±æ•ˆï¼Œæˆ‘ä»¬å¯ä»¥è¿™æ ·ï¼š

```js
const searchOptions = useMemo(() => {  
  return { matchMode: 'whole-word', text };  
}, [text]); // âœ… Only changes when text changes
```

å½“ç„¶ï¼Œä¹Ÿå¯ä»¥ä¸¤ä¸ª useMemo åˆå¹¶ä¸€ä¸ªï¼š

```js
const visibleItems = useMemo(() => {
  const searchOptions = { matchMode: 'whole-word', text };
  return searchItems(allItems, searchOptions);
}, [allItems, text]); // âœ… Only changes when allItems or text changes
```

#### ç¼“å­˜å‡½æ•°

ä¸¾ä¸€ä¸ªè¡¨å•æäº¤çš„ä¾‹å­ï¼š

```js
export default function ProductPage({ productId, referrer }) {
  function handleSubmit(orderDetails) {
    post('/product/' + productId + '/buy', {
      referrer,
      orderDetails,
    });
  }

  return <Form onSubmit={handleSubmit} />;
}
```

handleSubmit æ¯æ¬¡é‡æ¸²æŸ“éƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„å¯¹è±¡ï¼Œå¯¼è‡´ Form å­ç»„ä»¶ä¹Ÿé‡æ¸²æŸ“äº†ã€‚é™¤äº†ä½¿ç”¨ useCallbackï¼Œè¿˜å¯ä»¥ä½¿ç”¨ useMemoï¼š

```js
const handleSubmit = useMemo(() => {
  return (orderDetails) => {
    post('/product/' + product.id + '/buy', {
      referrer,
      orderDetails,
    });
  };
}, [productId, referrer]);
```

åªéœ€è¦è®© useMemo çš„ fn è¿”å›ä¸€ä¸ªå‡½æ•°å°±è¡Œäº†ã€‚å®˜æ–¹å»ºè®®ï¼Œç¼“å­˜å‡½æ•°ä½¿ç”¨ useCallbackï¼Œè¿™æ ·ä¼šé¿å…å¤šå†™ä¸€ä¸ªåŒ…è£¹å‡½æ•°è€Œé€ æˆä»£ç å¯è¯»æ€§ä¸‹é™ã€‚

### QA

- **ä¸ºä»€ä¹ˆæˆ‘çš„è®¡ç®—å€¼æ¯æ¬¡æ¸²æŸ“éƒ½æ‰§è¡Œä¸¤æ¬¡**

å› ä¸ºï¼Œåœ¨ä¸¥æ ¼æ¨¡å¼ä¸‹ï¼ŒReactå°†è°ƒç”¨æŸäº›å‡½æ•°ä¸¤æ¬¡è€Œä¸æ˜¯ä¸€æ¬¡ã€‚è€Œä¸”è¿™åªåœç•™åœ¨å¼€å‘æ¨¡å¼ä¸‹ï¼Œåªè¦ä½ çš„ç»„ä»¶å’Œè®¡ç®—å‡½æ•°æ˜¯çº¯çš„ï¼Œè¿™å°±ä¸ä¼šå½±å“é€»è¾‘ã€‚ä½†æ˜¯ä¸ºäº†è®©ä»£ç æ›´å¥å£®ï¼Œä¸‹é¢çš„ä»£ç å°±æ˜¯å¯æ”¹è¿›çš„ï¼š

```js
const visibleTodos = useMemo(() => {
  // ğŸš© Mistake: mutating a prop
  todos.push({ id: 'last', text: 'Go for a walk!' });
  const filtered = filterTodos(todos, tab);
  return filtered;
}, [todos, tab]);
```
todosä½œä¸ºä¾èµ–é¡¹ ä¼šè¢« push ä¸¤æ¬¡ï¼Œæˆ‘ä»¬å¯ä»¥è¿™æ ·å†™ï¼š

```js
const visibleTodos = useMemo(() => {
  const filtered = filterTodos(todos, tab);
  // âœ… Correct: mutating an object you created during the calculation
  filtered.push({ id: 'last', text: 'Go for a walk!' });
  return filtered;
}, [todos, tab]);
```
è¿™æ ·å°±ä¿è¯äº† useMemo ä¾èµ–çš„ä¸€è‡´æ€§ã€‚å³ä½¿è°ƒç”¨äº†ä¸¤æ¬¡ï¼Œé‚£ä¸ªå¯¹è±¡ä¹Ÿä¸ä¼šè¢« push ä¸¤ä¸ªç›¸åŒçš„å¯¹è±¡ã€‚

- **ä¸ºä»€ä¹ˆæˆ‘çš„ useMemo è¿”å›äº† undefined**

é”™è¯¯ä»£ç ç¤ºä¾‹ï¼š

```js
// ğŸ”´ You can't return an object from an arrow function with () => {
const searchOptions = useMemo(() => {
  matchMode: 'whole-word',
  text: text
}, [text]);
```
åŸå› ï¼šæ²¡æœ‰å†™è¿”å›å€¼ã€‚ä½ åº”è¯¥æŠŠæƒ³è¦çš„å¯¹è±¡ return è¿”å›å‡ºå»ã€‚å¯èƒ½å¯¹ç®­å¤´å‡½æ•°çš„ä½¿ç”¨è¿˜ä¸å¤ªç†Ÿæ‚‰ã€‚

- **å¦‚ä½•åœ¨å¾ªç¯åˆ—è¡¨é‡Œä½¿ç”¨ useMemo**

ä¸å¯ä»¥ç›´æ¥ä½¿ç”¨ï¼Œä¼šç ´å hook çš„é“¾è¡¨ç»“æ„ã€‚æ¨èçš„åšæ³•æ˜¯å°†å…¬å…±ç»„ä»¶æå–å‡ºæ¥ï¼Œåœ¨æå–çš„å…¬å…±ç»„ä»¶ä¸­ä½¿ç”¨ã€‚64:T1da3,> æœ‰åˆ†äº«æ‰æœ‰è¿›æ­¥ï¼Œæ¬¢è¿å¤§å®¶æ‰¹è¯„æŒ‡æ­£

æœ€è¿‘åœ¨å¼€å‘ä¸€ä¸ªå›½é™…ç«™é¡¹ç›®ï¼Œæ¶‰åŠåˆ°çš„ä»»åŠ¡æµè½¬å¯èƒ½ä¼šè·¨å¤šä¸ªå›½å®¶å’Œåœ°åŒºï¼Œè¿™å°±æ¶‰åŠåˆ°æ—¶é—´å·®çš„é—®é¢˜äº†ã€‚æœ¬æ–‡å°±æ¥æ¢³ç†ä¸€ä¸‹æˆ‘åœ¨å®é™…å¼€å‘ä¸­æ¶‰åŠåˆ°çš„å‰ç«¯æ—¶åŒºçš„é€»è¾‘å¤„ç†æ–¹æ¡ˆã€‚

## 1. å®é™…ä¸šåŠ¡åœºæ™¯

åœ¨ Asia/shanghai æ—¶åŒºä¸‹åˆ›å»ºå®šæ—¶æµè½¬ä»»åŠ¡æ—¶ï¼Œäº§å“ä¼šæœ‰è¦æ±‚ï¼šè®¾ç½®ä¸ºè¿ªæ‹œæ—¶é—´çš„ `2023-06-24 23:00:00` ç‚¹è§¦å‘ä»»åŠ¡æµç¨‹ï¼Œè¿™å°±ç‰µæ‰¯åˆ°æ—¶åŒºè½¬æ¢çš„é—®é¢˜ï¼›åŒæ—¶ï¼Œåœ¨ Asia/shanghai æ—¶åŒºä¸‹åˆ›å»ºçš„ä»»åŠ¡ï¼Œåœ¨ä¸–ç•Œå…¶ä»–å„ä¸ªæ—¶åŒºä¸‹çœ‹åˆ°çš„åº”è¯¥æ˜¯ä¸åŒçš„æ—¶é—´ï¼Œä½†æ˜¯è¿™é‡Œéœ€è¦æ ¼å¼åŒ–ä¸ºåŒä¸€ä¸ªæ—¶é—´ï¼ˆåˆ›å»ºåœ°çš„ï¼‰æ ¼å¼ï¼Œå¹¶æ ‡æ˜ `UTC +8`ã€‚

> æˆ‘ä»¬æ¥ä¸¾ä¸ªè¿‘ä¸€ç‚¹çš„ä¾‹å­ï¼š æ‹¿ä¸œäº¬ä¸¾ä¾‹ï¼Œæ˜¯ `UTC+9` æ—¶åŒºï¼Œæ¯”æˆ‘ä»¬å¿«äº†ä¸€ä¸ªæ—¶åŒºã€‚å¦‚æœåœ¨ Asia/shanghai æ—¶åŒºä¸‹é€‰æ‹©äº†è®¾å®šåœ¨ä¸œäº¬çš„ `2023-06-24 00:00:00` ä¸‹è§¦å‘ï¼Œé‚£ä¹ˆè¿™ä¸ªæ—¶é—´ä»¥ä¸œäº¬æ—¶é—´æ ¼å¼åŒ–ä¸ºæ—¶é—´æˆ³åï¼Œåœ¨ä¸Šæµ·æœ¬åœ°æ ¼å¼åŒ–ï¼Œåº”è¯¥æ˜¯ `2023-06-23 23:00:00`

åŸºäºä¸Šé¢çš„ä¸šåŠ¡åœºæ™¯ï¼Œæˆ‘è¿™é‡Œç»™å‡ºäº†å‡ ç§å¤„ç†æ–¹æ¡ˆï¼š

## 2. æ–¹æ¡ˆä¸€ã€åç«¯è°ƒæ•´æ—¶åŒº

å¯ä»¥ç›´æ¥æŠŠé€‰æ‹©çš„æ—¶é—´å­—ç¬¦ä¸² `2023-06-24 00:00:00` å’Œéœ€è¦è®¾ç½®çš„å½“åœ°æ—¶é—´çš„æ—¶åŒº `Asia/Tokyo` ç»™åˆ°åç«¯ï¼Œåç«¯æ¥æ ¹æ®æ—¶åŒºå°†æ—¶é—´å­—ç¬¦ä¸²æ ¼å¼åŒ–ä¸ºç›¸å¯¹äºä¸œäº¬çš„æ—¶é—´æˆ³ã€‚

ä»¥ Go ä¸ºä¾‹ï¼Œtime åŒ…ä¸‹å°±æœ‰æŒ‰ç…§æ—¶åŒºæ ¼å¼åŒ–çš„å‡½æ•°ï¼š

```go
layout := "2006-01-02 15:04:05"
value := "2023-06-24 00:00:00"
location := time.LoadLocation("Asia/Tokyo")
t := time.ParseInLocation(layout, value, location)

fmt.Println("Parsed time:", t.unix())
```

è¿™æ ·å°±èƒ½åœ¨æ•°æ®åº“é‡Œå­˜ä¸‹æ‰€é€‰æ—¶é—´çš„æ—¶åŒºå’Œç»å¯¹çš„æ—¶é—´æˆ³äº†ã€‚

è¿™æ—¶ä½ ä¼šé—®ï¼Œé‚£ä¹ˆæˆ‘å‰ç«¯å¦‚ä½•è·å–åˆ° `Asia/Tokyo` è¿™ä¸ªæ­£ç¡®çš„æ—¶åŒºæ ¼å¼ç»™åˆ°åç«¯å‘¢ï¼Ÿ

1. ä½¿ç”¨ moment-timezone åº“

```js
import moment from 'moment-timezone';

moment.tz.names(); // ["Africa/Abidjan", "Africa/Accra", "Africa/Addis_Ababa", ...]
```

é€‰æ‹©å®Œæ—¶åŒºåï¼Œå¯ä»¥é€šè¿‡ `const zone = moment.tz.zone('Asia/Tokyo');` æ¥è·å–æ—¶åŒºå¯¹è±¡ï¼Œå¯¹è±¡é‡Œä¾¿æœ‰äº† offset ç­‰ä¿¡æ¯ã€‚

å®é™…åœ¨é¡¹ç›®è½åœ°ä¸­ï¼Œmomentåº“æ¯”è¾ƒå¤§ï¼Œä¸€èˆ¬ä½¿ç”¨ dayjs ä»£æ›¿ï¼Œä½†æ˜¯ dayjs ä¸­æ²¡æœ‰ç›¸å…³çš„æ—¶åŒº APIï¼Œæ‰€ä»¥è¿™ä¸ªæ—¶åŒºåˆ—è¡¨ï¼Œæˆ‘åœ¨æœ¬åœ°ä½¿ç”¨ moment è·å–åˆ°ä»¥ååšäº†æœ¬åœ°çš„ç‰¹æ®Šæ ¼å¼åŒ–ï¼Œå¹¶ä½œä¸ºé™æ€æ–‡ä»¶æŒ‚è½½åœ¨ CDN ä¸Šäº†ï¼Œæ•°ç»„ç»“æ„å¦‚ä¸‹ï¼š

```js
[
  {
    value: 'Japan Standard Time',
    abbr: 'JST',
    offset: 9,
    isdst: false,
    text: '(UTC+09:00) Osaka, Sapporo, Tokyo',
    UTC: ['Asia/Dili', 'Asia/Jayapura', 'Asia/Tokyo', 'Etc/GMT-9', 'Pacific/Palau']
  },
  {
    value: 'China Standard Time',
    abbr: 'CST',
    offset: 8,
    isdst: false,
    text: '(UTC+08:00) Beijing, Chongqing, Hong Kong, Urumqi',
    UTC: ['Asia/Hong_Kong', 'Asia/Macau', 'Asia/Shanghai']
  },
  // ...
]
```

ä¸Šé¢çš„ offset æ˜¯ç›¸å¯¹äº UTC æ ‡å‡†æ—¶åŒºçš„åå·®ï¼Œè¯¥å€¼å¯ä»¥ä» moment çš„ zone å¯¹è±¡ä¸­è·å–ã€‚

> Zone å¯¹è±¡é‡Œ offsets å¸¸è§çš„æœ‰ PST æ—¶åŒº å’Œ PDT æ—¶åŒºï¼Œå‰è€…ä¸ºå¤ªå¹³æ´‹æ ‡å‡†æ—¶é—´ï¼ˆè‹±æ–‡ï¼š*Pacific Standard Time*ï¼Œç¸®å¯«ï¼š*PST*ï¼‰ï¼ŒUTC-8ï¼›åè€…ä¸ºå¤ä»¤æ—¶é—´ï¼ˆå¤å­£ï¼‰ç§°ä¸ºå¤ªå¹³æ´‹å¤ä»¤æ—¶é–“ï¼ˆè‹±æ–‡ï¼šPacific Daylight Timeï¼Œç¸®å¯«ï¼š*PDT*ï¼‰ï¼ŒUTC-7ï¼›ä½¿ç”¨å…¶ä¸­ä¸€ä¸ªï¼Œæ ¹æ®åå·®åšåŠ å‡å³å¯ã€‚

2. ä½¿ç”¨åŸç”Ÿçš„ Intl å¯¹è±¡

å¦‚æœä¸éœ€è¦äº¤äº’é€‰æ‹©æ—¶åŒºåˆ—è¡¨ï¼Œåªæ˜¯åœ¨é¡µé¢ä¸Šæ ¹æ®å½“åœ°æ—¶åŒºæ ¼å¼åŒ–æ—¶é—´æˆ³ï¼Œå¯ä»¥ä½¿ç”¨jsåŸç”Ÿçš„ Intl å¯¹è±¡ï¼š

```js
const timeZone = Intl.DateTimeFormat().resolvedOptions().timeZone;
console.log(timeZone); // Asia/Shanghai
```

è€Œä¸”è¯¥æ–¹æ³•çš„å…¼å®¹æ€§ç›®å‰å·²ç»æ¯”è¾ƒå¥½äº†ï¼š


![image.png](/img/posts/2023-6-26/2023-6-26-1.png)

è¿™æ ·åœ¨ä¸­å›½çš„é¡µé¢ä¸Šè¿™æ ·æ˜¾ç¤ºï¼š

```
(Asia/Shanghai UTC +8) 2023-06-23 23:00:00
```

åœ¨æ—¥æœ¬çš„é¡µé¢è¿™æ ·æ˜¾ç¤ºï¼š

```
(Asia/Tokyo UTC +9) 2023-06-24 00:00:00
```

## 3. æ–¹æ¡ˆäºŒã€å‰ç«¯æ ¼å¼åŒ–ä¸ºæ—¶é—´æˆ³

è¿™ç§æ–¹æ¡ˆä¸ä¾èµ–åç«¯ï¼Œå‰ç«¯é€‰æ‹©æ—¶åŒºï¼Œå‰ç«¯è½¬æ¢ä¸ºç»å¯¹å€¼æ—¶é—´æˆ³ç»™åˆ°åç«¯ã€‚è·å–æ—¶åŒºåˆ—è¡¨çš„æ–¹å¼å‚è§æ–¹æ¡ˆä¸€ã€‚è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨æ‰‹åŠ¨æ—¶åŒºè½¬æ¢çš„æ€è·¯ï¼Œè·å–åˆ°åº”è¯¥è½¬æ¢ä¸ºä¸Šæµ·æ—¶é—´çš„æ—¶é—´å­—ç¬¦ä¸²ï¼Œå³ï¼Œå°† `2023-06-24 00:00:00` è½¬æ¢ä¸º `2023-06-23 23:00:00`ã€‚

åœ¨è·å–åˆ°æ—¶åŒº `timeZoneOffset` ï¼ˆè¿™é‡Œæ˜¯ 9ï¼‰ å’Œ æ—¶é—´å­—ç¬¦ä¸² `time` ï¼ˆè¿™é‡Œæ˜¯ 2023-06-24 00:00:00ï¼‰åï¼Œå‰ç«¯æŒ‰ç…§å½“åœ°æ—¶é—´æ¨¡æ‹Ÿæ—¶åŒºå˜åŒ–æ¥å¤„ç†ï¼š

```js
// æ¨¡æ‹Ÿè½¬æ¢ä¸ºæ ‡å‡† UTC æ—¶é—´ï¼Œè¿™é‡Œå‡å»9ä¸ªå°æ—¶å³å¯
const UTC = dayjs(time).add(-timeZoneOffset, 'hour');
// è·å–æµè§ˆå™¨å½“åœ°æ—¶é—´çš„å°æ—¶å·®ï¼ŒoffsetHours å¦‚æœåœ¨ä¸Šæµ·ï¼Œå°±æ˜¯ 8
const date = new Date();
const offsetHours = -(date.getTimezoneOffset() / 60);
// å°†ä¸Šé¢çš„ UTC åŠ ä¸Šæµè§ˆå™¨æœ¬åœ°çš„æ—¶å·® 
const result = dayjs(UTC).add(offsetHours, 'hour');
```

é€šè¿‡ä¸Šè¿°æ“ä½œï¼Œå°±å°†ä¸œäº¬æ—¶é—´çš„ `2023-06-24 00:00:00` è½¬æ¢ä¸ºä¸Šæµ·æ—¶åŒºçš„ `2023-06-23 23:00:00`ï¼Œæ­¤æ—¶åœ¨å°†è¿™ä¸ª result è½¬æ¢ä¸ºæ—¶é—´æˆ³å³å¯ï¼š

```js
result.unix() // 1687532400
```


## 4. æ–¹æ¡ˆä¸‰ã€dayjsæ ¼å¼åŒ–ä¸ºæ—¶é—´æˆ³

è¯¥æ–¹æ¡ˆä¸ºæ–¹æ¡ˆäºŒçš„å˜ç§ï¼Œåªæ˜¯ä¸ç”¨åŸç”Ÿæ“ä½œæ—¶åŒºå·®æ¥è®¡ç®—ï¼Œè€Œæ˜¯ä½¿ç”¨ dayjs å†…ç½®çš„æ–¹æ³•æ›¿ä»£ä¹‹ï¼š

```js
const d = dayjs.tz('2023-06-24 00:00:00', 'Asia/Tokyo')
console.log(d.format()) // 2023-06-24T00:00:00+09:00
console.log(d.unix()) // 1687532400
```


![image.png](/img/posts/2023-6-26/2023-6-26-2.png)

è¯¥æ–¹æ³•çš„å‰ææ˜¯å¼•å…¥æ—¶åŒºæ’ä»¶ï¼š

```js
import timezone from 'dayjs/plugin/timezone';

dayjs.extend(timezone);
```

è¿™ç§æ–¹æ¡ˆçš„ç¼ºç‚¹æ˜¯å¿…é¡»æå‰ä¼ å…¥æ—¶åŒºå­—ç¬¦ä¸²ã€‚æ–¹æ¡ˆäºŒä¸éœ€è¦ä»»ä½•æ¡ä»¶ï¼Œåªéœ€è¦çŸ¥é“æ˜¯ UTC å‡ çš„æ—¶åŒºå°±å¯ä»¥äº†ã€‚

## 5. é€†å‘ï¼šæ—¶é—´æˆ³å±•ç¤ºä¸ºç»™å®šæ—¶åŒºçš„æ—¶é—´

ä¸Šé¢è®²äº†æ€ä¹ˆæŠŠæœ¬åœ°æ—¶é—´é€‰æ‹©å™¨é€‰ä¸­çš„æŒ‡å®šæ—¶åŒºçš„æ—¶é—´ï¼ˆdayjsï¼‰æŒ‰ç…§æ‰€é€‰æ—¶åŒºæ ¼å¼åŒ–ä¸ºæ—¶é—´æˆ³ã€‚ä¸‹é¢è¯´çš„æ˜¯ä»–çš„é€†å‘ï¼šæ€ä¹ˆä»æ—¶é—´æˆ³æ ¼å¼åŒ–ä¸ºæ‰€åœ¨æ—¶åŒºçš„æ—¶é—´å­—ç¬¦ä¸²ã€‚

> æ¯”å¦‚æ—¶é—´æˆ³ï¼š1688439600ï¼Œä»–åœ¨åŒ—äº¬æ—¶é—´æ˜¯ 2023-7-4 11:00:00ï¼Œåœ¨ä¸œäº¬æ—¶é—´ï¼ˆUTC +9ï¼‰åº”è¯¥å¿«ä¸€ä¸ªå°æ—¶

æŒ‰ç…§ä¸Šè¾¹çš„ä¾‹å­ï¼Œæˆ‘ä»¬å¯ä»¥å¯¹æ¯”æµè§ˆå™¨æ‰€åœ¨æ—¶åŒºå’Œç»™å®š offset çš„å·®å€¼æ¥æ¯”å¯¹ï¼Œè¿›è€Œå°†æ—¶é—´åŠ æˆ–è€…å‡å¯¹åº”çš„å°æ—¶æ•°å³å¯ï¼š

```js
// ä¼ å…¥ 1688439600ï¼Œ9
export const showWithTimeZone = (timestamp, timeZoneOffset) => {
  if (typeof timeZoneOffset === 'number') {
    const date = new Date();
    const offsetHours = -(date.getTimezoneOffset() / 60);

    // ç»™å®šæ—¶åŒºä¸æµè§ˆå™¨æœ¬åœ°æ—¶åŒºçš„å·®å¼‚
    const offset = timeZoneOffset - offsetHours;
    // ç›´æ¥åŠ æ³•å³å¯ï¼Œå¦‚æœæ—¶åŒºå¿«ï¼Œå°±æ˜¯æ­£æ•°ï¼Œå¦è‡ªæ˜¯è´Ÿæ•°
    const result = dayjs(timestamp * 1000).add(offset, 'hour');

    return {
      format: `(UTC ${timeZoneOffset > 0 ? '+' + timeZoneOffset : timeZoneOffset + ''}) ${result.format('YYYY-MM-DD HH:mm:ss')}`
    };
  }
};
```

å¦‚æ­¤ï¼Œåœ¨ç•Œé¢å°±ä¼šçœ‹åˆ°ï¼š


![image.png](/img/posts/2023-6-26/2023-6-26-3.png)

## 6. æ€»ç»“

ä¸ªäººä½¿ç”¨çš„æ˜¯æ–¹æ¡ˆä¸‰å’Œæ–¹æ¡ˆä¸€çš„ç»“åˆï¼Œè·å–åˆ°æ—¶åŒºåˆ—è¡¨å¹¶ç¼“å­˜CDNåï¼Œå‰ç«¯é€‰æ‹©æ—¶åŒºå¹¶è½¬æ¢ä¸ºç»å¯¹å€¼æ—¶é—´æˆ³ï¼Œåç«¯è¿›è¡ŒäºŒæ¬¡æ ¡éªŒå¹¶åœ¨åˆ—è¡¨æ˜¾ç¤ºçš„åœ°æ–¹æ ¼å¼åŒ–ä¸ºå­—ç¬¦ä¸²è¿”å›ã€‚

> éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç½‘ä¸Šè·å–åˆ°çš„æ—¶åŒºåç§»å¯èƒ½ä¼šæœ‰å»¶è¿Ÿï¼ˆæœ‰äº›åŸå¸‚ä¼šä¸åœè°ƒæ•´æ—¶åŒºï¼‰ï¼Œæ¯”å¦‚æŸæ—çš„æ—¶åŒºï¼Œæˆ‘åœ¨åˆ—è¡¨é‡Œçš„æ˜¯ +1ï¼Œä½†æ˜¯ç½‘ä¸Šæœåˆ°çš„æœ€æ–°æ¶ˆæ¯æ˜¯ GMT+2 çš„ï¼Œä½†æ˜¯ä»Šå¹´10æœˆä»½åˆä¼šè°ƒå› +1ã€‚æˆ‘è¿™é‡Œå°±è¿˜ä»¥momentè·å–çš„æ•°æ®ä¸ºå‡†äº†ã€‚


![image.png](/img/posts/2023-6-26/2023-6-26-4.png)65:T484f,> æœ¬æ–‡é’ˆå¯¹ ESLint 8+ ç‰ˆæœ¬

## 1. é…ç½®æ–‡ä»¶æ ¼å¼

ESLint é…ç½®æ–‡ä»¶å¯ä»¥ä½¿ç”¨å¤šç§æ–‡ä»¶æ ¼å¼ï¼Œå¸¸ç”¨çš„æœ‰ä»¥ä¸‹å‡ ç§ï¼š

-   .eslintrc.jsï¼šä½¿ç”¨ JavaScript ç¼–å†™çš„é…ç½®æ–‡ä»¶ï¼Œè¿”å›ä¸€ä¸ªé…ç½®å¯¹è±¡ã€‚
-   .eslintrc.yamlã€.eslintrc.ymlï¼šä½¿ç”¨ YAML è¯­è¨€ç¼–å†™çš„é…ç½®æ–‡ä»¶ã€‚
-   .eslintrc.jsonï¼šä½¿ç”¨ JSON æ ¼å¼ç¼–å†™çš„é…ç½®æ–‡ä»¶ã€‚
-   .eslintrc.cjsï¼šä½¿ç”¨è¿™ç§é…ç½®æ—¶ï¼Œä¸­éœ€è¦åœ¨`package.json`ä¸­é…ç½®`type":"module"`ã€‚
-   eslintConfigï¼šä½¿ç”¨npmåŒ…è¿›è¡Œé…ç½®ã€‚
-   .eslintrcï¼šæ™®é€šé…ç½®æ–‡ä»¶

æ­¤å¤–è¿˜æœ‰è¡Œå†…é…ç½®ï¼š

-   `/* eslint-disable */` å’Œ `/* eslint-enable */`ï¼Œç¦ç”¨å¯ç”¨è§„åˆ™
-   `/* global */`ï¼Œå®šä¹‰å…¨å±€å˜é‡
-   `/* eslint */`ï¼Œé…ç½®è§„åˆ™
-   `/* eslint-env */`ï¼ŒæŒ‡å®šå½“å‰è¿è¡Œç¯å¢ƒ

ç°åœ¨ï¼Œæœ‰ä¸€ç§æ–°çš„é…ç½®æ–‡ä»¶ç±»å‹ï¼š`eslint.config.js`ï¼Œå®˜æ–¹å°†åœ¨ v9 ç‰ˆæœ¬å…¨é¢ä½¿ç”¨è¯¥é…ç½®ç±»å‹ã€‚



å…¶ä¸­ï¼Œæ¨èä½¿ç”¨ .js æ–‡ä»¶æ ¼å¼ï¼Œå› ä¸ºå®ƒå¯ä»¥ä½¿ç”¨ JavaScript çš„æ‰€æœ‰ç‰¹æ€§ï¼Œæ–¹ä¾¿ç¼–å†™å¤æ‚çš„é…ç½®è§„åˆ™ã€‚æœ¬æ–‡ä»¥æ¨èçš„æ ¼å¼ä¸ºä¾‹æ¥è®²è§£é…ç½®:

```js
// .eslintrc.js
module.exports = {
...
}
```

```js
//eslint.config.js
export default [

]
```

## 2. å¸¸ç”¨é…ç½®é¡¹

### root

æŒ‡å®šESLintåœ¨æŸ¥æ‰¾é…ç½®æ–‡ä»¶æ—¶çš„èµ·å§‹ä½ç½®ã€‚

å‡è®¾ç°åœ¨ç›®å½•å±‚çº§å¦‚ä¸‹ï¼š

```bash
project/
â”œâ”€â”€ package.json
â”œâ”€â”€ .eslintrc.js
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ .eslintrc.js
â”‚   â””â”€â”€ index.js
â””â”€â”€ test/
    â”œâ”€â”€ .eslintrc.js
    â””â”€â”€ test.js
```

æˆ‘ä»¬åœ¨ é¡¶å±‚.eslintrc.js ä¸­é…ç½® rootï¼š

```
// project/.eslintrc.js
module.exports = {
  root: true,
  // ...
}
```
è¿™å‘Šè¯‰äº†ESLintåº”è¯¥ä½¿ç”¨æ­¤æ–‡ä»¶ä½œä¸ºèµ·å§‹ä½ç½®æ¥æŸ¥æ‰¾å…¶ä»–é…ç½®æ–‡ä»¶ã€‚è¿™å°†ç¡®ä¿ESLintå§‹ç»ˆä½¿ç”¨project/.eslintrc.jsä½œä¸ºé¡¹ç›®ä¸­æ‰€æœ‰æ–‡ä»¶çš„é…ç½®æ–‡ä»¶ï¼Œè€Œä¸æ˜¯ä½¿ç”¨å­ç›®å½•ä¸­çš„å…¶ä»–é…ç½®æ–‡ä»¶ã€‚

å¦‚æœåœ¨ä¸Šè¿°çš„ä¾‹å­ä¸­æ²¡æœ‰æŒ‡å®š"root"å­—æ®µï¼ŒESLintä¼šä½¿ç”¨æœ€è¿‘çš„é…ç½®æ–‡ä»¶æ¥æ£€æµ‹ä»£ç ï¼Œå¦‚æœå½“å‰ç›®å½•ä¸‹æ²¡æœ‰é…ç½®æ–‡ä»¶ï¼ŒESLintä¼šç»§ç»­å‘ä¸ŠæŸ¥æ‰¾çˆ¶ç›®å½•ï¼Œç›´åˆ°æ‰¾åˆ°ä¸€ä¸ªé…ç½®æ–‡ä»¶ä¸ºæ­¢ã€‚

### env

ç”¨æ¥æŒ‡å®šæ ¡éªŒç¯å¢ƒã€‚å®ƒå‘Šè¯‰ ESLint ä»£ç è¿è¡Œåœ¨å“ªä¸ªç¯å¢ƒä¸­ï¼Œä»è€Œå¸®åŠ© ESLint æ›´å¥½åœ°ç†è§£æ‚¨çš„ä»£ç å¹¶æ£€æµ‹æ½œåœ¨çš„é—®é¢˜ã€‚

é…ç½®å¦‚ä¸‹ï¼š

```js
env: {
  es6: true /** å¯ç”¨é™¤äº†modulesä»¥å¤–çš„æ‰€æœ‰ ES6 ç‰¹æ€§,å¼€å¯åä¼šè‡ªåŠ¨è®¾ç½®ecmaVersionä¸º6 */,
  node: true /** Node.js å…¨å±€å˜é‡å’Œ Node.js ä½œç”¨åŸŸ */,
  browser: true /** æµè§ˆå™¨å…¨å±€å˜é‡ */,
  commonjs: true /**  CommonJS å…¨å±€å˜é‡å’Œ CommonJS ä½œç”¨åŸŸ (ç”¨äº Browserify/WebPack æ‰“åŒ…çš„åªåœ¨æµè§ˆå™¨ä¸­è¿è¡Œçš„ä»£ç ) */,
  jest: false /** Jest å…¨å±€å˜é‡ */,
  jquery: false /** jQuery å…¨å±€å˜é‡ */,
  'shared-node-browser': false /** Node.js å’Œ Browser é€šç”¨å…¨å±€å˜é‡ */,
  worker: false /** Web Workers å…¨å±€å˜é‡ */,
  amd: false /** å°† require() å’Œ define() å®šä¹‰ä¸ºåƒ amd ä¸€æ ·çš„å…¨å±€å˜é‡ */,
  mocha: false /** æ·»åŠ æ‰€æœ‰çš„ Mocha æµ‹è¯•å…¨å±€å˜é‡ */,
  jasmine: false /** æ·»åŠ æ‰€æœ‰çš„ Jasmine ç‰ˆæœ¬ 1.3 å’Œ 2.0 çš„æµ‹è¯•å…¨å±€å˜é‡ã€‚ */,
  phantomjs: false /** phantomjs å…¨å±€å˜é‡ */,
  protractor: false /** protractor å…¨å±€å˜é‡ */,
  qunit: false /** QUnit å…¨å±€å˜é‡ */,
  prototypejs: false /** Prototype.js å…¨å±€å˜é‡ */,
  shelljs: false /** ShellJS å…¨å±€å˜é‡ */,
  meteor: false /** Meteor å…¨å±€å˜é‡ */,
  mongo: false /** MongoDB å…¨å±€å˜é‡ */,
  applescript: false /** AppleScript å…¨å±€å˜é‡ */,
  nashorn: false /** Java 8 Nashorn å…¨å±€å˜é‡ */,
  serviceworker: false /** Service Worker å…¨å±€å˜é‡ */,
  atomtest: false /** Atom æµ‹è¯•å…¨å±€å˜é‡ */,
  embertest: false /** Ember æµ‹è¯•å…¨å±€å˜é‡ */,
  webextensions: false /** WebExtensions å…¨å±€å˜é‡ */,
  greasemonkey: false /** GreaseMonkey å…¨å±€å˜é‡ */,
}
```

### parser

æŒ‡å®šç”¨äºè§£æJavaScriptä»£ç çš„è§£æå™¨ã€‚ESLinté»˜è®¤ä½¿ç”¨ esprima è§£æå™¨ï¼Œä½†æ˜¯å¯ä»¥é€šè¿‡"parser"é…ç½®æ¥ä½¿ç”¨å…¶ä»–è§£æå™¨ã€‚

å¸¸ç”¨çš„è§£æå™¨å¦‚ä¸‹ï¼š

1. esprimaï¼šé»˜è®¤çš„è§£æå™¨ï¼Œç”¨äºè§£æECMAScript 5åˆ°ECMAScript 2021ä¹‹é—´çš„JavaScriptä»£ç ã€‚
2.  @babel/eslint-parserï¼šç”±Babelé¡¹ç›®æä¾›çš„è§£æå™¨ï¼Œç”¨äºè§£æES6+ä»£ç ã€‚
3.  @typescript-eslint/parserï¼šç”±TypeScriptå›¢é˜Ÿæä¾›çš„è§£æå™¨ï¼Œç”¨äºè§£æTypeScriptä»£ç ã€‚
4.  eslint-plugin-htmlï¼šç”¨äºè§£æHTMLæ–‡ä»¶ä¸­çš„JavaScriptä»£ç ã€‚
5.  vue-eslint-parserï¼šç”¨äºè§£æVueå•æ–‡ä»¶ç»„ä»¶ä¸­çš„JavaScriptä»£ç ã€‚

### parserOptions

ç»™é…ç½®çš„è§£æå™¨æ·»åŠ å¯é€‰é…ç½®é¡¹ã€‚

å¦‚æœä½¿ç”¨çš„æ˜¯é»˜è®¤parseré…ç½®ï¼Œå¯ä»¥æœ‰å¦‚ä¸‹é…ç½®ï¼š
```js
// .eslintrc.js
module.exports = {
  parser: "esprima",
  parserOptions: {
    ecmaVersion: 2022, 
    sourceType: "module",
    range: true,
    loc: true,
  },
  // ...
}
```
å­—æ®µè§£æï¼š

-   `ecmaVersion`: æŒ‡å®šè¦è§£æçš„ ECMAScript ç‰ˆæœ¬ã€‚å¯ä»¥è®¾ç½®ä¸ºæ•°å­—ï¼ˆå¦‚ 3ã€5ã€6ã€7ã€8ã€9ã€10ã€11ã€12ã€13ã€2020ã€2021 ç­‰ï¼‰æˆ–å­—ç¬¦ä¸²ï¼ˆå¦‚ `"latest"`ï¼‰ã€‚é»˜è®¤ä¸º `5`ã€‚
-   `sourceType`: æŒ‡å®šè¦è§£æçš„æ¨¡å—ç³»ç»Ÿç±»å‹ã€‚å¯é€‰å€¼ä¸º `"script"`ï¼ˆé»˜è®¤ï¼‰æˆ– `"module"`ã€‚
-   `ecmaFeatures`: ä¸€ä¸ªå¯¹è±¡ï¼Œç”¨äºå¯ç”¨æˆ–ç¦ç”¨ ECMAScript ä¸­çš„ç‰¹å®šè¯­è¨€åŠŸèƒ½ã€‚å¯ç”¨çš„é€‰é¡¹åŒ…æ‹¬ï¼š
    -   `globalReturn`ï¼šå…è®¸åœ¨å…¨å±€ä½œç”¨åŸŸä¸­ä½¿ç”¨ return è¯­å¥ã€‚
    -   `impliedStrict`ï¼šå…è®¸åœ¨éä¸¥æ ¼æ¨¡å¼ä¸‹è§£æä¸ºä¸¥æ ¼æ¨¡å¼ã€‚
    -   `jsx`ï¼šå¯ç”¨ JSX è¯­æ³•ã€‚
    -   `experimentalObjectRestSpread`ï¼šå¯ç”¨å¯¹è±¡çš„ rest å’Œ spread æ“ä½œç¬¦ã€‚
-   `allowImportExportEverywhere`: å…è®¸åœ¨ä»£ç çš„ä»»ä½•ä½ç½®ä½¿ç”¨ import å’Œ export è¯­å¥ã€‚é»˜è®¤ä¸º `false`ã€‚
-   `codeFrame`: å½“å‘ç”Ÿè¯­æ³•é”™è¯¯æ—¶ï¼Œæä¾›æ›´è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯ã€‚é»˜è®¤ä¸º `true`ã€‚
-   `requireConfigFile`: å¦‚æœè®¾ç½®ä¸º `true`ï¼Œåˆ™å¿…é¡»æä¾› `tsconfig.json` æˆ– `.eslintrc.*` æ–‡ä»¶æ¥é…ç½®è§£æå™¨ã€‚é»˜è®¤ä¸º `false`ã€‚
-   `babelOptions`: ä¼ é€’ç»™ `@babel/parser` çš„é€‰é¡¹å¯¹è±¡ã€‚ç¤ºä¾‹å¦‚ä¸‹ï¼š
```js
babelOptions: {
  ecmaVersion: "es2020",
  ecmaFeatures: {
    globalReturn: true,
    jsx: true,
  },
  lib: ["ES2020"],
},
```
-   `tsconfigRootDir`: æŒ‡å®š TypeScript é…ç½®æ–‡ä»¶çš„æ ¹ç›®å½•ã€‚é»˜è®¤ä¸ºè§£æ `tsconfig.json` æ–‡ä»¶çš„ç›®å½•ã€‚

å¦‚æœä½¿ç”¨@babel/eslint-parserè§£æå™¨ï¼Œåˆ™å¯ä»¥æœ‰å¦‚ä¸‹é…ç½®ï¼š

```js
// .eslintrc.js
module.exports = {
  parser: "@babel/eslint-parser",
  parserOptions: {
    ecmaVersion: 2022,
    sourceType: "module",
    ecmaFeatures: {
      jsx: true,  //æ”¯æŒ jsx
    },
  },
  // ...
}
```

è‹¥ä½¿ç”¨ @typescript-eslint/parserï¼Œå¯ä»¥ä½¿ç”¨å¦‚ä¸‹é…ç½®ï¼š

```js
// .eslintrc.js
module.exports = {
  parser: "@typescript-eslint/parser",
  "parserOptions": {
    "ecmaVersion": 2021,
    "sourceType": "module",
    "project": "./tsconfig.json",
    "tsconfigRootDir": "./",
    "extraFileExtensions": [".tsm"]
  },
}
```

### globals

æŒ‡å®šå…¨å±€å˜é‡çš„ä¸€ä¸ªé…ç½®é¡¹ã€‚åœ¨ JavaScript ä¸­ï¼Œå¦‚æœä¸€ä¸ªå˜é‡æ²¡æœ‰ç»è¿‡å£°æ˜å°±è¢«ä½¿ç”¨ï¼Œä¼šå¯¼è‡´è¯¥å˜é‡è¢«å½“ä½œå…¨å±€å˜é‡å¤„ç†ï¼Œè¿™å¯èƒ½ä¼šå¯¼è‡´ä¸€äº›æ½œåœ¨çš„é—®é¢˜ã€‚é€šè¿‡é…ç½® `globals`ï¼Œæˆ‘ä»¬å¯ä»¥å‘Šè¯‰ ESLint è¿™äº›å˜é‡æ˜¯å…¨å±€å˜é‡ï¼Œä»è€Œé¿å…å‡ºç°è¿™ç§é—®é¢˜ã€‚

`globals` å¯ä»¥æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œé”®ä¸ºå…¨å±€å˜é‡çš„åç§°ï¼Œå€¼ä¸ºè¯¥å˜é‡çš„ä½¿ç”¨æƒ…å†µï¼Œå¯ä»¥æ˜¯ `readonly`ã€`writable` æˆ– `off`ã€‚ä¾‹å¦‚ï¼š

```js
{
  "globals": {
    "foo": "writable",
    "bar": "readonly",
    "baz": "off"
  }
}
```

åœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œ`foo` å’Œ `bar` éƒ½è¢«æŒ‡å®šä¸ºå…¨å±€å˜é‡ï¼Œ`foo` å¯ä»¥è¢«å†™å…¥ï¼Œè€Œ `bar` æ˜¯åªè¯»çš„ï¼Œ`baz` è¢«å…³é—­ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼ŒESLint ä¸ä¼šå¯¹å®ƒè¿›è¡Œä»»ä½•æ£€æŸ¥ã€‚

å¯ä»¥å°† `globals` è§†ä¸ºä¸€ä¸ªç™½åå•ï¼Œå…¶ä¸­åŒ…å«äº†æ˜ç¡®æŒ‡å®šçš„å…¨å±€å˜é‡ï¼Œè€Œå…¶ä»–æœªè¢«åˆ—å‡ºçš„å˜é‡ä¼šè¢«è®¤ä¸ºæ˜¯æœªå®šä¹‰çš„ï¼Œä»è€Œé¿å…äº†ä¸ç»æ„åœ°ä½¿ç”¨æœªå£°æ˜çš„å˜é‡è€Œå¯¼è‡´çš„é”™è¯¯ã€‚

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä½¿ç”¨å…¨å±€å˜é‡å¯èƒ½ä¼šé™ä½ä»£ç çš„å¯è¯»æ€§å’Œå¯ç»´æŠ¤æ€§ï¼Œå› æ­¤åº”è¯¥è°¨æ…ä½¿ç”¨ï¼Œå¹¶ä¸”åªåœ¨ç¡®å®éœ€è¦ä½¿ç”¨å…¨å±€å˜é‡æ—¶æ‰ä½¿ç”¨ã€‚åŒæ—¶ï¼Œ`globals` å¯èƒ½ä¹Ÿä¼šå¯¼è‡´ä¸€äº›ä¸å¯é¢„æµ‹çš„é—®é¢˜ï¼Œå› æ­¤å»ºè®®ä»…åœ¨å¿…è¦æ—¶ä½¿ç”¨ã€‚

### rules

é…ç½®æ–‡ä»¶ä¸­æœ€å¸¸ç”¨çš„é…ç½®é¡¹ä¹‹ä¸€ï¼Œç”¨äºè®¾ç½® ESLint çš„è§„åˆ™å’Œè§„åˆ™çš„é”™è¯¯ç­‰çº§ã€‚`rules` é…ç½®é¡¹æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œå®ƒçš„æ¯ä¸ªå±æ€§è¡¨ç¤ºä¸€ä¸ªè§„åˆ™ï¼Œå±æ€§å€¼è¡¨ç¤ºè¯¥è§„åˆ™çš„é”™è¯¯ç­‰çº§ã€‚

é…ç½®æ–¹å¼ï¼š

```js
"rules": {
    "eqeqeq": "off",  // å…³é—­å‘Šè­¦
    "no-undef": "warn", // è­¦å‘Šçº§åˆ«
    "react/prop-types": "error", // é”™è¯¯çº§åˆ«
}
```

é…ç½®é¡¹è¿˜æœ‰ç¬¬äºŒä¸ªå‚æ•°ï¼š

```js
"semi": ["error", "always"] // è¦æ±‚åœ¨è¯­å¥æœ«å°¾å§‹ç»ˆä½¿ç”¨åˆ†å·ã€‚
"semi": ["error", "never"] // è¦æ±‚åœ¨è¯­å¥æœ«å°¾ä¸ä½¿ç”¨åˆ†å·ã€‚
```

å½“ç„¶äº†ï¼Œä¹Ÿå¯ä»¥è¿™æ ·å†™æ¥æ‹¦æˆªç‰¹å®šçš„æ–‡ä»¶ï¼š

```js
overrides: [
  {
    files: ["*.ts", "*.tsx"],
    rules: {
      "no-undef": "off",
      "react/prop-types": "off",
      "semi": "off"
    },
  },
],
```
è¦æ³¨æ„è§„åˆ™é›†ä¹‹é—´çš„é¡ºåºé—®é¢˜ï¼Œåé¢çš„è§„åˆ™é›†ä¼šè¦†ç›–å‰é¢çš„è§„åˆ™é›†ã€‚å¦‚æœéœ€è¦ä¿ç•™å‰é¢çš„è§„åˆ™é›†ä¸­çš„è§„åˆ™ï¼š

```js
"rules": Object.assign({}, require("eslint-config-airbnb/rules"))
```


å¸¸è§çš„ruleæœ‰å¦‚ä¸‹è¿™äº›ï¼Œ

-   `no-var`: ç¦æ­¢ä½¿ç”¨ `var` å…³é”®å­—å£°æ˜å˜é‡ï¼Œä½¿ç”¨ `let` æˆ– `const` ä»£æ›¿ã€‚
-   `no-unused-vars`: ç¦æ­¢å£°æ˜å˜é‡ä½†æœªä½¿ç”¨ï¼Œå‡å°‘ä»£ç å†—ä½™ã€‚
-   `no-console`: ç¦æ­¢ä½¿ç”¨ `console` è¯­å¥ï¼Œé¿å…ä»£ç åœ¨ç”Ÿäº§ç¯å¢ƒä¸­æ³„æ¼æ•æ„Ÿä¿¡æ¯ã€‚
-   `semi`: è¦æ±‚åœ¨è¯­å¥æœ«å°¾ä½¿ç”¨åˆ†å·ï¼Œè§„èŒƒä»£ç é£æ ¼ã€‚
-   `indent`: è¦æ±‚ä½¿ç”¨æŒ‡å®šçš„ç¼©è¿›é£æ ¼ï¼Œæé«˜ä»£ç å¯è¯»æ€§ã€‚
-   `quotes`: è¦æ±‚åœ¨å­—ç¬¦ä¸²å‘¨å›´ä½¿ç”¨æŒ‡å®šçš„å¼•å·ç±»å‹ï¼Œè§„èŒƒä»£ç é£æ ¼ã€‚
-   `no-undef`: ç¦æ­¢ä½¿ç”¨æœªå£°æ˜çš„å˜é‡ï¼Œå‡å°‘é”™è¯¯å‡ºç°çš„æ¦‚ç‡ã€‚
-   `no-extra-parens`: ç¦æ­¢å‡ºç°ä¸å¿…è¦çš„æ‹¬å·ï¼Œæé«˜ä»£ç å¯è¯»æ€§ã€‚
-   `no-multiple-empty-lines`: ç¦æ­¢å‡ºç°å¤šè¡Œç©ºç™½è¡Œï¼Œæé«˜ä»£ç å¯è¯»æ€§ã€‚
-   `no-trailing-spaces`: ç¦æ­¢è¡Œæœ«å‡ºç°ç©ºæ ¼ï¼Œæé«˜ä»£ç å¯è¯»æ€§ã€‚
-   `no-unreachable`: ç¦æ­¢å‡ºç°æ— æ³•åˆ°è¾¾çš„ä»£ç ï¼Œå‡å°‘ä»£ç å†—ä½™ã€‚
-   `no-useless-return`: ç¦æ­¢å‡ºç°ä¸å¿…è¦çš„ `return` è¯­å¥ï¼Œå‡å°‘ä»£ç å†—ä½™ã€‚

React

-   `react/jsx-uses-react`: æ£€æµ‹æ˜¯å¦ä½¿ç”¨äº† React åº“ï¼Œå¦‚æœæ²¡æœ‰ä½¿ç”¨åˆ™æŠ¥é”™ã€‚
-   `react/jsx-uses-vars`: æ£€æµ‹æ˜¯å¦å£°æ˜äº† JSX å˜é‡ï¼Œå¦‚æœå£°æ˜äº†ä½†æœªä½¿ç”¨åˆ™æŠ¥é”™ã€‚
-   `react/jsx-no-undef`: æ£€æµ‹æ˜¯å¦ä½¿ç”¨äº†æœªå®šä¹‰çš„ JSX å˜é‡ï¼Œå¦‚æœä½¿ç”¨äº†åˆ™æŠ¥é”™ã€‚
-   `react/jsx-indent`: è¦æ±‚ JSX å…ƒç´ çš„ç¼©è¿›ä¸ºæŒ‡å®šæ•°é‡çš„ç©ºæ ¼ã€‚
-   `react/jsx-indent-props`: è¦æ±‚ JSX å±æ€§çš„ç¼©è¿›ä¸ºæŒ‡å®šæ•°é‡çš„ç©ºæ ¼ã€‚
-   `react/no-unescaped-entities`: ç¦æ­¢åœ¨ JSX ä¸­ä½¿ç”¨æœªè½¬ä¹‰çš„ HTML å®ä½“å­—ç¬¦ã€‚
-   `react/prop-types`: æ£€æµ‹æ˜¯å¦ä¸ºç»„ä»¶å£°æ˜äº† props ç±»å‹å®šä¹‰ï¼Œå¦‚æœæ²¡æœ‰åˆ™æŠ¥é”™ã€‚

Vue

-   `vue/html-indent`: è¦æ±‚æ¨¡æ¿ä¸­çš„ç¼©è¿›ä¸ºæŒ‡å®šæ•°é‡çš„ç©ºæ ¼ã€‚
-   `vue/no-unused-components`: æ£€æµ‹æ˜¯å¦æ³¨å†Œäº†ä½†æœªä½¿ç”¨çš„ç»„ä»¶ï¼Œå¦‚æœæœ‰åˆ™æŠ¥é”™ã€‚
-   `vue/no-unused-vars`: æ£€æµ‹æ˜¯å¦å£°æ˜äº†ä½†æœªä½¿ç”¨çš„å˜é‡ï¼Œå¦‚æœæœ‰åˆ™æŠ¥é”™ã€‚
-   `vue/require-prop-types`: è¦æ±‚ç»„ä»¶å£°æ˜ props ç±»å‹å®šä¹‰ã€‚
-   `vue/require-default-prop`: è¦æ±‚ç»„ä»¶å£°æ˜ props çš„é»˜è®¤å€¼ã€‚
-   `vue/require-v-for-key`: è¦æ±‚ä½¿ç”¨ v-for æŒ‡ä»¤æ—¶ä¸ºæ¯ä¸ªé¡¹æä¾›å”¯ä¸€çš„ key å±æ€§ã€‚

ç­‰ç­‰..

é™¤æ­¤ä¹‹å¤–ï¼Œä¸åŒçš„æ’ä»¶è¿˜æœ‰å¯¹åº”çš„ruleï¼Œå¯æŸ¥çœ‹å¯¹åº”æ–‡æ¡£æ¥é…ç½®ã€‚

### plugins

ç”¨æ¥æŒ‡å®šæ’ä»¶çš„ä¸€ä¸ªé€‰é¡¹ã€‚æ’ä»¶æ˜¯ä¸€ç§æ‰©å±• ESLint åŠŸèƒ½çš„æ–¹å¼ï¼Œå¯ä»¥ç”¨äºæ£€æŸ¥ç‰¹å®šç±»å‹çš„é—®é¢˜æˆ–è€…åº”ç”¨ç‰¹å®šçš„ç¼–ç è§„èŒƒã€‚ESLint æ’ä»¶é€šå¸¸æ˜¯ä¸€ä¸ª npm åŒ…ï¼ŒåŒ…å«ä¸€ç»„è§„åˆ™å’Œç›¸å…³çš„é…ç½®ï¼Œé€šè¿‡ `plugins` é€‰é¡¹å°†å…¶å¼•å…¥åˆ°é¡¹ç›®ä¸­ï¼Œå°±å¯ä»¥ä½¿ç”¨è¿™äº›è§„åˆ™æ¥æ£€æŸ¥ä»£ç äº†ã€‚

ESLint æ’ä»¶é€šå¸¸éœ€è¦é…åˆå¯¹åº”çš„è§„åˆ™è¿›è¡Œä½¿ç”¨ï¼Œå¯ä»¥é€šè¿‡ `extends` é€‰é¡¹æ¥ç»§æ‰¿æ’ä»¶çš„è§„åˆ™ã€‚å¸¸ç”¨çš„æ’ä»¶å¦‚ä¸‹ï¼š

1.  `eslint-plugin-import`ï¼šç”¨äºæ£€æŸ¥æ¨¡å—å¯¼å…¥çš„è§„èŒƒæ€§ï¼ŒåŒ…æ‹¬è·¯å¾„ã€æ–‡ä»¶ç±»å‹å’Œæ–‡ä»¶å†…å®¹ç­‰æ–¹é¢çš„æ£€æŸ¥ã€‚
2.  `eslint-plugin-react`ï¼šç”¨äºæ£€æŸ¥ React ä»£ç çš„è§„èŒƒæ€§ï¼ŒåŒ…æ‹¬ JSX è¯­æ³•ã€ç»„ä»¶ä½¿ç”¨å’Œç”Ÿå‘½å‘¨æœŸç­‰æ–¹é¢çš„æ£€æŸ¥ã€‚
3.  `eslint-plugin-vue`ï¼šç”¨äºæ£€æŸ¥ Vue.js ä»£ç çš„è§„èŒƒæ€§ï¼ŒåŒ…æ‹¬æ¨¡æ¿ã€ç»„ä»¶å’ŒæŒ‡ä»¤ç­‰æ–¹é¢çš„æ£€æŸ¥ã€‚
4.  `eslint-plugin-jest`ï¼šç”¨äºæ£€æŸ¥ Jest æµ‹è¯•ä»£ç çš„è§„èŒƒæ€§ï¼ŒåŒ…æ‹¬æµ‹è¯•åç§°ã€åŒ¹é…å™¨å’Œæ–­è¨€ç­‰æ–¹é¢çš„æ£€æŸ¥ã€‚
5.  `eslint-plugin-node`ï¼šç”¨äºæ£€æŸ¥ Node.js ä»£ç çš„è§„èŒƒæ€§ï¼ŒåŒ…æ‹¬ API ä½¿ç”¨ã€æ–‡ä»¶ç³»ç»Ÿå’Œå­è¿›ç¨‹ç­‰æ–¹é¢çš„æ£€æŸ¥ã€‚
6.  `eslint-plugin-prettier`ï¼šç”¨äºå°† Prettier ä»£ç æ ¼å¼åŒ–é›†æˆåˆ° ESLint ä¸­ï¼Œå¯ä»¥é€šè¿‡é…ç½®æ¥è‡ªåŠ¨ä¿®å¤ä»£ç æ ¼å¼é—®é¢˜ã€‚
7.  `eslint-plugin-security`ï¼šç”¨äºæ£€æŸ¥ä»£ç ä¸­çš„å®‰å…¨é—®é¢˜ï¼ŒåŒ…æ‹¬è·¨ç«™ç‚¹è„šæœ¬æ”»å‡»ã€å‘½ä»¤æ³¨å…¥å’Œ SQL æ³¨å…¥ç­‰æ–¹é¢çš„æ£€æŸ¥ã€‚

ç­‰ç­‰...

è¿™é‡Œä»¥ eslint-plugin-react ä¸ºä¾‹è®²è§£é…ç½®ï¼š

å®‰è£…ï¼š

```
npm install eslint-plugin-react --save-dev
```

ä½¿ç”¨ï¼š

```js
{
  "plugins": ["react"],
  "extends": ["eslint:recommended", "plugin:react/recommended"],
  "rules": {
    "react/jsx-props-no-spreading": "off",
    "react/jsx-props-no-spreading": [
      "error",
      {
        "exceptions": ["Component"],
        "html": "enforce",
        "custom": "ignore"
      }
    ]
  }
}
```

åœ¨ä¸Šé¢çš„é…ç½®ä¸­ï¼Œä½¿ç”¨äº† `eslint:recommended` å’Œ `plugin:react/recommended` æ‰©å±•ï¼Œåˆ†åˆ«è¡¨ç¤ºä½¿ç”¨äº† ESLint æ¨èçš„è§„åˆ™å’Œ `eslint-plugin-react` çš„æ¨èè§„åˆ™ã€‚è¿™äº›è§„åˆ™å¯ä»¥é€šè¿‡ `rules` é…ç½®é¡¹è¿›è¡Œä¿®æ”¹å’Œè¦†ç›–ã€‚

### extends

ç”¨æ¥ç»§æ‰¿å’Œæ‰©å±• ESLint è§„åˆ™é›†çš„é…ç½®é¡¹ã€‚é€šè¿‡ `extends`ï¼Œå¯ä»¥å°†ç°æœ‰çš„è§„åˆ™é›†åˆå¹¶åˆ°è‡ªå·±çš„è§„åˆ™é…ç½®ä¸­ï¼Œä¹Ÿå¯ä»¥åŸºäºç°æœ‰çš„è§„åˆ™é›†è¿›è¡Œæ‰©å±•å’Œå®šåˆ¶åŒ–ã€‚å…¶ä¸ pluginsçš„åŒºåˆ«æ˜¯ï¼Œå‰è€…é›†æˆäº†åè€…çš„åŠŸèƒ½ï¼Œè€Œä¸”è‡ªå¸¦äº†é…ç½®è§„åˆ™rulesã€‚

ESLint æä¾›äº†å¤šä¸ªå†…ç½®è§„åˆ™é›†ï¼ŒåŒ…æ‹¬ `eslint:recommended`ã€`plugin:@typescript-eslint/recommended`ã€`plugin:react/recommended`ã€`plugin:vue/recommended` ç­‰ã€‚é€šè¿‡åœ¨é…ç½®æ–‡ä»¶ä¸­è®¾ç½® `extends` ä¸ºå†…ç½®è§„åˆ™é›†çš„åç§°ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨å†…ç½®è§„åˆ™é›†ä¸­çš„è§„åˆ™ã€‚

é™¤äº†å†…ç½®è§„åˆ™é›†å¤–ï¼Œè¿˜æœ‰è®¸å¤šç¬¬ä¸‰æ–¹è§„åˆ™é›†å¯ä»¥ä½¿ç”¨ï¼Œæ¯”å¦‚ `airbnb`ã€`standard`ã€`prettier` ç­‰ã€‚

å¦‚æœéœ€è¦åŒæ—¶ä½¿ç”¨å¤šä¸ªè§„åˆ™é›†ï¼Œå¯ä»¥ä½¿ç”¨æ•°ç»„çš„æ–¹å¼å°†å¤šä¸ªè§„åˆ™é›†åˆå¹¶åˆ°ä¸€èµ·ï¼š

```js
{
  "extends": [
    "eslint:recommended",
    "plugin:@typescript-eslint/recommended",
    "plugin:react/recommended",
    "plugin:vue/recommended"
  ]
}
```

å¦‚æœéœ€è¦å®šä¹‰è‡ªå·±çš„è§„åˆ™é›†ï¼Œå¯ä»¥ä½¿ç”¨ç›¸å¯¹è·¯å¾„æˆ–ç»å¯¹è·¯å¾„æŒ‡å®šè§„åˆ™é›†çš„ä½ç½®:

```js
{
  "extends": "./path/to/my-rule-set"
}
```
extends çš„ä¼˜å…ˆçº§æ˜¯ä»ä½åˆ°é«˜çš„ï¼Œåé¢çš„è§„åˆ™ä¼šè¦†ç›–å‰é¢çš„è§„åˆ™ï¼Œæœ€ç»ˆä»¥æœ€åä¸€ä¸ªè§„åˆ™é›†ä¸ºå‡†ï¼›è€Œå½“ä¸€ä¸ªè§„åˆ™åœ¨å¤šä¸ªè§„åˆ™é›†ä¸­å®šä¹‰æ—¶ï¼Œåè¾¹çš„ä¼šè¦†ç›–å‰é¢çš„ã€‚ä¾‹å¦‚ï¼š

```js
// eslint-config-a.js
module.exports = {
  rules: {
    'no-console': 'off',
    'no-alert': 'error'
  }
};

// eslint-config-b.js
module.exports = {
  extends: ['eslint-config-a'],
  rules: {
    'no-console': 'error',
    'no-debugger': 'warn'
  }
};
```
eslint-config-b ä¸­ï¼Œno-consoleä½¿ç”¨errorï¼Œè€Œä¸æ˜¯offã€‚

### settings

ä¸€ä¸ªå¯é€‰çš„é¡¶å±‚å±æ€§ï¼Œå®ƒå¯ä»¥ç”¨æ¥é…ç½®ä¸€äº›é¢å¤–çš„ã€è‡ªå®šä¹‰çš„ä¿¡æ¯ï¼Œä¾›æ’ä»¶å’Œè§„åˆ™ä½¿ç”¨ã€‚å®ƒçš„å€¼æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œå¯ä»¥åŒ…å«å¤šä¸ªå±æ€§ã€‚ä¸‹é¢æ˜¯ä¸€äº›å¸¸ç”¨çš„ `settings` å±æ€§åŠå…¶ä½œç”¨ï¼š

-   `react`ï¼šè¯¥å±æ€§ç”¨äºé…ç½® React ç›¸å…³çš„ç¯å¢ƒå’Œé€‰é¡¹ã€‚å…·ä½“æ¥è¯´ï¼Œå®ƒå¯ä»¥åŒ…å«ä»¥ä¸‹å±æ€§ï¼š
    -   `version`ï¼šReact çš„ç‰ˆæœ¬å·ï¼Œå¦‚æœä¸è®¾ç½®è¯¥å±æ€§ï¼Œåˆ™æ’ä»¶ä¼šå°è¯•è‡ªåŠ¨æ£€æµ‹ React çš„ç‰ˆæœ¬ã€‚
    -   `pragma`ï¼šJSX çš„æ³¨é‡Šè¯­æ³•ï¼Œå¦‚æœä½ ä½¿ç”¨äº†ç±»ä¼¼äº `/** @jsx h */` çš„æ³¨é‡Šæ¥æŒ‡å®š JSX çš„è½¬æ¢å‡½æ•°ï¼Œåˆ™éœ€è¦è®¾ç½®è¯¥å±æ€§ã€‚
    -   `fragment`ï¼šä½¿ç”¨ Fragment ç»„ä»¶çš„åç§°ï¼Œå¦‚æœä½ ä½¿ç”¨äº† Fragment ç»„ä»¶ï¼Œåˆ™éœ€è¦è®¾ç½®è¯¥å±æ€§ã€‚
    -   `linkComponents`ï¼šé…ç½®è‡ªå®šä¹‰ç»„ä»¶é“¾æ¥çš„è§„åˆ™ï¼Œç”¨äºè§£å†³ç»„ä»¶åœ¨æŸäº›æƒ…å†µä¸‹æ— æ³•é“¾æ¥çš„é—®é¢˜ã€‚
-   `import/resolver`ï¼šè¯¥å±æ€§ç”¨äºé…ç½®å¯¼å…¥æ¨¡å—æ—¶çš„è§£æå™¨ï¼Œé€šå¸¸ç”¨äºè§£å†³è·¯å¾„é—®é¢˜ã€‚å…·ä½“æ¥è¯´ï¼Œå®ƒå¯ä»¥åŒ…å«ä»¥ä¸‹å±æ€§ï¼š
    -   `node`ï¼šè¯¥å±æ€§ç”¨äºè§£æ Node.js æ¨¡å—ã€‚
    -   `webpack`ï¼šè¯¥å±æ€§ç”¨äºè§£æ Webpack æ¨¡å—ã€‚
    -   `typescript`ï¼šè¯¥å±æ€§ç”¨äºè§£æ TypeScript æ¨¡å—ã€‚
    -   `alias`ï¼šé…ç½®æ¨¡å—è·¯å¾„çš„åˆ«åï¼Œç”¨äºè§£å†³è·¯å¾„é—®é¢˜ã€‚
    -   `extensions`ï¼šé…ç½®æ¨¡å—çš„æ‰©å±•åï¼Œç”¨äºè§£å†³æ¨¡å—æ–‡ä»¶ç±»å‹çš„é—®é¢˜ã€‚
-   `polyfills`ï¼šè¯¥å±æ€§ç”¨äºé…ç½®ä¸€äº›éœ€è¦åœ¨ä»£ç ä¸­æ‰‹åŠ¨å¼•å…¥çš„ Polyfillï¼Œé€šå¸¸ç”¨äºè§£å†³å…¼å®¹æ€§é—®é¢˜ã€‚
-   `react-native/style-sheet-object-names`ï¼šè¯¥å±æ€§ç”¨äºé…ç½® React Native ä¸­ä½¿ç”¨çš„ StyleSheet å¯¹è±¡åç§°ã€‚
-   `jest`ï¼šè¯¥å±æ€§ç”¨äºé…ç½® Jest æµ‹è¯•æ¡†æ¶ç›¸å…³çš„ä¿¡æ¯ã€‚
-   `svelte3`ï¼šè¯¥å±æ€§ç”¨äºé…ç½® Svelte 3 ç›¸å…³çš„ä¿¡æ¯ã€‚

ç­‰ç­‰...

## 3. æ–°é…ç½®æ–‡ä»¶

ESLintå°†åœ¨ 9.0ç‰ˆæœ¬å¯ç”¨æ–°çš„é…ç½®æ–‡ä»¶æ ¼å¼`eslint.config.js`ï¼Œå…¶æ¢äº†ä¸€ç§æ–°çš„é…ç½®æ–¹å¼ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š

```js
export default [
  {
    rules: {
      semi: "error",
      "prefer-const": "error"
    }
  },
  {
    files: ["src/**/*.js"],
    ignores: ["**/*.config.js"],
    rules: {
      semi: "off"
    }
  }
]
```

å…·ä½“æ–°çš„åŠ¨å‘ï¼Œå¯ä»¥å…³æ³¨[å®˜ç½‘](https://eslint.org/docs/latest/use/configure/configuration-files-new)çš„æ›´æ–°ã€‚


## 4. å‘å¸ƒnpm

å»ºç«‹ä¸€ä¸ªæ–‡ä»¶ä»“åº“ï¼š


![image.png](/img/posts/2023-4-21/2023-4-21-1.png)

index.jså†™å…¥é…ç½®ï¼š

![image.png](/img/posts/2023-4-21/2023-4-21-2.png)


package.jsonå†™å…¥ï¼š


![image.png](/img/posts/2023-4-21/2023-4-21-3.png)

ç™»å½•npmï¼š

```shell
npm login --registry=http://registry.npm.pre.xxx.com
```

æ‰§è¡Œå‘å¸ƒè„šæœ¬ï¼ˆpatchä¸ºä¾‹ï¼‰ï¼š

```shell
npm run publish:patch
```

åœ¨å‰ç«¯é¡¹ç›®ä¸­ä½¿ç”¨é…ç½®ï¼š


![image.png](/img/posts/2023-4-21/2023-4-21-4.png)

å½“ç„¶äº†ï¼Œä½¿ç”¨å‰è®°å¾— `yarn -D` ä¸€ä¸‹å•¦ã€‚

å‰©ä½™çš„é…ç½®huskyç­‰å·¥ä½œï¼Œå°±å¯ä»¥å‚è§æˆ‘ä¹‹å‰çš„æ–‡ç« ï¼š[å‰ç«¯é¡¹ç›®é…ç½® git hook + prettier + eslint](https://juejin.cn/post/7172430884673421342)

----

æ€»ç»“ï¼šeslinté…ç½®æ–‡ä»¶å•ç‹¬å°è£…åœ¨ä¸€ä¸ªç‹¬ç«‹åº“ä¸­ï¼Œä¾¿äºæ‰©å±•å’Œç»´æŠ¤å‡çº§ï¼Œçµæ´»æ€§æ›´å¼ºï¼Œé€‚åˆå‰ç«¯å¤šé¡µé¢åº”ç”¨æˆ–è€…å¾®æœåŠ¡åº”ç”¨çš„åœºæ™¯ã€‚

è‡³æ­¤ï¼Œå‰ç«¯æ ¡éªŒå·¥å…· eslintå°±é…ç½®å®Œæˆå•¦ï¼66:T29d8,## 1. å†™åœ¨å‰é¢çš„è¯

ç°åº¦è¿™ä¸ªæ¦‚å¿µï¼Œæ¥è‡ªæ•°å­—å›¾åƒé¢†åŸŸï¼Œæœ€åˆæ˜¯æè¿°é»‘ç™½æ•°å­—å›¾åƒçš„ç°åº¦å€¼ï¼ŒèŒƒå›´ä» `0` åˆ° `255`ï¼Œ`0` è¡¨ç¤ºé»‘è‰²ï¼Œ`255` è¡¨ç¤ºç™½è‰²ï¼Œä¸­é—´çš„æ•°å€¼è¡¨ç¤ºä¸åŒç¨‹åº¦çš„ç°è‰²ã€‚

ç°åº¦ç³»ç»Ÿçš„è¯ç”Ÿæºäºäº¤å‰å­¦ç§‘çš„å»ºè®¾ï¼Œåœ¨äº’è”ç½‘ä¸Šä¹Ÿä¸ä¾‹å¤–ã€‚å¯¹äºä¸€ä¸ªè½¯ä»¶äº§å“ï¼Œåœ¨å¼€å‘å’Œå‘å¸ƒçš„æ—¶å€™è‚¯å®šå¸Œæœ›ç”¨æˆ·èƒ½å¤Ÿé¡ºåˆ©çš„çœ‹åˆ°æƒ³è®©å…¶çœ‹åˆ°çš„å†…å®¹ã€‚ä½†æ˜¯ï¼Œå‘å¸ƒæ²¡æœ‰ä¸€å¸†é£é¡ºçš„ï¼Œå¦‚æœåœ¨å‘å¸ƒçš„æŸä¸ªç¯èŠ‚å‡ºäº†é—®é¢˜ï¼Œæ¯”å¦‚æ‰“é”™äº†é•œåƒæˆ–è€…ç”±äºéƒ¨ç½²ç¯å¢ƒä¸åŒè§¦å‘äº†éšè—çš„bugï¼Œå¯¼è‡´ç”¨æˆ·çœ‹åˆ°äº†é”™è¯¯çš„é¡µé¢æˆ–è€…æ—§çš„é¡µé¢ï¼Œè¿™å°±å‡ºç°äº†ç”Ÿäº§äº‹æ•…ã€‚ä¸ºäº†é¿å…è¿™ç§æƒ…å†µå‡ºç°ï¼Œå€Ÿé‰´æ•°å­—å›¾åƒå¤„ç†çš„ç†å¿µï¼Œè®¾è®¡å¸ˆä»¬è®¾è®¡å‡ºäº†ä¸€ç§ä»‹äº `0` å’Œ `1` ä¹‹é—´çš„`è¿‡æ¸¡ç³»ç»Ÿ`çš„æ¦‚å¿µï¼šè®©ç³»ç»Ÿå¯ä»¥é¢„å…ˆå‘å¸ƒï¼Œå¹¶è®¾ç½®å¯è§èŒƒå›´ï¼Œå°±åƒæœ‹å‹åœˆä¸€æ ·ï¼Œç­‰åˆ°é£é™©å¯æ§åï¼Œå†å¯¹å…¬ä¼—å¯è§ã€‚è¿™å°±æ˜¯ç°åº¦ç³»ç»Ÿã€‚

ç°åº¦ç³»ç»Ÿç‰ˆæœ¬çš„å‘å¸ƒåŠ¨ä½œç§°ä½œ `ç°åº¦å‘å¸ƒ`ï¼Œåˆåé‡‘ä¸é›€å‘å¸ƒï¼Œæˆ–è€…ç°åº¦æµ‹è¯•ï¼Œä»–æ˜¯æŒ‡åœ¨é»‘ä¸ç™½ä¹‹é—´èƒ½å¤Ÿå¹³æ»‘è¿‡æ¸¡çš„ä¸€ç§å‘å¸ƒæ–¹å¼ã€‚åœ¨å…¶ä¸Šå¯ä»¥è¿›è¡ŒA/B testingï¼Œå³è®©ä¸€éƒ¨åˆ†ç”¨æˆ·ç»§ç»­ç”¨äº§å“ç‰¹æ€§Aï¼Œä¸€éƒ¨åˆ†ç”¨æˆ·å¼€å§‹ç”¨äº§å“ç‰¹æ€§Bï¼Œå¦‚æœç”¨æˆ·å¯¹Bæ²¡æœ‰ä»€ä¹ˆåå¯¹æ„è§ï¼Œé‚£ä¹ˆé€æ­¥æ‰©å¤§èŒƒå›´ï¼ŒæŠŠæ‰€æœ‰ç”¨æˆ·éƒ½è¿ç§»åˆ°Bä¸Šé¢æ¥ã€‚(æ¦‚å¿µæ¥è‡ªçŸ¥ä¹)

å¯¹äºå‰ç«¯é¢†åŸŸï¼Œæ¼”è¿›åˆ°ç°åœ¨ï¼Œç°åº¦ç³»ç»Ÿä¸»è¦æœ‰å¦‚ä¸‹å‡ ç‚¹åŠŸèƒ½ï¼š

1. å¢é‡ç°åº¦ï¼šå°çš„patchå¯ä»¥å¢é‡çš„æ·»åŠ åœ¨å‘å¸ƒç‰ˆæœ¬ä¸Šï¼Œä¹Ÿå¯ä»¥é€šè¿‡å¼€å…³ä¸€é”®å…³é—­
2. ç”¨æˆ·ç°åº¦ï¼šå¢é‡å’Œå…¨é‡ç‰ˆæœ¬éƒ½å¯å¯¹ä¸åŒç¾¤ä½“æˆ–è€…æŸå‡ ä¸ªç‰¹å®šçš„ç”¨æˆ·è¿›è¡Œç°åº¦å¯è§
3. ç‰ˆæœ¬å›é€€ï¼šæ¯ä¸€ä¸ªç‰ˆæœ¬éƒ½åœ¨ç°åº¦ç³»ç»Ÿé‡Œå¯è§ï¼Œå¯ä»¥ä¸€é”®å›é€€

å‰ç«¯ç°åº¦ç³»ç»Ÿå·¥ä½œæµç¨‹å›¾å¦‚ä¸‹ï¼š


```mermaid
sequenceDiagram
å‰ç«¯é¡¹ç›®-->ç°åº¦ç³»ç»Ÿ: éƒ¨ç½²é˜¶æ®µ
å‰ç«¯é¡¹ç›®->>ç°åº¦ç³»ç»Ÿ: 1.CI æ‰“åŒ…åå†™å…¥æ‰“åŒ…èµ„æºï¼ŒçŠ¶æ€åˆå§‹åŒ–
å‰ç«¯é¡¹ç›®-->ç°åº¦ç³»ç»Ÿ: è®¿é—®é˜¶æ®µ
å‰ç«¯é¡¹ç›®->>ç°åº¦ç³»ç»Ÿ: 1.é¡µé¢è®¿é—®ï¼Œè¯·æ±‚å½“å‰ç™»å½•ç”¨æˆ·å¯¹åº”çš„èµ„æºç‰ˆæœ¬
ç°åº¦ç³»ç»Ÿ-->>å‰ç«¯é¡¹ç›®: 2.ä»å¯¹åº”ç‰ˆæœ¬çš„èµ„æºç›®å½•è¿”å›å‰ç«¯èµ„æº
```

![](/img/posts/2023-3-19/2023-3-19-1.png)
---

## 2. ç°åº¦è§„åˆ™

å…³äºç°åº¦èµ„æºä¼˜å…ˆçº§çš„è¯´æ˜å¦‚ä¸‹ï¼š

| ç°åº¦ç­–ç•¥ | ä¼˜å…ˆçº§ |
| --- | --- |
| æœªç”Ÿæ•ˆ | ä½ |
| ç”Ÿæ•ˆ | é«˜ |
| å…¨é‡ | ä¸€èˆ¬ |

å¦‚æ­¤å°±èµ·åˆ°äº†`ç°åº¦`çš„ä½œç”¨ï¼šå…¨é‡è¡¨ç¤ºæ‰€æœ‰äººéƒ½å¯ä»¥çœ‹ï¼›ç”Ÿæ•ˆè¡¨ç¤ºåªæœ‰åœ¨è§„åˆ™ä¸­çš„ç”¨æˆ·æ‰å¯ä»¥çœ‹åˆ°è¿™éƒ¨åˆ†å¢é‡æ›´æ–°ï¼Œä¼˜å…ˆçº§æœ€é«˜ï¼›æœªç”Ÿæ•ˆè¡¨ç¤ºä¸ç°åº¦ï¼Œä¼˜å…ˆçº§æœ€ä½ã€‚

## 3. ç°åº¦ç³»ç»Ÿæ•°æ®åº“è®¾è®¡

> `ä¸ºä»€ä¹ˆç°åº¦ç³»ç»Ÿæœ‰åç«¯`ï¼šå‰ç«¯é¡¹ç›® CI éƒ¨ç½²åï¼Œä¼šäº§ç”Ÿä¸€ä¸ª commit å·å’Œä¸€ä¸ªé•œåƒè®°å½•ï¼Œå¹¶ä¸”æ‰“åŒ…åçš„æ–‡ä»¶å­˜æ”¾åœ¨æœåŠ¡å™¨ä¸­æŸä¸€ä¸ªæ·±å±‚çš„æ–‡ä»¶å¤¹ç›®å½•ä¸­ï¼Œç°åº¦ç³»ç»Ÿéœ€è¦å­˜å…¥è¯¥éƒ¨ç½²çš„ç›®å½•åœ°å€ï¼Œä¾¿äºåœ¨åˆ‡æ¢ç°åº¦æ—¶æŸ¥æ‰¾ä¸åŒç‰ˆæœ¬çš„æ–‡ä»¶ã€‚


å…ˆä»‹ç»ä¸€ä¸ªè¦éƒ¨ç½²çš„å‰ç«¯é¡¹ç›®ï¼ˆä½ å¯ä»¥æ ¹æ®è‡ªå·±çš„å‰ç«¯é¡¹ç›®åŠ¨æ€è°ƒæ•´ï¼‰ã€‚

æœ¬é¡¹ç›®é’ˆå¯¹çš„å‰ç«¯é¡¹ç›®æ˜¯ä¸€ä¸ªåŸºäºå¾®æœåŠ¡æ¶æ„çš„é¡¹ç›®ï¼Œ

ä¸‹é¢æ˜¯è®¾è®¡ERå›¾ï¼š


![image.png](/img/posts/2023-3-19/2023-3-19-2.png)

æˆ‘ä»¬ä¾æ­¤æ¥åˆ†æï¼š

### å­é¡¹ç›®è¡¨

è¯¥è¡¨ç”¨äºå­˜æ”¾æ‰€æœ‰å­é¡¹ç›®çš„ä¿¡æ¯ï¼Œæ–°å»ºä¸€ä¸ªå¾®æœåŠ¡å­é¡¹ç›®æ—¶ï¼Œä¼šåœ¨è¿™ä¸ªè¡¨é‡Œæ–°å»ºä¸€ä¸ªæ¡ç›®ï¼Œæ•°æ®ç¤ºæ„å¦‚ä¸‹ï¼š


![image.png](/img/posts/2023-3-19/2023-3-19-3.png)

### ç°åº¦ç”¨æˆ·è¡¨

ç”¨äºç°åº¦ç³»ç»Ÿç™»å½•çš„ç”¨æˆ·ï¼Œæ‹¥æœ‰ç°åº¦æƒé™çš„äººæ‰å¯ä»¥åŠ å…¥ã€‚

### èµ„æºè¡¨

èµ„æºè¡¨å­˜æ”¾é¡¹ç›®åœ¨ CI ä¸­å†™å…¥çš„ commit ä¿¡æ¯å’Œ build å®Œä»¥ååœ¨æœåŠ¡å™¨çš„å­˜æ”¾ä½ç½®ï¼Œæ•°æ®ç¤ºæ„å¦‚ä¸‹ï¼š


![image.png](/img/posts/2023-3-19/2023-3-19-4.png)

å…¶ä¸­ `branch` æ˜¯è·‘CIçš„åˆ†æ”¯ï¼Œ`data` å­˜æ”¾æ‰“åŒ…èµ„æºç›®å½•ä¿¡æ¯ï¼Œä¸€èˆ¬ç»“æ„å¦‚ä¸‹ï¼š


![image.png](/img/posts/2023-3-19/2023-3-19-5.png)

`gitProjectId` å­˜æ”¾è¯¥äº§å“åœ¨ gitlab ä¸­çš„é¡¹ç›®å·ï¼Œ `status` è¡¨ç¤ºæ„å»ºçŠ¶æ€ï¼š0ï¼šæ„å»ºå®Œæˆ 1ï¼šéƒ¨ç½²å®Œæˆ 2ï¼šæ„å»ºå¤±è´¥ï¼Œ3ï¼šéƒ¨ç½²å¤±è´¥ã€‚

è¿™é‡Œç®€å•æä¸€ä¸‹ CI æ˜¯å¦‚ä½•å†™å…¥ç°åº¦ç³»ç»Ÿæ•°æ®åº“çš„ï¼Œè¿‡å¤šè¯¦æƒ…ä¸åšè§£é‡Šï¼Œå†™å…¥æ•°æ®åº“æ–¹å¼å¾ˆå¤šï¼Œè¿™åªæ˜¯å…¶ä¸­ä¸€ç§å®ç°æ–¹å¼ã€‚

1. é¦–å…ˆåœ¨ CI build ç¯èŠ‚å¾€æœåŠ¡å™¨å†™å…¥æ‰“åŒ…ä¿¡æ¯çš„ JSONï¼š

![image.png](/img/posts/2023-3-19/2023-3-19-6.png)

å…¶ä¸­ build.sh è´Ÿè´£æŠŠä¼ å…¥çš„å‚æ•°å†™åˆ°ä¸€ä¸ª json ä¸­ã€‚ä¸Šå›¾ä¸­æ˜¯å¾€æ ¹ç›®å½•copyï¼Œæ–¹ä¾¿ä¸‹ä¸€ä¸ª CI jobè¯»å–jsonæ–‡ä»¶çš„ç¤ºæ„å›¾ã€‚

2. åœ¨ CI éƒ¨ç½²ç¯èŠ‚ï¼Œé€šè¿‡è°ƒç”¨è„šæœ¬åˆ›å»ºèµ„æºï¼š


![image.png](/img/posts/2023-3-19/2023-3-19-7.png)

å…¶ä¸­ run_gray.js:

```js
const { ENV, file, branch, projectId, gitProjectId, user, commitMsg } = require('yargs').argv;

axios({
    url: URL,
    method: "POST",
    headers: {
        remoteUser: user
    },
    data: {
        Action: "CreateResource",
        projectId,
        branch,
        commitMsg,
        gitProjectId,
        channel: Channel,
        data: fs.readFileSync(file, 'utf8'),
        status: "0"
    }
}).then(...)
```
å…¶ä¸­ status çš„å˜åŒ–ï¼Œåœ¨ CI éƒ¨ç½²æœåŠ¡å™¨å®Œæˆåï¼Œè¿½åŠ ä¸€ä¸ª `UpdateResource` åŠ¨ä½œå³å¯ï¼š

```
if [[ $RetCode != 0 ]]; then curl "$STARK_URL" -X 'POST' -H 'remoteUser: '"$GITLAB_USER_NAME"'' -H 'Content-Type: application/json' -d '{"Action": "UpdateResource", "id": "'"$ResourceId"'", "status": "2"}' > test.log && echo `cat test.log`; fi
```

### ç°åº¦ç­–ç•¥è¡¨

ç°åº¦ç­–ç•¥æ˜¯å¯¹ç°åº¦èµ„æºçš„è°ƒåŠ¨é…ç½®ã€‚å…¶è®¾è®¡å¦‚ä¸‹ï¼š

![image.png](/img/posts/2023-3-19/2023-3-19-8.png)

å…¶ä¸­ï¼Œ`prijectId` è¡¨ç¤ºç°åº¦çš„é¡¹ç›®ï¼Œ`resourceId` è¡¨ç¤ºä½¿ç”¨çš„èµ„æºï¼Œ`rules` é…ç½®äº†å¯¹åº”çš„ç”¨æˆ·æˆ–ç”¨æˆ·ç»„ï¼ˆçœ‹ä½ æ€ä¹ˆé…ç½®äº†ï¼Œæˆ‘è¿™é‡Œåªé…ç½®äº†å•ç‹¬çš„ userIdï¼‰ï¼Œ`status` æ˜¯ç°åº¦çš„çŠ¶æ€ï¼Œæˆ‘è®¾ç½®äº†ä¸‰ç§ï¼š

- default: æœªç”Ÿæ•ˆ
- failure: ç”Ÿæ•ˆ
- success: å…¨é‡

çŠ¶æ€ç”Ÿæ•ˆè¡¨ç¤ºæ˜¯å¢é‡å‘å¸ƒçš„æ„æ€ã€‚

åˆ°è¿™é‡Œï¼Œæ•°æ®åº“è®¾è®¡å°±å®Œæ¯•äº†ã€‚

---

## 4. ç°åº¦ç³»ç»Ÿæ¥å£APIå¼€å‘

æœ‰äº†æ•°æ®åº“ï¼Œè¿˜éœ€è¦æä¾›èƒ½å¤Ÿæ“ä½œæ•°æ®åº“çš„æœåŠ¡ï¼Œä¸Šè¾¹åˆ›å»ºèµ„æºçš„æ¥å£å°±æ˜¯è°ƒç”¨çš„ç°åº¦è‡ªå·±çš„APIå®ç°çš„ã€‚ä¸»è¦çš„APIåˆ—è¡¨å¦‚ä¸‹ï¼š


| åç§° | æè¿° |
| --- | --- |
| getResourcesByProjectId | è·å–å•ä¸ªäº§å“ä¸‹æ‰€æœ‰èµ„æº |
| getResourcesById | é€šè¿‡ä¸»é”®è·å–èµ„æº |
| createResource | åˆ›å»ºä¸€ä¸ªèµ„æº |
| updateResource | æ›´æ–°ä¸€ä¸ªèµ„æº |
| getIngressesByProjectId | è·å–å•ä¸ªäº§å“ä¸‹ç°åº¦ç­–ç•¥ä»»åŠ¡åˆ—è¡¨ |
| getIngressById | é€šè¿‡ä¸»é”®è·å–å•ä¸ªç°åº¦ç­–ç•¥ä»»åŠ¡è¯¦æƒ… |
| createIngress | åˆ›å»ºä¸€ä¸ªç­–ç•¥ |
| updateIngress | æ›´æ–°ä¸€ä¸ªç­–ç•¥ |

å‰©ä½™çš„æ¥å£æœ‰ç”¨æˆ·å¤„ç†çš„ï¼Œæœ‰å­é¡¹ç›®ç®¡ç†çš„ï¼Œè¿™é‡Œä¸åšè¯¦è¿°ã€‚é™¤äº†ä¸Šè¾¹çš„å¿…é¡»çš„æ¥å£å¤–ï¼Œè¿˜æœ‰ä¸€ä¸ªæœ€é‡è¦çš„æ¥å£ï¼Œé‚£å°±æ˜¯è·å–å½“å‰ç™»å½•ç”¨æˆ·éœ€è¦çš„èµ„æºç‰ˆæœ¬çš„æ¥å£ã€‚åœ¨ç”¨æˆ·è®¿é—®æ—¶ï¼Œéœ€è¦é¦–å…ˆè°ƒç”¨ç°åº¦ç³»ç»Ÿçš„è¿™ä¸ªæ¥å£æ¥è·å–èµ„æºåœ°å€ï¼Œç„¶åæ‰èƒ½é‡å®šå‘åˆ°ç»™è¯¥ç”¨æˆ·çœ‹çš„é¡µé¢ä¸­å»ï¼š

| åç§° | æè¿° | æ¥æ”¶å‚æ•° | è¾“å‡º |
| --- | --- | --- | --- |
| getConsoleVersion | è·å–å½“å‰ç”¨çš„äº§å“ç‰ˆæœ¬ | userIdï¼Œproducts | resourceé”®å€¼å¯¹åˆ—è¡¨ |

`getConsoleVersion` æ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯å½“å‰ç™»å½•çš„ç”¨æˆ· IDï¼Œ ä¸€ä¸ªæ˜¯å½“å‰ç”¨æˆ·è®¿é—®çš„å¾®æœåŠ¡ç³»ç»Ÿä¸­æ‰€åŒ…å«çš„äº§å“åˆ—è¡¨ã€‚è¯¥æ¥å£åšäº†å¦‚ä¸‹å‡ æ­¥æ“ä½œï¼š

1. éå† productsï¼Œè·å–æ¯ä¸€ä¸ªäº§å“çš„ projectId
2. å¯¹äºæ¯ä¸€ä¸ª projectIdï¼Œè”æŸ¥èµ„æºè¡¨ï¼Œåˆ†åˆ«è·å–å¯¹åº”çš„ resourceId
3. å¯¹äºæ¯ä¸€ä¸ªresourceIdï¼Œç»“åˆ userIdï¼Œå¹¶è”æŸ¥ç°åº¦ç­–ç•¥è¡¨ï¼Œç­›é€‰å‡ºèµ·ä½œç”¨çš„ç°åº¦ç­–ç•¥ä¸­å¯ç”¨çš„èµ„æº
4. è¿”å›æ¯ä¸€ä¸ªèµ„æºçš„ data ä¿¡æ¯ã€‚

å…¶ä¸­ç¬¬ä¸‰æ­¥å¤„ç†ç›¸å¯¹ç¹çä¸€äº›ï¼Œæ¯”å¦‚è¯´ï¼Œä¸€ä¸ªèµ„æºæœ‰ä¸¤ä¸ªèµ·ä½œç”¨çš„ç°åº¦èµ„æºï¼Œä¸€ä¸ªæ˜¯å¢é‡çš„ï¼Œä¸€ä¸ªæ˜¯å…¨é‡çš„ï¼Œè¿™é‡Œåº”è¯¥æ‹¿å¢é‡çš„ç‰ˆæœ¬ï¼Œå› ä¸ºä»–ä¼˜å…ˆçº§æ›´é«˜ã€‚


è·å–ç”¨æˆ·ç‰ˆæœ¬çš„æµç¨‹å›¾å¦‚ä¸‹ï¼š


```mermaid
graph TD
ç”¨æˆ·ç™»å½•é¡µé¢ --> è·å–æ‰€æœ‰äº§å“ä¸‹çš„èµ„æºåˆ—è¡¨
è·å–æ‰€æœ‰äº§å“ä¸‹çš„èµ„æºåˆ—è¡¨ --> æ ¹æ®ç°åº¦ç­–ç•¥ç­›é€‰èµ„æºä¸­è¯¥ç”¨æˆ·å¯ç”¨çš„éƒ¨åˆ† --> è¿”å›äº§å“ç»´åº¦çš„èµ„æºå¯¹è±¡
```

![](/img/posts/2023-3-19/2023-3-19-9.png)

æœ€åè¿”å›çš„èµ„æºå¤§æ¦‚é•¿è¿™ä¸ªæ ·å­ï¼š

```js
interface VersionResponse {
    [productId: number]: ResourceVersion;
}

interface ResourceVersion {
    files: string[];
    config: ResourceConfig;
    dependencies: string[];
}
```

å…¶ä¸­ files å°±æ˜¯ JSON è§£æåçš„ä¸Šè¿° data ä¿¡æ¯çš„æ–‡ä»¶åˆ—è¡¨ï¼Œå› ä¸ºæ‰“åŒ…åçš„æ–‡ä»¶å¾€å¾€æœ‰ csså’Œå¤šä¸ªjsã€‚

è‡³äºè¿™ä¸ªåç«¯ä½¿ç”¨ä»€ä¹ˆè¯­è¨€ï¼Œä»€ä¹ˆæ¡†æ¶æ¥å†™ï¼Œå¹¶ä¸é‡è¦ï¼Œé‡è¦çš„æ˜¯ä¸€å®šè¦ç¨³å®šï¼Œä»–è¦æŒ‚æ‰äº†ï¼Œç”¨æˆ·å°±è¿›ä¸å»ç³»ç»Ÿäº†ï¼Œå®¹ç¾å’Œå®¹é”™è¦åšå¥½ï¼›å¦‚æœæ˜¯ä¸ªå®¢æˆ·æ¯”è¾ƒå¤šçš„ç½‘ç«™ï¼Œå¹¶å‘åˆ†æµä¹Ÿè¦è€ƒè™‘è¿›å»ã€‚

## 5. å‰ç«¯é¡µé¢å±•ç¤º

å‰ç«¯é¡µé¢å°±éšä¾¿ä½¿ç”¨äº†ä¸€ä¸ªå‰ç«¯æ¡†æ¶æ­äº†ä¸€ä¸‹ï¼Œé€‰å‹ä¸æ˜¯é‡ç‚¹ï¼Œç»„ä»¶åº“èƒ½å¤Ÿæ»¡è¶³è¦æ±‚å°±è¡Œï¼š

- ç™»å½•

![image.png](/img/posts/2023-3-19/2023-3-19-10.png)

- æŸ¥çœ‹èµ„æº


![image.png](/img/posts/2023-3-19/2023-3-19-11.png)

- é…ç½®ç­–ç•¥


![image.png](/img/posts/2023-3-19/2023-3-19-12.png)


![image.png](/img/posts/2023-3-19/2023-3-19-13.png)

---

éƒ¨ç½²ä»¥åï¼Œå®é™…è¿è¡Œé¡¹ç›®çœ‹çœ‹æ•ˆæœï¼š


![image.png](/img/posts/2023-3-19/2023-3-19-14.png)

å¯ä»¥çœ‹åˆ°ï¼Œåœ¨è°ƒç”¨ä¸šåŠ¡æ¥å£ä¹‹å‰ï¼Œä¼˜å…ˆè°ƒç”¨äº† getConsoleVersionæ¥è·å–ç‰ˆæœ¬ï¼Œå…¶è¿”å›å€¼æ˜¯ä»¥äº§å“ä¸º key çš„é”®å€¼å¯¹ï¼š


![image.png](/img/posts/2023-3-19/2023-3-19-15.png)

## 6. è®¿é—®è½¬å‘

è¿™é‡Œæ‹¿åˆ°éƒ¨ç½²ä¿¡æ¯åï¼ŒæœåŠ¡å™¨è¦è¿›è¡Œä¸‹ä¸€æ­¥å¤„ç†çš„ã€‚æˆ‘è¿™é‡Œæ˜¯æŠŠå®ƒå°è£…åˆ°ä¸€ä¸ªå¯¹è±¡ä¸­ï¼Œå¸¦ç€å‚æ•°ä¼ ç»™äº†å¾®æœåŠ¡çš„ hook å»äº†ï¼ˆå¾®æœåŠ¡ç³»ç»Ÿéœ€è¦ï¼‰ï¼›**å¦‚æœä½ æ˜¯å•é¡µåº”ç”¨ï¼Œå¯èƒ½éœ€è¦æŠŠå·¥ä½œé‡å¿ƒæ”¾åœ¨ Nginx çš„è½¬å‘ä¸Šï¼ŒNginxå†…éƒ¨æœåŠ¡è¯»å–ç°åº¦ç³»ç»Ÿæ•°æ®åº“æ¥æ‹¿åˆ°ç‰ˆæœ¬ç›®å½•ï¼Œç„¶ååˆ‡æ¢è·¯ç”±è½¬å‘ï¼ˆå¯èƒ½åªæ˜¯æ”¹å˜ä¸€ä¸ªè·¯ç”±å˜é‡ï¼‰ã€‚** ï¼ˆä½ ä¹Ÿå¯ä»¥å‚ç…§æˆ‘ [nginx ç›¸å…³æ–‡ç« ](https://juejin.cn/post/7211702508371656759)ï¼‰ï¼Œä¸‹é¢æˆ‘ç®€å•çš„ç»™ä¸ªç¤ºæ„å›¾ï¼š


```mermaid
graph TD
ç°åº¦ç³»ç»Ÿé…ç½®ç°åº¦ç­–ç•¥ --> Nginx+Lua+Mysqlè·å–ç°åº¦ç­–ç•¥å¹¶å†™å…¥Nginxå˜é‡
Nginx+Lua+Mysqlè·å–ç°åº¦ç­–ç•¥å¹¶å†™å…¥Nginxå˜é‡ --> NginxæœåŠ¡å™¨é…ç½®èµ„æºè½¬å‘
```

![](/img/posts/2023-3-19/2023-3-19-16.png)

## 7. æ€»ç»“

å‰ç«¯ç°åº¦ç³»ç»Ÿï¼Œå…¶å®å°±æ˜¯ä¸€ä¸ªåå°ç®¡ç†ç³»ç»Ÿã€‚ä»–é…ç½®å’Œç®¡ç†äº†ä¸åŒç‰ˆæœ¬çš„å‰ç«¯éƒ¨ç½²èµ„æºå’Œå¯¹åº”çš„ç”¨æˆ·ç­–ç•¥ï¼Œåœ¨éœ€è¦çš„æ—¶å€™è¿›è¡Œé…ç½®ã€‚

æ¥ä¸‹æ¥çš„æ–‡ç« æˆ‘ä¼šé…å¥—æ€§çš„è®²ä¸€ä¸‹ `Nginx` å’Œ `Docker` çš„å‰ç«¯å…¥é—¨ä½¿ç”¨ï¼Œæ•¬è¯·æœŸå¾…ï¼

å®Œï¼å¤§å®¶å¯¹ç°åº¦ç³»ç»Ÿæœ‰ä»€ä¹ˆå¥½çš„å»ºè®®ï¼Œå¯ä»¥åœ¨è¯„è®ºåŒºè®¨è®ºå“¦ï¼

---67:T4612,å¯¹äºä¸€ä¸ªå‰ç«¯å¼€å‘ï¼Œè™½ç„¶æœåŠ¡å™¨å¼€å‘éƒ¨ç½²ä¸æ˜¯ä¸»è¦ä¸šåŠ¡ï¼Œä½†æ˜¯ï¼Œç‹¬ç«‹å¼€å‘å‰ç«¯é¡¹ç›®æ€»å½’æ˜¯æŒ‚è½½åœ¨æœåŠ¡å™¨ä¸Šæ‰èƒ½è·‘èµ·æ¥çš„ï¼Œä¸èƒ½æ€»æŒ‡æœ›è¿ç»´æ¥åšè¿™ä¸ªå·¥ä½œã€‚è€Œä¸”ï¼Œä½œä¸ºä¸€ä¸ªç¨‹åºå‘˜ï¼Œä¸å¯èƒ½å¯¹é¡¹ç›®éƒ¨ç½²ä¸€ç‚¹éƒ½ä¸äº†è§£ã€‚

æœ¬æ–‡å°±è®²ä¸€ä¸‹ä½œä¸ºä¸€ä¸ªå‰ç«¯å¼€å‘åº”è¯¥è¦æŒæ¡çš„åŸºæœ¬çš„ nginx æœåŠ¡.

> å…³äº nginx ä¸ CI é…åˆçš„ä½¿ç”¨ï¼Œè§æˆ‘çš„æ–‡ç« ï¼šhttps://juejin.cn/post/7183517146729693221

## 1. æ¦‚å¿µ

- æ­£å‘ä»£ç†

ç‰¹ç‚¹ï¼šç”¨æˆ·ä¸»åŠ¨å»è”ç³»åˆ†å‘è®¾å¤‡ï¼Œåˆ†å‘è®¾å¤‡æ¥åˆ¤æ–­åˆ†å‘çš„ç›®æ ‡æœåŠ¡å™¨ã€‚æ­¤æ—¶ï¼Œ**ç”¨æˆ·å¯¹äºæœåŠ¡å™¨æœªçŸ¥**ã€‚

è·¯ç”±å™¨æ˜¯æ­£å‘ä»£ç†çš„ä¸€ä¸ªä¾‹å­ï¼Œä¸ç”¨æˆ·åœ¨ä¸€ä¾§ï¼Œæœ‰æœ€å¤§å¸¦å®½é™åˆ¶ã€‚

![image.png](/img/posts/2023-3-18/2023-3-18-1.png)

- åå‘ä»£ç†

åå‘ä»£ç†ä¸€èˆ¬æ˜¯éƒ¨ç½²åœ¨æœåŠ¡ä¾§çš„ï¼Œçµæ´»å¾ˆå¤šï¼Œå¯ä»¥åšè´Ÿè½½åˆ†æµå’Œæ‰©å±•åŠŸèƒ½ç­‰ã€‚ä½†æ˜¯å¯¹äºç”¨æˆ·è€Œè¨€ï¼Œåå‘ä»£ç†æœåŠ¡å™¨å°±ç›¸å½“äºç›®æ ‡æœåŠ¡å™¨ï¼Œå³ç”¨æˆ·ç›´æ¥è®¿é—®åå‘ä»£ç†æœåŠ¡å™¨å°±å¯ä»¥è·å¾—ç›®æ ‡æœåŠ¡å™¨çš„èµ„æºã€‚æ­¤æ—¶ï¼Œ**æœåŠ¡å™¨å¯¹äºç”¨æˆ·æœªçŸ¥**ï¼Œæé«˜äº†å®‰å…¨æ€§ã€‚

![image.png](/img/posts/2023-3-18/2023-3-18-2.png)

nginx ä¾¿æ˜¯é«˜æ€§èƒ½çš„ HTTP å’Œåå‘ä»£ç† web æœåŠ¡å™¨

ä¸€ä¸ªnginxçš„ä½¿ç”¨ä¾‹å­å°±æ˜¯è™šæ‹Ÿä¸»æœºï¼šå¤šä¸ªåŸŸåç»‘å®šä¸€ä¸ªä¸»æœºï¼Œç”± nginx è½¬å‘ä¸åŒçš„èµ„æºã€‚

## 2. å®‰è£…ä¸éƒ¨ç½²å‰ç«¯åº”ç”¨

- å¹³å°ï¼šCentOS7 è™šæ‹Ÿæœº
- å®‰è£…ç‰ˆæœ¬ï¼šç›®å‰æœ€æ–° 1.21.6
- ä¸‹è½½åœ°å€ï¼š[nginx å®˜ç½‘](https://nginx.p2hp.com/en/download.html)


å®‰è£…åŒ…è§£å‹åè¿›å…¥ç›®å½•

![image.png](/img/posts/2023-3-18/2023-3-18-3.png)

å®‰è£…ä¾èµ–

```
yum install -y gcc
yum install -y pcre-devel
yum install -y zlib zlib-devel
```

å¼€å§‹å®‰è£… (å®‰è£…ç›®å½•/usr/local/nginx)

```sh
./configure --prefix=/usr/local/nginx

make

make install
```

å®‰è£…æˆåŠŸï¼ŒæŸ¥çœ‹å®‰è£…ç›®å½•


![image.png](/img/posts/2023-3-18/2023-3-18-4.png)

æµ‹è¯•è¿è¡Œ

æ‰§è¡Œ `./sbin/nginx` (ä¹Ÿå¯ä»¥ä½¿ç”¨å…¨å±€ nginx å‘½ä»¤)

![image.png](/img/posts/2023-3-18/2023-3-18-5.png)

å¯ä»¥çœ‹åˆ°è¿›ç¨‹å·²ç»å¯åŠ¨

```
ps -ef | grep nginx
```

![image.png](/img/posts/2023-3-18/2023-3-18-6.png)

ä¸ºäº†æµ‹è¯•ï¼Œå…ˆå…³é—­é˜²ç«å¢™ï¼š

```
systemctl stop firewalld.service
```

æ­£å¼çº¿ä¸Šä½¿ç”¨çš„ï¼Œå¯ä»¥é…ç½®é˜²ç«å¢™æ”¾è¡Œç«¯å£ã€‚

é…ç½® nginx é…ç½®æ–‡ä»¶ï¼š

```
vim ./conf/nginx.conf
```

![image.png](/img/posts/2023-3-18/2023-3-18-7.png)

å…¶ä¸­ location æ ¹ç›®å½•ä½ç½®æ˜¯å·²ç» build å¥½çš„ä¸€ä¸ª vue åº”ç”¨ï¼š

![image.png](/img/posts/2023-3-18/2023-3-18-8.png)

é‡å¯

```
nginx -s reload
```

æµè§ˆå™¨æŸ¥çœ‹ ï¼ˆä½¿ç”¨ ip addr æŒ‡ä»¤å¯ä»¥æŸ¥çœ‹ipï¼‰

![image.png](/img/posts/2023-3-18/2023-3-18-9.png)

---
> ä¸Šè¿°åœ¨ä¹‹å‰çš„æ–‡ç« ä¸­ä¹Ÿæœ‰æ‰€æåŠï¼Œç›¸é¢æ›´æ·±å…¥çš„è®²ä¸€ä¸‹é…ç½®æ–‡ä»¶çš„ä½¿ç”¨
---

## 3. é…ç½®æ–‡ä»¶æœ€å°é›†

é…ç½®æ–‡ä»¶æœ€å°é›†æ˜¯ä¸€ä¸ªèƒ½å¤Ÿæ”¯æ’‘ nginx æ­£å¸¸è·‘èµ·æ¥çš„æœ€å°çš„é…ç½®é¡¹é›†åˆï¼Œè¿æ³¨é‡Šä¸€å¹¶å†™åœ¨ä¸‹é¢ï¼Œä¾›å¤§å®¶å‚è€ƒï¼š

```json
// ./conf/nginx.conf
worker_process 1; // å¹¶è¡Œæ‰§è¡Œçš„ä»»åŠ¡æ•°ï¼Œä¸€èˆ¬æŒ‰ç…§CPUå†…æ ¸é…ç½®
events: {
    worker_connections 1024; // é…ç½®å•ä¸ªworkerè¿›ç¨‹æœ€å¤§çš„è¿æ¥æ•°ï¼Œnginx é»˜è®¤è¿æ¥æ•°æ˜¯1024
}

http { // æ”¯æŒ http åè®®è®¿é—®çš„æœåŠ¡
    include      mime.types; // å½“å‰ç›®å½•ä¸‹çš„é…ç½®çš„æ–‡ä»¶ç±»å‹æ–‡ä»¶ï¼Œä½¿ç”¨é»˜è®¤å³å¯ã€‚å›¾ç‰‡éŸ³é¢‘ä¼šè‡ªåŠ¨è§£æç»™æµè§ˆå™¨ï¼Œä¸èƒ½è§£æçš„ä¸€å¾‹æŒ‰ç…§äºŒè¿›åˆ¶æµä¸‹è½½
    default_type  application/octet-stream; // é»˜è®¤æ–‡ä»¶ç±»å‹ äºŒè¿›åˆ¶æµä¸‹è½½
    sendfile        on;  // æ˜¯å¦å…è®¸ç›®æ ‡æœåŠ¡å™¨ç»•è¿‡ nginx æœåŠ¡å™¨ç›´æ¥è¿”å›ç»“æœç»™ç”¨æˆ·
    keepalive_timeout  65;  // è¶…æ—¶æ—¶é—´
    
    server { // éš¶å±äº http çš„ä¸€ä¸ª æœåŠ¡å™¨
        listen       10087;  // ç«¯å£
        server_name  localhost;  // æœåŠ¡éƒ¨ç½²çš„ipåœ°å€ï¼Œå¯ä»¥æ˜¯åŸŸå
        charset utf-8;
        location / {  // é…ç½® uri
	    root   /root/web/dist;  // è‡ªå®šä¹‰çš„èµ„æºç›®å½•ï¼Œå¯ä»¥æ˜¯ç»å¯¹ç›®å½•ï¼›è‹¥å‰è¾¹ä¸åŠ  /, åˆ™è¡¨ç¤ºç›¸å¯¹ç›®å½•ï¼Œç›¸å¯¹çš„æ˜¯ nginx ä¸»ç›®å½•
            index  index.html index.htm;
        }

        error_page  404             404.html;  // 404é¡µé¢é…ç½®ï¼Œç›¸å¯¹è·¯ç”±
        error_page   500 502 503 504   50x.html; // åŒä¸Š
        location = /50x.html {
            root   html;  // 50x æ—¶ï¼Œèµ„æºæŒ‡å‘ htmlç›®å½•ä¸‹å¯»æ‰¾
        }
        location = /404.html {
            root   html;  // åŒä¸Š
        }
    } // end server
} // end http
```

## 4. å¤šç«™ç‚¹é…ç½®

å‡è®¾æˆ‘ä»¬æœ‰ä¸¤ä¸ªèµ„æºç›®å½•ï¼Œä½ å¯ä»¥ç†è§£ä¸ºä¸¤ä¸ªé¡¹ç›®çš„ build ç›®å½•ï¼š

```
/root/web/vue/dist
/root/web/react/dist
```

æˆ‘ä»¬é€šè¿‡é…ç½®æ–‡ä»¶æ¥æ§åˆ¶ä¸åŒçš„è®¿é—® url åˆ†åˆ«åˆ†å‘ç»™è¿™ä¸¤ä¸ªèµ„æºã€‚

```json
server {
    listen       80;  
    server_name  www.vue.com;  
    location / {  
        root   /root/web/vue/dist; 
        index  index.html index.htm;
    }
}

server {
    listen       8080;  
    server_name  www.react.com;  
    location / {  
        root   /root/web/react/dist; 
        index  index.html index.htm;
    }
}
```

è¿™æ ·ï¼Œè®¿é—® www.vue.com å°±ä¼šè¿›å…¥ vue çš„é¡¹ç›®ï¼Œè®¿é—® www.react.com:8080 ä¼šè¿›å…¥ react çš„é¡¹ç›®ã€‚

æ³¨æ„ï¼šhttps çš„åŸŸåéœ€è¦åœ¨äº‘ç«¯é…ç½® ip ç»‘å®šä¸º nginx çš„æœåŠ¡å™¨ã€‚

## 5. server_name åŒ¹é…

server_name æ”¯æŒæ¨¡ç³ŠåŒ¹é…å’Œé€šé…ç¬¦åŒ¹é…ã€‚

- é€šé…ç¬¦ï¼š *.xxx.com ã€www.baidu.*

æ‰€æœ‰ .xxx.com ç»“å°¾çš„éƒ½å¯ä»¥åŒ¹é…åˆ°

- å®Œå…¨åŒ¹é…ï¼šwww.react.com
- æ­£åˆ™åŒ¹é…ï¼š~^[0-9]+\.xxx\.com$ (è§„åˆ™ï¼š~å¼€å¤´)


åŒ¹é…ä¼˜å…ˆçº§ï¼š

1. å®Œå…¨åŒ¹é…
2. é€šé…ç¬¦åœ¨å‰çš„
3. é€šé…ç¬¦åœ¨åçš„
4. æ­£åˆ™åŒ¹é…

å¦‚æœéƒ½ä¸åŒ¹é…

1. ä¼˜å…ˆé€‰æ‹©listené…ç½®é¡¹åæœ‰ default æˆ– default_server çš„
2. ä¸Šè¿°éƒ½ä¸æ»¡è¶³ï¼Œåˆ™å»æ‰¾ç«¯å£é…ç½®çš„ä½ç½®æœ€é å‰çš„server

## 6. è´Ÿè½½å‡è¡¡é…ç½®

ä½¿ç”¨åœºæ™¯ï¼šè®¿é—®åŒä¸€ä¸ªåŸŸåï¼Œä½†æ˜¯ç›®æ ‡åœ°å€å¯ä»¥æ˜¯å¤šä¸ªï¼Œæ ¹æ®ä½¿ç”¨æƒ…å†µå’Œç©ºé—²ç¨‹åº¦è‡ªåŠ¨åˆ†é…ä¸€ä¸ªä½¿ç”¨ã€‚upstream ç”¨äºè®¾ç½®å¤šå°åˆ†å‘ä¸»æœºçš„é›†åˆã€‚

```json
http {
    ...
    upstream my_server {
        server 10.123.345.456:8000;
        server 10.123.345.457:8000;
    }

    server {
        location / {
            proxy_pass http://my_server;
        }
    }
}

```

è¿™æ ·é…ç½®åï¼Œå®é™…è®¿é—® http://192.168.122.1 è®¿é—®æ—¶ï¼Œç³»ç»Ÿä¼šåœ¨ 456 å’Œ 457 ä¸¤ä¸ª ipæœåŠ¡é€‰æ‹©ä¸€ä¸ªåˆ†å‘ï¼Œé›¨éœ²å‡æ²¾ã€‚

å½“ç„¶ä½ ä¹Ÿå¯ä»¥é…ç½®ä¸¤ä¸ªæœåŠ¡å™¨çš„è½®è¯¢æƒé‡(è®¿é—®æ¦‚ç‡)ã€‚

```json
server 10.123.345.456:8000 weight=8;
server 10.123.345.457:8000 weight=1;
server 10.123.345.457:8000 backup;  // æ ‡è¯†å¤‡ç”¨æœºï¼Œå®åœ¨æ˜¯æ²¡æœ‰å¯ç”¨çš„æœºå™¨æ—¶å¯ç”¨
```

å¦‚æœæƒ³è¦æŸä¸€ä¸ªæœåŠ¡å™¨ä¸å‚ä¸è´Ÿè½½å‡è¡¡ï¼Œå¯ä»¥å¦‚ä¸‹é…ç½®ï¼š

```json
server 10.123.345.456:8000 down;
```

## 7. é…ç½®åŠ¨é™åˆ†ç¦»

é€‚åˆå°ä¸­å‹ç½‘ç«™ï¼Œé™æ€èµ„æºä¸å¤ªå¤šçš„åœºæ™¯ã€‚åŸç†æ˜¯ç”¨æˆ·è¯·æ±‚é¡µé¢æ—¶ï¼Œæå–å‡ºé™æ€èµ„æºï¼Œç­‰ä¸‹æ¬¡ç”¨æˆ·è®¿é—®ç›¸åŒé¡µé¢æ—¶ï¼Œé™æ€èµ„æºå¯ä»¥ä¸ç”¨å†æ¬¡æ‰¾æœåŠ¡å™¨è·å–ï¼Œè€Œæ˜¯å–ç¼“å­˜çš„å†…å®¹ã€‚

é…ç½®å¦‚ä¸‹ï¼š


```json
http {
    ...
    upstream my_server {
        server 10.123.345.456:8000;
        server 10.123.345.457:8000;
    }

    server {
        location / {
            proxy_pass http://my_server;
        }
        
        location ~.*\.(js|png|jpg|svg|css)$ {  // é™æ€èµ„æº
            root   html;
            index  index.html index.htm;
        }
    }
}
```

## 8. é…ç½® URLRewrite

ç”¨äºéšè—æœåŠ¡å™¨çœŸå®urlè·¯å¾„ã€‚

```js
http {
    ...
    upstream my_server {
        server 10.123.345.456:8000;
        server 10.123.345.457:8000;
    }

    server {
        location / {
            rewrite ^/([0-9]+).html$ /index/pageNum=$1 break;
            proxy_pass http://my_server;
        }
        
    }
}
```

ä¸Šè¾¹å°±ä½¿ç”¨äº†ä¸€ä¸ª rewrite æ¥é…ç½®äº†è½¬å‘ã€‚

è¿™ä¸ªä¾‹å­éšè—äº†é¡µé¢çš„åˆ†é¡µä¿¡æ¯ï¼šè®¿é—® /2.html å°±ç›¸å½“äºè®¿é—®äº† /index/pageNum=2 è·¯å¾„ã€‚

åŒ¹é…å…³é”®å­—ï¼š

- breakï¼šåœæ­¢æ‰€æœ‰rewriteåŒ¹é…
- lastï¼šæœ¬æ¡åŒ¹é…å®Œæˆåï¼Œç»§ç»­å‘ååŒ¹é…å…¶ä»–çš„ location çš„ rewrite
- redirectï¼šè¿”å› 302 é‡å®šå‘åˆ°çœŸå®åœ°å€ï¼Œè€Œä¸æ˜¯ç”¨å‡åœ°å€
- permanentï¼š301 æ°¸ä¹…é‡å®šå‘åˆ°çœŸå®åœ°å€ ï¼ˆé€‚ç”¨äºçˆ¬è™«ï¼‰

## 9. é…ç½®é˜²ç›—é“¾

ç›—é“¾ï¼ˆHotlinkingï¼‰æ˜¯æŒ‡åœ¨ä¸€ä¸ªç½‘ç«™ä¸Šï¼Œä½¿ç”¨åˆ«äººç½‘ç«™ä¸Šçš„å›¾ç‰‡æˆ–å…¶ä»–åª’ä½“èµ„æºæ¥è£…é¥°è‡ªå·±çš„ç½‘ç«™ï¼Œè€Œä¸è·å¾—è¯¥èµ„æºçš„æ‰€æœ‰è€…è®¸å¯çš„è¡Œä¸ºã€‚ç›—é“¾å¯ä»¥å¯¼è‡´è¢«ç›—ç”¨è€…çš„å¸¦å®½å’Œæµé‡å—åˆ°æ¶ˆè€—ï¼Œç”šè‡³å¯èƒ½ä½¿å…¶ç½‘ç«™é€Ÿåº¦å˜æ…¢æˆ–å´©æºƒã€‚

é˜²ç›—é“¾ä¹Ÿæ˜¯èµ„æºèŠ‚çœä¼˜åŒ–çš„å¿…å¤‡é…ç½®ã€‚nginx ä¸­æ ¹æ® http è¯·æ±‚å¤´çš„ referer åˆ¤æ–­æ¥æºå¯ä»¥åšåˆ°æ‹¦æˆªã€‚

ä¸€ä¸ªé…ç½®é˜²ç›—é“¾çš„ä¾‹å­å¦‚ä¸‹ï¼š

```json
location ~* \.(jpg|jpeg|png|gif)$ {
    valid_referers none blocked xxx.com;
    if ($invalid_referer) {
        return 403;
    }
}
```

ä»¥ä¸Šä»£ç è¡¨ç¤ºï¼Œå¦‚æœè®¿é—®çš„å›¾ç‰‡URLçš„`referer`ä¸æ˜¯ xxx.comï¼Œåˆ™è¿”å› 403 ç¦æ­¢è®¿é—®ã€‚å¦‚æœè®¿é—®çš„URLæ²¡æœ‰refererï¼Œåˆ™ä¹Ÿä¼šè¢«ç¦æ­¢è®¿é—®ã€‚

é…ç½®é¡¹ä»‹ç»ï¼š

- noneï¼šrefererä¸å­˜åœ¨æ—¶å¯ä»¥è®¿é—®ï¼Œä¸è®¾ç½®åˆ™æ‰€æœ‰è®¿é—®ä¸æ˜¯ xxx.com éƒ½ç¦æ­¢
- blockedï¼šrefererå€¼è¢«é˜²ç«å¢™æˆ–è€…ä»£ç†æœåŠ¡å™¨åˆ é™¤æˆ–ä¼ªè£…æ—¶å¯ä»¥è®¿é—®ã€‚ä¸€èˆ¬æ˜¯ä¸å¸¦ http å‰ç¼€çš„è®¿é—®æ”¾è¡Œé…ç½®ã€‚

æ¥ä¸‹æ¥é…ç½®é”™è¯¯æç¤ºé¡µé¢ï¼š

å‡è®¾æœ‰ä¸ªé¡µé¢ ï¼š `403.html`, éœ€è¦é…ç½®ç¦æ­¢è®¿é—®æ—¶æ˜¾ç¤ºï¼š

```json
error_page 403 /403.html
location = /403.html {
    root   html;  // èµ„æºæŒ‡å‘ htmlç›®å½•ä¸‹å¯»æ‰¾
}
```

æˆ–è€…åœ¨ return 403 æ—¶è®¾ç½®ï¼š`rewrite` åˆ°ä¸€ä¸ªé…ç½®å¥½çš„èµ„æºä¹Ÿå¯ä»¥ã€‚

## 10. å®‰å…¨é«˜å¯ç”¨æ–¹æ¡ˆé…ç½®

å®‰å…¨é«˜å¯ç”¨çš„æ„ä¹‰ï¼šåœ¨ä¸é¢å¤–æ·»åŠ æœºå™¨çš„æƒ…å†µä¸‹åšåˆ°ä¸downæœºåŠ¨æ€åˆ‡æ¢æœºå™¨ï¼Œä»è€Œè¾¾åˆ°æœåŠ¡æŒç»­å¯ç”¨ 

### keepalived

å®‰è£…

```sh
yum install keepalived
```

ç¼–è¾‘é…ç½®ï¼ˆ/etc/keepalived.confï¼‰:

```json
global_defs {
    router_id lb111
}

vrrp_instance_test {  // è‡ªå®šä¹‰ test å®ä¾‹
    state MASTER   // ä¸»
    interface eth01  // ä½ æœºå™¨ä¸Šç½‘å¡çš„åå­—
    virtual_router_id 33  // è™šæ‹Ÿè·¯ç”±idï¼Œä¸»ä»è¦ä¸€æ ·
    priority 100 // ä¼˜å…ˆçº§é«˜çš„æœºå™¨å°±ä¸º master
    advert_int 1 // é—´éš”æ£€æµ‹æ—¶é—´
    authentication {  // è®¤è¯é…ç½®ï¼ŒåŒä¸€ç»„ä¿æŒä¸€è‡´å³å¯
        auth_type PASS  
        auth_pass 1111  
    }
    virtual_ipaddress {
        192.168.44.1  // æœ¬å°æœºå™¨çš„è™šæ‹Ÿåœ°å€
    }
}
```

ä¸Šé¢æ˜¯ç¬¬ä¸€å°æœºå™¨çš„é…ç½®ï¼Œåœ¨ç¬¬äºŒå°è™šæ‹Ÿæœºä¸Šä¹Ÿé…ç½®ä¸€ä¸‹ç±»ä¼¼çš„é…ç½®ï¼Œè®¾ç½®ï¼š

```json
global_defs {
    router_id lb110  // ä¿®æ”¹è·¯ç”±å·
}

vrrp_instance_test {  // åŒä¸€ä¸ªå®ä¾‹
    state BACKUP   // ä»
    interface eth01  
    virtual_router_id 33
    priority 50 // å‡ä½ä¼˜å…ˆçº§
    advert_int 1
    authentication { 
        auth_type PASS  
        auth_pass 1111  
    }
    virtual_ipaddress {
        192.168.44.1  // æœ¬å°æœºå™¨çš„è™šæ‹Ÿåœ°å€
    }
}
```

ä¸¤å°æœºå™¨åˆ†åˆ«å¯åŠ¨ä¸€ä¸‹ï¼š

```
systemctl start keepalived
```

æ­¤æ—¶åœ¨å¤–ç½‘å¯ä»¥pingé€šçš„ipæ˜¯ï¼š 192.168.44.1ã€‚

æˆ‘ä»¬è®© MASTER æœºå™¨å…³æœºåï¼Œå†pingä¸€ä¸‹ 192.168.44.1ï¼Œå‘ç°ä»ç„¶å¯ä»¥ï¼Œæ­¤æ—¶åœ¨å¤‡ä»½åŠä½¿ç”¨æŒ‡ä»¤ `ip addr` æŸ¥çœ‹ï¼Œå¯ä»¥çœ‹åˆ° æœ‰ä¸€ä¸ª 192.168.44.1 çš„è™šæ‹Ÿipã€‚è¿™è¯´æ˜é«˜å¯ç”¨ç”Ÿæ•ˆäº†ï¼Œè¿™ç§é…ç½®å« ipæ¼‚ç§»ã€‚

ä¸Šè¿°æƒ…å†µåªèƒ½ä¿è¯ keepalived è¿›ç¨‹æŒ‚æ‰æ—¶èµ·ä½œç”¨ï¼Œæ›´é«˜çº§çš„ç”¨æ³•æ˜¯è·‘ä¸€ä¸ªè„šæœ¬ï¼Œæ£€æµ‹æœ¬æœºçš„ nginz æœåŠ¡è¿›ç¨‹ï¼Œå¦‚æœæœåŠ¡å¼‚å¸¸ï¼Œåˆ™ kill æ‰æœ¬æœºçš„ keepalived è¿›ç¨‹ã€‚


### https ä¸ TLS

http åè®®å¾€å¾€æ˜¯ä¸å®‰å…¨çš„ï¼Œå³ä½¿æœ‰é˜²ç«å¢™ï¼Œä½†æ˜¯æ²¡åŠæ³•é˜²å¾¡æ¶ˆæ¯åœ¨ä¼ è¾“è¿‡ç¨‹ä¸­è¢«åŠ«æŒï¼š

![image.png](/img/posts/2023-3-18/2023-3-18-10.png)

æ­¤æ—¶å°±éœ€è¦å¯¹ä¼ è¾“è¿‡ç¨‹çš„æ¶ˆæ¯è¿›è¡ŒåŠ å¯†ã€‚åŠ å¯†æ–¹å¼æœ‰å¯¹ç§°åŠ å¯†å’Œéå¯¹ç§°åŠ å¯†ã€‚

å¯¹ç§°åŠ å¯†çš„åŠ å¯†å’Œè§£å¯†äº’ä¸ºé€†è¿‡ç¨‹ï¼Œè§„åˆ™æ˜¯å›ºå®šçš„ï¼Œå­˜æ”¾åœ¨æœåŠ¡å™¨ç«¯æˆ–è€…å®¢æˆ·ç«¯ï¼Œè¿™ä¸ªåŠ å¯†ç®—æ³•ä¼ è¾“è¿‡ç¨‹ä¸­ä¹Ÿå®¹æ˜“è¢«è·å–ï¼Œæ‰€ä»¥å¹¶ä¸æ˜¯å¤ªå®‰å…¨ã€‚

- éå¯¹ç§°åŠ å¯†

éå¯¹ç§°åŠ å¯†ä¼šè®¾ç½®ä¸€ä¸ªå…¬é’¥ï¼Œç”¨äºä¼ é€’ï¼›æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯åˆ†åˆ«è®¾ç½®ä¸€ä¸ªç§é’¥ï¼Œè‡ªå·±ä¿å­˜ï¼ŒåŠ å¯†æ­¥éª¤å¦‚ä¸‹ï¼š

1. ç”¨æˆ·é€šè¿‡æœåŠ¡å™¨443ç«¯å£ä¸‹è½½å…¬é’¥ï¼Œå¹¶ä¼ é€’è‡ªå·±çš„å…¬é’¥ç»™æœåŠ¡å™¨ã€‚
2. å†æ¬¡è¯·æ±‚æœåŠ¡å™¨ï¼Œç”¨**æœåŠ¡å…¬é’¥+å¯¹ç§°åŠ å¯†ç®—æ³•**æ¥åŠ å¯†æ˜æ–‡ï¼Œç”Ÿæˆå¯†æ–‡
3. ä¼ é€’å¯†æ–‡ç»™æœåŠ¡å™¨
4. æœåŠ¡ç«¯ç”¨**æœåŠ¡ç§é’¥+åŠ å¯†ç®—æ³•**è§£å¼€å¯†æ–‡ï¼Œå¾—åˆ°æ˜æ–‡
5. ç±»ä¼¼çš„ï¼ŒæœåŠ¡ç«¯æ ¹æ®æ˜æ–‡è¯·æ±‚å’Œç”¨æˆ·ä¼ é€’çš„ç”¨æˆ·å…¬é’¥è¿›è¡Œå“åº”ï¼š**ç”¨æˆ·å…¬é’¥+ç®—æ³•çš„å¯†æ–‡**
6. ç”¨æˆ·ç”¨**ç”¨æˆ·ç§é’¥+ç®—æ³•è§£å¯†**è·å–æ•°æ®

å…¶ä¸­éœ€æ³¨æ„ï¼Œå…¬é’¥åŠ å¯†çš„æ•°æ®å…¬é’¥è‡ªå·±æ˜¯è§£ä¸å¼€çš„ï¼Œè€Œä¸”è¦ä¿è¯éƒ½æ˜¯å…¬é’¥åŠ å¯†ï¼Œç§é’¥è§£å¯†ã€‚

ä½†æ˜¯ï¼Œå¦‚æœæœåŠ¡å™¨è¢«ä¼ªé€ äº†ï¼Œå…¬é’¥æ˜¯åäººç»™çš„ï¼Œé‚£ä½ çš„æ•°æ®åŠ å¯†å†å¥½ä¹Ÿæ²¡ç”¨äº†ï¼Œè¿™å°±æ˜¯ä¸­é—´äººæ”»å‡»ã€‚

- TLS

ä¸ºäº†è§£å†³ä¸­é—´äººæ”»å‡»ï¼Œéœ€è¦å¯¹ä½¿ç”¨è€…è¿›è¡Œèº«ä»½è®¤è¯ï¼Œè¿™å°±å¼•å…¥äº†æ•°å­—è¯ä¹¦ã€‚å¸¸è§çš„æ–¹å¼æ˜¯æ‰¾ä¸€ä¸ªç¬¬ä¸‰æ–¹å…¬è®¤çš„å¥½äººï¼ˆCAï¼‰æ¥é¢å‘è¿™ä¸ªè¯ä¹¦æ¥è®¤è¯å…¬é’¥ã€‚

æœåŠ¡å™¨ä¼šç”³è¯·å…¬é’¥ç»™CAæ¥è·å–è¯ä¹¦ï¼ŒCAåˆ¤æ–­ä½ æ˜¯å¦æœ‰æ‰€è®¤è¯æœºæ„çš„ç®¡ç†æƒé™å’Œæ‹¥æœ‰æƒé™ï¼Œé€šè¿‡åé¢å‘æ•°å­—è¯ä¹¦ï¼ˆCAè‡ªå·±çš„ç§é’¥+åŠ å¯†ç®—æ³•ï¼‰ï¼›æœåŠ¡å™¨æ‹¿åˆ°è¯ä¹¦åï¼Œç»™ç”¨æˆ·ä¼ é€’çš„å°±æ˜¯è¿™ä¸ªè¯ä¹¦äº†ï¼Œç”¨æˆ·ç”¨CAå…¬é’¥è§£å¯†å‡ºæœåŠ¡å™¨å…¬é’¥æ¥ä½¿ç”¨ã€‚

æ­¤æ—¶ï¼Œä¸­é—´äººè·å–ä¸åˆ°CAçš„ç§é’¥ï¼Œæ‰€ä»¥ç”¨æˆ·ç«¯æµè§ˆå™¨å°±ä¸è®¤è¿™ä¸ªä¸­é—´äººï¼Œä»¥æ­¤è¾¾åˆ°é‰´ä¼ªã€‚ç”¨æˆ·åªè¦ä½¿ç”¨çš„æ˜¯æ­£ç‰ˆæ“ä½œç³»ç»Ÿå’Œæ­£è§„æµè§ˆå™¨ï¼Œå°±èƒ½ä¿è¯æ•°å­—è¯ä¹¦çš„è·å–ã€‚è¿™æœŸé—´ä½¿ç”¨äº† TLS ç®—æ³•ç”Ÿæˆäº†ä¸¤ç»„éšæœºæ•°ï¼Œé€šè¿‡éå¯¹ç§°åŠ å¯†ï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯è¾¾æˆä¸€è‡´ï¼Œç”Ÿæˆäº†ä¸€ä¸ªåªæœ‰ä»–ä»¬è‡ªå·±çŸ¥é“çš„å¯¹ç§°åŠ å¯†è§„åˆ™ï¼Œæˆ‘è¿™é‡Œå€Ÿç”¨[bç«™](https://www.bilibili.com/video/BV1KY411x7Jp) æŠ€æœ¯è›‹è€å¸ˆçš„è§£é‡Šå›¾ï¼š


![image.png](/img/posts/2023-3-18/2023-3-18-11.png)

ä¸Šå›¾çš„æ­¥éª¤å¦‚ä¸‹ï¼š

1. æœåŠ¡å™¨ç”Ÿæˆä¸€å¥—ç§é’¥å’Œå…¬é’¥
2. å¯ä»¥å…ˆç”Ÿæˆä¸€ä¸ªéšæœºæ•°1ï¼Œå¹¶ä¼ ç»™æœåŠ¡ç«¯ï¼Œè¯·æ±‚å…¬é’¥
3. æœåŠ¡ç«¯ç”Ÿæˆéšæœºæ•°2ï¼Œå¸¦ä¸Šå…¬é’¥ã€è¯ä¹¦ä¸€èµ·ç»™å®¢æˆ·ç«¯
4. ç°åœ¨å®¢æˆ·ç«¯ã€æœåŠ¡ç«¯ã€é»‘å®¢éƒ½çŸ¥é“äº†å…¬é’¥ã€éšæœºæ•°1å’Œéšæœºæ•°2
5. å®¢æˆ·ç«¯ç”Ÿæˆéšæœºæ•°3ï¼Œç»“åˆå…¬é’¥åŠ å¯†åç»™æœåŠ¡ç«¯ï¼ŒæœåŠ¡ç«¯é€šè¿‡ç§é’¥è§£å¯†åå¾—åˆ°æ˜æ–‡
6. å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯å„è‡ªé€šè¿‡ éšæœºæ•°1/2/3ç”Ÿæˆä¸€ä¸ªä¼šè¯ç§˜é’¥ï¼Œè¿™ä¸ªä¼šè¯ç§˜é’¥å°±æ˜¯å¯¹ç§°åŠ å¯†çš„ç§˜é’¥ï¼Œä¸”ä¸åœ¨ç½‘ç»œä¸Šä¼ é€’ã€‚
7. æ¥ä¸‹æ¥å°±æ˜¯å¯¹ç§°åŠ é€šä¿¡ç¯èŠ‚ï¼Œè€Œé»‘å®¢ç›®å‰åªçŸ¥é“å…¬é’¥ã€éšæœºæ•°1å’Œéšæœºæ•°2ï¼Œæ— æ³•ç ´è§£é€šä¿¡ã€‚


è¿™é‡Œè®²ä¸€ä¸‹ nginx å¦‚ä½•é…ç½® httpsã€‚ä½ éœ€è¦æœ‰ä¸€ä¸ªæœåŠ¡çš„å…¬ç½‘ipï¼ˆå‡è®¾ 123.456.789.111ï¼‰å’Œè´­ä¹°çš„åŸŸåï¼ˆå‡è®¾ www.abc.com ï¼‰å¹¶ç”³è¯·å¥½äº†åŸŸåè§£æå’Œæ•°å­—è¯ä¹¦ï¼ˆ.key å’Œ .pem æ–‡ä»¶ï¼‰:

```json
server {
    listen 443 ssl;
    server_name localhost;  // åŸŸåå·²ç»å’Œipç»‘å®šï¼Œå†™ localhostä¹Ÿæ˜¯èƒ½è§£æçš„
    ssl_certificate xxxx.pem;
    ssl_certificate_key xxxx.key;
    underscores_in_headers on; // å…è®¸è¯·æ±‚å¤´å‡ºç°ä¸‹åˆ’çº¿
    root html;
}
```


## 11. å˜é‡çš„ä½¿ç”¨

è·Ÿå…¶ä»–æŠ€æœ¯çš„é…ç½®æ–‡ä»¶ä¸€æ ·ï¼Œnginx ä¹Ÿèƒ½ä½¿ç”¨å˜é‡ï¼š

```json
location / { 
    set $name "zhangsan"; 
    return 200 "$name"; 
}
```

ä¸Šé¢å°±è®¾ç½®äº†ä¸€ä¸ªå˜é‡å« nameï¼Œå¹¶ä¸”ç›´æ¥è¿”å› 200 çš„è¯·æ±‚ï¼Œåœ¨é¡µé¢ä¸Šæ˜¾ç¤º name çš„å€¼ã€‚å…¶æ ¼å¼æ˜¯ï¼š

```sh
set $å˜é‡å å˜é‡å€¼
```

å½“ç„¶äº†ï¼Œnginx ä¹Ÿè‡ªå¸¦äº†ä¸€äº›å˜é‡ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ï¼Œæ¯”å¦‚ï¼š

- `$request`  å®Œæ•´çš„åŸå§‹çš„è¯·æ±‚è¡Œï¼Œä¾‹å¦‚ï¼šGET /nginx/index?a=1&b=2 HTTP/1.1
- `$request_uri`  å®Œæ•´çš„åŸå§‹è¯·æ±‚URIï¼Œè®¿é—®çš„URLé™¤å»åŸŸå(æˆ–IP)å’Œ port, å¦‚: /nginx/index?a=1&b=2
- `$args` è¯·æ±‚è¡Œä¸­çš„å…¨éƒ¨å‚æ•° ä¾‹å¦‚ï¼ša=1&b=2
- `$remote_addr` å®¢æˆ·ç«¯ipåœ°å€
- `$remote_port` å®¢æˆ·ç«¯ç«¯å£

...

nginx é…ç½®æ–‡ä»¶çš„å˜é‡å¯ä»¥ç»Ÿä¸€è®¾ç½®åœ¨æ–‡ä»¶çš„é¡¶éƒ¨ï¼Œè¿™æ ·åœ¨æ•´ä¸ªæ–‡ä»¶ä¸­éƒ½å¯ä»¥ä½¿ç”¨åŒä¸€ä¸ªå˜é‡ï¼š

```sh
set $my_var "hello";
```

å¼•ç”³ï¼šå˜é‡å€¼çš„è®¡ç®—

```json
location / { 
    set $my_var 10; 
    add_header X-Test $my_var; // æˆåŠŸå“åº”æ—¶ï¼Œæ·»åŠ å“åº”å¤´
    add_header X-Total $my_var*2; 
}
```
ä¸Šé¢çš„ä¾‹å­å°±æ˜¯å˜é‡ç®€å•çš„æ•°å€¼è®¡ç®—ã€‚


## 12. ä¸šåŠ¡åœºæ™¯æ¡ˆä¾‹

### æ¡ˆä¾‹ä¸€

- **é¡¹ç›®ä»‹ç»**ï¼šå‰ç«¯å¾®æœåŠ¡é¡¹ç›®
- **éœ€æ±‚**ï¼šå„ä¸ªå­æœåŠ¡çš„éƒ¨ç½²ï¼Œéœ€è¦æ ¹æ®ç°åº¦ç³»ç»Ÿä¼ é€’è¿‡æ¥çš„é™æ€èµ„æºç›®å½•åœ°å€æ¥åŠ¨æ€åˆ‡æ¢è½¬å‘åœ°å€
- **ä¸šåŠ¡ä»‹ç»**ï¼šè¿™æ˜¯æˆ‘å‚ä¸çš„ä¸€ä¸ªå‰ç«¯ä¸šåŠ¡åœºæ™¯ï¼Œè®¿é—®å¾®æœåŠ¡å­åº”ç”¨æ—¶ï¼Œå¾®æœåŠ¡å¯åŠ¨å™¨ä¼šè°ƒç”¨ç°åº¦ç³»ç»Ÿæ¥å£è·å–å½“å‰ç™»å½•ç”¨æˆ·çš„äº§å“æƒé™åˆ—è¡¨ï¼Œå¹¶è¿”å›ç»™å‰ç«¯æ‰“åŒ…å¥½çš„å‰ç«¯é¡µé¢é™æ€èµ„æºåœ°å€ã€‚è¿™ä¸ªåœ°å€ä¼šæ ¹æ®ç”¨æˆ·æƒé™å’Œç°åº¦ç­–ç•¥å˜åŒ–ã€‚

ç°åœ¨æœ‰ä¸Šé¢ä¸€ä¸ªå·¥ä½œï¼Œéœ€è¦é…ç½®nginxæ¥å®ŒæˆåŠ¨æ€è½¬å‘çš„å·¥ä½œï¼Œè®©ç”¨æˆ·çœ‹åˆ°ä¸åŒç‰ˆæœ¬çš„å‰ç«¯é¡¹ç›®ã€‚

#### è§£æ

å¯ä»¥ä½¿ç”¨ä¸€ä¸ªå˜é‡æ¥æ ‡è¯†èµ„æºåœ°å€ï¼Œåœ¨å‰ç«¯æœåŠ¡buildçš„CIä¸­ä¿®æ”¹è¿™ä¸ªé…ç½®æ–‡ä»¶ï¼Œæ›´æ”¹å˜é‡å€¼ã€‚

ä¸€ä¸ªç¤ºä¾‹ï¼š

```json
set $uri "/root/web/vue/dist";

server {
    listen       80;  
    server_name  www.test.com;  
    location / {  
        root   $uri; 
        index  index.html index.htm;
    }
}
```

åœ¨ CI ä¸­ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼šset $uri "/root/web/react/dist"ï¼Œé‡å¯ nginx åå³å¯ã€‚

> å¤§å®¶æœ‰æ›´å¥½çš„åŠæ³•çš„è¯ï¼Œå¯ä»¥åœ¨è¯„è®ºåŒºè®¨è®ºå“¦

### æ¡ˆä¾‹äºŒ

- **ä½¿ç”¨åœºæ™¯**ï¼šåœ¨å‰ç«¯é¡¹ç›®éƒ¨ç½²æ–°ç‰ˆæœ¬åï¼Œç”¨æˆ·æ²¡åŠæ³•æ„ŸçŸ¥åˆ·æ–°ï¼Œåœ¨ä¸å¼ºåˆ¶åˆ·æ–°çš„å‰æä¸‹ï¼Œçœ‹åˆ°çš„ä»ç„¶æ˜¯æ—§ç‰ˆæœ¬ã€‚
- **éœ€æ±‚**ï¼šéœ€è¦è®¾ç½®æœåŠ¡å™¨é…ç½®ï¼Œåœ¨å‰åç«¯ç‰ˆæœ¬ä¸ä¸€è‡´æ—¶å¼ºåˆ¶åˆ·æ–°

#### è§£æ

è¿™ä¸ªé—®é¢˜æœ‰å¤šç§è§£å†³æ–¹å¼ã€‚

å¯ä»¥é…ç½® nginxï¼Œé«˜é€Ÿæµè§ˆå™¨ä¸è¦ç¼“å­˜ï¼š

```json
location / {
    add_header Cache-Control "no-cache, must-revalidate"
}
```

æˆ–è€…é…ç½®å¼ºåˆ¶æµè§ˆå™¨ç¼“å­˜ï¼Œå¸¸ç”¨çš„åŠæ³•æ˜¯æ·»åŠ hashæˆ–è€…ç‰ˆæœ¬å·æ¥è®©æµè§ˆå™¨é‡æ–°ä¸‹è½½èµ„æºï¼š

```js
<link rel="stylesheet" href="/css/main.css?version=v2"
```68:T1f5a,ä¸Šä¸€èŠ‚è®²äº†å¦‚ä½•åœ¨ CentOS ä¸Šå®‰è£… gitlabï¼Œæœ¬èŠ‚è®²ä¸€ä¸‹å¦‚ä½•å®ç° gitlab CI/CDã€‚

## 1. å®‰è£…é…ç½® gitlab-runner

æ‰§è¡ŒæŒ‡ä»¤

```shell
mwget https://mirrors.tuna.tsinghua.edu.cn/gitlab-runner/yum/el7/gitlab-runner-11.5.1-1.x86_64.rpm
```

å®‰è£…

```shell
rpm -i gitlab-runner-11.5.1-1.x86_64.rpm
```

æŸ¥çœ‹ç‰ˆæœ¬

```shell
gitlab-runner -v
```

![image.png](/img/posts/2023-1-1/2023-1-1-1.png)

æ³¨å†Œï¼š
`gitlab-runner register`ï¼Œ
ä¼šæç¤ºè¾“å…¥URLï¼Œ

![image.png](/img/posts/2023-1-1/2023-1-1-2.png)

è¿™ä¸ªåœ¨ä»“åº“çš„é…ç½®çš„ Runners é‡Œå¯ä»¥æŸ¥åˆ°

![image.png](/img/posts/2023-1-1/2023-1-1-3.png)

æ¥ä¸‹æ¥æç¤ºè¾“å…¥ gitlab-ci tokenï¼Œé…ç½®é‡Œç´§æŒ¨ç€åˆšæ‰çš„URLçš„å°±æ˜¯Tokenï¼Œç²˜è´´è¿‡å»å›è½¦å°±å¯ä»¥å•¦ã€‚

ä¸€è·¯æŒ‰ç…§æç¤ºè¾“å…¥å°±è¡Œï¼Œè¾“å…¥tagä¸º  test-deployï¼Œæœ€åä¼šæç¤ºé€‰æ‹©å“ªç§æ‰§è¡Œå™¨ executorï¼š

![image.png](/img/posts/2023-1-1/2023-1-1-4.png)

çœ‹ä½ ç†Ÿæ‚‰å“ªä¸ªå•¦ï¼Œè¿™é‡Œä»¥ shellä¸ºä¾‹ã€‚

é…ç½®å¥½åï¼Œéœ€è¦å°†gitlabÂ æ ¡éªŒä¸€ä¸‹

![image.png](/img/posts/2023-1-1/2023-1-1-5.png)

åœ¨webé¡µé¢æŸ¥çœ‹ä¸€ä¸‹ runnersé…ç½®ï¼Œåˆšåˆšçš„æ³¨å†Œrunnerå·²ç»å­˜åœ¨å•¦ï¼š


![image.png](/img/posts/2023-1-1/2023-1-1-6.png)

ç‚¹å‡»ç¼–è¾‘æŒ‰é’®è¿›å…¥runnerç¼–è¾‘ï¼š

![image.png](/img/posts/2023-1-1/2023-1-1-7.png)
å‹¾ä¸Šå›¾ä¸­æ‰€ç¤ºé€‰é¡¹è®©æ²¡æœ‰æ‰“æ ‡ç­¾çš„é¡¹ç›®ä¹Ÿèƒ½ä½¿ç”¨ã€‚æˆ‘è¿™é‡Œ æ‰“äº† test-deploy çš„æ ‡ç­¾ã€‚åŒä¸€ä¸ªæ ‡ç­¾çš„ CI ç”¨çš„æ˜¯ä¸€ä¸ª Runnerã€‚

## 2. é¡¹ç›®buildä¸Nginxéƒ¨ç½²

å…ˆä¸ä½¿ç”¨gitlabæµæ°´çº¿ï¼Œè‡ªå·±å®ç°ä¸€ä¸‹è¯¥é¡¹ç›®çš„buildä¸nginxéƒ¨ç½²ã€‚

æœ¬æ–‡å‡†å¤‡çš„é¡¹ç›®å°±æ˜¯ä¸€ä¸ªviteåˆ›å»ºçš„ vue3 ç©ºé¡¹ç›®ï¼š

![image.png](/img/posts/2023-1-1/2023-1-1-8.png)

æŸ¥çœ‹ä»–çš„ package.jsonï¼š

```json
"scripts": {
    "dev": "vite",
    "build": "vite build",
    "preview": "vite preview"
}
```

æ‰§è¡Œï¼š

```shell
yarn build
```
å¯ä»¥çœ‹åˆ°æ‰“åŒ…æ–‡ä»¶å·²ç»ç”Ÿæˆäº†ï¼š

![image.png](/img/posts/2023-1-1/2023-1-1-9.png)

æ¥ä¸‹æ¥å°±æ˜¯åœ¨ æœåŠ¡å™¨ï¼ˆè¿˜ä»¥è¿™ä¸ªCentOSè™šæ‹Ÿæœºä¸ºä¾‹ï¼‰ä¸Šå®‰è£…ä¸€ä¸‹ Nginxï¼ŒæŠŠæ‰“åŒ…çš„æ–‡ä»¶ä¸¢è¿›å»å°±å¯ä»¥äº†ã€‚

### Nginx å®‰è£…

- å‰ç½®ä¾èµ–å®‰è£…

```shell
yum -y install gcc gcc-c++ autoconf pcre-devel zlib-devel openssl openssl-devel make automake
yum -y install httpd vim
```

- å®‰è£… Nginx

```shell
## ç”¨æˆ·ç›®å½•ä¸‹ï¼Œä¸‹è½½å…å®‰è£…ç‰ˆ (ä¹Ÿå¯ä»¥ç”¨ yum)
cd ~
mwget http://nginx.org/download/nginx-1.18.0.tar.gz

## è§£å‹ç¼©
tar zxvf nginx-1.18.0.tar.gz

## è¿›å…¥å®‰è£…ç›®å½• ï¼ˆä½ åœ¨å“ªé‡Œè§£å‹ç¼©çš„ï¼Œæ–‡ä»¶å°±åœ¨å“ªï¼‰
## é…ç½®å®‰è£…è¿è¡Œç›®å½•
./configure --prefix=/usr/local/nginx

## ç¼–è¯‘å®‰è£…
make && make install

## é…ç½®ç¯å¢ƒå˜é‡ ï¼ˆæˆ‘è¿™é‡Œåªé…ç½®ç”¨æˆ·çº§åˆ«ï¼‰
## åœ¨ç”¨æˆ·ä¸»ç›®å½•ä¸‹
vim .bash_profile

## è¿½åŠ 
PATH=$PATH:$HOME/bin:/usr/local/nginx/sbin

## ä¿å­˜é€€å‡ºåç”Ÿæ•ˆé…ç½®
source ./.bash_profile
```

æ­¤æ—¶åœ¨ä»»æ„ç›®å½•ä¸‹æ‰§è¡Œï¼š

```shell
nginx -v
```
ä¾¿å¯ä»¥çœ‹åˆ°æ‰“å°çš„ç‰ˆæœ¬å·äº†ã€‚

![image.png](/img/posts/2023-1-1/2023-1-1-10.png)

### å¯åŠ¨Nginx

```shell
å®‰è£…å®Œæ¯•ï¼Œè¿›å…¥Nginxä¸‹çš„sbinç›®å½•å¹¶å¯åŠ¨nginx
cd /usr/local/nginx/sbin
./nginx
```


### é…ç½® Nginx

> è¿™é‡Œè®² Nginx åªæ˜¯ä¸ºäº†è¾…åŠ© CI/CD è®²è§£ï¼Œé…ç½®è¯¦ç»†ä¸åšè¿‡å¤šå±•å¼€

è‹¥æ˜¯ yum å®‰è£…çš„ï¼Œé…ç½®æ–‡ä»¶åœ¨ `/etc/nginx/nginx.conf` ä¸­ï¼Œæˆ‘è¿™ä¸ªæ˜¯å…å®‰è£…ç‰ˆçš„ï¼Œé…ç½®æ–‡ä»¶åœ¨ `/usr/local/nginx` ä¸­ï¼š

```shell
vi /usr/local/nginx/conf/nginx.conf
```
æŒ‰ç…§è‡ªå·±çš„å–œå¥½é…ç½®ï¼Œæ‰¾å¯¹æ–‡ä»¶ç›®å½•å³å¯ï¼ˆå»ºè®®å•å¼€ä¸€ä¸ªå…¨å±€ç›®å½•ï¼‰ï¼š


![image.png](/img/posts/2023-1-1/2023-1-1-11.png)

æˆ‘ä»¬æŠŠ é¡¹ç›® dist ç›®å½•æ”¾å…¥å¯¹åº”é…ç½®çš„ä½ç½®ï¼ˆå»ºè®®ä¸è¦åœ¨è‡ªå®šä¹‰çš„ç”¨æˆ·ä¸‹ï¼Œä¸ç„¶ CI ä½¿ç”¨çš„è´¦æˆ· ä¼šæ‹¿ä¸åˆ°ï¼‰ï¼š


![image.png](/img/posts/2023-1-1/2023-1-1-12.png)

æŒ‰ç…§ä¸Šä¸€èŠ‚çš„è®²è§£ï¼Œé…ç½®äº†é˜²ç«å¢™å’Œè™šæ‹ŸæœºNATé…ç½®ï¼Œå¼€é€š 10087 ç«¯å£åï¼Œåœ¨ windowsä¸­è®¿é—®è™šæ‹Ÿæœºè¿™ä¸ªç«¯å£ http://192.168.137.128:10087


![image.png](/img/posts/2023-1-1/2023-1-1-13.png)
æˆåŠŸï¼

## 3. é…ç½®CI

åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹åˆ›å»º .gitlab-ci.yml æ–‡ä»¶æ¥ç¼–å†™æ‰§è¡Œæµç¨‹ã€‚

åœ¨ç¼–å†™ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¸…æ¥šä¸€ä¸ªäº‹æƒ…ï¼ŒCI/CD æ‰€è¦å®Œæˆçš„å·¥ä½œå°±æ˜¯ä¸Šè¾¹æˆ‘ä»¬æ‰‹åŠ¨ build å®Œä»¥åï¼Œå†æŠŠ dist ç›®å½•ç§»åŠ¨åˆ° nginx é…ç½®çš„ç›®å½•ä¸‹å¹¶ä¸”é‡å¯ Nginxï¼Œåªæ˜¯å˜æˆäº†æµæ°´çº¿è‡ªåŠ¨åŒ–éƒ¨ç½²è€Œå·²ï¼Œçœå»äº†ç¹æ‚çš„éƒ¨ç½²å·¥ä½œã€‚

ç¡®å®šæµæ°´çº¿åˆ†ä¸¤æ­¥ï¼šæ‰“åŒ… å’Œ éƒ¨ç½²ï¼š

```yaml
stages:
  - build
  - deploy
```

æµæ°´çº¿æ˜¯ä¸²è¡Œæ‰§è¡Œçš„ï¼Œæ•…runneråªç”¨ä¸€ä¸ªå°±å¯ä»¥ï¼Œyml ä¸­ tags è®¾ç½®ä¸ºåŒä¸€ä¸ªå°±è¡Œã€‚

æˆ‘ä»¬å†™ä¸€äº› build çš„è„šæœ¬æµ‹è¯•ï¼š

```yaml
build:
  stage: build
  tags:
    - test-deploy
  only:
    - master
  script:
    - pwd && ls -al
    - npm install --registry https://registry.npm.taobao.org && npm run build
    - cd $CI_PROJECT_DIR && ls
    - cp -r ./dist /home/gitlab-runner/web/backup/ 
  cache:
    paths:
      - node_modules/
```

> æœ€åçš„ cp æ˜¯ä¸ºäº†åœ¨ deploy èƒ½æ‹¿åˆ° build çš„æ–‡ä»¶ã€‚cp çš„æ—¶å€™åˆ«å¿˜äº†ç»™æ–‡ä»¶å¤¹æƒé™

æ¨é€åˆ° master åå‘ç° CI æŒ‚äº†ï¼š


![image.png](/img/posts/2023-1-1/2023-1-1-14.png)

åŸæ¥æ˜¯ runner ç¯å¢ƒé‡Œæ²¡æœ‰nodeç¯å¢ƒï¼Œé€šè¿‡å¦‚ä¸‹è„šæœ¬æ¥çœ‹çœ‹runnerçš„æ‰§è¡Œä½ç½®ï¼š

```yaml
before_script:
    - whoami
    - pwd
    - locate npm
    - echo ${PATH}
    - node -v
 ```
 
æ‰“å°ç»“æœï¼š

![image.png](/img/posts/2023-1-1/2023-1-1-15.png)

å¯ä»¥çœ‹åˆ°ï¼ŒPATH é‡Œæ˜¯æœ‰æˆ‘ä»¬åœ¨æœåŠ¡å™¨ä¸Šé…ç½®çš„ node çš„å…¨å±€å˜é‡çš„ï¼Œä½†æ˜¯è¿™é‡Œè¯»ä¸åˆ°ã€‚åº”è¯¥æ˜¯æœåŠ¡å™¨ç™»å½•è´¦æˆ·ä¸åŒé€ æˆçš„ã€‚


![image.png](/img/posts/2023-1-1/2023-1-1-16.png)

æº node æˆ‘æ˜¯é…ç½®åœ¨ root ä¸‹çš„å…¨å±€å˜é‡ï¼Œè€Œ CI æ˜¯è·‘åœ¨è‡ªåŠ¨åˆ›å»ºçš„ gitlab-runner è´¦æˆ·ä¸‹çš„ï¼Œæ­¤æ—¶åªè¦åœ¨runnerè´¦æˆ·ä¸‹å†å®‰è£…ä¸€æ¬¡ï¼Œé…ç½®å¥½ç¯å¢ƒå˜é‡å°±æå®šå•¦ã€‚å†æµ‹è¯•ä¸€ä¸‹ï¼š


![image.png](/img/posts/2023-1-1/2023-1-1-17.png)

å¯ä»¥çœ‹åˆ° node å·²ç»æ‹¿åˆ°ï¼Œç›´æ¥ä¸Š buildï¼š


![image.png](/img/posts/2023-1-1/2023-1-1-18.png)

å¯ä»¥çœ‹åˆ° npm build æˆåŠŸå•¦ï¼Œé‚£ä¹ˆæ‰“å®ŒåŒ…çš„ dist è¦å¦‚ä½•éƒ¨ç½²åˆ°æœåŠ¡å™¨ä¸Šå‘¢ï¼Ÿ

## 4. é…ç½®CD

é¦–å…ˆè¿›å…¥æŸ¥çœ‹ä¸€ä¸‹ ä¸Šä¸€æ­¥ cp çš„å…¬å…±ç›®å½•ï¼š


![image.png](/img/posts/2023-1-1/2023-1-1-19.png)

å¯ä»¥çœ‹åˆ°å·²ç»æœ‰å•¦ã€‚è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥åœ¨ deploy é˜¶æ®µå¤„ç†è¿™äº›æ–‡ä»¶äº†ã€‚

å¤ä¹ ä¸€ä¸‹ä¸Šä¸€èŠ‚ï¼ŒNginx éƒ¨ç½²ç›®å½•æ˜¯ï¼š/root/web/distï¼Œæˆ‘ä»¬è¯•ç€ cp ä¸€ä¸‹ï¼š

```yaml
deploy:
  stage: deploy
  tags:
    - test-deploy
  only:
    - master
  script:
    - echo "deploy"
    - pwd && ls -al
    - cp -r /home/gitlab-runner/web/backup/dist /root/web/dist
```

å‘ç°è¯»å–ä¸äº† root ä¸‹çš„ç›®å½•ï¼š


![image.png](/img/posts/2023-1-1/2023-1-1-20.png)

æ‰€ä»¥æ”¹è¿›ä¸€ä¸‹ Nginx éƒ¨ç½²ç›®å½•ï¼š


![image.png](/img/posts/2023-1-1/2023-1-1-21.png)

ä¿®æ”¹ deployï¼š
```yaml
- cp -r /home/gitlab-runner/web/backup/dist /home/gitlab-runner/web/
```

æ­¤æ—¶ 10087 ç«¯å£å·²ç»è·‘ä¸èµ·æ¥äº†ã€‚æˆ‘ä»¬æäº¤ä¸€ä¸‹ CI å†è·‘ä¸€æ¬¡ï¼š


![image.png](/img/posts/2023-1-1/2023-1-1-22.png)

æˆåŠŸå¤åˆ¶è¿‡å»äº†ã€‚

æ­¤æ—¶åœ¨ windowsä¸‹å†çœ‹çœ‹ï¼š


![image.png](/img/posts/2023-1-1/2023-1-1-23.png)

æˆåŠŸï¼

æˆ‘ä»¬æ”¹åŠ¨ä¸€ä¸‹ä»£ç æäº¤æµ‹è¯•ä¸€ä¸‹ï¼š


![image.png](/img/posts/2023-1-1/2023-1-1-24.png)

push åˆ° master ä¸Šï¼Œç­‰ CI/CD è·‘å®Œååˆ·æ–°ç½‘é¡µï¼š


![image.png](/img/posts/2023-1-1/2023-1-1-25.png)

è‡ªåŠ¨åŒ–éƒ¨ç½²å®Œæˆï¼ï¼

## 5. å°ç»“

1. å®‰è£… runner
2. é…ç½® nginx
3. ä¹¦å†™ .gitlab-ci.yml

```yaml
stages:
  - build
  - deploy

build:
  stage: build
  tags:
    - test-deploy
  only:
    - master
  before_script:
    - whoami
    - pwd
    - echo ${PATH}
    - node -v
  script:
    - pwd && ls -al
    - npm install --registry https://registry.npm.taobao.org && npm run build
    - cd $CI_PROJECT_DIR && ls
    - cp -r ./dist /home/gitlab-runner/web/backup/
  cache:
    paths:
      - node_modules/

deploy:
  stage: deploy
  tags:
    - test-deploy
  only:
    - master
  script:
    - echo "deploy"
    - pwd && ls -al
    - cp -r /home/gitlab-runner/web/backup/dist /home/gitlab-runner/web/
```

4. éƒ¨ç½²ç›®å½•æ£€æŸ¥ä¸æµ‹è¯•ä»£ç 69:T190d,ä¹‹å‰ä¸€ç›´æ¯”è¾ƒå¿Œè®³åœ¨å‰ç«¯é¡¹ç›®ä¸­ä½¿ç”¨å…¨å±€çŠ¶æ€ç®¡ç†å·¥å…·ï¼Œå®‰è£…åŒ…æ¯”è¾ƒå¤§ï¼Œé…ç½®èµ·æ¥æ¯”è¾ƒç¹çï¼Œæ¯”å¦‚ Reduxã€‚ä½†æ˜¯éšç€é¡¹ç›®ä¸šåŠ¡çš„å¢å¤šï¼Œä¸€äº›çŠ¶æ€å¾ˆéš¾åšåˆ°ç»„ä»¶é—´å…±äº«ï¼Œæ¯”å¦‚ç™»å½•çŠ¶æ€. é€šçŸ¥æ¶ˆæ¯ç­‰ã€‚


## 1. å‰ç«¯çŠ¶æ€ç®¡ç†æ–¹æ¡ˆ

ä¸‹é¢æ¥å¯¹æ¯”ä¸€ä¸‹ å‰ç«¯é¡¹ç›®ä¸­å…¨å±€çŠ¶æ€ç®¡ç†çš„å‡ ç§æ–¹å¼ã€‚

1. localStorage / sessionStorage

2. cookie

3. Context å…¨å±€ä¸Šä¸‹æ–‡

4. çŠ¶æ€ç®¡ç†å·¥å…·ï¼Œæ¯”å¦‚ Redux. Piniaç­‰


### 1. localStorage

å…ˆè¯´ç¬¬ä¸€ç§ï¼Œå¯ä»¥å­˜åœ¨æµè§ˆå™¨æœ¬åœ°çš„ä¸€ç§å­˜å‚¨æ–¹å¼ã€‚ç¡®å®é¡¹ç›®ä¸­ç»å¸¸åœ¨ç”¨ï¼š

```js
export function setLocalStorage(key, value) {
    try {
        window.localStorage.setItem(key, JSON.stringify(value));
    } catch (e) {
        console.log(e.message)
    }
}

export function getLocalStorage(key) {
    const value = window.localStorage.getItem(key);
    try {
        return JSON.parse(value);
    } catch (e) {
        return value;
    }
}
```

- ä¼˜åŠ¿
    1. èƒ½å¤Ÿé•¿æœŸå‚¨å­˜æ•°æ®
    2. åŒä¸€ä¸ªåŸŸä¸‹å…±äº«åŒä¸€ä¸ªå¯¹è±¡
    3. ä¸ä¼šéš HTTP è¯·æ±‚å‘é€
    4. é¡µé¢çº§åˆ«ä½¿ç”¨
- ç¼ºç‚¹
    1. ä¸åŒçš„æµè§ˆå™¨çª—å£ä¸‹ï¼Œä¿¡æ¯ä¼šç›¸äº’å¹²æ‰°
    2. åœ¨æµè§ˆå™¨çš„éšç§æ¨¡å¼ä¸‹ä¸å¯ä»¥è¯»å–
    3. ç”±äºæœåŠ¡å…³é—­åä¿¡æ¯è¿˜èƒ½å­˜åœ¨åœ¨æµè§ˆå™¨ç¼“å­˜ä¸­ï¼Œæ•…ä¸é€‚å®œå­˜å‚¨æ•æ„Ÿä¿¡æ¯ï¼Œæ¯”å¦‚ç™»å½•ä¿¡æ¯ç­‰
    4. ç”±äºä½¿ç”¨äº† window å¯¹è±¡ï¼Œéæµè§ˆå™¨ç¯å¢ƒä¸å¯ä½¿ç”¨
    5. æ— æ³•å“åº”å¼è§¦å‘æ‰€æœ‰ç»„ä»¶åŒæ­¥æ›´æ–°çŠ¶æ€ï¼ˆè¿™ä¹Ÿæ˜¯reduxå­˜åœ¨çš„æ„ä¹‰ï¼‰
- å»ºè®®
   - å­˜å‚¨å¸¸ç”¨çš„ä¸‹æ‹‰èœå•é€‰æ‹©é¡¹. å…¬ç”¨åˆ—è¡¨. æšä¸¾ç­‰ã€‚


### 2. Cookie

- ä¼˜åŠ¿
    1. å¯ä»¥å‰åç«¯å…±äº«
    2. åŒä¸€ä¸ªåŸŸä¸‹å…±äº«åŒä¸€ä¸ªå¯¹è±¡
- ç¼ºç‚¹
    1. é™åˆ¶å¤§å°4Kï¼Œåªèƒ½å­˜ä¸€äº›å…¬å…±å˜é‡ï¼Œä½¿ç”¨åœºæ™¯ä¸é€‚åˆç”¨äºç¼“å­˜
    2. å­˜åœ¨é¢å¤–çš„å®‰å…¨é…ç½®æˆæœ¬
    3. è·¨åŸŸå­˜åœ¨é—®é¢˜ï¼Œéœ€è¦é¢å¤–çš„é…ç½®æˆæœ¬
    4. ä¸å¤Ÿçµæ´»ï¼Œä¸èƒ½é€‚åº”è¶Šæ¥è¶Šå¤šçš„å…¨å±€çŠ¶æ€çš„æ·»åŠ 

### 3. Context

Context ä¼ é€’ä¿¡æ¯æ˜¯ç»„ä»¶çº§åˆ«çš„ï¼Œå¾€å¾€åŒ…è£¹åœ¨éœ€è¦å…±äº«å‚æ•°çš„ç»„ä»¶é›†åˆçš„æœ€å¤–å±‚ï¼š

```js
const BasicContext = React.createContext({});

<BasicContext.Provider value={{ ...context, ...systemStore }} >
    ...
</BasicContext.Provider>
```

Context ä¸äº§ç”Ÿæ•°æ®æ¥æºï¼Œå¾€å¾€å’Œç¼“å­˜ä¸€èµ·ä½¿ç”¨ï¼Œæ¯”å¦‚ systemStore å¯ä»¥æ˜¯ getLocalStorage æ‹¿åˆ°çš„ä¸€å †æ•°æ®çš„é›†åˆï¼Œè¢«ä»–åŒ…è£¹çš„å­å…ƒç´ ä¾¿éƒ½å¯ä»¥å…±äº«åŒä¸€ä»½ä¸Šä¸‹æ–‡æ•°æ®ã€‚

- ä¼˜åŠ¿
    1. ä½¿ç”¨ç®€å•ï¼Œä¸éœ€è¦é¢å¤–é…ç½®
    2. ç»„ä»¶çº§åˆ«ä½¿ç”¨
- ç¼ºç‚¹
    1. åªæä¾›ä¸€ä¸ªä¸Šä¸‹æ–‡ç¯å¢ƒï¼Œå¿…é¡»å’Œå…¶ä»–çš„çŠ¶æ€ç®¡ç†å·¥å…·ä¸€èµ·ä½¿ç”¨
    2. å—æ¡†æ¶é™åˆ¶
    3. contextç›¸å½“äºå…¨å±€å˜é‡ï¼Œ éš¾ä»¥è¿½æº¯æ•°æ®æº
    4. è€¦åˆåº¦é«˜ï¼Œå³ä¸åˆ©äºç»„ä»¶å¤ç”¨ä¹Ÿä¸åˆ©äºæµ‹è¯•
    5. æ²¡åŠæ³•åå‘ä¿®æ”¹çŠ¶æ€å€¼ï¼Œå­ç»„ä»¶åªèƒ½è¢«åŠ¨è¯»å–

### Mobx

ä½¿ç”¨æ¡†æ¶çº§åˆ«çš„çŠ¶æ€ç®¡ç†å·¥å…·å¯ä»¥ç”¨æ¥å­˜å‚¨ä¸´æ—¶çš„å‰ç«¯å±‚çº§çš„å…¬å…±çŠ¶æ€ï¼š


- ä¼˜åŠ¿
    1. ä¾¿äºä»£ç ç®¡ç†
    2. ç»„ä»¶çº§åˆ«ä½¿ç”¨
    3. è¯»å†™æ–¹ä¾¿ï¼Œæ²¡æœ‰å®‰å…¨é—®é¢˜
- ç¼ºç‚¹
    1. å—æ¡†æ¶é™åˆ¶
    2. éœ€è¦é¢å¤–çš„é…ç½®
    3. ä¸šåŠ¡è€¦åˆåº¦é«˜ï¼Œç”¨æˆ·å†™ä¸šåŠ¡å¿…é¡»ç…§é¡¾åˆ°çŠ¶æ€çš„é…ç½®
    4. ...

Mobx æ˜¯ä¸€ç§ç›¸å¯¹èƒ½å¤Ÿå…‹æœé…ç½®ç¹çé—®é¢˜çš„å·¥å…·ï¼Œè¿™æ¬¡åœ¨é¡¹ç›®å¼€å‘ä¸­å°±å¼•å…¥äº† Mobxï¼Œä½¿ç”¨å“åº”å¼+å‡½æ•°å¼æ¨¡å¼ï¼Œå¹¶å°† Reducerå’ŒActionåˆä¸ºä¸€ä½“ï¼Œä½¿å¾—Mobxç›¸å¯¹äº Redux ç®€å•è®¸å¤šã€‚

## 2. Mobx ä½¿ç”¨

è¿™é‡Œä»¥å®ç°ä¸€ä¸ªè¿è¥ç³»ç»Ÿå†…éƒ¨å½“å‰å¾…å®¡æ ¸é¡¹ç›®çš„æ•°é‡æç¤ºä¸ºä¾‹ï¼Œè®²è§£ Mobx åœ¨å‡½æ•°å¼ç»„ä»¶ä¸­çš„ä½¿ç”¨ã€‚

- å®‰è£…

```js
yarn add mobx mobx-react-lite
```

- å¼•å…¥ï¼šæ–°å»º stores.js

```js
import { runInAction } from "mobx"
import { useLocalObservable } from 'mobx-react-lite';

// è‡ªå·±å®šä¹‰çš„ APIè¯·æ±‚ï¼Œæœ¬è´¨æ˜¯ä¸€ä¸ª Promise
import { GetAuditingDataCount } from '../../src/apis/usms';

export const Store = () => {

  // åˆ›å»ºè§‚å¯Ÿè€…
  const storeContext = useLocalObservable(() => ({
    // çŠ¶æ€
    auditCount: {},
    get getAuditCount() { return this.auditCount; },
    // è¯·æ±‚APIçš„action
    reloadAuditCount() {
      GetAuditingDataCount().then(res => {
        runInAction(() => {
          this.auditCount = res?.Data || {}
        })
      })
    },
    // é‡ç½®çŠ¶æ€
    resetAuditCount() {
      runInAction(() => {
        this.auditCount = {};
      })
    }
  }));

  return { storeContext }
}

```
ä¸Šé¢å°±åˆ›å»ºäº†ä¸€ä¸ªè¯»å–å½“å‰å¾…å®¡æ ¸æ•°é‡çš„storeã€‚

- ä¸šåŠ¡ä¸­ä½¿ç”¨ï¼šä½¿ç”¨ observer åŒ…è£¹è¦ç”¨åˆ°çŠ¶æ€çš„ç»„ä»¶ï¼Œnameåœ¨è¿™ä¸ªç»„ä»¶å†…éƒ¨å°±å»ºç«‹äº†ç›‘å¬

```js
import { observer } from "mobx-react-lite";

function Menu() {
  ...
}

export default observer(Menus)
```

å€ŸåŠ© Context ä¼ å€¼ç»™ Menuï¼š

```js
// å¼•å…¥è‡ªå®šä¹‰çš„ store
import { Store as MobxStore } from '../stores';

const { storeContext } = MobxStore();

// å•ç‹¬ä¸€ä¸ªæ–‡ä»¶å†™å…¥ï¼šconst BasicContext = React.createContext({});
<BasicContext.Provider value={{ storeContext }} >
    ...
    <Menu />
    ...
</BasicContext.Provider>
```

Menu ç»„ä»¶å†…éƒ¨ä½¿ç”¨ï¼š

```js
import BasicContext from '../../BasicContext'

const context = useContext(BasicContext);

const storeContext = context.storeContext || {};
```
å¦‚æ­¤å°±æ‹¿åˆ°äº†é‚£ä¸ª store çš„å•ä¾‹ï¼Œè¿›è€Œåœ¨æ¸²æŸ“æ—¶å°±å¯ä»¥è¿™æ ·å†™ï¼š

```js
<Menu.SubMenu
    title={
      <span>
        {menu.icon}
        // è¿™é‡Œæ˜¯é‡ç‚¹ï¼Œå¯ç›´æ¥è·å–çŠ¶æ€æ•°æ® storeContext?.auditCount?.TotalCount
        {menu.auditCount ? <Badge offset={[4, 0]} dot={(storeContext?.auditCount?.TotalCount || 0) > 0}>
          <span>{menu.name}</span>
        </Badge> : <span>{menu.name}</span>}
      </span>
    }
    key={menu.key}
    >
    {genMenus(menu.children)}
</Menu.SubMenu>
```

æ•°æ®å˜æ›´ï¼š

```js
// å®¡æ ¸æ¥å£

AuditAPI(...).then(() => {
    ...
    // åˆ·æ–° mobx çŠ¶æ€
    storeContext.reloadAuditCount();
});
```
å½“å®¡æ ¸çŠ¶æ€å˜åŒ–æ—¶ï¼ŒåŠ¨æ€è°ƒç”¨APIé‡æ–°è®¾ç½®storesé‡Œçš„å€¼åï¼Œæ‰€æœ‰è¢« observe çš„ç»„ä»¶éƒ½ä¼šè‡ªåŠ¨å˜åŒ–ï¼š


![image.png](/img/posts/2022-12-26/2022-12-26-1.png)


## 3. æ€»ç»“

ä¸æ˜¯ä¸‡ä¸å¾—å·²ï¼Œå°½é‡ä¸è¦ä¸Šå…¨å±€çŠ¶æ€ç®¡ç†å·¥å…·ï¼Œä½¿ç”¨ Context + sessionStorage ä»£æ›¿å³å¯ã€‚åœ¨éœ€è¦å®æ—¶æˆ–è§¦å‘å¼æ›´æ–°çŠ¶æ€çš„åœ°æ–¹ï¼Œå¦‚æœä¸èƒ½ä¸Š webSocketï¼Œå®åœ¨è¦ç”¨ï¼Œå°±ä½¿ç”¨é…ç½®ç®€å•ï¼Œè€¦åˆæ€§ä½çš„å·¥å…·ã€‚åŒæ—¶è¿˜è¦ç…§é¡¾åˆ°å®‰å…¨æ€§ï¼Œæ¨èé…ç½®ï¼šContext + Mobx.6a:Tbff,åœ¨éƒ¨ç½²å‰ç«¯æœåŠ¡çš„è¿‡ç¨‹ä¸­ï¼Œéœ€è¦å®ç°ç™»å½•ä¿¡æ¯å…±äº«çš„åŠŸèƒ½ï¼Œè‹¥å„ä¸ªæœåŠ¡æ˜¯åœ¨åŒä¸€ä¸ªåŸŸåä¸‹çš„ï¼Œåˆ™å¯ä»¥å…±äº«cookieã€‚ä½†æ˜¯ï¼Œå…¬å¸å¯¹å¤–äº§å“å¾€å¾€éƒ½æ˜¯å•ç‹¬éƒ¨ç½²åŸŸåçš„ï¼Œæ¯”å¦‚äº§å“é¡µé¢ã€é—¨æˆ·ç½‘ç«™ç­‰ï¼Œä»–ä»¬è‹¥éœ€è¦æ‹¿åˆ°å½“å‰ç™»å½•ä¿¡æ¯ï¼Œå°±éœ€è¦ç‰¹æ®Šé…ç½®äº†ã€‚

äº§å“éƒ¨ç½²é…ç½®ï¼š

- ç™»å½•é¡µé¢ï¼š https://passport.xxx.com
- å¾®æœåŠ¡äº§å“ç³»ç»Ÿï¼šhttps://console.xxx.com
- é—¨æˆ·ç½‘ç«™ï¼šhttps://www.xxx.com
- äº§å“æ–‡æ¡£ï¼šhttps://docs.xxx.com

å¯ä»¥çœ‹åˆ°çº¿ä¸Šéƒ¨ç½²åï¼Œå…¬å¸äº§å“çš„äºŒçº§åŸŸåè™½ç„¶æ˜¯ä¸ä¸€æ ·ï¼Œä½†æ˜¯ä¸€çº§åŸŸåä¸€æ ·ï¼ŒæŠŠcookieçš„Domainè®¾ç½®ä¸º `.xxx.com` å°±å¯ä»¥å…±äº«äº†ã€‚ä½†æ˜¯å¦‚æœæ˜¯æœ¬åœ°å¼€å‘å°±å¤´ç–¼äº†ã€‚æœ¬åœ°å¼€å‘ï¼Œä¼šå…ˆè·³è½¬åˆ°éƒ¨ç½²å¥½çš„ç™»å½•é¡µï¼š`passport.xxx.admin.com`ï¼Œç„¶åå†è·³è½¬å› `localhost` ï¼Œæ­¤æ—¶ï¼Œæ¥æºçš„ä¸€çº§åŸŸåä¸ä¸€æ ·ï¼Œå°±ä¼šå‡ºç°cookieæ²¡åŠæ³•å…±äº«çš„é—®é¢˜äº†ã€‚

è¿™é‡Œæä¾›ä¸‰ç§è·¨åŸŸcookieæ–¹æ¡ˆä¾›é€‰æ‹©ã€‚

## 1. åç«¯é…ç½®

æˆ‘ä»¬çŸ¥é“ cookie æœ‰å‡ ä¸ªå±æ€§ï¼š

![image.png](/img/posts/2022-12-25/2022-12-25-1.png)

HttpOnly å’Œ Secure ç”¨äºé™åˆ¶åªèƒ½ https ä¼ é€’ä¸å¯è¯»çš„å®‰å…¨ cookieï¼›å¦å¤–ä¸€ä¸ªå±æ€§ SameSite å¯ä»¥è®¾ç½®ä¸‰ä¸ªå€¼ï¼š`Strict`ã€`Lax`ã€`None`ï¼š

- `Strict`ï¼šå®Œå…¨ç¦æ­¢ç¬¬ä¸‰æ–¹è·å–cookieï¼Œè·¨ç«™ç‚¹æ—¶ï¼Œä»»ä½•æƒ…å†µä¸‹éƒ½ä¸ä¼šå‘é€cookie
- `Lax`ï¼šé˜²èŒƒè·¨ç«™ï¼Œå¤§å¤šæ•°æƒ…å†µä¸‹ç¦æ­¢è·å–cookieï¼Œé™¤éå¯¼èˆªåˆ°ç›®æ ‡ç½‘å€çš„GETè¯·æ±‚ï¼ˆé“¾æ¥ã€é¢„åŠ è½½ã€GETè¡¨å•ï¼‰
- `None`ï¼šæ²¡æœ‰é™åˆ¶ã€‚å¿…é¡»åŒæ—¶è®¾ç½®`Secure`å±æ€§ï¼ˆCookie åªèƒ½é€šè¿‡ HTTPS åè®®å‘é€ï¼‰ï¼Œå¦åˆ™æ— æ•ˆï¼Œéœ€è¦ chrome > 80ï¼Œå…¼å®¹æ€§æœ‰é—®é¢˜ï¼š

![image.png](/img/posts/2022-12-25/2022-12-25-2.png)

æ­¤æ—¶ï¼Œåªè¦è®¾ç½® åªæ”¯æŒhttps ä¸” samesite=Noneï¼Œä¾¿ä¼šåœ¨ https ä¸‹æºå¸¦ cookie äº†ã€‚ä½†æ˜¯è¿™åªé€‚ç”¨äº httpsï¼Œå¼€å‘ç¯å¢ƒå¤§å¤šæ˜¯ httpï¼Œä¸èƒ½ç”¨ã€‚

## 2. å‰ç«¯é…ç½®

å‰ç«¯ä¹Ÿæ˜¯å¯ä»¥è®¾ç½® cookie çš„ï¼Œè€Œä¸”å¯ä»¥æŒ‡å®šåŸŸåã€‚åœ¨ç™»å½•é¡µé¢ç™»å½•åè®¾ç½® cookieï¼š

```js
let host = window.location.host;

if (host.indexOf('passport.xxx.admin.com') > -1) {
    host = '.xxx.admin.com';
}

window.document.cookie = `${name}=${value};domain=${host}`;
```


## 3. è·³è½¬æ—¶è®¾ç½®å›è°ƒå‚æ•°

é’ˆå¯¹å‰ç«¯é…ç½®çš„è¡¥å……æ–¹æ¡ˆï¼Œæ­¤æ–¹æ³•ä¹Ÿé€‚åˆ iframe ä¼ å‚æ–¹å¼ã€‚

åœ¨ `localhost` è¿›å…¥å¼€å‘é¡µé¢ï¼Œæ­¤æ—¶æ£€æµ‹åˆ°æ²¡æœ‰ cookie ä¿¡æ¯ï¼Œä¼šè‡ªåŠ¨è·³è½¬åˆ°ç™»å½•é¡µé¢ï¼š `passport.xxx.admin.com`, è·³è½¬æ—¶å›å¸¦å‚æ•°ï¼š

```shell
http://passport.xxx.admin.com?origin=localhost
```

ç™»å½•é¡µé¢ç™»å½•åï¼Œç›´æ¥è¯»å–è·¯ç”±å‚æ•°ä¸­çš„ originï¼Œå¹¶è®¾ç½®å¸¦ç€ host çš„ cookieï¼š

```js
window.document.cookie = `${name}=${value};domain=${origin}`;
```
è®¾ç½®å®Œæ¯•åé‡å®šå‘é¡µé¢è·³è½¬å› origin å³å¯å®ç° cookie æºå¸¦ã€‚


## 4. å¯¹æ¯”

- åç«¯é…ç½®å€¾å‘äºå‰åç«¯ä¼ é€’ cookie æ—¶ä½¿ç”¨ï¼Œè‹¥åªæ˜¯å‰ç«¯å…±äº« cookieï¼Œä¸éœ€è¦å‘ŠçŸ¥åç«¯æ—¶åˆ™ä¸å¯ç”¨
- å‰ç«¯é…ç½®å¯ä»¥å®ç°åç«¯æ— æ„Ÿçš„cookieä¼ é€’ï¼Œä½†æ˜¯å®‰å…¨æ€§ä¸é«˜ï¼Œä¸å¯ä¼ é€’æ˜æ–‡ï¼Œå°½é‡åªç”¨åœ¨å¼€å‘ç¯å¢ƒã€‚

--------
å®Œ ï¼6b:T18f4,åœ¨å›¢é˜Ÿä»£ç ç§æœ‰ä»“åº“ä¸­ï¼Œäº’è”ç½‘å…¬å¸ä¸­gitlabåº”è¯¥æ˜¯é¦–é€‰çš„ï¼Œä¸ä»…ä»…æ˜¯ä¸ªä»“åº“ï¼Œå…¶æ”¯æŒç§æœ‰åŒ–éƒ¨ç½²å’Œå…·å¤‡ç‹¬æœ‰çš„CI/CDï¼Œä¼˜åŠ¿æ˜æ˜¾ã€‚gitlab æœ‰å…è´¹çš„ç¤¾åŒºç‰ˆï¼ˆCEï¼‰ä¹Ÿæœ‰æ”¶è´¹çš„ä¼ä¸šç‰ˆï¼ˆEEï¼‰ï¼Œå›½å†…è¿˜æœ‰æç‹ç‰ˆï¼ˆJHï¼‰ã€‚æœ¬æ–‡ä»¥ CE ä¸ºä¾‹è®²è§£ã€‚

æœ¬æ–‡ä»‹ç»å¦‚ä½•åœ¨æœåŠ¡å™¨ï¼ˆä»¥centOS7ä¸ºä¾‹ï¼‰ä¸Šå®‰è£…gitlabï¼Œå¹¶å®ç°webç«¯è´¦å·é…ç½®ä¸sshé…ç½®ä»“åº“ã€‚

> å›½å†…å¯ä»¥ä½¿ç”¨ gitlab åœ¨å›½å†…çš„ä»£ç† [æç‹](https://gitlab.cn/install/) æ¥å®‰è£…ï¼Œå¾ˆå¤šè®¾ç½®éƒ½å·²ç»åšå¥½äº†ï¼Œä¹Ÿä¸å­˜åœ¨ç½‘ç»œé—®é¢˜ï¼Œå¯ä»¥çœå»å¾ˆå¤šç¹é‡çš„é…ç½®å·¥ä½œã€‚æœ¬æ–‡è¿˜æ˜¯ä»¥æ¸…åçš„é•œåƒæºä¸ºä¾‹ã€‚

## 1. å®‰è£…å‰æ£€æŸ¥

åœ¨å®‰è£…å‰ï¼Œå¯ä»¥æ£€æŸ¥ä¸€ä¸‹æ˜¯å¦å®‰è£…æœ‰æ—§ç‰ˆæœ¬ï¼Œå¸è½½æ‰ä»–ï¼

æŒ‰é¡ºåºæ‰§è¡Œå¦‚ä¸‹æŒ‡ä»¤ï¼š

```shell
## åœæ­¢gitlab
gitlab-ctl stop

## å¸è½½ (è¯·ç¡®å®šç‰ˆæœ¬`ce/ee/jh`ç­‰ã€‚è‹¥æ‰¾ä¸åˆ°åŒ…è¯´æ˜ä¸Šæ¬¡æ²¡æœ‰å®‰è£…æˆåŠŸ)
rpm -e gitlab-ce

## æ£€æŸ¥ä¸€ä¸‹è¿›ç¨‹
ps aux | grep gitlab
```


![image.png](/img/posts/2022-12-24/2022-12-24-1.png)

```shell
## æ¸…é™¤æ‰ service çš„è¿›ç¨‹
kill -9 9956

## åˆ é™¤æ‰€æœ‰åŒ…å«gitlabæ–‡ä»¶ ï¼ˆé€’å½’æŸ¥æ‰¾æœ‰äº›æ…¢ï¼Œå¯ä»¥ä¸åšï¼‰
find / -name gitlab | xargs rm -rf
```

## 2. å®‰è£…

- æ“ä½œç³»ç»Ÿï¼šCentOS7
- gitlabï¼šGitLab-ce æ¸…åæºé•œåƒ ï¼ˆgitlab-ce-11.5.3-ce.0.el7.x86_64.rpmï¼‰

### å‰ç½®å®‰è£…

åœ¨ç³»ç»Ÿé˜²ç«å¢™ä¸­æ‰“å¼€ HTTPã€HTTPS å’Œ SSH è®¿é—®ã€‚å¦‚æœæ‰“ç®—ä»…ä»æœ¬åœ°ç½‘ç»œè®¿é—®æç‹GitLabï¼Œåˆ™å¯ä»¥è·³è¿‡å®ƒã€‚

```shell
## å…¨éƒ¨ç²˜è´´ä¸€èµ·ä¸¢åˆ°ç»ˆç«¯é‡Œ
sudo yum install -y curl policycoreutils-python openssh-server perl
sudo systemctl enable sshd
sudo systemctl start sshd

sudo firewall-cmd --permanent --add-service=http
sudo firewall-cmd --permanent --add-service=https
sudo systemctl reload firewalld
```

sshé…ç½®ï¼š

```shell
sudo yum install curl policycoreutils openssh-server openssh-clients
```

é…ç½®é‚®ä»¶é€šçŸ¥ï¼ˆå¯é€‰ï¼‰

```shell
sudo yum install postfix
sudo systemctl enable postfix
sudo systemctl start postfix
```

ä¿®æ”¹é‚®ä»¶é…ç½®ï¼švi /etc/postfix/main.cf

```shell
inet_interfaces = allÂ Â  Â Â Â  Â Â  Â  //ä¹‹å‰åº”è¯¥æ˜¯localhost
```

å¯åŠ¨ postfixï¼š

```shell
service postfix start
systemctl status postfix.service
sudo systemctl enable postfix
```

ç”±äºå›½å†… wgeté€Ÿåº¦è¾ƒæ…¢ï¼Œå¯ä»¥ä½¿ç”¨ mwgetï¼š(è¿™ä¸€å †ä¸¢åˆ°ç»ˆç«¯é‡Œ)

```shell
wget http://jaist.dl.sourceforge.net/project/kmphpfm/mwget/0.1/mwget_0.1.0.orig.tar.bz2
yum install bzip2 gcc-c++ openssl-devel intltool -y
bzip2 -d mwget_0.1.0.orig.tar.bz2
tar -xvf mwget_0.1.0.orig.tar 
cd mwget_0.1.0.orig
./configure 
make
make installã€€
```

### ä¸‹è½½ä¸å®‰è£… gitlab

ä¸‹è½½é•œåƒæºï¼š

```shell
mwget https://mirrors.tuna.tsinghua.edu.cn/gitlab-ce/yum/el7/gitlab-ce-11.5.3-ce.0.el7.x86_64.rpm
```

å®‰è£…ï¼š

```shell
rpm -i gitlab-ce-11.5.3-ce.0.el7.x86_64.rpm
```
æˆ‘è¿™é‡Œå‡ºç°äº†ç£ç›˜ç©ºé—´ä¸è¶³çš„é—®é¢˜ï¼š

![image.png](/img/posts/2022-12-24/2022-12-24-2.png)

çœ‹äº†ä¸€ä¸‹ï¼Œä¸€å…±ä½¿ç”¨äº† 6Gï¼š

![image.png](/img/posts/2022-12-24/2022-12-24-3.png)

æŸ¥çœ‹å¯ç”¨ç©ºé—´ï¼š

![image.png](/img/posts/2022-12-24/2022-12-24-4.png)
æ ¹è·¯å¾„ä¸‹åªå‰©5Gä¸åˆ°äº†ï¼Œæ¸…ç†äº†åˆ é™¤åæœªé‡Šæ”¾ç£ç›˜çš„æ–‡ä»¶åå†è¯•ã€‚

è€å¿ƒç­‰å¾…åä¼šæœ‰å®‰è£…æˆåŠŸæç¤º


![image.png](/img/posts/2022-12-24/2022-12-24-5.png)

æ­¤æ—¶æŸ¥çœ‹gitlabç‰ˆæœ¬ï¼š

```shell
cat /opt/gitlab/embedded/service/gitlab-rails/VERSION

## 11.5.3
```
> ä¹Ÿå¯ä»¥ä½¿ç”¨ docker å®‰è£…ï¼šhttps://docs.gitlab.cn/jh/install/docker.html

## 3. å®‰è£…åé…ç½®

### é‡ç½®rootè´¦æˆ·

ç¼–è¾‘Â `/etc/gitlab/gitlab.rb`ï¼ˆå¦‚æœä¸å­˜åœ¨åˆ™åˆ›å»ºï¼‰å¹¶è®¾ç½®ï¼š

```shell
gitlab_rails['initial_root_password'] = 'passport'
```
åŒç›®å½•ä¸‹çš„ initial_root_password ä¹Ÿä¿®æ”¹ä¸€ä¸‹ï¼Œå¦‚æœæœ‰çš„è¯ã€‚å½“ç„¶ä¹Ÿå¯ä»¥é‡ç½®å¯†ç ï¼š

```shell
## 1. è·å–ç®¡ç†å‘˜æƒé™
sudo su
## 2. è¿›å…¥æ§åˆ¶å°
gitlab-rails console production
## 3. æŸ¥æ‰¾rootç”¨æˆ·
user = User.where(id: 1).first
## 4. è®¾ç½®
user.password = 'passport' #è®¾ç½®æ–°çš„å¯†ç 
user.password_confirmation = 'passport'  #ç¡®è®¤å¯†ç 
## 5. ä¿å­˜
user.save!
## å½“å‘ç°=> trueæ—¶è¡¨ç¤ºé‡ç½®æˆåŠŸ

## 6. é€€å‡º
ctrl+d or exit
```

### é…ç½®web URL
ç¼–è¾‘Â `/etc/gitlab/gitlab.rb`

```shell
## é…ç½®æœ¬æœºipå¯è®¿é—®çš„åœ°å€
external_url "http://127.0.0.1:10086"
```

æœ€åç”Ÿæ•ˆé…ç½®ï¼š

```shell
gitlab-ctl reconfigure
```

æŸ¥çœ‹çŠ¶æ€

```shell
gitlab-ctl status
```

## 4. Web è®¿é—®

æµè§ˆå™¨é‡Œæ‰“å¼€åˆšåˆšé…ç½®çš„ url åœ°å€ï¼š


![image.png](/img/posts/2022-12-24/2022-12-24-6.png)

> å¦‚æœå‡ºç°äº† 502 é”™è¯¯ï¼Œå¯èƒ½æ˜¯ç«¯å£è¢«å ç”¨äº†ï¼Œä¹Ÿå¯èƒ½æ˜¯å†…å­˜ä¸è¶³äº†

è¾“å…¥é…ç½®å¥½çš„å¯†ç ï¼š
- root/password

è¿›å…¥ç•Œé¢ï¼š


![image.png](/img/posts/2022-12-24/2022-12-24-7.png)

## 5. å®¢æˆ·ç«¯è®¿é—®

### è®¾ç½® CentOS å¤–éƒ¨å¯è®¿é—®ï¼š

æ‰§è¡ŒæŒ‡ä»¤ï¼š

```shell
iptables -F  
iptables -P INPUT ACCEPTï¼ˆè®¾ç½®é»˜è®¤å…è®¸è§„åˆ™ï¼‰
```
é…ç½®é˜²ç«å¢™ï¼Œå…è®¸10086ç«¯å£è®¿é—®ï¼š

```shell
## /etc/sysconfig/iptables-config

## æ·»åŠ 
-A RH-Firewall-1-INPUT -m state --state NEW -m tcp -p tcp --dport 10086 -j ACCEPT
```
å¼€æ”¾ç«¯å£ï¼š
```shell
firewall-cmd --zone=public --add-port=10086/tcp --permanent
```


å¦‚æœæ˜¯çœŸå®çš„ç‰©ç†æœºï¼Œåªè¦åœ¨ä¸€ä¸ªå±€åŸŸç½‘ä¸‹ç¨ä½œé…ç½®ä¾¿å¯ä»¥è®¿é—®ï¼Œæˆ‘è¿™é‡Œä½¿ç”¨çš„è™šæ‹Ÿæœºæ­å»ºçš„ CentOS ç¯å¢ƒï¼Œæ‰€ä»¥éœ€è¦å¦‚ä¸‹é…ç½®ï¼š


![image.png](/img/posts/2022-12-24/2022-12-24-8.png)

è™šæ‹Ÿæœºç¼–è¾‘é‡Œçš„è™šæ‹Ÿç½‘ç»œç¼–è¾‘å™¨ä¸­æ‰“å¼€NATè®¾ç½®ä¸­çš„æ·»åŠ ï¼šï¼ˆè™šæ‹Ÿæœºæ“ä½œç³»ç»Ÿipï¼š192.168.137.128ï¼‰

![image.png](/img/posts/2022-12-24/2022-12-24-9.png)

ç„¶ååœ¨ windows çš„é˜²ç«å¢™é…ç½®é‡Œæ·»åŠ è™šæ‹Ÿæœºçš„IPå³å¯ã€‚

> æ³¨æ„ï¼šä¸€å®šè¦é€‰æ‹© VWnet8 ç½‘ç»œ

windows ä¸‹è®¿é—®ï¼š


![image.png](/img/posts/2022-12-24/2022-12-24-10.png)

ç¬¬ä¸€éƒ¨åˆ†å°±å®Œæˆäº†ã€‚

-----

## 6. ç”¨æˆ·ç®¡ç†ä¸ä»“åº“ç®¡ç†

1. åˆ›å»ºä¸€ä¸ªç”¨æˆ·ï¼šç›´æ¥ä½¿ç”¨ç•Œé¢çš„æ³¨å†Œè¡¨å•å¡«å†™å³å¯ã€‚
2. ä½¿ç”¨è¯¥ç”¨æˆ·åˆ›å»ºä¸€ä¸ªä»“åº“ï¼š

![image.png](/img/posts/2022-12-24/2022-12-24-11.png)

3. æ­¤æ—¶å·²ç»çœ‹åˆ°æç¤ºäº†ï¼Œæˆ‘ä»¬é…ç½®ä¸€ä¸‹ sshkeyï¼Œé…ç½®è¿‡ç¨‹çœç•¥ï¼Œå¤§å®¶éƒ½ä¼šã€‚

![image.png](/img/posts/2022-12-24/2022-12-24-12.png)

4. åœ¨æœ¬åœ°åˆ›å»ºä¸€ä¸ª vue é¡¹ç›®ã€‚

5. å°†è¯¥ä»“åº“æ¨é€è‡³è¿œç«¯ä»“åº“åï¼ŒæŸ¥çœ‹ç•Œé¢ï¼š


![image.png](/img/posts/2022-12-24/2022-12-24-13.png)


ä»‹ç»å°±åˆ°è¿™é‡Œå•¦ï¼æœ‰æ„Ÿå…´è¶£çš„å¯ä»¥å…³æ³¨ä¸‹æœŸ CI/CD çš„é…ç½®ã€‚è°¢è°¢ï¼ï¼6c:T1e29,å‰ç«¯é¡¹ç›®é™¤äº†ç›®å‰çš„çº¯å•é¡µåº”ç”¨ï¼Œè¿˜æœ‰SSRçš„åº”ç”¨ï¼Œä¾‹å¦‚ nuxt å’Œ nextjsï¼Œå…¶åŒºåˆ«åœ¨äºå‰è€…æ˜¯å•ç‹¬çš„å‰ç«¯é¡µé¢éƒ¨ç½²ï¼Œè€Œåè€…ä½¿ç”¨äº†ä¸€ä¸ªå†…éƒ¨çš„ node å°å‹æœåŠ¡å™¨æ¥åšåˆ°æœåŠ¡å™¨é¡µé¢ç›´å‡ºçš„æ•ˆæœã€‚

ä¸‹é¢æˆ‘ä»¬å°±é’ˆå¯¹è¿™ä¸¤ç§å¸¸è§çš„å‰ç«¯é¡¹ç›®ï¼Œè®²è®²ä»–ä»¬ä¸Šçº¿éƒ¨ç½²çš„æµç¨‹ã€‚

## 1. éƒ¨ç½²å•é¡µåº”ç”¨


å•é¡µåº”ç”¨ï¼Œä¸€èˆ¬ä½¿ç”¨ä¸€ç§æˆ–å¤šç§å‰ç«¯æ¡†æ¶ï¼Œåœ¨å‘å¸ƒä¸Šçº¿æ—¶ï¼Œä¸€èˆ¬ä¼šæ‰“åŒ…ï¼ˆwebpack + babelï¼‰ä¸ºæœ€ä¼˜åŒ–çš„é™æ€èµ„æºï¼Œç„¶åä½¿ç”¨å•ç‹¬çš„æœåŠ¡å™¨ï¼ˆnginxï¼‰æ¥æŒ‚è½½è¯¥èµ„æºã€‚

- é¦–å…ˆæˆ‘ä»¬æ¥æ‰“åŒ…èµ„æº

å‡è®¾æˆ‘ä»¬çš„é¡¹ç›®å« opsï¼Œå…¶ä¸­ package.json æ˜¯è¿™ä¹ˆå†™çš„ï¼š

```sh
"build": "react-scripts build",
```

åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸­å†™ä¸€ä¸ªè„šæœ¬ç”¨äºæ‰“åŒ…æ–‡ä»¶ï¼šbuild.shï¼š

```sh
## æ‰“åŒ…çš„è„šæœ¬ï¼ˆåªå±•ç¤ºå¿…è¦æ­¥éª¤ï¼‰
#!/usr/bin/env bash

## æ¥å— ENV
env=$1

## è¿™é‡Œå¯ä»¥åŒºåˆ†å¼€å‘å’Œçº¿ä¸Šçš„ä¸åŒenvé…ç½®æ–‡ä»¶ï¼Œä¸€èˆ¬æ˜¯è¯·æ±‚çš„èµ„æºå’ŒAPIçš„urlä¸åŒ
if [ $env = "pre" ];then
    cp .env_pre .env
elif [ $env = "prod" ];then
    cp .env_prod .env
else
    exit 1
fi

# yarnæ‰“åŒ…
yarn build

# æ‰“åŒ…dockeré•œåƒ
# é»˜è®¤æ¨é€åˆ° hub.xxx.com/ops

time=$(date "+%Y%m%d%H%M%S")
tag="$time"

app_name=ops"_""$env"
default_registry=hub.xxx.com
default_project=ops
default_user=admin
default_pwd=xxxxxxxx
dockerfile=Dockerfile
nginx_conf="./scripts/nginx_""$env"".conf"

echo $(date "+%Y-%m-%d %H:%M:%S")-å¼€å§‹åˆ¶ä½œé•œåƒ
docker build --platform linux/amd64 --rm --build-arg NGINX_CONF=$nginx_conf -t $app_name:latest . 
echo $(date "+%Y-%m-%d %H:%M:%S")-é•œåƒåˆ¶ä½œå®Œæˆ

echo $(date "+%Y-%m-%d %H:%M:%S")-å¼€å§‹æ‰“tag
docker tag $app_name:latest $default_registry/$default_project/$app_name\:$tag
echo $(date "+%Y-%m-%d %H:%M:%S")-æ‰“tagå®Œæˆ

echo $(date "+%Y-%m-%d %H:%M:%S")-å¼€å§‹pushé•œåƒ
docker login -u $default_user -p $default_pwd $default_registry
docker push $default_registry/$default_project/$app_name\:$tag
echo $(date "+%Y-%m-%d %H:%M:%S")-pushé•œåƒå®Œæˆ

echo $(date "+%Y-%m-%d %H:%M:%S")-åˆ é™¤æœ¬åœ°é•œåƒ
docker rmi $app_name\:latest
docker rmi $default_registry/$default_project/$app_name\:$tag

echo "æ‰§è¡Œå‘å¸ƒè„šæœ¬è¯·è¾“å…¥tagï¼š"
echo $tag
```
å…¶ä¸­ docker çš„ç™»å½•ç”¨æˆ·åå¯†ç éœ€è¦è‡ªå·±é…ç½®å³å¯ã€‚ Dockerfileå¦‚ä¸‹ï¼š

```
FROM nginx:1.19.1
ARG NGINX_CONF=""

# æœåŠ¡å™¨ä¸Šèµ„æºçš„åœ°å€
WORKDIR /data/ops

# å¾€ç›®å½•é‡Œæ‹·è´æ‰“åŒ…çš„æ–‡ä»¶å¤¹ buildï¼Œè¿™æ˜¯æœ€å…³é”®çš„ä¸€æ­¥
ADD build build

# è¿™é‡Œåœ¨dockeré‡Œæ‰§è¡Œäº†nginxé…ç½®ï¼Œè¿™é‡Œä¸ä½¿ç”¨é»˜è®¤é…ç½®
COPY ./scripts/run.sh ./
COPY "${NGINX_CONF}" /etc/nginx/conf.d/default.conf

EXPOSE 80
ENTRYPOINT ["sh", "./run.sh"]  
```
ä¸Šè¾¹æ‰§è¡Œçš„ run.sh è„šæœ¬æˆ‘è¿™é‡Œæ˜¯ä»å®¢æˆ·ç«¯æ‹·è´åˆ°äº†æœåŠ¡å™¨ä¸Šï¼Œå½“ç„¶ä¹Ÿå¯ä»¥ç›´æ¥å†™åœ¨æœåŠ¡å™¨ä¸­ï¼Œå…¶ä½œç”¨æ˜¯å¯åŠ¨dockeré•œåƒä¸Šçš„ nginxï¼ˆå®‰è£…ç›®å½• /etc/init.d/nginxï¼Œnginxé…ç½®è¿™é‡Œçœç•¥ï¼‰ã€‚run.sh å¦‚ä¸‹ï¼š

```sh
#!/usr/bin/env bash

#start udnr web...
/etc/init.d/nginx start
```

å…¶ä¸­æœ¬åœ°çš„ nginxé…ç½®æ–‡ä»¶ `nginx_conf="./scripts/nginx_""$env"".conf"` æ˜¯ç”¨äº docker å®¹å™¨å†…éƒ¨çš„ nginxï¼Œè¦†ç›–é»˜è®¤é…ç½®ã€‚è¿™é‡Œæˆ‘é…ç½®äº†æœåŠ¡çš„è¯·æ±‚è·¯å¾„ä»¥åŠå¼€å‘ç¯å¢ƒå’Œç”Ÿäº§ç¯å¢ƒçš„è¯·æ±‚APIåœ°å€çš„åå‘ä»£ç†ï¼Œè¿™é‡Œä¸è¿‡å¤šå±•å¼€ï¼š

```sh
## ./scripts/nginx_prod.conf ä¸ºä¾‹
upstream dashboard {
    server 10.69.164.xxx:21001;
}

...

location / {
    try_files   /index.html =404;
    root        /data/ops/build;
}

location ~ .*.(js|gif|png|map|jpg|css|ico|html|less)$ {
    root            /data/ops/build;
    proxy_redirect  off;
    expires         30d;
    error_page 405  =200 http://$host$request_uri;
}

location /dashboard {
    proxy_pass         http://dashboard/;
    proxy_set_header   Host $Host;
}
```

build.sh è„šæœ¬æ‰§è¡Œå®Œæ¯•åï¼Œä¼šç”Ÿæˆä¸€ä¸ªæŒ‚è½½äº†é¡¹ç›®buildèµ„æºçš„Dockeré•œåƒï¼Œå¹¶è¾“å‡ºäº†å…¶ Tagã€‚

- æ¥ä¸‹æ¥æˆ‘ä»¬æ¥éƒ¨ç½²è¿™ä¸ª docker é•œåƒ

åˆšåˆšçš„æ“ä½œéƒ½æ˜¯åœ¨å®¢æˆ·ç«¯æ“ä½œçš„ï¼ˆå¯ä»¥æ‰‹åŠ¨æ‰§è¡Œè„šæœ¬ï¼Œä¹Ÿå¯ä»¥å†™åœ¨CIé‡Œï¼‰ã€‚ç°åœ¨æˆ‘ä»¬ç™»å½•æœåŠ¡å™¨ï¼š

```sh
ssh root@172.xx.xxx.72

cd /data/ops/
```

å…¶ä¸­ deploy.shï¼š

```sh
#!/bin/bash
if [ ! -n "$1" ]
then
echo "You should give me a image tag."
else
echo "The image tag is $1"

oldtag=`cat .env`

## è·å–ä¸Šä¸€æ¬¡æˆåŠŸçš„tagï¼Œä¾¿äºåœ¨æ‰“åŒ…å¤±è´¥æ—¶åŠæ—¶å›é€€
echo "The old image tag is $oldtag"

path=$(pwd)

# è®°å½•æ–°çš„tagåˆ°å®¹å™¨çš„.envä¸­
sed -i "s/$oldtag/TAG=$1/g" $path/.env

# docker-compose config
docker login -u ops -p ä½ çš„å¯†ç  hub.xxx.com
# é‡æ–°å¯åŠ¨å®¹å™¨ï¼Œå› ä¸º build æ–‡ä»¶å¤¹æ›¿æ¢äº†ï¼Œæ‰€ä»¥æ˜¯æœ€æ–°çš„æ‰“åŒ…ä¿¡æ¯
docker-compose up -d

fi
```

ç°åœ¨åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œï¼š

```sh
sh deploy.sh tagåç§°
```
æ­¤æ—¶åœ¨æœåŠ¡å™¨ä¸Šå°±å¯åŠ¨èµ·æ¥äº†ä¸€ä¸ªå‰ç«¯å•é¡µåº”ç”¨äº†ï¼Œå¯ä»¥é€šè¿‡ip+ç«¯å£å·æ¥è®¿é—®äº†ã€‚


## 2. éƒ¨ç½²SSRåº”ç”¨

SSRå‰ç«¯æ¡†æ¶æˆ‘ä»¬ä»¥ nextjs ä¸ºä¾‹æ¥è®²ä¸€ä¸‹å¦‚ä½•ä¸ docker ç»“åˆéƒ¨ç½²ã€‚

- é¦–å…ˆæ¥éƒ¨ç½²æ‰“åŒ…åº”ç”¨

å‡è®¾é¡¹ç›®çš„ package.jsonæ˜¯è¿™ä¹ˆå†™çš„ï¼š

```json
"scripts": {
    "build": "next build --profile",
    "start": "next start",
}
```
nextjséƒ¨ç½²åˆ°æœåŠ¡å™¨æ—¶ï¼Œéœ€è¦å…ˆ `yarn build`ï¼Œç„¶ååœ¨æ‰“å¥½åŒ…çš„ .next åŒç›®å½•ä¸Šæ‰§è¡Œ `yarn start` ä»¥æ­¤æ¥å¯åŠ¨ä¸€ä¸ªå°å‹çš„SSRç›´å‡ºæœåŠ¡å™¨ã€‚

æ˜ç™½äº†è¿™ä¸ªåï¼Œæˆ‘ä»¬é¦–å…ˆæ¥æ‰“åŒ…ã€‚æ‰“åŒ…çš„æ“ä½œé™¤äº†å†™åœ¨shellé‡Œï¼Œä¹Ÿå¯ä»¥ç›´æ¥å†™åœ¨ Dockerfile é‡Œï¼š

```
# å®‰è£…ä¸€äº›linuxç³»ç»Ÿå¿…é¡»çš„ä¾èµ–å’Œé…ç½®ç¯å¢ƒï¼Œå¹¶ä¸ºä¸‹ä¸€æ­¥buildå®‰è£…node_modules
FROM node:16-alpine AS deps
RUN apk add --no-cache libc6-compat
WORKDIR /app
COPY package.json yarn.lock ./
RUN yarn install --frozen-lockfile

# æ‹·è´æ‰“åŒ…éœ€è¦çš„èµ„æºï¼Œæ‰§è¡Œbuildã€‚é»˜è®¤çš„ï¼Œbuildå®Œåï¼Œå½“å‰ç›®å½•ä¸‹ä¼šæœ‰ä¸€ä¸ª.nextç›®å½•ç”Ÿæˆ
FROM node:alpine AS builder
WORKDIR /app
COPY . .
COPY --from=deps /app/node_modules ./node_modules
RUN yarn build && yarn install --production --ignore-scripts --prefer-offline

# æ·»åŠ ç”¨æˆ·ç»„
FROM node:alpine AS runner
WORKDIR /app

ENV NODE_ENV production
RUN addgroup -g 1001 -S nodejs
RUN adduser -S nextjs -u 1001

# æ‰“åŒ…ä»¥åï¼Œä¸€äº›é…ç½®æ–‡ä»¶åœ¨æ‰“åŒ…çš„ç›®å½•ä¸‹æ²¡æœ‰ï¼Œéœ€è¦æ‰‹åŠ¨copy
COPY --from=builder /app/next.config.js ./                      # nextçš„é…ç½®æ–‡ä»¶
COPY --from=builder /app/next-i18next.config.js ./              # å¦‚æœéœ€è¦next-i18nextæ”¯æŒï¼Œè¿™é‡Œä¹Ÿéœ€è¦æ‹·è´è‡ªå·±åœ¨æ ¹ç›®å½•æ”¾ç½®çš„é…ç½®æ–‡ä»¶

COPY --from=builder --chown=nextjs:nodejs /app/public ./public  # å…¬å…±èµ„æº
COPY --from=builder --chown=nextjs:nodejs /app/.next ./.next    # æ‰“åŒ…åçš„æºä»£ç 
COPY --from=builder /app/node_modules ./node_modules            # å®‰è£…å¥½çš„ä¾èµ–
COPY --from=builder /app/package.json ./package.json            # åŒ…ä¿¡æ¯
```

å¯ä»¥çœ‹åˆ° docker æ˜¯å¾ˆå¼ºå¤§çš„ï¼Œä¸€ä¸ªæ–‡ä»¶å°±æŠŠä¾èµ–å®‰è£…ã€buildå’Œèµ„æºæ‹·è´å®Œæˆäº†ã€‚

- æ¥ä¸‹æ¥æ˜¯å¯åŠ¨æ‰“åŒ…çš„é¡¹ç›®

ç”±äºnextjså†…ç½®çš„nodeæœåŠ¡ï¼Œç›´æ¥å¯ä»¥ `next start` å¯åŠ¨ï¼Œæ•…ä¸éœ€è¦é¢å¤–é…ç½® nginxã€‚å¯ä»¥åœ¨ä¸Šè¾¹çš„Dockerfile é‡Œè¿½åŠ å¯åŠ¨çš„æŒ‡ä»¤ï¼š

```
# ä½¿ç”¨åˆšåˆšæ·»åŠ çš„ç”¨æˆ·
USER nextjs

# æš´éœ²dockerç«¯å£3000
EXPOSE 3000

ENV PORT 3000

# æ‰§è¡Œ yarn start
CMD ["yarn", "start"]
```
åˆ°æ­¤ï¼Œä¸€ä¸ª nextjs åº”ç”¨å°±åœ¨æœåŠ¡å™¨çš„ 3000 ç«¯å£å¯åŠ¨èµ·æ¥äº†ã€‚


----


æµç¨‹æ€»ç»“å¦‚ä¸‹ï¼š

1. ä½¿ç”¨dockeræˆ–è€…shellè¿›è¡Œæ‰“åŒ…ï¼Œè·å–æ‰“åŒ…çš„èµ„æºæ–‡ä»¶ç›®å½•
2. å°†èµ„æºæ–‡ä»¶ã€é…ç½®é¡¹ã€ä¾èµ–ç­‰æ‹·è´åˆ°dockerå®¹å™¨ä¸­è‡ªå®šä¹‰çš„å·¥ä½œç›®å½•ä¸‹
3. åœ¨dockerè¯¥å·¥ä½œç›®å½•ä¸‹æ‰§è¡ŒæŒ‡ä»¤å¯åŠ¨dockerä¸­çš„nginxæˆ–è€…å…¶ä»–çš„æœåŠ¡å™¨

åˆ°è¿™é‡Œï¼Œå‰ç«¯é¡¹ç›®éƒ¨ç½²å°±å®Œæˆäº†ï¼Œæ˜¯ä¸æ˜¯å¾ˆç®€å•ï¼Ÿå¦‚æœæƒ³è¦çœ‹ä¸CI/CDç»“åˆçš„è‡ªåŠ¨åŒ–éƒ¨ç½²æµç¨‹ï¼Œå¯ä»¥çœ‹æˆ‘ä¹‹å‰è®²è¿° gitlab CI çš„æ–‡ç« ã€‚6d:T104a,æœ€è¿‘åœ¨å¼€å‘è‡ªå·±è‡ªå»ºçš„ç±»åº“å’Œç»„ä»¶åº“ï¼Œæ¶‰åŠåˆ°å„ç§åŒ…ç‰ˆæœ¬çš„ç®¡ç†é—®é¢˜ã€‚åœ¨è¿™é‡Œè®°å½•ä¸€ä¸‹æˆ‘æ˜¯æ€ä¹ˆç®¡ç†è‡ªå·±è‡ªå·±å¼€å‘åº“çš„ç‰ˆæœ¬çš„ã€‚


## 1. éœ€è¦è§£å†³çš„é—®é¢˜

1. åŒä¸€å¥—ç±»åº“éœ€è¦å‘å¸ƒä¸åŒçš„å¯å®‰è£…ç‰ˆæœ¬
2. éœ€è¦åŒºåˆ†ç¨³å®šç‰ˆå’Œæµ‹è¯•ç‰ˆ


## 2. å»ºç«‹ä¸€ä¸ªåº“

æˆ‘è¿™ä¸ªåº“æ˜¯ç»™å†…éƒ¨å¾®æœåŠ¡æ§åˆ¶å°æä¾›å…¬å…±ä¾èµ–çš„ï¼Œç”¨äºç»Ÿä¸€ç®¡ç†ä¾èµ–çš„ç‰ˆæœ¬ã€‚ç›®å½•ä¸€ç»“æ„å¦‚ä¸‹ï¼š

![image.png](/img/posts/2022-12-1/2022-12-1-1.png)

å®ç°åŠŸèƒ½å¾ˆç®€å•ï¼Œé€šè¿‡åœ¨é¡¹ç›®ä¸­å®‰è£…è¿™ä¸ªåº“ï¼Œå¯ä»¥è·å¾—ä¸€å¥—å®Œæ•´çš„ä¾èµ–åŒ…å’Œwebpacké…ç½®æ–‡ä»¶ï¼Œè¾…åŠ©ä»¥ cli å‘½ä»¤è¡Œå·¥å…·åŠ æŒï¼Œå°±å¯ä»¥èµ·åˆ°åŒæ—¶ç®¡ç† å…¬å…±ä¾èµ–å’Œwebpackå…¬å…±é…ç½®çš„æ•ˆæœã€‚

æ¥ä¸‹æ¥çœ‹çœ‹åœ¨å­åº”ç”¨ä¸­çš„ä½¿ç”¨ï¼š


![image.png](/img/posts/2022-12-1/2022-12-1-2.png)

æ¥ç€åªéœ€ yarn ä¸€ä¸‹å°±å¯ä»¥å®‰è£…ä¸Šä¾èµ–äº†ã€‚ç”±äºæœ¬æœŸè®²çš„æ˜¯è¿™ä¸ªåŒ…å¦‚ä½•å‘å¸ƒä¸åŒçš„ç‰ˆæœ¬ï¼Œæ•…ä¸Šè¿°é…ç½®ä¸åšè¯¦ç»†è¯´æ˜ï¼Œå¦‚æœæœ‰å¯¹ å‰ç«¯å‘½ä»¤è¡Œå·¥å…·ï¼ˆcliï¼‰æ„Ÿå…´è¶£çš„ï¼Œå¯ä»¥æœŸå¾…æˆ‘åæœŸçš„æ–‡ç« ã€‚

## 3. æ‰“ä¸€ä¸ªç‰ˆæœ¬

æ‰§è¡Œå¦‚ä¸‹æŒ‡ä»¤ï¼š

```shell
# å¯é€‰ (minor / major)
npm version patch
```
è¿™ä¸ªæƒ³å¿…å¤§å®¶éƒ½çŸ¥é“ï¼Œnpm åŒ…çš„ç‰ˆæœ¬æ˜¯ä¸‰æ®µå¼çš„ï¼Œä¸­é—´ä»¥ . éš”å¼€ï¼Œä»å·¦å¾€å³åˆ†åˆ«æ˜¯ major(ä¸»ç‰ˆæœ¬)ã€minorï¼ˆå°ç‰ˆæœ¬ï¼‰ã€patchï¼ˆè¡¥ä¸åŒ…ï¼‰ã€‚

æ‰§è¡Œå®ŒæŒ‡ä»¤åå¯ä»¥çœ‹åˆ°ç‰ˆæœ¬å·çš„ç¬¬ä¸‰æ®µè‡ªå¢äº†ï¼š


![image.png](/img/posts/2022-12-1/2022-12-1-3.png)

æ¥ä¸‹æ¥å‘å¸ƒnpmï¼Œè¿™é‡Œéœ€è¦æå‰ç™»å½•npmï¼Œå¤§å®¶éƒ½ä¼šï¼Œä¸åšè¿‡å¤šè®¨è®ºï¼Œç½‘ä¸Šå¾ˆå¤šè¯´æ˜äº†ï¼š

```shell
npm publish
```

å‘å¸ƒå®Œä»¥åï¼Œä½ æ‰€é…ç½®çš„npmä»“åº“é‡Œå°±æœ‰äº†ä½ è¿™ä¸ªé¡¹ç›®çš„ç‰ˆæœ¬äº†ã€‚

æ¥ä¸‹æ¥åœ¨å…¶ä»–é¡¹ç›®æ ¹ç›®å½•é‡Œï¼š

```shell
yarn add -D @xxx/xxx-console-dev-libs
```
å¦‚æ­¤ä¾¿å®‰è£…äº†ä¸€ä¸ªæ­£å¼å‘å¸ƒçš„ç‰ˆæœ¬äº†ã€‚

## 4. æ­£å¼ç‰ˆä¸æµ‹è¯•ç‰ˆ

### æ­£å¼ç‰ˆ

æˆ‘ä»¬åœ¨ä¸€ä¸ªæ–°åˆ›å»ºçš„çº¯å‡€é¡¹ç›®é‡Œæ‰§è¡Œå¦‚ä¸‹æŒ‡ä»¤æŸ¥çœ‹å½“å‰é¡¹ç›®å…¨éƒ¨npmç‰ˆæœ¬ï¼š

```shell
npm dist-tag ls
```
å¯ä»¥çœ‹åˆ°å¦‚ä¸‹æ˜¾ç¤ºï¼š

![image.png](/img/posts/2022-12-1/2022-12-1-4.png)

latestç‰ˆæœ¬å°±æ˜¯æˆ‘ä»¬åœ¨ä¸Šè¾¹å‘å¸ƒçš„é‚£ç§æ­£å¼ç‰ˆï¼Œé»˜è®¤å®‰è£…æ—¶ä¸éœ€è¦å¸¦ç€ç‰ˆæœ¬å·ï¼Œé»˜è®¤ä¼šå»æ‹¿ latestã€‚é‚£å¦‚æœéœ€è¦å®‰è£…å¾€æœŸçš„æ­£å¼ç‰ˆæœ¬ï¼Œå¯ä»¥å¦‚ä¸‹ï¼š

```shell
yarn add @xxx/xxx-console-dev-libs@1.0.8
```

### æµ‹è¯•ç‰ˆ

npm ä¼šæœ‰å†…ç½®çš„ä»£è¡¨ç‰ˆæœ¬æµ‹è¯•çš„åç§°ç¬¦å·ã€‚ä¸€ä¸ªè½¯ä»¶åœ¨æ­£å¼å‘å¸ƒå‰ï¼Œéƒ½ä¼šæœ‰ `alpha`, `beta` ç‰ˆï¼Œåˆ†åˆ«ä»£è¡¨å†…æµ‹ç‰ˆå’Œå…¬æµ‹ç‰ˆï¼ŒnpmåŒ…ä¹Ÿæ˜¯è½¯ä»¶ï¼Œä¹Ÿä¸ä¾‹å¤–ã€‚

å¦‚æœç±»åº“å¼€å‘åˆ°æŸä¸€ä¸ªç¨‹åº¦ï¼Œæƒ³è®©å†…éƒ¨çš„äººè¯•ä¸€ä¸‹ï¼Œåˆä¸æƒ³å½±å“è‡ªåŠ¨åŒ–éƒ¨ç½²ä¸­å®‰è£…çš„ç‰ˆæœ¬çš„è¯ï¼Œå¯ä»¥è¿™æ ·ï¼š

```shell
npm version 1.0.13-alpha.0

npm publish --tag alpha
```

æ­¤æ—¶ package.json ä¸­çš„ç‰ˆæœ¬ä¼šå˜æˆï¼š

![image.png](/img/posts/2022-12-1/2022-12-1-5.png)

è¿™ä¾¿æ˜¯ä¸€ä¸ªå†…æµ‹ç‰ˆäº†ï¼Œå†…æµ‹ç”¨æˆ·æ‰§è¡Œå¦‚ä¸‹æŒ‡ä»¤ä¾¿å¯ä»¥å®‰è£… alpha çš„æœ€æ–°æµ‹è¯•ç‰ˆï¼š

```shell
yarn add @xxx/xxx-console-dev-libs@alpha
```

å†…æµ‹ç‰ˆä¹Ÿå¯ä»¥æ›´æ–°ï¼š

```shell
npm version prerelease --preid alpha

npm publish --tag alpha
```

å¯ä»¥çœ‹åˆ°ç‰ˆæœ¬ä¹Ÿæ˜¯é€’å¢çš„ï¼š

![image.png](/img/posts/2022-12-1/2022-12-1-6.png)

åŒç†ï¼Œå…¬æµ‹ç‰ˆä¹Ÿä¸€æ ·ï¼š

```shell
// æ‰“ç‰ˆæœ¬
npm version 1.0.13-beta.0 
// æ‰“tag
npm publish --tag beta
// æ›´æ–°ç‰ˆæœ¬
npm version prerelease --preid beta
```

> ä¸Šé¢æ‰“ tag æ˜¯ä¸ºäº† npm dist-tag èƒ½å¤ŸæŸ¥åˆ°å¯¹åº”çš„ç‰ˆæœ¬ï¼Œä»¥æ­¤æ¥åŒºåˆ†å®‰è£…ã€‚å‚æ•° preid è¡¨ç¤ºé¢„å‘çš„æ˜¯alpha/bataçš„æµ‹è¯•ç‰ˆ

æœ€ååˆ«å¿˜äº† git æ¨é€çš„æ—¶å€™æ‰“ä¸Š tagï¼Œè¿™æ ·ä¾¿äºç®¡ç†ï¼š

```shell
git push --tags
```

çœ‹ä¸€ä¸‹æˆ‘å®é™…å¼€å‘çš„ä»“åº“é‡Œçš„ç‰ˆæœ¬(npm dist-tag ls)ï¼š

![image.png](/img/posts/2022-12-1/2022-12-1-7.png)

> æµ‹è¯•ç‰ˆè¿˜å¯ä»¥ npm version prepatch æ¥å‘å¸ƒï¼ŒåŸç†ä¸€æ ·ï¼š1.0.1 --> 1.0.1-0


æœ€åä¸€ä¸ªé—®é¢˜ï¼Œä¸€ä¸ªæµ‹è¯•ç‰ˆå¦‚æœæƒ³è¦è½¬æ­£ï¼Œå¯ä»¥æ‰§è¡Œå¦‚ä¸‹æŒ‡ä»¤ï¼š

```shell
npm version minor
```
> è‹¥ä½ ä¹‹å‰æ˜¯åœ¨ 12 ç‰ˆæœ¬ç›´æ¥å‡ä¸Šçš„ 13.beta, è¿™é‡Œå¯ä»¥ patch å°±è¡Œ

ä¹‹å‰ï¼š

![image.png](/img/posts/2022-12-1/2022-12-1-8.png)

ä¹‹åï¼š

![image.png](/img/posts/2022-12-1/2022-12-1-9.png)

-----

å®Œ ï¼6e:T519e,React Router v6ç‰ˆæœ¬ï¼Œå¬è¯´åˆæ›´æ–°äº†ä¸€ç‰ˆï¼Œå®˜ç½‘æ–‡æ¡£ä¹Ÿæ›´æ–°äº†ï¼ˆ6.4.2ï¼‰ã€‚è¿™é‡Œå°±æ±‡æ€»ç¿»è¯‘ä¸€ä¸‹æ–‡æ¡£æ›´æ–°çš„å†…å®¹ã€‚

äº†è§£å…¶ä»– React Router v6 çš„å®˜ç½‘æ–‡æ¡£ï¼Œå¯ä»¥çœ‹æˆ‘æœ¬ä¸“æ å¾€æœŸçš„æ–‡ç« ã€‚

## 1. å…³äº Routers

APIåˆ›å»ºrouterå¯¹è±¡ï¼š

### createBrowserRouter

ç±»å‹å®šä¹‰ï¼š

```js
function createBrowserRouter(
  routes: RouteObject[],
  opts?: {
    basename?: string;
    window?: Window;
  }
): RemixRouter;
```

è¿™ä¸ª API ç”¨äºä½¿ç”¨jsä»£ç åˆ›å»ºä¸€ä¸ª History routerã€‚ç¬¬äºŒä¸ªå±æ€§æ˜¯å¯é€‰å‚æ•°ï¼š

- basenameï¼šç›¸å¯¹è·¯ç”±æ ¹åœ°å€
- windowï¼šé‡æ–°æŒ‡å®šwindowå¯¹è±¡ï¼Œå¸¸ç”¨äºæµ‹è¯•ç¯å¢ƒæˆ–è€…éæµè§ˆå™¨ç¯å¢ƒ

ä½¿ç”¨æ–¹å¼å¦‚ä¸‹ï¼š


```js
import {
  createBrowserRouter,
  RouterProvider,
} from "react-router-dom";

const router = createBrowserRouter([
  {
    path: "/",
    element: <Root />,
    loader: rootLoader,
    children: [
      {
        path: "team",
        element: <Team />,
        loader: teamLoader,
      },
    ],
  },
]);

ReactDOM.createRoot(document.getElementById("root")).render(
  <RouterProvider router={router} />
);
```

### createHashRouter

ä½¿ç”¨æ–¹å¼åŒ createBrowserRouterï¼Œåˆ›å»ºä¸€ä¸ªåŸºäºé”šç‚¹å¯¼èˆªçš„ routerã€‚

### createMemoryRouter

memory routeræ˜¯ä¸€ä¸ªèƒ½å¤Ÿè‡ªå·±ç®¡ç† history stack çš„ History routerã€‚å¸¸ç”¨äºå¼€å‘å·¥å…·ï¼ˆä¾‹å¦‚StoryBookï¼‰. æµ‹è¯•æˆ–éæµè§ˆå™¨ç¯å¢ƒã€‚

ç±»å‹å®šä¹‰ï¼š

```js
function createMemoryRouter(
  routes: RouteObject[],
  opts?: {
    basename?: string;
    initialEntries?: InitialEntry[];
    initialIndex?: number;
    window?: Window;
  }
): RemixRouter;
```

ä½¿ç”¨æ–¹å¼ï¼š

```js
import {
  RouterProvider,
  createMemoryRouter,
} from "react-router-dom";
import * as React from "react";
import {
  render,
  waitFor,
  screen,
} from "@testing-library/react";
import "@testing-library/jest-dom";
import CalendarEvent from "./routes/event";

test("event route", async () => {
  const FAKE_EVENT = { name: "test event" };
  const routes = [
    {
      path: "/events/:id",
      element: <CalendarEvent />,
      loader: () => FAKE_EVENT,
    },
  ];

  const router = createMemoryRouter(routes, {
    initialEntries: ["/", "/events/123"],
    initialIndex: 1,
  });

  render(<RouterProvider router={router} />);

  await waitFor(() => screen.getByRole("heading"));
  expect(screen.getByRole("heading")).toHaveTextContent(
    FAKE_EVENT.name
  );
});
```

å…¶ä¸­çš„å‚æ•°ï¼š

- initialEntriesï¼šåˆå§‹åŒ–çš„ history stack
- initialIndexï¼šåˆå§‹åŒ–æ˜¾ç¤ºçš„ history stack çš„ä¸‹æ ‡


### RouterProvider

ç»™ä¸Šè¿°åˆ›å»ºrouterçš„APIæä¾›ä¸€ä¸ªå®¹å™¨ã€‚å…¶æœ‰ç¬¬äºŒä¸ªå‚æ•° `fallbackElement={<SpinnerOfDoom />}`ï¼Œå¯ä»¥æä¾›ä¸€ä¸ªåœ¨è·¯ç”±åŠ è½½è¿‡ç¨‹ä¸­ loadingçš„è‡ªå®šä¹‰ç»„ä»¶ã€‚

## 2. å…³äº Route ç»„ä»¶

### æ·»åŠ æ–°å±æ€§ loader

è·¯ç”±åœ¨æ¸²æŸ“ä¹‹å‰åŠ è½½çš„åŠ è½½å™¨ã€‚å½“è·¯ç”±è·³è½¬æ—¶ï¼Œloaderå‡½æ•°ä¼šå¼‚æ­¥çš„æ‰§è¡Œï¼Œå¹¶ä¸”åœ¨ç›®æ ‡è·¯ç”±ç»„ä»¶ä¸­å¯ä»¥è·å–åˆ°ã€‚

ä½¿ç”¨æ–¹å¼ï¼š
```js
 {
    element: <Team />,
    path: ":teamId",
    loader: async ({ params }) => {
      return fetch(`/api/teams/${params.teamId}.json`);
    },
  },
```

å‚æ•° params æ˜¯è·¯ç”±å‚æ•°ã€‚å¯ä»¥è¿”å›ä»»ä½•ä½ æƒ³è¦çš„å†…å®¹ï¼Œæ¨èä½¿ç”¨ fetch æˆ–è€… Promiseã€‚

loader åŠ è½½çš„æ•°æ®å¯ä»¥åœ¨è·³è½¬ä¹‹åçš„ç•Œé¢ é€šè¿‡ useLoaderData è·å–ã€‚ä½¿ç”¨æ–¹å¼è§ä¸‹é¢ hooks çš„æ›´æ–°å†…å®¹ã€‚

### æ·»åŠ æ–°å±æ€§ action

æä¾›ä¸€ç§è·¯ç”±åˆ‡æ¢æ—¶è§¦å‘çš„æ–¹æ³•ã€‚è¯¥æ–¹å¼å…è®¸åœ¨è·¯ç”±è·³è½¬æ—¶æ¨é€ä¸€ä¸ª ajax è¯·æ±‚å‡ºå»ã€‚

ä½¿ç”¨æ–¹å¼ï¼š

```js
// å®šä¹‰
<Route
  path="/song/:songId/edit"
  element={<EditSong />}
  action={async ({ params, request }) => {
    let formData = await request.formData();
    return fakeUpdateSong(params.songId, formData);
  }}
  loader={({ params }) => {
    return fakeGetSong(params.songId);
  }}
/>

// forms
<Form method="post" action="/songs" />;
<fetcher.Form method="put" action="/songs/123/edit" />;

// imperative submissions
let submit = useSubmit();
submit(data, {
  method: "delete",
  action: "/songs/123",
});
fetcher.submit(data, {
  method: "patch",
  action: "/songs/123/edit",
});

```

è§¦å‘æ–¹å¼ä¸ºéGETç±»çš„è¯·æ±‚ï¼Œå¹¶æä¾›ä¸¤ä¸ªå‚æ•°ï¼š

- params è·¯ç”±åŠ¨æ€å‚æ•°
- request fetchè¯·æ±‚çš„å®ä¾‹

### errorElement

åªé€‚ç”¨äºAPIåŠ¨æ€åˆ›å»ºçš„routerã€‚ä½¿ç”¨æ–¹å¼ï¼š
```jsx
<Route
  path="/invoices/:id"
  // if an exception is thrown here
  loader={loadInvoice}
  // here
  action={updateInvoice}
  // or here
  element={<Invoice />}
  // this will render instead of `element`
  errorElement={<ErrorBoundary />}
/>;

function Invoice() {
  return <div>Happy {path}</div>;
}

function ErrorBoundary() {
  let error = useRouteError();
  console.error(error);
  // Uncaught ReferenceError: path is not defined
  return <div>Dang!</div>;
}
```
æä¾›ä¸€ç§è·¯ç”±è·³è½¬é”™è¯¯åçš„è¡¥æ•‘æ–¹æ¡ˆã€‚åœ¨action. loaderæˆ–è€…ç»„ä»¶æ¸²æŸ“è¿‡ç¨‹ä¸­æŠ›å‡ºé”™è¯¯åï¼Œå¯ä»¥åœ¨è¿™é‡Œæ•è·å¹¶ä»£æ›¿æ˜¾ç¤ºè‡ªå®šä¹‰çš„é”™è¯¯ç•Œé¢ã€‚

### shouldRevalidate

ä½œä¸ºä¸€ä¸ªä¼˜åŒ–é¡¹ï¼Œç”¨äºå¯¹loaderåšæ ¡éªŒã€‚ä»–æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œåœ¨è·¯ç”± loader è·å–æ•°æ®ä¹‹å‰è°ƒç”¨ï¼Œè¯¥å‡½æ•°è¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œå¦‚æœè¿”å›å¸ƒå°”å€¼ï¼Œæœ¬æ¬¡ loader å‡½æ•°å°†ä¸ä¼šè°ƒç”¨ï¼Œç•Œé¢æ•°æ®ä¸ä¼šæ”¹å˜ã€‚

ä½¿ç”¨æ–¹å¼ï¼š
```jsx
<Route
  path="meals-plans"
  element={<MealPlans />}
  loader={loadMealPlans}
  shouldRevalidate={({ currentUrl }) => {
    // only revalidate if the submission originates from
    // the `/meal-plans/new` route.
    return currentUrl.pathname === "/meal-plans/new";
  }}
>
  <Route
    path="new"
    element={<NewMealPlanForm />}
    // `loadMealPlans` will be revalidated after
    // this action...
    action={createMealPlan}
  />
  <Route
    path=":planId/meal"
    element={<Meal />}
    // ...but not this one because origin the URL
    // is not "/meal-plans/new"
    action={updateMeal}
  />
</Route>
```

## 3. å…³äºè·¯ç”±ç»„ä»¶

### Await

æ˜¯ä¸€ç§ç±»ä¼¼äº React è·¯ç”±æ‡’åŠ è½½ï¼ˆlazyï¼‰çš„å·¥å…·ã€‚ä½¿ç”¨æ–¹å¼å¦‚ä¸‹ï¼š

```jsx
import { Await, useLoaderData } from "react-router-dom";

function Book() {
  const { book, reviews } = useLoaderData();
  return (
    <div>
      <h1>{book.title}</h1>
      <p>{book.description}</p>
      <React.Suspense fallback={<ReviewsSkeleton />}>
        <Await
          resolve={reviews}
          errorElement={
            <div>Could not load reviews ğŸ˜¬</div>
          }
          children={(resolvedReviews) => (
            <Reviews items={resolvedReviews} />
          )}
        />
      </React.Suspense>
    </div>
  );
}
```

### Form

v6ç‰ˆè·¯ç”±ï¼Œå¯¹äº plain HTMLÂ form è¿›è¡Œäº†ä¸€ä¸ªåŒ…è£…ã€‚ç›®å‰ä»…ä»…åœ¨ä½¿ç”¨ API åˆ›å»ºè·¯ç”±å®ä¾‹çš„åœºæ™¯ä¸­ä½¿ç”¨ã€‚

```jsx
import { Form } from "react-router-dom";

function NewEvent() {
  return (
    <Form method="post" action="/events">
      <input type="text" name="title" />
      <input type="text" name="description" />
      <button type="submit">Create</button>
    </Form>
  );
}
```

å±æ€§å‚æ•°ä»‹ç»ï¼š

- actionï¼šform submit çš„ urlã€‚å’ŒåŸç”Ÿformå”¯ä¸€ä¸åŒçš„æ˜¯ï¼Œä»–çš„é»˜è®¤urlæ˜¯æœ€è¿‘åŒ¹é…åˆ°çš„ç›¸å¯¹è·¯ç”±
- methodï¼šè¡¨å•æäº¤çš„æ–¹æ³•
- replaceï¼šæ”¹å˜ history stack çš„åˆ‡æ¢æ–¹å¼
- relativeï¼šè®¾ç½®ç›¸å¯¹è·¯ç”±çš„æ ¹è·¯ç”±
- reloadDocumentï¼šè·³è¿‡ React Router å¹¶ä½¿ç”¨æµè§ˆå™¨çš„å†…ç½®è¡Œä¸ºæäº¤è¡¨å•

ç»¼åˆä½¿ç”¨æ¡ˆä¾‹ï¼š

> **æ€»ç»“**ï¼šaction å¯ä»¥æ¥å— element ç»„ä»¶ä¸­ä¼ å…¥çš„è¯·æ±‚å®ä¾‹ï¼Œåœ¨actionä¸­è¿›è¡Œä½¿ç”¨ã€‚è€Œç´§æ¥ç€ï¼Œelement ç»„ä»¶ä¸­ï¼Œåˆå¯ä»¥é€šè¿‡ useLoaderData ä½¿ç”¨ loader é‡ŒåŠ è½½è¿›æ¥çš„æ•°æ®ã€‚

```jsx
<Route
  path="/projects/:id"
  element={<Project />}
  loader={async ({ params }) => {
    return fakeLoadProject(params.id)
  }}
  action={async ({ request, params }) => {
    switch (request.method) {
      case "put": {
        let formData = await request.formData();
        let name = formData.get("projectName");
        return fakeUpdateProject(name);
      }
      case "delete": {
        return fakeDeleteProject(params.id);
      }
      default {
        throw new Response("", { status: 405 })
      }
    }
  }}
/>;

function Project() {
  let project = useLoaderData();

  return (
    <>
      <Form method="put">
        <input
          type="text"
          name="projectName"
          defaultValue={project.name}
        />
        <button type="submit">Update Project</button>
      </Form>

      <Form method="delete">
        <button type="submit">Delete Project</button>
      </Form>
    </>
  );
}
```

### ScrollRestoration

ç”¨äºåœ¨æµè§ˆå™¨ locationå˜åŒ–åï¼Œä¿æŒæ»šåŠ¨æ¡çš„ä½ç½®ã€‚ä»…ä»…åœ¨ API åˆ›å»ºè·¯ç”±å¯¹è±¡æ—¶æœ‰æ•ˆã€‚

æ¨èåœ¨æ ¹è·¯ç”±ä¸­ä½¿ç”¨ï¼Œä½¿ç”¨æ–¹å¼ï¼š

```jsx
import { ScrollRestoration } from "react-router-dom";

function RootRouteComponent() {
  return (
    <div>
      {/* ... */}
      <ScrollRestoration
        getKey={(location, matches) => {
          // default behavior
          return location.key;
        }}
      />
    </div>
  );
}
```

å‚æ•°ï¼š

- getKeyï¼šReact Router ç¼“å­˜æ»šåŠ¨ä½ç½®çš„key
- preventScrollResetï¼šå½“åˆ›å»ºä¸€ä¸ªæ–°çš„ scroll keyæ—¶ï¼Œé¡µé¢æ»šåŠ¨ä½ç½®ä¼šè¢«é‡ç½®åœ¨é¡¶éƒ¨ã€‚ä½ å¯ä»¥å°†è¯¥å‚æ•°è®¾ç½®ä¸º true æ¥é˜»æ­¢é¡µé¢è¢«é‡ç½®å›é¡¶éƒ¨

<hr />


## 4. Hooks

### useActionData

æä¾›ä¸Šä¸€ä¸ªè·³è½¬æ—¶ action çš„è¿”å›å€¼ã€‚å¦‚æœæ²¡æœ‰è¿”å›å€¼ï¼Œåˆ™æ˜¯ undefinedã€‚

ä½¿ç”¨æ–¹å¼ï¼ˆæœ€å¸¸ç”¨çš„å°±æ˜¯è¡¨å•éªŒè¯ï¼‰ï¼š

```jsx
import {
  useActionData,
  Form,
  redirect,
} from "react-router-dom";

export default function SignUp() {
  // 2. è·å– action è¿”å›å€¼
  const errors = useActionData();

  return (
    <Form method="post">
      <p>
        <input type="text" name="email" />
        {errors?.email && <span>{errors.email}</span>}
      </p>

      <p>
        <input type="text" name="password" />
        {errors?.password && <span>{errors.password}</span>}
      </p>

      <p>
        <button type="submit">Sign up</button>
      </p>
    </Form>
  );
}

export async function action({ request }) {
  const formData = await request.formData();
  const email = formData.get("email");
  const password = formData.get("password");
  const errors = {};

  // validate the fields
  if (typeof email !== "string" || !email.includes("@")) {
    errors.email =
      "That doesn't look like an email address";
  }

  if (typeof password !== "string" || password.length < 6) {
    errors.password = "Password must be > 6 characters";
  }

  // return data if we have errors
  if (Object.keys(errors).length) {
    // 1. action ä¸­ return ä¸€ä¸ªå¯¹è±¡ï¼Œè€Œä¸æ˜¯ redirect
    return errors;
  }

  // otherwise create the user and redirect
  await createUser(email, password);
  return redirect("/dashboard");
}
```

### useAsyncError

è¿”å› Await ç»„ä»¶ çš„rejectçš„å€¼ï¼š

```jsx
import { useAsyncError, Await } from "react-router-dom";

function ErrorElement() {
  const error = useAsyncError();
  return (
    <p>Uh Oh, something went wrong! {error.message}</p>
  );
}

<Await
  resolve={promiseThatRejects}
  errorElement={<ErrorElement />}
/>;
```

### useAsyncValue

è¿”å› Await ç»„ä»¶çš„ resolve å€¼ï¼š

```jsx
function ProductVariants() {
  const variants = useAsyncValue();
  return <div>{/* ... */}</div>;
}

// Await creates the context for the value
<Await resolve={somePromiseForProductVariants}>
  <ProductVariants />
</Await>;
```

### useFetcher

> useFetcherä»…ä»…åœ¨ä½¿ç”¨ API åˆ›å»ºrouterå®ä¾‹ä¸­æœ‰æ•ˆã€‚


å½“ä½ éœ€è¦ï¼š

- è·å–ä¸ UI è·¯ç”±æ— å…³çš„æ•°æ®ï¼ˆå¼¹å‡ºæ¡†. åŠ¨æ€è¡¨å•ç­‰ï¼‰
- æ— éœ€å¯¼èˆªå³å¯å°†æ•°æ®æäº¤çš„æ“ä½œï¼ˆå…±äº«ç»„ä»¶ï¼Œå¦‚å®æ—¶é€šè®¯æ³¨å†Œï¼‰
- å¤„ç†åˆ—è¡¨ä¸­çš„å¤šä¸ªå¹¶å‘æäº¤ï¼ˆå…¸å‹çš„â€œå¾…åŠäº‹é¡¹åº”ç”¨ç¨‹åºâ€åˆ—è¡¨ï¼Œæ‚¨å¯ä»¥åœ¨å…¶ä¸­å•å‡»å¤šä¸ªæŒ‰é’®ï¼Œå¹¶ä¸”æ‰€æœ‰æŒ‰é’®éƒ½åº”åŒæ—¶å¤„äºå¾…å¤„ç†çŠ¶æ€ï¼‰
- æ— é™æ»šåŠ¨å®¹å™¨

ç­‰ç­‰ï¼ŒuseFetcher å¯ä»¥å¸®åŠ©åˆ°ä½ ï¼š

```jsx
import { useFetcher } from "react-router-dom";

function SomeComponent() {
  const fetcher = useFetcher();

  // æäº¤åŠ¨ä½œ
  React.useEffect(() => {
    fetcher.submit(data, options);
    fetcher.load(href);
  }, [fetcher]);

  // å¯ä»¥ç›´æ¥è·å–æ•°æ®
  fetcher.state;
  fetcher.formData;
  fetcher.formMethod;
  fetcher.formAction;
  fetcher.data;

  // ä¸ä¼šè§¦å‘è·¯ç”±å¯¼èˆªçš„è¡¨å•
  return <fetcher.Form />;
}
```


fetchers æœ‰å¾ˆå¤šå†…ç½®çš„è¡Œä¸ºï¼š

- ä¸­æ–­æ—¶ï¼Œè‡ªåŠ¨å¤„ç†fetchå–æ¶ˆ
- ä½¿ç”¨ POST. PUT. PATCH. DELETE æäº¤æ—¶ï¼Œé¦–å…ˆè°ƒç”¨è¯¥æ“ä½œï¼š
    - æ“ä½œå®Œæˆåï¼Œé¡µé¢ä¸Šçš„æ•°æ®å°†é‡æ–°éªŒè¯ä»¥æ•è·å¯èƒ½å‘ç”Ÿçš„ä»»ä½•çªå˜ï¼Œè‡ªåŠ¨ä½¿æ‚¨çš„ UI ä¸æ‚¨çš„æœåŠ¡å™¨çŠ¶æ€ä¿æŒåŒæ­¥
- å½“å¤šä¸ª fetcher åŒæ—¶è¿è¡Œæ—¶ï¼Œå®ƒä¼šï¼š
    - åœ¨ä»–ä»¬æ¯æ¬¡ç™»é™†æ—¶æäº¤æœ€æ–°çš„å¯ç”¨æ•°æ®
    - ç¡®ä¿æ²¡æœ‰é™ˆæ—§çš„è´Ÿè½½è¦†ç›–æ›´æ–°çš„æ•°æ®ï¼Œæ— è®ºå“åº”è¿”å›çš„é¡ºåºå¦‚ä½•
- é€šè¿‡å‘ˆç°æœ€è¿‘çš„ errorElement æ¥å¤„ç†æœªæ•è·çš„é”™è¯¯ï¼ˆå°±åƒæ¥è‡ª \<Link> æˆ– \<Form> çš„æ­£å¸¸å¯¼èˆªï¼‰
- å¦‚æœæ‚¨çš„æ“ä½œ/åŠ è½½ç¨‹åºè¢«è°ƒç”¨è¿”å›é‡å®šå‘ï¼Œå°†é‡å®šå‘åº”ç”¨ç¨‹åºï¼ˆå°±åƒæ¥è‡ª \<Link> æˆ– \<Form> çš„æ­£å¸¸å¯¼èˆªä¸€æ ·ï¼‰



å…¶ä¸­å„ä¸ªå±æ€§çš„è®²è§£ï¼š

- `fetcher.state`: æäº¤çš„çŠ¶æ€ï¼Œæšä¸¾å¦‚ä¸‹ï¼š
    -   **idle**Â - nothing is being fetched.
    -   **submitting**Â - A route action is being called due to a fetcher submission using POST, PUT, PATCH, or DELETE
    -   **loading**Â - The fetcher is calling a loader (from aÂ `fetcher.load`) or is being revalidated after a separate submission orÂ `useRevalidator`Â call
- `fetcher.Form`: ä¸ä¼šå¯¼èˆªçš„è¡¨å•
- `fetcher.load`: é€šè¿‡ router loader åŠ è½½æ•°æ®ï¼š 
```js
if (fetcher.state === "idle" && !fetcher.data) {
    fetcher.load("/some/route");
}
```
- `fetcher.submit`: æ¨¡æ‹Ÿfetcher.Form çš„æäº¤åŠ¨ä½œã€‚æ¯”å¦‚ä¸€ä¸ªç”¨æˆ·ç™»å‡ºçš„æ“ä½œï¼š

```jsx
import { useFetcher } from "react-router-dom";
import { useFakeUserIsIdle } from "./fake/hooks";

export function useIdleLogout() {
  const fetcher = useFetcher();
  const userIsIdle = useFakeUserIsIdle();

  useEffect(() => {
    if (userIsIdle) {
      fetcher.submit(
        { idle: true },
        { method: "post", action: "/logout" }
      );
    }
  }, [userIsIdle]);
}
```

- `fetcher.data`: loader æˆ–è€… action è¿”å›çš„æ•°æ®ä¼šå­˜å‚¨åœ¨è¿™é‡Œ
- `fetcher.formData`: å½“ä½¿ç”¨`<fetcher.Form>`Â orÂ `fetcher.submit()`æ—¶ï¼ŒformData å¯ä»¥ç”¨æ¥è·å–æäº¤æ•°æ®ï¼š

```jsx
function TaskCheckbox({ task }) {
  let fetcher = useFetcher();

  // é€šè¿‡ get æ–¹æ³•å¯ä»¥è·å–åˆ°formDataå†…çš„å€¼ï¼Œåå‘å½±å“æäº¤è¡¨å•çš„æ¸²æŸ“
  let status =
    fetcher.formData?.get("status") || task.status;

  let isComplete = status === "complete";

  return (
    <fetcher.Form method="post">
      <button
        type="submit"
        name="status"
        value={isComplete ? "incomplete" : "complete"}
      >
        {isComplete ? "Mark Incomplete" : "Mark Complete"}
      </button>
    </fetcher.Form>
  );
}
```

- `fetcher.formAction`: è·å–å½“å‰æäº¤çš„ action çš„ url
- `fetcher.formMethod`: è·å–å½“å‰æäº¤çš„ action çš„ method


### useFetchers

è¿”å›æ‰€æœ‰fetcherçš„æ•°ç»„ï¼Œä½†ä¸æºå¸¦Â `load`,Â `submit`, Â `Form`Â ä¿¡æ¯ã€‚

### useFormAction

ç±»å‹å®šä¹‰ï¼š
```tsx
declare function useFormAction(
  action?: string,
  { relative }: { relative?: RelativeRoutingType } = {}
): string;
```

å¯¹action çš„urlåŒ…è£…äº†ä¸€å±‚ï¼Œä¼šè‡ªåŠ¨è§£æç›¸å¯¹è·¯å¾„ã€‚è¯¥ä½¿ç”¨ä¸å¤ªå¸¸è§ã€‚

ä½¿ç”¨æ–¹å¼ï¼š
```jsx
import { useFormAction } from "react-router-dom";

function DeleteButton() {
  return (
    <button
      formAction={useFormAction("destroy")}
      formMethod="post"
    >
      Delete
    </button>
  );
}
```

### useLoaderData

ç”¨æˆ·è·å–route loaderçš„è¿”å›å€¼ã€‚

ä½¿ç”¨æ–¹å¼ï¼š
```jsx
import {
  createBrowserRouter,
  RouterProvider,
  useLoaderData,
} from "react-router-dom";

function loader() {
  return fetchFakeAlbums();
}

export function Albums() {
  const albums = useLoaderData();
  // ...
}

const router = createBrowserRouter([
  {
    path: "/",
    loader: loader,
    element: <Albums />,
  },
]);

ReactDOM.createRoot(el).render(
  <RouterProvider router={router} />
);
```

useLoaderData ä¸ä¼šé‡å¤æå–æ•°æ®ã€‚å®ƒåªæ˜¯è¯»å– React Router å†…éƒ¨ç®¡ç†çš„ fetch çš„ç»“æœï¼Œå½“å®ƒç”±äºè·¯ç”±ä¹‹å¤–çš„åŸå› é‡æ–°æ¸²æŸ“æ—¶ï¼Œæ‚¨æ— éœ€æ‹…å¿ƒå®ƒä¼šé‡æ–°è·å–ã€‚è¿™ä¹Ÿæ„å‘³ç€è¿”å›æ•°æ®å’Œæ¸²æŸ“ä¹‹é—´ï¼Œdataæ˜¯ç¨³å®šçš„ï¼Œå› æ­¤æ‚¨å¯ä»¥å®‰å…¨åœ°å°†å…¶ä¼ é€’ç»™ React é’©å­ï¼ˆå¦‚ useEffectï¼‰ä¸­çš„ä¾èµ–æ•°ç»„ã€‚åªæœ‰åœ¨æ“ä½œæˆ–æŸäº›å¯¼èˆªåå†æ¬¡è°ƒç”¨åŠ è½½ç¨‹åºæ—¶ï¼Œå®ƒæ‰ä¼šæ›´æ”¹ã€‚


### useMatches

è¿”å›å½“å‰åŒ¹é…çš„è·¯ç”±é¡¹ã€‚ä½¿ç”¨æ¡ˆä¾‹ï¼šé¢åŒ…å±‘å¯¼èˆªï¼š

```jsx
// è·¯ç”±è¡¨
<Route element={<Root />}>
  <Route
    path="messages"
    element={<Messages />}
    loader={loadMessages}
    handle={{
      // you can put whatever you want on a route handle
      // here we use "crumb" and return some elements,
      // this is what we'll render in the breadcrumbs
      // for this route
      crumb: () => <Link to="/message">Messages</Link>,
    }}
  >
    <Route
      path="conversation/:id"
      element={<Thread />}
      loader={loadThread}
      handle={{
        // `crumb` is your own abstraction, we decided
        // to make this one a function so we can pass
        // the data from the loader to it so that our
        // breadcrumb is made up of dynamic content
        crumb: (data) => <span>{data.threadName}</span>,
      }}
    />
  </Route>
</Route>

// å¯¼èˆªç»„ä»¶
function Breadcrumbs() {
  let matches = useMatches();
  let crumbs = matches
    // first get rid of any matches that don't have handle and crumb
    .filter((match) => Boolean(match.handle?.crumb))
    // now map them into an array of elements, passing the loader
    // data to each one
    .map((match) => match.handle.crumb(match.data));

  return (
    <ol>
      {crumbs.map((crumb, index) => (
        <li key={index}>{crumb}</li>
      ))}
    </ol>
  );
}
```

### useNavigation

è·å–è·¯ç”±åŠ è½½è¿‡ç¨‹ä¸­çš„å„ç§å¯¼èˆªå‚æ•°ï¼Œä½¿ç”¨åœºæ™¯ï¼š

- å…¨å±€åŠ è½½ loading
- éœ€è¦å…¨å±€ç¦ç”¨ form
- æäº¤æ—¶è¡¨å•å¤„ç†ä¸­çš„åŠ¨ç”»
- ...

ä½¿ç”¨æ–¹å¼ï¼š

```jsx
import { useNavigation } from "react-router-dom";

function SomeComponent() {
  const navigation = useNavigation();
  navigation.state; // idle â†’ submitting â†’ loading â†’ idle
  navigation.location;
  navigation.formData;
  navigation.formAction;
  navigation.formMethod;
}
```

### useRevalidator

ç”¨äºé‡æ–°éªŒè¯æ•°æ®çš„åœºæ™¯ï¼Œä½¿ç”¨æ–¹å¼ï¼š
```jsx
import { useRevalidator } from "react-router-dom";

function WindowFocusRevalidator() {
  let revalidator = useRevalidator();

  useFakeWindowFocus(() => {
    revalidator.revalidate();
  });

  return (
    <div hidden={revalidator.state === "idle"}>
      Revalidating...
    </div>
  );
}
```

### useRouteError

åœ¨ errorElementå±æ€§ç»„ä»¶å†…éƒ¨ä½¿ç”¨ï¼Œè¿”å›ä»»ä½•è·¯ç”±ä¸­å‡ºç°çš„é”™è¯¯ã€‚ä½¿ç”¨æ–¹å¼ï¼š

```jsx
function ErrorBoundary() {
  const error = useRouteError();
  console.error(error);
  return <div>{error.message}</div>;
}

<Route
  errorElement={<ErrorBoundary />}
  loader={() => {
    // unexpected errors in loaders/actions
    something.that.breaks();
  }}
  action={() => {
    // stuff you throw on purpose in loaders/actions
    throw new Response("Bad Request", { status: 400 });
  }}
  element={
    // and errors thrown while rendering
    <div>{breaks.while.rendering}</div>
  }
/>;
```

### useRouteLoaderData

æ”¶é›†è·¯ç”±æ ‘ä¸Šæ‰€æœ‰çš„loaderæ•°æ®ã€‚åœ¨éœ€è¦å…¨å±€æŠŠæ§å¤šåµŒå¥—è·¯ç”±å‚æ•°æ—¶æ¯”è¾ƒæœ‰ç”¨ã€‚

ä½¿ç”¨æ–¹å¼ï¼š

```jsx
createBrowserRouter([
  {
    path: "/",
    loader: () => fetchUser(),
    element: <Root />,
    id: "root",
    children: [
      {
        path: "jobs/:jobId",
        loader: loadJob,
        element: <JobListing />,
      },
    ],
  },
]);

...
const user = useRouteLoaderData("root");
```

é€šè¿‡è·¯ç”±çš„idæ¥è¯†åˆ«è·¯ç”±æ ‘çš„èµ·ç‚¹ã€‚

### useSubmit

åŠ¨æ€æäº¤è¡¨å•ã€‚ä½¿ç”¨æ–¹å¼ï¼š
```jsx
import { useSubmit, Form } from "react-router-dom";

function SearchField() {
  let submit = useSubmit();
  return (
    <Form
      onChange={(event) => {
        submit(event.currentTarget, { method: "post", action: "/check" });
      }}
    >
      <input type="text" name="search" />
      <button type="submit">Search</button>
    </Form>
  );
}
```

## 5. æ–°å¢å°å·¥å…·

### json

jsonè½¬æ¢å·¥å…·ï¼š

```jsx
import { json } from "react-router-dom";

const loader = async () => {
  const data = getSomeData();
  return json(data);
};
```

### redirect

é‡å®šå‘ã€‚åœ¨ loader å’Œ action ä¸­æ¨èä½¿ç”¨ï¼Œè€Œä¸æ˜¯ useNavigateï¼Œä»–ç­‰ä»·äºå¦‚ä¸‹æ“ä½œï¼š

```js
new Response("", {
  status: 302,
  headers: {
    Location: someUrl,
  },
});
```
ä½¿ç”¨æ¡ˆä¾‹ï¼š
```jsx
import { redirect } from "react-router-dom";

const loader = async () => {
  const user = await getUser();
  if (!user) {
    return redirect("/login");
  }
};
```6f:T2246,æœ¬æœŸè®²ä¸€ä¸‹ `React Router v6` çš„utilsåº“ä¸­çš„å†…ç½®æ–¹æ³•ã€‚æœ¬æ–‡åªåœ¨æ˜é‡‘å‘å¸ƒã€‚

> ä¸“æ è¯´æ˜ï¼šå¯¹äºreact-router v6ç‰ˆæœ¬ï¼Œæœ‰åŒäº‹åæ˜ ç¼ºå°‘ç›¸å¯¹å®Œæ•´çš„ä¸­æ–‡æ–‡æ¡£ï¼ŒæŸ¥çœ‹ä¸æ–¹ä¾¿ã€‚ä¸ºäº†ä¾¿äºä½¿ç”¨ï¼Œä½œè€…å¯¹[å®˜ç½‘æ–‡æ¡£](https://link.juejin.cn/?target=https%3A%2F%2Freactrouter.com%2Fdocs%2Fen%2Fv6 "https://link.juejin.cn/?target=https%3A%2F%2Freactrouter.com%2Fdocs%2Fen%2Fv6")è¿›è¡Œé’ˆå¯¹æ€§ç¿»è¯‘ï¼Œä¾¿äºv6ç‰ˆæœ¬æ›´å¹¿æ³›çš„è¢«ä½¿ç”¨ã€‚


## 1. createRoutesFromChildren

ç±»å‹å®šä¹‰ï¼š

```ts
declare function createRoutesFromChildren(
  children: React.ReactNode
): RouteObject[];

// è¿”å›å€¼
interface RouteObject {
  caseSensitive?: boolean;
  children?: RouteObject[];
  element?: React.ReactNode;
  index?: boolean;
  path?: string;
}
```
`createRoutesFromChildren`Â é€šå¸¸åœ¨Â `<Route>`Â å­å…ƒç´ ä¸­ä½¿ç”¨ï¼Œç”¨äºç”Ÿæˆå­ route çš„é…ç½®é¡¹ã€‚å¯ä»¥æŠŠ `<Route>` ç±»å‹çš„ react element å¯¹è±¡ï¼Œå˜æˆäº†æ™®é€šçš„ route å¯¹è±¡ç»“æ„ã€‚å…¶å†…éƒ¨é€šè¿‡ React.Children.forEach æŠŠ Route ç»„ä»¶ç»™ç»“æ„åŒ–ï¼Œå¹¶ä¸”å†…éƒ¨è°ƒç”¨é€’å½’ï¼Œæ·±åº¦é€’å½’ children ç»“æ„ã€‚

ç¤ºä¾‹ï¼š

è¾“å…¥
```js
<Routes> 
    <Route element={<Home />} path="/home" /> 
    <Route element={<List/>} path="/list" /> 
    <Route element={<Layout/>} path="/children" > 
        <Route element={<Child1/>} path="/children/child1" /> 
        <Route element={<Child2/>} path="/children/child2" /> 
    </Route> 
</Routes>
```
è¾“å‡º

![1](/img/posts/2022-9-19/2022-9-19-1.png)

## 2. createSearchParams

ç±»å‹å®šä¹‰ï¼š


```ts
declare function createSearchParams(
  init?: URLSearchParamsInit
): URLSearchParams;
```

`createSearchParams` é€šå¸¸ä¸ `useSearchParams` é…å¯¹ä½¿ç”¨ï¼Œç”¨äº search ä¼ å‚æ—¶æ„å»ºå‚æ•°ã€‚

ç¤ºä¾‹ï¼š

```js
// ä¼ å‚æ–¹å¼ 1
navigate({
    pathname: "/class",
    search: `?id=${id}&grade=${grade}`
})

// ä¼ å‚æ–¹å¼ 2
const params = { id: '1', grade: '2' };
navigate({
    pathname: "/class",
    search: `?${createSearchParams(params)}`
})
```

## 3. generatePath

ç±»å‹å®šä¹‰ï¼š

```ts
declare function generatePath(
  path: string,
  params?: Params
): string;
```

åŠ¨æ€ç”Ÿæˆå¯è·³è½¬çš„ pathï¼Œ å¯è‡ªåŠ¨åŒ¹é…å¹¶å¡«å……åŠ¨æ€å‚æ•°ã€‚

ç¤ºä¾‹ï¼š
```js
generatePath("/users/:id", { id: "42" }); // "/users/42"
generatePath("/files/:type/*", {
  type: "img",
  "*": "cat.jpg",
}); // "/files/img/cat.jpg"
```

## 4. Location

React Router ä¸­ "location" çš„æ¥å£å®šä¹‰ã€‚

## 5. matchPath

ç±»å‹å®šä¹‰ï¼š
```ts
declare function matchPath<
  ParamKey extends string = string
>(
  pattern: PathPattern | string,
  pathname: string
): PathMatch<ParamKey> | null;

interface PathMatch<ParamKey extends string = string> {
  params: Params<ParamKey>;
  pathname: string;
  pattern: PathPattern;
}

interface PathPattern {
  path: string;
  caseSensitive?: boolean;
  end?: boolean;
}
```

æ¯”è¾ƒå¸¸ç”¨çš„å‡½æ•°ã€‚æ˜¯hook `[useMatch](https://reactrouter.com/en/main/hooks/use-match)` çš„è¡¥å……ï¼Œç”¨äºéå‡½æ•°å¼ç»„ä»¶ä¸­ã€‚

ç¤ºä¾‹ï¼š

```js
matchPath('/children/child1/:id', '/children/child1/1') 
```
![2](/img/posts/2022-9-19/2022-9-19-2.png)
ä¸ªäººè§‰å¾—æ²¡å•¥ç”¨çš„æ–¹æ³•ï¼Œä½ éƒ½çŸ¥é“ä¼ å…¥ pathname äº†ï¼Œè¿˜åŒ¹é…ä¸ªderã€‚

---
P.S. 2023å¹´2æœˆè¿½åŠ 

æˆ‘é”™äº†ï¼ï¼ä»Šå¤©é‡åˆ°ä¸€ä¸ªé—®é¢˜ï¼Œå†å†™ä¸€ä¸ªé¢åŒ…å±‘å¯¼èˆªçš„æ—¶å€™ï¼ŒåŒ¹é…å¸¦æœ‰è·¯å¾„å‚æ•°çš„è·¯ç”±è¿›è¡Œé€‰æ‹©æ€§é«˜äº®ï¼Œè¿˜çœŸå¾—ä½¿ç”¨ matchPathï¼Œçœçš„è‡ªå·±å†™æ­£åˆ™æ ¡éªŒäº†ï¼š

![3](/img/posts/2022-9-19/2022-9-19-3.png)

(è“è‰²æ˜¯location.pathnameï¼Œçº¢è‰²æ˜¯éå† Menué…ç½®æ‹¿åˆ°çš„urlï¼Œç»¿è‰²æ˜¯matchPathè¿”å›çš„ï¼Œè‹¥ä¸æ˜¯nullåˆ™è¡¨ç¤ºåŒ¹é…åˆ°äº†ï¼)

## 6. matchRoutes

ç±»å‹å®šä¹‰ï¼š
```ts
declare function matchRoutes(
  routes: RouteObject[],
  location: Partial<Location> | string,
  basename?: string
): RouteMatch[] | null;

interface RouteMatch<ParamKey extends string = string> {
  params: Params<ParamKey>;
  pathname: string;
  route: RouteObject;
}
```

è¿™ä¸ªæ˜¯v6ç‰ˆåŒ¹é…è·¯ç”±çš„æ ¸å¿ƒç®—æ³•ï¼Œå®˜æ–¹æš´éœ²å‡ºæ¥äº†ï¼Œä¾›å¼€å‘è€…è‡ªå®šä¹‰ä½¿ç”¨ã€‚

ç¤ºä¾‹ï¼š

```js
const routes = [
  {
    path: '/',
    component: <Home />
  },
  {
    path: '/list',
    component: <List />
  },
  {
    path: '/children',
    component: <Layout />,
    children: [
      {
        path: 'child1',
        component: <Child1 />
      },
      {
        path: 'child2/:id',
        component: <Child2 />
      },
    ]
  }
]
...

<BrowserRouter>
  <Routes>
      {routes.map((route, index) => <Route key={index} element={route.component} path={route.path} >
        {route.children && <>
          {route.children.map((cRoute, cIndex) => <Route key={cIndex} element={cRoute.component} path={cRoute.path} />)}
        </>}
      </Route> )}
  </Routes>
</BrowserRouter>

matchRoutes(routes, '/children/child1')
```

![4](/img/posts/2022-9-19/2022-9-19-4.png)
å¯ä»¥çœ‹åˆ°ï¼Œ matchRoutes å°†æ‰€æœ‰çš„åŒ¹é…è·¯å¾„ä¸Šçš„è·¯ç”±éƒ½æŒ‰ç…§é¡ºåºè¿”å›å•¦ã€‚å¯ä»¥é€šè¿‡ route.path æ¥è·å–åŸå§‹è·¯ç”±è¡¨ä¸­çš„ pathã€‚


## 7. renderMatches

ç±»å‹å®šä¹‰ï¼š
```ts
declare function renderMatches(
  matches: RouteMatch[] | null
): React.ReactElement | null;
```

å®ƒçš„ä½œç”¨æ˜¯æŠŠ matchRoutes åŒ¹é…åˆ°çš„ component æ¸²æŸ“å‡ºæ¥ã€‚è¯´çš„å®¹æ˜“ï¼Œç½‘ä¸Šçš„ä½¿ç”¨æ¡ˆä¾‹å°‘ä¹‹åˆå°‘ï¼Œå®˜æ–¹æ–‡æ¡£åˆå¤ªè¿‡æ•·è¡ï¼Œåªèƒ½å»è¯»æºç äº†ï¼š

```tsx
// react-router/packages/lib/hooks.tsx
export function _renderMatches(
  matches: RouteMatch[] | null,
  parentMatches: RouteMatch[] = []
): React.ReactElement | null {
  if (matches == null) return null;

  return matches.reduceRight((outlet, match, index) => {
    return (
      <RouteContext.Provider
        children={
          match.route.element !== undefined ? match.route.element : outlet
        }
        value={{
          outlet,
          matches: parentMatches.concat(matches.slice(0, index + 1)),
        }}
      />
    );
  }, null as React.ReactElement | null);
}
```
å¯ä»¥çœ‹åˆ°ï¼Œå®ƒæ˜¯å°†åŒ¹é…åˆ°çš„è·¯ç”±æ•°ç»„ä»å³å‘å·¦æ‘˜å–ï¼Œç»Ÿä¸€æ”¾åˆ°ä¸€ä¸ª context é‡Œäº†ã€‚è€Œä¸”ï¼Œä»æºç é‡Œçœ‹åˆ°ï¼ŒuseRoutes çš„è¿”å›å€¼å°±æ˜¯ä¸€ä¸ª _renderMatchesï¼Œæˆ‘ä»¬å¯ä»¥å‚ç…§æºç çš„è°ƒç”¨æ–¹å¼è¿›è¡Œä½¿ç”¨ã€‚

è€ƒè™‘è·¯ç”±ï¼š

```js
const routes = [
    {
      path: '/',
      component: <Home />
    },
    {
      path: '/list',
      component: <List />
    },
    {
      path: '/children',
      component: <Layout />,
      children: [
        {
          path: 'child1',
          component: <Child1 />
        },
        {
          path: 'child2/:id',
          component: <Child2 />
        },
      ]
    },
  ]
```

ä½¿ç”¨æ–¹å¼ï¼š

```js
renderMatches(matchRoutes(routes, '/children/child2/1'))
```
matchRoutes è¿”å›çš„å€¼æ˜¯ï¼š

![5](/img/posts/2022-9-19/2022-9-19-5.png)
ä¸ _renderMatches æ¥å—çš„å‚æ•°ä¸€è‡´ã€‚

åœ¨ matches.reduceRight ä¸­ï¼Œä¼šå°† match.route.element é€šè¿‡ context çš„ children çš„å½¢å¼æŒ‚è½½ã€‚ä¸çŸ¥é“æ˜¯ä¸æ˜¯å¼€å‘è€…çš„ç¬”è¯¯ï¼Œchildren é‡Œä½¿ç”¨äº† match.route.elementï¼Œè€Œä¸Šå›¾ä¸­åŒ¹é…çš„æ•°ç»„æ˜æ˜æ˜¯ route.componentï¼Œå¯¼è‡´ç›´æ¥ä½¿ç”¨æ¸²æŸ“ä¸å‡ºæ¥ä»»ä½•æ•°æ®ï¼Œæˆ‘æ”¹åŠ¨ä¸€ä¸‹è¿™ä¸ªå‡½æ•°å°±æœ‰æ•°æ®äº†ï¼š

```jsx
const Context = createContext({});

const matches = matchRoutes(routes, '/children/child2/1');

return matches && matches.reduceRight((outlet, match, index) => {
    return (
      <Context.Provider
        children={
          match.route.component !== undefined ? match.route.component : outlet
        }
        value={{
          outlet,
        }}
      />
    );
}, null as React.ReactElement | null);
```
ä½†æ˜¯ä»–ä¼ çš„è¿™ä¸ª outlet å‚æ•°ï¼Œå¹¶ä¸èƒ½è¢«è‡ªåŠ¨è¯†åˆ«ä¸º \<Outlet /> æ ‡ç­¾ï¼Œæ‰€ä»¥åªèƒ½æ¸²æŸ“å‡ºæ¥ Layoutï¼Œ å­ç»„ä»¶ä»ç„¶æ¸²æŸ“ä¸å‡ºæ¥ã€‚
          
 è¯‘è€…è‡ªå·±å†™äº†ä¸ªDemoï¼Œæ¥å¤ç°ä¸€ä¸‹ä»–è¿™ä¸ªç®—æ³•ï¼š
 
```tsx
// ä¸»
<Context.Provider
  value={{
    outlet: <Context.Provider>
      <Child2 />
    </Context.Provider>
  }}
>
  <Layout />
</Context.Provider>

// Layout
function Layout () {
    return <Context.Consumer>
      {values => {
        return <>
           'Layout
           {values.outlet ? values.outlet : <Outlet />}
        </>
      }}
    </Context.Consumer>
}
```
å¯ä»¥æ­£å¸¸æ¸²æŸ“ï¼š

![6](/img/posts/2022-9-19/2022-9-19-6.png)

æ€»ç»“ï¼šrenderMatches ä¸è¦ç”¨ï¼Œå‘äººã€‚åµŒå¥— Outlet çš„æ€æƒ³å¾ˆå¥½ï¼Œä½†ç»ˆç©¶æ˜¯ç»™å†…éƒ¨ä½¿ç”¨çš„å†…éƒ¨ APIï¼Œä¸šåŠ¡ä¸Šä¸è¦ç”¨ã€‚

## 8. resolvePath

ç±»å‹å®šä¹‰ï¼š
```ts
declare function resolvePath(
  to: To,
  fromPathname?: string
): Path;

type To = string | Partial<Path>;

interface Path {
  pathname: string;
  search: string;
  hash: string;
}
```

é€šè¿‡ç»™å®šçš„ç›¸å¯¹è·¯ç”± to æ¥è·å–ä¸€ä¸ªèƒ½å¤Ÿ navigate çš„ç»å¯¹è·¯å¾„ pathã€‚æ˜¯hook useResolvedPath çš„å®ç°æ–¹æ³•ã€‚


```js
resolvePath('children/child2/:id') // /children/child2/:id
```

<hr />

å®Œï¼70:T2bf7,> ä¸“æ è¯´æ˜ï¼šå¯¹äºreact-router v6ç‰ˆæœ¬ï¼Œæœ‰åŒäº‹ååº”ç¼ºå°‘ç›¸å¯¹å®Œæ•´çš„ä¸­æ–‡æ–‡æ¡£ï¼ŒæŸ¥çœ‹ä¸æ–¹ä¾¿ã€‚ä¸ºäº†ä¾¿äºä½¿ç”¨ï¼Œä½œè€…å¯¹[å®˜ç½‘æ–‡æ¡£](https://link.juejin.cn/?target=https%3A%2F%2Freactrouter.com%2Fdocs%2Fen%2Fv6 "https://reactrouter.com/docs/en/v6")è¿›è¡Œé’ˆå¯¹æ€§ç¿»è¯‘ï¼Œä¾¿äºv6ç‰ˆæœ¬æ›´å¹¿æ³›çš„è¢«ä½¿ç”¨ã€‚


> ä½œè€…è¯´æ˜ï¼šæœ¬æœŸçš„hooksä»…ä»…åœ¨å‡½æ•°å¼ç»„ä»¶é‡Œç”Ÿæ•ˆï¼Œè‹¥æƒ³è¦åœ¨ç±»å¼ç»„ä»¶é‡Œä½¿ç”¨ç›¸åº”åŠŸèƒ½ï¼Œå¯å‚è§æœ¬ä¸“æ ç¬¬ä¸€ç¯‡æ–‡ç« ï¼Œè‡ªå·±å†™ä¸€ä¸ª withRouter å‡½æ•°ã€‚

## 1. useHref

ç±»å‹å®šä¹‰ï¼š

```ts
declare function useHref(to: To): string;
```
`useHref` è¿”å›ä¸€ä¸ªå®Œæ•´çš„è·¯ç”±URLï¼ŒæŒ‡å‘å‚æ•°Â `to`Â å®šä½çš„åœ°å€, è¿™ä¸ªåœ°å€å¯ä»¥è„±ç¦» React Routerç¯å¢ƒã€‚ä½¿ç”¨ç¤ºä¾‹ï¼š

```js
// æ·±å±‚è·¯ç”±ä¸­
useHref({ to: 'dashboard' }) // /home/test/dashboard
```

## 2. useInRouterContext

ç±»å‹å®šä¹‰ï¼š
```ts
declare function useInRouterContext(): boolean;
```
å½“ç»„ä»¶ä½¿ç”¨äº†`<Router>`æ¸²æŸ“æ—¶ï¼Œè¯¥é’©å­è¿”å›trueï¼Œå¦åˆ™è¿”å›falseã€‚è¿™å¯¹äºä¸€äº›éœ€è¦çŸ¥é“ç»„ä»¶æ˜¯å¦åœ¨ React Router ä¸Šä¸‹æ–‡ä¸­çš„ç¬¬ä¸‰æ–¹æ‰©å±•éå¸¸æœ‰ç”¨ã€‚

## 3. useLinkClickHandler

ç±»å‹å®šä¹‰ï¼š
```ts
declare function useLinkClickHandler<
  E extends Element = HTMLAnchorElement
>(
  to: To,
  options?: {
    target?: React.HTMLAttributeAnchorTarget;
    replace?: boolean;
    state?: any;
  }
): (event: React.MouseEvent<E, MouseEvent>) => void;
```
å…¶è¿”å›ä¸€ä¸ªèƒ½å¤Ÿå®ç°`<Link>`æ ‡ç­¾åŠŸèƒ½çš„æ›¿ä»£æ€§çš„å‡½æ•°ï¼Œç”¨äºåœ¨è‡ªå®šä¹‰è·³è½¬æ—¶ä½¿ç”¨ï¼Œå‚æ•°åŒLinkæ ‡ç­¾ï¼š

```jsx
import {
  useHref,
  useLinkClickHandler,
} from "react-router-dom";

const StyledLink = styled("a", { color: "fuchsia" });

const Link = React.forwardRef(
  (
    {
      onClick,
      replace = false,
      state,
      target,
      to,
      ...rest
    },
    ref
  ) => {
    let href = useHref(to);
    // è°ƒç”¨handleClickï¼Œç›¸å½“äºç‚¹å‡»äº†ä¸€ä¸ª<Link>æ ‡ç­¾
    let handleClick = useLinkClickHandler(to, {
      replace,
      state,
      target,
    });

    return (
      <StyledLink
        {...rest}
        href={href}
        onClick={(event) => {
          onClick?.(event);
          if (!event.defaultPrevented) {
            handleClick(event);
          }
        }}
        ref={ref}
        target={target}
      />
    );
  }
);
```

## 4. useLinkPressHandler

ç±»å‹å®šä¹‰ï¼š
```ts
declare function useLinkPressHandler(
  to: To,
  options?: {
    replace?: boolean;
    state?: any;
  }
): (event: GestureResponderEvent) => void;
```
åŠŸèƒ½åŒ useLinkClickHandlerï¼Œ åªä¸è¿‡æ˜¯åœ¨ç§»åŠ¨ç«¯ä½¿ç”¨çš„ï¼ˆå¸¸ç”¨äº react-nativeï¼‰ï¼Œä½¿ç”¨ç¤ºä¾‹ï¼š
```tsx
import { TouchableHighlight } from "react-native";
import { useLinkPressHandler } from "react-router-native";

function Link({
  onPress,
  replace = false,
  state,
  to,
  ...rest
}) {
  let handlePress = useLinkPressHandler(to, {
    replace,
    state,
  });

  return (
    <TouchableHighlight
      {...rest}
      onPress={(event) => {
        onPress?.(event);
        if (!event.defaultPrevented) {
          handlePress(event);
        }
      }}
    />
  );
}
```

## 5. useLocation

ç±»å‹å®šä¹‰ï¼š
```ts
declare function useLocation(): Location;

interface Location extends Path {
  state: unknown;
  key: Key;
}
```

è¿™ä¸ªå°±æ¯”è¾ƒå¸¸ç”¨äº†ã€‚ä»–è¿”å›å½“å‰è·¯ç”±çŠ¶æ€ä¸‹çš„ location ä¿¡æ¯, å¯ç”¨äºè·¯ç”±ä¼ å‚ã€‚ä½¿ç”¨æ–¹å¼ï¼š
```jsx
import { useLocation } from 'react-router-dom';

function App() {
  let location = useLocation(); // hash, key, pathname, search, state
}
```

## 6. useMatch

ç±»å‹å®šä¹‰ï¼š
```ts
declare function useMatch<ParamKey extends string = string>(
  pattern: PathPattern | string
): PathMatch<ParamKey> | null;
```

å…¶æ¥å—ä¸€ä¸ªç›¸å¯¹è·¯ç”±å­—ç¬¦ä¸²ï¼Œè¿”å›åŒ¹é…åˆ°çš„è·¯ç”±è¡¨æ•°æ®ã€‚ç¤ºä¾‹ï¼š

```js
useMatch('/')
```
è¿”å›å€¼ï¼š

![image.png](/img/posts/2022-8-26/2022-8-26-1.png)

## 7. useNavigate

ç±»å‹å®šä¹‰ï¼š
```ts
declare function useNavigate(): NavigateFunction;

interface NavigateFunction {
  (
    to: To,
    options?: { replace?: boolean; state?: any }
  ): void;
  (delta: number): void;
}
```

ä»–è¿”å›ä¸€ä¸ªå¯ä»¥ç”¨äºè·¯ç”±å¯¼èˆªçš„å‡½æ•°ã€‚æœ‰ä¸€ä¸ªå‚æ•° replaceï¼Œå¦‚æœä¼ ä¸º trueï¼Œè·¯ç”±ä¼šåœ¨ history stack ä¸­æ›¿æ¢å½“å‰çš„ currentï¼Œ è€Œä¸æ˜¯æ–° push ä¸€ä¸ªçŠ¶æ€ã€‚ä½¿ç”¨ç¤ºä¾‹ï¼š

```jsx
import { useNavigate } from "react-router-dom";

// è¡¨å•æäº¤åè·³è½¬é¡µé¢
function SignupForm() {
  let navigate = useNavigate();

  async function handleSubmit(event) {
    event.preventDefault();
    await submitForm(event.target);
    navigate("../success", { replace: true });
  }

  return <form onSubmit={handleSubmit}>{/* ... */}</form>;
}
```

å½“ç„¶ä¹Ÿå¯ä»¥ä¸ä¼ è·¯ç”±çš„ pathï¼Œç›´æ¥ä¼ æ•°å­—ï¼š

```js
navigate(-1)
```
è¡¨ç¤ºæµè§ˆå™¨å›é€€æˆ–è€…å‰è¿›ã€‚

## 8. useNavigationType

ç±»å‹å®šä¹‰ï¼š
```ts
declare function useNavigationType(): NavigationType;

type NavigationType = "POP" | "PUSH" | "REPLACE";
```

è¿”å›è·¯ç”±è·³è½¬çš„çŠ¶æ€ï¼Œè¡¨ç¤ºå½“å‰é¡µé¢æ˜¯æ€ä¹ˆæ ·è¢«ç”¨æˆ·è·³è½¬è¿‡æ¥çš„ï¼Œå¯é€‰å‚æ•°ï¼špop, push, replace

## 9. useOutlet

ç±»å‹å®šä¹‰ï¼š

```ts
declare function useOutlet(): React.ReactElement | null;
```

è¿”å›åµŒå¥—è·¯ç”±ä¸­ï¼Œè¢« `<Outlet>` å ä½çš„å­å…ƒç´ çš„è·¯ç”±å¯¹è±¡ã€‚é€šå¸¸åœ¨å­è·¯ç”±å†…éƒ¨ä½¿ç”¨ã€‚ç¤ºä¾‹ï¼š

```js
function Dashboard() {
  // æ‰“å° outlet
  console.log(useOutlet())
  return (
    <div>
      <h1>Dashboard</h1>
      <Outlet />
    </div>
  );
}

function DashboardMessages() {
  return 'DashboardMessages'
}

function DashboardTasks() {
  return 'DashboardTasks'
}

function App() {
  return (
    <Routes>
      <Route path="/" element={<Dashboard />}>
        {/* å­è·¯ç”± */}
        <Route
          path="messages"
          element={<DashboardMessages />}
        />
        <Route path="tasks" element={<DashboardTasks />} />
      </Route>
    </Routes>
  );
}
```
æ­¤æ—¶è®¿é—®è·¯ç”± `http://localhost:3000/messages`ï¼Œé¡µé¢å¦‚ä¸‹ï¼š

![image.png](/img/posts/2022-8-26/2022-8-26-2.png)

æ§åˆ¶å°æ‰“å°ï¼š

![image.png](/img/posts/2022-8-26/2022-8-26-3.png)

## 10. useOutletContext

ç±»å‹å®šä¹‰ï¼š
```ts
declare function useOutletContext<
  Context = unknown
>(): Context;
```
ç”¨äºçˆ¶å­è·¯ç”±å…±äº«çŠ¶æ€ã€‚ç¤ºä¾‹ï¼š
```jsx
// çˆ¶
function Parent() {
  const [count, setCount] = React.useState(0);
  return <Outlet context={[count, setCount]} />;
}

// å­
import { useOutletContext } from "react-router-dom";

function Child() {
  const [count, setCount] = useOutletContext();
  const increment = () => setCount((c) => c + 1);
  return <button onClick={increment}>{count}</button>;
}
```
å¦‚æœæ˜¯åœ¨tsç¯å¢ƒä¸‹ï¼Œä½¿ç”¨æ–¹å¼åˆæœ‰æ‰€ä¸åŒã€‚æ¨èè‡ªå®šä¹‰ä¸€ä¸ª contextï¼Œ è¿™æ ·æ–¹ä¾¿ç±»å‹å®šä¹‰ï¼š
```tsx
// çˆ¶
import * as React from "react";
import type { User } from "./types";
import { Outlet, useOutletContext } from "react-router-dom";

type ContextType = { user: User | null };

export default function Dashboard() {
  const [user, setUser] = React.useState<User | null>(null);

  return (
    <div>
      <h1>Dashboard</h1>
      <Outlet context={{ user }} />
    </div>
  );
}

// è‡ªå®šä¹‰ hook
export function useUser() {
  return useOutletContext<ContextType>();
}

// å­
import { useUser } from "../dashboard";

export default function DashboardMessages() {
  const { user } = useUser();
  return (
    <div>
      <h2>Messages</h2>
      <p>Hello, {user.name}!</p>
    </div>
  );
}
```

## 11. useParams

ç±»å‹å®šä¹‰ï¼š
```ts
declare function useParams<
  K extends string = string
>(): Readonly<Params<K>>;
```

è¿”å›è·¯ç”±ä¼ å‚çš„é”®å€¼å¯¹å‚æ•°ï¼ˆä¸æ˜¯é—®å·ä¼ å‚ï¼Œé—®å·çš„åœ¨locationçš„searché‡Œï¼‰ã€‚å­è·¯ç”±ä¹Ÿä¼šç»§æ‰¿çˆ¶è·¯ç”±çš„æ‰€æœ‰å‚æ•°ã€‚ä½¿ç”¨ç¤ºä¾‹ï¼š
```jsx
import * as React from 'react';
import { Routes, Route, useParams } from 'react-router-dom';

function ProfilePage() {
  // Get the userId param from the URL.
  let { userId } = useParams();
  // ...
}

function App() {
  return (
    <Routes>
      <Route path="users">
        <Route path=":userId" element={<ProfilePage />} />
        <Route path="me" element={...} />
      </Route>
    </Routes>
  );
}
```

## 12. useResolvedPath

ç±»å‹å®šä¹‰ï¼š

```ts
declare function useResolvedPath(to: To): Path;
```

è¿”å›ä¼ å…¥pathçš„å…¨è·¯å¾„ã€‚å¯è§£æå‡ºpathï¼Œhashï¼Œsearchï¼ˆlocationå¯¹è±¡ï¼‰


## 13. useRoutes

ç±»å‹å®šä¹‰ï¼š
```ts
declare function useRoutes(
  routes: RouteObject[],
  location?: Partial<Location> | string;
): React.ReactElement | null;
```
æ˜¯æ ‡ç­¾ `<Routes>` çš„å‡½æ•°å¼å½¢å¼ã€‚ä½¿ç”¨æ—¶ä¹Ÿä¸éœ€è¦é¢å¤–çš„JSXã€‚ç¤ºä¾‹ï¼š
```jsx
import * as React from "react";
import { useRoutes } from "react-router-dom";

function App() {
  let element = useRoutes([
    {
      path: "/",
      element: <Dashboard />,
      children: [
        {
          path: "messages",
          element: <DashboardMessages />,
        },
        { path: "tasks", element: <DashboardTasks /> },
      ],
    },
    { path: "team", element: <AboutPage /> },
  ]);

  return element;
}
```
ä»–çš„è¿”å›å€¼è¦ä¹ˆæ˜¯åŒ¹é…åˆ°çš„Reactå…ƒç´ ï¼Œè¦ä¹ˆæ˜¯nullã€‚

## 14. useSearchParams
ç±»å‹å®šä¹‰ï¼š
```ts
declare function useSearchParams(
  defaultInit?: URLSearchParamsInit
): [URLSearchParams, SetURLSearchParams];

type ParamKeyValuePair = [string, string];

type URLSearchParamsInit =
  | string
  | ParamKeyValuePair[]
  | Record<string, string | string[]>
  | URLSearchParams;

type SetURLSearchParams = (
  nextInit?: URLSearchParamsInit,
  navigateOpts?: : { replace?: boolean; state?: any }
) => void;
```

è§£æå½“å‰è·¯å¾„ï¼Œè¿”å›locationä¸­çš„searchï¼›å¹¶å¯é‡æ–°è®¾ç½® search å¹¶è§¦å‘è·³è½¬ã€‚ç¤ºä¾‹ï¼š
```jsx
import * as React from "react";
import { useSearchParams } from "react-router-dom";

function App() {
  let [searchParams, setSearchParams] = useSearchParams();

  function handleSubmit(event) {
    event.preventDefault();
    let params = serializeFormQuery(event.target);
    setSearchParams(params);
  }

  return (
    <div>
      <form onSubmit={handleSubmit}>{/* ... */}</form>
    </div>
  );
}
```
å…¶ä¸­ï¼Œ setSearchParams ç±»ä¼¼äº navigateï¼Œä½†æ˜¯ä»…ä»…ä¼ é€’ search å‚æ•°ã€‚

## 15. useSearchParams (React Native)

ç±»å‹å®šä¹‰ï¼š
```ts
declare function useSearchParams(
  defaultInit?: URLSearchParamsInit
): [URLSearchParams, SetURLSearchParams];

type ParamKeyValuePair = [string, string];

type URLSearchParamsInit =
  | string
  | ParamKeyValuePair[]
  | Record<string, string | string[]>
  | URLSearchParams;

type SetURLSearchParams = (
  nextInit?: URLSearchParamsInit,
  navigateOpts?: : NavigateOptions
) => void;

interface NavigateOptions {
  replace?: boolean;
  state?: any;
}
```
ä½¿ç”¨æ–¹å¼åŒä¸Šã€‚ç¤ºä¾‹ï¼š
```jsx
import * as React from "react";
import { View, SearchForm, TextInput } from "react-native";
import { useSearchParams } from "react-router-native";

function App() {
  let [searchParams, setSearchParams] = useSearchParams();
  let [query, setQuery] = React.useState(
    searchParams.get("query")
  );

  function handleSubmit() {
    setSearchParams({ query });
  }

  return (
    <View>
      <SearchForm onSubmit={handleSubmit}>
        <TextInput value={query} onChangeText={setQuery} />
      </SearchForm>
    </View>
  );
}
```71:T3b47,![WechatIMG105.jpeg](/img/posts/2022-8-23/2022-8-23-1.png)

> é•¿åˆ—è¡¨æ»šåŠ¨ï¼Œæ˜¯ä¸€ä¸ªè€ç”Ÿå¸¸è°ˆçš„æ€§èƒ½ä¼˜åŒ–é—®é¢˜ï¼Œåœ¨æåˆ°æ€§èƒ½ä¼˜åŒ–æ—¶å´åˆæ˜¯é¿ä¸å¼€çš„è¯é¢˜ï¼Œå…¶ç›®æ ‡æ— éå°±æ˜¯`å°½å¯èƒ½åœ¨ä»»æ„æ—¶åˆ»å†…åªå…³æ³¨å¯è§†çª—å£åŒºåŸŸçš„æ•°æ®çš„æµç•…å±•ç¤ºï¼Œè€Œå¿½è§†è¢«é®æŒ¡åŒºåŸŸï¼ŒåŒæ—¶åˆä¸èƒ½å½±å“æ•°æ®çš„æ­£å¸¸æ¸²æŸ“ã€‚`æœ¬æ–‡å°½å¯èƒ½å…¨çš„æ€»ç»“ä¸€ä¸‹æ‰€æœ‰é•¿åˆ—è¡¨æ»šåŠ¨çš„ä¼˜åŒ–æ–¹æ¡ˆï¼Œä»¥ä¾›å‚è€ƒã€‚
> 
> ï¼ˆæœ¬æ–‡ä»…åœ¨æ˜é‡‘å‘å¸ƒï¼‰


## 0. å¼•

å…ˆè¯´è¯´ DOM å…ƒç´ è¿‡å¤šï¼Œé¡µé¢ä¸ºä»€ä¹ˆä¼šå¡é¡¿å‘¢ï¼Ÿæœ‰æ²¡æœ‰æƒ³è¿‡è¿™ä¸ªé—®é¢˜ï¼Ÿ

å…¶å®ç”¨ç›´è§‚æ„Ÿå—ä¹Ÿèƒ½è§‰å¯Ÿçš„å‡ºæ¥ï¼Œå› ä¸ºæµè§ˆå™¨è¦æ“å¿ƒçš„äº‹æƒ…å¤šäº†ã€‚ä¸€ä¸‹åŠ è½½å¾ˆå¤šçš„ä¸œè¥¿ï¼ŒHTML å…ƒç´  å ç”¨çš„å†…å­˜ä¼šä¸€ä¸‹å˜å¤šï¼Œæµè§ˆå™¨å•è–„çš„å°èº«æ¿å°±ä¼šåƒä¸æ¶ˆï¼Œå¦‚æœç»™æ¯ä¸ªdomåˆæ·»åŠ ç›‘å¬äº‹ä»¶ï¼Œå†åŠ ä¸Šæ„ˆåŠ å¤æ‚çš„ DOM ç»“æ„ï¼Œé©¬ä¸Šå°±ä¼šé›ªä¸ŠåŠ éœœã€‚

å¯¹é•¿åˆ—è¡¨æ»šåŠ¨å‘¢ï¼Œåˆ™ä¼šæ›´è¿›ä¸€æ­¥ï¼Œæ¯æ¬¡æ»šåŠ¨å°±ä¼šè®©é¡µé¢æ‰€æœ‰å…ƒç´ è§¦å‘å›æµé‡ç»˜ï¼Œå› ä¸ºå…¶ä½ç½®å˜åŒ–äº†å˜›ã€‚ä½ æ‰“ä¸€äº›è€æ¸¸æˆï¼Œæ¯”å¦‚çº¢è­¦ï¼Œè§†çª—å†…å•ä½è¿‡å¤šæ—¶ï¼Œå°±ä¼šå¡é¡¿ï¼Œä½ ç”¨æœ€å¥½çš„æ˜¾å¡å’ŒCPUä¹Ÿè¿˜æ˜¯ä¼šå¡é¡¿ï¼Œä»–æ˜¯å› ä¸ºè€æ¸¸æˆçš„ä¼˜åŒ–åšçš„ä¸å¤Ÿå¥½ã€‚åŒç†ï¼Œwebç«¯ä¹Ÿéœ€è¦æ­¤ç±»ä¼˜åŒ–ï¼Œå¤„ç†é•¿åˆ—è¡¨æœ‰å¦‚ä¸‹å‡ ç§æ–¹å¼ï¼š

1. åˆ†é¡µåŠ è½½ï¼šé¡µæ¬¡éƒ½æ˜¾ç¤ºå›ºå®šçš„æ¡æ•°ï¼Œæ€§èƒ½å¯æ§ã€‚
2. æ— é™æ»šåŠ¨ï¼šåˆå§‹åŠ è½½ä¸€å°éƒ¨åˆ†ï¼Œè¶Šæ»šåŠ¨åŠ è½½è¶Šå¤šã€‚è¿™ç§å‡ºç°æ€§èƒ½é—®é¢˜åªæ˜¯æ—¶é—´é—®é¢˜ã€‚
3. è™šæ‹Ÿæ»šåŠ¨ã€‚

ç¬¬ä¸€ä¸ªåˆ†é¡µåŠ è½½ä¸åœ¨ä»Šå¤©çš„è®¨è®ºèŒƒç•´ï¼Œè¿™é‡Œå°±2ã€3ä¸¤ç‚¹å¼€å§‹è°ˆè®ºã€‚

## 1. æ‡’åŠ è½½

å¯¹äºæ•°æ®å¾ˆå¤šçš„åˆ—è¡¨ï¼Œä¸€å¼€å§‹ç•Œé¢åˆå§‹åŒ–çš„æ—¶å€™è‚¯å®šä¸èƒ½æŠŠå…¨éƒ¨æ•°æ®éƒ½å¡åœ¨åˆ—è¡¨é‡Œï¼Œå…ˆåˆ«è¯´å‰ç«¯èƒ½ä¸èƒ½æ’‘å¾—ä½ï¼Œåç«¯æŸ¥è¯¢æ—¶é•¿éƒ½è¦çˆ†ç‚¸ã€‚

æœ€å¸¸è§çš„å°±æ˜¯æ‰‹æœºç«¯çš„å•†å“åˆ—è¡¨ï¼Œå¦‚ä¸‹å›¾ï¼š

![WechatIMG102.jpeg](/img/posts/2022-8-23/2022-8-23-2.png)

è®¾ç½®ä¸€ä¸ªå†…éƒ¨å¯æ»šåŠ¨çš„å®¹å™¨ï¼Œå›ºå®šé«˜åº¦ï¼Œé€šè¿‡è®¡ç®— `scrollheight` ä¸ `scrollTop` çš„å·®å€¼ä¸å®¹å™¨çš„é«˜åº¦å°±å¯çŸ¥é“æ˜¯å¦æ»šåŠ¨åˆ°äº†åº•éƒ¨ï¼š


```jsx
// htmlä¸­cssè®¾ç½®containeré«˜åº¦ 500px
<div class="container">
    <div class="item">1</div>
    <div class="item">2</div>
    <div class="item">3</div>
    ...
</div>

// js
const container = document.querySelector('.container');

container.addEventListener('scroll', () => {
  const offset = container.scrollHeight - container.scrollTop;
  const delta = 50;
  
  console.log(offset)

  if (offset <= (500 + delta)) {
    // å¯ä»¥è®¾ç½®æ»šåŠ¨é”ï¼Œé”å®šæ»šåŠ¨ç›‘å¬
    const newDom = document.createElement('div');
    newDom.setAttribute('class', 'item');
    newDom.innerText = 'æˆ‘æ˜¯æ–°åŠ çš„';
    container.appendChild(newDom)
  }
})
```


åœ¨ç”¨æˆ·æ»šåŠ¨åˆ°æœ€ä¸‹è¾¹è‡ªåŠ¨ç›‘å¬æ»šåŠ¨äº‹ä»¶åï¼Œè‡ªåŠ¨åŠ è½½å›ºå®šæ•°ç›®çš„å†…å®¹æˆ–è€…æç¤º "åŠ è½½æ›´å¤š" æ¥è®©ç”¨æˆ·ç‚¹å‡»åŠ è½½ã€‚å¦‚ä¸‹è¾¹çš„ç¤ºæ„å›¾æ‰€ç¤ºï¼Œå·²ç»æ»šåˆ°åº•åï¼ŒscrollHeight - scrollTop çš„è®¡ç®—å€¼å°±æ˜¯è§†çª—é«˜åº¦çš„ 500px äº†ï¼š

![image.png](/img/posts/2022-8-23/2022-8-23-3.png)


ä¸Šé¢ç»™å‡ºäº†ç®€æ˜“å®ç°åŸç†ï¼Œè¿™é‡Œåªæ¢è®¨æ–¹æ¡ˆå®ç°ï¼Œå…·ä½“å®ç°å¯åŠ æ»šåŠ¨é”æˆ–è€…å»¶æ—¶æ¥é˜²æ­¢è¿‡å¿«æ·»åŠ å…ƒç´ ã€‚å¯ä»¥çœ‹åˆ°è¿™é‡Œè®¾ç½®äº†ä¸€ä¸ª $delta$ åç§»å€¼ 50 åƒç´ ï¼Œåœ¨æ»šåŠ¨åˆ°è·åº•éƒ¨ 50 åƒç´ æ—¶è§¦å‘å…ƒç´ æ’å…¥ã€‚

> æ»šåŠ¨é”å…¶å®å°±æ˜¯ä¸€ä¸ªå®šæ—¶å™¨ï¼Œå¼€å§‹æ»šåŠ¨æ—¶å®šæ—¶å™¨å¼€å§‹è®¡æ—¶ï¼Œåœ¨è®¡æ—¶æœŸé—´å¯ä»¥å–æ¶ˆè®¢é˜… scroll äº‹ä»¶æˆ–è€…ç¦ç”¨äº‹ä»¶å›è°ƒé€»è¾‘ï¼Œè®¡æ—¶ç»“æŸåæ‰§è¡Œä¸€æ¬¡æ¸²æŸ“åˆ—è¡¨çš„è®¡ç®—ã€‚

- ä¼˜ç‚¹

å®ç°ç›¸å¯¹ç®€å•ï¼Œä¸éœ€è¦é¢å¤–å¼•å…¥ç±»åº“ã€‚ä¸ç”¨è€ƒè™‘æ¯ä¸€ä¸ª item çš„é«˜åº¦æœ‰å¤šå°‘ã€‚

- ç¼ºç‚¹ 

1. é¢‘ç¹ä¸‹æ‹‰ï¼Œä¼šé€ æˆæ»šåŠ¨æ¡è¶Šæ¥è¶ŠçŸ­ï¼Œä½¿å¾—æ•°æ®å±•ç¤ºæ˜¾å¾—è‡ƒè‚¿ï¼›
2. å·²ç»åŠ è½½è¿‡çš„æ»šåŠ¨éšè—åŒºåŸŸçš„æ•°æ®å¹¶æ²¡æœ‰åšæ¸²æŸ“ä¸Šçš„å¤„ç†ï¼›
3. å…¨å±€æœç´¢æˆ–é¡µé¢å›é€€åå†æ¬¡è¿›æ¥æŸ¥çœ‹åˆ—è¡¨ï¼Œæ»šåŠ¨çŠ¶æ€ä¼šä¸¢å¤±ï¼›


## 2. IntersectionObserver + ç©ºdivå ä½

é¡¾åæ€ä¹‰ï¼Œè¿™ç§æ–¹å¼æ˜¯ä½¿ç”¨ç©ºçš„divå ä½éšè—åŒºåŸŸä¹‹å¤–çš„å…ƒç´ ï¼Œè¿™ç§å¾€å¾€å¯ä»¥å’Œç¬¬ä¸€ä¸ªæ–¹æ¡ˆç»„åˆä½¿ç”¨ã€‚è¿˜æ˜¯ä¸Šé¢çš„ä¾‹å­ï¼š

```js
const container = document.querySelector('.container');
const items = Array.from(container.children) || [];

items.forEach(item => {
  const intersectionObserver = new IntersectionObserver(
    function (entries) {
      // å¦‚æœä¸å¯è§ï¼Œå°±è¿”å›
      if (!entries[0].isVisible) {
        entries[0].target.backup = entries[0].target.innerHTML || entries[0].target.backup;
        entries[0].target.innerHTML = '';
        return;
      }

      // åœ¨å¯è§†åŒºåŸŸ
      entries[0].target.innerHTML = 
      entries[0].target.backup || entries[0].target.innerHTML;
    },
    {
      threshold: [0, 1],
      /* required options*/
      trackVisibility: true,
      delay: 100  
    });

  // å¼€å§‹è§‚å¯Ÿ
  intersectionObserver.observe(item);
})
```
æˆ‘è¿™é‡Œè®¾ç½® IntersectionObserver çš„é…ç½®å±æ€§thresholdä¸º `[0, 1]`ï¼Œè¡¨ç¤ºå®Œå…¨å¯è§å’Œå®Œå…¨ä¸å¯è§æ—¶æ‰å‡ºå‘å›è°ƒã€‚é€šè¿‡åˆ¤æ–­ `isVisible` å±æ€§æ¥æ§åˆ¶ `innerHTML` æ˜¾ç¤ºå†…å®¹ã€‚è¿™é‡Œä½ éœ€è¦ä¸€ä¸ªç¼“å­˜çš„mapï¼ˆæˆ‘è¿™é‡Œå­˜åœ¨äº†domçš„backupé‡Œï¼‰ï¼Œåœ¨å¯è§†æ—¶ï¼Œæ¢å¤ `innerHTML` çš„å€¼ã€‚

è¿™æ ·åœ¨æ»šåŠ¨æ—¶æˆ‘ä»¬å†çœ‹çœ‹domç»“æ„ï¼š

![image.png](/img/posts/2022-8-23/2022-8-23-4.png)

å¯ä»¥çœ‹åˆ°ï¼Œä¸æ˜¾ç¤ºçš„åŒºåŸŸå·²ç»ç½®ä¸ºäº†ç©ºçš„diväº†ã€‚


- ä¼˜ç‚¹
1. ä½¿ç”¨åŸç”Ÿçš„H5 APIï¼Œå…¼å®¹æ€§å¥½ï¼›
2. ç»“åˆç¬¬ä¸€ç§æ–¹æ¡ˆï¼Œå¯ç›‘å¬åº•éƒ¨å…ƒç´ æ˜¯å¦å¯è§æ¥å®ç°æ— é™æ»šåŠ¨ï¼Œå®ç°ç®€å•ï¼›
3. æ²¡æœ‰domæ’å…¥åˆ é™¤æ“ä½œï¼Œå¼€é”€æ¯”è¾ƒå°ï¼Œä¸ç ´ååŸæœ‰çš„ç»“æ„ï¼›
4. ç©ºçš„divå ä½å¯ä»¥ä½¿æ»šåŠ¨æ¡çš„é«˜åº¦ä¸ä¼šè·³å˜ï¼›

- ç¼ºç‚¹
1. å°±ç®—æ˜¯ç©ºçš„divï¼Œä¹Ÿè¿˜æ˜¯ä¼šé€ æˆæ¸²æŸ“æµªè´¹ï¼›
2. ç¼“å­˜mapé€ æˆç©ºé—´æµªè´¹ï¼Œç»´æŠ¤æˆæœ¬æé«˜ï¼›
3. æ— é™æ»šåŠ¨å¤ªé¢‘ç¹ï¼Œæ»šåŠ¨æ¡è¿˜æ˜¯ä¼šç¼©ä¸ºä¸€ä¸ªç‚¹ï¼›
4. å ä½divçš„é«˜åº¦å›ºå®šäº†ï¼Œå°±æ„å‘³ç€itemçš„é«˜åº¦éœ€è¦å›ºå®šï¼›

## 3. æ•°æ®æˆªæ–­å¼å ä½

è¿™ç§æ–¹æ¡ˆå¯ä»¥çœ‹åšæ˜¯ç¬¬äºŒç§æ–¹æ¡ˆçš„å‡çº§ç‰ˆã€‚å…¶ä¸ä½¿ç”¨å°çš„divå ä½ï¼Œè€Œæ˜¯åœ¨åˆ—è¡¨å¼€å¤´å’Œç»“å°¾ï¼Œåˆ†åˆ«ç”¨ä¸¤ä¸ªå¤§çš„divå ä½ï¼Œè¾¾åˆ°æ•°æ®æˆªæ–­çš„æ•ˆæœã€‚æˆ‘ä»¬çœ‹è‰å›¾ï¼š

![1071661234958_.pic.jpg](/img/posts/2022-8-23/2022-8-23-5.png)

`startIndex` å’Œ `endIndex` å°±æ˜¯æ•°æ®æ•°ç»„ä¸­çš„çœŸå®ä¸‹æ ‡ä½ç½®ï¼Œæ‰€ä»¥è¦æ›¿æ¢çš„åŒºé—´æ˜¯ $[0, startIndex) âˆª (endIndex, children.length - 1]$ã€‚æˆ‘ä»¬è¦åšçš„å°±æ˜¯æŠŠ startIndex ä¹‹å‰å’Œ endIndex ä¹‹åçš„éƒ¨åˆ†æ›¿æ¢ä¸ºdivã€‚è¿™é‡Œå› ä¸ºè¦ç”¨åˆ° scroll å±æ€§ï¼Œæ‰€ä»¥è¿˜æ˜¯ç”¨ scroll äº‹ä»¶æ¥ç›‘å¬ï¼ŒåŒæ—¶ç‰µæ‰¯åˆ°domç»“æ„çš„å˜åŠ¨ï¼Œæ‰€ä»¥è¿˜æ˜¯ä½¿ç”¨jsæ¥æ“ä½œdomã€‚

å…ˆå®šä¹‰å®¹å™¨ï¼š

```html
// cssä¸æ˜¯é‡ç‚¹ï¼Œå¿½ç•¥
<div class="container"></div>
```
å®šä¹‰æ•°æ®å¹¶è·å–å…ƒç´ ï¼š
```js
const data = [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20];
const container = document.querySelector('.container');
```
æ¥ä¸‹æ¥å®šä¹‰ä¸€ä¸‹æ·»åŠ åˆ—è¡¨çš„æ–¹æ³•ï¼š

```js
function addList(data, container) {
  data.forEach(item => {
    const dom = document.createElement('div');
    dom.setAttribute('class', 'item');
    dom.innerHTML = item;
    container.appendChild(dom)
  });
}
```

å®šä¹‰æ»šåŠ¨äº‹ä»¶ç›‘å¬ï¼ˆå¯åŠ å…¥æ»šåŠ¨é”æˆ–è€…èŠ‚æµä¼˜åŒ–ï¼‰ï¼š

```js
container.addEventListener('scroll', () => {
  const scrollTop = container.scrollTop;

  // ä¸Šè¾¹ç©ºç™½çš„é«˜åº¦
  const topHeight = scrollTop;
  const startIndex = Math.max(Math.ceil(topHeight / 40) - 2, 0);
  const endIndex = startIndex + Math.ceil(500 / 40);

  const show = data.slice(startIndex, endIndex + 1);

  // è®¡ç®—ä¸‹è¾¹å‰©ä½™çš„éšè—åŒºåŸŸé«˜åº¦
  const dataHeight = data.length * 40;
  const bottomHeight = dataHeight - 500 - scrollTop;

  const topDom = document.createElement('div');
  const bottomDom = document.createElement('div');
  topDom.style.height = topHeight + 'px';
  bottomDom.style.height = bottomHeight + 'px';

  // è¿˜æ²¡åˆ°åº•
  if (bottomHeight > -100) {
    // æ¸…ç©º
    container.innerHTML = '';
    container.appendChild(topDom);
    addList(show, container);
    container.appendChild(bottomDom);
  }
});
```
å¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œä¸èƒ½ä½¿ç”¨ container.scrollHeight æ¥è®¡ç®—é«˜åº¦äº†ï¼Œè¦é€šè¿‡æ•°æ®ä¹˜ä»¥æ¯ä¸€è¡Œé«˜åº¦è·å–ã€‚æœ€åçš„`bottomHeight > -100`æ˜¯ä¸ºäº†é¿å…å‡ºç°è®¡ç®—è´Ÿæ•°è€Œé€ æˆçš„é¡µé¢æŠ–åŠ¨ã€‚ï¼ˆå½“ç„¶ä½ ä¹Ÿå¯ä»¥å†™æ­»ä¸€ä¸ªé˜ˆå€¼ï¼Œé¡µé¢è¶³å¤Ÿé•¿æ—¶ï¼Œè¶…è¿‡è¿™ä¸ªé˜ˆå€¼ï¼Œé¦–å°¾ä¸¤ä¸ªdivé«˜åº¦å°±å®šæ­»ã€‚ï¼‰

æœ€ååœ¨é¡µé¢åˆå§‹åŒ–æ—¶åŠ è½½ä¸€æ¬¡åˆ—è¡¨ï¼š

```js
window.onload = function() {
    addList(data, container)
}
```
æœ€åæˆ‘ä»¬åœ¨é¡µé¢ä¸Šæ»šåŠ¨ä¸€ä¸‹çœ‹çœ‹æ•ˆæœï¼š

![image.png](/img/posts/2022-8-23/2022-8-23-12.png)
æˆåŠŸï¼ï¼

æ›´é‡è¦çš„æ˜¯ï¼Œè¿™ä¸ªæ–¹æ¡ˆå®Œç¾å¥‘åˆå•é¡µåº”ç”¨æ¡†æ¶ï¼Œæ‰€æœ‰çš„domæ“ä½œéƒ½å¯ä»¥ä½¿ç”¨æ¡†æ¶è¯­è¨€æ›¿ä»£ï¼Œæ¯”å¦‚ç”¨vueçš„v-for + è®¡ç®—å±æ€§å°±å¯ä»¥å®Œæˆã€‚ä¹‹å‰åœ¨bilibilié¢è¯•çš„æ—¶å€™ï¼Œå°±é—®äº†ä¸€ä¸‹æ˜¯å¦åšè¿‡è¿™ä¸ªæ–¹æ¡ˆğŸ˜‚ã€‚

- ä¼˜ç‚¹
1. é€šç”¨æ€§å¼ºï¼Œæ€§èƒ½æå‡æ˜æ˜¾
2. å¯ä»¥ä½¿ç”¨è™šæ‹Ÿdomç­‰æ¡†æ¶å®ç°
3. ä¸ç”¨æ‹…å¿ƒæ— é™æ»šåŠ¨åœºæ™¯ä¸‹æ»šåŠ¨æ¡ç¼©ä¸ºä¸€ä¸ªç‚¹ï¼Œå› ä¸ºä½ å®Œå…¨å¯ä»¥åŠ¨æ€æ§åˆ¶é¦–å°¾ä¸¤ä¸ªdivçš„é«˜åº¦ã€‚

- ç¼ºç‚¹
1. itemçš„é«˜åº¦å¾€å¾€éœ€è¦å›ºå®š
2. æ»šåŠ¨æ¡æŠ–åŠ¨éœ€è¦ç‰¹æ®Šå¤„ç†


## 4. CSS-`content-visibility`å®ç°å¯è§†åŒºåŸŸåˆ¤å®š

å…ˆæ¥çœ‹ä¸€ä¸‹caniuseçš„å…¼å®¹æ€§ï¼š

![image.png](/img/posts/2022-8-23/2022-8-23-6.png)

ä¸»æµçš„Chromeå’ŒEdgeå€’æ˜¯éƒ½æ”¯æŒã€‚ä»–æœ‰ä¸ª `auto` å±æ€§ï¼Œå…¶ä½œç”¨æ˜¯ï¼Œå¦‚æœè¯¥å…ƒç´ ä¸åœ¨å±å¹•ä¸Šï¼Œå¹¶ä¸”ä¸ç”¨æˆ·æ— å…³ï¼Œåˆ™ä¸ä¼šæ¸²æŸ“å…¶åä»£å…ƒç´ ã€‚

é‚£æˆ‘ä»¬å°±ä½¿ç”¨`content-visibility`æ¥å®ç°ä¸€ä¸‹è™šæ‹Ÿåˆ—è¡¨ã€‚

æˆ‘ä»¬å®šä¹‰domç»“æ„ï¼š

```html
<div class="container">
    <div class="item">
      <ul>
        <li>23423</li>
        <li>23423</li>
        <li>23423</li>
        <li>23423</li>
      </ul>
    </div>
    ... è‚¥è‚ å¤šæ•°æ®åœ¨è¿™é‡Œ
</div>
```

æˆ‘ä»¬æ·»åŠ åˆ°100Wè¡Œï¼Œçœ‹ä¸€ä¸‹æ¸²æŸ“æ—¶é—´ï¼š

![image.png](/img/posts/2022-8-23/2022-8-23-13.png)

æˆ‘ä»¬æ·»åŠ åˆ°400Wè¡Œï¼š

![image.png](/img/posts/2022-8-23/2022-8-23-7.png)
ç›´æ¥å¡æ­»ï¼Œç§’æ€CPUï¼

![image.png](/img/posts/2022-8-23/2022-8-23-8.png)

æ­¤æ—¶åŠ ä¸Šä¸€æ®µcssï¼š
```css
.itemÂ {
Â Â Â Â content-visibility:Â auto;
}
```
100Wæ¡æ—¶ï¼š

![image.png](/img/posts/2022-8-23/2022-8-23-9.png)
å¯ä»¥çœ‹åˆ°ï¼Œå¯¹äºæ•°æ®é‡å¤§çš„åˆ—è¡¨ï¼Œä¼˜åŒ–çš„æ•ˆæœå¾ˆæ˜æ˜¾ã€‚

400Wè¡Œæ—¶å‹‰å¼ºèƒ½çœ‹åˆ°åˆ—è¡¨ï¼Œä½†æ˜¯è¿˜æ˜¯å¡ï¼š

![image.png](/img/posts/2022-8-23/2022-8-23-10.png)
çœ‹æ¥æ•°æ®è¶³å¤Ÿå¤šæ—¶ï¼Œå·²ç»ä¸æ˜¯ä¼˜åŒ–èƒ½å¤„ç†çš„äº†ã€‚

å…¶å®ç°åŸç†ï¼Œå…¶å®è¿˜æ˜¯å±äºæ‡’åŠ è½½ï¼Œä¸åœ¨è§†å£åŒºåŸŸçš„åœ°æ–¹å°±ä¸æ¸²æŸ“ï¼Œåªä¸è¿‡æ˜¯cssé…ç½®åè®©æµè§ˆå™¨å¸®æˆ‘ä»¬åšäº†ã€‚æ­¤æ—¶å°±æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œä¸‹æ‹‰æ»šåŠ¨æ—¶ï¼Œçªç„¶å‡ºç°äº†ä¸€äº›æ•°æ®ï¼Œæ»šåŠ¨æ¡å¿…ç„¶ä¼šæŠ–åŠ¨ï¼Œæ­¤æ—¶åœ¨é…ç½®ä¸€ä¸ªcsså±æ€§å³å¯ï¼š
```css
.itemÂ {
Â Â Â Â contain-intrinsic-size:Â 120px;
}
```
è¿™æ ·ï¼Œæµè§ˆå™¨å°±ä¼šçŸ¥é“æ¯ä¸€è¡Œçš„é«˜åº¦ï¼Œä¼šè‡ªåŠ¨æ’‘å¼€æ»šåŠ¨åŒºåŸŸã€‚

- ä¼˜ç‚¹
1. ä¸å½±å“ç½‘é¡µå…¨å±€æœç´¢
2. ä½¿ç”¨ç®€å•ï¼Œçº¯css

- ç¼ºç‚¹
1. æœªåœ¨è§†çª—åŒºåŸŸçš„å¼‚æ­¥èµ„æºè¿˜æ˜¯ä¼šè¢«åŠ è½½
2. ä¸»æµæµè§ˆå™¨å…¼å®¹æ€§å·®ï¼Œæ…ç”¨


## 5. æ€»ç»“

ç»¼ä¸Šæ‰€è¿°ï¼Œå…³äºwebé•¿åˆ—è¡¨æ»šåŠ¨æ€§èƒ½ä¼˜åŒ–çš„ç®—æ³•ï¼Œè¦ä¹ˆæ˜¯æ¸…é™¤ä¸å¯è§åŒºåŸŸçš„domå…ƒç´ ï¼Œè¦ä¹ˆæ˜¯ç”¨æ›´ç®€å•çš„å…ƒç´ æ›¿æ¢ä¹‹ï¼Œå…¶ç›®çš„æ— éå°±æ˜¯ä¸ºäº†èƒ½å¤Ÿè®©æµè§ˆå™¨çš„æ¸²æŸ“å‹åŠ›å°ä¸€ç‚¹ã€‚

å›åˆ°ä¸€å¼€å§‹ã€‚`æˆ‘ä»¬åœ¨æŠ€æœ¯é€‰å‹æ—¶ï¼Œåˆ°åº•è¦ä½¿ç”¨åˆ†é¡µå‘¢ï¼Œè¿˜æ˜¯é•¿æ»šåŠ¨å‘¢ï¼Ÿ`ä½œè€…å»ºè®®è¦è§†æƒ…å†µè€Œå®šï¼Œæ¯”å¦‚æ‰‹æœºç«¯çš„H5å°±ä¸é€‚åˆåˆ†é¡µï¼Œåˆ†é¡µæ“ä½œåœ¨å°ç©ºé—´å†…ä¸å‹å¥½ï¼Œé€‚åˆPCç«¯åº”ç”¨ã€‚æ— é™æ»šåŠ¨å‘¢ï¼Œé€‚ç”¨èŒƒå›´æ¯”è¾ƒå¹¿ï¼Œæ¯”å¦‚bilibiliä¸»ç«™PCç«¯çš„è¯„è®ºåˆ—è¡¨ï¼Œå°±æ˜¯æ— é™+è™šæ‹Ÿæ»šåŠ¨ï¼ˆå½“ç„¶bç«™ä¹Ÿåšäº†éƒ¨åˆ† åˆ†é¡µå¼ çš„ï¼‰ï¼›ä½†æ˜¯ï¼Œæ— é™æ»šåŠ¨å¯¹äºæœç´¢ä¸å‹å¥½ï¼Œæœç´¢ç»“æŸåæ‰¾ä¸åˆ°æ»šåŠ¨çš„ä½ç½®äº†ï¼Œè¿˜å¾—é‡æ–°æ»šï¼Œå“ˆå“ˆï¼åŒæ—¶æ— é™æ»šåŠ¨å¯¹äºå„ä¸ªæ¡ç›®é«˜åº¦ç›¸å·®è¿‡å¤§çš„åœºæ™¯ä¹Ÿä¸é€‚åˆã€‚

> ä¸‹å›¾ä¸­ï¼Œbç«™è¯„è®ºåˆ—è¡¨çš„äºŒçº§è¯„è®ºï¼Œå±•å¼€åä¾¿æ˜¯åˆ†é¡µçš„


![image.png](/img/posts/2022-8-23/2022-8-23-11.png)

è¯´å¥é¢˜å¤–è¯ï¼Œå‡ ä¹æ‰€æœ‰çš„æ€§èƒ½ä¼˜åŒ–ç­–ç•¥ï¼Œéƒ½æ˜¯å—äº†ç°é˜¶æ®µæœ‰é™èµ„æºçš„é™åˆ¶ã€‚æƒ³å½“å¹´2Gæ—¶ä»£ï¼Œä¸€ä¸ªæœˆå¥—é¤åŒ…20MBéƒ½å·²ç»è§‰å¾—å¾ˆå¤§äº†ï¼Œæ‰‹æœºåˆ·ä¸€ä¸ªQQå®¶å›­ä»€ä¹ˆçš„éƒ½å¾ˆå¤Ÿç”¨ï¼Œé‚£ä¸ªæ—¶å€™ä¹Ÿæ²¡è§‰å¾—ç½‘é¡µæ…¢ã€‚ç„¶è€Œç°åœ¨ä¸»æµæµè§ˆå™¨éƒ½è‡ªå¸¦å¾ˆå¤šæ€§èƒ½ä¼˜åŒ–äº†ï¼Œä½†æ˜¯ä¼¼ä¹å¤§å®¶ä»ç„¶ä¸æ»¡è¶³\[â”“(Â Â´âˆ€`Â )â”\]ã€‚

éšç€æ—¶ä»£çš„è¿›æ­¥ï¼Œè®¡ç®—æœºç®—åŠ›è¿˜ä¼šæå‡ï¼Œåˆ°æ—¶å€™ç›®å‰çš„å‰ç«¯æ€§èƒ½ä¼˜åŒ–å¯èƒ½å°±æ²¡æœ‰æ„ä¹‰äº†ã€‚ä½†æ˜¯ç°åœ¨æ˜¾ç„¶è¿˜æ²¡åˆ°é‚£ä¸€æ­¥ã€‚

å¾ˆå¤šå¹´ä»¥åï¼Œæˆ‘ä»¬å¯èƒ½ä¼šç»™è¿™ä¸ªæ—¶ä»£å–ä¸ªåå­—ï¼Œå«â€œäº’è”ç½‘æ–°çŸ³å™¨æ—¶ä»£â€ã€‚è¿™ä¸ªæ—¶ä»£é‡Œï¼Œå®ç°ä¸€ä¸ªç¨‹åºéœ€è¦ä¸€ç¾¤å†™ä»£ç çš„äººå¥½å‡ ä¸ªæœˆçš„æŠ•å…¥ï¼Œä»£ç è´¨é‡å› äººè€Œå¼‚ï¼Œç»´æŠ¤èµ·æ¥ä¹Ÿå›°éš¾ï¼Œè¿ç»´æˆæœ¬ä¹Ÿé«˜ï¼Œè‡ªåŠ¨åŒ–ç¨‹åº¦è¿‡ä½ï¼Œå¤§å¤šæ•°ä»£ç çš„ç”Ÿå‘½å‘¨æœŸä¸è¶…è¿‡5å¹´ã€‚ä»–ä»¬èµ„æºæœ‰é™ï¼Œå¤©å¤©åœ¨ä¸ºèŠ‚çœå¸¦å®½å’Œå­˜å‚¨ç©ºé—´è€Œå‘æ„ï¼Œé‚£ä¸ªæ—¶ä»£ï¼Œè¢«è¿«æ€§èƒ½ä¼˜åŒ–åå€’æˆäº†ç¨‹åºå‘˜å¿…å¤‡çš„æŠ€èƒ½äº†ã€‚

å®Œï¼

<hr />

## 6. é™„è¨€

ä¸‹é¢å°±æ€»ç»“ä¸€ä¸‹ä¸»æµå‰ç«¯æ¡†æ¶çš„ä½¿ç”¨ï¼ˆ å†…éƒ¨åŸç†è‡ªå·±çœ‹æºç å»ï¼ŒåŸç†éƒ½è®²äº†ï¼Œä»£ç è¿˜ä¸æƒ³è‡ªå·±å†™ï¼Œå¯æ˜¯ä¸ä¼šè¿›æ­¥çš„å‘¦~~ ï¼‰ï¼š

### vue-virtual-scroll-list

å¼•å…¥ï¼š
```js
import VirtualList from 'vue-virtual-scroll-list'
```
ä½¿ç”¨ï¼š
```jsx
<virtual-list style="height: 360px; overflow-y: auto;" // make list scrollable
  :data-key="'uid'"
  :data-sources="items"
  :data-component="itemComponent"
/>
...

export default {
    name: 'root',
    data () {
      return {
        itemComponent: Item,
        items: [{uid: 'unique_1', text: 'abc'}, {uid: 'unique_2', text: 'xyz'}, ...]
      }
    },
    components: { 'virtual-list': VirtualList }
}

// Itemæ˜¯æ¸²æŸ“ç»„ä»¶ï¼Œæ¥å—indexå’Œsourceå±æ€§
```

å®˜ç½‘åœ°å€ï¼š[vue-virtual-scroll-list](https://github.com/tangbc/vue-virtual-scroll-list#live-demo)

### React-window

å¼•å…¥ï¼š

```js
import { FixedSizeList as List } from 'react-window';
```
ä½¿ç”¨ï¼š

```jsx
const Column = ({ index, style }) => (
  <div style={style}>Column {index}</div>
);

const Example = () => (
  <List
    height={75}
    itemCount={1000}
    itemSize={100}
    layout="horizontal"
    width={300}
  >
    {Column}
  </List>
);
```

å®˜ç½‘åœ°å€ï¼š[react-window](https://react-window.vercel.app/#/examples/list/fixed-size)

### Angular-cdk

å¼•å…¥ï¼š(å‰ææ˜¯å¼•å…¥cdkçš„module)

```js
import {ChangeDetectionStrategy, Component} from '@angular/core';

/** @title Basic virtual scroll */
@Component({
  selector: 'cdk-virtual-scroll-overview-example',
  styleUrls: ['cdk-virtual-scroll-overview-example.css'],
  templateUrl: 'cdk-virtual-scroll-overview-example.html',
  changeDetection: ChangeDetectionStrategy.OnPush,
})
export class CdkVirtualScrollOverviewExample {
  items = Array.from({length: 100000}).map((_, i) => `Item #${i}`);
}
```
ä½¿ç”¨ï¼š
```html
<cdk-virtual-scroll-viewport itemSize="50" class="example-viewport">
  <div *cdkVirtualFor="let item of items" class="example-item">{{item}}</div>
</cdk-virtual-scroll-viewport>
```

å®˜ç½‘åœ°å€ï¼š[Angular-CDK](https://v7.material.angular.io/cdk/scrolling/overview)

<hr/>

That's all ï¼72:T14d4,## 1. å‰è¨€

æˆ‘ä»¬ç»§ç»­æˆ‘ä»¬çš„ React ç»„ä»¶åº“ç³»åˆ—ã€‚æœ¬ç¯‡ä»‹ç»å¦ä¸€ç§å¼¹å‡ºå±‚ - æ¨¡æ€æ¡†ç»„ä»¶ã€‚æœ¬æ–‡çš„ä»£ç å±•ç¤ºçš„æ˜¯ä¸»è¦çš„æ ¸å¿ƒä»£ç ï¼Œå…¨éƒ¨ä»£ç è§ä»“åº“ï¼š[Giteeä»“åº“](https://link.juejin.cn/?target=https%3A%2F%2Fgitee.com%2Fdh1992%2Fdux-ui-react%2F)ï¼Œç»„ä»¶æ ·å¼è§[ä¸»é¡µ](https://link.juejin.cn?target=https%3A%2F%2Fdh1992.gitee.io%2Fdux-ui-react%2F)ã€‚

æ¨¡æ€æ¡†å’Œä¸Šä¸€æœŸè®²çš„popoverç±»ä¼¼ï¼Œä¹Ÿæ˜¯å¼¹å‡ºå±‚ç»„ä»¶ã€‚ä¸åŒçš„æ˜¯ï¼Œæ¨¡æ€æ¡†ä¸éœ€è¦é€šè¿‡triggerè§¦å‘ï¼Œé€šè¿‡ç›‘å¬ä¼ å…¥çš„ `visible` å‚æ•°å³å¯ç¡®å®šæ˜¾ç¤ºè¿˜æ˜¯éšè—ã€‚

## 2. å®šä¹‰å…¥å‚

ä¸€ä¸ªå¼¹çª—ï¼Œä¸€èˆ¬éœ€è¦ä¸€ä¸ªtitleï¼Œä¸€ä¸ªç»“å°¾çš„æŒ‰é’®æ”¾ç½®åŒºfooterã€‚è¿˜æœ‰å¼¹çª—çš„å°ºå¯¸sizeï¼ŒèƒŒæ™¯åŒºåŸŸçš„é®ç½©maskï¼Œæœ€åè¿˜æœ‰æ˜¾ç¤ºå‚æ•°visibleä»¥åŠå¼¹çª—çš„å„ç§äº‹ä»¶ï¼š

| å±æ€§              | è¯´æ˜         |
| --------------- | ---------- |
| visible         | å—æ§ï¼Œæ§åˆ¶å¼¹å‡ºå±‚å±•ç¤º |
| title       | æ ‡é¢˜       |
| footer | è„šæ³¨       |
| size           | æšä¸¾å‡ºå†…ç½®çš„å°ºå¯¸     |
| mask          | æ˜¯å¦æ˜¾ç¤ºé®ç½©         |
| visible  | æ§åˆ¶æ˜¾ç¤º      |
| onClose | ç‚¹å‡»å…³é—­æŒ‰é’®çš„ç›¸åº”äº‹ä»¶ |
| onOk | ç‚¹å‡»ç¡®å®šæŒ‰é’®çš„ç›¸åº”äº‹ä»¶ |
| afterClose | å…³é—­ä¹‹åçš„äº‹ä»¶å›è°ƒ |

## 3. rc-dialog å°è£…

è¿™å¯¹å®šåˆ¶åŒ–å¼¹çª—ç»„ä»¶ï¼Œä½¿ç”¨rc-triggerä¼¼ä¹æœ‰äº›åŠ›ä¸ä»å¿ƒï¼Œrc-triggeré‡ç‚¹åœ¨äºå¤„ç†è§¦å‘çš„æ—¶æœºï¼Œå¼¹å‡ºå±‚è·Ÿéšç‚¹å‡»ä½ç½®ï¼Œé€‚åˆè½»é‡çº§çš„å¼¹å‡ºå±‚ï¼›æ¨¡æ€æ¡†é‡ç‚¹åœ¨äºå¤„ç†å†…å®¹å±•ç¤ºï¼Œéœ€è¦æ›´å¥½çš„å±•ç¤ºçº§çš„åº“æ¥æ”¯æŒã€‚

è¿™é‡Œä½¿ç”¨ä¸“ç”¨çš„rc-dialogï¼š

```jsx
class RcDialogWrap extends Component {
  static propTypes = {
    className: PropTypes.string,
    wrapClassName: PropTypes.string,
  };
  render() {
    const { className, wrapClassName, ...rest } = this.props as any;
    return (
      <RcDialog
        wrapClassName={classnames(className, wrapClassName)}
        {...rest}
      />
    );
  }
}
```
`className` ä¸ºå¼¹çª—å†…å®¹æ ·å¼ç±»åï¼Œ`wrapClassName` ä¸ºå¼¹çª—å®¹å™¨æ ·å¼ç±»åã€‚

æˆ‘ä»¬è‡ªå·±å®šä¹‰çš„å¼¹çª—ï¼Œè‚¯å®šéœ€è¦æ¯”rc-dialogæ›´å¤šçš„å‚æ•°å’ŒåŠŸèƒ½ï¼Œå› æ­¤æˆ‘å†ä½¿ç”¨ModalWrapåŒ…è£¹ä¸€ä¸‹åˆšåˆšçš„ç»„ä»¶ï¼š


```js
export const ModalWrap = styleWrap()(
  styled(RcDialogWrap)((props) => {
    const {
      theme: { designTokens: DT, fontSize },
      mask,
      customStyle,
    } = props as any;
    
    return css`
    
      // å¼¹çª—å®¹å™¨
      position: fixed;
      overflow: auto;
      top: 0;
      right: 0;
      bottom: 0;
      left: 0;
      z-index: 1010;
      -webkit-overflow-scrolling: touch;
      outline: 0;
    
      ...
    `
  })
);
```

å¯ä»¥çœ‹åˆ°ï¼Œæ•´ä¸ªå¼¹çª—ä½¿ç”¨fixedå®šä½ï¼Œå¹¶ä¸”å±…ä¸­æ”¾ç½®ï¼Œz-indexè®¾ç½®æ¯”è¾ƒå¤§ï¼Œç¡®ä¿åœ¨æœ€é¡¶å±‚å³å¯ã€‚

æˆ‘ä»¬å†æ¥çœ‹çœ‹ ModalWrapæ˜¯æ€ä¹ˆä½¿ç”¨çš„ï¼š


```jsx
...
<ModalWrap
  // é»˜è®¤çš„ä¸€äº›ç›´ä¼ å±æ€§ï¼Œæ¯”å¦‚ visible ç­‰
  {...rest}
  style={{
    // æ¥å—è‡ªå®šä¹‰çš„widthæ ·å¼
    width: width,
    ...style,
  }}
  // prefixClsä¸ºç»„ä»¶åº“å‰ç¼€ï¼Œè¿™é‡Œä¸º dux-ui-modal
  prefixCls={prefixCls}
  // è¿™é‡Œç¦ç”¨rc-dialogè‡ªå¸¦çš„å…³é—­æŒ‰é’®
  closable={false}
  // ä¼ é€’rc-dialogå¯è¯†åˆ«çš„åŠ¨ç”»
  animation="slide-fade"
  maskAnimation="fade"
  onClose={onClose}
  title={[
    <div key="content" className={`${prefixCls}-title-content`}>
      {title}
    </div>,

    closable && (
      <Icon
        key="close"
        type="remove_circle"
        className={`${prefixCls}-close`}
        onClick={onClose}
      />
    ),
  ]}
  // ä½¿ç”¨äº†lodashï¼š_
  footer={_.isFunction(footer) ? footer({ locale }) : footer}
>
  // è·å–ref
  <div ref={this.savePopupContainer}></div>
  // å†…å®¹ç‰©
  {children}
</ModalWrap>
```

æˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹ä¸Šé¢çš„ä»£ç ã€‚

- animation å’Œ maskAnimation ä¸ºç›´ä¼ ç»™ rc-dialog çš„åŠ¨ç”»é…ç½®é¡¹ï¼›
- onClose æ˜¯å…³é—­äº‹ä»¶ï¼Œç”±propsä¼ å…¥
- title å°è£…äº†ä¼ å…¥çš„ title å…ƒç´ å’Œ å…³é—­æŒ‰é’®Iconï¼Œå¹¶ä»˜ç»™å…³é—­äº‹ä»¶onClose
- footer ä¹Ÿæ˜¯ç›´ä¼ å‚æ•°ã€‚å¯è‡ªå®šä¹‰ï¼ŒåŒæ—¶ä¹Ÿå†…ç½®äº†ä¸€ç»„æ“ä½œè„šæ³¨ï¼š

```js
getDefaultFooter = () => {
    const { onOk, onClose, locale } = this.props as any;
    return [
      <Button size="lg" key="cancel" onClick={onClose} style={{ marginRight: 8 }}>
        {locale.cancel}
      </Button>,
      <Button size="lg" key="confirm" onClick={onOk} styleType="primary">
        {locale.confirm}
      </Button>,
    ];
};
```

å¤–å£³å’Œäº‹ä»¶å¤„ç†çœ‹å®Œäº†ï¼Œå†çœ‹çœ‹å†…å®¹ç‰© children æ˜¯æ€ä¹ˆå¤„ç†çš„ã€‚æˆ‘ä»¬ä¸ºäº†ä½¿ç”¨ä¾¿åˆ©ï¼Œå¯¹ç”¨æˆ·æš´éœ²å‡ºä¸€ä¸ªå†…ç½®çš„modal content ç»„ä»¶ï¼Œå…¶å®å°±æ˜¯ä¸€ä¸ªåŠ äº†æ ·å¼çš„ divï¼š


```jsx
export const SContent = styleWrap({ className: contentCls })(
  styled.div((props) => {
    const { maxHeight } = props as any;
    return css`
      padding: 16px 20px;
      overflow: auto;
      max-height: ${maxHeight};
    `;
  }),
);
```

## 4. ä¸€ä¸ªğŸŒ°

æˆ‘ä»¬æ¥ä½¿ç”¨ä»¥ä¸‹åˆšåˆšå†™å¥½çš„ç»„ä»¶ï¼š


```jsx
...
const props = {
    visible: true
}
<Modal
    {...props}
    onClose={() => this.close()}
    afterClose={() => console.log('afterClose')}
    onOk={() => console.log('onOk')}
    title="this is title"
>
    <Modal.Content>this is content</Modal.Content>
</Modal>
```

ç•Œé¢å¦‚ä¸‹ï¼š


![image.png](/img/posts/2022-6-28/2022-6-28-1.png)

---

æ¨¡æ€æ¡†ç›¸å¯¹æ¯”è¾ƒç®€å•ï¼Œæœ¬æ–‡å°±åˆ°æ­¤ç»“æŸå•¦~~73:T24ab,## 1. å‰è¨€

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æˆ‘ä»¬ç»§ç»­æˆ‘ä»¬çš„ React ç»„ä»¶åº“ç³»åˆ—ã€‚æœ¬ç¯‡ä»‹ç»å¼¹å‡ºå±‚ PopOverä»¥åŠ tooltip çš„å®ç°ã€‚æœ¬æ–‡çš„ä»£ç å±•ç¤ºçš„æ˜¯ä¸»è¦çš„æ ¸å¿ƒä»£ç ï¼Œå…¨éƒ¨ä»£ç è§ä»“åº“ï¼š[Githubä»“åº“](https://github.com/heiheihoho1213/dux-ui)ï¼Œç»„ä»¶æ ·å¼è§[ä¸»é¡µ](https://heiheihoho1213.github.io/dux-ui/)ã€‚


## 2. å®šä¹‰å…¥å‚

é¦–å…ˆï¼Œè¿˜æ˜¯å…ˆç¡®å®šä¸€ä¸‹ä¸€ä¸ªå¼¹å‡ºå±‚éƒ½éœ€è¦ä»€ä¹ˆå‚æ•°æ¥æ§åˆ¶å‘¢ã€‚ç›¸ä¿¡å¤§å®¶ä¹Ÿéƒ½ç”¨è¿‡Tooltipä¹‹ç±»çš„ç»„ä»¶ï¼Œè‚¯å®šæœ‰æ§åˆ¶æ˜¾ç¤ºéšè—çš„å±æ€§ï¼Œè¿˜æœ‰å±•å¼€æ–¹å‘ç­‰ï¼Œæˆ‘è¿™é‡Œæ€»ç»“äº†ä¸€ä¸‹åŸºç¡€çš„å±æ€§ï¼š


| å±æ€§ | è¯´æ˜ |
| --- | --- |
| visible | å—æ§ï¼Œæ§åˆ¶å¼¹å‡ºå±‚å±•ç¤º |
| trigger | è§¦å‘æ–¹å¼ |
| placement | å±•å¼€æ–¹å‘ |
| onVisibleChange | æ˜¾ç¤ºäº‹ä»¶ |
| popup | å¼¹å‡ºå±‚çš„å…ƒç´  |
| zIndex | å±‚çº§ |
| popupClassName | å¼¹å‡ºå±‚ç±»å |


## 3. rc-trigger

[rc-trigger](https://www.npmjs.com/package/rc-trigger)æ˜¯ä¸€å¥—æµè¡Œçš„å¼€æºåº“ï¼Œé›†æˆäº†å„ç§è§¦å‘æ–¹å¼åˆ¤æ–­ã€å¼¹å‡ºå±‚æ¸²æŸ“ç­‰åŠŸèƒ½ã€‚æœ¬ç»„ä»¶åº“å°±ä½¿ç”¨è¯¥ç¬¬ä¸‰æ–¹åº“ã€‚

å…ˆå¼•å…¥ä¸€ä¸‹ï¼š

```js
import RcTrigger from 'rc-trigger';
```
ç„¶åå£°æ˜ä¸€ä¸ªrcTriggerçš„ç»„ä»¶ï¼š

```jsx
class RcTriggerWrap extends Component {
  static propTypes = {
    className: PropTypes.string,
    popupClassName: PropTypes.string,
    trueClassName: PropTypes.string,
  };
  render() {
    const { className, popupClassName, trueClassName, ...rest } = this.props as any;
    return (
      <RcTrigger
        className={trueClassName}
        popupClassName={classnames(className, popupClassName)}
        {...rest}
      />
    );
  }
}
```

æ¥ä¸‹æ¥ï¼Œç”¨styledæ ·å¼åŒ…è£¹ä¸€ä¸‹ï¼Œä¾¿äºæˆ‘ä»¬è‡ªå®šä¹‰æ ·å¼ï¼š

```jsx
import styled from '@emotion/styled';

export const PopoverWrap = styled(RcTriggerWrap)`
    /* æ”¾ç½®css */
`;
```
è¿™ä¸ª`PopoverWrap`ä¾¿æ˜¯æˆ‘ä»¬ä¹‹åè¦ç”¨çš„å¼¹å‡ºå±‚ç»„ä»¶çš„å¤–å£³äº†ã€‚

å¼¹å‡ºå±‚çš„ç»„ä»¶ï¼Œå…¶å®åªéœ€è¦å¯¹å¤–æš´éœ² `action` ã€`placement` å’Œ `popup`å±æ€§å°±è¡Œäº†ï¼Œæ‰€è°“åœ¨å¯¼å‡ºæ—¶ï¼Œæˆ‘ä»¬éœ€è¦å†å°è£…ä¸€ä¸‹ã€‚

åœ¨ç»„ä»¶åº“çš„index.tsxæ–‡ä»¶ä¸­ï¼Œå¯ä»¥è¿™æ ·ä½¿ç”¨ï¼š


```tsx
...
return <PopoverWrap
            action={trigger}
            popupPlacement={placement}
            popupTransitionName={
              transitionName || animation ? animationPrefixCls + '-' + animation : null
            }
            popupVisible={popup == null ? false : this.state.visible}
            popup={popup}
            onPopupVisibleChange={this.onVisibleChange}
            popupClassName={className}
            getPopupContainer={getPopupContainer}
      >
            {children}
      </PopoverWrap>
```
- `action`å¯¹åº”çš„æ˜¯rc-triggerçš„actionå±æ€§ï¼Œtriggeré€šè¿‡propsæ¥å—ã€‚æŒ‡çš„æ˜¯è§¦å‘å¼¹å‡ºçš„æ“ä½œï¼Œå¯é€‰é¡¹æœ‰ 'hover','click','focus','contextMenu'ï¼Œæ˜¯ä¸€ä¸ªæ•°ç»„å‚æ•°ï¼Œé»˜è®¤ä¸ºï¼š`['hover']`

- `popupPlacement`å¯¹åº”çš„æ˜¯rc-triggerçš„popupPlacementå±æ€§ï¼Œé€šè¿‡propsæ¥å—ã€‚æ˜¯ä¸€ä¸ªæšä¸¾é¡¹ï¼Œæšä¸¾å®šä¹‰å¦‚ä¸‹ï¼š

```ts
placement?:
    | 'topLeft'
    | 'top'
    | 'topRight'
    | 'bottomLeft'
    | 'bottom'
    | 'bottomRight'
    | 'leftTop'
    | 'left'
    | 'leftBottom'
    | 'rightTop'
    | 'right'
    | 'rightBottom';
```

- `popupTransitionName`å¯¹åº”rc-triggerçš„popupTransitionNameå±æ€§ï¼Œå®šä¹‰å¼¹å‡ºçš„åŠ¨ç”»ï¼Œæ˜¯å¯é€‰é¡¹ã€‚å¯é€šè¿‡propsæ¥å—animationå±æ€§æ¥å®šä¹‰ã€‚ç›®å‰ï¼Œrc-triggeråªæ”¯æŒä¸Šä¸‹æ–¹å‘çš„åŠ¨ç”»ï¼Œå…¶å†…éƒ¨ä½¿ç”¨äº†rc-animationï¼Œå¯é€‰é¡¹å¦‚ä¸‹ï¼š
`"fade" | "zoom" | "bounce" | "slide-up"`

- `popupVisible`å¯¹åº”rc-triggerçš„popupVisibleå±æ€§ï¼Œåœ¨ç”¨æˆ·ä¼ äº†popupåï¼Œé€šè¿‡props.visibleå±æ€§æ¥æ§åˆ¶ï¼Œè‹¥ç”¨æˆ·æ²¡æœ‰ä¼ popupï¼Œå¼ºè¡Œç½®ä¸ºfalse

- `popup`å¯¹åº”rc-triggerçš„popupå±æ€§ï¼Œæ˜¯æœ€æ ¸å¿ƒçš„å‚æ•°ï¼Œå¯ä¼ ä¸€ä¸ªElementå…ƒç´ ï¼Œç”¨äºå¼¹å‡ºå±‚çš„å±•ç¤ºã€‚
- `onPopupVisibleChange`å±æ€§åŒä¸Šï¼Œåœ¨popupå¼¹å‡ºæ—¶è§¦å‘ã€‚
- `popupClassName`å¯¹åº”rc-tableçš„popupClassNameï¼Œç»™å¼¹å‡ºå±‚åŠ ä¸€ä¸ªç±»åã€‚
- `getPopupContainer`å¯¹åº”rc-tableçš„getPopupContainerï¼Œå¯ä»¥è‡ªå®šä¹‰ä¸€ä¸ªå¼¹å‡ºå±‚å®¹å™¨ï¼Œéå¿…é€‰é¡¹ã€‚
- æœ€åä¸èƒ½å°‘äº†å‚æ•° `children`, é€šè¿‡hoveræˆ–è€…clickè¿™ä¸ªchildrenæ‰èƒ½è§¦å‘å¼¹å‡ºå±‚çš„å˜åŒ–ã€‚rc-triggerç»„ä»¶å¯ä»¥éšæ€§çš„ä¼ ä¸€ä¸ªåŒåçš„childrenï¼Œæ–‡æ¡£é‡Œè™½ç„¶æ²¡æœ‰å†™æ˜ï¼Œä½†æ˜¯reactç»„ä»¶é»˜è®¤éƒ½å¯ä»¥è¿™æ ·ä¼ é€’ã€‚


## 4. å®šä¹‰æ ·å¼

å¯¹äºå¼¹å‡ºå±‚ç»„ä»¶çš„å¤–å£³PopoverWrapï¼Œè¿˜è®°å¾—ä¸Šè¾¹é¢„ç•™çš„æ ·å¼çš„ç©ºç™½äº†å—ï¼Œæˆ‘ä»¬è¿™é‡Œåˆ†æƒ…å†µè®¨è®ºã€‚

å…ˆæŠŠå¤–å£³è®¾ç½®ä¸ºç»å¯¹å®šä½ï¼Œè¿™æ˜¯ä¸ºäº†é…åˆrc-triggerçš„topå’Œbottomæ ·å¼ï¼Œå¦å¤–ï¼Œæƒ³è¦å¼¹å‡ºå±‚è·Ÿéšç‚¹å‡»åŒºåŸŸï¼Œä¹Ÿå¿…é¡»ç»å¯¹å®šä½ï¼Œçˆ¶å…ƒç´ ä½¿ç”¨ç›¸å¯¹å®šä½ã€‚

```tsx
const _prefixCls = 'dux-ui'; // é€šè¿‡å¯¼å…¥å…¨å±€å˜é‡è·å¾—

export const prefixCls = _prefixCls + '-popover';
export const animationPrefixCls = prefixCls + '-animation';

export const PopoverWrap = styled(RcTriggerWrap)`
  &.${prefixCls} {
    // å¼¹å‡ºå±‚ç»å¯¹å®šä½
    position: absolute;
    z-index: 1030;
    display: block;

    &-hidden {
      display: none;
    }
  }
  ...
`;
```

åœ¨æ§åˆ¶å°é‡Œå¯ä»¥çœ‹åˆ°ï¼š

![WeChat37acb5ff66ca4ccd10b4cf17b7162a84.png](/img/posts/2022-6-22/2022-6-22-1.png)

rc-triggerä¼šåœ¨ä¼ å…¥çš„popupClassNameåæ‹¼æ¥ä¸€ä¸ªå¸¦æœ‰æ–¹å‘å‚æ•°çš„ç±»åï¼Œç”±æ­¤ï¼Œæˆ‘ä»¬æ¥å®šä¹‰å„è‡ªçš„æ ·å¼ï¼Œä»¥å·¦ä¸‹å’Œå·¦ä¸Šä¸ºä¾‹ï¼š


```scss
&-enter-active.${prefixCls}-placement-bottomLeft,
    &-appear-active.${prefixCls}-placement-bottomLeft {
    animation-name: ${slideUpIn};
    animation-play-state: running;
}
&-enter-active.${prefixCls}-placement-topLeft,
    &-appear-active.${prefixCls}-placement-topLeft {
    animation-name: ${slideDownIn};
    animation-play-state: running;
}
```

åˆ†åˆ«é…ç½®ä½¿ç”¨ä¸åŒçš„åŠ¨ç”»ï¼Œå¦‚æœä¸æƒ³è‡ªå®šä¹‰åŠ¨ç”»ï¼Œä¹Ÿå¯ä»¥ä¸è®¾ç½®ã€‚


å¦‚æœpropsä¸­å£°æ˜äº†åŠ¨ç”»ç±»å‹ï¼Œåˆ™ä¼šæœ‰ä¸€ä¸ªè¿™æ ·çš„ç±»åï¼š

![WeChat2b4c3d7733fd94dae215a0b13c47490f.png](/img/posts/2022-6-22/2022-6-22-2.png)


ä»¥fadeä¸ºä¾‹ï¼Œå¯ä»¥è¿™æ ·å£°æ˜cssï¼š

```css
const animationDuration = '0.1s';

...
&-fade {
  &-enter,
  &-appear,
  &-leave {
    animation-duration: ${animationDuration};
    animation-fill-mode: both;
  }
  &-enter,
  &-appear {
    animation-name: ${fadeIn};
  }
  &-leave {
    animation-name: ${fadeOut};
  }
}
```

è‡³äºåŠ¨ç”»çš„å…·ä½“å†™æ³•ï¼Œæœ‰å¾ˆå¤šç§ï¼Œè¿™é‡Œä»¥æ·¡å…¥æ·¡å‡ºä¸ºä¾‹ï¼Œå®ç°ä¸€ç§ä½œä¸ºå‚è€ƒï¼š

```css
export const fadeIn = keyframes`
    from {
        opacity: 0;
    }

    to {
        opacity: 1;
    }
`;
export const fadeOut = keyframes`
    from {
        opacity: 1;
    }

    to {
        opacity: 0;
    }
`;
```

## 5. ä¸€ä¸ªğŸŒ° 

æœ‰äº†è¿™äº›åŸºæœ¬çš„é…ç½®ï¼Œä¸€ä¸ªå¼¹å‡ºå±‚ç»„ä»¶å°±èƒ½è·‘èµ·æ¥äº†ã€‚

æµ‹è¯•ï¼š

```tsx
const Popup = () => (
  <div style={{ height: 30, border: '1px solid #ddd', background: '#fff' }}>This is a popup</div>
);

<Popover trigger={['hover']} popup={<Popup />}>
    <Content>{'hover'}</Content>
</Popover>
```

é¢„è§ˆæ•ˆæœï¼š


![WeChatee739043574f992511ff4658245bc54f.png](/img/posts/2022-6-22/2022-6-22-3.png)

æˆåŠŸï¼


## 6. è¿›é˜¶ï¼šåšä¸€ä¸ªTooltip

Tooltipçš„åº•å±‚ï¼Œå…¶å®å°±æ˜¯ä¸€ä¸ªpopoverï¼Œæˆ‘ä»¬æ¥å®ç°ä¸€ä¸‹ã€‚

ç›´æ¥çœ‹returnçš„ç»“æœï¼š

```tsx
<Popover
      placement={placement}
      popupClassName={...}
      popup={popup}
 />
```
Tooltipä¸åŒäºé€šç”¨å¼¹å‡ºå±‚çš„åœ°æ–¹åœ¨äºpopupçš„å†…å®¹ï¼Œä»–ä¼šæœ‰ä¸€ä¸ªç±»ä¼¼æ¼«ç”»å¯¹è¯æ¡†çš„å°ç®­å¤´ã€‚é‚£æˆ‘ä»¬æ¥å®šä¹‰ä¸€ä¸‹popupï¼š


```tsx
export const arrowWrapCls = popoverPrefixCls + '-span' + '-arrow-wrap';
export const arrowCls = popoverPrefixCls + '-span' + '-arrow-inner';

const popup = useMemo(() => {
    return (
      <TooltipWrap>
        {arrow && (
          <Arrow className={arrowWrapCls}>
            <ArrowInner className={arrowCls} />
          </Arrow>
        )}
        <ContentWrap customStyle={customStyle}>
          {popup}
        </ContentWrap>
      </TooltipWrap>
    );
  }, [popup, arrow, customStyle, theme]);
```

å¯ä»¥çœ‹åˆ°å…¶æ¥å—äº†å‡ ä¸ªæ–°çš„å‚æ•°ï¼Œæˆ‘ä»¬ä¸€ä¸ªä¸ªæ¥åˆ†æã€‚

- `arrow`: ä¸€ä¸ªboolå€¼ï¼Œæ§åˆ¶æ˜¯å¦æ˜¾ç¤ºç®­å¤´ã€‚é»˜è®¤æ˜¯æ²¡æœ‰çš„ï¼š

![image.png](/img/posts/2022-6-22/2022-6-22-4.png)

æˆ‘ä»¬æ¥å®šä¹‰ç®­å¤´çš„æ ·å¼ï¼Œä»¥ top çš„æ–¹å‘ä¸ºä¾‹ï¼š


```css
const arrowMixin = css`
  display: inline-block;
  position: absolute;
  width: 0;
  height: 0;
  border-width: 0;
  border-color: transparent;
  border-style: solid;
`;

export const Arrow = styled('span')`
  ${arrowMixin};
`;
export const ArrowInner = styled('span')`
  ${arrowMixin};
`;

.${arrowWrapCls}, .${arrowCls} {
    margin-left: -${arrowWidth};
    border-width: ${arrowWidth} ${arrowWidth} 0 ${arrowWidth};
    border-bottom-color: transparent;
    border-left-color: transparent;
    border-right-color: transparent;
}
.${arrowWrapCls} {
    bottom: -${arrowWidth};
}
.${arrowCls} {
    bottom: ${borderWidth};
}
```
å¯ä»¥çœ‹åˆ°ï¼Œç”¨ä¸€ä¸ªç»å¯¹å®šä½çš„spanåŒ…è£¹ï¼Œè®¾ç½®å®½é«˜æ˜¯0ï¼Œç„¶åè®¾ç½®å…¶ä¸Šã€å³ã€å·¦è¾¹æ¡†å®½åº¦åå†è®¾ç½®å‚ç›´æ–¹å‘çš„åæ–¹å‘ï¼Œå³ä¸‹ã€å·¦ã€å³è¾¹æ¡†ä¸ºé€æ˜è‰²ï¼Œæ¨¡æ‹Ÿä¸€ä¸ªç®­å¤´å‡ºæ¥ï¼Œæ•ˆæœå›¾å¦‚ä¸‹ï¼š


![image.png](/img/posts/2022-6-22/2022-6-22-5.png)

åŒç†ï¼Œå¯è®¾ç½®å…¶ä»–æ–¹å‘çš„ç®­å¤´æ ·å¼~~

- `popup`: æ˜¯å¼¹å‡ºå±‚å…ƒç´ ã€‚
- `TooltipWrap`å’Œ`ContentWrap`æ˜¯styledåŒ…è£¹ç»„ä»¶ï¼Œæœ¬è´¨æ˜¯ä¸ªdivï¼Œå¯ä»¥è‡ªå®šä¹‰æ ·å¼ã€‚

---

è‡³æ­¤ï¼Œå¼¹å‡ºå±‚ç»„ä»¶ä¹Ÿè®²å®Œè¾£~~74:T3a4b,## 1. å‡ºç°èƒŒæ™¯

åº”å“åº”å¼ç¼–ç¨‹çš„éœ€æ±‚ï¼Œå‡ºç°äº† Rx è¿™æ ·çš„ä¸“é—¨ç”¨æ¥å¤„ç†æ•°æ®å“åº”å¼çš„åº“ã€‚Rxå®¶æ—æœ‰å¾ˆå¤š: RxJavaï¼ŒRxSwift, Rx.NETç­‰ï¼Œè¿™é‡Œä¸»è¦ä»‹ç» RxJs çš„ä½¿ç”¨ã€‚

RxJs æ˜¯ä¸€ä¸ªç›¸å½“çµæ´»çš„ï¼Œä½¿ç”¨JavaScriptè¯­è¨€çš„æ•°æ®å“åº”å¼åº“ã€‚ä½¿ç”¨ç›¸å½“çš„çµæ´»ï¼ŒAPIç¹å¤šï¼Œå­¦ä¹ æˆæœ¬ä½ï¼Œç”¨å®˜ç½‘çš„è¯å«`å¯ä»¥æŠŠ RxJS å½“åšæ˜¯ç”¨æ¥å¤„ç†äº‹ä»¶çš„ Lodash `ã€‚

## 2. å…³é”®è¯

ReactiveXã€è§‚å¯Ÿè€…æ¨¡å¼ã€è¿­ä»£å™¨æ¨¡å¼ã€å‡½æ•°å¼ç¼–ç¨‹ã€æ•°æ®ç®¡é“ã€‚

## 3. RxJsç‰¹ç‚¹

1.  çº¯å‡€æ€§ (Purity)ï¼šä½¿ç”¨çº¯å‡½æ•°æ¥äº§ç”Ÿå€¼

> ä¸‹å›¾ä¸­ï¼ŒfromEventä¾¿æ˜¯çº¯å‡½æ•°ï¼Œå‡½æ•°çš„è¾“å‡ºä¸éšå¤–éƒ¨å˜é‡çš„å½±å“
> ![1.png](/img/posts/2022-6-19/2022-6-19-1.png)

2.  æµåŠ¨æ€§ (Flow)ï¼šRxJS æä¾›äº†ä¸€æ•´å¥—æ“ä½œç¬¦æ¥å¤„ç†æ•°æ®æµåŠ¨

> å¸¸ç”¨çš„è¿ç®—æœ‰ filterã€delayã€debounceTimeã€throttleTimeã€takeã€takeUntilã€distinctã€distinctUntilChanged

![2.png](/img/posts/2022-6-19/2022-6-19-2.png)

3.  ä»¥å€¼ (Values)ä¼ é€’ï¼šå¯¹äºæµç» observables çš„å€¼ï¼Œä½ å¯ä»¥å¯¹å…¶è¿›è¡Œè½¬æ¢ã€‚

> è¿˜æ˜¯ç‚¹å‡»äº‹ä»¶çš„ä¾‹å­ï¼Œä¸‹å›¾ä¸­çš„mapå’Œscanä¾¿å¯ä»¥å¯¹æµç»çš„æ•°æ®å€¼è¿›è¡Œæ˜ å°„å’Œæ•°å€¼è®¡ç®—

![3.png](/img/posts/2022-6-19/2022-6-19-3.png)

4.  Observable (å¯è§‚å¯Ÿå¯¹è±¡)

> Rxä¸­ä¸€åˆ‡éƒ½æ˜¯å¯è§‚å¯Ÿå¯¹è±¡ï¼Œæ•°æ®å€¼æ”¾åœ¨å¯è§‚å¯Ÿå¯¹è±¡ä¸­ã€‚å¯¹è±¡é€šè¿‡nextæ–¹æ³•å¾€æ•°æ®ç®¡é“é‡Œæ”¾å…¥å€¼ï¼Œåœ¨æ¥æ”¶ç«¯ï¼Œå¯ä»¥è®¢é˜…ï¼ˆsubscribeï¼‰åˆ›å»ºå‡ºæ¥çš„åŒä¸€ä¸ªå¯è§‚å¯Ÿå¯¹è±¡ï¼Œé€šè¿‡è®¢é˜…äº‹ä»¶**å¼‚æ­¥åœ°**æ‹¿åˆ°æ•°æ®å˜åŒ–çš„å†…å®¹ï¼Œå¹¶ä¸”å¯ä»¥å¤„ç†ä¼ è¾“å¼‚å¸¸ã€‚

> ä¸‹å›¾ä¸­å¯ä»¥çœ‹å‡ºï¼Œsubscribeè¢«åˆ›å»ºæ—¶ï¼Œè‹¥ç®¡é“é‡Œæœ‰å€¼ï¼Œä»–ä¼šä¾æ¬¡éå†ä¸€ä¸‹å„ä¸ªå€¼ï¼ˆè¿™å¯ä»¥ç”¨ä½œå±€éƒ¨ç¼“å­˜ï¼‰ï¼Œå¹¶å¯è‡ªå®šä¹‰å¤„ç†å‡½æ•°ã€‚å¯¹äºå®ä»»åŠ¡ï¼ˆsetTimeoutï¼‰ä¼šå»¶ååˆ¤æ–­ã€‚

![4.png](/img/posts/2022-6-19/2022-6-19-4.png)

ä¸Šå›¾ä¸­ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥çœ‹åˆ°ä¸€ä¸ªå®Œæ•´çš„ subscribe è®¢é˜…å†…éƒ¨çš„æ„æˆã€‚nextå‡½æ•°æ¥å—ç®¡é“ä¼ å€¼ï¼›erroræ¥å—ä¼ å€¼å¼‚å¸¸åçš„é”™è¯¯ä¿¡æ¯ï¼›å½“å“åº”å¼å¯¹è±¡è°ƒç”¨completeå‡½æ•°åï¼Œæ‰§è¡Œcompleteå‡½æ•°ï¼Œå¹¶ç»“æŸè¯¥æ¬¡è®¢é˜…ã€‚

ä¸€èˆ¬ä¸Šï¼Œsubscribeå‡½æ•°è°ƒç”¨æ—¶ï¼Œåªæ¥å—ä¸€ä¸ªå‚æ•°çš„è¯ï¼Œé»˜è®¤å°±æ˜¯nextè¿‡æ¥çš„æ•°æ®å€¼ã€‚

> **ä¸å‡½æ•°ã€è¿­ä»£å™¨çš„åŒºåˆ«**
>
> *   å‡½æ•°å’Œ Observables éƒ½æ˜¯æƒ°æ€§è¿ç®—ã€‚å¦‚æœä½ ä¸è°ƒç”¨å‡½æ•°ï¼Œå°±ä¸ä¼šæ‰§è¡Œã€‚Observables ä¹Ÿæ˜¯å¦‚æ­¤ï¼Œå¦‚æœä½ ä¸â€œè°ƒç”¨â€å®ƒ(ä½¿ç”¨ subscribe)ï¼Œä¹Ÿä¸ä¼šæ‰§è¡Œ
>
> *   ES2015 å¼•å…¥äº† generator å‡½æ•°å’Œ iterators (function\*)ï¼Œè¿™æ˜¯å¦å¤–ä¸€ç§ç±»å‹çš„æ‹‰å–ä½“ç³»ã€‚è°ƒç”¨ iterator.next() çš„ä»£ç æ˜¯æ¶ˆè´¹è€…ï¼Œå®ƒä¼šä» iterator(ç”Ÿäº§è€…) é‚£â€œå–å‡ºâ€å¤šä¸ªå€¼ã€‚
>
> Observable å¯ä»¥éšç€æ—¶é—´çš„æ¨ç§»â€œè¿”å›â€å¤šä¸ªå€¼ï¼Œè¿™æ˜¯å‡½æ•°æ‰€åšä¸åˆ°çš„ã€‚

å­¦ä¹ RxJsï¼Œé¦–å…ˆå¾—å¼„æ‡‚ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å¼çš„ä¸»è¢«åŠ¨å…³ç³»ï¼š

| ç”Ÿäº§è€…                 | æ¶ˆè´¹è€…                 |
| ------------------- | ------------------- |
| æ‹‰å–æ˜¯è¢«åŠ¨çš„: å½“è¢«è¯·æ±‚æ—¶äº§ç”Ÿæ•°æ®ã€‚  | æ‹‰å–æ˜¯ä¸»åŠ¨çš„: å†³å®šä½•æ—¶è¯·æ±‚æ•°æ®ã€‚   |
| æ¨é€æ˜¯ä¸»åŠ¨çš„: æŒ‰è‡ªå·±çš„èŠ‚å¥äº§ç”Ÿæ•°æ®ã€‚ | æ¨é€æ˜¯è¢«åŠ¨çš„: å¯¹æ”¶åˆ°çš„æ•°æ®åšå‡ºååº”ã€‚ |

RxJsæ˜¯ä¸»åŠ¨æ¨é€ã€è¢«åŠ¨æ¥å—æ¨¡å¼ã€‚ç®¡é“å…¥å£ï¼ˆå¯è®¢é˜…å¯¹è±¡ï¼Œæ¯”å¦‚Subjectï¼‰å¼ºè¡Œæ¨é€å€¼ï¼Œåœ¨å‡ºå£å¤„å¯é€‰æ‹©åœ°æ¥å—å’Œè¿‡æ»¤æ•°æ®ã€‚

ç¤ºä¾‹å‚è€ƒï¼š`<https://cn.rx.js.org/manual/overview.html#h21>`

## 4. å¸¸ç”¨è¿ç®—ç¬¦

#### $1. of/from$

å°†æ™®é€šå¯¹è±¡è½¬æ¢ä¸ºrxjså¯æ£€æµ‹çš„å“åº”å¼å¯¹è±¡

![5.png](/img/posts/2022-6-19/2022-6-19-5.png)

> ä¸åŒç‚¹ï¼š ofè®¢é˜…åå¿ å®çš„æ‰“å°æºå¯¹è±¡ï¼Œfromä¼šå°†æºå¯¹è±¡è§£æ„åä¾æ¬¡æ‰“å°ã€‚æ˜¯ä¸æ˜¯æœ‰ç‚¹åƒPromise.all ?

#### $2. map$

![6.png](/img/posts/2022-6-19/2022-6-19-6.png)

> é¡¾åæ€ä¹‰ï¼Œä¸æ•°ç»„çš„mapç±»ä¼¼ï¼Œå¯¹äºä¸€ä¸ªå“åº”å¼å¯¹è±¡ï¼Œå¯ä»¥ä½¿ç”¨pipeç®¡é“æŒ‡ä»¤è·å–å…¶ç®¡é“çš„å†…å®¹ï¼Œä¹‹åä¾¿å¯ä»¥ä½¿ç”¨å„ç§è¿ç®—ç¬¦æ¥å¤„ç†æ•°æ®å•¦ã€‚

#### $3. concat å’Œ concatAll$

åˆå¹¶Observableå¯¹è±¡å¹¶ä»¥æ­¤è¿”å›å…¶å€¼

concatï¼šé¦–å°¾ç›¸è¿ï¼Œå°†å„ä¸ªè®¢é˜…å€¼ç©¿èµ·æ¥è¾“å‡º

ä¾‹1ï¼š

```js
// RxJS v6+
import  {  of, concat }  from  'rxjs';
concat(
  of(1,  2,  3),
  // subscribed after first completes
  of(4,  5,  6),
  // subscribed after second completes
  of(7,  8,  9)
)
// log: 1, 2, 3, 4, 5, 6, 7, 8, 9
.subscribe(console.log);
```

ä¾‹2ï¼š

```js
import { concat, merge, defer, from } from 'rxjs'; 

console.log('Start')
const promiseA$ = defer(()=>from(new Promise((reslove, reject)=>{
  setTimeout(()=>{
    reslove('PromiseA')
  }, 1000)
})))
const promiseB$ = defer(()=>from(new Promise((reslove, reject)=>{
  setTimeout(()=>{
    reslove('PromiseB')
  }, 1000)
})))

// ä¼šä¾æ¬¡é—´éš”ä¸€ç§’æ‰“å°Start, PromiseA, PromiseB
concat(promiseA$, promiseB$).subscribe(x => console.log(x));
```

concatAllï¼šæ˜¯ä¸€ä¸ªé«˜é˜¶çš„å¤„ç†å‡½æ•°ï¼Œé¡ºåºæ¥å—ä¸Šæ¸¸æŠ›å‡ºçš„å„ä¸ªæ•°æ®æµä½œä¸ºå®ƒçš„æ•°æ®ï¼Œ è‹¥å‰é¢çš„æ•°æ®æµä¸èƒ½åŒæ­¥çš„å®Œç»“ï¼Œå®ƒä¼šæš‚å­˜åç»­æ•°æ®æµï¼Œå½“å‰æ•°æ®æµå®Œæˆåå®ƒæ‰ä¼šè®¢é˜…åä¸€ä¸ªæš‚å­˜çš„æ•°æ®æµã€‚å¯ä»¥æƒ³æˆæ˜¯æŠŠæ‰€æœ‰å…ƒç´  concat èµ·æ¥ã€‚å…¶å‰ç½®æ¡ä»¶å¼å¿…é¡»ä¼ è¿‡æ¥ä¸€ç»„ Observable å¯¹è±¡ã€‚

ä¾‹1ï¼š

![7.png](/img/posts/2022-6-19/2022-6-19-7.png)

> concatAll ä¸€èˆ¬ç”¨äºå¤„ç†ä¸€æ¬¡æ€§æˆ–è€…çŸ­æ—¶é—´å†…æœ‰å¤šä¸ªç®¡é“æ•°æ®çš„æƒ…å†µã€‚æ¯”å¦‚å¤„ç†ç‚¹å‡»äº‹ä»¶ï¼Œåœ¨ä»–å‰ç½®çš„è¿ç®—ç¬¦ï¼Œå¿…æœ‰ä¸€ä¸ªç±»ä¼¼äºmapçš„æ˜ å°„ï¼ŒconcatAll å¯ä»¥å°†ä¸€ä¸ª Observable å¯¹è±¡æ˜ å°„ä¸ºæ‹å¹³çš„å€¼æ¥ä¾æ¬¡å¤„ç†ã€‚

ä¸ä½¿ç”¨ concatAllï¼Œåªä½¿ç”¨mapæ—¶ï¼Œè¾“å‡ºç»“æœï¼š

![image.png](/img/posts/2022-6-19/2022-6-19-8.png)

ä¾‹2ï¼šé‡å†™ä¸‹ä¸Šé¢ concat çš„ä¾‹2ï¼Œè¾“å‡ºç›¸åŒçš„ç»“æœ

```js
import { concat, defer, from, of } from 'rxjs'; 
import { tap, concatAll } from 'rxjs/operators';

console.log('Start')

const promiseA$ = defer(() => from(new Promise((reslove, reject) => {
  console.log('PromiseA is been Subscribed ')
  setTimeout(()=>{
    reslove('PromiseA')
  }, 1000)
})))

const promiseB$ = defer(() => from(new Promise((reslove, reject) => {
  console.log('PromiseB is been Subscribed ')
  setTimeout(()=>{
    reslove('PromiseB')
  }, 1000)
})))

// ä¼šä¾æ¬¡é—´éš”ä¸€ç§’æ‰“å°Start, PromiseA, PromiseB
of(promiseA$, promiseB$).pipe(tap(console.log), concatAll()).subscribe(x => console.log(x));
```

#### $4. mergeAll$

mergeAll ä¸ä¼šåƒ concatAll ä¸€æ ·é¦–å°¾ç›¸è¿è¾“å‡ºå€¼ï¼Œå…¶å¹¶è¡Œå¤„ç†æ‰€æœ‰çš„ Observableï¼Œä¸ä¿è¯è¾“å‡ºé¡ºåºã€‚

![8.png](/img/posts/2022-6-19/2022-6-19-9.png)

#### $5. è¡ç”Ÿæ“ä½œç¬¦ concatMap, mergeMap$

concatMap, mergeMap åˆ†åˆ«æ˜¯ `map + concatAll` å’Œ `map + mergeAll` çš„ç»“åˆä½“ã€‚

![9.png](/img/posts/2022-6-19/2022-6-19-10.png)

ä¸Šé¢çš„å®æˆ˜ä¾‹å­ï¼Œæ¥å—ä¸€ä¸ªå¼¹çª—å…³é—­äº‹ä»¶ï¼Œåˆ¤æ–­å€¼æ˜¯å¦ä¸ºconfirmedï¼Œè‹¥æ˜¯ï¼Œåˆ™äº¤ç»™ mergeMapå¤„ç†ã€‚

mergeMapæ˜¯æ¯”è¾ƒå¸¸ç”¨çš„è¯·æ±‚æ•°æ®çš„æ“ä½œç¬¦ï¼Œè¯¦ç»†ä½¿ç”¨è§å®˜ç½‘ï¼š`<https://cn.rx.js.org/class/es6/Observable.js~Observable.html#instance-method-mergeMap>`

ä¸‹é¢æ˜¯ä»–çš„æ‰§è¡ŒåŸç†ï¼š
![10.png](/img/posts/2022-6-19/2022-6-19-11.png)
ä¸Šå›¾ä¸­ï¼Œç®—å­ç©¿äº†å¤„ç†å‡½æ•°ï¼š10\*iï¼Œå°†ä¸¤ä¸ªæµä¸­çš„æ•°ç›¸ä¹˜ã€‚å¯ä»¥çœ‹åˆ°ç±»ä¼¼äºçŸ©é˜µä¹˜ç§¯çš„å½¢å¼ï¼Œåˆ†åˆ«ç›¸ä¹˜åè¾“å‡ºã€‚

ç±»ä¼¼çš„ï¼ŒconcatMap æ˜¯æŒ‰ç…§é¡ºåºæ’åˆ—çš„ï¼Œä½¿ç”¨åœºæ™¯æ›´åŠ å¹¿æ³›ã€‚æ¯ä¸ªæ–°çš„å†…éƒ¨ Observable ä¸å…ˆå‰çš„å†…éƒ¨ Observable é¦–å°¾ä¸²è”ç»„æˆã€‚ä»–è§£å†³äº† concat å’Œ concatAll çš„ä¸€ä¸ªé—®é¢˜ï¼šåä¸€ä¸ªæ•°æ®æµæ‹¿ä¸åˆ°å‰ä¸€ä¸ªæ•°æ®æµæŠ›å‡ºçš„æ•°æ®ã€‚

> æ³¨æ„ï¼šÂ `concatMap`ç­‰æ•ˆäºÂ `mergeMap` çš„å¹¶å‘å‚æ•°è®¾ç½® åˆ°Â `1`ã€‚

![WeChat6cbaa584dbb91a47061695335ded81c5.png](/img/posts/2022-6-19/2022-6-19-12.png)

æˆ‘ä»¬è¿˜æ˜¯ä½¿ç”¨ä¸Šé¢ concat çš„åŒä¸€ä¸ªä¾‹å­ï¼Œä¸è¿‡æ§åˆ¶ä¸€ä¸‹ä¸¤ä¸ªpromiseçš„å…ˆåé¡ºåºï¼Œè®©åä¸€ä¸ªpromiseè·å–å‰ä¸€ä¸ªpromiseçš„æ•°æ®ï¼š

```js
import { concat, defer, from } from 'rxjs'; 
import { concatAll, map, tap } from 'rxjs/operators'; 

console.log('Start')

const promiseA$ = defer(() => from(new Promise((reslove, reject)=>{
  setTimeout(() => {
    reslove('PromiseA')
  }, 1000)
})))

// è¿™æ˜¯ä¸€ä¸ªä¼šè¿”å›æ•°æ®æµpromiseB$çš„å‡½æ•°
const promiseB = data => from(new Promise((reslove, reject)=>{
  setTimeout(() => {
    reslove(`${data} then PromiseB`)
  }, 1000)
}))

// mapä¼šå°†æŠŠä¸Šæ¸¸å®Œæˆåçš„æ•°æ®é€šè¿‡promiseBè½¬æ¢æˆpromiseB$æ•°æ®æµ
// å¹¶ä¼ é€’ç»™concatAll, concatAllå°†promiseB$è¿æ¥ä¸‹æ¸¸æ•°æ®æµ
// è¿™é‡Œå°†åœ¨ä¸¤ç§’åæ‰“å°å‡º PromiseA then PromiseB
promiseA$.pipe(
  map(promiseB),
  concatAll()
).subscribe(x => console.log(x))
```

æˆ‘ä»¬ä½¿ç”¨ concatMap æ”¹å†™ï¼š

```js
import { concat, defer, from } from 'rxjs'; 
import { concatMap, map, tap } from 'rxjs/operators'; 

console.log('Start')

const promiseA$ = defer(() => from(new Promise((reslove, reject)=>{
  setTimeout(() => {
    reslove('PromiseA')
  }, 1000)
})))

// è¿™æ˜¯ä¸€ä¸ªä¼šè¿”å›æ•°æ®æµpromiseB$çš„å‡½æ•°
const promiseB = data => new Promise((reslove, reject)=>{
  setTimeout(() => {
    reslove(`${data} then PromiseB`)
  }, 1000)
})

// concatMap å¯ä»¥æ¥æ”¶ä¸€ä¸ªè¿”å›Promiseçš„å‡½æ•°æˆ–è€…æ˜¯æ•°æ®æµ
// è¿™é‡Œå°†åœ¨ä¸¤ç§’åæ‰“å°å‡º PromiseA then PromiseB
promiseA$.pipe(
  concatMap(promiseB)
).subscribe(x => console.log(x))
```

å¯ä»¥çœ‹åˆ°ï¼Œå•å• concatMap å°±å¯ä»¥è®©åä¸€ä¸ªæ•°æ®æµæ¥å—å‰é¢æ•°æ®æµçš„æ•°æ®ï¼Œå…¶æœ¬è´¨å°±æ˜¯ map + concatAllã€‚

**concatMap å¼•ç”³ï¼š**

è€ƒè™‘ä¸€ä¸ªå®é™…çš„ä¸šåŠ¡åœºæ™¯ã€‚æˆ‘ä»¬æœ‰ä¸€ä¸ªé¡µé¢ï¼Œé¡µé¢åˆå§‹åŒ–çš„æ—¶å€™æœ‰ä¸ªåˆå§‹åŒ–æ¥å£è·å–æ•°æ®ï¼Œé¡µé¢ä¸Šæœ‰ä¸ªä¸‹ä¸€æ­¥æŒ‰é’®ï¼Œè¿™ä¸ªæŒ‰é’®è§¦å‘çš„äº‹ä»¶éœ€è¦ä½¿ç”¨åˆå§‹åŒ–æ¥å£çš„æ•°æ®ã€‚

å¯ä»¥è¿™æ ·å†™ï¼š

```js
import { concat, defer, from, fromEvent } from 'rxjs'; 
import { tap, concatMap } from 'rxjs/operators'; 

// ä½¿ç”¨promiseæ¥æ¨¡æ‹Ÿæ•°æ®è¯·æ±‚è¿‡ç¨‹
const req$ = defer(() => from(new Promise((reslove, reject)=>{
  setTimeout(() => {
    reslove('This is init data')
  }, 1000)
})))

// äº‹ä»¶æµ
const button$ = () => fromEvent(document.getElementById('button'), 'click')

// ç‚¹å‡»æŒ‰é’®åè¾“å‡ºè¯·æ±‚å†…å®¹
// è¿™é‡Œä¼šæ‰“å°å‡º This is init data
req$.pipe(
  concatMap(button$, (data, event) => data)
).subscribe(x => console.log(x))
```

concatMapæ¥å—å¼‚æ­¥è¯·æ±‚çš„æ•°æ®ï¼Œç„¶åä¼ ç»™ button çš„ç‚¹å‡»äº‹ä»¶ Observable å¯¹è±¡ï¼Œé€šè¿‡è¯¥äº‹ä»¶ Observable å¯¹è±¡æ¥è¾“å‡ºç»“æœã€‚å¤„ç†äº‹ä»¶æ—¶ï¼Œ concatMap ç¬¬äºŒä¸ªå‚æ•°å°±æ´¾ä¸Šç”¨åœºäº†ã€‚

#### $6. å®šæ—¶å™¨$

```js
import { interval, timer } from 'rxjs';

const test_interval = interval(1000);

const test_timer = timer(1000, 5000);

const test_timer = timer(1000);

export {test_interval, test_timer}
```

intervalä¼šä¸åœçš„æŒ‰ç…§é—´éš”æ—¶é—´ç´¯åŠ æ•°å­—ï¼Œä»0å¼€å§‹ã€‚timeræ˜¯ä¸€ä¸ªå®šæ—¶å™¨ï¼Œåªæœ‰ä¸€ä¸ªå‚æ•°æ—¶ï¼Œåœ¨æŒ‡å®šæ—¶é—´ï¼ˆæ¯«ç§’ï¼‰åè¾“å‡ºä¸€ä¸ª0ï¼Œä¸¤ä¸ªå‚æ•°æ—¶ï¼Œæ¯”å¦‚ä¸Šé¢çš„ä¾‹å­ï¼ŒæŒ‡çš„æ˜¯ä»ç¬¬1ç§’å¼€å§‹ï¼Œæ¯éš”5ç§’å‡ºä¹¦ä¸€ä¸ªç´¯åŠ çš„å€¼ï¼Œä»0å¼€å§‹ã€‚

#### $7. å¼‚å¸¸å¤„ç† throwError$

```js
import { throwError, interval, of } from 'rxjs';
import { mergeMap } from 'rxjs/operators';

interval(1000).pipe(
mergeMap(x => x === 2
    ? throwError('Twos are bad')
    : of('a', 'b', 'c')
    ),
).subscribe(x => console.log(x), e => console.error(e));
```

ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œä½¿ç”¨ç®—å­ throwErroræŠ›å‡ºé”™è¯¯ï¼ŒæŠ›å‡ºåï¼Œè®¢é˜…åœæ­¢ã€‚

#### $8. zipAll$

ä¸‹å›¾ä¸­ï¼ŒzipAll å°† from æ“ä½œç¬¦è§£æ„å‡ºçš„æµå¼æ•°æ®åˆæ‹¼æ¥å›æ•°ç»„å½¢å¼ã€‚

![12.png](/img/posts/2022-6-19/2022-6-19-13.png)

#### $9. group ä¸ reduce$

ç±»ä¼¼ SQL ä¸­çš„ groupByï¼Œæ¥å—ä¸€ä¸ªå‡½æ•°ï¼Œè¿”å›è¦groupçš„å¯¹è±¡keyå€¼ã€‚

![13.png](/img/posts/2022-6-19/2022-6-19-14.png)

è§£å¼€ tapçš„æ³¨é‡Šåï¼Œå¯ä»¥çœ‹åˆ°æ‰“å°çš„è¾“å‡ºï¼š

![image.png](/img/posts/2022-6-19/2022-6-19-15.png)

reduceç”¨æ¥èšåˆObservableä¸­çš„æ•°å€¼ã€‚

#### $10. distinct$

å»é‡ç®—å­ã€‚

ä½¿ç”¨RxJsæ¥æ•°ç»„å»é‡ï¼š

![14.png](/img/posts/2022-6-19/2022-6-19-16.png)

#### $11. takeUtill$

ç›´åˆ°æä¾›çš„ observable å‘å‡ºå€¼ï¼Œå®ƒä¾¿å®Œæˆ

ä¾‹1ï¼š

![15.png](/img/posts/2022-6-19/2022-6-19-17.png)

> æ€è€ƒï¼šæ˜¯ä¸æ˜¯å¯ä»¥ç”¨æ¥ é˜²æŠ–èŠ‚æµ å‘¢

ä¾‹2ï¼šç›´åˆ°ç”¨æˆ·ç‚¹å‡»åï¼Œå¼€å¯å®šæ—¶å™¨

![16.png](/img/posts/2022-6-19/2022-6-19-18.png)

#### $12. takeLast$

å–æµæ•°æ®çš„æœ€åä¸€ä¸ªï¼ˆåŒç†ï¼Œæœ‰ take(index: number)å‡½æ•°æ¥æ­£å‘æŒ‡å®šä¸‹æ ‡è·å–ï¼‰

![17.png](/img/posts/2022-6-19/2022-6-19-19.png)

#### $13. ä¸“ç”¨çš„é˜²æŠ–èŠ‚æµ$

ä¸Šé¢è¯´å¯ä»¥ç”¨takeUtilsæ¨¡æ‹Ÿé˜²æŠ–èŠ‚æµï¼Œå…¶å®Rxjsæœ‰ä¸“ç”¨çš„é˜²æŠ–èŠ‚æµå‡½æ•°ã€‚

```js
import { debounceTime, throttleTime } from 'rxjs';

Observable.fromEvent(document.getElementById("debounceTime"), "click")
    .debounceTime(1000)
    .subscribe(() => console.log("debounceTime"));
    
Observable.fromEvent(document.getElementById("throttleTime"), "click")
    .throttleTime(1000)
    .subscribe(() => console.log("throttleTime"));
```

#### $14. Subject å¯¹è±¡$

Subjectç»§æ‰¿è‡ªObservableç±»ï¼ŒåŒæ ·å…·æœ‰æ•°æ®æµç›‘å¬ç‰¹æ€§ï¼Œå…¶ä½œä¸ºobservableçš„ä¸€ç§è½½ä½“ï¼Œå¤šç”¨äºç»„ä»¶ä¹‹é—´ä¼ é€’ã€‚

å¯ä»¥æ¨é€(next)å’Œè¢«è®¢é˜…(subscribe)

![18.png](/img/posts/2022-6-19/2022-6-19-20.png)

BehaviorSubjectï¼šæ¯ä¸ªæ–°çš„è®¢é˜…å¯ä»¥æ‹¿åˆ°ç®¡é“ä¸­æœ€æ–°çš„é‚£æ¬¡æ•°æ®

![19.png](/img/posts/2022-6-19/2022-6-19-21.png)

AsyncSubjectï¼šcompleteæ—¶ä¼šè¾“å‡ºæœ€æ–°çš„ç®¡é“æ•°æ®ï¼Œå…¶ä½™æ—¶é—´ä¸è¾“å‡º

![20.png](/img/posts/2022-6-19/2022-6-19-22.png)

ReplaySubjectï¼šæ¯æ¬¡æ–°è®¢é˜…æ—¶ï¼Œå¯æŒ‡å®šè·å–ç®¡é“ä¸­æœ€æ–°çš„Nä¸ªæ•°æ®

![21.png](/img/posts/2022-6-19/2022-6-19-23.png)

> å¼•ç”³é˜…è¯»ï¼Œæ•°ç™¾ä¸ªæ“ä½œç¬¦ï¼šÂ http\://[reactivex.io/documentation/operators.html](http://reactivex.io/documentation/operators.html)

## 5. åº”ç”¨åœºæ™¯

1.  å¤šäº‹ä»¶ç•Œé¢
2.  æ›´åŠ å¤æ‚çš„äº¤äº’åœºæ™¯ï¼Œå°¤å…¶æ˜¯éœ€è¦ç»„ä»¶é—´å¤šçº§ä¼ é€’çš„æƒ…å†µ
3.  éœ€è¦æºæºä¸æ–­çš„æµå‡ºæ•°æ®çš„åœºæ™¯

## 6. ä¸ Promise å¯¹æ¯”

å…±åŒç‚¹ï¼š

1.  å¤„ç†å¼‚æ­¥

ä¾‹1ï¼š

![22.png](/img/posts/2022-6-19/2022-6-19-24.png)

ä¾‹2ï¼š

![23.png](/img/posts/2022-6-19/2022-6-19-25.png)

ä¸åŒï¼š

1.  è®¾è®¡ç†å¿µä¸åŒï¼ˆå‘å¸ƒè®¢é˜…ã€è§‚å¯Ÿè€…+pipeï¼‰
2.  ä¸­é€”å–æ¶ˆ

åœ¨ä¸Šé¢å¼‚æ­¥å¤„ç†çš„ä¾‹å­ä¸­ï¼Œå¯ä»¥é€‰æ‹©å–æ¶ˆå®šæ—¶å™¨ï¼šå³å–æ¶ˆè®¢é˜…

![24.png](/img/posts/2022-6-19/2022-6-19-26.png)

3.  å®Œå–„çš„å‡½æ•°å·¥å…·

## 7. ä¸ React ç»“åˆ

ç¤ºä¾‹ï¼šç»„ä»¶é—´ä¼ é€’æ¶ˆæ¯

çˆ¶ç»„ä»¶ï¼šå£°æ˜ä¸€ä¸ª subjectï¼Œé€šè¿‡ prop ä¼ é€’ç»™ å­ç»„ä»¶

![25.png](/img/posts/2022-6-19/2022-6-19-27.png)

![26.png](/img/posts/2022-6-19/2022-6-19-28.png)

å­ç»„ä»¶ï¼šæ¥å—è¯¥ subjectï¼Œç„¶åå¾€é‡Œè¾¹æ¨é€å€¼ã€‚åŒç†ï¼Œçˆ¶ç»„ä»¶ä¹Ÿå¯ä»¥æ¨é€ï¼Œå­ç»„ä»¶æ¥ç›‘å¬ã€‚å¦‚æ­¤è¾¾åˆ° çˆ¶å­ç»„ä»¶ å…¨åŒå·¥é€šä¿¡ã€‚

![27.png](/img/posts/2022-6-19/2022-6-19-29.png)

ç‚¹å‡»å­ç»„ä»¶çš„ä¸‰ä¸ªæŒ‰é’®ï¼Œå°±ä¼šçœ‹åˆ°çˆ¶ç»„ä»¶çš„è®¢é˜…è§¦å‘äº†ï¼

![28.png](/img/posts/2022-6-19/2022-6-19-30.png)

ç‚¹å‡»åä¼šæœ‰ç›¸åº”è¾“å‡ºï¼Œæ¯”å¦‚ï¼š

```
1
2
3
3
```

æ¨èé¡¹ç›®ï¼š`<https://github.com/LeetCode-OpenSource/rxjs-hooks>`

<hr />

å‚è€ƒï¼š

*   [Rxjs Github](https://github.com/ReactiveX/rxjs)
*   [ReactiveX å®˜ç½‘](https://reactivex.io/)75:T732,## 1. ä¼ªå…ƒç´ æ¨¡æ‹Ÿå®ç°å¾®è½¯logoé˜´å½±

>  CSS æ¢ç©¶ç³»åˆ—æ–‡ç« ä¹‹ä¼ªshadow

```html
<div style={{ width: '100%', height: '500px', background: 'linear-gradient(90deg, hsl(199, 98%, 50%), hsl(199, 98%, 38%))', overflow: 'hidden' }}>
  <div className={`${style.box}`}>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
  </div>
</div>
```


```html {{ title: 'HTML' }}
<div class='box'>
  <div></div>
  <div></div>
  <div></div>
  <div></div>
</div>
```

```css {{ title: 'CSS' }}
/* å…ˆä½¿ç”¨ grid å¸ƒå±€å®ç°å››ä¸ªæ–¹å—çš„å®šä½ */
.box {
  position: relative;
  width: 20vmin;
  height: 20vmin;
  margin: 20vmin;
  padding: 0;
  z-index: 2;
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  grid-template-rows: repeat(2, 1fr);
  grid-row-gap: 4%;
  grid-column-gap: 4%;
  grid-auto-flow: row;
}

/* è®¾ç½®ä¸¤ä¸ªä¼ªå…ƒç´ ï¼Œåˆ†åˆ«è¡¨ç¤ºä¸¤ä¸ªè¾¹çš„é˜´å½± */
.box::before,
.box::after {
  content: "";
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  z-index: 2;
}

.box::before {
  /* transform-origin æ˜¯å˜å½¢åŸç‚¹ï¼Œä¹Ÿå°±æ˜¯è¯¥å…ƒç´ å›´ç»•ç€é‚£ä¸ªç‚¹å˜å½¢æˆ–æ—‹è½¬ */
  /*æ¯”å¦‚ï¼š0 50% è¡¨ç¤º x æ–¹å‘ä¸Šåœ¨æœ€å·¦è¾¹ï¼Œy æ–¹å‘ä¸Šåœ¨æœ€å·¦è¾¹é‚£æ¡è¾¹ä¸­é—´çš„ä½ç½® */
  transform-origin: 0 0;
  /* è·‘åˆ°æœ€å³è¾¹çš„ä¸Šè¾¹, scaleX ç¼©æ”¾ä¸€ä¸‹èŒƒå›´ï¼Œå¯ä»¥ä¸è¦ */
  transform: translate(100%, 0) skewY(45deg) scaleX(.6);
  background: linear-gradient(90deg, rgba(0, 0, 0, .3), transparent);
  animation: shadowMoveY 5s infinite linear alternate;
}

.box::after {
  transform-origin: 0 0;
  transform: translate(0%, 100%) skewX(45deg) scaleY(.6);
  background: linear-gradient(180deg, rgba(0, 0, 0, .3), transparent);
}

@keyframes shadowMoveY {
  to {
    transform: translate(100%, 0) skewY(20deg) scaleX(.6);
  }
}
```

![microsoft-logo](/img/posts/css/microsoft-logo.jpg)76:T6cf,```html
<div className={style.container}>
  <div className={style.shadow}>Hover</div>
</div>
```

#### è®¾ç½®åˆå§‹é¢œè‰²

å…ˆè®¾ç½®å››ä¸ªè§’çš„é¢œè‰²ï¼ˆè®¾ç½®å®½é«˜. åœ†è§’. 0è¾¹æ¡† çš„ä»£ç çœç•¥ï¼‰ï¼š

```html
<div class='shadow'>Hover</div>
```

```css
--color: #1e91e9;

/* ç”¨å››ä¸ªé˜´å½±æ¨¡æ‹Ÿå››ä¸ªè±¡é™ï¼Œè¿™é‡Œåªè®¾ç½®ä¸€ä¸ªï¼Œå…¶å®åˆå§‹æ•ˆæœæ˜¯ä¸€æ ·çš„ */
box-shadow: 0 0 0 2px var(--color), 0 0 0 2px var(--color),
  0 0 0 2px var(--color), 0 0 0 2px var(--color);
```

#### è®¾ç½®æµ®åŠ¨åŠ¨ç”»

```css

.shadow:hover {
  --color: #1e91e9;
  animation: border .5s ease forwards;
}

@keyframes border {
  /* 1/4 æ—¶ï¼Œå³ä¸Šè§’ï¼šå‘å³åç§»ä¸º0ï¼Œå‘ä¸Šåç§»125ï¼Œä¸æ¨¡ç³Šï¼Œæ‰©æ•£2pxï¼Œå˜ä¸ºç°è‰² */
  /* å·¦ä¸Šè§’ï¼šå‘å³åç§»ä¸º0ï¼Œå‘ä¸Šåç§»125ï¼Œä¸æ¨¡ç³Šï¼Œæ‰©æ•£2pxï¼Œå˜ä¸ºç°è‰² */
  25% {
    box-shadow: 0 -125px 0 2px var(--color),
                -60px -60px 0 2px var(--color),
                -60px 60px 0 2px var(--color),
                60px 60px 0 2px var(--color),
                0 0 0 2px #ccc;
  }

  50% {
    box-shadow: 0 -125px 0 2px var(--color),
                -125px 0px 0 2px var(--color),
                -60px 60px 0 2px var(--color),
                60px 60px 0 2px var(--color),
                0 0 0 2px #ccc;
  }

  75% {
    box-shadow: 0 -125px 0 2px var(--color),
                -125px 0px 0 2px var(--color),
                0px 125px 0 2px var(--color),
                60px 60px 0 2px var(--color),
                0 0 0 2px #ccc;
  }

  100% {
    box-shadow: 0 -125px 0 2px var(--color),
                -125px 0px 0 2px var(--color),
                0px 125px 0 2px var(--color),
                120px 40px 0 2px var(--color),
                0 0 0 2px #ccc;
  }
}
```77:T60a,```html
<div className={style.container}>
  <div className='flex-start'>
    <div className={style.left}>å·¦</div>
    <p>box-shadow: -7px 0 5px -5px #ccc</p>
  </div>
  <div className='flex-start'>
    <div className={style.right}>å³</div>
    <p>box-shadow: 7px 0 5px -5px #ccc</p>
  </div>
  <div className='flex-start'>
    <div className={style.top}>ä¸Š</div>
    <p>box-shadow: 0 -7px 5px -5px #ccc</p>
  </div>
  <div className='flex-start'>
    <div className={style.bottom}>ä¸‹</div>
    <p>box-shadow: 0 7px 5px -5px #ccc</p>
  </div>
</div>
```

```html
<div>
  å‚æ•°ï¼š x æ–¹å‘åç§»é‡ï¼ˆå³+ï¼‰ï¼Œ y æ–¹å‘åç§»é‡ ï¼ˆä¸‹+ï¼‰ï¼Œæ¨¡ç³ŠåŠå¾„ï¼Œæ‰©å¼ åŠå¾„

  æ‰©å¼ åŠå¾„ä¼šæ ¹æ®æŒ‡å®šçš„å€¼å»æ‰©å¤§æˆ–ç¼©å°æŠ•å½±å°ºå¯¸ï¼Œå¦‚æœæˆ‘ä»¬ç”¨ä¸€ä¸ªè´Ÿçš„æ‰©å¼ åŠå¾„ï¼Œè€Œä»–çš„ç»å¯¹å€¼åˆšå¥½ç­‰äºæ¨¡ç³ŠåŠå¾„ï¼Œé‚£ä¹ˆæŠ•å½±çš„å°ºå¯¸å°±ä¼šä¸æŠ•å½±æ‰€å±çš„å…ƒç´ å°ºå¯¸å®Œå…¨ä¸€è‡´ï¼Œé™¤éä½¿ç”¨åç§»é‡æ¥ç§»åŠ¨ä»–ï¼Œå¦åˆ™æˆ‘ä»¬å°†çœ‹ä¸åˆ°ä»»ä½•æŠ•å½±ã€‚
</div>
```

```html
<div className={style.container}>
  <div className='flex-start'>
    <div className={style.left2}>å·¦</div>
    <p>box-shadow: -7px 0 5px 5px #ccc</p>
  </div>
  <div className='flex-start'>
    <div className={style.right2}>å³</div>
    <p>box-shadow: 7px 0 5px 5px #ccc</p>
  </div>
  <div className='flex-start'>
    <div className={style.top2}>ä¸Š</div>
    <p>box-shadow: 0 -7px 5px 5px #ccc</p>
  </div>
  <div className='flex-start'>
    <div className={style.bottom2}>ä¸‹</div>
    <p>box-shadow: 0 7px 5px 5px #ccc</p>
  </div>
</div>
```78:Ta671,## 0. å‰è¨€

### 1ã€åç§°ç”±æ¥

è¯´èµ·JavaScriptç›¸å…³çš„å†å²ï¼Œè¿˜å¾—è¿½æº¯åˆ°è®¡ç®—æœºåŠå…¶ç¼–ç¨‹è¯­è¨€è¯ç”Ÿä¹‹åˆçš„é‚£æ®µæ—¶é—´ã€‚

åœ¨1959å¹´ï¼Œæ¬§æ´²çš„è®¡ç®—æœºäº§ä¸šå·²ç»å‡ºç°è“¬å‹ƒå‘å±•çš„è¿¹è±¡äº†ï¼Œç°ä»£æ„ä¹‰çš„è®¡ç®—æœºä¹Ÿè¶Šæ¥è¶Šå¤šåœ°å¼€å§‹åœ¨ç§‘ç ”æœºæ„ï¼Œæ”¿åºœç­‰ç¤¾ä¼šåœºæ‰€è¢«ä½¿ç”¨ï¼Œä½¿ç”¨çš„äººå¤šäº†ï¼Œè®¡ç®—æœºæ“ä½œæŠ€æœ¯å®ç°æ ‡å‡†åŒ–å°±è¢«æ¨ä¸Šäº†æ—¥ç¨‹ï¼Œä¾‹å¦‚ç¼–ç¨‹ï¼Œä»¥åŠè¾“å…¥å’Œè¾“å‡ºä»£ç è§„èŒƒç­‰ã€‚

è¡Œä¸šæ ‡å‡†å¯¹äºè¡Œä¸šå‘å±•çš„é‡è¦æ€§ä¸è¨€è€Œå–»ã€‚ä¸ºäº†åè°ƒæ ‡å‡†åˆ¶å®šå·¥ä½œï¼Œæ¬§æ´²æ•°æ®å¤„ç†é¢†åŸŸå†å²æœ€æ‚ ä¹…çš„å…¬å¸ï¼ˆCompagnie des Machines Bullã€IBM World Trade Europe Corporation å’Œ International Computers and Tabulators Limitedï¼‰çš„è´Ÿè´£äººå‘æ‰€æœ‰å·²çŸ¥çš„è®¡ç®—æœºå‘å‡ºäº†è”åä¿¡ã€‚æ¬§æ´²åˆ¶é€ å•†é‚€è¯·è¿™äº›å…¬å¸æ´¾ä»£è¡¨å‚åŠ ä¼šè®®ã€‚è¿™æ¬¡ä¼šè®®äº 1960 å¹´ 4 æœˆ 27 æ—¥åœ¨å¸ƒé²å¡å°”ä¸¾è¡Œï¼›å†³å®šæˆç«‹ä¸€ä¸ªåˆ¶é€ å•†åä¼šï¼Œç§°ä¸ºæ¬§æ´²è®¡ç®—æœºåˆ¶é€ å•†åä¼šï¼ˆ`European Computer Manufacturers Association`ï¼‰æˆ–ç®€ç§° `ECMA`ï¼Œå¹¶æåäº†ä¸€ä¸ªå§”å‘˜ä¼šæ¥å‡†å¤‡è¯¥åä¼šçš„æˆç«‹å¹¶åˆ¶å®šç« ç¨‹å’Œè§„åˆ™ã€‚éšåçš„ 1961 å¹´ 5 æœˆ 17 æ—¥ï¼Œåä¼šæ­£å¼æˆç«‹ã€‚

è¿™ä¾¿æ˜¯`ECMA`è¿™ä¸ªåå­—çš„æ¥æºã€‚

`ECMA`èµ°å‘å…¨çƒåï¼Œåœ¨1994 å¹´æ›´åä¸ºï¼š`Ecma International`ã€‚å…¶å•†æ ‡â€œECMAâ€ç”±äºå†å²åŸå› è¢«ä¿ç•™äº†ä¸‹æ¥ï¼Œæ²¿ç”¨è‡³ä»Šã€‚

### 2ã€ECMA-262æ ‡å‡†ï¼Œæ¢¦å¼€å§‹çš„åœ°æ–¹

`EMCA`æ ‡å‡†å®¹çº³äº†å¤§é‡é€šä¿¡ã€è®¡ç®—æœºåŠå…¶ç›¸å…³è¡Œä¸šçš„æ ‡å‡†è§„èŒƒã€‚æˆ‘ä»¬æ‰¾ä¸€ä¸‹æœ¬æ–‡çš„ä¸»è§’ã€‚

åœ¨[å®˜ç½‘](https://www.ecma-international.org/publications-and-standards/standards/)ä¸­æ‰’ä¸€å¼ å›¾ï¼š

![image.png](/img/posts/2022-6-15/2022-6-15-1.png)

å¯ä»¥çœ‹åˆ°ï¼Œç¬¬262å·æ ‡å‡†åˆå«`ECMAScript`ï¼Œæ˜¯ECMAå®šä¹‰çš„ä¸€å¥—è„šæœ¬è¯­è¨€ç¼–ç¨‹è§„èŒƒã€‚

> ECMAScript é€šå¸¸ç¼©å†™ä¸º ESã€‚

æ­£æ˜¯å› ä¸ºæœ‰è¿™ä¸ªæ ‡å‡†çš„å‡ºç°ï¼Œæ‰æœ‰äº† JavaScript çš„è“¬å‹ƒå‘å±•ï¼æ„Ÿè°¢å¤§ä½¬èµé¥­åƒï¼ï¼

ECMA-262æ˜¯ä¸€ç§è§„èŒƒï¼ˆå®˜ç½‘ä¸­å¯ä»¥æŸ¥åˆ°å„ä¸ªç‰ˆæœ¬çš„PDFææ¡ˆï¼‰ï¼Œè‡ªç„¶ä¼šæœ‰æ»¡è¶³è¿™ç§è§„èŒƒçš„å…·ä½“çš„è¯­è¨€è¢«åˆ›é€ å‡ºæ¥ã€‚æœ€è‘—åçš„å°±æ˜¯**JavaScript**
ï¼ˆç°åœ¨å•†æ ‡å±äºOracleï¼‰ï¼Œåœ¨1995å¹´ç”±[Netscape](https://baike.baidu.com/item/Netscape/2778944)å…¬å¸çš„Brendan Eichï¼Œåœ¨Netscapeå¯¼èˆªè€…æµè§ˆå™¨ä¸Šé¦–æ¬¡è®¾è®¡å®ç°è€Œæˆã€‚å› ä¸ºNetscapeä¸[Sun](https://baike.baidu.com/item/Sun/69463)åˆä½œï¼ŒNetscapeç®¡ç†å±‚å¸Œæœ›å®ƒå¤–è§‚çœ‹èµ·æ¥åƒJavaï¼Œå› æ­¤å–åä¸ºJavaScriptã€‚ä½†å®é™…ä¸Šå®ƒçš„è¯­æ³•é£æ ¼ä¸SelfåŠ[Scheme](https://baike.baidu.com/item/Scheme/8379129)è¾ƒä¸ºæ¥è¿‘ã€‚å…¶è®¾è®¡æ€è·¯å¦‚ä¸‹ï¼š

1.  å€Ÿé‰´ C è¯­è¨€çš„åŸºæœ¬è¯­æ³•ã€‚
2.  å€Ÿé‰´ Java è¯­è¨€çš„æ•°æ®ç±»å‹å’Œå†…å­˜ç®¡ç†ã€‚
3.  å€Ÿé‰´ Scheme è¯­è¨€ï¼Œå°†å‡½æ•°æå‡åˆ°â€œç¬¬ä¸€ç­‰å…¬æ°‘â€ï¼ˆfirst classï¼‰çš„åœ°ä½ã€‚
4.  å€Ÿé‰´ Self è¯­è¨€ï¼Œä½¿ç”¨åŸºäºåŸå‹ï¼ˆprototypeï¼‰çš„ç»§æ‰¿æœºåˆ¶ã€‚

> JavaScriptçš„æ˜¯ä¸€é—¨åŠ¨æ€å¼±ç±»å‹ã€åŸºäºåŸå‹çš„ä¸€ç§è§£é‡Šæ€§è®¡ç®—æœºè„šæœ¬è¯­è¨€ã€‚

åœ¨æ²¡æœ‰ JavaScript çš„å¹´ä»£ï¼Œä¸€äº›ç®€å•çš„è¡¨å•éªŒè¯ï¼ˆå¦‚å¸¸è§çš„ å¯†ç å¤æ‚åº¦éªŒè¯ï¼‰éƒ½æ˜¯ç”±æœåŠ¡ç«¯è´Ÿè´£çš„ï¼Œè€Œä¸”å½“æ—¶çš„ç½‘ç»œé€Ÿåº¦æ˜¯éå¸¸æ…¢çš„ï¼Œè¿™ç§éªŒè¯æ–¹å¼ä¼šå¯¼è‡´ç½‘ç«™çš„å“åº”é€Ÿåº¦å˜å¾—æ›´æ…¢ï¼Œäºæ˜¯ä¾¿æœ‰äº†è¿™é—¨è¯­è¨€çš„è¯ç”Ÿã€‚

å…¶æ¬¡è¿˜æœ‰å¾®è½¯è‡ªç ”çš„ä¸€å¥—è¯­è¨€ï¼Œå«`JScript`ï¼Œå…¶å£°ç§°å®Œå…¨éµå¾ª`ECMA-262`è§„èŒƒã€‚ä¸‹é¢åˆ—ä¸¾ä¸€ä¸‹äºŒè€…çš„åŒºåˆ«ï¼š

| ç‰¹ç‚¹    | JavaScript                                       | JScript          |
| ----- | ------------------------------------------------ | ---------------- |
| è¿è¡Œå¹³å°  | å®¢æˆ·ç«¯,æœåŠ¡ç«¯                                          | å®¢æˆ·ç«¯,æœåŠ¡ç«¯          |
| è§£é‡Šç¯å¢ƒ  | Netscape Livewireã€V8ï¼ˆChrome + nodeï¼‰ã€TraceMonkeyç­‰ | WSHã€ASPã€.Net     |
| æ”¯æŒæµè§ˆå™¨ | æ‰€æœ‰ä¸»æµæµè§ˆå™¨                                          | ä¸»è¦æ˜¯IE3.0+        |
| å‡ºç°æ—¶é—´  | æ¯”è¾ƒæ—©ï¼Œç”šè‡³æ—©äºECMA-262                                 | VBScriptç«äº‰å¤±è´¥åçš„äº§ç‰© |

## 1. JavaScript 1.0 ï¼ˆ96å¹´ï¼‰

å‘å¸ƒäº1996å¹´ï¼Œé€‚ç”¨äºNetscape Navigator2.0æµè§ˆå™¨ï¼Œåˆæ­¥ç¡®å®šäº†å®Œæ•´çš„JavaScriptçš„ä¸‰ä¸ªæ„æˆè¦ç´ ï¼š

1.  ECMAScriptï¼ˆå§‘ä¸”è¿™ä¹ˆå«ï¼Œ1.3ç‰ˆæœ¬æ‰æ­£å¼å®Œå…¨å…¼å®¹ECMAè§„èŒƒï¼‰ã€‚JavaScript çš„æ ¸å¿ƒéƒ¨åˆ†ï¼Œå®ƒè§„å®šäº† JavaScript çš„è¯­æ³•ã€ç±»å‹ã€è¯­å¥ã€ å…³é”®å­—ã€ä¿ç•™å­—ã€è¿ç®—ç¬¦å’Œå¯¹è±¡ã€‚

2.  DOMï¼ˆDocument Object Modelï¼‰ã€‚é€šè¿‡æŠŠæ•´ä¸ªé¡µé¢æ˜ å°„æˆä¸€ä¸ªæ ‘ç»“æ„çš„æ–‡æ¡£ï¼Œæä¾› äº†ä¸€å¥—å¯ä»¥è®¿é—® HTML å’Œ XMLï¼ˆeXtensible Markup Languageï¼‰èŠ‚ç‚¹çš„ APIï¼ˆApplication Programming Interfaceï¼‰ï¼Œå¼€å‘è€…å¯ä»¥åˆ©ç”¨å®ƒè½»æ¾åœ°åˆ é™¤ã€æ·»åŠ ã€æ›¿æ¢æˆ–ä¿®æ”¹ä»»ä½•èŠ‚ç‚¹ã€‚

3.  BOMï¼ˆBrowser Object Modelï¼‰ã€‚æä¾›äº†è®¿é—®æµè§ˆå™¨çª—å£çš„æ–¹æ³•ï¼Œå¼€å‘è€…å¯ä»¥æ§åˆ¶æµ è§ˆå™¨çª—å£è¿›è¡Œä¸€äº›è¯¸å¦‚ç§»åŠ¨çª—å£ä¹‹ç±»çš„æ“ä½œã€‚BOM éƒ¨åˆ†çš„æœ‰å…³å®šä¹‰ï¼Œé›¶æ•£åˆ†å¸ƒåœ¨å„ç§æ ‡ å‡†ä¸­ï¼Œä¸»è¦ä½äº HTML æ ‡å‡†ã€‚å…¶ä»–æ¯”å¦‚ WebRTC æ ‡å‡†ç­‰å†…ä¹Ÿå®šä¹‰äº†ä¸€äº›æ¥å£ã€‚

> 1.0é‡Œæœ‰ä¸€äº›ä»¥åå¾ˆå°‘ç”¨çš„å†·é—¨ç‰¹æ€§ã€‚æ¯”å¦‚å‡½æ•°ä¸ä½†æœ‰callï¼Œapplyæ–¹æ³•ï¼Œè¿˜æœ‰nameå’Œlengthï¼Œè¿˜æœ‰`arguments`ï¼ŒÂ `caller`ï¼ˆåœ¨1.2ç‰ˆç§»é™¤ï¼‰ï¼›Argumentsæ˜¯ä¸ªå¯¹è±¡è€Œä¸æ˜¯æ•°ç»„ï¼›å¯¹è±¡å¯ä»¥ç”¨æ•°å­—ä¸‹æ ‡è®¿é—®å±æ€§ï¼›æ²¡æœ‰===çš„å¼ºç±»å‹åˆ¤å®šï¼›å¯¹ä¸æ”¯æŒscriptæ ‡ç­¾çš„æµè§ˆå™¨åšç‰¹æ®Šæ³¨é‡Šå…¼å®¹ç­‰ã€‚

## 2. JavaScript 1.1ï¼ˆ96å¹´ï¼‰

å‘å¸ƒäº1996å¹´ä¸‹åŠå¹´ï¼Œé€‚é…äº†Netscape Navigator3.0 å’Œ IE3.0ã€‚å®Œå–„æ•°ç»„å¯¹è±¡å’Œæ–¹æ³•ã€‚

## 3. JavaScript 1.2ï¼ˆ97å¹´ï¼‰

å‘å¸ƒäº1997å¹´ï¼Œé€‚é…äº†Netscape Navigator4.0ï¼Œä½†ä¸æ”¯æŒ IE ç¯å¢ƒã€‚å¢åŠ äº†===çš„åˆ¤æ–­æ–¹å¼ã€‚

## 4. JavaScript 1.3 ä¸ ECMAScript 1/2ï¼ˆ98å¹´ï¼‰

å‘å¸ƒäº1998å¹´ã€‚å‰è¾¹è¯´JavaScriptå‡ºç°æ—¶é—´æ—©äºECMA-262ï¼ŒæŒ‡çš„å°±æ˜¯è¿™ä¸ªç‰ˆæœ¬çš„äº‹æƒ…ã€‚è¿™ä¸€å¹´ï¼ŒECMAæ ‡å‡†åŒ–äº†JavaScript1.1çš„åŸºæœ¬ç‰¹æ€§ï¼ŒåŒæ—¶JavaScriptä¹Ÿå‡çº§åˆ°1.3ï¼Œå¹¶æ·»åŠ äº†ä¸€äº›æ–°ç‰¹æ€§ï¼ˆæ²¡æœ‰æ ‡å‡†åŒ–switchè¯­å¥å’Œæ­£åˆ™è¡¨è¾¾å¼ï¼‰ã€‚è‡³æ­¤ï¼ŒJavaScriptæ‰é€æ­¥éµå¾ªECMAè§„èŒƒè¿›è¡Œå‡çº§æ¢ä»£ã€‚

ECMAScript 2æ ‡å‡†æ˜¯å¯¹v1çš„ä¸€ä¸ªç»´æŠ¤ç‰ˆæœ¬ï¼Œåªæ·»åŠ äº†è¯´æ˜ï¼Œä¹Ÿåœ¨åŒä¸€å¹´å‘å¸ƒã€‚

## 5. JavaScript 1.4ï¼ˆ99å¹´ï¼‰

é€‚ç”¨äºNetscape serverçš„ä¸“ç”¨ç‰ˆæœ¬ã€‚

## 6. JavaScript 1.5 ä¸ ECMAScript 3ï¼ˆ00å¹´ï¼‰

å‘å¸ƒäº2000å¹´åº•ï¼Œå¼€å§‹æ”¯æŒ Mozilla Firefox å’Œ Opera æµè§ˆå™¨ï¼Œå¹¶æ ‡å‡†åŒ–äº†switchè¯­å¥ã€å¼‚å¸¸å¤„ç†( try/catch)å’Œæ­£åˆ™è¡¨è¾¾å¼ã€‚

## 7. JavaScript 1.6ï¼ˆ05å¹´ï¼‰

2005å¹´å‘å¸ƒã€‚é€æ­¥å¢åŠ äº†æ•°ç»„çš„æ‰©å±•æ–¹æ³•ã€å¢åŠ äº†Arrayå’ŒStringæ³›å‹ã€æ”¯æŒXMLæ‰©å±•ï¼ˆE4Xï¼‰ã€‚å¼€å§‹æ”¯æŒSafari 3.0ã€‚åŒå¹´ï¼ŒAjaxæŠ€æœ¯å‘å¸ƒã€‚

æ–°å¢çš„æ•°ç»„æ‰©å±•å¦‚ä¸‹ï¼ˆéƒ¨åˆ†æ‰©å±•åœ¨ES5ä¸­é€æ­¥è§„èŒƒåŒ–ï¼‰ï¼š

| æ–°å¢æ‰©å±•          | æè¿°                                           |
| ------------- | -------------------------------------------- |
| indexOf()     | è¿”å›æŒ‡å®šé¡¹é¦–æ¬¡å‡ºç°çš„index                              |
| lastIndexOf() | è¿”å›æŒ‡å®šé¡¹æœ€åä¸€æ¬¡å‡ºç°çš„index                            |
| every()       | åœ¨æ•°ç»„ä¸­çš„æ¯ä¸€ä¸ªé¡¹è¿è¡Œä¸€ä¸ªå‡½æ•°ã€‚å¦‚æ–¹æ³•å¯ç”¨éå†æ¯ä¸€ä¸ªé¡¹éƒ½è¿”å›çš„trueï¼Œåˆ™è¿”å›true  |
| filter()      | åœ¨æ•°ç»„ä¸­çš„æ¯ä¸€ä¸ªé¡¹è¿è¡Œä¸€ä¸ªå‡½æ•°ï¼Œå¹¶å°†è¿™ä¸ªå‡½æ•°è¿”å›trueçš„é¡¹ä½œä¸ºä¸€ä¸ªæ•°ç»„è¿”å›       |
| forEach()     | åœ¨æ•°ç»„ä¸­çš„æ¯ä¸€ä¸ªé¡¹è¿è¡Œä¸€ä¸ªå‡½æ•°                              |
| map()         | åœ¨æ•°ç»„ä¸­çš„æ¯ä¸€ä¸ªé¡¹è¿è¡Œä¸€ä¸ªå‡½æ•°ï¼Œå¹¶å°†æ‰€æœ‰çš„ç»“æœä½œä¸ºæ•°ç»„è¿”å›                |
| some()        | åœ¨æ•°ç»„ä¸­çš„æ¯ä¸€ä¸ªé¡¹è¿è¡Œä¸€ä¸ªå‡½æ•°ï¼Œå¦‚æœè¿™ä¸ªæ–¹æ³•è®¿é—®çš„ä»»ä½•ä¸€ä¸ªé¡¹è¿”å›trueï¼Œåˆ™è¿”å›true |

æ³›å‹ï¼ˆéTSçš„é‚£ç§ï¼‰ä½¿ç”¨ï¼š

```js
functionÂ isLetter(character)Â {Â Â 
  returnÂ (characterÂ >=Â "a"Â &&Â characterÂ <=Â "z");Â Â 
}Â Â 

// åœ¨å­—ç¬¦ä¸²ä¸­ä½¿ç”¨æ•°ç»„çš„æ–¹æ³•
ifÂ (Array.every(str,Â isLetter))Â Â 
  alert("TheÂ stringÂ '"Â +Â strÂ +Â "'Â containsÂ onlyÂ letters!");
```

## 8. JavaScript 1.7ï¼ˆ07å¹´ï¼‰

2007å¹´å‘å¸ƒã€‚æ–°ç‰¹æ€§å¦‚ä¸‹ï¼š

*   å­¦ä¹ äº†Pythonçš„è¯­æ³•ï¼Œå¹¶å¼•å…¥äº†Pythonic generatorsï¼ˆgeneratorå‡½æ•°ï¼‰ã€
*   å¼•å…¥è§£æ„èµ‹å€¼
*   Iteratorsï¼ˆè¿­ä»£å™¨ï¼‰
*   let å£°æ˜

> è¿™ä»ç„¶æ˜¯ES3çš„å†…å®¹ï¼Œä¸è¦è®¤ä¸ºæ˜¯ES6æ‰æœ‰çš„ã€‚

*   å¼€å§‹æ”¯æŒ Google Chrome1.0ã€‚

## 9. ECMAScript 4

2008å¹´è¢«åºŸå¼ƒçš„æ ‡å‡†ã€‚[æ­»äº¡åŸå› ](https://www.136.la/jingpin/show-14541.html)

## 10. JavaScript 1.8 ï¼ˆ08-10å¹´ï¼‰ ä¸ ECMAScript 5 ï¼ˆ09å¹´ï¼‰

åŒ…å«å¾ˆå¤špatchç‰ˆæœ¬ã€‚

#### 2008å¹´å‘å¸ƒ 1.8.0

æ–°ç‰¹æ€§ï¼š

| æ–°ç‰¹æ€§    | æè¿°                                   |
| ------ | ------------------------------------ |
| è¡¨è¾¾å¼é—­åŒ…  | è§ä¸‹é¢ä»£ç                                 |
| ç”Ÿæˆå™¨è¡¨è¾¾å¼ | ä¸ªæ–°ç‰¹æ€§ä½¿ä½ å¯ä»¥ä½¿ç”¨ç±»ä¼¼æ•°ç»„æ¦‚å¿µçš„è¯­æ³•æ¥åˆ›å»ºä¸€ä¸ªç‹¬ç«‹çš„ç”Ÿæˆå™¨å¥æŸ„ï¼Œè§ä»£ç  |

è¡¨è¾¾å¼é—­åŒ…ï¼š

```js
// JavaScript 1.7 ä»¥åŠæ›´è€çš„ç‰ˆæœ¬:
function(x) { return x * x; }

// JavaScript 1.8:
function(x) x * x;
```

ç”Ÿæˆå™¨è¡¨è¾¾å¼

```js
// ä½¿ç”¨1
let it = (i + 3 for (i in someObj));
try {
    while (true) {
        document.write(it.next() + "<br>\n");
    }
} catch (err if err instanceof StopIteration) {

    document.write("End of record.<br>\n");
}

// ä½¿ç”¨2
function handleResults( results ) {
    for ( let i in results )
    ...
}
handleResults( i for ( i in obj ) if ( i > 3 ) );
```

#### åŒå¹´å‘å¸ƒ 1.8.1

æ–°ç‰¹æ€§ï¼š

| æ–°ç‰¹æ€§                     | æè¿°                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| ----------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Object.getPrototypeOf() | è¿”å›æŒ‡å®šå¯¹è±¡çš„åŸå‹å¯¹è±¡ï¼Œè§[`ç¤ºä¾‹`](https://developer.mozilla.org/En/Core_JavaScript_1.5_Reference/Global_Objects/Object/GetPrototypeOf)                                                                                                                                                                                                                                                                                                                              |
| Firefox 3.5 åŸç”Ÿæ”¯æŒ JSON   | -                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| Stringå¯¹è±¡æ–°å¢æ–¹æ³•            | [`String`Â ](https://developer.mozilla.org/en/Core_JavaScript_1.5_Reference/Global_Objects/String)Â Â å¢åŠ Â Â [`trim()`Â ](https://developer.mozilla.org/En/Core_JavaScript_1.5_Reference/Global_Objects/String/Trim),Â Â Â [`trimLeft()`Â ](https://developer.mozilla.org/En/Core_JavaScript_1.5_Reference/Global_Objects/String/TrimLeft), å’ŒÂ Â Â [`trimRight()`Â ](https://developer.mozilla.org/En/Core_JavaScript_1.5_Reference/Global_Objects/String/TrimRight) |
| å…¶ä»–ä¸€äº›æ¬¡è¦æ›´æ–°                | -                                                                                                                                                                                                                                                                                                                                                                                                                                                     |

#### 2009å¹´å‘å¸ƒ 1.8.2

ä¸€äº›æ¬¡è¦æ›´æ–°ã€‚

#### 2010å¹´å‘å¸ƒ 1.8.5ï¼Œå¹¶éµå¾ªECMAScript 5 ï¼ˆ2009å¹´å‘å¸ƒï¼‰è§„èŒƒ

ä¸€æ¬¡å¤§çš„æ›´æ–°ï¼Œå°†ä¹‹å‰JSå„ä¸ªç‰ˆæœ¬çš„æ–¹æ³•è¿›è¡Œç»Ÿä¸€æ±‡æ€»æ•´ç†ï¼Œå¹¶æ–°åŠ å…¥ä¸€æ‰¹APIï¼Œä¸€èµ·å†™å…¥è§„èŒƒï¼Œä½¿å¾—ESå’ŒJSçš„è´´åˆç¨‹åº¦æ›´æ·±ã€‚

| æ–°ç‰¹æ€§       | æè¿°           |
| --------- | ------------ |
| æ·»åŠ äº†â€œä¸¥æ ¼æ¨¡å¼â€ | use 'strict' |
| è§„èŒƒthiså…³é”®å­— | -            |
| å¯¹ JSONæ”¯æŒ  | -            |
| å­—ç¬¦ä¸²æ–¹æ³•     | è§ä¸‹åˆ—è¡¨         |
| æ•°ç»„æ–¹æ³•      | è§ä¸‹åˆ—è¡¨         |
| å„ç§å¯¹è±¡æ–¹æ³•    | è§ä¸‹åˆ—è¡¨         |

*   **ä¸¥æ ¼æ¨¡å¼**

1.  ä¸å…è®¸çœç•¥varå®šä¹‰å˜é‡
2.  ä¸å…è®¸å‡½æ•°å½¢å‚åŒå
3.  ä¸å…è®¸æ™®é€šå‡½æ•°ä¸­çš„thisä»£è¡¨window

*   **thisè§„èŒƒ**

1.  å…¨å±€thisã€æ™®é€šå‡½æ•°çš„this ã€ è‡ªè°ƒç”¨å‡½æ•°çš„thiséƒ½ä»£è¡¨window
2.  äº‹ä»¶å‡½æ•°ä¸­çš„thisä»£è¡¨äº‹ä»¶æº
3.  å¯¹è±¡æ–¹æ³•ä¸­çš„thisä»£è¡¨å½“å‰å¯¹è±¡
4.  æ™®é€šå‡½æ•°è¢«è°è°ƒç”¨ï¼Œå‡½æ•°ä¸­thisæŒ‡å‘è°

*   **ES5 æ–°å¢æ•°ç»„æ–¹æ³•/è§„èŒƒ**ï¼ˆéƒ¨åˆ†æ–¹æ³•js1.6ä¸­å·²ç»æœ‰è¿‡å®ç°ï¼Œåœ¨ES5æ­£å¼å†™å…¥è§„èŒƒï¼‰

1.  Array.isArray()
2.  Array.forEach()
3.  Array.map()
4.  Array.filter()
5.  Array.reduce()
6.  Array.reduceRight()
7.  Array.every()
8.  Array.some()
9.  Array.indexOf()
10. Array.lastIndexOf()

*   **ES5æ–°å¢å­—ç¬¦ä¸²è§„èŒƒ**

1.  String.trim()
2.  charAt()
3.  å¯å¯¹å­—ç¬¦ä¸²è¿›è¡Œå±æ€§è®¿é—®
4.  å…è®¸å¤šè¡Œå­—ç¬¦ä¸²ï¼Œæ¯ä¸€è¡Œä½¿ç”¨åæ–œæ ç»“å°¾
5.  String.fromCharCode() ç”¨äºä» Unicode ç ç‚¹è¿”å›å¯¹åº”å­—ç¬¦

*   **ES5 æ–°å¢å„ç§å¯¹è±¡æ–¹æ³•**

1.  JSON.parse()
2.  JSON.stringify()
3.  Date.now()
4.  å±æ€§ Getter å’Œ Setter
5.  æ–°çš„å¯¹è±¡å±æ€§å’Œæ–¹æ³•è§„èŒƒï¼Œè§ä¸‹è¡¨

| æ–°çš„å¯¹è±¡å±æ€§å’Œæ–¹æ³•è§„èŒƒ                                         | æè¿°                                     |
| --------------------------------------------------- | -------------------------------------- |
| Object.defineProperty(object, property, descriptor) | æ·»åŠ æˆ–æ›´æ”¹å¯¹è±¡å±æ€§                              |
| Object.defineProperties(object, descriptors)        | æ·»åŠ æˆ–æ›´æ”¹å¤šä¸ªå¯¹è±¡å±æ€§                            |
| Object.getOwnPropertyDescriptor(object, property)   | è®¿é—®å±æ€§                                   |
| Object.getOwnPropertyNames(object)                  | å°†æ‰€æœ‰å±æ€§ä½œä¸ºæ•°ç»„è¿”å›                            |
| Object.keys(object)                                 | å°†å¯æšä¸¾å±æ€§ä½œä¸ºæ•°ç»„è¿”å›                           |
| Object.hasOwnProperty(key)                          | æ˜¯å¦ä¸ºå¯¹è±¡è‡ªèº«å±æ€§                              |
| Object.getPrototypeOf(object)                       | è·å–å¯¹è±¡åŸå‹                                 |
| Object.preventExtensions(object)                    | é˜²æ­¢å‘å¯¹è±¡æ·»åŠ æ–°çš„å±æ€§                            |
| Object.isExtensible(object)                         | å¦‚æœå¯ä»¥å°†å±æ€§æ·»åŠ åˆ°å¯¹è±¡ï¼Œåˆ™è¿”å› true                  |
| Object.seal(object)                                 | é˜²æ­¢æ›´æ”¹å¯¹è±¡å±æ€§ï¼ˆè€Œä¸æ˜¯å€¼ï¼‰å¯¹è±¡ä¸å¯ä»¥æ–°å¢å±æ€§å’Œåˆ é™¤ ä½†æ˜¯å¯ä»¥ä¿®æ”¹      |
| Object.isSealed(object)                             | å¦‚æœå¯¹è±¡è¢«å¯†å°ï¼Œåˆ™è¿”å› true                       |
| Object.freeze(object)                               | é˜²æ­¢å¯¹å¯¹è±¡è¿›è¡Œä»»ä½•æ›´æ”¹ ä¸å¯ä»¥æ–°å¢å±æ€§å’Œåˆ é™¤ä¹Ÿä¸å¯ä¿®æ”¹ å®Œå…¨é”æ­»       |
| Object.isFrozen(object)                             | å¦‚æœå¯¹è±¡è¢«å†»ç»“ï¼Œåˆ™è¿”å› true                       |
| å…è®¸ä¿ç•™å­—ä½œä¸ºå±æ€§åç§°                                         | `var obj = {name: "Bill", new: "yes"}` |

*   **ES5 è¯­æ³•æ›´æ”¹**

1.  å¯¹å­—ç¬¦ä¸²çš„å±æ€§è®¿é—® \[ ]
2.  æ•°ç»„å’Œå¯¹è±¡å­—é¢é‡ä¸­çš„å°¾éšé€—å·ï¼ˆJSONé™¤å¤–ï¼‰
3.  å¤šè¡Œå­—ç¬¦ä¸²å­—é¢é‡
4.  ä½œä¸ºå±æ€§åç§°çš„ä¿ç•™å­—

*   **ES5 æµè§ˆå™¨æ”¯æŒ**

Chrome 23ã€IE 10 å’Œ Safari 6 æ˜¯ç¬¬ä¸€æ‰¹å®Œå…¨æ”¯æŒ ECMAScript 5 çš„æµè§ˆå™¨ï¼š

| Chrome23                                                                                                                                                                                | IE10/Edge                                                                                                                                                                           | Firefox21                                                                                                                                                                                | Safari6                                                                                                                                                                                 | Opera15                                                                                                                                                                                |
| --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| ![compatible\_chrome.png](/img/posts/2022-6-15/chrome.png) | ![compatible\_ie.png](/img/posts/2022-6-15/ie.png) | ![compatible\_firefox.png](/img/posts/2022-6-15/firefox.png) | ![compatible\_safari.png](/img/posts/2022-6-15/safari.png) | ![compatible\_opera.png](/img/posts/2022-6-15/opera.png) |
| 2012å¹´9æœˆ                                                                                                                                                                                 | 2012å¹´9æœˆ                                                                                                                                                                             | 2013å¹´4æœˆ                                                                                                                                                                                  | 2012å¹´7æœˆ                                                                                                                                                                                 | 2013å¹´7æœˆ                                                                                                                                                                                |

## 11. ECMAScript 6 ï¼ˆ2015å¹´ï¼‰

2015å¹´å‘å¸ƒES6ï¼Œåˆæ˜¯ä¸€æ¬¡é‡å¤§æ›´æ–°ï¼š

| æ–°çš„ç‰¹æ€§å’Œæ‰©å±•  | æè¿°                                                                                                                                                        |
| -------- | --------------------------------------------------------------------------------------------------------------------------------------------------------- |
| å˜é‡å£°æ˜     | **let**ï¼š js1.7ä¸­å·²ç»æœ‰è¿‡å®ç°ï¼Œè¿™é‡Œé‡æï¼Œè¯´æ˜å—çº§ä½œç”¨åŸŸçš„é‡è¦æ€§ï¼›**const**ï¼šå¸¸é‡ï¼›**å˜é‡è§£æ„èµ‹å€¼**ï¼š`let \[a, b, c] = \[1, 2, 3]; let { foo, bar } = { foo: 'aaa', bar: 'bbb' }; `               |
| å¹‚ (\*\*) | æŒ‡æ•°è¿ç®—ç¬¦, Math.pow() ?                                                                                                                                       |
| é»˜è®¤å‚æ•°å€¼    | å‡½æ•°å£°æ˜æ—¶å¯ä»¥åˆ¶å®šé»˜è®¤å‚æ•°                                                                                                                                             |
| å­—ç¬¦ä¸²æ‰©å±•    | è§ä¸‹é¢åˆ—è¡¨                                                                                                                                                     |
| æ­£åˆ™æ‰©å±•     | è§ä¸‹é¢åˆ—è¡¨                                                                                                                                                     |
| æ•°ç»„æ‰©å±•     | è§ä¸‹é¢åˆ—è¡¨                                                                                                                                                     |
| å¯¹è±¡æ‰©å±•     | è§ä¸‹é¢åˆ—è¡¨                                                                                                                                                     |
| æ–°çš„æ•°å­—å±æ€§   | ES6 å°†ä»¥ä¸‹å±æ€§æ·»åŠ åˆ° Number å¯¹è±¡ï¼š EPSILONã€MIN\_SAFE\_INTEGERã€MAX\_SAFE\_INTEGER                                                                                     |
| æ–°çš„æ•°å­—æ–¹æ³•   | Number.isInteger() ã€Number.isSafeInteger()ï¼Œ Mathä¹Ÿæ–°å¢äº†17ä¸ª[é™æ€æ–¹æ³•](https://es6.ruanyifeng.com/#docs/number#Math-%E5%AF%B9%E8%B1%A1%E7%9A%84%E6%89%A9%E5%B1%95) |
| æ–°çš„å…¨å±€æ–¹æ³•   | isFinite()ã€isNaN()                                                                                                                                        |
| å‡½æ•°æ‰©å±•     | 1ã€å¼•å…¥ç®­å¤´å‡½æ•°ï¼šæ²¡æœ‰è‡ªå·±çš„thisã€æ²¡æœ‰é€’å½’ï¼Œäº‹ä»¶ç»‘å®šï¼Œè§£ç»‘å®šã€æ²¡æœ‰æ„é€ å™¨ã€ä¸å¯å…·ååŒ–ã€ä¹¦å†™ç®€å• 2ã€å¼•å…¥restå‚æ•° 3ã€å¢åŠ Function.prototype.toString()                                                            |
| Symbol   | æ–°çš„åŸå§‹æ•°æ®ç±»å‹, è¡¨ç¤ºç‹¬ä¸€æ— äºŒçš„å€¼                                                                                                                                        |
| æ–°å¢æ•°æ®ç»“æ„   | Setå’ŒMap                                                                                                                                                   |
| Proxy    | å¯¹è±¡ä»£ç†ï¼Œè¯¦è§é˜®è€å¸ˆçš„[è§£é‡Š](https://es6.ruanyifeng.com/#docs/proxy)                                                                                                   |
| Reflect  | ä¸ºäº†æ“ä½œå¯¹è±¡è€Œæä¾›çš„æ–° API                                                                                                                                           |
| å‰ç«¯å¼‚æ­¥ç­–ç•¥   | Promiseï¼ˆé€šå¸¸ä¸ES2017çš„asyncä¸€èµ·ä½¿ç”¨ï¼‰                                                                                                                              |
| è¿­ä»£å™¨      | å°†Iterator ã€ for...of å¾ªç¯ å’Œ Generatorå‡½æ•°å†™å…¥è§„èŒƒ                                                                                                                 |
| Classå£°æ˜  | å¢åŠ ç»§æ‰¿ã€æ¥å£ç­‰æ¦‚å¿µ                                                                                                                                                |
| ESModule | jsåŸç”Ÿæ”¯æŒæ¨¡å—åŒ–                                                                                                                                                 |
| æ–°å¢ææ¡ˆ     | è£…é¥°å™¨Decoratorã€do è¡¨è¾¾å¼ã€throw è¡¨è¾¾å¼ã€å‡½æ•°çš„éƒ¨åˆ†æ‰§è¡Œã€ç®¡é“è¿ç®—ç¬¦ã€Math.signbit()ã€åŒå†’å·è¿ç®—ç¬¦ã€Realm APIã€#!å‘½ä»¤ã€import.metaã€JSON æ¨¡å—                                                      |
| æ–°å¢è§„æ ¼æ–‡ä»¶   | -                                                                                                                                                         |

*   **å­—ç¬¦ä¸²æ‰©å±•**

1.  å­—ç¬¦ä¸²Unicodeæ ‡è¯†æ³•ï¼Œå¹¶å…è®¸ç›´æ¥è¾“å…¥å­—ç¬¦
2.  å¼•å…¥å­—ç¬¦ä¸²éå†å™¨
3.  JSON.stringifyæ”¹é€ 
4.  å¼•å…¥æ¨¡æ¿å­—ç¬¦ä¸²ã€æ ‡ç­¾æ¨¡æ¿æ¸²æŸ“
5.  æ–°å¢ä¸€äº›æ–¹æ³•ï¼Œè§ä¸‹è¡¨

| å­—ç¬¦ä¸²æ–¹æ³•                  | æè¿°                                         |
| ---------------------- | ------------------------------------------ |
| String.fromCodePoint() | å¯ä»¥è¯†åˆ«å¤§äº`0xFFFF`çš„å­—ç¬¦                          |
| String.raw()           | è¿”å›ä¸€ä¸ªæ–œæ éƒ½è¢«è½¬ä¹‰ï¼ˆå³æ–œæ å‰é¢å†åŠ ä¸€ä¸ªæ–œæ ï¼‰çš„å­—ç¬¦ä¸²ï¼Œå¾€å¾€ç”¨äºæ¨¡æ¿å­—ç¬¦ä¸²çš„å¤„ç†æ–¹æ³• |
| codePointAt            | èƒ½å¤Ÿæ­£ç¡®å¤„ç† 4 ä¸ªå­—èŠ‚å‚¨å­˜çš„å­—ç¬¦ï¼Œè¿”å›ä¸€ä¸ªå­—ç¬¦çš„ç ç‚¹ã€‚               |
| normalize              | å°†å­—ç¬¦çš„ä¸åŒè¡¨ç¤ºæ–¹æ³•ç»Ÿä¸€ä¸ºåŒæ ·çš„å½¢å¼ï¼Œè¿™ç§°ä¸º Unicode æ­£è§„åŒ–ã€‚        |
| startsWith             | è¿”å›å¸ƒå°”å€¼ï¼Œè¡¨ç¤ºå‚æ•°å­—ç¬¦ä¸²æ˜¯å¦åœ¨åŸå­—ç¬¦ä¸²çš„å¤´éƒ¨ã€‚                   |
| endsWith               | è¿”å›å¸ƒå°”å€¼ï¼Œè¡¨ç¤ºå‚æ•°å­—ç¬¦ä¸²æ˜¯å¦åœ¨åŸå­—ç¬¦ä¸²çš„å°¾éƒ¨ã€‚                   |
| repeat                 | è¿”å›ä¸€ä¸ªæ–°å­—ç¬¦ä¸²ï¼Œè¡¨ç¤ºå°†åŸå­—ç¬¦ä¸²é‡å¤`n`æ¬¡ã€‚                    |
| at                     | æ¥å—ä¸€ä¸ªæ•´æ•°ä½œä¸ºå‚æ•°ï¼Œè¿”å›å‚æ•°æŒ‡å®šä½ç½®çš„å­—ç¬¦ï¼Œæ”¯æŒè´Ÿç´¢å¼•ï¼ˆå³å€’æ•°çš„ä½ç½®ï¼‰ã€‚      |

*   **æ­£åˆ™æ‰©å±•**

1.  RegExpæ„é€ å‡½æ•°å¢åŠ ç¬¬äºŒä¸ªå‚æ•°
2.  ES6 å‡ºç°ä¹‹å‰ï¼Œå­—ç¬¦ä¸²å¯¹è±¡å…±æœ‰ 4 ä¸ªæ–¹æ³•ï¼Œå¯ä»¥ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼ï¼š`match()`ã€`replace()`ã€`search()`å’Œ`split()`ã€‚ES6ä¸­RegExpé›†æˆäº†è¿™å››ä¸ªæ–¹æ³•ã€‚
3.  `u`ä¿®é¥°ç¬¦
4.  æ–°å¢RegExp.prototype.unicode å±æ€§
5.  æ–°å¢RegExp.prototype.sticky å±æ€§
6.  æ–°å¢RegExp.prototype.flags å±æ€§

*   **æ•°ç»„æ‰©å±•**

1.  å¼•å…¥æ‰©å±•è¿ç®—ç¬¦
2.  Array.from()
3.  Array.of()
4.  å®ä¾‹æ–¹æ³•ï¼šcopyWithin()
5.  å®ä¾‹æ–¹æ³•ï¼šfind() å’Œ findIndex()
6.  å®ä¾‹æ–¹æ³•ï¼šfill()
7.  å®ä¾‹æ–¹æ³•ï¼šentries()ï¼Œkeys() å’Œ values()
8.  æ•°ç»„çš„ç©ºä½å®šä¹‰
9.  Array.prototype.sort() çš„æ’åºç¨³å®šæ€§é—®é¢˜ï¼šå¸¸è§çš„æ’åºç®—æ³•ä¹‹ä¸­ï¼Œæ’å…¥æ’åºã€åˆå¹¶æ’åºã€å†’æ³¡æ’åºç­‰éƒ½æ˜¯ç¨³å®šçš„ï¼Œå †æ’åºã€å¿«é€Ÿæ’åºç­‰æ˜¯ä¸ç¨³å®šçš„ã€‚ä¸ç¨³å®šæ’åºçš„ä¸»è¦ç¼ºç‚¹æ˜¯ï¼Œå¤šé‡æ’åºæ—¶å¯èƒ½ä¼šäº§ç”Ÿé—®é¢˜ã€‚åœ¨ES2019æ‰è§£å†³ã€‚

*   **å¯¹è±¡æ‰©å±•**

1.  keyå’Œå˜é‡æ˜¯åŒä¸€ä¸ªå•è¯æ—¶ï¼Œå¯ç®€å†™
2.  å±æ€§åè¡¨è¾¾å¼å†™æ³•ï¼š`obj['a' + 'bc'] = 123;`
3.  æ–¹æ³•æœ‰nameå±æ€§
4.  Object.assign()
5.  å¯¹è±¡å±æ€§éå†æ–¹å¼ï¼šfor...inã€Object.keys(obj)ã€Object.getOwnPropertyNames(obj)ã€Object.getOwnPropertySymbols(obj)ã€Reflect.ownKeys(obj)
6.  superå…³é”®å­—
7.  å¯¹è±¡æ‰©å±•`...`
8.  Object.is()ï¼šES5 æ¯”è¾ƒä¸¤ä¸ªå€¼æ˜¯å¦ç›¸ç­‰ï¼Œåªæœ‰ä¸¤ä¸ªè¿ç®—ç¬¦ï¼šç›¸ç­‰è¿ç®—ç¬¦ï¼ˆ`==`ï¼‰å’Œä¸¥æ ¼ç›¸ç­‰è¿ç®—ç¬¦ï¼ˆ`===`ï¼‰ã€‚å®ƒä»¬éƒ½æœ‰ç¼ºç‚¹ï¼Œå‰è€…ä¼šè‡ªåŠ¨è½¬æ¢æ•°æ®ç±»å‹ï¼Œåè€…çš„`NaN`ä¸ç­‰äºè‡ªèº«ï¼Œä»¥åŠ`+0`ç­‰äº`-0`ã€‚JavaScript ç¼ºä¹ä¸€ç§è¿ç®—ï¼Œåœ¨æ‰€æœ‰ç¯å¢ƒä¸­ï¼Œåªè¦ä¸¤ä¸ªå€¼æ˜¯ä¸€æ ·çš„ï¼Œå®ƒä»¬å°±åº”è¯¥ç›¸ç­‰ã€‚

*   **ES6 æµè§ˆå™¨æ”¯æŒ**

Safari 10 å’Œ Edge 14 æ˜¯é¦–å…ˆå®Œå…¨æ”¯æŒ ES6 çš„æµè§ˆå™¨ï¼š

| Chrome 58                                                                                                                                                                               | Edge 14                                                                                                                                                                             | Firefox 54                                                                                                                                                                               | Safari 10                                                                                                                                                                               | Opera 55                                                                                                                                                                               |
| --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| ![compatible\_chrome.png](/img/posts/2022-6-15/chrome.png) | ![compatible\_ie.png](/img/posts/2022-6-15/ie.png) | ![compatible\_firefox.png](/img/posts/2022-6-15/firefox.png) | ![compatible\_safari.png](/img/posts/2022-6-15/safari.png) | ![compatible\_opera.png](/img/posts/2022-6-15/opera.png) |
| Jan 2017                                                                                                                                                                                | Aug 2016                                                                                                                                                                            | Mar 2017                                                                                                                                                                                 | Jul 2016                                                                                                                                                                                | Aug 2018                                                                                                                                                                               |

> ES6ä¹‹åæ²¡æœ‰å°æ•°å­—ç‰ˆæœ¬çš„ECMAScriptäº†ï¼Œå–è€Œä»£ä¹‹çš„æ˜¯ä»¥å¹´ä»½ä¸ºä»£å·çš„ç‰ˆæœ¬ï¼Œå› ä¸ºæ¯ä¸€å¹´éƒ½ä¼šæœ‰ä¸€ä¸ªç‰ˆæœ¬ã€‚ç½‘ä¼ çš„ES7ã€ES8ä»€ä¹ˆçš„ï¼Œå…¶å®å®˜æ–¹æ²¡æœ‰è¿™ç§å«æ³•ã€‚

## 12. ECMAScript 2016

2016å¹´å‘å¸ƒã€‚

| æ–°ç‰¹æ€§                      | æè¿°                                                |
| ------------------------ | ------------------------------------------------- |
| æ±‚å¹‚èµ‹å€¼                     | let x = 5; x \*\*= 2; // ç»“æœæ˜¯ 25                   |
| Array.prototype.includes | -                                                 |
| è£…é¥°å™¨                      | [åŠ¨æ€](https://github.com/tc39/proposal-decorators) |

*   **ES2016 æµè§ˆå™¨æ”¯æŒ**

æ‰€æœ‰ç°ä»£æµè§ˆå™¨éƒ½æ”¯æŒ Array.prototype.includesï¼š

| Chrome 47                                                                                                                                                                               | Edge 14                                                                                                                                                                             | Firefox 43                                                                                                                                                                               | Safari 9                                                                                                                                                                                | Opera 34                                                                                                                                                                               |
| --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| ![compatible\_chrome.png](/img/posts/2022-6-15/chrome.png) | ![compatible\_ie.png](/img/posts/2022-6-15/ie.png) | ![compatible\_firefox.png](/img/posts/2022-6-15/firefox.png) | ![compatible\_safari.png](/img/posts/2022-6-15/safari.png) | ![compatible\_opera.png](/img/posts/2022-6-15/opera.png) |
| 2015 å¹´ 12 æœˆ                                                                                                                                                                             | 2016 å¹´ 8 æœˆ                                                                                                                                                                          | 2015 å¹´ 12 æœˆ                                                                                                                                                                              | 2015 å¹´ 10 æœˆ                                                                                                                                                                             | 2015 å¹´ 12 æœˆ                                                                                                                                                                            |

<hr />

æœ€è¿‘çš„ç‰ˆæœ¬å¿«é€Ÿæµè§ˆï¼š

## 13. ECMAScript 2017

2017å¹´å‘å¸ƒã€‚

| æ–°ç‰¹æ€§     | æè¿°                                                              |
| ------- | --------------------------------------------------------------- |
| å¼‚æ­¥å£°æ˜    | async/await                                                     |
| å¯¹è±¡æ”¯æŒå°¾é€—å· | `{ a: 1, b: 2, } `                                                |
| å­—ç¬¦ä¸²æ‰©å±•   | String.padStart å’Œ String.padEndï¼Œå¢åŠ å­—ç¬¦ä¸²å‰åç¼©è¿›                       |
| å¯¹è±¡æ‰©å±•    | Object.valuesã€Object.entriesã€Object.getOwnPropertyDescriptors() |

## 14. ECMAScript 2018

2018å¹´å‘å¸ƒã€‚

| æ–°ç‰¹æ€§                   | æè¿°                                                      |
| --------------------- | ------------------------------------------------------- |
| å¼‚æ­¥è¿­ä»£                  | ES2018å¼•â¼Šå¼‚æ­¥è¿­ä»£å™¨ï¼Œå…è®¸ for...of å¾ªç¯å¯ä»¥å’Œ await â¼€èµ·ä½¿â½¤ï¼Œä»¥ä¸²â¾çš„â½…å¼è¿â¾å¼‚æ­¥æ“ä½œ |
| Promiseæ‰©å±•             | Promise.finally()                                       |
| Restå‚æ•°çš„Spreadå±æ€§       | å±•å¼€è¿ç®—ç¬¦ï¼šMath.max(...values) // values = \[1,2,3,4]        |
| æ­£åˆ™è¡¨è¾¾å¼å‘½åæ•è·ç»„            | ES2018å…è®¸å‘½åæ•è·ç»„ä½¿â½¤ç¬¦å·`?<name>`ï¼Œåœ¨æ‰“å¼€æ•è·æ‹¬å·(åâ½´å³å‘½å                |
| æ­£åˆ™è¡¨è¾¾å¼åå‘æ–­è¨€             | `?<= ã€?\<!  `                                             |
| æ­£åˆ™è¡¨è¾¾å¼ s ä¿®é¥°ç¬¦ï¼šdotAll æ¨¡å¼ | [æ­£åˆ™æ‰©å±•](http://caibaojian.com/es6/regex.html)            |
| æ­£åˆ™è¡¨è¾¾å¼Unicodeè½¬ä¹‰        | [æ­£åˆ™æ‰©å±•](http://caibaojian.com/es6/regex.html)            |

*   å¼‚æ­¥è¿­ä»£ç¤ºä¾‹ï¼š

```js
// ä¸èµ·ä½œç”¨
async function process(array) {
  for (let i of array) {
    await doSomething(i);
  }
}

// èµ·ä½œç”¨äº†
async function process(array) {
  for await (let i of array) {
    doSomething(i);
  }
}
```

## 15. ECMAScript 2019

2019å¹´å‘å¸ƒã€‚

| æ–°ç‰¹æ€§                             | æè¿°                                                                                   |
| ------------------------------- | ------------------------------------------------------------------------------------ |
| å­—ç¬¦ä¸²æ‰©å±•                           | `String.prototype.trimStart() , String.prototype.trimEnd()`ï¼ŒåŸæ¥çš„trimLeftå’ŒtrimRightè¢«åºŸå¼ƒ |
| Object.fromEntries()            | Object.entriesçš„é€†è¿ç®—                                                                   |
| æ•°ç»„æ‹å¹³                            | `Array.prototype.flat() ï¼Œ Array.prototype.flatMap()`                                 |
| catch çš„å‚æ•°æ”¹ä¸ºå¯é€‰                   | å¯ä»¥çœç•¥catchç»‘å®šçš„å‚æ•°å’Œæ‹¬å·                                                                    |
| Symbol.description              | -                                                                                    |
| JSON Superset è¶…é›†                | å³jså…¼å®¹æ‰€æœ‰JSONæ”¯æŒçš„æ–‡æœ¬ã€‚åŸå§‹çš„JSON å†…å®¹å¯ä»¥æ­£å¸¸åŒ…å« U+2028è¡Œåˆ†éš”ç¬¦ ä¸ U+2029æ®µåˆ†éš”ç¬¦ï¼Œè€Œä¹‹å‰ç‰ˆæœ¬çš„ECMAScript å´ä¸è¡Œ       |
| JSON.stringify() è½¬åŒ–ç‰¹æ®Šå­—ç¬¦         | ä¿®å¤äº†å¯¹äºä¸€äº›è¶…å‡ºèŒƒå›´çš„Â `Unicode`å±•ç¤ºé”™è¯¯çš„é—®é¢˜                                                        |
| Array.sort                      | å˜ä¸ºç¨³å®šç®—æ³•                                                                               |
| Function.prototype.toString()å¢å¼º | å¯ä»¥è¿”å›æ³¨é‡Šå’Œç©ºæ ¼                                                                            |
| String.prototype.matchAll       | è¿”å›ä¸€ä¸ªåŒ…å«æ‰€æœ‰åŒ¹é…æ­£åˆ™è¡¨è¾¾å¼åŠåˆ†ç»„æ•è·ç»“æœçš„è¿­ä»£å™¨                                                           |

## 16. ECMAScript 2020

2020å¹´å‘å¸ƒã€‚

| æ–°ç‰¹æ€§                | æè¿°                                                                                                                           |
| ------------------ | ---------------------------------------------------------------------------------------------------------------------------- |
| Promise.allSettled | å½“æ‰€æœ‰promiseéƒ½resolveæˆ–rejectåï¼Œè¿”å›resolveæˆ–rejectçš„ç»“æœé›†åˆæ•°ç»„                                                                           |
| é“¾åˆ¤æ–­è¿ç®—ç¬¦             | `const firstName = message?.body?.user?.firstName \|\| 'default';`                                                           |
| ç©ºå€¼åˆå¹¶è¿ç®—ç¬¦            | `var level = user.level ?? 'æš‚â½†ç­‰çº§';`                                                                                          |
| åŠ¨æ€å¼•å…¥               | import(`/test.js`).then((module) =\> {}                                                                                      |
| globalThiså¯¹è±¡       | `globalThis`Â æä¾›äº†ä¸€ä¸ªæ ‡å‡†çš„æ–¹å¼æ¥è·å–ä¸åŒç¯å¢ƒä¸‹çš„å…¨å±€Â `this`Â å¯¹è±¡ï¼ˆä¹Ÿå°±æ˜¯å…¨å±€å¯¹è±¡è‡ªèº«ï¼‰ã€‚ä¸åƒÂ `window`Â æˆ–è€…Â `self`Â è¿™äº›å±æ€§ï¼Œ`globalThis` ç¡®ä¿å¯ä»¥åœ¨æœ‰ã€æ— çª—å£çš„å„ç§ç¯å¢ƒä¸‹æ­£å¸¸å·¥ä½œ         |
| å¼•å…¥bigint           | Numberæœ‰å–å€¼èŒƒå›´ \[Number.MIN\_SAFE\_INTEGER, Number.MAX\_SAFE\_INTEGER], è¶…è¿‡è¿™ä¸ªèŒƒå›´ä¼šç²¾åº¦ä¸¢å¤±ï¼Œè¿™å°±éœ€è¦å¤§æ•°ç±»å‹ï¼švar bigIntNum = 9007199254740993n; |

## 17. ECMAScript 2021

2021å¹´å‘å¸ƒã€‚

| æ–°ç‰¹æ€§         | æè¿°                                                                                                                                 |
| ----------- | ---------------------------------------------------------------------------------------------------------------------------------- |
| Promise.any | æ¥æ”¶ä¸€ä¸ªPromiseæ•°ç»„ï¼Œåªè¦å…¶ä¸­ä»»æ„ä¸€ä¸ªresolveï¼Œä¾¿é€šè¿‡ï¼Œå¦åˆ™æ‹’ç»                                                                                             |
| replaceAll  | è¿”å›â¼€ä¸ªå…¨æ–°çš„å­—ç¬¦ä¸²ï¼Œæ‰€æœ‰ç¬¦åˆåŒ¹é…è§„åˆ™çš„å­—ç¬¦éƒ½å°†è¢«æ›¿æ¢æ‰                                                                                                       |
| WeakRefs    | åœ¨ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œå¯¹è±¡çš„å¼•ç”¨æ˜¯å¼ºå¼•ç”¨çš„ï¼Œè¿™æ„å‘³ç€åªè¦æŒæœ‰å¯¹è±¡çš„å¼•ç”¨ï¼Œå®ƒå°±ä¸ä¼šè¢«åƒåœ¾å›æ”¶ã€‚åªæœ‰å½“è¯¥å¯¹è±¡æ²¡æœ‰ä»»ä½•çš„å¼ºå¼•ç”¨æ—¶ï¼Œåƒåœ¾å›æ”¶æœºåˆ¶æ‰ä¼šé”€æ¯è¯¥å¯¹è±¡å¹¶ä¸”å›æ”¶è¯¥å¯¹è±¡æ‰€å çš„å†…å­˜ç©ºé—´ã€‚è€Œ `WeakRef` å…è®¸ä¿ç•™å¯¹ä¸€ä¸ªå¯¹è±¡çš„å¼±å¼•ç”¨ï¼Œè€Œä¸ä¼šé˜»æ­¢è¢«å¼±å¼•ç”¨çš„å¯¹è±¡è¢«åƒåœ¾å›æ”¶ã€‚ |
| æ•°å­—å£°æ˜æ—¶å¯å¢åŠ åˆ†éš”ç¬¦ | `const num = 1_000_000_000  //1000000000`                                                                                          |
| æ–°çš„é€»è¾‘è¿ç®—ç¬¦å’Œè¡¨è¾¾å¼ | è§ä¸‹é¢ä»£ç                                                                                                                               |

```js
a ||= b
//ç­‰ä»·äº
a = a || (a = b)
a &&= b
//ç­‰ä»·äº
a = a && (a = b)
a ??= b
//ç­‰ä»·äº
a = a ?? (a = b)
```

## 18. ECMAScript 2022

2022å¹´å‘å¸ƒã€‚

| æ–°ç‰¹æ€§                         | æè¿°                                                                                       |
| --------------------------- | ---------------------------------------------------------------------------------------- |
| classæ–°ç‰¹æ€§                    | 1ã€å¢åŠ privateå±æ€§ï¼Œ `class A { #a = 1 }`; 2ã€å¢åŠ classçš„staticæˆå‘˜æ–¹æ³•                                  |
| top-level await             | å¯ä»¥ä½¿ç”¨type='module'çš„scriptæ ‡ç­¾å¼•å…¥ä¸€ä¸ªjsæ–‡ä»¶ï¼Œjsé‡Œä½¿ç”¨awaitè·å–å¼‚æ­¥æ•°æ®                                      |
| æ•°ç»„å®ä¾‹æ–¹æ³•at(index)             | `a = [1,2,3]; const value = a.at(1)`                                                     |
| errorå¤„ç†æ–°æ–¹å¼                  | `throw new Error('fail', { cause: 123 });` åœ¨catché‡Œè·å–ï¼š`catch(e) { console.log(e.cause) }` |
| Object.hasOwn(obj, propKey) | åŒhasOwnPropertyï¼Œä½†æ”¯æŒæ‰€æœ‰å¯¹è±¡ç±»å‹çš„åˆ¤æ–­                                                             |

## 19. ECMAScript 2023

*   ä»å¤´åˆ°å°¾æœç´¢æ•°ç»„ï¼š`findLast()`Â ã€`findLastIndex()`
*   Hashbang è¯­æ³•
*   é€šè¿‡å‰¯æœ¬æ›´æ”¹æ•°ç»„ï¼š`toReversed()`ã€`toSorted()`ã€`toSpliced()`ã€`with()`
*   Symbol ä½œä¸º WeakMap çš„é”®

## 20. åè®°

éšç€ECMAScriptç‰ˆæœ¬çš„æ›´æ–°ï¼Œæ–‡ç« ä¼šæŒç»­ä¿æŒæ›´æ–°\~\~

<hr />

å‚è€ƒèµ„æ–™

*   [ECMA-international å®˜ç½‘](https://www.ecma-international.org/)
*   [Baiduç™¾ç§‘ - JavaScript](https://baike.baidu.com/item/JavaScript/321142?fr=aladdin)
*   [Javascript.com](https://www.javascript.com/)
*   [W3Cå­¦é™¢](https://www.w3school.com.cn/js/js_versions.asp)79:T2710,> ä¸“æ è¯´æ˜ï¼šå¯¹äºreact-router v6ç‰ˆæœ¬ï¼Œæœ‰åŒäº‹ååº”ç¼ºå°‘ç›¸å¯¹å®Œæ•´çš„ä¸­æ–‡æ–‡æ¡£ï¼ŒæŸ¥çœ‹ä¸æ–¹ä¾¿ã€‚ä¸ºäº†ä¾¿äºä½¿ç”¨ï¼Œä½œè€…å¯¹[å®˜ç½‘æ–‡æ¡£](https://reactrouter.com/docs/en/v6)è¿›è¡Œé’ˆå¯¹æ€§ç¿»è¯‘ï¼Œä¾¿äºv6ç‰ˆæœ¬æ›´å¹¿æ³›çš„è¢«ä½¿ç”¨ã€‚

## 1. \<Link>

ç±»å‹å®šä¹‰ï¼š

```ts
declare function Link(props: LinkProps): React.ReactElement;

interface LinkProps
  extends Omit<
    React.AnchorHTMLAttributes<HTMLAnchorElement>,
    "href"
  > {
  replace?: boolean;
  state?: any;
  to: To;
  reloadDocument?: boolean;
}

type To = Partial<Location> | string;
```
å†…ç½®å…ƒç´ Â `<Link>`Â æ˜¯ç”¨äºé€šè¿‡ç‚¹å‡»è·³è½¬é¡µé¢çš„ã€‚ åœ¨Â `react-router-dom`ä¸­ï¼Œ`<Link>`Â ä¼šæ¸²æŸ“ä¸€ä¸ª`<a>`Â æ ‡ç­¾ï¼Œ æ ‡ç­¾çš„ `href`Â ä¸ºLinkçš„ `to` å±æ€§. ä¹Ÿå°±æ˜¯è¯´ï¼Œå³é”®ç‚¹å‡»ä¸€ä¸ª `<Link>`ä¹Ÿæ˜¯èµ·ä½œç”¨çš„. ä½ ä¹Ÿå¯ä»¥è¿™ä¹ˆå†™ï¼š`<Link reloadDocument>`Â ï¼Œ ä»¥æ­¤æ¥é˜»æ­¢æµè§ˆå™¨é»˜è®¤äº‹ä»¶ã€‚

ä½¿ç”¨æ¡ˆä¾‹ï¼š

```ts
import * as React from "react";
import { Link } from "react-router-dom";

function UsersIndexPage({ users }) {
  return (
    <div>
      <h1>Users</h1>
      <ul>
        {users.map((user) => (
          <li key={user.id}>
            <Link to={user.id}>{user.name}</Link>
          </li>
        ))}
      </ul>
    </div>
  );
}
```

`<Link to>`Â çš„ `to` å‚æ•°ï¼Œå¦‚æœä¸æ˜¯ä»¥ `/` å¼€å¤´çš„è¯ï¼Œè¡¨ç¤ºæ˜¯ä¸€ä¸ªç›¸å¯¹è·¯ç”±ã€‚è·¯å¾„ä¸­å¯èƒ½ä¼šåŒ…å« `..`æ¥æ£€ç´¢ä¸Šä¸€çº§ï¼Œç±»ä¼¼ç›®å½•æŒ‡ä»¤çš„ `cd`ã€‚


åœ¨ React Native ä¸­ä½¿ç”¨ï¼š

ç±»å‹å®šä¹‰ï¼š
```ts
declare function Link(props: LinkProps): React.ReactElement;

interface LinkProps extends TouchableHighlightProps {
  children?: React.ReactNode;
  onPress?(event: GestureResponderEvent): void;
  replace?: boolean;
  state?: any;
  to: To;
}
```

`<Link>` ç”¨äºå“åº”ç”¨æˆ·ç‚¹å‡»åè·³è½¬å…¶ä»–çš„ `View`, æ¸²æŸ“ä¸ºä¸€ä¸ªÂ `<a>`Â æ ‡ç­¾ã€‚ åœ¨Â `react-router-native`, ä¸­ï¼ŒÂ `<Link>`Â æ¸²æŸ“ä¸€ä¸ªÂ `TouchableHighlight`ã€‚å¯ä»¥ä½¿ç”¨[`TouchableHighlight`é…ç½®é¡¹](https://reactnative.dev/docs/touchablehighlight#props)æ¥è‡ªå®šä¹‰æ ·å¼å’Œè¡Œä¸ºã€‚

```ts
import * as React from "react";
import { View, Text } from "react-native";
import { Link } from "react-router-native";

function Home() {
  return (
    <View>
      <Text>Welcome!</Text>
      <Link to="/profile">Visit your profile</Link>
    </View>
  );
}
```

## 2. \<NavLink>

ç±»å‹å®šä¹‰ï¼š
```ts
declare function NavLink(
  props: NavLinkProps
): React.ReactElement;

interface NavLinkProps
  extends Omit<
    LinkProps,
    "className" | "style" | "children"
  > {
  caseSensitive?: boolean;
  children?:
    | React.ReactNode
    | ((props: { isActive: boolean }) => React.ReactNode);
  className?:
    | string
    | ((props: {
        isActive: boolean;
      }) => string | undefined);
  end?: boolean;
  style?:
    | React.CSSProperties
    | ((props: {
        isActive: boolean;
      }) => React.CSSProperties);
}
```

`<NavLink>`Â æ˜¯ç‰¹æ®Šç±»å‹çš„[`<Link>`](https://reactrouter.com/docs/en/v6/components/link)ï¼ŒÂ å¯ä»¥è®°å½• "active" çŠ¶æ€ã€‚ å¯ç”¨äºé¢åŒ…å±‘æˆ–è€…èœå•çš„é€‰ä¸­ç‚¹äº®ã€‚å¯¹äºç”¨æˆ·å’Œè¯»è€…æ¥è¯´ä¹Ÿæä¾›äº†ä¸Šä¸‹æ–‡çš„å¯¼èˆªè¯´æ˜ã€‚

é»˜è®¤çš„, `<NavLink>`æ¿€æ´»æ—¶ï¼Œä¼šåŠ ä¸Šç±»å`active`ï¼Œv5ä¸­ä¹Ÿæ˜¯è¿™ä¹ˆåšçš„. ä¸åŒçš„æ˜¯ï¼Œæ–°ç‰ˆæœ¬`v6.0.0-beta.3`Â ä¸­å±æ€§ç§»é™¤äº† `activeClassName`Â å’ŒÂ `activeStyle`ï¼Œå–è€Œä»£ä¹‹çš„æ˜¯Â `style`Â æˆ–è€…Â `className`Â å±æ€§ï¼Œç”¨äºè‡ªå®šä¹‰è¡Œå†…æ ·å¼æˆ–è€…è‡ªå®šä¹‰ç±»åï¼Œå½“ç„¶ä¹Ÿå¯ä»¥ç©¿ä¸€ä¸ªå‡½æ•°ä½œä¸ºå±æ€§ç»™Â `<NavLink>`Â ç»„ä»¶æ¥è‡ªå®šä¹‰è¡Œä¸ºã€‚

ä¾‹å­ï¼š

```ts
import * as React from "react";
import { NavLink } from "react-router-dom";

function NavList() {
  // This styling will be applied to a <NavLink> when the
  // route that it links to is currently selected.
  let activeStyle = {
    textDecoration: "underline",
  };

  let activeClassName = "underline";

  return (
    <nav>
      <ul>
        <li>
          <NavLink
            to="messages"
            style={({ isActive }) =>
              isActive ? activeStyle : undefined
            }
          >
            Messages
          </NavLink>
        </li>
        <li>
          <NavLink
            to="tasks"
            className={({ isActive }) =>
              isActive ? activeClassName : undefined
            }
          >
            Tasks
          </NavLink>
        </li>
        <li>
          <NavLink to="tasks">
            {({ isActive }) => (
              <span
                className={
                  isActive ? activeClassName : undefined
                }
              >
                Tasks
              </span>
            )}
          </NavLink>
        </li>
      </ul>
    </nav>
  );
}
```

å¦‚æœä½ å¾ˆç†Ÿæ‚‰ v5 çš„ APIï¼Œå¯ä»¥äºŒæ¬¡å°è£…ä¸€ä¸‹ä½¿ç”¨ï¼š
```ts
import * as React from "react";
import { NavLink as BaseNavLink } from "react-router-dom";

const NavLink = React.forwardRef(
  ({ activeClassName, activeStyle, ...props }, ref) => {
    return (
      <BaseNavLink
        ref={ref}
        {...props}
        className={({ isActive }) =>
          [
            props.className,
            isActive ? activeClassName : null,
          ]
            .filter(Boolean)
            .join(" ")
        }
        style={({ isActive }) => ({
          ...props.style,
          ...(isActive ? activeStyle : null),
        })}
      />
    );
  }
);
```

`end` å±æ€§ç”¨äºæ§åˆ¶ä¸ä¼šçº§è”ç‚¹äº®ã€‚å¦‚æœæƒ³è¦åªåœ¨å®Œå…¨åŒ¹é…è·¯ç”±æ˜¯activeï¼Œè€Œä¸æ˜¯åœ¨è¯¥è·¯ç”±ä¸Šå‡ çº§è·¯å¾„éƒ½è¢«activeï¼Œå¯ä»¥ä½¿ç”¨è¿™ä¸ªå±æ€§ã€‚ä¸‹é¢çš„ä¾‹å­ï¼Œåªä¼šåœ¨è·¯å¾„ä¸º `/` æ—¶åŒ¹é… activeï¼Œå…¶ä»–ä»»ä½•è·¯å¾„éƒ½ä¸ä¼šç‚¹äº®ï¼š

```jsx
<NavLink to="/" end>
  Home
</NavLink>
```

## 3. \<Navigate>

ç±»å‹å®šä¹‰ï¼š

```ts
declare function Navigate(props: NavigateProps): null;

interface NavigateProps {
  to: To;
  replace?: boolean;
  state?: any;
}
```

`<Navigate>`Â è¢«æ¸²æŸ“æ—¶ï¼Œä¼šç«‹å³æ”¹å˜å½“å‰çš„location. å’Œhooks [`useNavigate`](https://reactrouter.com/docs/en/v6/hooks/use-navigate) å¯ä»¥è¾¾åˆ°ä¸€æ ·çš„æ•ˆæœï¼Œä¼ é€’çš„å‚æ•°ä¹Ÿä¸€æ ·ã€‚
> **æç¤º:**
>
> `<Navigate>`å¯ä»¥åœ¨ä¸èƒ½ä½¿ç”¨è·¯ç”± hooks çš„åœ°æ–¹ä»£æ›¿ useNavigate

ä¸‹é¢çš„ä¾‹å­ä¸­ï¼Œä¼šå…ˆæ‹¿åˆ°ç™»å½•çŠ¶æ€çš„userï¼Œè‹¥æ²¡æœ‰userï¼Œæ¸²æŸ“ç™»å½•è¡¨å•ï¼›å¦‚æœæ‹¿åˆ°äº†ç™»å½•ä¿¡æ¯ï¼Œåˆ™é€šè¿‡`<Navigate>`ç›´æ¥è·³è½¬åˆ° dashboard é¡µé¢ï¼š

```jsx
import * as React from "react";
import { Navigate } from "react-router-dom";

class LoginForm extends React.Component {
  state = { user: null, error: null };

  async handleSubmit(event) {
    event.preventDefault();
    try {
      let user = await login(event.target);
      this.setState({ user });
    } catch (error) {
      this.setState({ error });
    }
  }

  render() {
    let { user, error } = this.state;
    return (
      <div>
        {error && <p>{error.message}</p>}
        {user && (
          <Navigate to="/dashboard" replace={true} />
        )}
        <form
          onSubmit={(event) => this.handleSubmit(event)}
        >
          <input type="text" name="username" />
          <input type="password" name="password" />
        </form>
      </div>
    );
  }
}
```


## 4. \<Outlet>

ç±»å‹å®šä¹‰ï¼š

```ts
interface OutletProps {
  context?: unknown;
}
declare function Outlet(
  props: OutletProps
): React.ReactElement | null;
```

`<Outlet>`Â å¯ç”¨äºçˆ¶è·¯ç”±ä¸­ï¼Œç”¨æ¥æ¸²æŸ“å­è·¯ç”±ç»„ä»¶. è¿™éœ€è¦å¼€å‘è€…åˆç†å®‰æ’åµŒå¥— UI çš„å¸ƒå±€. å½“ç›´æ¥è®¿é—®çˆ¶è·¯ç”±æ—¶ï¼Œä¼šè‡ªåŠ¨æ¸²æŸ“çˆ¶è·¯ç”±ä¸­é…ç½®äº† index å±æ€§çš„å­è·¯ç”±æ¥æ›¿ä»£ `Outlet`, å¦‚æœæ²¡æœ‰ index è·¯ç”±ï¼Œè¯¥ä½ç½®ä¸æ¸²æŸ“ã€‚

ä¸‹é¢çš„ä¾‹å­ä¸­ï¼Œè®¿é—® `/` ä¼šæ¸²æŸ“ Dashboard ç»„ä»¶ï¼Œ Outletç•™ç™½ï¼› è®¿é—® `/tasks` åˆ™ä¼šæ¸²æŸ“ Dashboardï¼ŒOutletä½ç½®ä¼šæ¸²æŸ“ DashboardTasksï¼š

```jsx
function Dashboard() {
  return (
    <div>
      <h1>Dashboard</h1>

      <Outlet />
    </div>
  );
}

function App() {
  return (
    <Routes>
      <Route path="/" element={<Dashboard />}>
        <Route
          path="messages"
          element={<DashboardMessages />}
        />
        <Route path="tasks" element={<DashboardTasks />} />
      </Route>
    </Routes>
  );
}
```

å½“ç„¶äº†ï¼Œçˆ¶å­ç»„ä»¶ä»ç„¶å¯ä»¥ä¼ å‚ï¼Œä½¿ç”¨ context å’Œ useOutletContext ç»„åˆæ‹³å³å¯ï¼Œè¯¦æƒ…å¯å‚è€ƒæœ¬ä¸“æ çš„ hook ä¸“é¢˜ã€‚

## 5. \<Routes> ä¸ \<Route>

ç±»å‹å£°æ˜ï¼š

```ts
declare function Routes(
  props: RoutesProps
): React.ReactElement | null;

interface RoutesProps {
  children?: React.ReactNode;
  location?: Partial<Location> | string;
}

declare function Route(
  props: RouteProps
): React.ReactElement | null;

interface RouteProps {
  caseSensitive?: boolean;
  children?: React.ReactNode;
  element?: React.ReactNode | null;
  index?: boolean;
  path?: string;
}
```

`<Routes>`Â å’ŒÂ `<Route>`Â æ˜¯ React Router ä¸­ä¸»è¦çš„é…ç½®ç±»å‹ã€‚å¯ä»¥æŠŠÂ `<Route>`çœ‹åšæ˜¯ä¸€ä¸ª `if`Â åˆ¤æ–­ï¼šå¦‚æœÂ `path`Â åŒ¹é…äº†å½“å‰ URL, åˆ™ä¼šæ¸²æŸ“ä»–çš„Â `element`ï¼ä½¿ç”¨Â `<Route caseSensitive>`å¯ä»¥å¯ç”¨è·¯ç”±å¤§å°å†™åŒ¹é…ã€‚

å½“ location å˜åŒ–æ—¶,Â `<Routes>`Â ä¼šéå†ä¸‹å±Â `children`Â çš„æ‰€æœ‰ `<Route>`Â ä»¥è¯•å›¾å¯»æ‰¾æœ€ä½³åŒ¹é…çš„è·¯ç”±.Â `<Route>`Â æ‰€åœ¨è·¯å¾„è·ŸåµŒå¥— UI çš„è·¯å¾„ä½ç½®æ˜¯ä¸€è‡´çš„ï¼Œæ‰€è§å³æ‰€å¾—çš„æ¸²æŸ“æ–¹å¼ã€‚

ä¾‹å­ï¼š

```jsx
<Routes>
  <Route path="/" element={<Dashboard />}>
    <Route
      path="messages"
      element={<DashboardMessages />}
    />
    <Route path="tasks" element={<DashboardTasks />} />
  </Route>
  <Route path="about" element={<AboutPage />} />
</Routes>
```

> **Note:**
>
> Routes çš„ Javascriptæ›¿ä»£å“è§ [Â `useRoutes`Â ](https://reactrouter.com/docs/en/v6/hooks/use-routes).

`<Route element>`Â ä¼šé»˜è®¤å¾€ä¸‹æ¸²æŸ“ï¼Œå¹¶ä¸”æ‹¼æ¥è·¯å¾„ï¼Œæ‰€ä»¥ä¸æ˜¯æ¯ä¸€ä¸ª Route éƒ½éœ€è¦é…ç½®ä¸€ä¸ª element å±æ€§ã€‚

æ¯”å¦‚è¯´ä¸‹é¢çš„ä¾‹å­ï¼Œ è·¯å¾„ `/users/:id`ä¾ç„¶å¯ä»¥åŒ¹é…åˆ° UserProfile å…ƒç´ ï¼Œè€Œä¸ç”¨æ‹…å¿ƒè·¯å¾„è¢«æˆªæ–­ï¼š

```jsx
<Route path="users">
  <Route path=":id" element={<UserProfile />} />
</Route>
```

<hr />

ã€å®Œã€7a:T1d12,> åŸæ–‡è·¯å¾„ï¼šhttps://reactrouter.com/docs/en/v6/routers/browser-router

### BrowserRouter

ç±»å‹å£°æ˜ï¼š
```ts
declare function BrowserRouter(
  props: BrowserRouterProps
): React.ReactElement;

interface BrowserRouterProps {
  basename?: string;
  children?: React.ReactNode;
  window?: Window;
}
```

BrowserRouteræ˜¯React Routeræ¨èä½¿ç”¨çš„æ¥å£ã€‚BrowserRouteråŸºäºæµè§ˆå™¨å†…ç½®ï¼ˆH5 APIï¼‰çš„history stackæ¥å­˜å‚¨å½“å‰æµè§ˆå™¨åœ°å€æ çš„locationä¿¡æ¯ã€‚

`<BrowserRouter window>`é»˜è®¤ä¼šä½¿ç”¨å½“å‰[documentçš„`defaultView`](https://developer.mozilla.org/en-US/docs/Web/API/Document/defaultView)ï¼Œä»–åœ¨ä¸šåŠ¡ä½¿ç”¨ä¸­è¿˜ä¹Ÿå¯ç”¨æ¥åœ¨å¦å¤–ä¸€ä¸ªæµè§ˆå™¨windowç¯å¢ƒä¸‹ï¼ˆæ¯”å¦‚iframeä¸­ï¼‰è¿½æº¯URLçš„å˜åŒ–ã€‚


ä½¿ç”¨èŒƒä¾‹ï¼š
```jsx
import * as React from "react";
import * as ReactDOM from "react-dom";
import { BrowserRouter } from "react-router-dom";

ReactDOM.render(
  <BrowserRouter>
    {/* The rest of your app goes here */}
  </BrowserRouter>,
  root
);
```

### HashRouter

ç±»å‹å£°æ˜ï¼š
```ts
declare function HashRouter(
  props: HashRouterProps
): React.ReactElement;

interface HashRouterProps {
  basename?: string;
  children?: React.ReactNode;
  window?: Window;
}
```

HashRouterç”¨åœ¨åŸºäºæµè§ˆå™¨çš„webé¡¹ç›®ä¸­ï¼Œè€Œä¸”ä¸éœ€è¦é€šè¿‡åç«¯æœåŠ¡æ¥æ§åˆ¶è·¯ç”±è·³è½¬ã€‚ä»–çš„åŸç†æ˜¯åŸºäºæµè§ˆå™¨çš„é”šç‚¹ï¼Œé€šè¿‡è®¾ç½®ä¸åŒçš„é”šç‚¹æ¥è¾¾åˆ°è·³è½¬é¡µé¢çš„æ•ˆæœã€‚


ä¹Ÿå¯ä»¥æœ‰`<HashRouter window>`çš„å†™æ³•ï¼Œä½œç”¨åŒ`<BrowserRouter window>`ã€‚

ä½¿ç”¨èŒƒä¾‹ï¼š
```jsx
import * as React from "react";
import * as ReactDOM from "react-dom";
import { HashRouter } from "react-router-dom";

ReactDOM.render(
  <HashRouter>
    {/* The rest of your app goes here */}
  </HashRouter>,
  root
);
```

> å®˜æ–¹ä¼˜å…ˆæ¨èä½¿ç”¨BrowserRouterï¼Œä»–æ˜¯åŸºäºH5æ ‡å‡†åˆ¶å®šçš„ï¼Œæ›´åŠ è§„èŒƒï¼Œæœ‰åŸç”Ÿçš„APIå¯ä»¥ä½¿ç”¨ï¼›åŒæ—¶ï¼ŒBrowserRouterè¿˜å¯ä»¥å°†å½“å‰è·¯ç”±ä¿¡æ¯å‘é€ç»™serverï¼Œä¾¿äºæ•°æ®åŒæ­¥ï¼›æ­¤å¤–åœ¨ä¸€äº›ç‰¹æ®Šåœºæ™¯ä¸‹ï¼Œä¼šä¸¢å¤±hashä¿¡æ¯ï¼Œä»¥è‡³äºHashRouterä¸èƒ½ä½¿ç”¨ï¼Œæ¯”å¦‚å°†URLä½¿ç”¨å¾®ä¿¡åˆ†äº«ã€‚

### HistoryRouter

ç±»å‹å£°æ˜ï¼š
```jsx
declare function HistoryRouter(
  props: HistoryRouterProps
): React.ReactElement;

interface HistoryRouterProps {
  basename?: string;
  children?: React.ReactNode;
  history: History;
}
```

`<unstable_HistoryRouter>`æä¾›ä¸€ä¸ªå°†historyä½œä¸ºpropçš„å®ä¾‹å¯¹è±¡ã€‚å¯ä»¥ä½¿ç”¨å®ƒåœ¨éReactçš„ä¸Šä¸‹æ–‡ç¯å¢ƒæˆ–å…¨å±€å˜é‡ä¸­ä½¿ç”¨Routerã€‚

èŒƒä¾‹ï¼š

```jsx
import * as React from "react";
import * as ReactDOM from "react-dom";
import { unstable_HistoryRouter as HistoryRouter } from "react-router-dom";
import { createBrowserHistory } from "history";

const history = createBrowserHistory({ window });

ReactDOM.render(
  <HistoryRouter history={history}>
    {/* The rest of your app goes here */}
  </HistoryRouter>,
  root
);
```

> æ­¤APIçš„å‰ç¼€ä¸ºâ€œunstable_â€ï¼Œå› ä¸ºæ‚¨å¯èƒ½ä¼šæ— æ„ä¸­å°†å†å²åº“çš„ä¸¤ä¸ªç‰ˆæœ¬éƒ½æ·»åŠ åˆ°åº”ç”¨ç¨‹åºä¸­ã€‚å¦‚æœæ‚¨ä½¿ç”¨çš„å¼€å‘å·¥å…·å…è®¸ï¼Œå»ºè®®ä¸è¦å°†historyæ·»åŠ ä¸ºç›´æ¥ä¾èµ–é¡¹ï¼Œè€Œæ˜¯ä¾èµ–react-routeråŒ…ä¸­çš„åµŒå¥—ä¾èµ–é¡¹ã€‚ä¸€æ—¦æˆ‘ä»¬æœ‰äº†æ£€æµ‹ä¸åŒ¹é…ç‰ˆæœ¬çš„æœºåˆ¶ï¼Œè¿™ä¸ªAPIå°†åˆ é™¤å…¶â€œunstable_â€çš„å‰ç¼€ã€‚

### MemoryRouter

ç±»å‹å£°æ˜ï¼š
```jsx
declare function MemoryRouter(
  props: MemoryRouterProps
): React.ReactElement;

interface MemoryRouterProps {
  basename?: string;
  children?: React.ReactNode;
  initialEntries?: InitialEntry[];
  initialIndex?: number;
}
```

`<MemoryRouter>`å°†locationä¿¡æ¯å­˜åœ¨ä¸€ä¸ªæ•°ç»„ä¸­. ä¸åŒäºÂ `<BrowserHistory>`Â å’ŒÂ `<HashHistory>`, ä»–ä¸ä½¿ç”¨é¢å¤–çš„èµ„æºï¼ˆæ¯”å¦‚æµè§ˆå™¨history stackï¼‰ã€‚å®ƒé€‚ç”¨äºä½ æƒ³è¦å®Œå…¨æ§åˆ¶history stackçš„åœºæ™¯ã€‚æ¯”å¦‚å•å…ƒæµ‹è¯•ã€‚

ä»–æœ‰ä¸¤ä¸ªå‚æ•°ï¼š
-   `<MemoryRouter initialEntries>`Â é»˜è®¤ä¸ºÂ `["/"]`Â (å•ä¸€å…¥å£â€™/â€˜) ä»–æ˜¯å†å²å †æ ˆä¸­çš„ä½ç½®æ•°ç»„ã€‚è¿™äº›å¯¹è±¡å¯ä»¥æ˜¯åŒ…å«`{pathname, search, hash, state}`çš„å®Œæ•´ä½ç½®å¯¹è±¡ï¼Œä¹Ÿå¯ä»¥æ˜¯ç®€å•çš„å­—ç¬¦ä¸²url
-   `<MemoryRouter initialIndex>`Â é»˜è®¤ä¸ºÂ `initialEntries` çš„æœ€åä¸€ä¸ªç´¢å¼•ï¼Œå¯ä¼ é€’ä»»æ„çš„ç´¢å¼•ä½ç½®

> **Tip:**
> å¤§å¤šæ•°React Routerçš„æµ‹è¯•éƒ½æ˜¯ç”¨äº†`<MemoryRouter>`ä½œä¸ºè·¯ç”±å…¥å£, è¿™é‡Œæœ‰å¾ˆå¤šæµ‹è¯•èŒƒä¾‹ï¼š[browsing through our tests](https://github.com/remix-run/react-router/tree/main/packages/react-router/__tests__).

ä½¿ç”¨èŒƒä¾‹ï¼š
```jsx
import * as React from "react";
import { create } from "react-test-renderer";
import {
  MemoryRouter,
  Routes,
  Route,
} from "react-router-dom";

describe("My app", () => {
  it("renders correctly", () => {
    let renderer = create(
      <MemoryRouter initialEntries={["/users/mjackson"]}>
        <Routes>
          <Route path="users" element={<Users />}>
            <Route path=":id" element={<UserProfile />} />
          </Route>
        </Routes>
      </MemoryRouter>
    );

    expect(renderer.toJSON()).toMatchSnapshot();
  });
});
```

### NaviteRouter

ç±»å‹å£°æ˜ï¼š
```jsx
declare function NativeRouter(
  props: NativeRouterProps
): React.ReactElement;

interface NativeRouterProps extends MemoryRouterProps {}
```

`<NativeRouter>`Â æ˜¯React Routeræ¨èçš„åœ¨[React Native](https://reactnative.dev/)Â Appä¸­ä½¿ç”¨çš„è·¯ç”±ç±»å‹ã€‚

ä»–æœ‰ä¸¤ä¸ªå¯é€‰å‚æ•°ï¼š
-   `<NativeRouter initialEntries>`Â é»˜è®¤ä¸ºÂ `["/"]`
-   `<NativeRouter initialIndex>`Â Â é»˜è®¤ä¸ºÂ `initialEntries` çš„æœ€åä¸€ä¸ªç´¢å¼•

ä½¿ç”¨èŒƒä¾‹ï¼š
```jsx
import * as React from "react";
import { NativeRouter } from "react-router-native";

function App() {
  return (
    <NativeRouter>
      {/* The rest of your app goes here */}
    </NativeRouter>
  );
}
```

### StaticRouter

ç±»å‹å£°æ˜ï¼š
```jsx
declare function StaticRouter(
  props: StaticRouterProps
): React.ReactElement;

interface StaticRouterProps {
  basename?: string;
  children?: React.ReactNode;
  location?: Path | LocationPieces;
}
```

`<StaticRouter>`ç”¨äºåœ¨Â [node](https://nodejs.org/) ä¸­æ¸²æŸ“React Routerã€‚å…¶é€šè¿‡ `location`Â prop æ¥æä¾›è·¯ç”±ä¿¡æ¯ã€‚

æœ‰ä¸€ä¸ªå¯é€‰å‚æ•°ï¼š
-   `<StaticRouter location>`Â é»˜è®¤æ˜¯Â `"/"`

ä½¿ç”¨èŒƒä¾‹ï¼š
```jsx
import * as React from "react";
import * as ReactDOMServer from "react-dom/server";
import { StaticRouter } from "react-router-dom/server";
import http from "http";

function requestHandler(req, res) {
  let html = ReactDOMServer.renderToString(
    <StaticRouter location={req.url}>
      {/* The rest of your app goes here */}
    </StaticRouter>
  );

  res.write(html);
  res.end();
}

http.createServer(requestHandler).listen(3000);
```

### ~~Router ï¼ˆä¸æ¨èï¼‰~~

ç±»å‹å£°æ˜ï¼š
```jsx
declare function Router(
  props: RouterProps
): React.ReactElement | null;

interface RouterProps {
  basename?: string;
  children?: React.ReactNode;
  location: Partial<Location> | string;
  navigationType?: NavigationType;
  navigator: Navigator;
  static?: boolean;
}
```

`<Router>`æ¥å£æ˜¯ä¸Šè¿°å…¶ä»–ç±»å‹Routeræ‰€å…±äº«çš„æ ¸å¿ƒç»„ä»¶ï¼Œä¸ºå…¶ä»–é«˜çº§Routeræä¾›ç†ç”±ä¿¡æ¯ä¸Šä¸‹æ–‡ï¼ˆ[context provider](https://reactjs.org/docs/context.html#contextprovider)ï¼‰ï¼Œä½¿ç”¨ä¼˜å…ˆçº§æœ€ä½ã€‚

å¼€å‘è€…å‡ ä¹ä¸éœ€è¦ç›´æ¥ä½¿ç”¨è¿™ä¸ªAPIï¼Œæ¨èä½¿ç”¨ä¸Šè¾¹æ›´é«˜é˜¶çš„è·¯ç”±ã€‚

ä»–æœ‰ä¸€ä¸ªå‚æ•°ï¼š
- `<Router basename>` ä½¿ç”¨basenameå…±äº«ä¸€ä¸ªæ ¹è·¯ç”±ã€‚åœ¨å¤§å‹é¡¹ç›®æˆ–è€…å¤šå…¥å£å·¥ç¨‹åŒ–æ–‡ä»¶ä¸­ä½¿ç”¨æœ‰å¥‡æ•ˆã€‚

<hr />


That's All. ä¸‹æœŸè®²å†…ç½®ç»„ä»¶çš„ä½¿ç”¨ã€‚7b:T6f41,## 1. ä¸»è¦æ¦‚å¿µ

> åŸæ–‡è·¯å¾„ï¼šhttps://reactrouter.com/docs/en/v6/getting-started/concepts

ä½ å¯èƒ½ä¼šå¥½å¥‡ï¼ŒReact Routeræ˜¯æ€ä¹ˆè¿è¡Œèµ·æ¥çš„ï¼Œä»–åˆæ˜¯æ€ä¹ˆè¾…åŠ©æ„å»ºAppçš„ï¼Ÿæ¢å¥è¯è¯´ï¼Œè·¯ç”±routeråˆ°åº•æ˜¯ä»€ä¹ˆï¼Ÿ

å¦‚æœä½ æ›¾ç»æƒ³è¿‡ä¸Šè¿°é—®é¢˜ï¼Œæˆ–è€…ä½ æƒ³è¦æ›´æ·±å…¥çš„äº†è§£è·¯ç”±æœºåˆ¶ï¼Œé‚£ä¹ˆæœ¬ç¯‡æ–‡ç« å¯ä»¥å¸®åŠ©åˆ°ä½ ã€‚æœ¬æ–‡åŒ…å«React Routeræ‰€æœ‰æ ¸å¿ƒæ¦‚å¿µçš„è¯¦ç»†è§£é‡Šã€‚

åŒæ—¶ä¹Ÿè¯·ä¸è¦å› ä¸ºè¿™ç¯‡æ–‡ç« è€Œé’»ç‰›è§’å°–ï¼ŒReact Routerçš„åŸºæœ¬ä½¿ç”¨è¿˜æ˜¯å¾ˆç®€å•çš„ï¼Œä¸šåŠ¡ä½¿ç”¨çš„è¯ï¼Œä¹Ÿä¸éœ€è¦æŒ–æ˜è¿™ä¹ˆæ·±å…¥ã€‚

React Routerå¯ä¸ä»…ä»…æ˜¯ä¸€ä¸ªurlçš„æ˜ å°„å‡½æ•°ï¼Œä»–æ˜¯ä¸€å¥—å…³äºæ„å»ºå®Œæ•´çš„ç”¨æˆ·ç•Œé¢çš„URLæ˜ å°„æœºåˆ¶ï¼Œæ‰€ä»¥ä¼šæœ‰æ›´å¤šçš„æ¦‚å¿µå’Œè§„èŒƒã€‚æˆ‘ä»¬å°†ä¼šåœ¨ä»¥ä¸‹ä¸‰ç‚¹æ¥è®¨è®ºï¼š

1. è®¢é˜…å’Œä½¿ç”¨ [history stack](https://reactrouter.com/docs/en/v6/getting-started/concepts#history-stack)

2. åœ¨è·¯ç”±ä¸­æ˜ å°„[URL](https://reactrouter.com/docs/en/v6/getting-started/concepts#url)

3. é€šè¿‡æ˜ å°„æ¥æ¸²æŸ“å±‚çº§åµŒå¥—UI


### å®šä¹‰ 

é¦–å…ˆå…ˆæŠ›å‡ºä¸€äº›å®šä¹‰ã€‚ä¸åŒäºå‰åç«¯æ¡†æ¶çš„è®¾è®¡æ€è·¯ï¼Œæœ‰æ—¶å€™React Routerä¸­çš„ä¸€ä¸ªè¯ï¼Œåœ¨ä¸åŒçš„ä¸Šä¸‹æ–‡è¯­ä¹‰ä¸­ä¼šæœ‰ä¸åŒçš„æ„æ€ã€‚ä¸‹é¢åˆ—ä¸¾ä¸€äº›å¸¸ç”¨çš„è¯æ±‡ï¼Œåœ¨ä¹‹åä¹Ÿä¼šè¯¦ç»†çš„æè¿°ï¼š

- **URL** - å¾ˆå¤šäººè®¤ä¸ºURLå’Œrouteå¯äº’æ¢ï¼Œç„¶è€ŒReact Routerä¸­å´ä¸æ˜¯è¿™æ ·ã€‚
- **Location** - æ˜¯React Routerç‹¬æœ‰çš„ï¼ŒåŸºäºwindow.locationçš„ä¸€ä¸ªå¯¹è±¡ï¼Œè¡¨ç¤ºå½“å‰ç”¨æˆ·æ‰€åœ¨åœ°ã€‚ä»–é€šå¸¸ç”¨æ¥è¡¨ç¤ºURLï¼Œä½†æ˜¯ä¼šé™„å¸¦é¢å¤–çš„è·¯ç”±ä¿¡æ¯ã€‚
- **Location State** - ä¸€ä¸ªæœªè¢«ç¼–ç çš„URLè·¯ç”±ä½ç½®çŠ¶æ€ã€‚ç±»ä¼¼äºè·¯ç”±hashæˆ–è€…è·¯ç”±parmasï¼Œä¸åŒçš„æ˜¯stateæ˜¯å­˜å‚¨åœ¨æµè§ˆå™¨ç¼“å­˜ä¸­ã€‚
- **History Stack** - å½“ç”¨æˆ·ä½¿ç”¨è·¯ç”±è·³è½¬æ—¶ï¼Œæµè§ˆå™¨ç»´æŠ¤ä¸€ä¸ªè·¯ç”±æ ˆï¼Œå¯¹äºæ ˆä¸­çš„æ¯ä¸€ä¸ªè·¯ç”±è¿›è¡Œè¿½æº¯ã€‚å¦‚æœä½ é•¿æŒ‰æµè§ˆå™¨ä¸­çš„å‘åæŒ‰é’®ï¼Œä½ ä¼šçœ‹åˆ°æµè§ˆå™¨çš„è·¯ç”±è·³è½¬å†å²ã€‚
- **Client Side Routing (CSR)** - æ‰å¹³åŒ–HTMLæ–‡æ¡£è·³è½¬æ—¶ï¼Œæµè§ˆå™¨ä¼šè‡ªåŠ¨ç»´æŠ¤ä¸€ä¸ªhistory stackï¼Œç”¨æˆ·ä¾§çš„è·¯ç”±å¯ä»¥è®©å¼€å‘è€…åœ¨ä¸è®¿é—®åç«¯æœåŠ¡çš„å‰æä¸‹æ“ä½œè·¯ç”±å †æ ˆã€‚
- **History** React Routerå†…ç½®å¯¹è±¡ï¼Œç”¨æˆ·å¯ä»¥ç”¨å®ƒè·å–è·¯ç”±è®¢é˜…ä¿¡æ¯ï¼ŒåŒæ—¶ä¹Ÿæä¾›äº†ä¸€äº›APIæ¥ç„¶ç”¨æˆ·æ“ä½œhistory stackã€‚
- **History Action** - history stackçš„æ“ä½œï¼Œæœ‰Pop. Pushå’ŒReplaceã€‚å¯ä½¿ç”¨Pushæ¥æ–°æ·»åŠ ä¸€ä¸ªè·¯ç”±å…¥å£ï¼Œä½¿ç”¨Replaceä¹Ÿå¯ä»¥è¾¾åˆ°ç±»ä¼¼çš„æ•ˆæœï¼Œåªæ˜¯ä¼šåœ¨å †æ ˆä¸­æ›¿æ¢æ‰å½“å‰çš„è·¯ç”±ï¼Œä½¿ç”¨Popæ¥è·å–ä¸Šä¸€ä¸ªå†å²è·¯ç”±ï¼Œç”¨ä»¥æµè§ˆå™¨è¿”å›ã€‚
- **Segment** - ä»‹äº'/'ä¹‹é—´çš„URLç‰‡æ®µã€‚æ¯”å¦‚ï¼Œâ€™/users/123â€˜å°±æœ‰ä¸¤ä¸ªç‰‡æ®µã€‚
- **Path Pattern** - å¸¦å‚URLã€‚æ¯”å¦‚åŠ¨æ€ç‰‡æ®µ'/users/:userId'å’Œæ˜Ÿå·ç‰‡æ®µ'/docs/\*'ã€‚æ˜¯ä¸€ç§React Routerè·¯ç”±çš„åŒ¹é…æ¨¡å¼ã€‚
- **Dynamic Segment** - åŠ¨æ€ç‰‡æ®µï¼Œè§ä¸Šè¾¹æè¿°ã€‚'users/:userId'å¯ä»¥ç²¾ç¡®åŒ¹é…'users/123'.
- **URL Params** - åŠ¨æ€è·¯ç”±ç‰‡æ®µè§£æå‡ºæ¥çš„è·¯ç”±å‚æ•°ã€‚
- **Router** - æœ‰çŠ¶æ€è·¯ç”±ç»„ä»¶ã€‚å±‚çº§åµŒå¥—ä½¿ç”¨ã€‚
- **Route Config** - è·¯ç”±æ ‘ã€‚é€šè¿‡åŒ¹é…æœºåˆ¶æ¥æ„å»ºè·¯ç”±åˆ†æ”¯ã€‚
- **Route** - è·¯ç”±å…ƒç´ çš„åŸºç¡€ç»„ä»¶ã€‚æœ‰pathå’Œelementä¸¤ä¸ªå‚æ•°ã€‚pathæ˜¯åŒ¹é…æ¨¡å¼ï¼Œå½“pathåŒ¹é…æˆåŠŸåï¼Œelementä¸­çš„å…ƒç´ æ‰ä¼šè¢«æ¸²æŸ“ã€‚
- **Nested Routes** - åµŒå¥—è·¯ç”±ã€‚è·¯ç”±å¯ä»¥æœ‰è‡ªå·±çš„å­©å­ï¼Œæ¯ä¸€ä¸ªè·¯ç”±éƒ½å®šä¹‰äº†URLç‰‡æ®µï¼Œå•ä¸ªURLå¯ä»¥åŒæ—¶åŒ¹é…è·¯ç”±æ ‘ä¸­çš„å¤šä¸ªè·¯ç”±ã€‚è¿™ä½¿å¾—å¯ä»¥ä½¿ç”¨outlet. ç›¸å¯¹è·¯ç”±ç­‰æ¥å¸ƒå±€åµŒå¥—domç»“æ„ã€‚
- **Relative links** - ç›¸å¯¹è·¯ç”±ã€‚ä¸ä½¿ç”¨'/'å¼€å¤´çš„è·¯ç”±ã€‚ä»–ä¼šç»§æ‰¿çˆ¶çº§è·¯ç”±ä½œä¸ºå‰ç¼€æ¥è¿›è¡ŒåŒ¹é…ã€‚è¿™ä½¿å¾—æ·±å±‚æ¬¡çš„URLæ¸²æŸ“å˜å¾—å®¹æ˜“ï¼Œå› ä¸ºä½ ä¸ç”¨å†è€ƒè™‘å¦‚ä½•è·å¾—å®Œæ•´çš„ä¸Šä¸‹æ–‡è·¯ç”±äº†ã€‚
- **Match** - å½“è·¯ç”±ä¸URLåŒ¹é…æ—¶ç”¨äºä¿å­˜ä¿¡æ¯çš„å¯¹è±¡ã€‚æ¯”å¦‚ï¼ŒåŒ¹é…çš„URLå‚æ•°å’Œè·¯å¾„åã€‚
- **Matches** - åŒ¹é…å½“å‰ä½ç½®çš„è·¯ç”±æ•°ç»„ã€‚ç”¨äºåµŒå¥—è·¯ç”±ä¸­ã€‚
- **Parent Route** - çˆ¶è·¯ç”±ã€‚
- **Outlet** - çˆ¶è·¯ç”±ä¸­åŒ¹é…å­è·¯ç”±çš„æ¸²æŸ“æ’æ§½ã€‚
- **Index Route** - outletä¸­é»˜è®¤æ¸²æŸ“çš„ç»„ä»¶ã€‚
- **Layout Route** - æ²¡æœ‰pathçš„çˆ¶è·¯ç”±ã€‚ç”¨äºæŠŠå­è·¯ç”±åˆ†ç»„åˆ°ä¸€ä¸ªå¸ƒå±€å•å…ƒä¸­ã€‚

### Historyå’ŒLocation

åœ¨ä½¿ç”¨React Routerä¹‹å‰ï¼Œéœ€è¦å…ˆè®¢é˜…æµè§ˆå™¨è·¯ç”±å †æ ˆçš„å˜æ›´ã€‚æµè§ˆå™¨ä¼šç‹¬ç«‹ç»´æŠ¤è¯¥å †æ ˆçš„å˜åŒ–ï¼Œæ‰€ä»¥æµè§ˆå™¨è‡ªå¸¦çš„å‰è¿›å’Œåé€€æ‰èƒ½å¤Ÿä½¿ç”¨ã€‚ä¼ ç»Ÿwebå¼€å‘ä¸­ï¼Œç”¨æˆ·æ¯ç‚¹å‡»å‰è¿›æˆ–åé€€. æ¯å‘èµ·ä¸€ä¸ªè·¯ç”±è·³è½¬éƒ½ä¼šå‘åç«¯å‘èµ·è¯·æ±‚ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬æœ‰å¦‚ä¸‹çš„æ“ä½œæµç¨‹ï¼š

1.  ç‚¹å‡»é“¾æ¥è·³è½¬åˆ°Â `/dashboard`
2.  ç‚¹å‡»é“¾æ¥è·³è½¬åˆ°Â `/accounts`
3.  ç‚¹å‡»é“¾æ¥è·³è½¬åˆ°Â `/customers/123`
4.  ç‚¹å‡»åé€€æŒ‰é’®
5.  ç‚¹å‡»é“¾æ¥è·³è½¬åˆ°Â `/dashboard`

é‚£ä¹ˆè·¯ç”±å †æ ˆå°†ä¼šæœ‰å¦‚ä¸‹çš„å˜åŒ–ï¼š
1. \[**`/dashboard`**\]
2.  \[`/dashboard`,Â  **`/accounts`**\]
3.  \[`/dashboard`,Â `/accounts`,Â  **`/customers/123`**\]
4.  \[`/dashboard`,Â  **`/accounts`**,Â `/customers/123`\]
5.  \[`/dashboard`,Â `/accounts`,Â  **`/dashboard`**\]

> è¯‘è€…æ³¨è§£ï¼Œè¿™é‡Œç¬¬å››åˆ°ç¬¬äº”æ­¥ï¼Œ/customers/123è¢«æ›¿æ¢æ‰äº†ï¼Œç±»ä¼¼äºæ“ä½œäº†replaceï¼Œå¯èƒ½æ˜¯æµè§ˆå™¨åˆ¤æ–­ç¬¬4æ­¥æ˜¯backæ“ä½œå›æ¥çš„ï¼Œç¬¬äº”æ­¥ä¸­å¼ºåˆ¶ä½¿ç”¨äº†replaceã€‚

#### History Object

åœ¨ç”¨æˆ·ç«¯è·¯ç”±ä½¿ç”¨çš„è¿‡ç¨‹ä¸­ï¼Œå¼€å‘è€…å¯ä»¥é€šè¿‡ä»£ç æ˜¾å¼çš„æ“ä½œæµè§ˆå™¨è·¯ç”±ã€‚æ¯”å¦‚è¯´ï¼Œå¯ä»¥å¦‚ä¸‹å†™ï¼š

```js
<a
  href="/contact"
  onClick={(event) => {
    // stop the browser from changing the URL and requesting the new document
    event.preventDefault();
    // push an entry into the browser history stack and change the URL
    window.history.pushState({}, undefined, "/contact");
  }}
/>
```
ä¸Šè¿°ä»£ç æ”¹å˜äº†URLï¼Œä½†æ˜¯å¹¶æ²¡æœ‰å¯¹UIè¿›è¡Œä»»ä½•çš„ä¿®æ”¹ã€‚æˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡ä»£ç æ¥æ”¹å˜è·¯ç”±çŠ¶æ€ï¼Œä»è€Œå½±å“UIçš„å˜åŒ–ã€‚ä½†é—®é¢˜æ˜¯ï¼Œæµè§ˆå™¨æ²¡æœ‰æä¾›éå¸¸å¥½çš„ç›‘å¬URLå˜åŒ–çš„æ–¹æ³•ã€‚

æˆ‘ä»¬å¯ä»¥æ¢ç§ç›‘å¬æ–¹å¼ï¼š


```js
window.addEventListener("popstate", () => {
  // URL changed!
});
```

ä¸Šè¿°æ–¹æ³•çœ‹èµ·æ¥ä¸é”™ï¼Œä½†æ˜¯ä»–åªåœ¨ç”¨æˆ·ç‚¹å‡»åé€€æˆ–è€…å‰è¿›æ—¶ç”Ÿæ•ˆã€‚åœ¨ç¨‹åºè°ƒç”¨`window.history.pushState`æˆ–`window.history.replaceState`æ—¶å´æ²¡æœ‰ä»»ä½•ç›‘å¬äº‹ä»¶å¯ä»¥ä½¿ç”¨ã€‚

åœ¨React Routerä¸­ï¼Œhistoryå¯ä»¥å¸®åŠ©ä½ å®ç°ç›‘å¬ã€‚ä»–æä¾›å¯¹push. pop. replaceäº‹ä»¶çš„ç›‘å¬ï¼š

```js
let history = createBrowserHistory();
history.listen(({ location, action }) => {
  // this is called whenever new locations come in
  // the action is POP, PUSH, or REPLACE
});
```
Appä¸éœ€è¦å†é¢å¤–åˆ›å»ºä»–ä»¬è‡ªå·±çš„historyå¯¹è±¡ï¼Œé€šè¿‡ç®€å•çš„ç›‘å¬å‡½æ•°ï¼Œå¯ä»¥å®Œæˆæ­£ç¡®çš„é‡æ–°æ¸²æŸ“ã€‚

#### Location

æµè§ˆå™¨çš„windowè‡ªå¸¦æœ‰locationå¯¹è±¡ï¼Œä»–æä¾›URLçš„ç›¸å…³ä¿¡æ¯ï¼š

```js
window.location.pathname; // /getting-started/concepts/
window.location.hash; // #location
window.location.reload(); // force a refresh w/ the server
```

åœ¨React Routerä¸­çš„ä½¿ç”¨ç±»ä¼¼ï¼Œä½†æ˜¯ä¼šæ›´ç®€å•ï¼Œå…¶ç»“æ„å¦‚ä¸‹ï¼š


```js
{
  pathname: "/bbq/pig-pickins",
  search: "?campaign=instagram",
  hash: "#menu",
  state: null,
  key: "aefz24ie"
}
```
å‰ä¸‰ä¸ªå‚æ•°`{ pathname, search, hash }`ç±»ä¼¼äºwindow.locationï¼Œåä¸¤ä¸ªå‚æ•°æ˜¯React Routerç‹¬æœ‰çš„ã€‚

##### Location Pathname

Location Pathnameæ˜¯URLçš„ä¸€éƒ¨åˆ†ï¼Œæ¯”å¦‚å¯¹äºURLï¼š`https://example.com/teams/hotspurs`, ä»–çš„pathnameå°±æ˜¯`/teams/hotspurs`ã€‚è¿™éƒ¨åˆ†æ‰æ˜¯ç”¨äºè·¯ç”±åŒ¹é…çš„ã€‚

##### Location Search

URLæœ‰å¾ˆå¤šä¸åŒçš„ä½¿ç”¨é€‰é¡¹ï¼š

- location search
- search params
- URL search params
- query string

åœ¨React Routerä¸­ï¼Œæˆ‘ä»¬ä¾¿å¯ä»¥ä½¿ç”¨location searchï¼Œå®ƒæ˜¯ä¸€ç§åºåˆ—åŒ–çš„`URLSearchParams`ï¼Œæ‰€ä»¥æœ‰æ—¶å€™ä¹Ÿå¯ä»¥å«ä»–`URL search params`ï¼š

```js
// given a location like this:
let location = {
  pathname: "/bbq/pig-pickins",
  search: "?campaign=instagram&popular=true",
  hash: "",
  state: null,
  key: "aefz24ie",
};

// we can turn the location.search into URLSearchParams
let params = new URLSearchParams(location.search);
params.get("campaign"); // "instagram"
params.get("popular"); // "true"
params.toString(); // "campaign=instagram&popular=true",
```
è§£æå‰çš„åºåˆ—åŒ–å­—ç¬¦ä¸²å«`search`ï¼Œç²¾å‡†è§£æåä¾¿æ˜¯`search params`äº†ã€‚è¯‘è€…è®¤ä¸ºè¿™é‡Œæè¿°çš„æ„æ€å°±æ˜¯è¯´å¯ä»¥å°†URLå­—ç¬¦ä¸²ç¿»è¯‘ä¸ºä¸€ä¸ªç»“æ„åŒ–çš„å‚æ•°å¯¹è±¡ã€‚å½“ä¸éœ€è¦è€ƒè™‘ç²¾ç¡®åº¦æ—¶ï¼Œè¿™ä¸¤ä¸ªæ¦‚å¿µæ˜¯å¯ä»¥äº’æ¢çš„ã€‚

##### Location Hash

URLä¸­çš„å“ˆå¸Œï¼ˆé”šç‚¹ï¼‰è¡¨ç¤ºå½“å‰é¡µé¢æ»šåŠ¨çš„ä½ç½®ã€‚åœ¨window.history.pushStateè¢«å¼•å…¥ä¹‹å‰ï¼Œwebå¼€å‘è€…åªèƒ½é€šè¿‡æ”¹å˜URLé”šç‚¹æ¥æ§åˆ¶æµè§ˆå™¨è·¯ç”±çš„å˜åŒ–ï¼Œè¿™ä¹Ÿæ˜¯åœ¨ä¸è®¿é—®åç«¯æœåŠ¡çš„å‰æä¸‹æ”¹å˜è·¯ç”±çš„å”¯ä¸€æ–¹å¼ã€‚ç°åœ¨æˆ‘ä»¬ä»ç„¶å¯ä»¥è¿™æ ·ä½¿ç”¨ä»–ã€‚

##### Location State

ä½ å¯èƒ½ä¼šå¥½å¥‡H5çš„API`window.history.pushState()`ä¸ºä»€ä¹ˆä¼šå«åšpush stateï¼Œæˆ‘ä»¬åˆšåˆšæ”¹å˜äº†URLï¼Œç†è®ºä¸Šä¸æ˜¯åº”è¯¥å«åš`history.push`æ›´è´´åˆ‡ï¼Ÿå“ˆï¼Œæˆ‘ä»¬ä¹Ÿä¸æ˜¯æµè§ˆå™¨æ ‡å‡†çš„åˆ¶å®šè€…ï¼Œè¿™äº›é—®é¢˜æˆ‘ä»¬æš‚ä¸”ä¸è€ƒè™‘ï¼Œå°±è¿™ä¸ªAPIæœ¬èº«è€Œè¨€ï¼Œç¡®å®æ˜¯ä¸€ä¸ªä¸é”™çš„æµè§ˆå™¨æ–°ç‰¹æ€§ã€‚ï¼ˆä½œè€…éšæ€§ç¿»è¯‘ï¼Œå¤§æ„åŸºæœ¬æ˜¯è¿™æ ·ï¼‰ã€‚

æµè§ˆå™¨æä¾›çš„è¿™ä¸ªstateï¼Œå¯ä»¥è®©æˆ‘ä»¬è½»æ¾åœ°ä¼ é€’è·¯ç”±çŠ¶æ€ã€‚å½“æˆ‘ä»¬ç‚¹å‡»æµè§ˆå™¨åé€€æŒ‰é’®æ—¶ï¼Œé€šè¿‡`pushState`ä¾¿å¯ä»¥å¼•èµ·`history.state`çš„å˜åŒ–ï¼š

> è¯‘è€…æé†’ï¼šè¿™ç§çŠ¶æ€åœ¨åˆ·æ–°æµè§ˆå™¨åä¼šä¸¢å¤±ï¼Œéœ€è¦æ…ç”¨

```js
window.history.pushState("look ma!", undefined, "/contact");
window.history.state; // "look ma!"
// user clicks back
window.history.state; // undefined
// user clicks forward
window.history.state; // "look ma!"
```

React Routeråˆ©ç”¨äº†æµè§ˆå™¨è‡ªå¸¦çš„åŠŸèƒ½ï¼Œå¯¹å…¶è¿›è¡Œäº†ä¸€äº›æŠ½è±¡å°è£…ï¼Œå¹¶å°†å€¼æ˜¾ç¤ºåœ¨locationä¸­ï¼Œè€Œä¸æ˜¯historyé‡Œã€‚

ä½ å¯ä»¥è¯•ç€ä½¿ç”¨location.stateï¼Œæ¯”å¦‚`location.hash`æˆ–è€…`location.search`ï¼Œè€Œä¸æ˜¯ç›´æ¥å°†è·¯ç”±å‚æ•°æ”¾åœ¨URLé‡Œï¼Œè¿™æ ·ä½ çš„URLä¼šæ¯”è¾ƒæ•´æ´ï¼Œä¼ é€’ä¼šç›¸å¯¹å®‰å…¨ã€‚

ä¸€ç»„æ¯”è¾ƒå¥½çš„ä½¿ç”¨æ¡ˆä¾‹ï¼š

- å‘Šè¯‰ä¸‹ä¸ªé¡µé¢ä½ è·³è½¬è‡ªå“ªé‡Œï¼Œä»¥æ­¤æ¥åŠ¨æ€å¸ƒå±€UIã€‚ç”¨çš„æœ€å¤šçš„ä¾‹å­æ˜¯ç”¨æˆ·ç‚¹å‡»ä¸€ä¸ªitemï¼Œç„¶åæ‰“å¼€ä¸€ä¸ªå¼¹çª—æ˜¾ç¤ºè¯¦ç»†è®°å½•çš„ä½¿ç”¨åœºæ™¯ã€‚å¦‚æœä½ æƒ³ç›´æ¥æ˜¾ç¤ºåˆ°URLçš„è¯ï¼Œï¼ˆè¯‘è€…è®¤ä¸ºæ˜¯è¯¦æƒ…é¡µé¢å¯ä»¥å¼¹çª—æ˜¾ç¤ºåˆå¯ä»¥é¡µé¢æ˜¾ç¤ºçš„æ„æ€ï¼‰ï¼Œé‚£ä¹ˆå°±å¯ä»¥è‡ªå®šä¹‰å¸ƒå±€ç»„ä»¶æ¥æ˜¾ç¤ºã€‚
- ä¼ é€’é¡µé¢è®°å½•ä¿¡æ¯çš„ä¸€éƒ¨åˆ†ç»™è¦è·³è½¬çš„é¡µé¢ï¼Œé‚£ä¹ˆä¸‹ä¸ªé¡µé¢ä¼šç›´æ¥å°†è¿™ä¸€éƒ¨åˆ†æ¸²æŸ“å‡ºæ¥ï¼Œè¿›è€Œå¯ä»¥å€ŸåŠ©å·²æœ‰ä¿¡æ¯æ¸²æŸ“å‰©ä½™éƒ¨åˆ†ã€‚

ä»£ç å®ç°ä¸Šï¼Œå¯ä»¥ä½¿ç”¨`<Link>`æˆ–è€…`navigate`æ¥å®ç°æ”¹å˜stateï¼š

```jsx
<Link to="/pins/123" state={{ fromDashboard: true }} />;

let navigate = useNavigate();
navigate("/users/123", { state: partialUser });
```

åœ¨è·³è½¬åçš„é¡µé¢ä¸­ä½¿ç”¨`useLocation`è·å–è·¯ç”±ä¿¡æ¯ï¼š

```js
let location = useLocation();
location.state;
```

> location.stateæ˜¯ä¸€ä¸ªåºåˆ—åŒ–çš„å€¼ï¼Œä½¿ç”¨new Date()ä¼ é€’æ—¶é—´æ—¶ï¼Œä¼šè¢«è½¬åŒ–ä¸ºå­—ç¬¦ä¸²

##### Location Key

æ¯ä¸€ä¸ªlocationåˆæœ‰è‡ªå·±å”¯ä¸€çš„keyã€‚è¿™å¯¹äºé”šç‚¹æ»šåŠ¨å¼è·¯ç”±è·³è½¬. å®¢æˆ·ç«¯æ•°æ®ç¼“å­˜ç­‰æ˜¯å¾ˆæœ‰å¸®åŠ©çš„ã€‚æ¯ä¸€ä¸ªlocationè·å–å”¯ä¸€keyåï¼Œä½ éƒ½å¯ä»¥ä½¿ç”¨æ‰å¹³åŒ–æ•°ç»„. new Map()ï¼Œç”šè‡³æ˜¯locationStorageæ¥å°†å¯¹åº”ä¿¡æ¯æŠ½è±¡å‡ºæ¥ã€‚

ä¸¾ä¸ªğŸŒ°ï¼Œåœ¨ä¸€ä¸ªå•ä¸€çš„å®¢æˆ·ç«¯ï¼Œä¸è¯·æ±‚åç«¯æ•°æ®ï¼Œåœ¨ç”¨æˆ·ç‚¹å‡»åé€€æŒ‰é’®æ—¶ï¼Œå¯ä»¥é€šè¿‡å¦‚ä¸‹è®¾ç½®æ¥å­˜å‚¨è·¯ç”±ç¼“å­˜ï¼š

```js
let cache = new Map();

function useFakeFetch(URL) {
  let location = useLocation();
  let cacheKey = location.key + URL;
  let cached = cache.get(cacheKey);

  let [data, setData] = useState(() => {
    // initialize from the cache
    return cached || null;
  });

  let [state, setState] = useState(() => {
    // avoid the fetch if cached
    return cached ? "done" : "loading";
  });

  useEffect(() => {
    if (state === "loading") {
      let controller = new AbortController();
      fetch(URL, { signal: controller.signal })
        .then((res) => res.json())
        .then((data) => {
          if (controller.signal.aborted) return;
          // set the cache
          cache.set(cacheKey, data);
          setData(data);
        });
      return () => controller.abort();
    }
  }, [state, cacheKey]);

  useEffect(() => {
    setState("loading");
  }, [URL]);

  return data;
}
```

### Matching

åœ¨é¡µé¢åˆå§‹åŒ–æ¸²æŸ“å’Œhistory stackå˜åŒ–æ—¶ï¼ŒReact Routerä¼šé’ˆå¯¹è·¯ç”±é…ç½®é¡¹æ¥åŒ¹é…å‡ºä¸€å¥—æ¸²æŸ“ç»“æ„ã€‚

#### Defining Routes

è·¯ç”±é…ç½®ç±»ä¼¼ä¸€ä¸ªå±‚çº§æ ‘ï¼Œå°±åƒä¸‹é¢çš„ä¾‹å­ï¼š


```jsx
<Routes>
  <Route path="/" element={<App />}>
    <Route index element={<Home />} />
    <Route path="teams" element={<Teams />}>
      <Route path=":teamId" element={<Team />} />
      <Route path=":teamId/edit" element={<EditTeam />} />
      <Route path="new" element={<NewTeamForm />} />
      <Route index element={<LeagueStandings />} />
    </Route>
  </Route>
  <Route element={<PageLayout />}>
    <Route path="/privacy" element={<Privacy />} />
    <Route path="/tos" element={<Tos />} />
  </Route>
  <Route path="contact-us" element={<Contact />} />
</Routes>
```

`<Routes>`é€’å½’åœ°æ¸²æŸ“åŒ¹é…åˆ°çš„`props.children`ï¼Œæå–ä»–ä»¬çš„propså¹¶ç”Ÿæˆå¦‚ä¸‹çš„ç»“æ„ï¼š


```jsx
let routes = [
  {
    element: <App />,
    path: "/",
    children: [
      {
        index: true,
        element: <Home />,
      },
      {
        path: "teams",
        element: <Teams />,
        children: [
          {
            index: true,
            element: <LeagueStandings />,
          },
          {
            path: ":teamId",
            element: <Team />,
          },
          {
            path: ":teamId/edit",
            element: <EditTeam />,
          },
          {
            path: "new",
            element: <NewTeamForm />,
          },
        ],
      },
    ],
  },
  {
    element: <PageLayout />,
    children: [
      {
        element: <Privacy />,
        path: "/privacy",
      },
      {
        element: <Tos />,
        path: "/tos",
      },
    ],
  },
  {
    element: <Contact />,
    path: "/contact-us",
  },
];
```

äº‹å®ä¸Šï¼Œä½ å¯ä»¥ä¸ä½¿ç”¨`<Routes>`ï¼Œä½¿ç”¨hook `useRoutes(routesGoHere)`ä¾ç„¶å¯ä»¥å®Œæˆä¸Šè¿°ä»»åŠ¡ã€‚å¦‚ä½ æ‰€è§ï¼Œè·¯ç”±å®šä¹‰ä¸­ï¼Œå¯ä»¥å£°æ˜å¤šé‡è·¯ç”±ç‰‡æ®µï¼Œæ¯”å¦‚`:itemId/edit`ï¼Œä¹Ÿå¯ä»¥å£°æ˜å•ä¸ªç‰‡æ®µï¼Œæ¯”å¦‚`:itemId`ã€‚æ‰€æœ‰çš„ç‰‡æ®µä¼šè¢«ç»„åˆåœ¨ä¸€ä¸ªæ¥æ„å»ºæœ€åçš„è·¯å¾„æ¨¡å¼ï¼ˆè·¯ç”±æ ‘ï¼‰ã€‚

#### Match Params

ä»¥`/items/:itemId`è¿™ç§åŠ¨æ€è·¯ç”±ç‰‡æ®µä¸ºä¾‹ï¼Œä»–å¯ä¸æ˜¯é™æ€åŒ¹é…URLçš„ï¼Œä»»ä½•çš„å€¼ä¼¼ä¹éƒ½å¯ä»¥å½“åš`:itemId`æ¥ä½¿ç”¨ï¼Œæ¯”å¦‚`/items/123`å’Œ`/items/å°è‚šè‚šè‚šè‚šè‚šå“¦`ã€‚è§£æå‡ºæ¥çš„å€¼å°±æ˜¯`URL params`ã€‚åœ¨æ¸²æŸ“ä¸€èŠ‚ï¼ˆRenderingï¼‰ä¼šè®²è¿°æ€ä¹ˆç”¨è¿™ä¸ªå‚æ•°ã€‚

#### Ranking Routes

å½“æˆ‘ä»¬è®¾ç½®å®Œè·¯ç”±é…ç½®åï¼Œæˆ‘ä»¬æœ€ç»ˆä¼šå¾—åˆ°è¯¸å¦‚å¦‚ä¸‹çš„åŒ¹é…æ¨¡å¼ï¼š


```js
[
  "/",
  "/teams",
  "/teams/:teamId",
  "/teams/:teamId/edit",
  "/teams/new",
  "/privacy",
  "/tos",
  "/contact-us",
];
```

äº‹æƒ…å˜å¾—çªç„¶èŒƒç‰¹è¥¿èµ·æ¥ï¼Œä»¥è¯·æ±‚path `"/teams/new"`ä¸ºä¾‹ï¼Œä¸Šè¿°åˆ—è¡¨ä¸­å“ªä¸€ä¸ªåŒ¹é…æ¨¡å¼èƒ½å¤Ÿè¢«ç¿»ç‰Œå­ï¼Ÿæˆ‘çŒœæœ‰ä¸¤ä¸ªï¼š


```
/teams/new
/teams/:teamId
```

æ­¤æ—¶ï¼ŒReact Routerå°±éœ€è¦åšå‡ºæœ€ç»ˆå†³å®šï¼Œåˆ°åº•ç¿»å“ªä¸€ä¸ªçš„ç‰Œå­ï¼Œå¤§å¤šæ•°è·¯ç”±éƒ½ä¼šæŒ‰ç…§ä»–ä»¬å®šä¹‰çš„å…ˆåé¡ºåºè¿›è¡ŒåŒ¹é…ï¼Œå…ˆåˆ°å…ˆå¾—ã€‚ä½†æ˜¯ä½¿ç”¨è¿™ç§ç®—æ³•ï¼Œæˆ‘ä»¬è¿`/`éƒ½èƒ½åŒ¹é…åˆ°äº†ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬åº”è¯¥æ›´åŠ å®Œç¾çš„æ’åºè¿™äº›åŒ¹é…æ¨¡å¼ï¼Œè¿›è€Œè¾¾åˆ°æˆ‘ä»¬æƒ³è¦çš„åŒ¹é…ç»“æœã€‚è¿™ä¹Ÿæ˜¯v6æ¯”è¾ƒæ™ºèƒ½çš„ä¸€ä¸ªä½“ç°ã€‚

è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬ç›´è§‚çš„æ„Ÿè§‰`/teams/new`åº”è¯¥æ˜¯æœ€ç»ˆçš„ç»“æœã€‚æˆ‘ä»¬æ‰€åšçš„å°±æ˜¯æ•™ä¼šäº†React Routerå»å®Œæˆè¿™ä¸ªä»»åŠ¡ã€‚åœ¨åŒ¹é…çš„è¿‡ç¨‹ä¸­ï¼ŒReact Routerä¼šæŒ‰ç…§ç‰‡æ®µåºå·è¿›è¡Œæ’åºï¼ˆåŒ…æ‹¬é™æ€çš„. åŠ¨æ€çš„å’Œæ˜Ÿå·ç‰‡æ®µç­‰ï¼‰ï¼ŒæŒ‘é€‰æœ€é€‚åˆçš„åŒ¹é…æ¨¡å¼ï¼Œè€Œå¯¹äºå¼€å‘è€…ï¼Œå†ä¹Ÿä¸ç”¨è€ƒè™‘è·¯ç”±é…ç½®çš„å…ˆåæ”¾ç½®é¡ºåºäº†ã€‚

#### Pathless Routes

è¿˜æœ‰ä¸€äº›ä¸å¸¦pathçš„è·¯ç”±ï¼š

```html
<Route index element={<Home />} />
<Route index element={<LeagueStandings />} />
<Route element={<PageLayout />} />
```

å¯¹äºè¿™ç§æˆ‘ä»¬æ€ä¹ˆåŒ¹é…å‘¢ï¼ŸReact Routerçš„åŒ¹é…æ—¶ç›¸å½“å®½æ¾çš„ï¼Œ`<LeagueStandings />`å’Œ`<Home />`ç»„ä»¶æ˜¯indexè·¯ç”±ï¼Œ`<PageLayout />`æ˜¯å¸ƒå±€è·¯ç”±ï¼Œæˆ‘ä»¬åœ¨æ¸²æŸ“ï¼ˆRenderingï¼‰è¿™ä¸€èŠ‚æ¥è®¨è®ºä»–æ˜¯æ€ä¹ˆå·¥ä½œçš„ï¼Œè¿™ä¸¤è€…éƒ½ä¸åŒ¹é…æœ¬èº«æ²¡æœ‰å¤šå¤§å…³ç³»ã€‚


#### Route Matches

å½“è·¯ç”±å»åŒ¹é…URLæ—¶ï¼Œå†…éƒ¨éƒ½ä¼šè½¬åŒ–ä¸€ä¸ªåŒ¹é…å¯¹è±¡ï¼Œä»¥`<Route path=":teamId" element={<Team/>}/>`ä¸ºä¾‹ï¼š
 
```jsx
{
  pathname: "/teams/firebirds",
  params: {
    teamId: "firebirds"
  },
  route: {
    element: <Team />,
    path: ":teamId"
  }
}
```

pathnameæ˜¯URLéƒ¨åˆ†ï¼Œä»£è¡¨çš„æ˜¯å…¨é‡è·¯å¾„ï¼›paramsæ˜¯é€šè¿‡URLè§£ææ¥çš„æš‚æ€è·¯ç”±å‚æ•°ï¼Œ`:teamId`å³ä¸º`params.teamId`ã€‚

å› ä¸ºè·¯ç”±è¡¨æ˜¯ä¸€æ£µæ ‘ï¼Œå•ä¸ªURLå¯èƒ½ä¼šåŒ¹é…ä¹¦ä¸Šçš„å¤šä¸ªåˆ†æ”¯ï¼Œä»¥`/teams/firebirds`ä¸ºä¾‹ï¼š


```diff 
<Routes>
+   <Route path="/" element={<App />}>
    <Route index element={<Home />} />
+   <Route path="teams" element={<Teams />}>
+     <Route path=":teamId" element={<Team />} />
      <Route path=":teamId/edit" element={<EditTeam />} />
      <Route path="new" element={<NewTeamForm />} />
      <Route index element={<LeagueStandings />} />
    </Route>
  </Route>
  <Route element={<PageLayout />}>
    <Route path="/privacy" element={<Privacy />} />
    <Route path="/tos" element={<Tos />} />
  </Route>
  <Route path="contact-us" element={<Contact />} />
</Routes>
```
é«˜äº®éƒ¨åˆ†æ˜¯ä»–çš„åŒ¹é…è·¯å¾„ã€‚React Routerä¼šåˆ›å»ºä¸€ä¸ªåŒ¹é…æ•°ç»„æ¥å­˜æ”¾åµŒå¥—çš„åŒ¹é…è·¯ç”±ï¼Œæ‰€ä»¥ä¼šç”Ÿæˆä¸€ä¸ªåµŒå¥—çš„UIç»“æ„ï¼š

```jsx
[
  {
    pathname: "/",
    params: null,
    route: {
      element: <App />,
      path: "/",
    },
  },
  {
    pathname: "/teams",
    params: null,
    route: {
      element: <Teams />,
      path: "teams",
    },
  },
  {
    pathname: "/teams/firebirds",
    params: {
      teamId: "firebirds",
    },
    route: {
      element: <Team />,
      path: ":teamId",
    },
  },
];
```

### Rendering

æœ€åçš„é‡å¤´æˆï¼Œåœ¨æ‹¿åˆ°åŒ¹é…æ•°åï¼Œè¦å¦‚ä½•è¿›è¡Œæ¸²æŸ“å‘¢ï¼Ÿè€ƒè™‘å¦‚ä¸‹çš„ç»“æ„ï¼š


```jsx
// react 18+
const root = ReactDOM.createRoot(
  document.getElementById("root")
);
root.render(
  <BrowserRouter>
    <Routes>
      <Route path="/" element={<App />}>
        <Route index element={<Home />} />
        <Route path="teams" element={<Teams />}>
          <Route path=":teamId" element={<Team />} />
          <Route path=":teamId/edit" element={<EditTeam />} />
          <Route path="new" element={<NewTeamForm />} />
          <Route index element={<LeagueStandings />} />
        </Route>
      </Route>
      <Route element={<PageLayout />}>
        <Route path="/privacy" element={<Privacy />} />
        <Route path="/tos" element={<Tos />} />
      </Route>
      <Route path="contact-us" element={<Contact />} />
    </Routes>
  </BrowserRouter>
);
```

æˆ‘ä»¬ä½¿ç”¨è®¿é—®è·¯å¾„`/teams/firebirds`ä½œä¸ºä¾‹å­æ¥è§£é‡Šå¦‚ä½•æ¸²æŸ“è·¯ç”±ã€‚`<Routes>`ä¼šè¯†åˆ«é…ç½®é¡¹ï¼Œé€šè¿‡ç²¾å‡†åŒ¹é…ååœ¨é¡µé¢ä¸Šæ„å»ºå¦‚ä¸‹ç»“æ„ï¼š

```jsx
<App>
  <Teams>
    <Team />
  </Teams>
</App>
```

æ¯ä¸€çº§åŒ¹é…é¡¹éƒ½æ”¾ç½®åœ¨å…¶çˆ¶è·¯ç”±å…ƒç´ ä¸­ï¼Œæœ€ç»ˆæ¸²æŸ“çš„ç»“æ„ä¸è·¯ç”±é…ç½®æ–‡ä»¶å®Œå…¨ä¸€æ ·ã€‚å¤§å¤šæ•°çš„ç½‘ç«™å’Œappéƒ½æœ‰è¿™æ ·çš„ç‰¹æ€§ï¼šå¥—å¨ƒå¼æ”¾ç½®å…ƒç´ ï¼Œæ¯ä¸€çº§å…ƒç´ éƒ½ä¼šæœ‰è‡ªå·±çš„å¯¼èˆªæ¥æ›´æ”¹è‡ªå·±çš„å­é¡µé¢å†…å®¹ã€‚

#### Outlets

åµŒå¥—å…ƒç´ æ ‘ä¸ä¼šè‡ªåŠ¨æ¸²æŸ“ï¼Œéœ€è¦ç”¨outletæ¥å‘Šè¯‰çˆ¶å…ƒç´ æ¸²æŸ“å­å…ƒç´ çš„åœ°æ–¹ã€‚`<Routes>`ä¼šé¦–å…ˆæ¸²æŸ“å…ƒç´ æ ‘çš„é¡¶å±‚å…ƒç´ ï¼ˆæ¯”å¦‚`<App />`ï¼‰ï¼Œæ¥ä¸‹æ¥åŒ¹é…å…ƒç´ `<Teams>`ï¼š

```jsx
function App() {
  return (
    <div>
      <GlobalNav />
      <Outlet />
      <GlobalFooter />
    </div>
  );
}
```

Outletç»„ä»¶ä¼šæ¸²æŸ“ä¸‹ä¸€ä¸ªmatchçš„å…ƒç´ ã€‚åŒç†ï¼Œ`<Teams>`ä¸­ä¹Ÿéœ€è¦ä¸€ä¸ªoutletæ¥æ¸²æŸ“`<Team />`ã€‚

å¦‚æœURLæ˜¯`/contact-us`ï¼Œé‚£ä¹ˆå…ƒç´ æ ‘å°±ä¼šæ˜¯å¦‚ä¸‹ç»“æ„ï¼š
```
<Contact />
```
ä»–æ²¡æœ‰åœ¨Appç»„ä»¶ä¹‹ä¸‹ï¼Œæ‰€ä»¥ä¼šå•ç‹¬æŒ‰ç…§è·¯ç”±å±‚çº§ç»“æ„æ¸²æŸ“ã€‚

å¦‚æœURLæ˜¯`/teams/firebirds/edit`ï¼Œå…ƒç´ æ ‘ä¼šå˜æˆï¼š

```jsx
<App>
  <Teams>
    <EditTeam />
  </Teams>
</App>
```

Outletæ˜¯ä¸€ä¸ªå ä½ç¬¦ï¼Œè¢«åŒ¹é…åˆ°åä¼šæ›¿æ¢ä¸ºåŒ¹é…çš„å­å…ƒç´ ï¼Œè€Œçˆ¶çº§å…ƒç´ ä¸ä¼šå˜åŒ–ã€‚


#### Index Routes

å¯¹äºå¦‚ä¸‹çš„è·¯ç”±é…ç½®ï¼š

```jsx
<Route path="teams" element={<Teams />}>
  <Route path=":teamId" element={<Team />} />
  <Route path="new" element={<NewTeamForm />} />
  <Route index element={<LeagueStandings />} />
</Route>
```
å¦‚æœè®¿é—®è·¯å¾„`/teams/firebirds`ï¼Œé‚£ä¹ˆå…ƒç´ æ ‘å°±ä¼šæ˜¯å¦‚ä¸‹ç»“æ„ï¼š

```jsx
<App>
  <Teams>
    <Team />
  </Teams>
</App>
```
ä½†æ˜¯ï¼Œå¦‚æœè®¿é—®è·¯å¾„æ˜¯`/teams`ï¼Œé‚£ä¹ˆå…ƒç´ æ ‘å°±ä¼šæ˜¯ï¼š
```jsx
<App>
  <Teams>
    <LeagueStandings />
  </Teams>
</App>
```
è¿™é‡Œçš„ä¼˜å…ˆçº§æ˜¯æ€ä¹ˆå¤„ç†çš„ï¼Ÿä¸ºä»€ä¹ˆå£°æ˜äº†indexå°±èƒ½å¤Ÿä¼˜å…ˆè¢«popå‡ºæ¥ï¼Ÿä»–ç”šè‡³éƒ½æ²¡æœ‰pathï¼å¾ˆæ˜¾ç„¶ï¼Œä¸æ˜¯é€šè¿‡pathçš„åŒ¹é…é€»è¾‘æ¥çš„ã€‚è¿™é‡Œä½¿ç”¨äº†ç‰¹æ®Šçš„index routesï¼ŒåŒæ ·æ˜¯æ¸²æŸ“åœ¨çˆ¶ç»„ä»¶ä¸‹çš„outletçš„ä½ç½®ã€‚è¿™é‡Œå¦‚æœä¸è®¾ç½®indexè·¯ç”±çš„è¯ï¼Œä»…ä»…è®¿é—®`/teams`ï¼Œæ¸²æŸ“çš„å…ƒç´ æ ‘ä¼šæ˜¯ä¸‹é¢è¿™æ ·ï¼š
```jsx
<App>
  <Teams />
</App>
```

å¦‚æœteamsè·¯ç”±è¢«æ˜¾ç¤ºåœ¨å·¦ä¾§çš„ç›®å½•æ ‘ä¸‹æ—¶ï¼Œnameé¡µé¢å³ä¾§å°±ä¼šæ˜¯ç©ºç™½é¡µäº†ï¼éœ€è¦é»˜è®¤çš„é¡µé¢ç»„ä»¶æ¥å¡«å……ã€‚æ¢å¥è¯è¯´ï¼Œindexè·¯ç”±å°±æ˜¯åœ¨æ‰€æœ‰childæ²¡æœ‰åŒ¹é…çš„æ—¶å€™ç»™å‡ºçš„é»˜è®¤æ¸²æŸ“æ–¹æ¡ˆã€‚


æ ¹æ®ä¸šåŠ¡éœ€æ±‚çš„ä¸åŒï¼Œå¯èƒ½ä¼šéœ€è¦ä¸åŒçš„è·¯ç”±ç»“æ„ã€‚ä¸ç®¡çˆ¶è·¯ç”±ä¸‹çš„å­è·¯ç”±å¦‚ä½•æ’åºï¼Œæ€»æ˜¯æ— æ³•é¿å…ç”¨æˆ·ä¼šç›´æ¥è®¿é—®çˆ¶è·¯ç”±çš„è·¯å¾„ï¼Œå¦‚æœçˆ¶è·¯ç”±ä¸­ç”¨äº†outletçš„è¯å°±ä¼šäº§ç”Ÿç©ºç™½é¡µï¼Œindexå°±æ˜¯ç”¨æ¥å¡«å……ç©ºç™½çš„ï¼ˆ**è¯‘è€…**ï¼šä½œè€…çš„æè¿°æœ‰ä¸€äº›ç¹çï¼Œå…¶å®å°±æ˜¯ä¸€å¥è¯ï¼šé»˜è®¤è·¯ç”±ä½œä¸ºç©ºç™½å¡«å……ç‰©ï¼‰ã€‚

> æˆ‘å‘ç°React Routerçš„å®˜ç½‘è‡ªå·±æœ¬èº«å°±æ²¡æœ‰åšçš„å¾ˆå¥½ï¼ŒIndexæ˜¯ä¸æ˜¯å¿˜äº†

![image.png](/img/posts/2022-6-7/2022-6-7-1.png)

#### Layout Routes

è€ƒè™‘å¦‚ä¸‹é«˜äº®éƒ¨åˆ†çš„è·¯å¾„ï¼š

```diff
<Routes>
+ <Route path="/" element={<App />}>
    <Route index element={<Home />} />
    <Route path="teams" element={<Teams />}>
      <Route path=":teamId" element={<Team />} />
      <Route path=":teamId/edit" element={<EditTeam />} />
      <Route path="new" element={<NewTeamForm />} />
      <Route index element={<LeagueStandings />} />
    </Route>
  </Route>
+ <Route element={<PageLayout />}>
+   <Route path="/privacy" element={<Privacy />} />
    <Route path="/tos" element={<Tos />} />
  </Route>
  <Route path="contact-us" element={<Contact />} />
</Routes>
```

ä»–çš„æ¸²æŸ“å…ƒç´ æ ‘æ˜¯ï¼š
```jsx
<App>
  <PageLayout>
    <Privacy />
  </PageLayout>
</App>
```
å¯ä»¥çœ‹åˆ°ï¼Œä¸¤ä¸ªå¹¶åˆ—çš„`<Route>`ç«Ÿç„¶æ¸²æŸ“å‡ºäº†åŒ…å«å…³ç³»ã€‚è¿™ç§æƒ…å†µçš„å‡ºç°åªæ˜¯ä¸ºäº†ç®€åŒ–åœ¨åŒä¸€ä¸ªå¸ƒå±€ä¸­å¤šé‡å­è·¯ç”±
åµŒå¥—çš„å…³ç³»ã€‚ä¸è¿‡ç¦ç”¨è¿™ç§åˆå¹¶ï¼Œåˆä¸æƒ³æ— é™åˆ¶åµŒå¥—ä¸‹å»çš„è¯ï¼Œå°±å¾—éœ€è¦æ¯”è¾ƒç¹ççš„é…ç½®äº†ï¼Œå¯èƒ½ä¼šå‡ºç°å¤§é‡é‡å¤çš„ç»„ä»¶ï¼š

> ä¸å»ºè®®è¿™æ ·å†™å“¦

```jsx
<Routes>
  <Route path="/" element={<App />}>
    <Route index element={<Home />} />
    <Route path="teams" element={<Teams />}>
      <Route path=":teamId" element={<Team />} />
      <Route path=":teamId/edit" element={<EditTeam />} />
      <Route path="new" element={<NewTeamForm />} />
      <Route index element={<LeagueStandings />} />
    </Route>
  </Route>
  <Route
    path="/privacy"
    element={
      <PageLayout>
        <Privacy />
      </PageLayout>
    }
  />
  <Route
    path="/tos"
    element={
      <PageLayout>
        <Tos />
      </PageLayout>
    }
  />
  <Route path="contact-us" element={<Contact />} />
</Routes>
```
æ‰€ä»¥ï¼Œå«ä»–å¸ƒå±€è·¯ç”±æœ‰ç‚¹é—®é¢˜ï¼Œå› ä¸ºä»–å¹¶ä¸ä¼šå»å‚ä¸åŒ¹é…URLï¼Œä»–åªæ˜¯ä¸ºäº†æ–¹ä¾¿ç”¨æˆ·ä½¿ç”¨è€Œåšçš„ä¸€ç§è·¯ç”±åˆå¹¶è€Œå·²ã€‚

> æ’ä¸€å¥ï¼Œæ— é™åˆ¶åµŒå¥—å¯ä»¥è¿™ä¹ˆå†™ï¼Œä¸è¿‡è·¯å¾„ä¼šé•¿ä¸€äº›ï¼š/layout/privacy


```jsx
<Routes>
  <Route path="/" element={<App />}>
    <Route index element={<Home />} />
    <Route path="teams" element={<Teams />}>
      <Route path=":teamId" element={<Team />} />
      <Route path=":teamId/edit" element={<EditTeam />} />
      <Route path="new" element={<NewTeamForm />} />
      <Route index element={<LeagueStandings />} />
    </Route>
    
    // åµŒå¥—é…ç½®
    <Route path="layout" element={<PageLayout />}>
      <Route path="privacy" element={<Privacy />} />
      <Route path="tos" element={<Tos />} />
    </Route>
  </Route>
</Routes>
```

### Navigating

URLå˜åŒ–çš„è¿™ä¸ªåŠ¨ä½œå«åšå¯¼èˆªï¼ˆnavigationï¼‰ï¼Œåœ¨React Routerä¸­æœ‰ä¸¤ç§æ–¹æ³•ï¼š

- `<Link>`
- `navigate`

#### Link

è·¯ç”±å¯¼èˆªçš„ä¸»è¦æ–¹å¼ã€‚å½“ç”¨æˆ·ç‚¹å‡»æ”¹æ ‡ç­¾æ—¶ä¾¿ä¼šè§¦å‘æ“ä½œã€‚React Routerä¼šé˜»æ­¢æµè§ˆå™¨é»˜è®¤çš„äº‹ä»¶è¡Œä¸ºï¼Œå¹¶ä¸”å‘historyå †æ ˆä¸­pushä¸€ä¸ªæ–°çš„çŠ¶æ€ã€‚ç»§è€Œè§¦å‘locationçš„å˜åŒ–å’Œè·¯ç”±åŒ¹é…å…ƒç´ çš„æ¸²æŸ“ã€‚

ç„¶è€Œï¼Œlinkæœ‰å±€é™æ€§ï¼š

- ä»ç„¶æ˜¯æ¸²æŸ“ä¸€ä¸ªaæ ‡ç­¾ï¼ˆå› æ­¤é”®ç›˜æ“ä½œ. å¯èšç„¦å’ŒSEOå¯ä»¥ä½¿ç”¨ï¼‰
- æ²¡æœ‰é˜»æ­¢æµè§ˆå™¨çš„é»˜è®¤è¡Œä¸ºï¼Œæ¯”å¦‚å³é”®ç‚¹å‡»æˆ–è€…æŒ‰ä½ctrlåæ–°å»ºä¸€ä¸ªtabé¡µç­¾ã€‚

åµŒå¥—è·¯ç”±ä¸ä»…ä»…æ˜¯æ¸²æŸ“å¸ƒå±€ï¼Œä»–ä¹Ÿèƒ½å¤„ç†ç›¸å¯¹è·¯ç”±ã€‚è¿˜æ‹¿ä¹‹å‰çš„ä¾‹å­ï¼š

```jsx
<Route path="teams" element={<Teams />}>
  <Route path=":teamId" element={<Team />} />
</Route>
```

åœ¨`<Teams>`ä¸­å¯ä»¥è¿™æ ·å†™ï¼š
```jsx
<Link to="psg" />
<Link to="new" />
```
ä»–ä»¬çš„è·¯å¾„å…¨ç¨‹æ˜¯`/teams/psg`Â å’ŒÂ `/teams/new`ï¼Œå¯ä»¥çœ‹åˆ°ä»–ä»¬ç»§æ‰¿äº†çˆ¶è·¯ç”±ä½œä¸ºå‰ç¼€ï¼Œå› æ­¤è·¯ç”±ç»„ä»¶ä¸éœ€è¦çœŸçš„çŸ¥é“å‰©ä½™çš„è·¯ç”±ä¿¡æ¯ã€‚å› æ­¤è·¯ç”±é…ç½®ä¼šéå¸¸çµæ´»ï¼Œå¯¹äºè¶Šæ¥è¶Šå¤æ‚çš„appï¼Œéœ€æ±‚å’Œè®¾è®¡éƒ½åœ¨ä¸åœçš„å˜åŒ–æ—¶ï¼Œè¿™ä¼šå¤§å¤§å‡å°‘å¼€å‘è€…çš„ç—›è‹¦ã€‚

#### Navigate Function

å¦ä¸€ç§æ–¹å¼ï¼Œå¿…é¡»åœ¨å‡½æ•°å¼ç»„ä»¶ï¼ˆRFCï¼‰ä¸­ä½¿ç”¨ï¼Œä½¿ç”¨`useNavigate`é’©å­è·å–navigateå‡½æ•°ï¼š
```jsx
let navigate = useNavigate();
useEffect(() => {
  setTimeout(() => {
    navigate("/logout");
  }, 30000);
}, []);
```

åœ¨formçš„æäº¤äº‹ä»¶ä¸­ä¹Ÿå¯ä»¥ä½¿ç”¨ï¼š

```jsx
<form onSubmit={event => {
  event.preventDefault();
  let data = new FormData(event.target)
  let urlEncoded = new URLSearchParams(data)
  navigate("/create", { state: urlEncoded })
}} />
```

ä»–å’Œlinkä¸­çš„toä½¿ç”¨æ–¹å¼æ˜¯ç±»ä¼¼çš„ã€‚ä½ å¯ä»¥ç”¨å®ƒæ›¿ä»£linkæ ‡ç­¾ï¼š

```jsx
<li onClick={() => navigate("/somewhere")} />
```

ä½†æ˜¯ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œé™¤äº†é“¾æ¥å’Œè¡¨å•ä»¥å¤–ï¼Œå¾ˆå°‘æœ‰äº¤äº’ä¼šæ”¹å˜URLï¼ˆ**è¯‘è€…è¯´**ï¼šæ”¾å±ï¼è·³ä¸è·³è½¬è¿˜ä¸æ˜¯è€æ¿ä¸€å¥è¯ï¼Ÿå›¾ç‰‡ï¼Œaudioï¼Œspanç­‰ç­‰ï¼Œåªè¦æ˜¯èƒ½æƒ³åˆ°çš„å…ƒç´ çš†å¯è·³è½¬ğŸ¶ ï¼‰ï¼Œå› ä¸ºä»–ä¼šå¢åŠ å¯è®¿é—®æ€§å’Œç”¨æˆ·äº¤äº’çš„å¤æ‚åº¦ã€‚

### Data Access

è·¯ç”±çš„æ•°æ®æ— éå°±æ˜¯å‚æ•°çš„è·å–ï¼Œå‚æ•°çš„ä¿®æ”¹ï¼Œå¦‚ä¸‹ä½¿ç”¨å³å¯ï¼š
```jsx
let location = useLocation();
let urlParams = useParams();
let [urlSearchParams, setUrlSearchParams] = useSearchParams();
```

### Review

æ€»ç»“ï¼

1. å†™ä¸€ä¸‹ä½ çš„Appï¼š

```jsx
const root = ReactDOM.createRoot(
  document.getElementById("root")
);
root.render(
  <BrowserRouter>
    <Routes>
      <Route path="/" element={<App />}>
        <Route index element={<Home />} />
        <Route path="teams" element={<Teams />}>
          <Route path=":teamId" element={<Team />} />
          <Route path="new" element={<NewTeamForm />} />
          <Route index element={<LeagueStandings />} />
        </Route>
      </Route>
      <Route element={<PageLayout />}>
        <Route path="/privacy" element={<Privacy />} />
        <Route path="/tos" element={<Tos />} />
      </Route>
      <Route path="contact-us" element={<Contact />} />
    </Routes>
  </BrowserRouter>
);
```

2. `<BrowserRouter>`åˆ›å»ºhistoryæ¨¡å¼çš„è·¯ç”±ï¼ˆåŸåœ°åˆ·æ–°é¡µé¢éœ€è¦åç«¯å¤„ç†è·³è½¬ï¼Œæˆ–è€…é…ç½®Nginxæ¥åˆ¤æ–­æ˜¯å¦éœ€è¦è¯·æ±‚åç«¯ï¼‰ï¼ŒpushçŠ¶æ€å€¼ï¼Œå¹¶ä¸”è®¢é˜…URLå˜åŒ–ã€‚

3. `<Routes>`å®¹çº³å­è·¯ç”±ï¼Œå¹¶ä¸”åˆ›å»ºè·¯ç”±é…ç½®å¯¹è±¡ï¼Œé€šè¿‡å½“å‰è·¯å¾„æ¥åŒ¹é…å…·ä½“çš„è·¯ç”±å¹¶åˆ›å»ºåŒ¹é…çš„å…ƒç´ æ ‘ï¼Œæœ€åæ¸²æŸ“æœ€ä¼˜çš„åŒ¹é…ã€‚

4. æ¯ä¸ªçˆ¶è·¯ç”±ä¸­åº”è¯¥æœ‰ä¸€ä¸ª`<Outlet />`

5. outletä¼šæ¸²æŸ“çˆ¶è·¯ç”±ä¸­åŒ¹é…åˆ°çš„ä¸‹ä¸€ä¸ªå­è·¯ç”±å…ƒç´ ã€‚

6. ç”¨æˆ·ç‚¹å‡»Linkè¿›è¡Œè·³è½¬ã€‚

7. ä¹Ÿå¯ä½¿ç”¨navigate()è¿›è¡Œè·³è½¬ã€‚

8. historyä¿®æ”¹URLåä¼šé€šçŸ¥`<BrowserRouter>`ã€‚

9. `<BrowserRouter>`æ”¶åˆ°é€šçŸ¥ï¼Œè§¦å‘åŒ¹é…å’Œæ¸²æŸ“ï¼Œé‡æ–°ä»ç¬¬2æ­¥å¼€å§‹ã€‚

That's all !

<hr />

æ–‡ç« è¾ƒé•¿ï¼Œç¿»è¯‘ä¸æ˜“ï¼Œéƒ½çœ‹åˆ°è¿™é‡Œäº†ï¼Œè¦ä¸ç‚¹ä¸ªèµå†èµ°å‘—ğŸ¶ ~~7c:T24e7,## 1. å‰è¨€

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ç»è¿‡å‰å‡ ç¯‡æ–‡ç« çš„è®²è¿°ï¼Œæˆ‘ä»¬çš„ç»„ä»¶åº“å·²ç»åˆå…·è§„æ¨¡ï¼š[æºç ](https://github.com/heiheihoho1213/dux-ui)ã€‚ç°åœ¨æˆ‘ä»¬è®²è¿°ä¸€ä¸‹å¦‚ä½•å‘å¸ƒåˆ°npmä¸Šï¼Œå¹¶ä¸”é…ç½®ä¸€ä¸‹gitee pages.

æœ¬æ–‡æœ€ç»ˆéƒ¨ç½²ä¸»é¡µæ•ˆæœï¼š[UIåº“ä¸»é¡µ](https://heiheihoho1213.github.io/dux-ui/)ã€‚

## 2. ä½¿ç”¨Webpackæ‰“åŒ…é™æ€æ–‡ä»¶


&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;é¦–å…ˆçœ‹ä¸€ä¸‹æˆ‘ä»¬é¡¹ç›®çš„ç›®å½•ç»“æ„ï¼š

![image.png](/img/posts/2022-5-22/2022-5-22-3.png)

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å¯ä»¥çœ‹åˆ°ï¼Œæœ¬ç»„ä»¶çš„é™æ€æ–‡ä»¶æ¯”è¾ƒå°‘ï¼Œä»…ä»…åœ¨staticä¸­æ”¾ç½®äº†Iconçš„å­—ä½“æ ·å¼æ–‡ä»¶ï¼Œæˆ‘ä»¬æƒ³æŠŠé™æ€æ–‡ä»¶è·Ÿæºç æ–‡ä»¶åˆ†å¼€æ”¾ç½®ï¼Œæ–¹ä¾¿ä»¥åè¿ç§»ï¼ŒåŒæ—¶ä¹Ÿæ–¹ä¾¿æ ·å¼çš„æŒ‰éœ€å¼•å…¥ã€‚æ‰€ä»¥æˆ‘ä»¬å°±å…ˆæ¥æ‰“åŒ…staticã€‚

### webpack.config.js

1. è®¾ç½®å…¥å£


```js
entry: {
    // webpackåªè´Ÿè´£icon/cssæ‰“åŒ…
    icon: path.resolve(__dirname, './static/style/icon.css'),
},
```

2. é…ç½®é™æ€èµ„æºå‡ºå£çš„è·¯å¾„

```js
 output: {
    // ä¸iconç›¸å…³çš„jsæ”¾åœ¨scripts
    filename: 'scripts/[name].[contenthash].min.js',
    // é™æ€èµ„æºï¼ˆå­—ä½“æ ·å¼æ–‡ä»¶ï¼‰æ”¾åœ¨assets
    assetModuleFilename: 'assets/[contenthash][ext]',
    // å‘å¸ƒçš„åŒ…å
    library: 'dux-ui',
    // ä½¿ç”¨umdæ¨¡å¼ï¼Œæé«˜å…¼å®¹æ€§
    libraryTarget: 'umd',
    // æ¯æ¬¡buildæ—¶æ¸…ç©ºoutputç›®å½•
    clean: true,
 },
```

3. é…ç½®æ’ä»¶ - å‹ç¼©css

```js
const cssPlugin = new MiniCssExtractPlugin({
  // cssæ”¾åœ¨stylesæ–‡ä»¶å¤¹ä¸‹
  filename: 'styles/[name].min.css',
});

...
plugins: [cssPlugin],
```

4. é…ç½®loaderå…¼å®¹csså’Œå­—ä½“æ–‡ä»¶ï¼ˆé‡è¦ï¼‰

```js
module: {
    rules: [
      {
        test: /static\/style\/icon\.css$/,
        use: [
          // 1. webpack5ä¸­, ä½¿ç”¨MiniCssExtractPlugin.loaderä»£æ›¿style-loader
          {
            loader: MiniCssExtractPlugin.loader,
          },
          'css-loader',
        ],
      },
      {
        // 2. webpack5 é…ç½® - è¯†åˆ«å­—ä½“æ–‡ä»¶
        test: /.(svg|eot|ttf|woff)$/,
        type: 'asset/resource',
      },
    ],
  },
```

5. é…ç½®æ‰“åŒ…çš„æ–‡ä»¶å¤¹æ ¹è·¯å¾„ä¸ºdistã€‚æ–°å»ºä¸€ä¸ª webpack.dist.config.jsï¼š


```js
const path = require('path');

const config = require('./webpack.config');

config.output.path = path.resolve(__dirname, 'dist');
```

è¿è¡Œè„šæœ¬ï¼š

`NODE_ENV=production npm run build:webpack -- --config webpack.dist.config.js`

æŸ¥çœ‹é¡¹ç›®è·¯å¾„ä¸Šå¤šå‡ºçš„æ–‡ä»¶ï¼š

![image.png](/img/posts/2022-5-22/2022-5-22-4.png)

æ‰“åŒ…æˆåŠŸï¼


## 4. ä½¿ç”¨Babelæ‰“åŒ…æºæ–‡ä»¶

### .babelrc.json


```json
{
  // import/export åŒ¹é…ä¸º scriptÂ , å…¶ä»–åŒ¹é…ä¸ºÂ module
  "sourceType": "unambiguous",
  "presets": [
    [
      // é¢„è®¾ï¼Œä»åå¾€å‰è¯†åˆ«
      "@babel/preset-env",
      {
        "targets": {
          "ie": "11",
          "firefox": "29",
          "chrome": "30",
          "safari": "7"
        },
        "spec": true,
        "loose": true
      }
    ],
    ["@babel/preset-react"],
    // è¯†åˆ«ts
    ["@babel/preset-typescript", { "allowDeclareFields": true }]
  ],
  "plugins": [
    [
      // è‡ªåŠ¨ç§»é™¤è¯­æ³•è½¬æ¢åå†…è”çš„è¾…åŠ©å‡½æ•° 
      "@babel/plugin-transform-runtime",
      {
        "regenerator": false
      }
    ],
    ["@babel/plugin-transform-typescript", { "allowDeclareFields": true }],
    // æ”¯æŒè£…é¥°å™¨è¯­æ³•
    ["@babel/plugin-proposal-decorators", { "legacy": true }],
    // ç¼–è¯‘ç±»å¼ç»„ä»¶ï¼Œä½¿ç”¨ç›´æ¥èµ‹å€¼æ–¹å¼
    ["@babel/plugin-proposal-class-properties", { "loose": true }],
    // è¯†åˆ«ç§æœ‰å˜é‡
    ["@babel/plugin-proposal-private-methods", { "loose": true }],
    "emotion",
    "lodash",
    ["babel-plugin-webpack-alias", { "config": "./webpack.config.js", "noOutputExtension": true }],
    // ä»TypeScriptç”ŸæˆReact interface æˆ– åˆ«å
    ["babel-plugin-typescript-to-proptypes"]
  ]
}

```

### package.json

é…ç½®åŒ…å…¥å£å’Œæ–‡ä»¶ï¼š
```json
"main": "lib/index.js",

...
"files": [
    "README.md",
    "index.d.ts",
    "dist/",
    "lib/"
],
```

è¿è¡Œè„šæœ¬ï¼Œæ‰“åŒ…æ‰€æœ‰srcä¸‹çš„æŒ‡å®šæ–‡ä»¶ï¼š
`babel src/ --extensions '.js,.jsx,.ts,.tsx' -d lib/ --ignore '**/.umi/*','**/__tests__/*'`

æŸ¥çœ‹æ‰“åŒ…ç›®å½•libï¼Œå·²ç»æœ‰äº†ç»“æœï¼š

![image.png](/img/posts/2022-5-22/2022-5-22-5.png)

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å¯ä»¥çœ‹åˆ°indexæ˜¯æœ‰é—®é¢˜çš„ã€‚ä»–è‡ªåŠ¨æŠŠ`src/index.ts`æ‰“åŒ…è¿›å»äº†ï¼Œè¿™ä¸ª`index.ts`æ˜¯`dumi`æ–‡æ¡£è‡ªåŠ¨ç”Ÿæˆçš„å…¥å£ã€‚è€Œå¾€å¾€æ–‡æ¡£å±•ç¤ºçš„ç»„ä»¶ä¸ç»„ä»¶åº“å®é™…æ‹¥æœ‰çš„ç»„ä»¶æ•°é‡æ˜¯ä¸ä¸€è‡´çš„ï¼Œæœ‰ä¸€äº›å¼€å‘ä¸­çš„é¡¹ç›®æ˜¯ä¸å±•ç¤ºåœ¨æ–‡æ¡£ä¸­çš„ï¼›åŒæ—¶ï¼Œå¦‚æœè°ƒæ•´äº†æ–‡æ¡£å±•ç¤ºçš„ç»„ä»¶ï¼Œåˆ™ä¼šé€ æˆæ‰“åŒ…çš„ç»„ä»¶æœ‰ç¼ºå¤±çš„é£é™©ã€‚æ‰€ä»¥è¿˜æ˜¯å†³å®šå•ç‹¬åœ¨ç”Ÿæˆä¸€æ¬¡libä¸‹çš„index.jsã€‚

### build-index.js

å†™ä¸€ä¸ªè„šæœ¬ç”Ÿæˆindex.jsï¼š
```js
const fs = require('fs');
const path = require('path');
const child_process = require('child_process');

let js = '';

// 1. è¯»å–æ‰€æœ‰æƒ³è¦ä»å¯¼å‡ºçš„ç»„ä»¶ï¼ˆè¿™é‡Œé»˜è®¤å…¨éƒ¨ï¼‰
const result = fs
  .readdirSync('./src/components/', {
    withFileTypes: true,
  })
  .filter((dir) => /^[A-Z]+[a-zA-Z]*$/.test(typeof dir === 'string' ? dir : dir.name));

/** 2. è¾“å‡ºjsæ ¼å¼
  * import * as InputAll from './components/Input/';
  *  const Input = Object.assign(InputAll.default, InputAll);
  *  export { Input };
 */
result.forEach((dir) => {
  if (typeof dir !== 'string') dir = dir.name;
  js += `
    import * as ${dir}All from './components/${dir}/';
    const ${dir} = Object.assign(${dir}All.default, ${dir}All);
    export { ${dir} };
    `;
});

// 3. å†™å…¥æ–‡ä»¶
fs.writeFileSync(path.join(__dirname, 'lib/__index.js'), js);

// 4. ä½¿ç”¨babelå†æ¬¡æ‰“ä¸€ä¸‹åŒ…
child_process.execSync('npx babel lib/__index.js --out-file lib/index.js');

```

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æ‰§è¡Œè„šæœ¬ `node build-index`å³å¯ã€‚è¿™æ ·ç”Ÿæˆçš„libæ–‡ä»¶å¤¹ä¸‹ä¼šå¤šä¸€ä¸ª`__index.js`æ–‡ä»¶ï¼Œä½†æ˜¯æ— ä¼¤å¤§é›…ï¼Œå¦‚æœè§‰å¾—ä¸å¤Ÿæ¸…çˆ½ï¼Œå¯ä»¥åŠ å…¥ä»¥ä¸‹åˆ é™¤ä»£ç ï¼š

```js
fs.unlink('lib/__index.js', () => {});
```

å¦‚æ­¤ï¼Œå†æ¬¡æ‰§è¡Œè„šæœ¬ï¼š

```js
babel src/ --extensions '.js,.jsx,.ts,.tsx' -d lib/ --ignore '**/.umi/*','**/__tests__/*' && node build-index.js
```
libæ–‡ä»¶ç”Ÿæˆå®Œæ¯•~


## 5. npmå‘å¸ƒ

1. [NPM](https://www.npmjs.com/)çš„ä½¿ç”¨ï¼Œéœ€è¦å…ˆæ³¨å†Œè´¦å·ï¼Œç„¶ååœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹æ‰§è¡Œ`npm login`:

![image.png](/img/posts/2022-5-22/2022-5-22-6.png)

æŒ‰ç…§å›¾ç¤ºè¾“å…¥é¡ºåºç™»å½•ï¼Œå°±ä¼šçœ‹åˆ°Logged inå­—æ ·ï¼Œè¯´æ˜ç™»å…¥æˆåŠŸï¼

2. ç”Ÿæˆå˜æ›´è®°å½•

- é¡¹ç›®ä¸­å®‰è£…standard-version / cz-conventional-changelogï¼š
`yarn add --dev standard-version cz-conventional-changelog`

- é…ç½®package.jsonä¸­çš„è„šæœ¬ï¼š`"commit": "cz"`


- commitä½ çš„æ‰€æœ‰æäº¤ã€‚

- ç„¶åæ‰“ç‰ˆæœ¬ï¼ˆæœ‰patch/minor/majorä¸‰ç§ç‰ˆæœ¬ç±»å‹ï¼‰ï¼š
`standard-version --release-as patch`

- æœ€åå‘å¸ƒ
`npm publish`

çœ‹åˆ°æœ€æ–°çš„ç‰ˆæœ¬å·ç”Ÿæˆå°±è¡¨ç¤ºå‘å¸ƒæˆåŠŸäº†ï¼š

![image.png](/img/posts/2022-5-22/2022-5-22-7.png)

æœ€åæ£€æŸ¥npmä¸ªäººä»“åº“ä¸»é¡µæ˜¯å¦æœ‰æ–°çš„ç‰ˆæœ¬ç”Ÿæˆï¼š

![image.png](/img/posts/2022-5-22/2022-5-22-8.png)

## 6. viteé¡¹ç›®ä½¿ç”¨
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æˆ‘ä»¬å¯ä»¥åœ¨viteé¡¹ç›®ä¸­æµ‹è¯•ä¸€ä¸‹æˆ‘ä»¬å‘å¸ƒçš„åŒ…èƒ½å¦ä½¿ç”¨ã€‚ä½¿ç”¨å¦‚ä¸‹é…ç½®çš„ä¾èµ–ç¯å¢ƒï¼š

```json
  "scripts": {
    "start": "vite",
    "build": "vite build",
    "preview": "vite preview"
  },
  "dependencies": {
    "dux-ui": "^1.3.4",
    "react": "^18.0.0",
    "react-dom": "^18.0.0"
  },
  "devDependencies": {
    "@types/react": "^18.0.0",
    "@types/react-dom": "^18.0.0",
    "@vitejs/plugin-react": "^1.3.0",
    "vite": "^2.9.9"
  }
```

æ‰§è¡Œ`yarn`å®‰è£…ä¾èµ–ã€‚

åœ¨`vite.config.js`ä¸­é…ç½®å¼•ç”¨è·¯å¾„ï¼š


```js
import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'

export default defineConfig({
  plugins: [react()],
  alias: [
    { find: 'dux-ui/dist/styles/icon.min.css', replacement: '/node_modules/dux-ui/dist/styles/icon.min.css' },
    { find: 'dux-ui', replacement: '/node_modules/dux-ui/lib/index.js' },
  ],
})
```

åœ¨App.jsxä¸­æµ‹è¯•ç»„ä»¶ï¼š

```jsx
...
<>
    <Icon type="loading" spin></Icon>
    {StyleTypes.map((type) => (
        <Button styleType={type} key={type} onClick={() => console.log('clicked')}>
          Button
        </Button>
    ))}
</>
```
å¯åŠ¨é¡¹ç›®åå¯ä»¥çœ‹åˆ°æ•ˆæœï¼š

![image.png](/img/posts/2022-5-22/2022-5-22-9.png)

## 7. Dumié¡¹ç›®Gitee Pagesé…ç½®

- é¦–å…ˆå®‰è£…ä¾èµ–ï¼š`yarn add --dev gh-pages`

- æ‰§è¡Œè„šæœ¬`dumi build`

- ç„¶åè¾“å‡ºåˆ°æƒ³è¦å¯¼å‡ºçš„æ–‡ä»¶å¤¹ï¼ˆä»¥docs-distä¸ºä¾‹ï¼‰ï¼š`gh-pages -d docs-dist`

è¿è¡ŒæˆåŠŸåï¼Œä¼šçœ‹åˆ°gitä»“åº“å¤šä¸€ä¸ªåˆ†æ”¯ï¼š

![image.png](/img/posts/2022-5-22/2022-5-22-10.png)

- åœ¨giteeä»“åº“é¡µé¢ï¼Œé€‰æ‹©å¯¹åº”çš„æœåŠ¡ï¼š

![image.png](/img/posts/2022-5-22/2022-5-22-11.png)

- é€‰æ‹©å¯¹åº”çš„åˆ†æ”¯ï¼Œå¹¶ä¸”éƒ¨ç½²å³å¯ï¼š

![image.png](/img/posts/2022-5-22/2022-5-22-12.png)

æ‰“å¼€ç”Ÿæˆçš„é“¾æ¥å³å¯çœ‹åˆ°éƒ¨ç½²çš„ä¸»é¡µã€‚å¦‚æœæ‰“å¼€åæç¤ºé™æ€èµ„æº404ï¼Œåˆ™éœ€è¦è¿›è¡Œå¦‚ä¸‹é…ç½®ï¼š

`.umirc.ts`

```js
  base: '/dux-ui-react/',
  publicPath: '/dux-ui-react/',
```
å†æ¬¡ä»ç¬¬äºŒæ­¥å¼€å§‹æ‰§è¡Œå³å¯ï¼


&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;è‡³æ­¤ï¼ŒåŸºäºReactçš„UIåº“çš„æ­å»º. éƒ¨ç½². åŸºç¡€ç»„ä»¶çš„å°è£…å·²ç»ç»“æŸã€‚åç»­æˆ‘ä¼šé€æ­¥å®Œå–„ç»„ä»¶åº“ï¼Œæ·»åŠ æ›´å¤šå¸¸ç”¨çš„ç»„ä»¶ï¼Œæ•¬è¯·æœŸå¾…~~7d:T31d5,## 1. å‰è¨€

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ç”±äºç–«æƒ…åŸå› ï¼Œè¢«å°é—­åœ¨å®¶ä¸­æ¯”è¾ƒçƒ¦èºï¼Œæ‹–äº†å¥½ä¹…æ‰å¼€å§‹ç»­å†™UIç¯‡çš„æ–‡ç« ï¼ŒæŠ±æ­‰ã€‚æœ¬ç¯‡æ˜¯Reactç»„ä»¶åº“çš„ç¬¬5ç¯‡æ–‡ç« ï¼Œæˆ‘ä»¬æ¥å®ç°ä¸€ä¸‹Formè¡¨å•çš„åŠŸèƒ½ã€‚æœ¬æ–‡çš„ä»£ç å±•ç¤ºçš„æ˜¯ä¸»è¦çš„æ ¸å¿ƒä»£ç ï¼Œå…¨éƒ¨ä»£ç è§ä»“åº“ï¼š[Giteeä»“åº“](https://gitee.com/dh1992/dux-ui-react/)ã€‚å¦ï¼Œæˆ‘å·²éƒ¨ç½²äº†æœ¬ç»„ä»¶åº“çš„æ–‡æ¡£åœ°å€ï¼Œè¿˜è¯·æ‰¹è¯„æŒ‡æ­£ï¼šhttps://dh1992.gitee.io/dux-ui-react


## 2. Input
   &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Inputä½œä¸ºæœ€åŸºæœ¬çš„HTMLè¡¨å•ç»„ä»¶ï¼Œè‚¯å®šæ˜¯ç»„ä»¶åº“ä¸­å¿…ä¸å¯å°‘çš„ä¸€ä¸ªç»„ä»¶ï¼ŒåŒæ—¶ä¹Ÿæ˜¯å®ç°èµ·æ¥ç›¸å¯¹ç®€å•çš„ï¼ŒH5æœ¬èº«å°±è‡ªå¸¦äº†`input`æ ‡ç­¾ï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨å…¶åŸºç¡€ä¸Šè‡ªå®šä¹‰è‡ªå·±çš„æ ·å¼ï¼Œå¹¶ä¸”å®ç°ä¸€äº›äº‹ä»¶ç›‘å¬å³å¯ã€‚
   
   &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æˆ‘ä»¬å…ˆç¡®å®šInputè¦æ¥å—çš„propsæœ‰å“ªäº›ã€‚é¦–å…ˆè¾“å…¥æ¡†è‚¯å®šè¦æœ‰å€¼ï¼Œè¿˜è¦èƒ½ç¦ç”¨å’Œæ¸…é™¤ï¼ŒåŒæ—¶å˜åŒ–è¿˜è¦æœ‰æ£€æµ‹äº‹ä»¶ï¼Œä¸»è¦çš„å‚æ•°æˆ‘ç½—åˆ—ä¸€ä¸‹ï¼š
   
| å±æ€§ | æè¿° |
| --- | --- |
| value | å—æ§å€¼ |
| prefix | å‰ç¼€ |
| suffix | åç¼€ |
| clearable | æ˜¯å¦å¯æ¸…ç©º |
| size | å°ºå¯¸ |
| disabled | æ˜¯å¦ç¦ç”¨ |
| onClear | æ¸…é™¤äº‹ä»¶ |
| onFocus | èšç„¦äº‹ä»¶ |
| onBlur | å¤±ç„¦äº‹ä»¶ |
| onChange | å˜åŒ–äº‹ä»¶ |


   æˆ‘ä»¬åœ¨`components`æ–‡ä»¶å¤¹ä¸‹ï¼Œæ–°å»º`Input`æ–‡ä»¶å¤¹ï¼Œå¹¶åœ¨å…¶ä¸‹æ–°å»º`index.tsx`æ–‡ä»¶ï¼š
   
   
```tsx
...
const Input = ({size, focused, disabled, customStyle, clearable, value}) => {
      
      return <SWrap
        {...{ size, focused, disabled, customStyle }}
        empty={!value}
      >
        <span className={inputWrapCls}>
          {renderPrefix}
          <input
            {...rest}
            value={value}
            onChange={onChange}
            ref={inputRef}
            onFocus={handleFocus}
            onBlur={handleBlur}
            disabled={disabled}
          />
          {renderClear}
          {renderSuffix}
        </span>
      </SWrap>
    );
}
```

 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æˆ‘ç”¨ä¸€ä¸ª`SWrap`ç»„ä»¶åŒ…è£¹äº†åŸç”Ÿçš„inpuæ ‡ç­¾ï¼Œæ¥å—ç”¨æˆ·ä¼ å…¥çš„propså±æ€§ã€‚çœ‹ä¸€ä¸‹SWrapæ˜¯æ€ä¹ˆå®ç°çš„ï¼Œä»ç„¶æ˜¯è¿”å›ä¸€ä¸ªstyleWrapå‡½æ•°ï¼Œå…·ä½“çš„csså®ç°å¯ä»¥çœ‹æˆ‘çš„æºç ï¼Œè¿™é‡Œä¸å¤šèµ˜è¿°ï¼š
 
```tsx
import styled from '@emotion/styled';
import { css } from '@emotion/core';

...
export const SWrap = styleWrap({})(
  styled.span((props) => {
    const {
      theme: { designTokens: DT },
      disabled,
      size,
      focused,
      clearable,
      customStyle,
    } = props;

    return css`
        /** csså®ç° */
        ...
    `
  })
);
```

æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹æ¯ä¸€ä¸ªå±æ€§éƒ½æ˜¯æ€ä¹ˆå®ç°å…¶ä»·å€¼çš„ï¼š

### 2.1 value/disabled/onChange
é€šè¿‡propså±æ€§ä¼ å…¥ä»¥åç›´æ¥èµ‹å€¼ç»™inputæ ‡ç­¾ï¼š`value={value}`

### 2.2 prefix/suffix
å‰åç¼€æˆ‘ä»¬é€šè¿‡`renderPrefix/renderSuffix`ç»„ä»¶å®ç°ï¼Œåˆ†åˆ«æ”¾åœ¨inputçš„å‰åï¼š


```tsx
// å¦‚æœç”¨æˆ·ä¼ å…¥äº†prefixï¼Œå°±è¿”å›ä¸€ä¸ªspanï¼ŒåŠ ä¸Šclassnameï¼Œå¹¶ç»™ä¸€ä¸ªonMouseDownçš„äº‹ä»¶ï¼Œå¦‚æœä¸éœ€è¦è¿™é‡Œä¹Ÿå¯ä»¥ä¸è¦äº‹ä»¶ã€‚åç¼€ä¹ŸåŒå‰ç¼€ä¸€æ ·ã€‚
const renderPrefix = useMemo(() => {
  return (
    prefix && (
      <span className={inputPrefixCls} onMouseDown={onMouseDown}>
        {prefix}
      </span>
    )
  );
}, [onMouseDown, prefix]);
```

### 2.3 clearable
clearableæ˜¯ç»„ä»¶è‡ªå®šä¹‰çš„å±æ€§ï¼ŒåŸç”Ÿinputæ²¡æœ‰è‡ªå¸¦çš„æ¸…é™¤æ“ä½œã€‚æˆ‘ä»¬é€šè¿‡åç¼€ç»„ä»¶å‰è¾¹çš„`renderClear`ç»„ä»¶å®ç°:


```tsx
// å…¶å®ä¸å‰åç¼€å®ç°æ–¹å¼ä¸€æ ·ï¼Œä¸åŒçš„æ˜¯contentæ˜¯å›ºå®šçš„ä¸€ä¸ªIconï¼Œå¹¶å¼ºåˆ¶èµ‹äºˆhandleClearäº‹ä»¶
const renderClear = useMemo(() => {
  if (clearable) {
    return (
      <span className={clearCls} onClick={handleClear} onMouseDown={onMouseDown}>
        <Icon type="remove_sign" />
      </span>
    );
  }
}, [clearable, handleClear, onMouseDown]);

// æ¸…é™¤valueäº‹ä»¶
const handleClear = useCallback(
  (e) => {
    if (disabled) return;
    onClear();
    const input = inputRef.current;
    if (!input) return;
    e.target = input;
    e.currentTarget = input;
    const cacheV = input.value;
    input.value = '';
    onChange(e);
    input.value = cacheV;
  },
  [disabled, onChange, onClear],
);
```
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æˆ‘ä»¬è®¾å®šçš„æ¸…é™¤äº‹ä»¶æ‰§è¡Œé¡ºåºæ˜¯å…ˆæ‰§è¡Œç”¨æˆ·ä¼ å…¥çš„`onClear`ï¼Œä¹‹åç¼“å­˜valueï¼Œç„¶åæ‹¿åˆ°Inputæ ‡ç­¾çš„refï¼Œè®¾ç½®å…¶valueæ˜¯ç©ºå­—ç¬¦ä¸²ï¼Œå¹¶å°†å½“å‰ç‚¹å‡»äº‹ä»¶çš„targetç»™Inputï¼Œè°ƒç”¨`onChange`è¿”ç»™ç”¨æˆ·ã€‚**æ³¨æ„æœ€åä¸€è¡Œ**ï¼Œè¦é‡æ–°æŠŠinputçš„valueèµ‹å€¼å›ç¼“å­˜çš„åŸå€¼ï¼Œå› ä¸ºè¿™é‡Œå¹¶æ²¡æœ‰ä»»ä½•setStateçš„æ“ä½œï¼Œä¸åº”è¯¥æ”¹å˜åŸæ¥çš„å€¼ã€‚ç”¨ä¸€ä¸ªonChangeäº‹ä»¶é—´éš”ä¸€ä¸‹ï¼Œvalueå€¼åœ¨ä¸€ä¸ªæ¸²æŸ“å‘¨æœŸå†…ä¸ä¼šæ¸²æŸ“ä¸¤æ¬¡ï¼Œæ‰€ä»¥å°±é€ æˆäº†è¢«æ¸…ç©ºçš„å‡è±¡ã€‚è‡³äºæ¸…ç©ºæ•°æ®çš„çœŸå®æ“ä½œï¼Œåº”è¯¥æ”¾åœ¨onChangeä¸­ã€‚
 
  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;è‡³æ­¤ï¼ŒInputç»„ä»¶çš„åŠŸèƒ½å®ç°å·²ç»ä»‹ç»å®Œæ¯•ã€‚ä»¥æ­¤ç±»æ¨ï¼Œæ•°å­—è¾“å…¥æ¡†`NumberInput`ï¼Œåªéœ€è¦åœ¨å·¦å³ä¸¤ä¾§ä¸ªåŠ ä¸€ä¸ªButtonæ¥æ§åˆ¶å¢å‡ï¼Œåœ¨`onBlur`äº‹ä»¶ä¸­éœ€è¦é€šè¿‡æ­£åˆ™æ ¡éªŒæ˜¯å¦ä¸ºåˆæ³•çš„æ•°å­—å³å¯ï¼›æ–‡æœ¬åŸŸ`Textarea`å®Œå…¨å¯ä»¥å‚ç…§Inputï¼Œå°†åŸç”Ÿæ ‡ç­¾æ¢æˆtextareaå³å¯ã€‚
  
## 3. Radio
  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;H5çš„inputæ ‡ç­¾è™½ç„¶æœ‰radioå±æ€§ï¼Œä½†æ˜¯ä¸€èˆ¬ç»„ä»¶åº“å°±ä¸å¤ªä¼šç›´æ¥ä½¿ç”¨äº†ï¼Œä¸€æ–¹é¢æ˜¯åŸç”Ÿçš„æ–¹æ³•å¾€å¾€ä¸èƒ½æ»¡è¶³ç»„ä»¶åº“çš„éœ€æ±‚ï¼Œå¦ä¸€æ–¹é¢ï¼Œä¸æƒ³åŸå§‹çš„Inputè¾“å…¥æ¡†ï¼ŒåŸç”Ÿæ ‡ç­¾ä¸èƒ½åšåˆ°ç»„ä»¶åº“éœ€è¦çš„æ ·å¼å®šåˆ¶å’Œä¸»é¢˜å®šåˆ¶ã€‚æ¯”å¦‚æˆ‘ä»¬è‡ªå®šä¹‰çš„radioç»„ä»¶ï¼Œå¯ä»¥æœ‰åŸç”Ÿæ ·å¼ï¼Œä¹Ÿå¯ä»¥æœ‰cardæ¨¡å¼ï¼Œè€Œä¸”radioå¾€å¾€éƒ½ä¸æ˜¯ä¸€ä¸ªå•ç‹¬å­˜åœ¨ï¼Œè‡³å°‘å¾—æœ‰ä¸¤ä¸ªæ‰èƒ½æ»¡è¶³è¦æ±‚ã€‚æˆ‘ä»¬å…ˆæ¥å®šä¹‰ä¸€ä¸‹`props`ï¼š
  
  | å±æ€§ | æè¿° |
| --- | --- |
| checked        | æ˜¯å¦é€‰ä¸­                                                        | 
| defaultChecked | é»˜è®¤æ˜¯å¦é€‰ä¸­                                                      | 
| disabled       | æ˜¯å¦ç¦ç”¨                                                        | 
| onChange       | ç‚¹é€‰æ—¶çš„å›è°ƒ                                                      | 
| value          | radioçš„å€¼                                                     | 
| styleType      | æ ·å¼é£æ ¼, å¯é€‰ 'default', 'button', 'tag', 'card', 'text', 'list' | 
| size           | å°ºå¯¸ï¼Œå¯é€‰'sm', 'md', 'lg'ï¼ŒstyleType ä¸º card. list æ—¶æ— æ•ˆ             | 
| title          | æ ‡é¢˜ï¼ŒstyleType ä¸º card æ—¶ä½¿ç”¨                                     | 

 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æ¥ä¸‹æ¥åœ¨`src/components`ä¸‹æ–°å»ºæ–‡ä»¶å¤¹`Radio`ï¼Œå¹¶åœ¨å…¶ä¸­æ–°å»º`index.tsx`ï¼š
 
 
```tsx
...
renderRadioList(props: any) {
    /* eslint-disable no-unused-vars */
    const {
      children,
      checked,
      onChange,
      onClick,
      disabled,
      ...rest
    } = props;
    /* eslint-enable no-unused-vars */

    return (
      <RadioListWrap
        checked={checked}
        disabled={disabled}
        {...rest}
        onClick={(...args: any) => this.onClick(props, { ...args })}
      >
        <RadioIcon checked={checked} disabled={disabled} />
        {children != null && <span className={contentCls}>{children}</span>}
      </RadioListWrap>
    );
}
```
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`RadioListWrap`ä»ç„¶æ˜¯ç”¨`styleWrap`åŒ…è£¹çš„åŒ…å«æ ·å¼çš„divï¼Œå†…å®¹ç‰©æˆ‘ä»¬æ”¾ä¸€ä¸ªå›¾æ ‡`RadioIcon`æ¥æ”¶æœ€é‡è¦çš„å±æ€§`checked`ï¼Œåè¾¹ç”¨ä¸€ä¸ªspanåŒ…è£¹ä¼ å…¥çš„childrenï¼Œä½¿ç”¨æ—¶å¯ä»¥è¿™æ ·å†™ï¼š
 
 ```tsx
 <Radio checked>checked</Radio>
 ```
 ç»„ä»¶`RadioIcon`å†…éƒ¨æ”¾ä¸€ä¸ªå®å¿ƒåœ†å½¢çš„Iconï¼Œ`SIconWrap`ä»ç„¶æ˜¯ä¸€ä¸ªdivï¼š
 
 
```tsx
const RadioIcon = (props: { checked?: boolean; disabled?: boolean }) => {
  return (
    <SIconWrap {...props}>
      <Icon className={iconCls} type="whitecircle" />
    </SIconWrap>
  );
};
```

åœ¨`SIconWrap`æ ·å¼å®šä¹‰é‡Œï¼Œé€šè¿‡åˆ¤æ–­æ˜¯å¦checkedæ¥æ§åˆ¶æ ·å¼é«˜äº®ï¼š


```tsx
${checked &&
  css`
    // checkedæ—¶ï¼ŒSIconWrapåŠ ä¸€ä¸ªä¸»é¢˜è‰²çš„è¾¹æ¡†
    &.${iconWrapCls} {
      color: ${DT.T_COLOR_LINE_PRIMARY_DEFAULT};
      border-color: ${DT.T_COLOR_LINE_PRIMARY_DEFAULT};
    }
    // checkedæ—¶ï¼ŒIconå­—ä½“åŠ ä¸Šä¸»é¢˜è‰²
    .${iconCls} {
      visibility: visible;
      opacity: 1;
      fill: ${DT.T_COLOR_TEXT_PRIMARY_DEFAULT};
    }
`}
```

åŸºæœ¬ç»“æ„è®²è§£å®Œäº†ï¼Œæˆ‘ä»¬æ¥çœ‹åŠ ä¸Šæ ·å¼ç¾åŒ–åçš„æ•ˆæœï¼š

![image.png](/img/posts/2022-5-22/2022-5-22-1.png)

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å¯ä»¥çœ‹åˆ°ï¼Œé™¤äº†æ¨¡æ‹ŸåŸç”Ÿæ ·å¼å¤–ï¼Œè¿˜å¯ä»¥æ¨¡æ‹ŸæŒ‰é’®. æ ‡ç­¾å’Œåˆ—è¡¨æ ·å¼ï¼Œå®ç°æ–¹å¼åŒä¸Šï¼Œåªéœ€è¦å°†`RadioWrap`å†…çš„Iconæ›¿æ¢æˆå…¶ä»–çš„ç»„ä»¶å³å¯ã€‚

>  è¡¨å•ç»„ä»¶æ¯”è¾ƒå¤šï¼Œè¿™é‡Œåªæ˜¯è®²è¿°äº†åŸºæœ¬çš„å‡ ä¸ªå®ç°ï¼Œä¸ºå†™è¡¨å•ç»„ä»¶æä¾›ä¸€ä¸ªæ€è·¯ï¼Œæ›´å¤šç»„ä»¶å¯ä»¥å‚è§[ç»„ä»¶åº“ä¸»é¡µ](https://dh1992.gitee.io/dux-ui-react/)


## 4. Form
  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;è®²å®ŒåŸºç¡€è¡¨å•ç»„ä»¶ï¼Œæˆ‘ä»¬å®ç°ä¸€ä¸‹è¡¨å•ç»„ä»¶çš„å¸ƒå±€ï¼Œå°±å«`Form`ã€‚H5åŸç”Ÿçš„ç»„ä»¶æ˜¯æœ‰formçš„ï¼Œæˆ‘ä»¬è¿™é‡Œéœ€è¦ç”¨åˆ°å…¶submitæ–¹æ³•ï¼Œæ‰€ä»¥å°±ä½¿ç”¨åŸç”Ÿçš„formï¼Œå¹¶å¯¹å…¶è¿›è¡Œæ ·å¼å°è£…ã€‚
  
  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;è¡¨å•å®¹å™¨ï¼Œå¿…é¡»æœ‰ä¸€ä¸ªæ ¹ç»„ä»¶Formï¼Œå†…éƒ¨æœ‰è‡³å°‘ä¸€ä¸ªformitemï¼Œæ¯ä¸€ä¸ªformitemå†…åŒ…å«ä¸€ä¸ªåŸºç¡€è¡¨å•è¾“å…¥ç»„ä»¶ï¼Œå®šä¹‰ä¸åŒçš„nameã€‚åœ¨`src/components`ä¸‹æ–°å»º`Form`æ–‡ä»¶å¤¹ï¼Œå¹¶åœ¨å…¶ä¸‹æ–°å»º`Form.tsx`,`Item.tsx`ã€‚å…ˆçœ‹`Form.tsx`ï¼š
  
  
```tsx
const Form = ({ onSubmit, ...rest }: any) => {
  const { preventFormDefaultAction } = useContext(ConfigContext);
  const handleSubmit = React.useCallback(
    (e) => {
      if (e) {
        e.preventDefault();
        e.stopPropagation();
      }
      onSubmit && onSubmit(e);
    },
    [onSubmit],
  );
  return (
      <FormWrap onSubmit={preventFormDefaultAction ? handleSubmit : onSubmit} {...rest} />
  );
};
```
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;è¡¨å•å®¹å™¨ï¼Œå¿…é¡»æœ‰ä¸€ä¸ªæ ¹ç»„ä»¶Formç”¨äºå®¹çº³æ‰€æœ‰çš„è¾“å…¥å…ƒç´ ï¼Œè§¦å‘åŸç”Ÿçš„submitäº‹ä»¶ï¼›å†…éƒ¨childrenæœ‰è‡³å°‘ä¸€ä¸ªformitemï¼Œæ¯ä¸€ä¸ªformitemå†…åŒ…å«ä¸€ä¸ªåŸºç¡€è¡¨å•è¾“å…¥ç»„ä»¶ï¼Œå®šä¹‰ä¸åŒçš„nameï¼Œformitemåº”è¯¥éµå¾ªå·¦å³å¸ƒå±€æ ¼å¼ï¼Œä½¿ç”¨floatæˆ–è€…flexéƒ½å¯ä»¥å®ç°ã€‚æˆ‘ä»¬çœ‹ä¼ å…¥çš„å‚æ•°`onSubmit`ï¼Œåœ¨ç»„ä»¶`FormWrap`çš„å›è°ƒonSubmitä¸­è°ƒç”¨ã€‚æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹`FormWrap`ï¼Œä»–è¿”å›çš„å°±æ˜¯ä¸€ä¸ªåŠ äº†æ ·å¼çš„åŸç”Ÿformæ ‡ç­¾ï¼š
  
  
```tsx
export const FormWrap = styleWrap<{ size: string }>({
  className: prefixCls,
})(
  styled('form')((props) => {

    return css`
      font-size: 12px;

      // ç»™ä¸‹å±çš„æ¯ä¸€ä¸ªitemåŠ æ ·å¼
      .${itemCls} {
        margin-bottom: 16px;
        &:last-child {
          margin-bottom: 0;
        }
      }
    `;
  }),
);

```

  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æˆ‘ä»¬å†æ¥çœ‹å†…å®¹ç‰©`Item.tsx`çš„å®ç°ï¼š
  
  
```tsx
...
return (
    <ItemWrap>
      <LabelWrap {...labelCol}>
        {label}
        {required && <RequiredLabel>*</RequiredLabel>}
        {help && <CommentWrap>{help}</CommentWrap>}
      </LabelWrap>
      <ControllerWrap {...controllerCol}>
        {children}
        <RenderTip tip={tip} status={status} />
      </ControllerWrap>
    </ItemWrap>
);
```
  
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`ItemWrap`ï¼Œ`LabelWrap`ï¼Œ`ControllerWrap`ï¼Œç”¨äºè¡¨å•æ¡ç›®å·¦å³å¸ƒå±€çš„å®ç°ï¼š
  
  ```tsx
// ItemWrap ä½¿ç”¨12æ …æ ¼å¸ƒå±€
export const ItemWrap = styleWrap<{ size: string }>({
  className: prefixCls,
})(
    styled('form')((props) => {

    return css`
      font-size: 12px;
      display: flex;

      // ç»™ä¸‹å±çš„æ¯ä¸€ä¸ªlabelåŠ æ ·å¼ï¼Œæ ·å¼ç±»åä»LabelWrapè·å–
     .${prefixCls} > .${itemLabelCls} {
        flex: ${props.labelCol.span || 6}
      }
      
      // ç»™ä¸‹å±çš„æ¯ä¸€ä¸ªcontrollerå—æ§åŒºåŸŸåŠ æ ·å¼ï¼Œæ ·å¼ç±»åä»ControllerWrapè·å–
     .${prefixCls} > .${itemControllerCls} {
        flex: ${props.controllerCol.span || 6}
      }
    `;
  }),
);

```
  
   &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æˆ‘ä»¬æ¥çœ‹çœ‹æ”¾ç»„ä»¶åçš„æ•ˆæœï¼ˆä¸»é¡µdemoï¼‰ï¼š
   
![image.png](/img/posts/2022-5-22/2022-5-22-2.png)



   &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æ€»ç»“ä¸€ä¸‹ï¼Œè¡¨å•ç»„ä»¶éœ€è¦æ”¾åœ¨åŸç”Ÿformæ ‡ç­¾å†…ï¼Œä½¿ç”¨æ …æ ¼å¸ƒå±€ï¼Œå·¦ä¾§æ”¾ç½®labelï¼Œå³ä¾§æ”¾ç½®å…·ä½“çš„è¾“å…¥ç»„ä»¶ï¼›æœ¬æ–‡ç« ä»‹ç»äº†Inputå’ŒRadioå¦‚ä½•æ¥å°è£…ï¼Œå…¶ä»–ç»„ä»¶ä¹Ÿéƒ½æ˜¯å¤§åŒå°å¼‚ï¼Œç”±äºç¯‡å¹…é™åˆ¶ï¼Œè¯»è€…å¯ä»¥å»ä¸»é¡µæŸ¥çœ‹æ•ˆæœæˆ–è€…è‡ªå·±å»npmå®‰è£…ä¸€ä¸‹å®æ–½æ•ˆæœï¼ˆç›¸å…³é…ç½®å¯æŸ¥çœ‹æºç READMEï¼‰ï¼š

```sh
npm install --save dux-ui
```7e:T2c69,å‰åç«¯åˆ†ç¦»çš„é¡¹ç›®ä¸­ï¼ŒAPIæ¥å£çš„è´¨é‡ä¼šç›´æ¥å½±å“å‰ç«¯é¡µé¢æ¸²æŸ“çš„é€»è¾‘ã€‚ä½œè€…ç»è¿‡å¤šå¹´çš„ä¸åç«¯å¼€å‘åŒå­¦. äº§å“çš„â€œç£¨åˆâ€ä¸­æ€»ç»“äº†ä¸€å¥—ç›¸å¯¹æ¥è¯´æ¯”è¾ƒå®Œæ•´çš„ï¼Œå¯¹äºå‰ç«¯æ¯”è¾ƒå‹å¥½çš„æ¥å£è§„èŒƒã€‚å…¶å®è¯´æ˜¯æ€¼åç«¯ï¼Œä½†æ¢ä¸ªè§’åº¦è®²ï¼Œä¹Ÿæ˜¯åœ¨å¸®åŠ©åç«¯è¿›æ­¥å˜›ï¼


## 0. è®¾è®¡è§„èŒƒåŸåˆ™

```
1.   å‰ç«¯åº”åªå…³æ³¨æ¸²æŸ“é€»è¾‘ï¼Œè€Œä¸åº”è¯¥å…³æ³¨æ•°æ®çš„å¤„ç†é€»è¾‘ã€‚æ¥å£è¿”å›çš„æ•°æ®åº”è¯¥æ˜¯èƒ½å¤Ÿç›´æ¥å±•ç¤ºåœ¨ç•Œé¢ä¸Šçš„ã€‚
2.   ä¸€ä¸ªåŠŸèƒ½åº”é¿å…å¤šä¸ªæ¥å£åµŒå¥—è°ƒç”¨è·å–æ•°æ®ï¼Œåå°åº”è¯¥å¤„ç†å¥½ä¸€æ¬¡æ€§è¿”å›ã€‚
3.   å“åº”æ ¼å¼åº”è¯¥æ˜¯JSONï¼Œè€Œä¸”åº”é¿å…å¤šçº§JSONçš„å‡ºç°ï¼›
4.   åç«¯å¦‚æœéœ€è¦ç•Œé¢å®æ—¶åˆ·æ–°æ•°æ®ï¼Œä¸åº”è¯¥è¦æ±‚å‰ç«¯å®šæ—¶å™¨è½®è¯¢ï¼Œè€Œè¦æä¾›ç±»ä¼¼webSocketä¹‹ç±»çš„åŠŸèƒ½ã€‚
```
æ ¹æ®è¿™ä¸ªåŸåˆ™ï¼Œåç«¯è¿”å›çš„æ•°æ®åº”è¯¥æ˜¯æ‰€è§å³æ‰€å¾—çš„æ•°æ®ï¼Œè€Œä¸åº”è¯¥æ˜¯ä¸€å±‚åŒ…ä¸€å±‚çš„å¤æ‚çš„JSONï¼Œéœ€è¦å‰ç«¯é¢å¤–æ¥å¤„ç†å¾ˆå¤æ‚çš„å»é‡ï¼Œæ’åº. æ·±æµ…æ‹·è´ï¼Œå˜å½¢ç­‰å¤„ç†ã€‚å‰ç«¯åœ¨æ¸²æŸ“æ¯ä¸€ä¸ªdivï¼Œæ¯ä¸€ä¸ªtableçš„cellæ—¶ï¼Œä¸ç”¨æ‹…å¿ƒæ•°æ®ç»“æ„ä¼šé¢‘ç¹æ›´æ”¹ä»è€Œå¯¼è‡´é¡µé¢å´©æºƒã€‚

## 1. æ¥å£åˆ¶å®šçš„å…¨æµç¨‹

å‰ç«¯è¯·æ±‚ä¸€èˆ¬æ˜¯`HTTP`åè®®ï¼Œè¿™é‡Œä»¥HTTPä¸ºä¾‹ã€‚

### HTTPè¯·æ±‚çš„åè®®ç±»å‹

åº”ä½¿ç”¨ä¸‹é¢ç½—åˆ—çš„HTTPæ–¹æ³•ï¼ˆä½¿ç”¨çš„SQLå…³é”®å­—ï¼‰:

- `GET`ï¼ˆSELECTï¼‰ï¼šä»æœåŠ¡å™¨å–å‡ºèµ„æºï¼Œä¸€é¡¹æˆ–å¤šé¡¹ã€‚
- `POST`ï¼ˆCREATEï¼‰ï¼šåœ¨æœåŠ¡å™¨æ–°å»ºä¸€ä¸ªèµ„æºã€‚
- `PUT`ï¼ˆUPDATEï¼‰ï¼šåœ¨æœåŠ¡å™¨æ›´æ–°èµ„æºï¼ˆå®¢æˆ·ç«¯æä¾›æ”¹å˜åçš„å®Œæ•´èµ„æºï¼‰ã€‚
- `PATCH`ï¼ˆUPDATEï¼‰ï¼šåœ¨æœåŠ¡å™¨æ›´æ–°èµ„æºï¼ˆå®¢æˆ·ç«¯æä¾›æ”¹å˜çš„å±æ€§ï¼‰ï¼Œä½¿ç”¨æ¯”è¾ƒå°‘
- `DELETE`ï¼ˆDELETEï¼‰ï¼šä»æœåŠ¡å™¨åˆ é™¤èµ„æºã€‚

ä¸‹é¢æ˜¯ä¸€äº›ä¾‹å­:

- `GET` /schoolsï¼šåˆ—å‡ºæ‰€æœ‰çš„å­¦æ ¡åˆ—è¡¨
- `POST` /schoolï¼šæ–°å»ºä¸€ä¸ªå­¦æ ¡
- `GET` /school/`{id}`ï¼šè·å–æŸä¸ªæŒ‡å®šå­¦æ ¡çš„ä¿¡æ¯
- `PUT` /school/`{id}`ï¼šæ›´æ–°æŸä¸ªæŒ‡å®šå­¦æ ¡çš„ä¿¡æ¯ï¼ˆæä¾›è¯¥å­¦æ ¡çš„å…¨éƒ¨ä¿¡æ¯ï¼Œè€Œä¸æ˜¯è®©å‰ç«¯å†é€šè¿‡åˆ«çš„æ¥å£è·å–ï¼‰
- `PATCH` /school/`{id}`ï¼šæ›´æ–°æŸä¸ªæŒ‡å®šå­¦æ ¡çš„ä¿¡æ¯ï¼ˆæä¾›è¯¥å­¦æ ¡çš„éƒ¨åˆ†ä¿¡æ¯ï¼‰
- `DELETE` /school/`{id}`ï¼šåˆ é™¤æŸä¸ªå­¦æ ¡

### HTTPè¯·æ±‚çš„å‚æ•°å®šä¹‰

ä¸åŒ`HTTP`æ–¹æ³•å¯¹åº”ä¸åŒçš„å‚æ•°ä¼ é€’æ–¹å¼ï¼Œå¦‚ä¸‹ï¼š

> queryæŒ‡è·¯å¾„ä¼ å‚ï¼ŒbodyæŒ‡requestBodyè¯·æ±‚ä½“

- `GET`ï¼špath & query
- `POST`ï¼špath & body
- `PUT`ï¼špath & query & body
- `PATCH`ï¼špath & query & body
- `DELETE`ï¼špath & query

æ³¨æ„ï¼š

```
1. æœªå‡ºç°åœ¨ä¸Šè¡¨ä¸­çš„ä½ç½®ä¸å¯æ”¾ç½®å‚æ•°ï¼Œå¦‚GETæ–¹æ³•ä¸å¯åœ¨bodyä¸­æ”¾ç½®å‚æ•°ã€‚
2. å‚æ•°å‘½åå‡éµå¾ªå°é©¼å³°å‘½åæ³•ã€‚
3. pathå’Œqueryä¸­ä¼ é€’çš„å‚æ•°éœ€ç¡®ä¿é•¿åº¦å¯æ§ï¼Œè¶…è¿‡2000å­—ç¬¦ï¼ˆå› æµè§ˆå™¨è€Œå¼‚ï¼‰çš„å‚æ•°å¯å¯¼è‡´è¯·æ±‚å¤±è´¥ã€‚å½“è¯·æ±‚æ— æ³•ä¿è¯å‚æ•°é•¿åº¦å¯æ§ï¼Œåˆ™ä¸èƒ½å°†å‚æ•°æ”¾åœ¨pathæˆ–queryä¸­ï¼Œå¿…é¡»ä½¿ç”¨æ”¯æŒbodyå‚æ•°çš„HTTPæ–¹æ³•ï¼Œå¦‚POSTã€‚
4. pathå’Œqueryä¸­ä¼ é€’çš„å‚æ•°éœ€æ˜¯åŸºæœ¬ç±»å‹ï¼Œäº¦ä¸å¯ä¼ é€’åºåˆ—åŒ–ä¹‹åçš„JSONå¯¹è±¡ï¼ä¸ç„¶å‰ç«¯å°±è¦try/catchä¸€ä¸‹æ¥parseäº†ã€‚
5. bodyä¸­çš„å‚æ•°éœ€æ˜¯åˆæ³•JSONå¯¹è±¡æˆ–è€…formDataï¼Œå³ä½¿å‚æ•°ä»…åŒ…å«å•å­—æ®µæˆ–å•æ•°ç»„ï¼Œä¹Ÿéœ€åŒ…å«åœ¨å¯¹è±¡ä¸­ï¼Œå¦‚ï¼š
{
Â  name: string;
}
```


### HTTPå“åº”ç»“æœå®šä¹‰

é’ˆå¯¹ä¸åŒæ“ä½œï¼ŒæœåŠ¡å™¨å‘ç”¨æˆ·è¿”å›çš„ç»“æœåº”è¯¥ç¬¦åˆä»¥ä¸‹è§„èŒƒã€‚

<Row>
  <Col>
    - `GET` /collectionsï¼šè¿”å›èµ„æºå¯¹è±¡çš„åˆ—è¡¨ï¼ˆæ•°ç»„ï¼‰
  </Col>
  <Col sticky>
    ```js {{ title: 'Response' }}
    {
        RetCode: 0,
        Message: 'ok',
        Action: 'collections',
        Data: [
            {
                Id: 1,
                name: 'collection1',
                ...
            },
            ...
        ]
    }
    ```
  </Col>
</Row>
---
<Row>
  <Col>
    - `GET` /collection/resourceï¼šè¿”å›å•ä¸ªèµ„æºå¯¹è±¡
  </Col>
  <Col sticky>
    ```js {{ title: 'Response' }}
    {
        RetCode: 0,
        Message: 'ok',
        Action: 'collectionResource',
        Data: {
            Id: 1,
            name: 'collection1',
            ...
        }
    }
    ```
  </Col>
</Row>
---
<Row>
  <Col>
    - `POST` /collectionï¼šè¿”å›æ–°ç”Ÿæˆçš„èµ„æºå¯¹è±¡
  </Col>
  <Col sticky>
    ```js {{ title: 'Response' }}
      {
          RetCode: 0,
          Message: 'ok',
          Action: 'collection',
          Data: {
              Id: 1,
              name: 'collection1',
              ...
          }
      }
    ```
  </Col>
</Row>

- `PUT` /collection/resourceï¼šè¿”å›å®Œæ•´çš„èµ„æºå¯¹è±¡ï¼Œ è¿”å›ç»“æœåŒä¸Šã€‚
- `PATCH` /collection/resourceï¼šè¿”å›å®Œæ•´çš„èµ„æºå¯¹è±¡ï¼Œè¿”å›ç»“æœåŒä¸Šã€‚

<Row>
  <Col>
    - `DELETE` /collection/resourceï¼šè¿”å›ä¸€ä¸ªç©ºæ–‡æ¡£
  </Col>
  <Col sticky>
    ```js {{ title: 'Response' }}
      {
          RetCode: 0,
          Message: 'ok',
          Action: 'collectionResource',
          Data: {}
      }
    ```
  </Col>
</Row>

æ³¨æ„ï¼š


1. æ‰€æœ‰è¿”å›æ•°æ®éœ€æ˜¯åˆæ³•JSONï¼Œå°½é‡è¿”å›objectæˆ–è€…array (äºŒè¿›åˆ¶æ–‡ä»¶ä¸‹è½½é™¤å¤–)ã€‚å¦‚æœæ•°æ®ä¸­åŒ…å«ç±»å‹ä¸ºarrayçš„å±æ€§ï¼Œå½“æ•°æ®ä¸ºç©ºæ—¶ï¼Œå°½é‡è¿”å›ç©ºæ•°ç»„[]ï¼Œé¿å…è¿”å›nullã€‚
2. è¿”å›æ•°æ®é¿å…ä½¿ç”¨mapçš„`<'key', 'value'>`å½¢å¼ï¼å¦‚æœ‰ç›¸å…³æ ¼å¼çš„è¿”å›æ•°æ®ï¼Œè¯·è½¬æ¢ä¸ºarrayã€‚
3. å¦‚æœæ²¡æœ‰æ•°æ®éœ€è¦è¿”å›ï¼Œæˆ–ç³»ç»ŸæŠ¥é”™æ—¶ï¼Œå¯ç»Ÿä¸€è¿”å›å›ºå®šå­—æ®µï¼š

```ts
{
  RetCode: number, // åç«¯çŠ¶æ€ç 
  Message: string, // è¯·æ±‚è¿”å›æ¶ˆæ¯
  Action: string, // è¯·æ±‚çš„å“åº”å…³é”®å­—
  Data: Object | Array // å“åº”æ•°æ®
}
```

4. è¿”å›å€¼ä¸­åº”å°½é‡é¿å…åŒ…å«æ— ç”¨ä¿¡æ¯ï¼Œæˆ–è€…é¢å¤–çš„æ•°æ®ç»“æ„ï¼Œä»…åŒ…å«å¿…è¦æ•°æ®å³å¯ã€‚å¿…è¦æ•°æ®æŒ‡å‰ç«¯éœ€è¦æ¸²æŸ“çš„æ•°æ®ã€‚
5. åç«¯å¼‚å¸¸æŠ¥é”™å‡ä»¥'500'çŠ¶æ€ç çš„å½¢å¼è¿”å›ï¼Œä¹Ÿå¯é€‚å½“æ·»åŠ é¢å¤–ä¿¡æ¯ï¼Œéç‰¹æ®Šæƒ…å†µæ— éœ€åœ¨è¿”å›çš„æ•°æ®ä½“ä¸­è¿”å›HTTP codeã€‚


### URLè§„èŒƒ

å¯å‚ç…§ä¸‹é¢çš„èŒƒä¾‹ï¼š
`GET [http | https]://host:port/studio/api/ç»„ä»¶å/v1/æ¨¡å—å/èœå•å/æ¥å£å/:param`

æ³¨æ„ï¼š
```
1. ä¸ç”¨å¤§å†™å­—æ¯ï¼Œå»ºè®®ç”¨ä¸­æ  - ä¸ç”¨ä¸‹æ  _. æ¯”å¦‚é‚€è¯·ç å†™æˆinvitation-codeè€Œä¸æ˜¯invitation_code
2. ä½¿ç”¨åè¯è¡¨ç¤ºèµ„æºé›†åˆï¼Œä½¿ç”¨å¤æ•°å½¢å¼ï¼ˆä¸ºç¡®ä¿æ‰€æœ‰API URIsä¿æŒä¸€è‡´ï¼‰ï¼Œä¸èƒ½ä½¿ç”¨åŠ¨è¯ï¼›
3. æ¯ä¸ªèµ„æºéƒ½è‡³å°‘æœ‰ä¸€ä¸ªæ ‡è¯†å®ƒçš„URIï¼ŒåŒæ—¶åº”è¯¥éµå¾ªä¸€ä¸ªå¯é¢„æµ‹çš„å±‚æ¬¡ç»“æ„æ¥æé«˜å¯ç†è§£æ€§ï¼Œä»è€Œæé«˜å¯ç”¨æ€§ï¼›
4. å®¾è¯­å¿…é¡»æ˜¯åè¯ã€‚ç½‘å€ä¸­ä¸èƒ½æœ‰åŠ¨è¯ï¼Œåªèƒ½æœ‰åè¯ï¼ŒAPIä¸­çš„åè¯ä¹Ÿåº”è¯¥ä½¿ç”¨å¤æ•°ï¼Œå®¾è¯­å°±æ˜¯APIçš„URLï¼Œæ˜¯HTTPåŠ¨è¯ä½œç”¨çš„å¯¹è±¡ã€‚å®ƒåº”è¯¥æ˜¯åè¯ï¼Œä¸èƒ½æ˜¯åŠ¨è¯
```
æ­£ğŸŒ° ï¼š

- `GET` /classesï¼šåˆ—å‡ºæ‰€æœ‰ç­çº§
- `POST` /classesï¼šæ–°å»ºä¸€ä¸ªç­çº§
- `GET` /classes/`{classId}`ï¼šè·å–æŸä¸ªæŒ‡å®šç­çº§çš„ä¿¡æ¯
- `PUT` /classes/`{classId}`ï¼šæ›´æ–°æŸä¸ªæŒ‡å®šç­çº§çš„ä¿¡æ¯ï¼ˆä¸€èˆ¬å€¾å‘æ•´ä½“æ›´æ–°ï¼‰
- `PATCH` /classes/`{classId}`ï¼šæ›´æ–°æŸä¸ªæŒ‡å®šç­çº§çš„ä¿¡æ¯ï¼ˆä¸€èˆ¬å€¾å‘éƒ¨åˆ†æ›´æ–°ï¼‰
- `DELETE` /classes/`{classId}`ï¼šåˆ é™¤æŸä¸ªç­çº§
- `GET` /classes/`{classId}`/teachersï¼šåˆ—å‡ºæŸä¸ªæŒ‡å®šç­çº§çš„æ‰€æœ‰è€å¸ˆçš„ä¿¡æ¯
- `GET` /classes/`{classId}`/studentsï¼šåˆ—å‡ºæŸä¸ªæŒ‡å®šç­çº§çš„æ‰€æœ‰å­¦ç”Ÿçš„ä¿¡æ¯
- `DELETE` classes/`{classId}`/teachers/`{teacherId}`ï¼šåˆ é™¤æŸä¸ªæŒ‡å®šç­çº§ä¸‹çš„æŒ‡å®šçš„è€å¸ˆçš„ä¿¡æ¯

åä¾‹ï¼š
- /getAllclasses
- /createNewclass
- /deleteAllActiveclasses

> **å¤æ•°è¿˜æ˜¯å•æ•°URLé—®é¢˜**ï¼š æ—¢ç„¶ URL æ˜¯åè¯ï¼Œé‚£ä¹ˆåº”è¯¥ä½¿ç”¨å¤æ•°ï¼Œè¿˜æ˜¯å•æ•°ï¼Ÿè¿™æ²¡æœ‰ç»Ÿä¸€çš„è§„å®šï¼Œä½†æ˜¯å¸¸è§çš„æ“ä½œæ˜¯è¯»å–ä¸€ä¸ªé›†åˆï¼Œæ¯”å¦‚GET /articlesï¼ˆè¯»å–æ‰€æœ‰æ–‡ç« ï¼‰ï¼Œè¿™é‡Œæ˜æ˜¾åº”è¯¥æ˜¯å¤æ•°ï¼Œè€Œè·å–å•ä¸ªå¯ä»¥ç”¨GET /article/2ã€‚ å½“ç„¶ï¼Œä½ å¯ä»¥ä¸ºäº†ç»Ÿä¸€èµ·è§ï¼Œéƒ½ä½¿ç”¨å¤æ•°URLï¼Œæ¯”å¦‚GET /articles/2ã€‚

å¤šçº§URLçš„å¤„ç†ï¼šå½“æŸ¥è¯¢èµ„æºä¿¡æ¯è¾ƒå¤šæ—¶ï¼Œå¾€å¾€ä¼šæœ‰å¤šçº§å‚æ•°å‡ºç°åœ¨URLä¸­ï¼Œæ­¤å¤„è¦åˆ†ä¸‰ç§æƒ…å†µè®¨è®ºï¼š

1. æŸ¥è¯¢ä¿¡æ¯æŒ‡ä»£å½“å±‚å”¯ä¸€idï¼Œå°†æŸ¥è¯¢ä¿¡æ¯æ”¾åœ¨pathä¸­ï¼Œæ„å»ºå”¯ä¸€çš„æŸ¥è¯¢è·¯å¾„ï¼Œå¦‚ï¼š
`> GET /authors/12/categories/2`

2. æŸ¥è¯¢ä¿¡æ¯å±äºå¯¹å½“å±‚ä¿¡æ¯çš„çŠ¶æ€è¿‡æ»¤ï¼Œå°†æŸ¥è¯¢ä¿¡æ¯æ”¾åœ¨queryä¸­ï¼Œå¦‚ï¼š
`> GET /articles?published=true`

3. æŸ¥è¯¢ä¿¡æ¯æ—¢åŒ…å«å½“å±‚idï¼Œä¹ŸåŒ…å«è¿‡æ»¤ä¿¡æ¯ï¼Œåˆ†åˆ«å°†idå’Œè¿‡æ»¤ä¿¡æ¯æ”¾åœ¨pathå’Œqueryä¸­ï¼Œå¦‚ï¼š
`> GET /authors/12/categories/2?published=true`


### HTTPçŠ¶æ€ç çº¦æŸ

å®¢æˆ·ç«¯çš„æ¯ä¸€æ¬¡è¯·æ±‚ï¼ŒæœåŠ¡å™¨éƒ½å¿…é¡»ç»™å‡ºå›åº”ã€‚å›åº”åŒ…æ‹¬ HTTP çŠ¶æ€ç å’Œæ•°æ®ä¸¤éƒ¨åˆ†ã€‚HTTP çŠ¶æ€ç å°±æ˜¯ä¸€ä¸ªä¸‰ä½æ•°ï¼Œåˆ†æˆäº”ä¸ªç±»åˆ«ã€‚

```
- 1xxï¼šç›¸å…³ä¿¡æ¯
- 2xxï¼šæ“ä½œæˆåŠŸ
- 3xxï¼šé‡å®šå‘
- 4xxï¼šå®¢æˆ·ç«¯é”™è¯¯
- 5xxï¼šæœåŠ¡å™¨é”™è¯¯
```
çŠ¶æ€ç è§„èŒƒè§[W3Cå…³äºHTTPçŠ¶æ€ç å®šä¹‰](https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html)

### åˆ†é¡µä¸æœç´¢æ¥å£çº¦æŸ

åˆ†é¡µæ¥å£å¹¿æ³›å‡ºç°åœ¨æ•°æ®é‡è¾ƒå¤§åœºæ™¯ä¸‹çš„è¡¨æ ¼å‹äº¤äº’ã€‚å³ä½¿æ˜¯æ¸²æŸ“ç®€å•çš„åˆ—è¡¨å…ƒç´ ï¼Œè¶…è¿‡500é¡¹æœ‰å¯èƒ½å¯¼è‡´å‰ç«¯å¡é¡¿ï¼Œè¶…è¿‡5000é¡¹ä»¥ä¸Šï¼ˆä¸åŒæµè§ˆå™¨. ç”µè„‘é…ç½®ä¼šå½±å“è¿™ä¸ªæ•°å­—ï¼‰æœ‰å¯èƒ½å¯¼è‡´å‰ç«¯å´©æºƒã€‚å‡¡æ— æ³•ä¿è¯èƒ½é™åˆ¶æ¥å£è¿”å›æ•°é‡åœ¨ä¸€ä¸ªè¾ƒå°æ•°é‡çº§ï¼ˆ100ä»¥ä¸‹ï¼‰çš„æ¥å£éƒ½éœ€è¦è€ƒè™‘æ”¯æŒåç«¯åˆ†é¡µï¼›å¦‚æœè¿”å›ç»“æœæ•°é‡æ˜¯ä¸å—æ§åˆ¶çš„ï¼ˆå¦‚åŒ…å«ç”¨æˆ·ç”Ÿæˆæ•°æ®ï¼‰ï¼Œåˆ™`å¿…é¡»æ”¯æŒ`åç«¯åˆ†é¡µã€‚
<br />

è¿™é‡Œç»™å‡ºè¯·æ±‚èŒƒä¾‹ï¼š

GET æ¥å£

`?page={page}&size={size}`

POST æ¥å£

```js
// æ ¼å¼1
{
    page: number;
    size: number;
    total: number; // æ•°æ®æ€»é‡
}

// æ ¼å¼2
{
    Limit: number;
    Offset: number
    Total: number; // æ•°æ®æ€»é‡
}

// å…¶ä¸­pageä¸ºå½“å‰è¯·æ±‚é¡µï¼Œä¸ºä»0å¼€å§‹çš„æ­£æ•´æ•°ï¼›
// sizeä¸ºå½“å‰é¡µå¤§å°ï¼Œå¸¸ç”¨çš„å€¼æœ‰10. 20ç­‰ï¼Œç†è®ºä¸Šéœ€æ”¯æŒä»»æ„æ­£æ•´æ•°ã€‚ç‰¹æ®Šçš„ï¼Œè‹¥ä¸º-1ï¼Œå¯ä»¥çº¦å®šä¸ºæŸ¥è¯¢å…¨éƒ¨
// LimitåŒsize
// Offsetä¸ºç›¸å¯¹åç§»é‡ï¼Œä¸ºä»0å¼€å§‹çš„æ­£æ•´æ•°
```


éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœäº¤äº’ä¸­å‡ºç°è¿‡æ»¤. æ’åºåŠŸèƒ½ï¼Œåˆ™ç›¸å…³åŠŸèƒ½å¿…è¦æ—¶éƒ½éœ€è¦åç«¯æ”¯æŒã€‚å¦‚æœå‚æ•°èƒ½ä¿è¯ä¸è¶…è¿‡ä¸€å®šé•¿åº¦ï¼Œåˆ™å‚æ•°æ”¾åœ¨queryé‡Œä¹Ÿæ˜¯å¯ä»¥æ¥å—çš„ã€‚æ•°ç»„å‹å‚æ•°å¯ä»¥ä»¥ç›¸å…³å­—æ®µç”¨é€—å·è¿æ¥çš„å½¢å¼ä¼ é€’ï¼Œå¦‚ï¼š

```
?status=RUNNING,COMPLETE,ERROR
```

> ç‰¹æ®Šç±»å‹å¤„ç†
> 1. å…³äºBooleanç±»å‹ï¼ŒJSONæ•°æ®ä¼ è¾“ä¸­ä½¿ç”¨true/falseå­—æ®µè¿›è¡Œä¼ é€’ã€‚
> 2. å…³äºæ—¥æœŸç±»å‹ï¼ŒJSONæ•°æ®ä¼ è¾“ä¸­ä¸€å¾‹ä½¿ç”¨é•¿æ•´å½¢æ—¶é—´æˆ³ï¼ˆUnix timeï¼‰è¿›è¡Œä¼ é€’ï¼Œå…·ä½“æ—¥æœŸæ˜¾ç¤ºæ ¼å¼ç”±å‰ç«¯å¤„ç†ã€‚



## 2. æ³¨æ„äº‹é¡¹

ä»»ä½•å½¢å¼çš„æ¥å£å˜æ›´éƒ½ä¼šå¯¹å‰ç«¯äº§ç”Ÿå½±å“ï¼Œæ¯”å¦‚å­—æ®µåç§°çš„ä¿®æ”¹ï¼Œå­—æ®µçš„å¢å‡ï¼Œå­—æ®µç±»å‹çš„ä¿®æ”¹ï¼Œè¯·æ±‚å‚æ•°ç±»å‹çš„å˜åŠ¨ç­‰ã€‚åŸåˆ™ä¸Šå½“æ¥å£å¯¹æ¥å®Œæˆåä¸åº”æœ‰ä»»ä½•å½¢å¼çš„ä¿®æ”¹ï¼Œå¦‚æœä¸€å®šè¦å˜æ›´æ¥å£ï¼Œéœ€åŠæ—¶é€šçŸ¥ç›¸åº”å‰ç«¯å¼€å‘äººå‘˜å¹¶é‡æ–°å¯¹æ¥ã€‚

è¡¨ç¤ºåŒä¸€å«ä¹‰çš„å­—æ®µåœ¨åŒä¸€å¥—åŠŸèƒ½æ¥å£é›†åˆï¼ˆå¢åˆ æ”¹æŸ¥ï¼‰ä¸­åº”å°½é‡ä¿è¯ç›¸åŒã€‚åœ¨æ¥å£è®¾è®¡ä¸­ï¼Œå¯¹åŒä¸€å®ä½“è¿›è¡Œæ“ä½œçš„æ¥å£åº”å°½é‡ä¿è¯åœ¨å‚æ•°å’Œè¿”å›å€¼ä¸­ï¼Œè¯¥å®ä½“çš„æ•°æ®ç»“æ„ä¿æŒä¸€è‡´ï¼Œå°½é‡é¿å…å‰ç«¯åšæ•°æ®å¯¹è±¡è½¬æ¢çš„åŠ¨ä½œã€‚


## 3. å‚è€ƒ

[é˜®ä¸€å³° RESTful API è®¾è®¡æŒ‡å—](https://www.ruanyifeng.com/blog/2014/05/restful_api.html)

[Representational state transfer](https://en.wikipedia.org/wiki/Representational_state_transfer)

[Hypertext Transfer Protocol](https://en.wikipedia.org/wiki/Hypertext_Transfer_Protocol#Request_methods)

```
çµæ„Ÿæ¥æº - Transwarpé€šç”¨æŠ€æœ¯ç»„å‰ç«¯å›¢é˜Ÿjiraæ–‡æ¡£ - å‰åç«¯æ¥å£è§„èŒƒ
```7f:T2d3f,> ä¸“æ è¯´æ˜ï¼šå¯¹äºreact-router v6ç‰ˆæœ¬ï¼Œæœ‰åŒäº‹ååº”ç¼ºå°‘ç›¸å¯¹å®Œæ•´çš„ä¸­æ–‡æ–‡æ¡£ï¼ŒæŸ¥çœ‹ä¸æ–¹ä¾¿ã€‚ä¸ºäº†ä¾¿äºä½¿ç”¨ï¼Œä½œè€…å¯¹[å®˜ç½‘æ–‡æ¡£](https://reactrouter.com/docs/en/v6)è¿›è¡Œé’ˆå¯¹æ€§ç¿»è¯‘ï¼Œä¾¿äºv6ç‰ˆæœ¬æ›´å¹¿æ³›çš„è¢«ä½¿ç”¨ã€‚

ä¸Šä¸€ç¯‡ï¼š[# React Router v6 å®˜æ–¹æ–‡æ¡£ç¿»è¯‘ ï¼ˆä¸€ï¼‰ ---- Installation && Quick Start](https://juejin.cn/post/7100479939694034952)

## 1. é—®ç­”ç¯èŠ‚

> åŸæ–‡è·¯å¾„ï¼šhttps://reactrouter.com/docs/en/v6/getting-started/faq#faqs

ä¸‹é¢æ˜¯å¤§å®¶åœ¨ä½¿ç”¨`React Router v6`æ—¶ç»å¸¸é—®åˆ°çš„é—®é¢˜ã€‚

### 1. å½“æˆ‘ç”¨çš„æ˜¯ç±»å¼ç»„ä»¶ï¼Œåˆå¿…é¡»ä½¿ç”¨Routeræ—¶ï¼Œæˆ‘åº”è¯¥æ€ä¹ˆåšï¼Ÿ

React Router v6ç‰ˆæœ¬ä¸å†æ”¯æŒ`withRouter`ã€‚å½“ä½¿ç”¨ç±»å¼Reactç»„ä»¶æ—¶ï¼Œä¸èƒ½å¤Ÿä½¿ç”¨hooksï¼Œç„¶è€Œåœ¨React Router v6ä¸­éƒ½æ˜¯ç”¨hookså‡½æ•°æ¥å…±äº«è·¯ç”±çŠ¶æ€ï¼Œä½†è¿™å¹¶ä¸æ„å‘³ç€ç±»å¼ç»„ä»¶ä¸èƒ½ä½¿ç”¨React Router v6ã€‚æ­¤æ—¶ä½ éœ€è¦å†™ä¸€ä¸ªè‡ªå·±çš„`withRouter`å°è£…å‡½æ•°ï¼ˆReact16.8+ï¼‰ï¼š

```tsx
import {
  useLocation,
  useNavigate,
  useParams,
} from "react-router-dom";

function withRouter(Component) {
  function ComponentWithRouterProp(props) {
    let location = useLocation();
    let navigate = useNavigate();
    let params = useParams();
    return (
      <Component
        {...props}
        router={{ location, navigate, params }}
      />
    );
  }

  return ComponentWithRouterProp;
}
```

### 2. ä¸ºä»€ä¹ˆ`<Route>`æ ‡ç­¾ç”¨`element`å±æ€§æ›¿ä»£`render`å’Œ`component`ï¼Ÿ

åœ¨React Router v6ä¸­ï¼Œæˆ‘ä»¬æŠŠv5ä¸­`<Route component>`å’Œ`<Route render>`ä¸¤ä¸ªAPIç”¨`<Route element>`æ›¿æ¢ï¼Œä¸»è¦åŸå› æœ‰å¦‚ä¸‹å‡ ç‚¹ï¼š

1. å¯¹äºåˆå­¦è€…ï¼Œè‚¯å®šä¼šç»å¸¸ä½¿ç”¨ç»„ä»¶æ‡’åŠ è½½`<Suspense fallback={<Spinner />}>`ï¼Œè¿™ä¸ªAPIé‡Œï¼Œfallbackå°±æ˜¯ä¸€ä¸ª`ReactÂ element`ï¼Œæˆ‘ä»¬ä¹‹æ‰€ä»¥è¿™ä¹ˆè®¾è®¡ï¼Œå°±æ˜¯ä¸ºäº†è®©åˆå­¦è€…èƒ½å¤Ÿæ›´å®¹æ˜“. æ›´å¹³æ»‘çš„ä½¿ç”¨æ¸²æŸ“å‡½æ•°ã€‚

2. ï¼ˆå®˜ç½‘è¯´çš„æ¯”è¾ƒå¤æ‚ï¼Œæˆ‘æ€»ç»“ä¸€ä¸‹ï¼‰v5ç‰ˆæœ¬ä¸­ï¼Œ`<Route component>`ä¸èƒ½ä¼ é€’propsï¼Œæƒ³è¦ä¼ é€’ç»„ä»¶å‚æ•°ï¼Œå°±éœ€è¦ä½¿ç”¨`<Route render>`ï¼Œè¿™å°±å¯¼è‡´äº†v4/v5çš„æ¸²æŸ“APIä½“é‡ä¼šæ›´å¤§ä¸€äº›ï¼Œä¸‹é¢æ˜¯ä¾‹å­ï¼š

```jsx
// å“¦å¼ï¼Œçœ‹èµ·æ¥æ˜¯ä¸ªä¸é”™çš„å†™æ³•ï¼
<Route path=":userId" component={Profile} />

// ä½†æ˜¯å‘¢ï¼Œæˆ‘æ€ä¹ˆç»™ <Profile> ä¼ é€’ props å‘¢??
// Hmm, æˆ‘è¿˜å¾—ç”¨å¦å¤–ä¸€ç§æ–¹å¼ï¼šrender
<Route
  path=":userId"
  render={routeProps => (
    <Profile routeProps={routeProps} animate={true} />
  )}
/>

// æ‰€ä»¥ï¼Œåœ¨v5ç‰ˆæœ¬ä¸­æœ‰ä¸¤ç§è·¯ç”±ç»„ä»¶æ¸²æŸ“æ–¹å¼ :/

// ä½†æ˜¯è¿˜æœ‰ä¸€ç§æƒ…å†µï¼Œå…³äºæ‰€æœ‰URLéƒ½ä¸èƒ½åŒ¹é…çš„404æƒ…å†µå‘¢ï¼Ÿ
// æˆ–è®¸è¿˜å¯ä»¥ä½¿ç”¨childrenæ–¹æ³•
<Route
  path=":userId"
  children={({ match }) => (
    match ? (
      <Profile match={match} animate={true} />
    ) : (
      <NotFound />
    )
  )}
/>

// å¦‚æœæƒ³è¦æ‹¿åˆ°è·¯ç”±çš„åŒ¹é… æˆ–è€… æƒ³åœ¨åµŒå¥—è·¯ç”±æ¯”è¾ƒæ·±å±‚çš„åœ°æ–¹æ¥ä¸€ä¸ªè·¯ç”±è·³è½¬å‘¢ï¼Ÿ
function DeepComponent(routeStuff) {
  // å•Šï¼Œå¤æ‚çš„å®ç°~
}
export default withRouter(DeepComponent);

// ä»¥ä¸Šæ˜¯åˆ—ä¸¾çš„ä½œè€…èƒ½æƒ³åˆ°çš„ä½¿ç”¨æƒ…å†µã€‚
```

Reactæœ¬èº«ä¸æä¾›ä»»ä½•è·å–`<Route>`ä¿¡æ¯çš„æ–¹å¼ï¼Œ æ‰€ä»¥æˆ‘ä»¬å¿…é¡»å‘æ˜ä¸€ç§æ—¢èƒ½è·å–Routeä¿¡æ¯ï¼Œåˆèƒ½è·å–è‡ªå®šä¹‰propsçš„æ–¹å¼ã€‚åº†å¹¸çš„æ˜¯ï¼Œhooksçš„å‡ºç°ï¼Œå¯ä»¥æ›¿ä»£ä¹‹å‰çš„`component`. `render`å’Œé«˜é˜¶ç»„ä»¶ã€‚å†çœ‹çœ‹é’ˆå¯¹ä»¥ä¸Šæƒ…å†µï¼Œv6æ˜¯æ€ä¹ˆå®ç°çš„ï¼š

```jsx
// å°±åƒReactåŸç”Ÿçš„ <Suspense> é‚£æ ·ä½¿ç”¨è·¯ç”±ç»„ä»¶!
// ä¸éœ€è¦é¢å¤–å¢åŠ å­¦ä¹ ä»»åŠ¡.
<Route path=":userId" element={<Profile />} />

// æˆ‘ä»¬æ¥ä¼ é€’è‡ªå·±çš„props
<Route path=":userId" element={<Profile animate={true} />} />

// è·å–è·¯ç”±å‚æ•°å’Œè·¯ç”±å®šä½ä¿¡æ¯
function Profile({ animate }) {
  let params = useParams();
  let location = useLocation();
}

// è·¯ç”±åµŒå¥—æ·±å±‚çš„ç»„ä»¶è¿›è¡Œè·³è½¬
function DeepComponent() {
  // ä¸€ä¸ªhooksæå®šï¼
  let navigate = useNavigate();
}
```

å¦å¤–è¯´ä¸€ä¸‹ï¼Œv6ä¸­ä¸ä½¿ç”¨`children`ï¼Œè¿˜æœ‰ä¸ªåŸå› ï¼Œv6åœ¨åµŒå¥—è·¯ç”±ä¸­å·²ç»å°†childrenä½œä¸ºå†…éƒ¨ä¿ç•™å…³é”®å­—äº†ï¼Œè¿™é‡Œå°±ä¸èƒ½å†ç”¨äº†ï¼š[åµŒå¥—è·¯ç”±](https://reactrouter.com/docs/en/v6/getting-started/overview#nested-routes)

### 3. v6å¦‚ä½•å®šä¹‰404é¡µé¢

åœ¨v4ä¸­ï¼Œæ¥æˆ‘ä»¬éœ€è¦å®šä¹‰ä¸€ä¸ªè·¯ç”±ä¹‹å¤–çš„pathï¼Œv5ä¸­å¯ä»¥ä½¿ç”¨`path="*"`ï¼Œv6ä¸­æ²¿ç”¨v5çš„ç”¨æ³•ï¼Œä¸è¿‡æ›´ç®€æ´ï¼š

```jsx
<Route path="*" element={<NoMatch />} />
```

### 4. ä¸ºä»€ä¹ˆæˆ‘çš„`<Route>`ä¸æ¸²æŸ“ï¼Ÿå¥½æ°”ï¼

åœ¨v5ä¸­ï¼Œ`<Route>`ç»„ä»¶å°±æ˜¯ä¸€ä¸ªæ™®é€šçš„Reactç»„ä»¶ï¼ŒURLæ²¡æœ‰åŒ¹é…åˆ°çš„æ—¶å€™ï¼Œå°±ä¼šåƒæ˜¯ifè¯­å¥æ²¡æœ‰è¦†ç›–åˆ°ä¸€æ ·ï¼Œä¸ä¼šæ¸²æŸ“ï¼›åœ¨v6ä¸­ï¼Œ`<Route>`å…ƒç´ å¹¶æ²¡æœ‰çœŸæ­£çš„æ¸²æŸ“å‡ºæ¥ï¼Œä»–åªæ˜¯ä¸€ä¸ªé…ç½®ã€‚æˆ‘ä»¬æ¥ä¸¾ä¾‹å¯¹æ¯”ä¸€ä¸‹ï¼š

v5ä¸­ï¼Œ`<Route>`å°±æ˜¯ä¸€ä¸ªç»„ä»¶ï¼Œå½“åŒ¹é…åˆ°è·¯å¾„`/my-route`æ—¶ï¼Œ`MyRoute`ç»„ä»¶å°±ä¼šè¢«æ¸²æŸ“å‡ºæ¥ï¼š
```jsx
let App = () => (
  <div>
    <MyRoute />
  </div>
);

let MyRoute = ({ element, ...rest }) => {
  return (
    <Route path="/my-route" children={<p>Hello!</p>} />
  );
};
```

v6ä¸­ï¼Œä½ è¦å†è¿™æ ·å†™å°±æ¸²æŸ“ä¸å‡ºæ¥äº†ï¼š
```jsx
// ERROR !!!
let App = () => (
  <Routes>
    <MyRoute />
  </Routes>
);

let MyRoute = () => {
  // <Routes>å¯çœ‹ä¸åˆ°ä½ è¿™é‡Œè¾¹é…ç½®çš„path
  return (
    <Route path="/my-route" children={<p>Hello!</p>} />
  );
};
```
v6çš„æ­£ç¡®å†™æ³•åº”è¯¥éµå¾ªä¸¤ä¸ªåŸåˆ™ï¼š

1. åœ¨`<Routes>`ä¸­åªæ”¾ç½®`<Route>`

2. æŠŠéœ€è¦æ¸²æŸ“çš„éƒ½æ”¾åˆ°`element`ä¸­

ç¤ºä¾‹ï¼š

```jsx
let App = () => (
  <div>
    <Routes>
      <Route path="/my-route" element={<MyRoute />} />
    </Routes>
  </div>
);

let MyRoute = () => {
  return <p>Hello!</p>;
};
```

ä½¿ç”¨`<Routes>`æ¥é™æ€åœ°é…ç½®å…¨å±€è·¯ç”±ï¼Œèƒ½å¤Ÿå‘æŒ¥å‡ºv6æ›´å¤šçš„ç‰¹æ€§ã€‚æˆ‘ä»¬ä¹Ÿé¼“åŠ±å¼€å‘è€…å°†æ‰€æœ‰`<Route>`éƒ½æ”¾åˆ°ä¸€ä¸ª`<Routes>`æ¥é…ç½®è·¯ç”±ã€‚å¦‚æœä½ çœŸçš„æƒ³è¦ä¸ªæ€§åŒ–çš„åŒ¹é…ç‹¬ç«‹URLçš„ç»„ä»¶ï¼Œä½ å¯ä»¥åƒä¸‹é¢è¿™æ ·ä¹¦å†™ï¼š

```jsx
function MatchPath({ path, Comp }) {
  let match = useMatch(path);
  return match ? <Comp {...match} /> : null;
}

// åŒ¹é…ä»»ä½•åœ°æ–¹çš„ç»„ä»¶ï¼Œä¸ä¸€å®šæœ‰ <Routes> åŒ…è£¹
<MatchPath path="/accounts/:id" Comp={Account} />;
```

### 5. è·¯ç”±æ ‘æ„å»ºçš„è¿ç§»å·¥ä½œ

åœ¨v5ç‰ˆæœ¬ä¸­ï¼Œä½ å¯ä»¥ä½¿ç”¨`<Route>`å’Œ`<Switch>`æ ‡ç­¾æ¥å¤„ç†è·¯ç”±åµŒå¥—é—®é¢˜ï¼š

```jsx
// è·¯ç”±æ ‘é¡¶éƒ¨
<Switch>
  <Route path="/users" component={Users} />
</Switch>;

// è·¯ç”±æ ‘ä¸­æŸä¸ªåœ°æ–¹
function Users() {
  return (
    <div>
      <h1>Users</h1>
      <Switch>
        <Route path="/users/account" component={Account} />
      </Switch>
    </div>
  );
}
```

v6ä¸­çš„ä½¿ç”¨åŸºæœ¬ç±»ä¼¼ï¼Œå°†`Switch`æ¢æˆ`Routes`ã€‚ä¸è¿‡éœ€è¦æ³¨æ„ä»¥ä¸‹ä¸¤ç‚¹ï¼š

1. åœ¨çˆ¶è·¯ç”±çš„pathé…ç½®ä¸­ï¼Œéœ€è¦åŠ å…¥`/*`æ¥åŒ¹é…elementä¸­é…ç½®çš„å­è·¯ç”±

2. åµŒå¥—è·¯ç”±ä¸­ä¸éœ€è¦è·å–å®Œæ•´çš„è·¯å¾„ï¼Œv6æ”¯æŒç›¸å¯¹è·¯å¾„

ç¤ºä¾‹ï¼š
```jsx
// é¡¶å±‚è·¯ç”±
<Routes>
  <Route path="/users/*" element={<Users />} />
</Routes>;

// è·¯ç”±æ ‘ä¸­æŸä¸ªåœ°æ–¹
function Users() {
  return (
    <div>
      <h1>Users</h1>
      <Routes>
        <Route path="account" element={<Account />} />
      </Routes>
    </div>
  );
}
```

å¦ï¼Œåœ¨v5ä¸­å¦‚æœæœ‰æ¸¸ç¦»çš„`<Route>`ï¼Œåœ¨è¿ç§»æ—¶éœ€è¦ç”¨`<Routes>`åŒ…è£¹ï¼š
```jsx
// v5
<Route path="/contact" component={Contact} />

// v6
<Routes>
  <Route path="contact" element={<Contact />} />
</Routes>
```

### 6. v6è¿˜èƒ½ä½¿ç”¨æ­£åˆ™åŒ¹é…å—ï¼Ÿ

v6ä¸­å·²ç»ç§»é™¤äº†æ­£åˆ™åŒ¹é…~~ æœ‰ä»¥ä¸‹ä¸¤ä¸ªåŸå› ï¼š

1. æ­£åˆ™è·¯ç”±åœ¨ä½¿ç”¨ä¸­é€ æˆäº†å¾ˆå¤šä¼˜å…ˆçº§åŒ¹é…çš„é—®é¢˜ï¼Œå› ä¸ºæ­£åˆ™æ˜¯æ²¡æœ‰ä¼˜å…ˆçº§è¿™ä¸ªæ¦‚å¿µçš„

2. æ­£åˆ™åŒ¹é…çš„ä¾èµ–åŒ…å¤ªå¤§äº†ï¼Œå¦‚æœå†æ”¾å›æ¥ï¼Œv6çš„ä½“ç§¯ä¼šå¢åŠ 1/2ï¼ˆå³æ­£åˆ™å ç”¨1/3ï¼‰

åœ¨è°ƒç ”è¿‡å¤§é‡çš„ç”¨ä¾‹åï¼Œæˆ‘ä»¬å‘ç°ï¼Œå®Œå…¨å¯ä»¥è§„é¿æ‰ç›´æ¥ä½¿ç”¨æ­£åˆ™æ¥åŒ¹é…è·¯ç”±ã€‚æ‰€ä»¥ï¼Œå†ä¸‰æƒè¡¡ä¹‹ä¸‹ï¼Œæˆ‘ä»¬åšäº†è¿™ä¸ªé‡è¦çš„åˆ å‡ï¼Œæ¥ç¼©å°React Routerçš„ä½“ç§¯å’Œè§„é¿å·²çŸ¥çš„ä¼˜å…ˆçº§é—®é¢˜ã€‚

ä¸€èˆ¬æ¥è¯´ï¼Œæ­£åˆ™è·¯ç”±ä»…ä»…æ˜¯ç”¨æ¥åŒ¹é…ä¸€ä¸ªURLå­—ç¬¦ä¸²ç‰‡æ®µï¼Œå®ç°å¦‚ä¸‹åŠŸèƒ½ï¼š

1. åŒ¹é…å¤šä¸ªé™æ€å€¼
ä¸¾ä¾‹ï¼ˆv5ï¼‰ï¼š
```jsx
// v5-lang-route.js
function App() {
  return (
    <Switch>
      <Route path={/(en|es|fr)/} component={Lang} />
    </Switch>
  );
}

function Lang({ params }) {
  let lang = params[0];
  let translations = I81n[lang];
  // ...
}
```
è¿™äº›å­—ç¬¦ä¸²éƒ½æ˜¯é™æ€å†™å…¥çš„è·¯å¾„ï¼Œåœ¨v6ä¸­ï¼Œå®Œå…¨å¯ä»¥ç”¨ä¸‰ä¸ª`Route`ä»£æ›¿ï¼Œå¦‚æœæœ‰å¾ˆå¤šè¦åŒ¹é…çš„ï¼Œæ”¾åœ¨æ•°ç»„é‡Œæ¥ä¸ªéå†å°±è¡Œï¼š
```jsx
// v6-lang-route.js
function App() {
  return (
    <Routes>
      <Route path="en" element={<Lang lang="en" />} />
      <Route path="es" element={<Lang lang="es" />} />
      <Route path="fr" element={<Lang lang="fr" />} />
    </Routes>
  );
}

function Lang({ lang }) {
  let translations = I81n[lang];
  // ...
}
```

2. æ ¡éªŒå‚æ•°ï¼ˆæ¯”å¦‚æ˜¯ä¸æ˜¯numberç±»å‹ï¼‰

ä¸¾ä¾‹ï¼ˆv5ï¼‰ï¼š
```jsx
// v5-userId-route.js
function App() {
  return (
    <Switch>
      <Route path={/users/(\d+)/} component={User} />
    </Switch>
  );
}

function User({ params }) {
  let id = params[0];
  // ...
}
```
åœ¨v6ä¸­éœ€è¦åšä¸€ç‚¹å¾®é‡çš„å·¥ä½œæ¥å®ç°è¿™ç§æ ¡éªŒï¼š
```jsx
// v6-userId-route.js
function App() {
  return (
    <Routes>
      <Route path="/users/:id" element={<ValidateUser />} />
      <Route path="/users/*" element={<NotFound />} />
    </Routes>
  );
}

function ValidateUser() {
  let params = useParams();
  let userId = params.id.match(/\d+/);
  if (!userId) {
    return <NotFound />;
  }
  return <User id={params.userId} />;
}

function User(props) {
  let id = props.id;
  // ...
}
```

åœ¨v5ä¸­ï¼Œå¦‚æœæ­£åˆ™è·¯ç”±ä¸èƒ½åŒ¹é…ä»»ä½•ä¸€ä¸ªURLæ—¶ï¼Œ`<Switch>`ä¼šå°è¯•åŒ¹é…æ¥ä¸‹æ¥çš„è·¯ç”±ï¼š
```jsx
// v5-switch.js
function App() {
  return (
    <Switch>
      <Route path={/users/(\d+)/} component={User} />
      <Route path="/users/new" exact component={NewUser} />
      <Route
        path="/users/inactive"
        exact
        component={InactiveUsers}
      />
      // 'users/abc' ä¼šåŒ¹é…åˆ°è¿™é‡Œ
      <Route path="/users/*" component={NotFound} />
    </Switch>
  );
}
```

åœ¨v6ä¸­å°±ä¸ç”¨æ‹…å¿ƒè¿™ç§é—®é¢˜ï¼Œåœ¨ä¸‹è¾¹çš„ä¾‹å­ä¸­ï¼Œç”±äºv6çš„ç²¾ç¡®åŒ¹é…æœºåˆ¶ï¼Œ`:userId`ä¼šä¼˜å…ˆè¢«åŒ¹é…æ‰ï¼Œæ ¡éªŒçš„å·¥ä½œæ˜¯åœ¨åŒ¹é…åˆ°ä¹‹ååœ¨å­ç»„ä»¶å†…è¿›è¡Œçš„ï¼Œè€Œä¸æ˜¯é€šè¿‡æ ¡éªŒæ¥åŒ¹é…ã€‚
```jsx
// v6-ranked.js
function App() {
  return (
    <Routes>
      // '/users/123', '/users/abc' éƒ½ä¼šåŒ¹é…åˆ°
      <Route path="/users/:id" element={<ValidateUser />} />
      // '/users/new' æ‰èƒ½åŒ¹é…åˆ°
      <Route path="/users/new" element={<NewUser />} />
      <Route
        path="/users/inactive"
        element={<InactiveUsers />}
      />
    </Routes>
  );
}
```

äº‹å®ä¸Šï¼Œ å¦‚æœä½¿ç”¨è€…æ²¡æœ‰æŒ‰ç…§æ­£ç¡®çš„é¡ºåºå¸ƒå±€è‡ªå·±çš„è·¯ç”±æ—¶ï¼Œv5ä¸­ç¡®å®ä¼šå­˜åœ¨è·¯ç”±ä¼˜å…ˆçº§é”™ä¹±çš„é—®é¢˜ã€‚v6å¼•å…¥äº†ç²¾å‡†åŒ¹é…è§£å†³äº†è¿™ä¸ªé—®é¢˜ã€‚

<hr />

å¦‚æœä½ æ˜¯ç”¨çš„æ˜¯`Remix`ï¼Œåœ¨è·¯ç”±æ²¡æœ‰åŒ¹é…åˆ°æ—¶ï¼Œä½ å¯ä»¥è¿”å›å¸¦`40x`çŠ¶æ€ç çš„Loaderï¼Œç”±äºLoaderè¿è¡Œåœ¨æœåŠ¡ç«¯ï¼Œæ‰€ä»¥è¿™å°†ä¼šå‡å°‘å‰ç«¯ä»£ç æ‰“åŒ…çš„ä½“ç§¯ï¼š
```jsx
// remix-useLoaderData.js
import { useLoaderData } from "remix";

export async function loader({ params }) {
  if (!params.id.match(/\d+/)) {
    throw new Response("", { status: 400 });
  }

  let user = await fakeDb.user.find({
    where: { id: params.id },
  });
  if (!user) {
    throw new Response("", { status: 404 });
  }

  return user;
}

function User() {
  let user = useLoaderData();
  // ...
}
```

ä¸åŒäºç›´æ¥æ¸²æŸ“ç»„ä»¶ï¼Œremixä¼šæ¸²æŸ“æœ€è¿‘çš„[catch boundary](https://remix.run/docs/en/v1/api/conventions#catchboundary)ã€‚

<hr />

FAQs finished !80:T36b8,> ä¸“æ è¯´æ˜ï¼šå¯¹äºreact-router v6ç‰ˆæœ¬ï¼Œæœ‰åŒäº‹ååº”ç¼ºå°‘ç›¸å¯¹å®Œæ•´çš„ä¸­æ–‡æ–‡æ¡£ï¼ŒæŸ¥çœ‹ä¸æ–¹ä¾¿ã€‚ä¸ºäº†ä¾¿äºä½¿ç”¨ï¼Œä½œè€…å¯¹[å®˜ç½‘æ–‡æ¡£](https://reactrouter.com/docs/en/v6)è¿›è¡Œé’ˆå¯¹æ€§ç¿»è¯‘ï¼Œä¾¿äºv6ç‰ˆæœ¬æ›´å¹¿æ³›çš„è¢«ä½¿ç”¨ã€‚

## 1. å®‰è£…


æœ¬æ–‡æ¡£ä»‹ç»ä½¿ç”¨åŸºäºReactæ¡†æ¶çš„ä¸åŒæ„å»ºå·¥å…·æ¥é…ç½®React Routerçš„ä¸€èˆ¬æ–¹æ¡ˆã€‚

### åŸºç¡€å®‰è£…

> åŸæ–‡è·¯å¾„ https://reactrouter.com/docs/en/v6/getting-started/installation#basic-installation

å¤§å¤šæ•°Reactå·¥ç¨‹é¡¹ç›®éƒ½ä½¿ç”¨åŒ…ç®¡ç†å™¨[npm](https://www.npmjs.com/) æˆ–è€…Â [Yarn](https://yarnpkg.com/)è¿›è¡Œä¾èµ–ç®¡ç†ã€‚ä½¿ç”¨React Routerå‰çš„ç¬¬ä¸€ä»¶äº‹æƒ…ï¼Œå°±æ˜¯åŸºäºä½ çš„åŒ…ç®¡ç†å·¥å…·è¿›è¡ŒReact Routerçš„å®‰è£…ã€‚

1. npm

```sh
$ npm install react-router-dom@6
```
2. yarn

```sh
$ yarn add react-router-dom@6
```
3. pnpm

```sh
$ pnpm add react-router-dom@6
```

### åŸºäºCreate-react-appé¡¹ç›®çš„å®‰è£…

> åŸæ–‡è·¯å¾„ https://reactrouter.com/docs/en/v6/getting-started/installation#create-react-app

å½“ä½ åœ¨craé¡¹ç›®ä¸­å®‰è£…å¥½ä¾èµ–åï¼Œæ‰“å¼€æ–‡ä»¶`src/index.js`ï¼Œ ä»Â `react-router-dom`Â å¼•å…¥ `BrowserRouter`ï¼Œ å¹¶ä½¿ç”¨æ ‡ç­¾`<BrowserRouter>`åŒ…è£¹æ–‡ä»¶:


```jsx
import * as React from "react";
import ReactDOM from "react-dom/client";
import { BrowserRouter } from "react-router-dom";
import "./index.css";
import App from "./App";
import reportWebVitals from "./reportWebVitals";

const root = ReactDOM.createRoot(
  document.getElementById("root")
);
root.render(
  <React.StrictMode>
    <BrowserRouter>
      <App />
    </BrowserRouter>
  </React.StrictMode>
);
```

æ¥ä¸‹æ¥ä½ å°±å¯ä»¥åœ¨appä¸­ä»»æ„åœ°æ–¹ä½¿ç”¨è·¯ç”±äº†ï¼š

```jsx
import * as React from "react";
import { Routes, Route, Link } from "react-router-dom";
import "./App.css";

function App() {
  return (
    <div className="App">
      <h1>Welcome to React Router!</h1>
      <Routes>
        <Route path="/" element={<Home />} />
        <Route path="about" element={<About />} />
      </Routes>
    </div>
  );
}
```
ä¸Šè¿°æ–‡ä»¶ä¸­ï¼ŒHomeå’ŒAboutæ˜¯è‡ªå®šä¹‰çš„è·¯ç”±ç»„ä»¶ï¼Œé€šè¿‡importå¼•å…¥ã€‚

### åŸºäºParcelé¡¹ç›®çš„å®‰è£…

åœ¨package.jsonä¸­æ·»åŠ è„šæœ¬ï¼š

```json
"scripts": {
  "start": "parcel index.html"
}
```

å®‰è£…å®Œä¾èµ–åï¼Œåœ¨æ ¹ç›®å½•ä¸‹æ–°å»ºæ–‡ä»¶`.babelrc`:
```js
{
  "presets": ["@babel/preset-react"]
}
```

ç„¶ååœ¨æ ¹ç›®å½•çš„`index.js`æ–‡ä»¶ä¸­å³å¯ä½¿ç”¨ï¼š
```jsx
import * as React from "react";
import ReactDOM from "react-dom/client";
import { BrowserRouter } from "react-router-dom";
import App from "./App.js";

const root = ReactDOM.createRoot(
  document.getElementById("root")
);
root.render(
  <React.StrictMode>
    <BrowserRouter>
      <App />
    </BrowserRouter>
  </React.StrictMode>
);
```
å†™å…¥æ–‡ä»¶`index.html`ï¼š
```html
<body>
  <noscript
    >You need to enable JavaScript to run this
    app.
  </noscript>
  <div id="root"></div>
  <script src="./index.js"></script>
</body>
```
æ¥ä¸‹æ¥å°±å¯ä»¥åœ¨Appç»„ä»·ä¸­ä½¿ç”¨routeräº†ï¼Œä½¿ç”¨æ–¹å¼åŒcraé¡¹ç›®ã€‚

### åŸºäºWebpacké¡¹ç›®çš„å®‰è£…

> åŸæ–‡è·¯å¾„ https://reactrouter.com/docs/en/v6/getting-started/installation#webpack

webpackæ˜¯ä¸€ç§æ›´ç»†ç²’åº¦çš„æ„å»ºå·¥å…·ï¼Œæ‚¨å¯ä»¥è¿›è¡Œæ›´åŠ ç»†å¾®çš„é…ç½®ã€‚å®‰è£…å®Œå¿…è¦çš„ä¾èµ–åï¼Œä¾¿å¯ä»¥å¼•å…¥è·¯ç”±äº†ï¼š
```jsx
import {
  BrowserRouter,
  Routes,
  Route,
} from "react-router-dom";

function App() {
  return (
    <BrowserRouter>
      <div>
        <h1>Hello, React Router!</h1>
        <Routes>
          <Route path="/" element={<Home />} />
        </Routes>
      </div>
    </BrowserRouter>
  );
}
```

### ä½¿ç”¨scriptæ ‡ç­¾å…¨å±€å®‰è£…

> åŸæ–‡è·¯å¾„ https://reactrouter.com/docs/en/v6/getting-started/installation#html-script-tags

React-router v6ä¸React16.8+å®Œå…¨å…¼å®¹ã€‚æ‚¨å®Œå…¨å¯ä»¥åœ¨ä¸€ä¸ªHTMLä¸­é€šè¿‡`<script>`å¼•å…¥å¯¹åº”çš„jsæ–‡ä»¶è¿›è¡Œå…¨å±€ä½¿ç”¨ï¼šï¼ˆæˆ‘è¿™é‡Œåˆ æ‰äº†åŸæ–‡çš„æ³¨é‡Šï¼‰
```html
<body>
  <div id="root"></div>

  <script src="https://unpkg.com/react@>=16.8/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@>=16.8/umd/react-dom.development.js" crossorigin></script>

  <!-- Load history -->
  <script src="https://unpkg.com/history@5/umd/history.development.js" crossorigin></script>

  <!-- Load React Router and React Router DOM -->
  <script src="https://unpkg.com/react-router@6/umd/react-router.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-router-dom@6/umd/react-router-dom.development.js" crossorigin></script>

  <!-- A simple example app -->
  <script>
  var e = React.createElement;
  var Router = ReactRouterDOM.BrowserRouter;
  var Routes = ReactRouterDOM.Routes;
  var Route = ReactRouterDOM.Route;

  ReactDOM.render(
    (
      e(Router, null, (
        e(Routes, null, (
          e(Route, {
            element: e('div', null, 'Hello, React Router!')
          })
        ))
      ))
    ),
    document.getElementById('root')
  );
  </script>

</body>
```
è™½ç„¶è¿™ç§æ–¹æ³•æ¥å¾—æ¯”è¾ƒå¿«ï¼Œä½†æ˜¯ä¹Ÿå¼•å…¥äº†ä¸€äº›ä¸å¿…è¦çš„ä»£ç å¼•ç”¨ã€‚React RouteråŒ…å«äº†å¾ˆå¤šå°å·¥å…·å’Œç»„ä»¶ï¼ŒæŒ‰éœ€å¼•å…¥æ‰æ˜¯ç‹é“ã€‚æ‰€ä»¥è¿˜æ˜¯æ¨èå‰ä¸‰ç§å®‰è£…æ–¹å¼ã€‚


## 2. å¿«é€Ÿå¼€å§‹ï¼ˆæœ‰ä¸€äº›ä¸å®‰è£…é‡å¤ï¼‰

> åŸæ–‡åœ°å€ https://reactrouter.com/docs/en/v6/getting-started/overview#quick-start-overview

### å¼•å…¥ 

å®‰è£…ä¾èµ–ï¼Œå‰è¾¹å·²ç»æåˆ°ï¼š

```js
npm install react-router-dom@6
```

é…ç½®è·¯ç”±
```jsx
import ReactDOM from "react-dom/client";
import {
  BrowserRouter,
  Routes,
  Route,
} from "react-router-dom";
// import your route components too

const root = ReactDOM.createRoot(
  document.getElementById("root")
);
root.render(
  <BrowserRouter>
    <Routes>
      <Route path="/" element={<App />}>
        <Route index element={<Home />} />
        <Route path="teams" element={<Teams />}>
          <Route path=":teamId" element={<Team />} />
          <Route path="new" element={<NewTeamForm />} />
          <Route index element={<LeagueStandings />} />
        </Route>
      </Route>
    </Routes>
  </BrowserRouter>
);
```
åœ¨v6ä¹‹å‰çš„ç‰ˆæœ¬ï¼Œæœ‰å¤šè·¯ç”±è¦åŒ¹é…æ—¶ï¼Œéœ€è¦åˆç†å®‰æ’å‰åæ”¾ç½®é¡ºåºã€‚åœ¨v6ä¸­ï¼ŒåŒ¹é…æ›´æ™ºèƒ½ï¼Œä¸è¦åœ¨æ‹…å¿ƒé¡ºåºé—®é¢˜äº†ï¼Œä¸¾ä¸ªä¾‹å­ï¼š
```jsx
<Route path="teams/:teamId" element={<Team />} />
<Route path="teams/new" element={<NewTeamForm />} />
```
è·¯ç”±`teams/new`ä¼¼ä¹å¯¹äºä¸Šè¾¹ä¸¤ä¸ªè·¯å¾„éƒ½å¯ä»¥åŒ¹é…ï¼Œä½†æ˜¯ç¬¬äºŒä¸ªæ›´ç²¾ç¡®ï¼Œæ‰€ä»¥v6 routerä¼šé€‰æ‹©ç¬¬äºŒä¸ªNewTeamFormã€‚

### è·¯ç”±è·³è½¬

å¯ä½¿ç”¨`Link`æ ‡ç­¾æ¥ç‚¹å‡»æ”¹å˜URLï¼Œæˆ–è€…ä½¿ç”¨`useNavigate`é’©å­é€šè¿‡ä»£ç è·³è½¬ã€‚

- Link
```jsx
import { Link } from "react-router-dom";

function Home() {
  return (
    <div>
      <h1>Home</h1>
      <nav>
        <Link to="/">Home</Link> |{" "}
        <Link to="about">About</Link>
      </nav>
    </div>
  );
}
```

- navigate
```jsx
import { useNavigate } from "react-router-dom";

function Invoices() {
  let navigate = useNavigate();
  return (
    <div>
      <NewInvoiceForm
        onSubmit={async (event) => {
          let newInvoice = await createInvoice(
            event.target
          );
          navigate(`/invoices/${newInvoice.id}`);
        }}
      />
    </div>
  );
}
```

### è·å–è·¯ç”±å‚æ•°

å¯ä»¥ä½¿ç”¨Â `:style`Â å½¢å¼ä¼ å‚ï¼Œ ä½¿ç”¨Â `useParams()`Â è·å–å‚æ•°ï¼š
```jsx
import { Routes, Route, useParams } from "react-router-dom";

function App() {
  return (
    <Routes>
      <Route
        path="invoices/:invoiceId"
        element={<Invoice />}
      />
    </Routes>
  );
}

function Invoice() {
  let params = useParams();
  return <h1>Invoice {params.invoiceId}</h1>;
}
```
ä¸¾ä¸€ä¸ªé€šè¿‡è·¯ç”±å‚æ•°è·å–å¼‚æ­¥æ•°æ®çš„ä¾‹å­ï¼š
```jsx
function Invoice() {
  let { invoiceId } = useParams();
  // useFakeFetchå¯ä»¥ç†è§£ä¸ºä¸€ä¸ªå¼‚æ­¥è¯·æ±‚
  let invoice = useFakeFetch(`/api/invoices/${invoiceId}`);
  return invoice ? (
    <div>
      <h1>{invoice.customerName}</h1>
    </div>
  ) : (
    <Loading />
  );
}
```

---
> 2023.3.9 è¡¥å……ï¼šè¿™é‡Œé¡ºä¾¿è¡¥å……ä¸€ä¸‹è·å–é—®å·ä¼ å‚çš„æ–¹å¼ï¼Œæ–¹ä¾¿æŸ¥è¯¢

### é—®å·ä¼ å‚è·å–

#### v6 ä¸­

```jsx
// å¼•å…¥
import { useSearchParams } from 'react-router-dom';
...

// è·å–
const [searchParams] = useSearchParams();
// ä½¿ç”¨
const currentType = searchParams.get('type');
```

#### v5ä¸­

v5 ç‰ˆæœ¬æ²¡æœ‰è¿™ä¸ªhookï¼Œéœ€è¦è‡ªå·±å®šä¹‰ä¸€ä¸‹ï¼š

```jsx
// useSearchParams.js
import { useLocation } from "react-router-dom";
import { useMemo } from "react";

/**
 * è·å–å½“å‰é¡µé¢çš„æŸ¥è¯¢å‚æ•°
 */
export default function useSearchParams() {
  const { search } = useLocation();
  return useMemo(() => {
    const urlSearchParams = new URLSearchParams(search);
    let params = {};
    urlSearchParams.forEach((value, key) => {
      params[key] = value;
    });
    return params;
  }, [search]);
}
```

ä½¿ç”¨ï¼š

```jsx
const searchParams = useSearchParams();

console.log(searchParams.type)
```

---


### è·¯ç”±åµŒå¥—

è·¯ç”±åµŒå¥—æ˜¯ä¸€ä¸ªå¾ˆå¼ºå¤§çš„åŠŸèƒ½ï¼Œå¯ä»¥å‡å°‘å†—æ‚çš„å¸ƒå±€ä»£ç ï¼Œé™ä½å¸ƒå±€çš„éš¾åº¦ã€‚å¦‚ä¸‹ä½¿ç”¨ï¼š
```jsx
function App() {
  return (
    <Routes>
      <Route path="invoices" element={<Invoices />}>
        <Route path=":invoiceId" element={<Invoice />} />
        <Route path="sent" element={<SentInvoices />} />
      </Route>
    </Routes>
  );
}
```
åˆ†åˆ«é€šè¿‡å¦‚ä¸‹ä¸‰ç§è·¯å¾„åŒ¹é…ï¼š
-   `"/invoices"`
-   `"/invoices/123"`
-   `"/invoices/sent"`

### Outlet

å¯ä»¥ä½¿ç”¨ä¸€ä¸ªè·¯ç”±å ä½ç¬¦ï¼Œé’ˆå¯¹å¤šåŒ¹é…çš„è·¯ç”±ä½ç½®è¿›è¡Œå¤ç”¨ï¼Œç±»ä¼¼äºvue routerçš„è·¯ç”±æ’æ§½å’ŒAngularçš„`router-outlet`ï¼š
```jsx
import {
  Routes,
  Route,
  Link,
  Outlet,
} from "react-router-dom";

function App() {
  return (
    <Routes>
      <Route path="/" element={<Layout />}>
        <Route path="invoices" element={<Invoices />} />
        <Route path="dashboard" element={<Dashboard />} />
      </Route>
    </Routes>
  );
}

function Layout() {
  return (
    <div>
      <h1>Welcome to the app!</h1>
      <nav>
        <Link to="invoices">Invoices</Link> | {" "}
        <Link to="dashboard">Dashboard</Link>
      </nav>
      <div className="content">
        <Outlet />
      </div>
    </div>
  );
}

function Invoices() {
  return <h1>Invoices</h1>;
}

function Dashboard() {
  return <h1>Dashboard</h1>;
}
```
è¿™æ ·ä¼šæŠŠURLç‰‡æ®µæ„å»ºä¸ºç»„ä»¶æ ‘ï¼Œè·¯ç”±ä¸‹çš„å­è·¯ç”±ä¼šåŠ¨æ€çš„å»æ›¿æ¢æ‰çˆ¶è·¯ç”±çš„`<Outlet />`ï¼Œä»¥æ­¤è¾¾åˆ°åµŒå¥—çš„ç›®çš„ã€‚

### é»˜è®¤è·¯ç”±

å½“ä¸€ä¸ªçˆ¶è·¯ç”±æœ‰å¤šä¸ªå­è·¯ç”±ï¼Œä¸”å½“å‰URLåœç•™åœ¨çˆ¶è·¯ç”±æ—¶ï¼ˆä¸Šä¸ªä¾‹å­ä¸­ï¼Œè·¯ç”±ä¸º'/'æ—¶ï¼Œoutleté‡Œå°±æ— æ³•è¯†åˆ«æ¸²æŸ“ï¼‰ï¼Œç•Œé¢è¯¥å¦‚ä½•æ¸²æŸ“å‘¢ï¼Ÿä½ éœ€è¦ç»™çˆ¶è·¯ç”±è®¾ç½®ä¸€ä¸ªé»˜è®¤æ¸²æŸ“çš„å­è·¯ç”±ã€‚
```jsx
function App() {
  return (
    <Routes>
      <Route path="/" element={<Layout />}>
        <Route index element={<Activity />} />
        <Route path="invoices" element={<Invoices />} />
        <Route path="activity" element={<Activity />} />
      </Route>
    </Routes>
  );
}
```
åŠ ä¸Š`index`å±æ€§åå°±ä¼šé»˜è®¤æ¸²æŸ“è¯¥è·¯ç”±ä¸‹çš„ç»„ä»¶ã€‚è€Œä¸”é»˜è®¤ç´¢å¼•è·¯ç”±å¯ä»¥æ”¾åœ¨è·¯ç”±åµŒå¥—çš„ä»»ä½•ä¸€çº§ä¸­ä½¿ç”¨ã€‚

### åµŒå¥—è·¯ç”±ä¸­ä½¿ç”¨Link

```jsx
...
// <Dashboard />
<nav>
    <Link to="invoices">Invoices</Link>{" "}
    <Link to="team">Team</Link>
</nav>

...
<Routes>
    <Route path="/" element={<Home />} />
    <Route path="dashboard" element={<Dashboard />}>
        <Route path="invoices" element={<Invoices />} />
        <Route path="team" element={<Team />} />
    </Route>
</Routes>

```
åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä¸Šè¿°ä¸¤ä¸ªLinkä¼šè¿æ¥åˆ°`/dashboard/invoices`Â å’ŒÂ `/dashboard/team`ä¸¤ä¸ªåœ°å€ï¼Œè¿™å°±æ˜¯ç›¸å¯¹è·¯ç”±ã€‚

### 404è·¯ç”±

å½“æ²¡æœ‰ä¸€ä¸ªURLåŒ¹é…æ—¶ï¼Œå°±ä¼šæŸ¥æ‰¾æ˜¯å¦é…ç½®äº†é€šç”¨è·¯ç”±`path="*"`ï¼Œä»–å¯ä»¥åŒ¹é…ä»»ä½•å½¢å¼çš„è·¯ç”±ï¼Œå½“æ²¡æœ‰æ›´ç²¾ç¡®çš„è·¯ç”±åŒ¹é…æ—¶ï¼Œå°±è¿›å…¥è¯¥è·¯ç”±çš„é…ç½®ï¼Œè¯¥è·¯ç”±çš„ä¼˜å…ˆçº§æ˜¯æœ€ä½çš„ã€‚

```jsx
function App() {
  return (
    <Routes>
      <Route path="/" element={<Home />} />
      <Route path="dashboard" element={<Dashboard />} />
      <Route path="*" element={<NotFound />} />
    </Routes>
  );
}
```

### å¤šä¸ªè·¯ç”±ç»„

ä¸€ä¸ª`Routes`ç»„ä»¶åŒ…è£¹çš„è·¯ç”±ä¸ºä¸€ç»„ï¼Œv6ä¸­ä½ å¯ä»¥ä½¿ç”¨å¤šä¸ª`Routes`ã€‚æ¯ä¸€ä¸ª`<Routes>`éƒ½æ˜¯ç‹¬ç«‹çš„ï¼Œåˆ†åˆ«è¿›è¡Œè·¯ç”±åŒ¹é…ï¼Œå…¶éƒ½æ˜¯ç›¸å¯¹äºè·Ÿè·¯ç”±çš„ä¸€ä¸ªé“¾æ¥ã€‚
```jsx
function App() {
  return (
    <div>
      <Sidebar>
        <Routes>
          <Route path="/" element={<MainNav />} />
          <Route
            path="dashboard"
            element={<DashboardNav />}
          />
        </Routes>
      </Sidebar>

      <MainContent>
        <Routes>
          <Route path="/" element={<Home />}>
            <Route path="about" element={<About />} />
            <Route path="support" element={<Support />} />
          </Route>
          <Route path="dashboard" element={<Dashboard />}>
            <Route path="invoices" element={<Invoices />} />
            <Route path="team" element={<Team />} />
          </Route>
          <Route path="*" element={<NotFound />} />
        </Routes>
      </MainContent>
    </div>
  );
}
```

### å¤šçº§Routesæ—¶æ³¨æ„äº‹é¡¹

å½“å­ç»„ä»¶ä¹Ÿä½¿ç”¨äº†`Routes`æ—¶ï¼Œéœ€è¦åœ¨å…¶ä¸Šä¸€çº§çˆ¶è·¯ç”±åè¾¹è¿½åŠ `/*`ï¼Œè¿½åŠ çš„`*`çš„å±‚çº§æ•°å–å†³äºä½ å­è·¯ç”±çš„å±‚çº§æ•°ã€‚
```jsx
function App() {
  return (
    <Routes>
      <Route path="/" element={<Home />} />
      // ä¸åŠ *ä¼šåŒ¹é…ä¸åˆ°Dashboardä¸­çš„å­è·¯ç”±
      <Route path="dashboard/*" element={<Dashboard />} />
    </Routes>
  );
}

function Dashboard() {
  return (
    <div>
      <p>Look, more routes!</p>
      <Routes>
        <Route path="/" element={<DashboardGraphs />} />
        <Route path="invoices" element={<InvoiceList />} />
      </Routes>
    </div>
  );
}
```

å¸¸ç”¨é…ç½®ä»‹ç»å®Œæ¯•äº†ã€‚æºæ–‡æ¡£çš„[Tutorial](https://reactrouter.com/docs/en/v6/getting-started/tutorial)æ„Ÿè§‰ä¸æœ¬ç« åŸºæœ¬ç±»ä¼¼ï¼Œæˆ‘æ‰“ç®—è·³è¿‡ä»–ï¼Œä¸‹ä¸€ç« è®²è§£FAQsã€‚81:T19bb,## 1. å‰è¨€

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æ‰¿æ¥ä¸Šä¸€ç¯‡[# æ‰‹æŠŠæ‰‹æ­å»ºåŸºäºReactçš„å‰ç«¯UIåº“ ï¼ˆä¸‰ï¼‰-- åŸºç¡€ç»„ä»¶Iconå’ŒButton](https://juejin.cn/post/7076668781044924453)ã€‚æˆ‘ä»¬ç»§ç»­æ·»åŠ ç»„ä»¶ï¼Œæœ¬æ¬¡è®°å½•çš„æ˜¯å¸ƒå±€ç»„ä»¶Boxå’ŒCombineã€‚

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æœ¬æ–‡çš„ä»£ç å±•ç¤ºçš„æ˜¯ä¸»è¦çš„æ ¸å¿ƒç¤ºæ„ä»£ç ï¼Œå…¨éƒ¨ä»£ç è§ä»“åº“ï¼š[Githubä»“åº“](https://github.com/heiheihoho1213/dux-ui)


## 2. Box

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å…³äºé¡µé¢å¸ƒå±€ï¼Œæœ€æµè¡Œçš„ä¾¿æ˜¯flexå¸ƒå±€ï¼ŒBoxç»„ä»¶ä¾¿æ˜¯å¯¹flexå¸ƒå±€è¿›è¡Œçš„ä¸€æ¬¡å°è£…ã€‚åºŸè¯ä¸å¤šè¯´ï¼Œä¸Šä»£ç ã€‚åœ¨`src/component`æ–‡ä»¶å¤¹ä¸‹æ–°å»ºæ–‡ä»¶å¤¹`Box`ï¼Œåœ¨å…¶ä¸­æ–°å»ºæ–‡ä»¶`index.tsx`ï¼š

```tsx
export interface BoxProps {
  children?: ReactNode;
  direction?: 'row' | 'row-reverse' | 'column' | 'column-reverse';
  wrap?: 'nowrap' | 'wrap' | 'wrap-reverse';
  alignItems?: 'center' | 'flex-start' | 'flex-end' | 'stretch';
  alignContent?: 'center' | 'flex-start' | 'flex-end' | 'space-between' | 'space-around';
  justifyContent?:
    | 'center'
    | 'flex-start'
    | 'flex-end'
    | 'space-between'
    | 'space-around'
    | 'stretch';
  padding?: number | string;
  width?: string;
  height?: string;
  flex?: string;
}

class Box extends PureComponent<BoxProps> {
  render() {
    const box = <BoxWrap {...this.props} />;

    return box;
  }
}

...

```
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ä¸Šè¾¹å®šä¹‰äº†ä¸€äº›æ¥æ”¶å‚æ•°ï¼Œå…¶ä¸flexçš„csså‚æ•°æ˜¯å¯¹åº”çš„ï¼Œæˆ‘ä»¬å°±æ¯ä¸€ä¸ªå…·ä½“çš„å‚æ•°ï¼Œåœ¨ä»£ç é‡Œè¿›è¡Œå®ç°ä¾¿å¯ä»¥å®Œæˆè¯¥ç»„ä»¶äº†ã€‚æ¥ä¸‹æ¥å®ç°`BoxWrap`ç»„ä»¶ï¼š


```tsx
import styled from '@emotion/styled';
import { css } from '@emotion/core';

export const BoxWrap = styleWrap({
  className: prefixCls,
})(
  styled('div')((props: any) => {
      // è¦å®ç°çš„å†…å®¹
  }),
);
```
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æ¶å­å·²ç»æ­èµ·æ¥ï¼Œè€æ ·å­ï¼Œä»ç„¶ä½¿ç”¨styleWrapåŒ…è£¹ä¸€å±‚å…¬å…±æ ·å¼ï¼Œå†…éƒ¨ç”¨ä¸€ä¸ªdivæ‰¿æ¥ï¼Œä¸­é—´è¦å®ç°çš„å†…å®¹åº”è¯¥è¿”å›è¦ä½¿ç”¨çš„cssï¼Œè¿™è¾¹æ˜¯æ ¸å¿ƒå†…å®¹ï¼š


```tsx
...
const {
    children,
    direction,
    wrap,
    justifyContent,
    alignItems,
    alignContent,
    span,
    flex,
    width,
    height,
    padding,
} = props;

...

return css`
    box-sizing: border-box;
    
    // direction
    ${direction != null &&
      css`
        flex-direction: ${direction};
      `}

    // wrap
    ${wrap != null &&
      css`
        flex-wrap: ${wrap};
      `}
      
    // justifyContent
    ${justifyContent != null &&
      css`
        justify-content: ${justifyContent};
      `}
      
    // ...
`
```
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å¯ä»¥çœ‹åˆ°ï¼Œåªæ˜¯ç®€å•åŠ ä¸€ä¸ªcssä¾¿å¯ä»¥å®ç°ï¼Œç›¸å½“ç®€å•ã€‚éœ€è¦è§£é‡Šçš„æ˜¯childrençš„å±æ€§å¹¶æ²¡æœ‰å…¬å¼€å£°æ˜ï¼Œè€Œæ˜¯ä¼ é€’ç»™`styled`ç”Ÿæˆçš„ç»„ä»¶åéšå¼çš„æ¸²æŸ“äº†ã€‚

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;åˆ›å»ºå®Œæ¯•åï¼Œåœ¨ç»„ä»¶å¤–ä¾¿å¯ä»¥è¿™æ ·å®ç°ï¼š


```tsx
<Box direction="column" justifyContent="center">
    <div>1</div>
    <div>2</div>
    <div>3</div>
</Box>
```

## 3. Combine
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Combineç»„ä»¶ç”¨äºç»„åˆä¸åŒçš„ç»„ä»¶ï¼Œç±»ä¼¼Boxï¼Œä»ç„¶æ˜¯æ ·å¼ä¸ºä¸»çš„ç»„ä»¶ï¼Œæ˜¯ä¸ºäº†å¸ƒå±€æ–¹ä¾¿çš„ï¼Œå¯¹cssè¿›è¡Œçš„å°è£…ã€‚æˆ‘ä»¬ä¸ä½¿ç”¨flexï¼Œä½¿ç”¨ä¸€ä¸ªå¤§divåŒ…è£¹ä¸€å †inline-blockå…ƒç´ å³å¯ã€‚åœ¨`src/components`ä¸‹æ–°å»ºæ–‡ä»¶å¤¹`Combine`ï¼Œåœ¨æ–‡ä»¶å¤¹ä¸‹æ–°å»ºæ–‡ä»¶`index.tsx`ï¼š


```tsx
const Combine = ({
  children,
  sharedProps = {},
  spacing = 'smart',
  separator,
  ...rest
}: CombineProps) => {
  const { size = 'md' } = sharedProps;
  let isFirstItem: boolean;
  return (
    <CombineWrap spacing={spacing} {...rest}>
        {React.Children.map(children, (child) => (
            // éå†child
            <>
                // æ”¾ç½®åˆ†éš”ç¬¦
                {separator && !isFirstItem ? <span className={separatorCls} key="separator">
                    {separator}
                  </span> : null
                }
                // æ”¾ç½®å­å…ƒç´ 
                <div className={itemCls}>
                    {React.cloneElement(child)}
                    ...
                </div>
            </>
          )
        )}
    </CombineWrap>
  )
}
```
ä¸Šè¾¹ä»£ç ä¸­å®šä¹‰äº†å­å…ƒç´ å’Œåˆ†éš”ç¬¦çš„ç±»ï¼š

```tsx
export const itemCls = prefixCls + '-item';
export const separatorCls = prefixCls + '-separator';
```

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ç»„ä»¶æ¥æ”¶spacingå‚æ•°æ¥æ§åˆ¶ç›¸å…³è”ç»„ä»¶ä¹‹é—´çš„è·ç¦»ï¼ŒåŒæ—¶è¿˜å¯ä»¥è®¾ç½®separatoræ¥ä½œä¸ºè‡ªå®šä¹‰åˆ†éš”ç¬¦ã€‚æ¥çœ‹ä¸€ä¸‹ç»„ä»¶`CombineWrap`çš„å®ç°ï¼š

```tsx
import styled from '@emotion/styled';
import { css } from '@emotion/core';

export const CombineWrap = styledWrap<{ spacing: string }>({
  // æ¥å—è‡ªå®šä¹‰class
  className: prefixCls,
})(
  // ç”Ÿæˆä¸€ä¸ªè‡ªå®šä¹‰æ ·å¼åŒ…è£¹çš„div
  styled('div')((props) => {
    const {
      spacing,
      theme: { designTokens: DT },
    } = props;
    
    // spacingMapä¸ºdesignTokensé‡Œå®šä¹‰çš„å¸¸é‡
    const space = (DT as any)[spacingMap[spacing]];

    return css`
      display: inline-block;  // inlinkä½¿å¾—å„ä¸ªå­å…ƒç´ å¹³é“ºæ’åˆ—
      vertical-align: middle;
      
      // å­å…ƒç´ æ ·å¼
      > .${itemCls} { 
        &:focus {
          z-index: 2;
        }
        &:hover {
          z-index: 3;
        }
      }
      
      // å­å…ƒç´ ä¸‹ä¸€ä¸ªå…„å¼Ÿï¼Œåˆ†éš”ç¬¦ä¸‹ä¸€ä¸ªå­å…ƒç´ ï¼Œå­å…ƒç´ ä¸‹ä¸€ä¸ªåˆ†éš”ç¬¦ ç»Ÿä¸€éƒ½åŠ ä¸Šå·¦è¾¹è·ï¼Œè¿™é‡Œå°±æ˜¯spaceçš„ç”¨æ³•
      > .${itemCls}+.${itemCls}, > .${separatorCls}+.${itemCls}, > .${itemCls}+.${separatorCls} {
        margin-left: ${space};
      }
    `;
  }),
);

```

å…³äºspacingå¸¸é‡ï¼Œå¯ä»¥åœ¨themeä¸»ä½“ä¸­å®šä¹‰å¸¸é‡ï¼š

```js
T_SPACING_COMMON_XS: '4px',
T_SPACING_COMMON_SM: '8px',
T_SPACING_COMMON_MD: '12px',
T_SPACING_COMMON_LG: '16px',
T_SPACING_COMMON_XLG: '20px',
T_SPACING_COMMON_XXLG: '24px',
T_SPACING_COMMON_XXXLG: '32px',
```

ç„¶åæˆ‘ä»¬åœ¨é¡¹ç›®ä¸­ä½¿ç”¨ä¸€ä¸‹ï¼š

```tsx
<Combine>
  <Button styleType="primary">æŒ‰é’®ç»„å±•ç¤º</Button>
  <Button>æŒ‰é’®ç»„å±•ç¤º</Button>
  <Button>æŒ‰é’®ç»„å±•ç¤º</Button>
  <Button disabled>æŒ‰é’®ç»„å±•ç¤º</Button>
</Combine>
```


è‡³æ­¤ï¼Œå¸ƒå±€ç»„ä»¶`Box`å’Œ`Combine`å·²ç»ä»‹ç»å®Œæ¯•~  æ›´å¤šç»„ä»¶å‚ç…§ä»£ç ä»“åº“ï¼š[Githubä»“åº“](https://github.com/heiheihoho1213/dux-ui)

### å‚è€ƒ

[React-components](https://ucloud-fe.github.io/react-components/)

[Antdä¹‹Spaceå’ŒGrid](https://ant.design/components/grid-cn/)82:T3b59,## 1. å‰è¨€

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æ‰¿æ¥ä¸Šä¸€ç¯‡[æ‰‹æŠŠæ‰‹æ­å»ºåŸºäºReactçš„å‰ç«¯UIåº“ï¼ˆäºŒï¼‰-- ä¸»é¢˜é…ç½®](https://juejin.cn/post/7076652936331280421/)ã€‚åœ¨ä¸»é¢˜é…ç½®ä¹‹åï¼Œæˆ‘ä»¬ç€æ‰‹å†™ä¸€äº›åŸºç¡€ç»„ä»¶ä»¥åŠå…¶å‘¨è¾¹çš„é…ç½®å·¥å…·ã€‚ï¼ˆæœ¬æœŸç”¨åˆ°çš„styleWrapçš„å®šä¹‰å¯æŸ¥çœ‹ä¸ŠæœŸï¼‰

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æœ¬æ–‡çš„ä»£ç å±•ç¤ºçš„æ˜¯ä¸»è¦çš„æ ¸å¿ƒä»£ç ï¼Œå…¨éƒ¨ä»£ç è§ä»“åº“ï¼š[Githubä»“åº“](https://github.com/heiheihoho1213/dux-ui)


## 2. Icon

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å›¾æ ‡çš„è®¾è®¡æ˜¯ä¸ªæŠ€æœ¯æ´»ï¼Œéœ€è¦è®¾è®¡å‡ºè‡ªå·±ä¸“å±çš„é£æ ¼ï¼Œå°±åƒä¸Šä¸€æœŸä¸€å¼€å§‹è®²çš„é‚£æ ·ï¼ŒStyleé£æ ¼è®¾è®¡æ˜¯ä¸‰è¦ç´ ä¹‹é¦–ã€‚åŸºç¡€ç»„ä»¶è®¾è®¡ï¼Œæ¯”å¦‚æŒ‰é’®æ˜¯æ‰å¹³è¿˜æ˜¯ç«‹ä½“ï¼Œè¾“å…¥æ¡†æ˜¯æ–¹è§’è¿˜æ˜¯åœ†è§’ï¼ŒåŠ ä¸åŠ é˜´å½±ç­‰è¿™äº›ï¼Œå—é¡¹ç›®ç»ç†. äº§å“å’Œäº¤äº’çš„å½±å“ä¼šå¤šä¸€ç‚¹ï¼Œä½†æ˜¯å¤§ä½“æ¥è¯´ï¼Œåº”ä¸å…¬å¸åŒç±»äº§å“ä¿æŒä¸€è‡´ï¼Œè‡³äºå¦‚ä½•è®¾è®¡ï¼Œé‚£å°±æ˜¯å¦å¤–çš„è¯¾é¢˜äº†ï¼Œä¸åœ¨æœ¬æ–‡çš„è®¨è®ºä¹‹åˆ—ã€‚

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æœ¬æ–‡ä¸­çš„Iconå›¾æ ‡ä½¿ç”¨å­—ä½“åº“æ¥å®Œæˆï¼Œé€šè¿‡CSSæ— ä¾µå…¥å¼çš„åœ¨ä¸€ä¸ªå…ƒç´ ä¸ŠåŠ å…¥`before`æˆ–è€…`after`ä¼ªç±»æ¥å®ç°å›¾æ ‡æ˜¾ç¤ºï¼Œè¿™é‡Œä¸æ˜¯æµè§ˆå™¨çš„å­—ä½“ï¼Œä¹Ÿä¸æ˜¯å®¢æˆ·ç”µè„‘é‡Œå®‰è£…çš„å­—ä½“ï¼Œä¹Ÿä¸æ˜¯å›¾ç‰‡æˆ–å…¶ä»–æ–¹å¼ï¼Œè€Œä¸”æ˜¯ä»¥æ–‡å­—çš„æ–¹å¼æ˜¾ç¤ºï¼Œè¿™æ ·åšç›¸å¯¹æ¯”è¾ƒç®€æ´ï¼Œæ–¹ä¾¿ä¿®æ”¹ï¼Œæ›´é‡è¦çš„æ˜¯åˆ©äºSEOä¼˜åŒ–ã€‚æµè§ˆå™¨å…¼å®¹æ€§æ¯”è¾ƒå¥½çš„å­—ä½“åº“æœ‰`WOFF`. `WOFF2`ç­‰ã€‚å­—ä½“åº“å…¼å®¹æ€§è§[å®˜æ–¹è§£é‡Š](https://developer.mozilla.org/zh-CN/docs/Web/CSS/@font-face)ã€‚å­—ä½“åº“æœ‰ä¸“é—¨çš„è‡ªå®šä¹‰ç”Ÿæˆå·¥å…·ï¼Œä¾‹å¦‚[fonteditor](http://www.fonteditor.com/)ï¼Œå¯ä»¥è¯•ç”¨30å¤©ï¼›è‡³äºå­—ä½“åº“ï¼Œä½ ä¹Ÿå¯ä»¥ä½¿ç”¨ç¬¬ä¸‰æ–¹å¼€æºçš„å­—ä½“åº“ï¼Œä¾‹å¦‚[Font Awesome](https://fontawesome.dashgame.com/)ã€‚è¿™é‡Œä½œè€…å°±ä½¿ç”¨Font Awesomeçš„woffå­—ä½“åº“ï¼Œæˆ‘ä»¬æ‰“å¼€å›¾å½¢åˆ›å»ºå·¥å…·fonteditoræ¥æŸ¥çœ‹è¿™ä¸ªæ–‡ä»¶ï¼š

![image.png](/img/posts/2022-3-19/2022-3-19-6.png)


&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å¯ä»¥çœ‹åˆ°ï¼Œæ¯ä¸€ä¸ªIconéƒ½æœ‰å¯¹åº”çš„`Code-points`ï¼Œè¿™æ ·æˆ‘ä»¬å°±èƒ½é€šè¿‡CSSæ¥é…ç½®å­—ä½“å›¾æ ‡äº†ï¼š

```css
// ä¸Šå›¾ä¸­ç»ç’ƒæ¯
.glass:before {
    content: '\F000';
}
```
è®¾è®¡æ€è·¯æœ‰äº†ï¼Œæ¥ä¸‹æ¥å°±å¼€å§‹åŠ¨å·¥ï¼

### Icon.tsx
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;åœ¨`src/components`æ–‡ä»¶å¤¹ä¸‹ï¼Œæ–°å»ºæ–‡ä»¶å¤¹`Icon`ï¼Œåœ¨è¯¥æ–‡ä»¶å¤¹ä¸‹æ–°å»º`Icon.tsx`ï¼š

```tsx
// å®šä¹‰æ¥æ”¶å‚æ•°
export interface IconProps {
    /** å›¾æ ‡ç±»å‹ */
    type: string;
    /** æ˜¯å¦æ—‹è½¬ */
    spin?: boolean;
    /** è‡ªå®šä¹‰ icon ç±»åå‰ç¼€ï¼Œä½¿ç”¨è‡ªå®šä¹‰å›¾æ ‡åº“æ—¶ä½¿ç”¨ï¼Œé»˜è®¤ä¸º icon\_\_ */
    prefix?: string;
}

// å›¾æ ‡æ§ä»¶
const Icon = ({
    type,
    spin,
    prefix,
    className,
    ...rest
}) => {
    const configContext = useContext(ConfigContext);
    const finalPrefix = useMemo(() => prefix || configContext.iconDefaultPrefix || 'icon__', [
        configContext.iconDefaultPrefix,
        prefix
    ]);
    return (
        <IconWrap
            className={classnames(prefixCls, `${finalPrefix}${type}`, spin && `${prefixCls}-spin`, className)}
            spin={spin}
            {...rest}
        />
    );
};

export default React.memo(Icon);
```
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;è¿™é‡Œå¯ä»¥çœ‹åˆ°ï¼Œæˆ‘åœ¨å…¨å±€`configContext`å®šä¹‰äº†é»˜è®¤çš„å›¾æ ‡ç±»åå‰ç¼€ï¼Œé»˜è®¤ä¸º`icon__`ï¼Œä½ ä¹Ÿå¯ä»¥è‡ªå®šä¹‰ï¼Œåªè¦å’ŒCSSæ ·å¼å¯¹åº”å³å¯ã€‚æœ€åè¿”å›çš„æ˜¯ä¸€ä¸ª`IconWrap`ç»„ä»¶ï¼Œæˆ‘ä»¬åœ¨`Icon`æ–‡ä»¶å¤¹ä¸‹æ–°å»º`style`æ–‡ä»¶å¤¹æ¥æ”¾ç½®æ ·å¼åŒ…è£¹ç±»ï¼Œ`style`ä¸‹è®¾ç½®`font`æ–‡ä»¶å¤¹æ¥å®‰ç½®æˆ‘ä»¬ä¸‹è½½çš„WOFFæ–‡ä»¶ï¼Œå¹¶åœ¨`style`åŒç›®å½•ä¸‹æ–°å»º`icon.css`å’Œ`index.ts`ï¼š

src/components/Icon/style/icon.cssï¼š

```css
/* è‡ªå®šä¹‰ä¸“å±çš„å­—ä½“ç±»å‹ */
@font-face {
    font-family: duiicon;
    /* src: url(./fonts/duiicon.eot?v=1552285261926); */
    src: url(./fonts/fontawesome-webfont.woff) format('woff');
    font-weight: 400;
    font-style: normal;
}

...
/* è®¾ç½®å­—ä½“å¯¹åº”çš„ç±» */
[class*=' icon__']:before,
[class^='icon__']:before {
    display: inline-block;
}
.icon__glass:before {
    content: '\F000';
}
...
```

src/components/Icon/style/index.ts:

```ts
import styled from '@emotion/styled';
import { css } from '@emotion/core';

// spinMixinæ˜¯å…¬å…±çš„æ—‹è½¬æ ·å¼ï¼Œè¯¦è§å…¨éƒ¨ä»£ç 
const iconSpinMixin = css`
    ${spinMixin};
    line-height: normal;
`;

export const IconWrap = styleWrap<{ spin?: boolean }>({})(
    styled('i')(props => {
        const { spin } = props;

        return css`
            vertical-align: baseline;
            &&& {
                ${spin && iconSpinMixin};
            }
        `;
    })
);
```
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ä»ä»£ç ä¸­çœ‹åˆ°ï¼Œè™½ç„¶è¿™é‡Œé¢æ²¡æœ‰ç”¨åˆ°ä¸»é¢˜æ ·å¼çš„å˜é‡ï¼Œä½†ä¸ºäº†é£æ ¼ç»Ÿä¸€ï¼Œè¿™é‡Œç”¨`styleWrap`åŒ…è£¹ä¸€ä¸‹ï¼Œä¸ç»™è¾“å…¥å‚æ•°å³å¯ï¼Œå…¶è¿”å›çš„ä»ç„¶æ˜¯ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œæ¥å—ä¸€ä¸ªå‡½æ•°å¼ç»„ä»¶ä½œä¸ºå‚æ•°ï¼Œè¿™é‡Œä¼ é€’ä¸€ä¸ªiæ ‡ç­¾ï¼š`styled('i')`ï¼Œå‚æ•°`props`æ˜¯ç»„ä»¶`IconWrap`æ¥å—çš„å‚æ•°ï¼Œå¦‚æœæœ‰spinæ—‹è½¬ï¼Œé‚£å°±åŠ ä¸Šæ—‹è½¬çš„æ ·å¼ã€‚

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å…³äºå‰ç¼€çš„æ‹¼æ¥ï¼Œæˆ‘è¿™é‡Œè¯´ä¸€ä¸‹ï¼š

```js
classnames(prefixCls, `${finalPrefix}${type}`, spin && `${prefixCls}-spin`, className)
```
ç¬¬ä¸€æ®µæ˜¯å…¬å…±æ ·å¼ï¼Œè¿™é‡Œä¸º`dux-ui-icon`ï¼Œå¯ä»¥ç†è§£ä¸ºæ¥è‡ªç»„ä»¶åº“çš„æ ‡è¯†ï¼Œä¹Ÿæ–¹ä¾¿ç”¨æˆ·åœ¨ä½¿ç”¨æ—¶æ‰¹é‡æ·»åŠ æ ·å¼ï¼›ç¬¬äºŒæ®µå°±æ˜¯æˆ‘ä»¬ä»£ç ä¸­æ‹¼æ¥çš„`icon__glass`ç­‰ï¼Œç”¨äºå®é™…å›¾æ ‡æ˜¾ç¤ºï¼›ç¬¬ä¸‰æ®µæ˜¯æ—‹è½¬æ ‡è¯†ï¼›ç¬¬å››æ®µæä¾›äº†ç”¨æˆ·è‡ªå®šä¹‰classã€‚

ç°åœ¨ï¼Œä»£ç ç›®å½•ç»“æ„å¦‚ä¸‹ï¼š

![image.png](/img/posts/2022-3-19/2022-3-19-7.png)

å½“ç„¶åˆ«å¿˜äº†åœ¨`src/index`å¯¼å‡ºï¼š

```ts
export { default as Icon } from './components/Icon';
```

### Icon demo

æˆ‘ä»¬åœ¨åŒç›®å½•ä¸‹çš„`index.md`ä¸­å†™ä¸Šdemoç”¨ä¾‹ï¼š

```tsx
import React from 'react';
// dumi-dux-uiè¦ä¸ä½ package.jsonä¸­çš„nameä¸€è‡´
import { Icon } from 'dumi-dux-ui';
import Copy from 'copy-to-clipboard';

// demo start
const layout = {
    style: {
        marginRight: 10
    }
};

const Icons = [
    'glass',
];
const TypeDemo = () => (
    <div style={{ display: "flex" }}>
        {Icons.map(item => (
            <div key={item} style={{ width: '50px', height: '50px', cursor: 'pointer' }} onClick={() => Copy(item)}>
                <Icon type={item} {...layout} />
            </div>
        ))}
    </div>
);
```
ä¿®æ”¹`.umirc.ts`ï¼š

```ts
...
menus: {
    // éœ€è¦è‡ªå®šä¹‰ä¾§è¾¹èœå•çš„è·¯å¾„ï¼Œæ²¡æœ‰é…ç½®çš„è·¯å¾„è¿˜æ˜¯ä¼šä½¿ç”¨è‡ªåŠ¨ç”Ÿæˆçš„é…ç½®
    '/components': [
      {
        title: 'ç»„ä»¶',
        path: '/components',
        children: [
          // èœå•å­é¡¹ï¼ˆå¯é€‰ï¼‰
          'components/Icon/index.md',
        ],
      },
    ],
  },
```

ç„¶ååœ¨æ ¹ç›®å½•ä¸‹æ‰§è¡Œï¼š`npm run docs`ï¼Œæ‰“å¼€æµè§ˆå™¨ï¼Œè¿›å…¥localhost:8000/components/iconå³å¯çœ‹åˆ°ï¼š

![image.png](/img/posts/2022-3-19/2022-3-19-8.png)

æˆ‘ä»¬çš„ç»ç’ƒæ¯å›¾æ ‡åŠ è½½å‡ºæ¥äº†ï¼F12æŸ¥çœ‹å…ƒç´ ï¼Œç¡®å®æ˜¯æˆ‘ä»¬æƒ³è¦çš„åŠ è½½æ–¹å¼ï¼š

![image.png](/img/posts/2022-3-19/2022-3-19-9.png)


> å…³äº @emotionä¸­çš„`styled`å’Œ`css`æ–¹æ³•ï¼Œå¯ä»¥é¿å…ä½¿ç”¨å¤–æŒ‚cssæ–‡ä»¶ï¼ŒåŒæ—¶ç»„ä»¶ä¼ é€’å‚æ•°æ›´åŠ æ–¹ä¾¿ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥å®Œå…¨ä¸ç”¨styledï¼Œå¦‚ä¸‹é¢ä»£ç æ‰€ç¤ºï¼Œå…¶æ•ˆæœæ˜¯ç­‰ä»·çš„ã€‚è¯¦ç»†ä½¿ç”¨å¯ä»¥æŸ¥çœ‹[emotionå®˜ç½‘](http://emotion.sh/docs)


```tsx
function Content(props: any) {
    // propsçš„å±æ€§éœ€è¦ç‰¹æ®Šå¤„ç†ï¼Œå¯ä¼ é€’classNameå±æ€§ï¼Œé€šè¿‡å¤–æŒ‚csså®ç°ç›¸åŒçš„æ ·å¼
    ...
    return <i {...props}></i>
}

export const IconWrap = styleWrap<{ spin?: boolean }>({})(Content);
```

---

## 3. Button

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æŒ‰é’®ä¸€èˆ¬ä¼šåˆ†ç±»åˆ«ï¼Œä¸åŒçš„ç±»åˆ«æœ‰ä¸åŒçš„é¢œè‰²ï¼Œæˆ‘ä»¬åˆ†ä¸ºå®å¿ƒï¼Œè¾¹æ¡†ç©ºå¿ƒå’Œç¦ç”¨ä¸‰ç§æ¨¡å¼ã€‚ä¸‹é¢åˆ—ä¸€ä¸ªè¡¨æ ¼è¯´æ˜æ‰€æœ‰çš„buttonæ ·å¼ï¼š


| ç±»åˆ«åç§° | ç§ç±»åé›†åˆ |
| --- | --- |
| StyleTypes ç§ç±» | ['primary', 'warning', 'success', 'error', 'border', 'border-gray'] |
| Sizes å¤§å° | ['sm', 'md', 'lg'] |
| Shapes å½¢çŠ¶ | ['circle', 'square'] |
| Shadowed é˜´å½± | ['true', 'false'] |
| Loading åŠ è½½ | ['true', 'false'] |
| Disabled ç¦ç”¨ | ['true', 'false'] |
| Block å—çº§æ˜¾ç¤º | ['true', 'false'] |

æˆ‘ä»¬æ ¹æ®ç½—åˆ—çš„ç±»å‹ï¼Œå¼€å§‹æ­å»ºç»„ä»¶ï¼

### æ­å»ºåŸºç¡€

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æˆ‘ä»¬åœ¨`src/components`æ–‡ä»¶å¤¹ä¸‹æ–°å»ºæ–‡ä»¶å¤¹`Button`ï¼Œåœ¨è¯¥ç›®å½•ä¸‹æ–°å»ºæ–‡ä»¶`index.tsx`ï¼š


```tsx
// å®šä¹‰æ¥å—å‚æ•°ï¼Œä¸ºè¡¨æ ¼ä¸­ç½—åˆ—å±æ€§
export interface ButtonProps {
  /** æŒ‰é’®ç±»å‹ */
  styleType?: 'primary' | 'warning' | 'success' | 'error' | 'border' | 'border-gray';
  /** æŒ‰é’®å°ºå¯¸ */
  size?: 'sm' | 'md' | 'lg';
  /** å½¢çŠ¶ */
  shape?: 'circle' | 'square';
  /** é˜´å½± */
  shadowed?: boolean;
  /** ä¸»é¢˜ */
  // theme?: 'dark';
  /** æ˜¯å¦åŠ è½½ä¸­ */
  loading?: boolean;
  /** å›¾æ ‡ */
  icon?: string | ReactNode;
  /** è®¾ç½®åŸç”Ÿçš„ button ä¸Š type å±æ€§ */
  type?: string;
  /** å±•ç¤ºè®¾ç½®ä¸ºå—å…ƒç´  */
  block?: boolean;
}
```
åŒæ ·çš„ï¼Œæˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ªæ ·å¼ç±»åŒ…è£¹ä¸€ä¸‹åŸç”Ÿçš„buttonï¼ˆè¿˜æ˜¯åœ¨è¿™ä¸ªæ–‡ä»¶ï¼‰ï¼š

```tsx
...
render() {
    // eslint-disable-next-line @typescript-eslint/no-unused-vars
    const { loading, icon, children, ...rest } = this.props;

    return (
      <StyleButton loading={loading} {...rest}>
        // renderIconä¸ºæŒ‚è½½æŒ‰é’®å†…å›¾æ ‡çš„å‡½æ•°
        {this.renderIcon()}
        {children}
      </StyleButton>
    );
  }
```
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æ¥ä¸‹æ¥å»åˆ›å»º`StyleButton`ï¼Œä¸Iconåˆ›å»ºä¸€æ ·åœ°ï¼Œæˆ‘ä»¬åœ¨`src/components/Button`æ–‡ä»¶å¤¹ä¸‹æ–°å»º`style`æ–‡ä»¶å¤¹ï¼Œåœ¨è¯¥æ–‡ä»¶å¤¹ä¸‹æ–°å»º`index.tsx`ï¼Œæ ¸å¿ƒä»£ç åœ¨è¿™é‡Œï¼š

```tsx
...
const Button = ({
  loading,
  styleType,
  disabled,
  onClick,
  block,
  shadowed,
  ...rest
}) => (
  <button
    disabled={disabled}
    onClick={!disabled ? onClick : undefined}
    {...rest}
  />
);

export const StyleButton = styleWrap<SButtonProps, HTMLButtonElement>({
  className: classNameMixin,
})(styled(Button)(buttonStyleMixin));

```
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å®šä¹‰ä¸€ä¸ªå«Buttonçš„å‡½æ•°å¼ç»„ä»¶ï¼Œå…¶è¿”å›çš„å°±æ˜¯ä¸€ä¸ªåŸç”Ÿçš„buttonï¼Œæ‰€ä»¥restå‚æ•°é‡Œä½ å¯ä»¥ä¼ é€’åŸç”Ÿçš„å±æ€§ï¼Œæœ€åç”¨styleWrapåŒ…è£¹åå¯¼å‡ºã€‚ä¸Iconä¸åŒçš„æ˜¯ï¼ŒButtonçš„æ ·å¼æ›´å¤šï¼Œè€Œä¸”è¿˜è¦é€‚é…ä¸»é¢˜ã€‚æ‰€ä»¥è¿™é‡Œå¤šäº†ä¸€ä¸ªç±»åå£°æ˜`classNameMixin`å’Œä¸€ä¸ªæ ·å¼å‡½æ•°`buttonStyleMixin`.

classNameMixinï¼š
```tsx
// classNameMixinè´Ÿè´£æ·»åŠ å„ç§ç±»åï¼Œç”¨äºå”¯ä¸€è¯†åˆ«å’Œå¼€å‘è€…è¿›è¡Œå®šåˆ¶
const classNameMixin = ({
  size,
  styleType,
  shape,
  loading,
  disabled,
  checked,
}) =>
  classnames(
    prefixCls,
    `${prefixCls}-size-${size}`,
    `${prefixCls}-styletype-${styleType}`,
    shape && `${prefixCls}-${shape}`,
    loading && `${prefixCls}-loading`,
    disabled && `${prefixCls}-disabled`,
    checked && `${prefixCls}-checked`,
  );
```

buttonStyleMixinæ˜¯ä¸€ä¸ªæ€»å¼€å…³ï¼Œç”¨äºæ·»åŠ å„ç§æ ·å¼ï¼š

```tsx
// buttonStyleMixin
const buttonStyleMixin = (props) => {
  const { theme, loading, shape, checked, block } = props;
  const { designTokens: DT } = theme;
  return css`
    margin: 0;
    box-sizing: border-box;
    border-radius: ${DT.T_CORNER_LG};
    text-align: center;
    text-decoration: none;
    cursor: pointer;
    outline: none;
    font-size: ${DT.T_TYPO_FONT_SIZE_1};
    white-space: nowrap;
    ${inlineBlockWithVerticalMixin};  // å—çº§

    ${sizeMixin(props)};  // å¤§å°
    ${styleTypeMixin(props)};  // styleType
    ${shape && shapeMixin(props)}; // å½¢çŠ¶
    ${loading && loadingMixin(props)};  // åŠ è½½ä¸­
    ${block &&
    css`
      width: 100%;
    `};
  `;
};
```
æ¥ä¸‹æ¥åˆ†åˆ«è®°å½•ä¸Šè¿°å„ä¸ªæ ·å¼å˜é‡ï¼š

sizeMixinï¼š

```tsx
// é€šè¿‡getHeightBySizeæ‹¿åˆ°ä¸»é¢˜é…ç½®æ–‡ä»¶ä¸­çš„å„ä¸ªå¤§å°
...
return css`
    height: ${getHeightBySize(DT, size)};
    line-height: ${getHeightBySize(DT, size)};
    padding: 0 ${getPaddingBySize(DT, size)};
`;
...
```

shapeMixinï¼š

```tsx
...
// ç›®å‰æ”¯æŒåœ†å½¢å’Œæ–¹å½¢
switch (shape) {
    case 'circle':
      return css`
        border-radius: 50% !important;
        padding: 0;
        overflow: hidden;
        width: ${getHeightBySize(DT, size)};
      `;
    case 'square':
      return css`
        padding: 0;
        overflow: hidden;
        width: ${getHeightBySize(DT, size)};
      `;
    default:
      return css``;
}
```

loadingMixinçš„è®¾ç½®ä¹Ÿä¸€æ ·ï¼Œä½¿å¾—é¼ æ ‡ä¸å¯ç‚¹å‡»ï¼Œæš—ç°è‰²æ˜¾ç¤ºå³å¯ã€‚

styleTypeMixinç”¨æ¥é€šè¿‡styleTypeçš„ä¸åŒï¼Œå¯¹åº”çš„è®¾ç½®ä¸åŒçš„ä¸»é¢˜é…è‰²ï¼Œ ä»¥primaryä¸ºä¾‹ï¼š

```tsx
const {
  // æ¥å—ThemeProviderä¼ é€’çš„themeå‚æ•°
  theme: { designTokens: DT },
  styleType,
  disabled,
  size,
  shadowed,
} = props;

...
primary: {
  background: DT.T_BUTTON_PRIMARY_COLOR_BG_DEFAULT,
  ':hover,:active': {
    background: DT.T_BUTTON_PRIMARY_COLOR_BG_HOVER,
    boxShadow: shadowed ? DT.T_SHADOW_BUTTON_PRIMARY_HOVER : 'none',
  },
  color: DT.T_BUTTON_PRIMARY_COLOR_TEXT_DEFAULT,
  fill: DT.T_BUTTON_PRIMARY_COLOR_TEXT_DEFAULT,
  border: 'none',
  boxShadow: shadowed ? DT.T_SHADOW_BUTTON_PRIMARY : 'none',
  transition: `${transitionProperty} ${transitionFlat}`,
  ':link,:visited': {
    color: DT.T_BUTTON_PRIMARY_COLOR_TEXT_DEFAULT,
  },
},
...
```
å¯ä»¥çœ‹åˆ°ï¼Œå½“`styleType='primary'æ—¶`ï¼Œè®¾ç½®äº†å…¶èƒŒæ™¯è‰². æ–‡å­—é¢œè‰². å¡«å……è‰². æ¸å˜. è¿‡æ¸¡. æ¿€æ´»æ—¶çš„æ ·å¼ä»¥åŠè¢«è®¿é—®åçš„æ ·å¼ç­‰ã€‚

å¦‚æ­¤ï¼Œä¸€ä¸ªç®€å•çš„Buttonç»„ä»¶å°è£…è£…å¥½äº†ï¼Œæˆ‘ä»¬åªæ˜¯å¯¹æ ·å¼è¿›è¡Œäº†æ”¹åŠ¨ï¼Œå…¶æœ¬è´¨è¿˜æ˜¯è¿”å›äº†ä¸€ä¸ªåŸç”ŸæŒ‰é’®ï¼ŒåŸæ¥çš„äº‹ä»¶ä¸å½±å“ä½¿ç”¨ã€‚

### Button demo

æˆ‘ä»¬å†™ä¸ªdemoæµ‹è¯•ä¸€ä¸‹ã€‚åœ¨`src/components/Button`ä¸‹æ–°å»º`index.md`ï¼š

```tsx
import React from 'react';

import { Button } from 'dumi-dux-ui';

// demo start
const { StyleTypes } = Button;

const ColorDemo = () => {
  return (
    <div>
      {StyleTypes.map((type) => (
        <Button styleType={type} key={type} onClick={() => console.log('clicked')}>
          Button
        </Button>
      ))}
    </div>
  );
};
// demo end

export default ColorDemo;
```
åœ¨`.umirc.ts`ä¸­åŠ å…¥ï¼š

```js
...
menus: {
    // éœ€è¦è‡ªå®šä¹‰ä¾§è¾¹èœå•çš„è·¯å¾„ï¼Œæ²¡æœ‰é…ç½®çš„è·¯å¾„è¿˜æ˜¯ä¼šä½¿ç”¨è‡ªåŠ¨ç”Ÿæˆçš„é…ç½®
    '/components': [
      {
        title: 'ç»„ä»¶',
        path: '/components',
        children: [
          // èœå•å­é¡¹ï¼ˆå¯é€‰ï¼‰
          'components/Icon/index.md',
          'components/Button/index.md',
        ],
      },
    ],
  },
```

æ ¹ç›®å½•ä¸‹æ‰§è¡Œ`npm run docs`ï¼Œ ä¸å‡ºæ„å¤–çš„è¯ï¼Œåœ¨localhost:8000/components/buttonä¸‹å¯ä»¥çœ‹åˆ°ï¼š

![image.png](/img/posts/2022-3-19/2022-3-19-10.png)
F12æµ‹è¯•ç‚¹å‡»äº‹ä»¶ï¼š

![image.png](/img/posts/2022-3-19/2022-3-19-11.png)

è‡³æ­¤ï¼ŒåŸºç¡€ç»„ä»¶Iconå’ŒButtonçš„è®°å½•å°±åˆ°æ­¤ç»“æŸäº†ã€‚ä¸‹ä¸€æœŸä¼šè®°å½•å¸ƒå±€ç»„ä»¶çš„æ­å»ºï¼Œæ•¬è¯·æœŸå¾…~


---

å‚è€ƒï¼š
[antdæ ·å¼è®¾è®¡](https://ant.design/docs/spec/values-cn) 
[Material UIè®¾è®¡](https://mui.com/zh/components/buttons/)83:T2957,## 1. å‰è¨€

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æ‰¿æ¥ä¸Šä¸€ç¯‡[æ‰‹æŠŠæ‰‹æ­å»ºåŸºäºReactçš„å‰ç«¯UIåº“ ï¼ˆä¸€ï¼‰-- é¡¹ç›®åˆå§‹åŒ–](https://juejin.cn/post/7074915729601986567)ï¼Œå¦‚æœæ²¡æœ‰çœ‹è¿‡é¡¹ç›®æ­å»ºçš„ï¼Œå¯ä»¥ç‚¹å‡»å‰è¾¹çš„é“¾æ¥ã€‚åœ¨dumié¡¹ç›®æ­å»ºå®Œæ¯•åï¼Œæˆ‘ä»¬ç€æ‰‹å†™ä¸€ä¸‹å…¨å±€ä¸»é¢˜é…ç½®ã€‚

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æœ¬æ–‡çš„ä»£ç å±•ç¤ºçš„æ˜¯ä¸»è¦çš„æ ¸å¿ƒä»£ç ï¼Œå…¨éƒ¨ä»£ç è§ä»“åº“ï¼š[Githubä»“åº“](https://github.com/heiheihoho1213/dux-ui)

## 2. UIåº“ä¸‰è¦ç´ 

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;åœ¨å†³å®šè¦å†™æ ¸å¿ƒç»„ä»¶ä¹‹å‰ï¼Œé¦–å…ˆè¦ç¡®å®šè¿™ä¹ˆå‡ ä¸ªæ³¨æ„äº‹é¡¹ï¼š

- `1. Styleé£æ ¼`
- `2. é€‚é…æ€§`
- `3. å†…å®¹é€‚åº”æ€§`

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`Styleé£æ ¼`å¯ä»¥åŒ…å«ç»„ä»¶åº“çš„è‰²å½©è®¾è®¡ï¼Œè§†è§‰é£æ ¼è®¾è®¡ï¼Œå­—ä½“ï¼ŒåŠ¨ç”»æ•ˆæœï¼Œä¸»é¢˜çš®è‚¤å’Œä¸€äº›åŸºç¡€æ ·å¼çš„è®¾è®¡ç­‰ï¼›`é€‚é…æ€§`åˆ™è¡¨ç¤ºè¦è€ƒè™‘ç»„ä»¶åº“è¦è¿è¡Œåœ¨ä»€ä¹ˆå¹³å°ï¼Œæ˜¯PCç«¯è¿˜æ˜¯ç§»åŠ¨ç«¯ï¼Œæˆ–è€…æ˜¯å…¼å®¹å…¶ä»–å¹³å°ç­‰ï¼›`å†…å®¹é€‚åº”æ€§`æŒ‡çš„æ˜¯ç»„ä»¶åŒ…å«çš„åŠŸèƒ½èŒƒå›´ï¼Œæ–‡æ¡ˆå‹å¥½åº¦ï¼Œæ˜¯å¦è€ƒè™‘å›½é™…åŒ–ï¼Œå¯¹å¼€å‘è€…æ˜¯å¦å‹å¥½ç­‰é—®é¢˜ã€‚è¿™äº›è®¾è®¡é£æ ¼ä»è€…è§ä»ï¼Œåœ¨ä¹‹åçš„æ–‡ç« ä¸­ä¼šé™†ç»­è®°å½•æˆ‘æ˜¯å¦‚ä½•è®¾è®¡çš„ã€‚

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;åŸºäºä¸Šè¿°åŸåˆ™ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆä»ä¸»é¢˜è‰²å½©å…¥æ‰‹ã€‚

<hr />

## 3. ThemeProvider

Themeå’Œæ ·å¼è‡ªç„¶æ˜¯å±äºå…¨å±€çš„ï¼Œæˆ‘ä»¬ç”¨ä¸€ä¸ª`provider`æ¥æ‰¿æ¥ã€‚

### ThemeProvider.tsx

åœ¨`src/components`ä¸‹æ–°å»ºä¸€ä¸ªæ–‡ä»¶å¤¹`ThemeProvider`ï¼Œåœ¨è¯¥æ–‡ä»¶å¤¹ä¸‹æ–°å»ºä¸€ä¸ªæ–‡ä»¶`ThemeProvider.tsx`ï¼š

```tsx
class ThemeProvider extends Component {
    ...
}
```


åœ¨`src/components/ThemeProvider/ThemeProvider.tsx`ä¸­æ·»åŠ propsï¼Œå…¶ä¸­çš„themeè¡¨ç¤ºå½“å‰çš„ä¸»é¢˜ï¼š

```tsx
static propTypes = {
    /**
     * è‡ªå®šä¹‰ä¸»é¢˜
     */
    theme: PropTypes.object.isRequired
};
```

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æ¥ä¸‹æ¥å®‰è£…ä¸€ä¸ªç¬¬ä¸‰æ–¹ä¾èµ–`emotion-theming`æ¥æä¾›ä¸»é¢˜åŒ–çš„è§£å†³æ–¹æ¡ˆï¼Œè¯¦ç»†é…ç½®å¯æŸ¥çœ‹å…¶[ä¸»é¡µ](https://emotion.sh/docs/theming#themeprovider-reactcomponenttype)ï¼Œå°±å½“åšæ˜¯ä¸€ä¸ªå…¨å±€çš„`context`æ¥ç®¡ç†çŠ¶æ€å§ã€‚æ‰§è¡ŒæŒ‡ä»¤ï¼š
```sh
npm i --save emotion emotion-theming @emotion/core @emotion/styled
```

ç„¶åå®šä¹‰æ„é€ å™¨å’Œæ¸²æŸ“å‡½æ•°ï¼š
```tsx
import React, { Component } from 'react';
import _ from 'lodash';
import PropTypes from 'prop-types';
import { ThemeProvider as EThemeProvider } from 'emotion-theming';

constructor(props: any) {
    super(props);
    const theme = props.theme;
 
    this.state = {
        theme
    };
}
...
render() {
    // eslint-disable-next-line no-unused-vars
    const { theme: _theme, ...rest } = this.props as any;
    const { theme } = this.state;
    return <EThemeProvider theme={theme} {...rest} />;
}
```

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ç•™å¿ƒçš„æœ‹å‹å¯èƒ½ä¼šæ³¨æ„åˆ°ï¼Œæˆ‘è¿™é‡Œçš„stateä¸­çš„themeæ˜¯å†™åœ¨æ„é€ å™¨ä¸­çš„ï¼Œåœ¨æŒ‚è½½çš„æ—¶å€™åªæ‰§è¡Œä¸€æ¬¡ï¼Œå¦‚æœç”¨æˆ·æƒ³è¦åˆ‡æ¢ä¸»é¢˜ï¼Œå¿…ç„¶ä¼šé€šè¿‡`props`ä¼ é€’æ–°çš„themeå€¼ï¼Œæˆ‘ä»¬è¿™é‡Œæ£€æµ‹propså˜åŒ–ï¼š

```tsx
...
componentWillReceiveProps(nextProps: any) {
    const { theme } = nextProps;
    if (JSON.stringify(theme) !== this.cache) {
        const mergedTheme = this.getMergedTheme(theme);
        this.cache = JSON.stringify(theme);
        this.setState(
            {
                theme: mergedTheme
            },
        );
    }
}

getMergedTheme = (theme: string) => {
    return generateTheme(theme);
};
```
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å¯ä»¥çœ‹åˆ°ï¼ŒåŠ äº†ä¸€ä¸ªæœ¬åœ°çš„ç¼“å­˜`cache`æ¥é¿å…é‡å¤å˜æ›´ã€‚å…¶ä¸­`generateTheme`æ˜¯æˆ‘å†™çš„ä¸€ä¸ªå¢å¼ºæ–¹æ³•ï¼Œç”¨äºå¤„ç†å‰åä¸¤ä¸ªä¸»é¢˜å¯¹æ¯”æ›´æ–°ï¼Œå¹¶åŠ å…¥äº†ä¸€äº›å¸¸ç”¨æ ·å¼ï¼Œæ¯”å¦‚`fontSize`ç­‰ï¼Œå¦‚æœä½ è§‰å¾—æ²¡å¿…è¦ï¼Œé‚£ä¹ˆä½ ç›´æ¥è®¾ç½®æ‹¿åˆ°çš„themeå°±è¡Œäº†ã€‚

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;è‡³æ­¤ï¼Œä¸€ä¸ªæä¾›ä¸»é¢˜çš„providerå°±å†™å¥½äº†ï¼Œç°åœ¨æ¥ç»™ä»–å¢åŠ çµé­‚ï¼šé…è‰²ã€‚è¿™é‡Œæˆ‘å†™äº†ä¸¤ç§é…è‰²ï¼ˆä½ ä¹Ÿå¯ä»¥è‡ªå·±è®¾è®¡ï¼Œå¦‚æœä½ å…·å¤‡è®¾è®¡å¸ˆçš„ç¾å­¦ç´ å…»å’Œä¸“ä¸šçŸ¥è¯†çš„è¯ï¼‰ï¼š`Black`å’Œ`White`ã€‚

### designTokens.ts

æˆ‘ä»¬åœ¨`ThemeProvider.tsx`åŒç›®å½•æ–°å»ºæ–‡ä»¶`designTokens.ts`æ¥æ”¾ç½®é»˜è®¤ä¸»é¢˜é…è‰²ï¼š


```ts
/** é»˜è®¤çš„ä¸»é¢˜é…è‰² */
const designTokens = {
    ...
};

export { designTokens };
```
å…·ä½“çš„é…è‰²å˜é‡åº”å…¨å¤§å†™ï¼Œä»¥Tå¼€å¤´ï¼Œä»…åŒ…å«å­—æ¯. æ•°å­—. ä¸‹åˆ’çº¿ï¼Œç”±äºå˜é‡å¤ªå¤šï¼Œè¿™é‡Œç»™å‡ºä¸€éƒ¨åˆ†ï¼š

èƒŒæ™¯è‰²ï¼š

![image.png](/img/posts/2022-3-19/2022-3-19-1.png)

å¤šå½©è‰²ï¼š

![image.png](/img/posts/2022-3-19/2022-3-19-2.png)


æ¸å˜è‰²æ± ï¼š

![image.png](/img/posts/2022-3-19/2022-3-19-3.png)


å¸¸ç”¨å°ºå¯¸ï¼š

![image.png](/img/posts/2022-3-19/2022-3-19-4.png)


&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;åŒç†ï¼Œåœ¨ç›¸åŒçš„ç›®å½•ä¸‹ï¼Œæ–°å»ºæ–‡ä»¶`dark.ts`, æ”¾å…¥ç›¸åŒçš„å˜é‡ï¼Œä½†æ˜¯è‰²å·åº”è¯¥æ˜¯æš—è‰²è°ƒçš„é…è‰²ï¼Œäº®è‰²è°ƒä¸‹çš„äº®è‰²ï¼Œåœ¨æš—è‰²è°ƒä¸‹åº”è¯¥æ˜¯æš—è‰²ã€‚æ¯”å¦‚æ¸å˜è‰²æ± åº”è¯¥æ˜¯ä¸‹é¢è¿™æ ·ï¼š

![image.png](/img/posts/2022-3-19/2022-3-19-5.png)


è¿™äº›é…è‰²æ–¹æ¡ˆï¼Œç½‘ä¸Šä¹Ÿèƒ½æ‰¾åˆ°ç±»ä¼¼çš„ï¼Œé€‰æ‹©è‡ªå·±å–œæ¬¢çš„å°±è¡Œäº†ã€‚

æœ‰äº†è¿™äº›é¢œè‰²æ± ï¼Œæˆ‘ä»¬å†™ä¸€ä¸ªæ–¹æ³•æ¥è·å–å½“å‰çš„`designTokens`ï¼Œè¿˜æ˜¯åœ¨åŒç›®å½•ä¸‹ï¼Œæ–°å»ºæ–‡ä»¶`useDesignTokens.ts`ï¼š


```tsx
import { useTheme } from 'emotion-theming';

// ../../styleä¸­å†™äº†å‡ ä¸ªè¾…åŠ©çš„æ ·å¼ï¼Œå¯¹è§£é‡ŠåŸç†æ²¡æœ‰å½±å“ï¼Œæƒ³çœ‹å…¨éƒ¨ä»£ç å¯ä»¥å»é¡¹ç›®ä»“åº“æŸ¥çœ‹
import { defaultTheme, Theme } from '../../style';

const useDesignTokens = () => {
  // æ‹¿åˆ°Themeproviderçš„theme
  const theme = useTheme<Theme>();
  if (!Object.keys(theme).length) return defaultTheme.designTokens;
  return theme.designTokens;
};

export default useDesignTokens;

```
è¿™æ ·ï¼Œå°±å¯ä»¥åœ¨ä»»ä½•ä¸€ä¸ªåœ°æ–¹ï¼Œé€šè¿‡useDesignTokensæ‹¿åˆ°å½“å‰çš„ä¸»é¢˜é…è‰²äº†ã€‚

## 4. åæ€

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å†å›åˆ°`ThemeProvider`æœ¬èº«è¿›è¡Œæ€è€ƒï¼Œæ€»è§‰å¾—å°‘äº†ç‚¹ä»€ä¹ˆã€‚æ˜¯ä¸æ˜¯æ˜¾å¾—åŠŸèƒ½æœ‰ç‚¹å•è–„ï¼Œä¼ å€¼åªèƒ½ä¼ é€’themeï¼Œä¸å¤Ÿçµæ´»ã€‚æ•´ä¸ªç»„ä»¶åº“é¡¹ç›®è¦ç»´æŠ¤çš„å…¬å…±å˜é‡åº”è¯¥ä¸ä¼šåªæœ‰ä¸»é¢˜ï¼Œåæ¥å¯èƒ½è¿˜ä¼šæœ‰å›½é™…åŒ–ä»€ä¹ˆçš„ï¼Œæ‰€ä»¥ï¼Œæ˜¯ä¸æ˜¯è¦å†™ä¸€ä¸ªæ›´é€šç”¨çš„Provideræ¥ç»Ÿä¸€å¤„ç†ï¼Ÿ

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æˆ‘ä»¬åœ¨`src/components`æ–‡ä»¶å¤¹ä¸‹ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„æ–‡ä»¶å¤¹`ConfigProvider`ï¼Œåœ¨æ–°åˆ›å»ºçš„æ–‡ä»¶å¤¹ä¸‹åˆ›å»ºæ–‡ä»¶`ConfigProvider.tsx`ï¼Œå†™ä¸Šå¦‚ä¸‹ä»£ç ï¼š

```tsx
import React, { ReactNode, createContext } from 'react';

import ThemeProvider from '../ThemeProvider';

export interface ConfigProviderProps {
  /** @ignore */
  children: ReactNode;

  /** æä¾›æ—¶ä¼šä½¿ç”¨ ThemeProvider åŒ…è£¹ */
  theme?: any;
}

const ConfigProvider = ({ children, theme, ...rest }: ConfigProviderProps) => {

  const defaultConfig = {};
  const ConfigContext = createContext<any>(defaultConfig);

  let provider = (
    <ConfigContext.Provider value={{ ...defaultConfig, ...rest }}>
      {children}
    </ConfigContext.Provider>
  );
  if (theme) provider = <ThemeProvider theme={theme}>{provider}</ThemeProvider>;

  // ä¸‹è¾¹å¯ä»¥è¿½åŠ å…¶ä»–æƒ…å†µçš„Provider ...

  return provider;
};

export { ThemeProvider };
export default ConfigProvider;
```
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;è¿™é‡Œï¼Œæˆ‘ä»¬ä½¿ç”¨`createContext`æ¥åˆ›å»ºä¸€ä¸ªcontextæ”¾ç½®å…¨å±€å˜é‡ï¼Œä½¿ç”¨`ConfigContext.Provider`ä½œä¸ºåŸºç¡€å…¨å±€å‚æ•°ï¼Œé€šè¿‡æ‹¿åˆ°çš„ä¸åŒå‚æ•°æ¥åŠ¨æ€å åŠ è½¬æ¢ä¸ºå…¶ä»–ä¸åŒçš„`Provider`ã€‚å½“ç„¶ï¼Œcontextå¯ä»¥è‡ªå·±å†å•å†™ä¸€ä¸ªæ–‡ä»¶æ¥å­˜å‚¨ï¼Œè¿™é‡Œå°±ä¸èµ˜è¿°äº†ã€‚

## 5. å¦‚ä½•ä½¿ç”¨

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ä¸ºäº†èƒ½å¤Ÿåœ¨ç»„ä»¶ä¸­ä½¿ç”¨çš„å†…ç½®ä¸»é¢˜è‰²ï¼Œéœ€è¦å°†é…ç½®å¯¹å¤–æš´éœ²å‡ºæ¥ï¼Œåœ¨`src/index.ts`æ–‡ä»¶ä¸­åˆ é™¤ä¸Šä¸€æœŸå¯¼å…¥çš„Fooç»„ä»¶ï¼š

<del>`export { default as Foo } from './components/Foo';`</del>

ç„¶ååŠ å…¥å¦‚ä¸‹ä»£ç ï¼š

```ts
export { default as ThemeDark } from './components/ThemeProvider/dark';
export { designTokens as ThemeDefault } from './components/ThemeProvider/designTokens';
export {
  default as ConfigProvider,
  ThemeProvider,
} from './components/ConfigProvider/ConfigProvider';
```

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ä¸»é¢˜é…ç½®æœ‰äº†ï¼Œæ¥ä¸‹æ¥è¦æ€ä¹ˆç”¨å‘¢ï¼Ÿç”¨è¿™ä¸ªProvideræŠŠå…¨å±€Appç»„ä»¶åŒ…è£¹ä¸€ä¸‹å—ï¼Ÿå¦‚æœæœ‰ä¸ªåˆ«ç»„ä»¶æƒ³è¦å®šåˆ¶æ ·å¼å‘¢ï¼Ÿä¼¼ä¹ä¸å¤Ÿçµæ´»ï¼Œä½œè€…è®¤ä¸ºåº”è¯¥å°è£…ä¸€ä¸ªå·¥å…·ç±»ï¼Œåœ¨éœ€è¦é…ç½®ä¸»é¢˜è‰²çš„ç»„åŠ ä¸Šä½¿ç”¨å³å¯ã€‚åœ¨`src`ç›®å½•ä¸‹æ–°å»º`style`æ–‡ä»¶å¤¹ç”¨æ¥æ”¾ç½®å…¬å…±çš„æ ·å¼é…ç½®ï¼Œåœ¨è¯¥æ–‡ä»¶å¤¹ä¸‹æ–°å¢æ–‡ä»¶`styleWrap.tsx`ï¼š

```tsx
// å¼•å…¥ä¾èµ–
import React, { FC, useMemo } from 'react';
import { useTheme } from 'emotion-theming';
import defaultTheme from '../components/ThemeProvider/theme';

...

// æ–°å»ºä¸€ä¸ªå‡½æ•°
const styleWrap = () => {
    ...
    return Com => {
        const WithThemeComponent = (props) => {

            ...

            const theme = useTheme();

            const memoTheme = useMemo(
                () => (!theme || !Object.keys(theme)?.length ? defaultTheme : theme),
                [theme],
            );

            const result = {
                ...props,
                theme: memoTheme,
            };
            ...

            const Com = Comp as unknown as FC;
            // resultä¸­å¸¦æœ‰themeä¸»é¢˜å‚æ•°ï¼Œåœ¨åŸºç¡€ä¸šåŠ¡ç»„ä»¶ä¸­åº”æ¥å—å¹¶å¤„ç†
            return <Com {...result} />;
        } 

        return WithThemeComponent;
    }
}

```
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å¯ä»¥çœ‹åˆ°ï¼ŒstyleWrapè¿”å›çš„æ˜¯ä¸€ä¸ªé«˜é˜¶ç»„ä»¶WithThemeComponentï¼Œåœ¨è¯¥ç»„ä»¶é‡Œè·å–å½“å‰ä¸»é¢˜å¹¶ä½¿ç”¨`useMemo`èŠ‚çœæ¸²æŸ“å¼€é”€ï¼Œå°†ç»“æœæ”¶é›†åˆ°`result`é‡Œä½œä¸ºå±æ€§ä¼ é€’ç»™åŸºç¡€ä¸šåŠ¡ç»„ä»¶`Com`.

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æ¥ä¸‹æ¥è®°å½•ä¸€ä¸‹`ThemeProvider`åœ¨ç»„ä»¶ä¸­çš„ä½¿ç”¨æ–¹å¼ï¼š


```tsx
...
// 1. å¼•å…¥ä¸€ç§å­—ä½“
const [theme, setTheme] = useState(ThemeDark);
...

// 2. ä½¿ç”¨
<ConfigProvider theme={theme}>
    // æ”¾ç½®è¢«styleWrapåŒ…è£¹çš„ä¸šåŠ¡ç»„ä»¶
    ...
</ConfigProvider>

// 3. åˆ‡æ¢ä¸»é¢˜
setTheme(designTokens);
```


<hr />

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æœ¬æœŸä¸»é¢˜é…ç½®çš„è®°å½•åˆ°è¿™é‡Œå°±ç»“æŸäº†ï¼Œä¸‹ä¸€æœŸè®²è§£åŸºç¡€ç»„ä»¶`Button`å’Œ`Icon`çš„è®¾è®¡ï¼ŒåŒæ—¶ä¼šå°†ä¸»é¢˜è‰²åº”ç”¨åœ¨è¿™äº›ç»„ä»¶ä¸Šï¼Œä¸ºäº†èƒ½å¤Ÿæ›´å¥½åœ°ç†è§£åŸºç¡€ç»„ä»¶å¦‚ä½•å¤„ç†ä¼ å…¥çš„themeå‚æ•°ï¼Œä¸‹ä¸€æœŸä¼šå’Œæœ¬æœŸä¸€èµ·å‘å¸ƒï¼Œæ•¬è¯·æœŸå¾…~~84:T14b2,## 1. å‰è¨€

### å†™ä½œèƒŒæ™¯
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ç°åœ¨å¼€å§‹æˆ‘åœ¨æ˜é‡‘çš„ç¬¬ä¸€ä¸ªä¸“æ ï¼Œè®°å½•ä¸€ä¸‹æˆ‘åœ¨å®é™…é¡¹ç›®ä¸­æ­å»ºUIç»„ä»¶åº“çš„è¿‡ç¨‹ï¼Œä»¥ä¾¿äºä»¥åæŸ¥è¯¢ï¼ŒåŒæ—¶ä¹Ÿä¸ºå¤§å®¶æä¾›ä¸€ç§åŸºäºReactåˆ›å»ºå‰ç«¯UIåº“çš„æ€è·¯ã€‚

### ä¸ºä»€ä¹ˆè¦è‡ªå·±å†™UIåº“

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ç°åœ¨ä¼˜ç§€çš„å‰ç«¯å¼€æºUIåº“å·²ç»å¾ˆå¤šäº†ï¼Œæ¯”å¦‚antd. Material UI. element UIç­‰ç­‰ï¼Œè¿™äº›UIåº“ç”Ÿæ€éƒ½æ¯”è¾ƒå®Œå–„ï¼Œæ–‡æ¡£ä¹Ÿå†™å¾—å¾ˆå¥½ï¼Œä½ åœ¨é¡¹ç›®ä¸­ç›´æ¥ç”¨ä¸å°±è¡Œäº†ï¼Œå¯ä¸ºä»€ä¹ˆè¿˜è¦è‡ªå·±å†™å‘¢ï¼Ÿå€Ÿç”¨ä¸€å¥è€è¯ï¼Œç§Ÿä¸å¦‚ä¹°ï¼Œä¹°ä¸å¦‚é€ ï¼Œä»è¿™ä¸ªè§’åº¦ä¹Ÿèƒ½çŸ¥é“è€ç”¨åˆ«äººçš„æ€»è§‰å¾—æœ‰ç‚¹ç¼ºé™·ï¼Œè¿™é‡Œä½œè€…ä¸ªäººè®¤ä¸ºåšæŒå†™è‡ªå·±çš„UIåº“ä¸»è¦æœ‰è¿™ä¹ˆå‡ ä¸ªåŸå› ï¼š

*1.* *ä¼šå—åˆ¶äºäººã€‚*

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;è™½ç„¶æ˜¯å¼€æºçš„åº“ï¼Œä½†æ˜¯éè§‚å¸‚é¢ä¸Šå¤§å¤šæ•°äº§å“ï¼Œéƒ½æ²¡æœ‰ç”¨è¿™äº›ç»„ä»¶åº“ï¼Œç›¸åçš„æ˜¯ä¼ä¸šå†…éƒ¨çš„é¡¹ç›®ç”¨çš„æ¯”è¾ƒå¤šã€‚æˆ‘æƒ³æ›´å¤šçš„åŸå› æ˜¯ä¸æƒ³å—åˆ¶äºäººï¼Œå¦‚æœå“ªä¸€å¤©UIåº“çš„ä½œè€…æƒ³è¦æ”¶ä¸“åˆ©è´¹äº†ï¼Œä½ çš„é¡¹ç›®è¦ä¸è¦è¿ç§»åˆ°åˆ«çš„ç»„ä»¶åº“ï¼Ÿè¿˜æ˜¯è¯´ä¹–ä¹–äº¤é’±å‘¢ï¼Ÿå¦ä¸€æ–¹é¢ï¼Œå¦‚æœä½ å…¬å¸æ‰€æœ‰çš„äº§å“éƒ½ç”¨äº†antdï¼Œæ—¥ç§¯æœˆç´¯ï¼Œä½ å°±ä¼šå¤©ç„¶çš„ä¾èµ–é˜¿é‡Œçš„å¼€å‘ä¹ æƒ¯ï¼Œé€‰æ‹©æ–°äº§å“çš„æ—¶å€™å°±ä¼šæ›´å€¾å‘äºé˜¿é‡ŒåŒç³»çš„ï¼Œæ‰€ä»¥è¯´ï¼Œå…è´¹çš„ä»£ä»·æ˜¯å¤±å»è‡ªä¸»æƒã€‚

*2.* *å‡çº§äº§å“éœ€è¦çœ‹è„¸è‰²ã€‚*

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ä¸¾ä¸ªä¾‹å­ï¼Œä½ çš„äº§å“æ‰€ä½¿ç”¨çš„æ¡†æ¶ï¼ŒVueè¦ä»2å‡3ï¼ŒAngularè¦ä»9å‡12ï¼ŒReactè¦å‡çº§18äº†ï¼Œè€Œä½ æ‰€ä¾èµ–çš„ç¬¬ä¸‰æ–¹UIç»„ä»¶åº“è¿˜ä¸æ”¯æŒæ–°ç‰ˆæœ¬æ¡†æ¶ï¼Œæˆ–è€…å¯¹æ–°ç‰ˆæœ¬æ¡†æ¶æˆ–å…¶ä»–çš„ä¾èµ–éƒ¨åˆ†å…¼å®¹ï¼Œè¿™å°±ä¼šä½¿å¾—ä½ çš„å¼€å‘éå¸¸çš„éš¾å—ã€‚

*3.* *ä¸å¥½ç»´æŠ¤ã€‚*

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ä½¿ç”¨åˆ«äººçš„ç»„ä»¶åº“ï¼Œå¦‚æœå‡ºäº†Bugæ€ä¹ˆä¿®å‘¢ï¼Ÿéš¾é“è¦åœ¨Githubä¸ŠæIssueå˜›ğŸ˜‚ï¼Œè¿™æ ·æŠ±æ€¨çš„æ˜¯ä½ çš„å®¢æˆ·ï¼Œå—æŸçš„æ˜¯ä½ çš„äº§å“ã€‚ç¬¬ä¸‰æ–¹è¿›è¡Œçš„å¼€æºï¼Œæ˜¯ä¸ªåŒåˆƒå‰‘ï¼Œå…è´¹ç»™ä½ ç”¨ï¼Œä½†æ˜¯å‡ºäº†é—®é¢˜äººå®¶ä¹Ÿä¸è´Ÿè´£ã€‚


&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æœ‰äº†è¿™äº›åŸå› ï¼Œåº”è¯¥ä¸ä¼šå†è´¨ç–‘ä¸ºä»€ä¹ˆè¦åšè‡ªå·±çš„UIåº“äº†å§ã€‚æ‹¥æœ‰è‡ªå·±å…¨å¥—çš„äº§å“ä½“ç³»ï¼Œå¯¹äºä¼ä¸šï¼Œæ˜¯ä¸€ä¸ªæ‹¿å›è‡ªä¸»æƒçš„é‡è¦ä¸€æ­¥ï¼Œå¯¹äºæˆ‘ä»¬å¼€å‘è€…ï¼Œä¹Ÿæ˜¯é”¤ç‚¼è‡ªå·±åŸºæœ¬åŠŸçš„è¿‡ç¨‹ï¼Œä½•ä¹è€Œä¸ä¸ºï¼Ÿ

## 2. åŸºäºReact
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;è¿™é‡Œè®°å½•æˆ‘ç°åœ¨æ­£åœ¨æ­å»ºçš„ä¼ä¸šé¡¹ç›®ï¼Œä¸€è¾¹æ­å»ºä¸€è¾¹è®°å½•ï¼Œå…¶ä¹èèï¼Œå¯ä»¥ç§°å¾—ä¸Šæ‰‹æŠŠæ‰‹æ•™å­¦æœ¬å­¦äº†\[doge\]ã€‚

### 1. ä½¿ç”¨dumiåˆ›å»º

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dumiæ˜¯ä¸€ä¸ªå¼€æºçš„è´Ÿè´£ç»„ä»¶å¼€å‘åŠç»„ä»¶æ–‡æ¡£ç”Ÿæˆçš„å·¥å…·ï¼Œè¿™é‡Œä»…ä¸ºäº†æ–¹ä¾¿ç»„ä»¶åº“æ–‡æ¡£å±•ç¤ºä½¿ç”¨ã€‚åœ¨æœ€åæ‰“åŒ…å‘å¸ƒæ—¶ï¼Œdumiä¸å‚ä¸æ‰“åŒ…ï¼Œæ‰€ä»¥è¿™é‡Œä½¿ç”¨dumiæ˜¯å¯ä»¥çš„ã€‚

æ¥ä¸‹æ¥å°±å¼€å§‹è®°å½•å®æ“æ­¥éª¤ã€‚

é¦–å…ˆå®‰è£…Â [node](https://nodejs.org/en/)ï¼Œå¹¶ç¡®ä¿`node >= 10.13 && node < 17.6.0`ã€‚è¿™é‡Œä½œè€…äº²æµ‹ï¼Œnode 17.6.0æ˜¯ä¸å…¼å®¹çš„ï¼Œè€Œä½œè€…æœ¬åœ°ä½¿ç”¨çš„`v16.14.2`å¯ä»¥å®Œå…¨å…¼å®¹ã€‚

åœ¨ç©ºç™½çš„åœ°æ–¹æ–°å»ºæ–‡ä»¶å¤¹
```sh
mkdir dux-ui && cd ./dux-ui
```

ç„¶åæ‰§è¡Œå®‰è£…å‘½ä»¤ï¼Œè¿™é‡Œæˆ‘é€‰æ‹©ç«™ç‚¹å¼çš„åˆ›å»ºæ–¹å¼

```sh
$ npx @umijs/create-dumi-lib        # åˆå§‹åŒ–ä¸€ä¸ªæ–‡æ¡£æ¨¡å¼çš„ç»„ä»¶åº“å¼€å‘è„šæ‰‹æ¶
// or
$ yarn create @umijs/dumi-lib

$ npx @umijs/create-dumi-lib --site # åˆå§‹åŒ–ä¸€ä¸ªç«™ç‚¹æ¨¡å¼çš„ç»„ä»¶åº“å¼€å‘è„šæ‰‹æ¶
// or
$ yarn create @umijs/dumi-lib --site
```
åœ¨æ ¹ç›®å½•ä¸‹æ‰§è¡Œå‘½ä»¤

```sh
npm install
npm run dev
```
ç„¶åé¡¹ç›®å°±è·‘èµ·æ¥äº†ï¼ï¼ˆç›—ç”¨å®˜ç½‘çš„å›¾ï¼Œä»…ä¾›å‚è€ƒï¼‰

![image.png](/img/posts/2022-3-14/2022-3-14-1.png)

### 2. æ–‡ä»¶ç›®å½•

è„šæ‰‹æ¶æ­å»ºèµ·é¡¹ç›®åï¼Œå¯ä»¥çœ‹åˆ°åˆå§‹æ–‡ä»¶ç›®å½•

![image.png](/img/posts/2022-3-14/2022-3-14-2.png)


è¿™é‡Œä¸ºäº†å¼€å‘æ–¹ä¾¿ï¼Œæˆ‘ä»¬æŠŠè‡ªå®šä¹‰çš„ç»„ä»¶æ”¾åœ¨å•ç‹¬çš„`components`æ–‡ä»¶å¤¹ä¸‹ï¼š

![image.png](/img/posts/2022-3-14/2022-3-14-3.png)


ç„¶åä¿®æ”¹`src`ä¸‹çš„`index`æ–‡ä»¶ä¸­ç»„ä»¶çš„å¯¼å…¥è·¯å¾„ï¼š

```js
export { default as Foo } from './components/Foo';
```
ä¿®æ”¹dumié…ç½®æ–‡ä»¶`.umirc.ts`ï¼Œæ–°å¢menuå±•ç¤ºè·¯å¾„ï¼š

```js
import { defineConfig } from 'dumi';

export default defineConfig({
  title: 'test-dumi',
  favicon:
    'https://user-images.githubusercontent.com/9554297/83762004-a0761b00-a6a9-11ea-83b4-9c8ff721d4b8.png',
  logo: 'https://user-images.githubusercontent.com/9554297/83762004-a0761b00-a6a9-11ea-83b4-9c8ff721d4b8.png',
  outputPath: 'docs-dist',
  mode: 'site',
  
  // æ–°å¢
  menus: {
    // éœ€è¦è‡ªå®šä¹‰ä¾§è¾¹èœå•çš„è·¯å¾„ï¼Œæ²¡æœ‰é…ç½®çš„è·¯å¾„è¿˜æ˜¯ä¼šä½¿ç”¨è‡ªåŠ¨ç”Ÿæˆçš„é…ç½®
    '/components': [
      {
        title: 'ç»„ä»¶',
        path: '/components',
        children: [
          // èœå•å­é¡¹ï¼ˆå¯é€‰ï¼‰
          'components/Foo/index.md',
        ],
      },
    ],
  },
});
```

ä¿®æ”¹`package.json`

![image.png](/img/posts/2022-3-14/2022-3-14-4.png)


ç„¶åæ‰§è¡Œ

```sh
npm run docs
```

å¯ä»¥çœ‹åˆ°è·‘èµ·æ¥äº†

![image.png](/img/posts/2022-3-14/2022-3-14-5.png)
![image.png](/img/posts/2022-3-14/2022-3-14-6.png)

è‡³æ­¤ï¼Œé¡¹ç›®å°±æ­å»ºèµ·æ¥äº†ï¼æœ¬ç« åˆ°æ­¤ç»“æŸï¼Œä¸‹ä¸€èŠ‚ä¼šé€æ­¥è®°å½•å„ä¸ªç»„ä»¶çš„å¼€å‘è¿‡ç¨‹ã€‚85:T2618,## 1. nodeç¯å¢ƒä¸å¼€å‘å·¥å…·å‡†å¤‡

å‰ç«¯å·¥ç¨‹åŒ–å¼€å‘ï¼Œæœ¬åœ°å¯åŠ¨å¼€å‘ç¯å¢ƒéƒ½æ˜¯åŸºäºnodejsçš„ï¼Œå‘½ä»¤è¡Œé‡Œè¾“å…¥æŒ‡ä»¤`node -v`å¯ä»¥å¸®åŠ©ç¡®è®¤æ‚¨çš„ç”µè„‘ä¸Šæ˜¯å¦å®‰è£…äº†nodeï¼Œå¦‚æœæ²¡æœ‰å®‰è£…ï¼Œåˆ™å¯ä»¥å» [nodeå®˜ç½‘](http://nodejs.cn/download/) ä¸‹è½½å®‰è£…åŒ…ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š
![nodeå®˜ç½‘ä¸‹è½½ç•Œé¢](/img/posts/2022-3-1/2022-3-1-1.png)
ä¸ç®¡æ˜¯åœ¨windowsè¿˜æ˜¯åœ¨macç¯å¢ƒä¸‹ï¼Œéƒ½æ˜¯ä¸€é”®å‚»ç“œå¼å®‰è£…ï¼Œç”šè‡³è¿ç¯å¢ƒå˜é‡éƒ½ä¸éœ€è¦æ‰‹åŠ¨é…ç½®ï¼Œè¿™é‡Œå°±ä¸è¿‡å¤šä»‹ç»äº†ã€‚


## 2. å¼€å‘å·¥å…·å‡†å¤‡
å‰ç«¯çš„å¼€å‘å·¥å…·ï¼Œå¸¸è§çš„æœ‰VSCode. WebStorm. Atomç­‰ï¼Œåªéœ€ç”¨å…¶ä¸­ä¹‹ä¸€ä¾¿è¶³å¯ä»¥å®Œæˆæ‚¨çš„å¼€å‘ä»»åŠ¡ã€‚è¿™é‡Œç¬”è€…ç»™å‡ºå¸¸ç”¨ç¼–è¾‘å™¨çš„å¯¹æ¯”ã€‚


| å·¥å…·åç§° | ä¼˜ç‚¹ | ç¼ºç‚¹ | æ¨èåº¦ |
| --- | --- | --- | --- |
| WebStorm | æ’ä»¶å¾ˆå¤šï¼ŒåŠŸèƒ½é½å…¨ | æ”¶è´¹ï¼Œå ç”¨èµ„æºå¤§ | â˜†â˜…â˜… | 
| Atom | ç•Œé¢æ•´æ´ï¼Œå…è´¹ | æ’ä»¶å®‰è£…å¤šäº†ä¼šæ…¢ï¼Œä¸å¤Ÿæµç•… | â˜†â˜…â˜… | 
| VSCode | è½»é‡çº§ï¼Œæ’ä»¶ç¹å¤šï¼Œæ”¯æŒå®šåˆ¶ï¼Œå…è´¹ | æ’ä»¶è¿‡å¤šä¼šå‡ºç°å†²çªï¼Œä»£ç çš„æç¤ºä¸å‹å¥½ | â˜†â˜…â˜…â˜…â˜… | 


ç¬”è€…æ¥ä¸‹æ¥çš„å¼€å‘å°±ä»¥VSCodeä¸ºå‡†ã€‚

vsCodeä½œä¸ºç›®å‰æœ€ä¸ºæµè¡Œçš„è½»é‡çº§å¼€å‘å·¥å…·ï¼Œå¹¿å—å‰åç«¯ç¨‹åºå‘˜çš„å–œçˆ±ï¼Œå…¶æ’ä»¶åº“ä¹Ÿæ˜¯ååˆ†çš„ä¸°å¯Œï¼Œå¯ä»¥ä¾›å¼€å‘çš„è¿›è¡Œè‡ªå®šä¹‰é…ç½®ï¼Œè€Œä¸”æä¾›äº†æ’ä»¶å¼€å‘çš„åŠŸèƒ½ï¼Œä½¿å¾—å¼€æºä½œè€…èƒ½å¤Ÿæ›´åŠ è½»æ¾çš„è‡ªå®šä¹‰è‡ªå·±çš„æ’ä»¶ï¼Œå¹¶ä¸”æœ‰æ”¯æŒè¿œç¨‹å¼€å‘ç­‰ä¼˜ç‚¹ã€‚ç›¸æ¯”äºwebStormå’Œsublimeè¿™ç§éœ€è¦è´­ä¹°æ­£å¼ç‰ˆï¼ˆsublimeè™½ç„¶ä¸ä¹°ä¹Ÿæ²¡ä»€ä¹ˆå…³ç³»ï¼‰çš„äº§å“ï¼Œå…¶æœ€ç›´æ¥çš„ä¼˜ç‚¹æ˜¯ä»–æ˜¯å…è´¹çš„ï¼
vsCodeå®˜ç½‘åœ°å€ä¸ºï¼š`https://code.visualstudio.com/`ï¼Œå¼€å‘è€…å¯ä»¥ä¸‹è½½è‡ªå·±æ‰€éœ€çš„ç‰ˆæœ¬ï¼š

![image.png](/img/posts/2022-3-1/2022-3-1-2.png)
å›½å†…ç”¨æˆ·æœªç¿»å¢™çš„å¯èƒ½ä¼šå‡ºç°ä¸‹è½½ç¼“æ…¢çš„é—®é¢˜ï¼Œè¿™é‡Œä½œè€…æå‰ä¸‹è½½å¥½äº†å›½å†…ç‰ˆæœ¬æ”¾åœ¨æ–‡ç« æœ«å°¾ä¾›å¤§å®¶ä¸‹è½½ã€‚

atomä¹Ÿæ˜¯å…è´¹çš„å¼€å‘å·¥å…·ï¼Œè¿™ä¸ªæ ¹æ®è‡ªå·±çš„å–œå¥½æ¥ä½¿ç”¨ã€‚ä½œè€…ä¸€å¼€å§‹å†™ç½‘é¡µä¹Ÿæ˜¯ç”¨çš„atomï¼Œä½†æ˜¯å½“ä½ ä¸‹è½½äº†å®˜ç½‘çš„å®‰è£…åŒ…ï¼Œçœ‹åˆ°ä»–çš„å¤§å°åï¼Œæˆ–è€…åœ¨ä½¿ç”¨å¾ˆé•¿ä¸€æ®µæ—¶é—´åæ‰“å¼€èµ„æºç®¡ç†å™¨åï¼Œä½ å¯èƒ½å°±ä¼šåƒä½œè€…ä¸€æ ·å¼ƒç”¨å®ƒï¼è¿™é‡Œè¿˜æ˜¯ç»™å‡ºå…¶å®˜ç½‘åœ°å€`https://atom.io/`ï¼Œä»–çš„ç•Œé¢ä½œè€…è¿˜æ˜¯æŒºå–œæ¬¢çš„ã€‚

## 3. reacté¡¹ç›®å¼€å‘ç¯å¢ƒæ­å»º
reactå·¥ç¨‹åŒ–é¡¹ç›®åˆ›å»ºçš„è„šæ‰‹æ¶å·¥å…·è¿™é‡Œä½œè€…ä»‹ç»ä¸»æµçš„ä¸¤ç§ï¼š`create-react-app`å’Œ`vite`.
### 3.1. create-react-appæ„å»º
è¿™é‡Œä½¿ç”¨npxå®‰è£…ï¼š`npx create-react-app <å·¥ç¨‹å>`ã€‚
æ³¨æ„å·¥ç¨‹åç§°ä½¿ç”¨å­—æ¯æ•°å­—è¿æ¥çº¿çš„å½¢å¼(èŒƒä¾‹å‚è€ƒï¼š\<https://create-react-app.dev/docs/getting-started/> )ï¼Œè¿™é‡Œä½œè€…ä½¿ç”¨hello-world1.
æ„å»ºæˆåŠŸåä¼šçœ‹åˆ°æ§åˆ¶å°æ‰“å°å¦‚ä¸‹æŒ‡ä»¤ï¼š

![10.png](/img/posts/2022-3-1/2022-3-1-3.png)

è¿›å…¥å·¥ç¨‹æ ¹ç›®å½•`cd ./hello-world1`
> è‹¥åˆ›å»ºæ—¶æ²¡æœ‰å®‰è£…ä¾èµ–æˆåŠŸï¼Œè¿›å…¥å·¥ç¨‹æ ¹ç›®å½•ä¸‹æ‰‹åŠ¨å®‰è£…`npm inatall`å³å¯

æ‰§è¡ŒæŒ‡ä»¤ï¼š`npm start`ï¼Œå¯åŠ¨æˆåŠŸååœ¨æµè§ˆå™¨è¾“å…¥ç½‘å€`localhost:3000`å³å¯çœ‹åˆ°æ¬¢è¿ç•Œé¢ï¼š

![11.png](/img/posts/2022-3-1/2022-3-1-4.png)

### 3.2. viteæ„å»º
ç»ˆç«¯è¾“å…¥æŒ‡ä»¤
```sh
# npm 6.x
npm init vite@latest <å·¥ç¨‹å> --template <æ¨¡æ¿å>
# npm 7+
npm init vite@latest <å·¥ç¨‹å> -- --template <æ¨¡æ¿å>
```
è¿™é‡Œæˆ‘ä»¬å½“ç„¶ä½¿ç”¨`react`ä½œä¸ºæ¨¡æ¿å. hello-world2ä½œä¸ºå·¥ç¨‹åæ¥æ„å»ºå·¥ç¨‹ç›®å½•ã€‚è¾“å…¥æŒ‡ä»¤åä½ ä¼šå‘ç°é¡¹ç›®æ„å»ºçš„å¾ˆå¿«ï¼Œé‚£æ˜¯å› ä¸ºè„šæ‰‹æ¶æ²¡æœ‰é»˜è®¤å¸®ä½ å®‰è£…ä¾èµ–ï¼Œæ‰€ä»¥è¦è¿›å…¥å·¥ç¨‹ç›®å½•ï¼ˆ`cd ./hello-world2`ï¼‰å¹¶æ‰‹åŠ¨å®‰è£…ä¾èµ–ï¼š`npm install`ã€‚ä¾èµ–å®‰è£…å®Œæˆåï¼Œå³å¯å¯åŠ¨é¡¹ç›®ï¼š`npm run dev`ï¼ŒåŒæ ·çš„ï¼Œåœ¨æµè§ˆå™¨è¾“å…¥ç½‘å€`localhost:3000`å³å¯çœ‹åˆ°æ¬¢è¿ç•Œé¢ï¼š

![12.png](/img/posts/2022-3-1/2022-3-1-5.png)

è‡³æ­¤é¡¹ç›®å°±å¯åŠ¨å®Œæ¯•äº†~~ 

å¦‚æœæ‚¨åªæ˜¯æƒ³å¿«é€Ÿå¼€å‘ä¸€ä¸ªé¡¹ç›®ï¼Œç¯å¢ƒé…ç½®åˆ°è¿™é‡Œå°±ç»“æŸäº†ã€‚ä»¥ä¸‹å†…å®¹ä¸ºé€‰æ‹©æ€§è§‚çœ‹å†…å®¹ï¼Œå¦‚æœæ‚¨è§‰å¾—ä¾èµ–å®‰è£…æ¯”è¾ƒæ…¢ï¼Œåˆæˆ–è€…éœ€è¦ç®¡ç†ä¸åŒç‰ˆæœ¬çš„nodeï¼Œå¯ä»¥ç»§ç»­å¾€ä¸‹çœ‹ã€‚

## 4. ä¾èµ–å®‰è£…çš„æ–¹å¼(é€‰è¯»)
ä¸Šè¾¹ç« èŠ‚ä¸­ï¼Œä½œè€…ä¸»è¦ä½¿ç”¨`npm install`çš„æ–¹å¼å®‰è£…ä¾èµ–ï¼Œä½†æ˜¯æœ‰æ—¶å€™ï¼Œå°¤å…¶æ˜¯ç½‘ç»œä¸å¤ªå¥½çš„æƒ…å†µä¸‹ï¼Œä¾èµ–æ€»æ˜¯ä¸èƒ½è¢«æ­£ç¡®å®‰è£…ï¼Œå‡ºç°å®‰è£…é”™è¯¯ã€‚è¿™ä¸ªæ—¶å€™å¯èƒ½å°±éœ€è¦è¿›è¡Œä¸‹ä¸€æ­¥æ“ä½œã€‚
### 4.1. npmå›½å†…é•œåƒé…ç½®
å›½å†…npmé•œåƒå¯ä»¥ç»•å¼€è¢«å¢™çš„å›°æ‰°ï¼Œä½œè€…æ¨ètaobaoçš„é•œåƒã€‚ä½ å¯ä»¥è¿™æ ·æ‰§è¡Œå‘½ä»¤ï¼š
`npm install -g cnpm --registry=https://registry.npm.taobao.org`ï¼Œè¿™æ ·å°±å…¨å±€å®‰è£…äº†ä½¿ç”¨çš„taobaoå›½å†…é•œåƒçš„cnpmæŒ‡ä»¤ã€‚ä½ åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹è¯•è¯•`cnpm install`å°±ä¼šå¿«å¾ˆå¤šã€‚
ä½ è¿˜å¯ä»¥è¿™æ ·é…ç½®é•œåƒï¼š
`npm config set registry https://registry.npm.taobao.org`ï¼Œè¿™æ ·ä½ å³ä½¿ä½¿ç”¨npmæŒ‡ä»¤å®‰è£…ï¼Œä¹Ÿä¼šèµ°å›½å†…é•œåƒå®‰è£…ã€‚

### 4.2. ä¸åŒçš„ä¾èµ–å®‰è£…ç­–ç•¥
å‰ç«¯å·¥ç¨‹åŒ–é¡¹ç›®ä¾èµ–å®‰è£…ä¸åªæœ‰npmæ–¹å¼ï¼Œè¿˜æœ‰ä»–çš„å„ç§å˜ç§ã€‚æ¯”å¦‚å®‰è£…é€Ÿåº¦å¿«ï¼Œç‰ˆæœ¬èƒ½å¤Ÿæ›´å¥½ç»Ÿä¸€çš„`yarn`æˆ–è€…è¿è¡Œé€Ÿåº¦æ›´å¿«çš„`pnpm`ã€‚ç»†å¿ƒçš„è¯»è€…å¯ä»¥å‘ç°ï¼Œä¸Šé¢`create-react-app`å®‰è£…çš„æ–¹å¼ä½¿ç”¨äº†`npx`ï¼Œè€Œæ²¡æœ‰ä½¿ç”¨`npm -g`è¿™ç§å…¨å±€æŒ‡ä»¤æ–¹å¼ã€‚åœ¨`npm 5.2`ä»¥åçš„ç‰ˆæœ¬é»˜è®¤ä¼šå®‰è£…`npx`å‘½ä»¤ï¼Œå®ƒå¯ä»¥é¿å…å…¨å±€å®‰è£…æ¨¡å—ã€‚è¿™äº›ä¸åŒçš„ç­–ç•¥åœ¨ä¹‹åçš„æ–‡ç« ä¸­ä¼šæåŠï¼Œåœ¨è¿™é‡Œä¸åšè¿‡å¤šçš„èµ˜è¿°ã€‚

### 4.3. ä½¿ç”¨nvmç®¡ç†nodeç‰ˆæœ¬
nvmæ˜¯ç›®å‰æ¯”è¾ƒä¸»æµçš„nodeç‰ˆæœ¬ç®¡ç†å·¥å…·ï¼Œç±»ä¼¼çš„è¿˜æœ‰nodistï¼ˆ`https://github.com/nullivex/nodist/releases`ï¼‰ã€‚è¿™é‡Œä»¥nvmä¸ºå‡†è¿›è¡Œä»‹ç»ã€‚
#### 4.3.1. windowsç¯å¢ƒå®‰è£…
è¿›å…¥å®˜ç½‘ä¸‹è½½é“¾æ¥`https://github.com/coreybutler/nvm-windows/releases`ï¼Œä¸‹è½½assetsä¸­çš„å®‰è£…åŒ…ï¼ˆæ–‡ç« æœ«å°¾æä¾›å®‰è£…åŒ…ï¼‰ã€‚

![13.png](/img/posts/2022-3-1/2022-3-1-6.png)

è¿™é‡Œå¯ä»¥ç›´æ¥ä¸‹è½½setupç‰ˆçš„ï¼Œè§£å‹ååŒå‡»å°±å¯å®‰è£…ã€‚å½“ç„¶ä¹Ÿå¯ä»¥é€‰æ‹©noinstallç‰ˆæœ¬çš„ï¼Œé€šè¿‡æ‰‹åŠ¨é…ç½®ç¯å¢ƒæ¥è¾¾åˆ°ç›¸åŒçš„ç›®çš„ã€‚è¿™é‡Œä»¥å®‰è£…ç‰ˆä¸ºä¾‹ã€‚ä¸‹å›¾ä¸ºå®‰è£…ç•Œé¢ï¼š

![14.png](/img/posts/2022-3-1/2022-3-1-7.png)
ä¸€è·¯nextåˆ°åº•å®Œæˆå®‰è£…å³å¯ã€‚ç¯å¢ƒå˜é‡å·²ç»è‡ªåŠ¨é…ç½®å¥½äº†ã€‚
åœ¨å‘½ä»¤è¡Œä¸­æ£€æŸ¥æ˜¯å¦å®‰è£…æˆåŠŸï¼š

![15.png](/img/posts/2022-3-1/2022-3-1-8.png)

çœ‹åˆ°ç‰ˆæœ¬è¯´æ˜å·²ç»æ­£ç¡®å®‰è£…ï¼ï¼
#### 4.3.2. MacOSç¯å¢ƒå®‰è£…ï¼ˆéœ€ç¿»å¢™ï¼‰
è¿›å…¥å®˜ç½‘ä¸‹è½½é“¾æ¥`https://github.com/nvm-sh/nvm#installing-and-updating`ï¼Œå¯ä»¥çœ‹åˆ°å®‰è£…æŒ‡å¼•ï¼Œæˆ‘ä»¬éµä»å®˜æ–¹ç»™çš„æŒ‡ä»¤ç›´æ¥æ‰§è¡Œå³å¯ï¼š
```sh
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.1/install.sh | bash
```
æ¥ä¸‹æ¥æ‚¨å¯èƒ½ä¸ä¼šçœ‹åˆ°å®‰è£…æˆåŠŸï¼Œåè€Œä¼šæç¤ºå¦‚ä¸‹ï¼š
> Failed to connect to raw.githubusercontent.com port 443

è¿™æ˜¯å› ä¸ºæŸç§ç¥ç§˜çš„ä¸œæ–¹åŠ›é‡å¯¼è‡´çš„githubè®¿é—®çš„é—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥å€ŸåŠ©ç½‘å€`https://ipaddress.com/website/raw.githubusercontent.com`æŸ¥ä¸€ä¸‹`githubusercontent.com`çš„çœŸå®IPï¼Œè¾“å…¥githubusercontent.comæŸ¥è¯¢ä¼šçœ‹åˆ°ï¼š

![16.png](/img/posts/2022-3-1/2022-3-1-9.png)
æˆ‘ä»¬æ‰¾ä¸‹è¾¹æŸ¥åˆ°çš„IPå…¶ä¸­ä¸€ä¸ªå³å¯ï¼ˆå¦‚æœä¸è¡Œå°±æ¢ç€è¯•è¯•ï¼‰ï¼Œæ‰§è¡Œä¸‹è¿°æ­¥éª¤ï¼š

1. è¿›å…¥macçš„hostæ–‡ä»¶ï¼š`sudo vim /etc/hosts`
2. æœ€ä¸‹è¾¹è¿½åŠ IPæ˜ å°„

![17.png](/img/posts/2022-3-1/2022-3-1-10.png)

ç»è¿‡è¿™ä¸¤æ­¥åå†æ¬¡å°è¯•ä¸€å“ˆï¼Œå°±å¯ä»¥æ‰§è¡ŒæˆåŠŸäº†ã€‚
```sh
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.1/install.sh | bash
```
å¦‚æœå¾ˆä¸å¹¸ä½ å’å•å‡ºç°äº†å¦‚ä¸‹é”™è¯¯ï¼Œä¸è¦æƒŠæ…Œï¼Œåº”è¯¥æ˜¯æ²¡æœ‰æ£€æµ‹åˆ°ä½ çš„githubè´¦æˆ·ï¼Œä½ åªéœ€è¦æ‰“å¼€githubä¸»é¡µç™»å½•è´¦å·é‡è¯•å³å¯ã€‚
> unable to access 'https://github.com/nvm-sh/nvm.git/': LibreSSL SSL_connect: SSL_ERROR_SYSCALL in connection to github.com:443

æœ€åï¼

å®‰è£…æˆåŠŸçš„ç•Œé¢å¦‚ä¸‹ï¼š

![18.png](/img/posts/2022-3-1/2022-3-1-11.png)

æ­¤æ—¶å…ˆä¸è¦ç€æ€¥ï¼Œå…¨å±€çš„`nvm`æŒ‡ä»¤è¿˜æ²¡æœ‰åŠ å…¥ç¯å¢ƒå˜é‡ä¸­ï¼Œéœ€è¦ä½ æ¥æ‰‹åŠ¨æ·»åŠ ã€‚æ‰§è¡Œå‘½ä»¤(ä»¥zshç»ˆç«¯ä¸ºä¾‹) `sudo vim ~/.zshrc`ï¼Œè¿›å…¥ç¼–è¾‘åï¼Œè¿½åŠ ï¼š
```sh
export NVM_DIR="$([ -z "${XDG_CONFIG_HOME-}" ] && printf %s "${HOME}/.nvm" || printf %s "${XDG_CONFIG_HOME}/nvm")"
[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh" # This loads nvm
```
ç„¶åç”Ÿæ•ˆé…ç½®æ–‡ä»¶ï¼š`source ~/.zshrc`å³å¯ã€‚

ç°åœ¨å°±è¯•è¯•nvmæŒ‡ä»¤ï¼š

![19.png](/img/posts/2022-3-1/2022-3-1-12.png)

æˆåŠŸï¼

##### 4.3.3. nvmåŸºç¡€ä½¿ç”¨

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨`nvm list`å‘½ä»¤æŸ¥çœ‹å½“å‰nodeçš„ç‰ˆæœ¬åˆ—è¡¨

![20.png](/img/posts/2022-3-1/2022-3-1-13.png)

å¯ä»¥çœ‹åˆ°ï¼Œå½“å‰åªæœ‰ç³»ç»Ÿé»˜è®¤çš„16.13.2ç‰ˆæœ¬ã€‚å¦‚æœæƒ³è¦å®‰è£…åˆ«çš„nodeç‰ˆæœ¬ï¼Œæ²¡æœ‰å¿…è¦å†å»nodeå®˜ç½‘ä¸‹è½½äº†ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨nvmæŒ‡ä»¤ä¸‹è½½ã€‚æˆ‘ä»¬å¯ä»¥å…ˆä½¿ç”¨`nvm ls-remote`çœ‹ä¸€ä¸‹å®˜æ–¹éƒ½æœ‰å“ªäº›æ­£å¼ç‰ˆæœ¬ï¼š

![21.png](/img/posts/2022-3-1/2022-3-1-14.png)

åˆ—å‡ºçš„ç‰ˆæœ¬éƒ½æ˜¯å¯ä»¥å®‰è£…çš„ï¼Œæˆ‘ä»¬è¿™é‡Œå¯ä»¥å®‰è£…ç¨³å®šç‰ˆï¼š`nvm install stable`

![23.png](/img/posts/2022-3-1/2022-3-1-15.png)

å¯ä»¥çœ‹åˆ°æˆªæ­¢ä½œè€…å†™è¿™ç¯‡æ–‡ç« æ—¶ï¼Œnodeçš„ç¨³å®šç‰ˆæœ¬æ˜¯17.4.0ï¼Œnvmä¼šè‡ªåŠ¨åˆ‡æ¢è¿›å®‰è£…çš„ç‰ˆæœ¬ä¸Šã€‚å¦‚æœæƒ³è¦è‡ªå®šä¹‰ç‰ˆæœ¬å·å®‰è£…ï¼Œå¯ä»¥ä½¿ç”¨æŒ‡ä»¤`nvm install <ç‰ˆæœ¬å·>`

![24.png](/img/posts/2022-3-1/2022-3-1-16.png)

è¿™é‡Œæˆ‘ä»¬å®‰è£…äº†12.22.10ç‰ˆæœ¬ï¼Œå†æ¬¡`nvm list`å¯ä»¥çœ‹åˆ°å·²ç»æœ‰ä¸‰ä¸ªç‰ˆæœ¬äº†ã€‚æƒ³è¦åœ¨å¤šä¸ªç‰ˆæœ¬ä¹‹é—´åˆ‡æ¢ï¼Œåªéœ€ä½¿ç”¨æŒ‡ä»¤`nvm use <ç‰ˆæœ¬å·>`å³å¯ä¸€é”®åˆ‡æ¢ï¼

![25.png](/img/posts/2022-3-1/2022-3-1-17.png)

windowsä¸‹ä½¿ç”¨è¿‡ç¨‹ä¸­è‹¥å‡ºç°å¦‚ä¸‹é”™è¯¯ï¼š

![image.png](/img/posts/2022-3-1/2022-3-1-18.png)

ä¸€èˆ¬æ˜¯vscodeæˆ–è€…ç»ˆç«¯æ²¡æœ‰ç®¡ç†å‘˜æƒé™ï¼Œä»¥ç®¡ç†å‘˜èº«ä»½æ‰“å¼€å³å¯ã€‚

è‡³æ­¤ï¼Œå‰ç«¯å·¥ç¨‹åŒ–é¡¹ç›®çš„ç¯å¢ƒé…ç½®å·²ç»ç»“æŸï¼ 

## 5. é™„ä»¶
é™„ä»¶æ¸…å•ï¼švscodeå®‰è£…åŒ…. nvmå®‰è£…åŒ…ï¼ˆwinï¼‰. atomå®‰è£…åŒ…ï¼ˆmacï¼‰ã€‚

ä¸‹è½½é“¾æ¥ï¼š
> é“¾æ¥: https://pan.baidu.com/s/1zD2s9UjXrVZ06NANnx8oXg  æå–ç : 5diu86:T2b05,## 0. å¼•è¨€
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ä¸€ä¸ªå¥½çš„å‰ç«¯äº§å“ï¼Œå¿…ç„¶æ˜¯ç”¨æˆ·ä½“éªŒä¼˜ç§€. ä½¿ç”¨æµç•…. æ•°æ®å‡†ç¡®. ç•Œé¢å‹å¥½çš„äº§å“ã€‚è¦æƒ³è¾¾åˆ°è¿™ä¸ªç›®æ ‡ï¼Œä¸€å¼€å§‹çš„æŠ€æœ¯é€‰å‹å°±éœ€è¦éå¸¸æ…é‡ï¼Œä¸èƒ½å›¾ä¸€æ—¶ä¹‹å¿«è€Œå¯¼è‡´åæœŸç»´æŠ¤å‡çº§æˆæœ¬æŒ‡æ•°çº§ä¸Šæ¶¨ï¼Œä¹Ÿä¸èƒ½å¿½è§†å›¢é˜Ÿçš„æŠ€æœ¯æ²¿é©å’Œè€æ¿å¯¹äº§å“å®šä½çš„è¦æ±‚ã€‚

> PS. æŠ€æœ¯é€‰å‹ä»è€…è§ä»ï¼Œæœ¬æ–‡åªè°ˆç»éªŒï¼Œæä¾›ä¸€ä¸ªé€‰å‹çš„æ€è·¯ï¼Œè€Œä¸æ˜¯ç»™ä½ å…·ä½“çš„æ–¹æ¡ˆ

#### é€‰å‹çš„ç›®çš„
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;é¡¾åæ€ä¹‰ï¼Œå°±æ˜¯ä¸ºäº†å®ç°æ”¶ç›Šæœ€å¤§åŒ–ï¼Œæ˜¯äº§å“è¦æ±‚å’ŒæŠ€æœ¯æˆæœ¬ä¹‹é—´çš„ä¸€ä¸ªæƒè¡¡ã€‚

## 1. ä»ä¼ä¸šçš„è§’åº¦è€ƒè™‘é€‰å‹
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ä¼ä¸šçš„å­˜æ´»å®—æ—¨æ˜¯ç”¨æœ€å°‘çš„äººåŠ›æˆæœ¬åˆ›é€ å‡ºå°½å¯èƒ½å¤šçš„ä¼ä¸šæ•ˆç›Šï¼Œä»è¿™ä¸ªå‡ºå‘ç‚¹å°±å¯ä»¥å¾—å‡ºä¼ä¸šå¯¹ä¸€ä¸ªäº§å“é€‰å‹çš„è¦æ±‚ã€‚
#### ä¿è¯äº§å“è´¨é‡æ˜¯åŸºç¡€
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;äº§å“è´¨é‡è¦è¿‡åŸºæœ¬å…³ã€‚ä¸è¦æ±‚èƒ½æœ‰å¾ˆæƒŠè‰³çš„æ•ˆæœï¼Œä½†æ˜¯ä¸€å®šè¦æ»¡è¶³å®¢æˆ·çš„è¦æ±‚ï¼Œç½‘é¡µä¸èƒ½é•¿æ—¶é—´ç™½å±ï¼Œè¦ä¸é”™ä½ä¸å¡æ­»ï¼Œæ“ä½œæ­£å¸¸ï¼Œæ•°æ®ç²¾å‡†ã€‚æ›´è¿›é˜¶ä¸€ç‚¹çš„ï¼Œå¯èƒ½è¿˜ä¼šè¦æ±‚ä¸€å®šçš„äº¤äº’å’Œè§†è§‰ä½“éªŒï¼Œè¿˜æœ‰å¯èƒ½ä¼šåŠ å…¥æ— éšœç¢æ•ˆæœã€‚

> å¦‚æœè¦åŠ å…¥å…¼å®¹é˜¿æ‹‰ä¼¯è¯­ç½‘ç«™æ’ç‰ˆçš„è¯ï¼Œå·²æœ‰çš„æ¶æ„å¯èƒ½å®Œå…¨ä¸èƒ½ç”¨ï¼Œéœ€è¦å•ç‹¬å¢åŠ ä¸€å€çš„å·¥ä½œé‡å†å†™ä¸€å¥— -_- 

#### é™ä½æˆæœ¬æ˜¯å¿…è¦æ¡ä»¶
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æˆæœ¬åŒ…æ‹¬å‰æœŸå¼€å‘æŠ•å…¥çš„äººåŠ›å’ŒåæœŸç»´æŠ¤æŠ•å…¥çš„äººåŠ›ã€‚å‰ææŠ•å…¥äººåŠ›è¶Šå¤šï¼Œå¼€å‘çš„å‘¨æœŸå¯èƒ½ä¼šçŸ­ï¼Œä½†æ˜¯ä¸ä¹‹å¯¹åº”çš„æ˜¯å›¢é˜Ÿåä½œçš„ç®¡ç†æˆæœ¬ä¼šé«˜èµ·æ¥ï¼›å‰æœŸäººæŠ•å…¥çš„å°‘ï¼Œå¯èƒ½æŠ€æœ¯é€‰å‹ä¼šæœ‰æ¼æ´æˆ–è€…å¯æ‰©å±•æ€§ä¸è¶³ï¼ŒåæœŸæ¢äººæ¥ç»´æŠ¤çš„è¯å¯èƒ½ä¼šä¸¾æ­¥ç»´è‰°ï¼Œä¸å¾—ä¸é‡æ„ã€‚

## 2. ä»äº§å“æŠ€æœ¯å½¢æ€ä¸Šæ¥è€ƒè™‘é€‰å‹
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;äº§å“çš„æŠ€æœ¯å½¢æ€æŒ‡çš„æ˜¯å…¶æŠ€æœ¯æ¨¡å¼ï¼Œåˆ†ä¸ºçº¯å‰ç«¯å¼€å‘. å‰åç«¯åˆ†ç¦»å’Œåç«¯é©±åŠ¨çš„å¼€å‘ã€‚

#### çº¯å‰ç«¯é¡µé¢
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;çº¯å‰ç«¯çš„ä¸€èˆ¬æ˜¯ä¸€äº›é™æ€é¡µé¢ï¼Œæ¯”å¦‚ä¸ªäººåšå®¢. ä¸€äº›æ´»åŠ¨é¡µé¢. å®£ä¼ ç½‘ç«™ç­‰ã€‚ä¸€èˆ¬æ¥è¯´ä¸€ä¸ªäººè¶³ä»¥ï¼Œæ­¤æ—¶ä½ å°±ä¸éœ€è¦è€ƒè™‘ä»€ä¹ˆæ¶æ„äº†ï¼Œä½¿ç”¨ä½ æœ€æ“…é•¿çš„æŠ€æœ¯æ ˆå’Œæˆç†Ÿçš„ç”Ÿæˆå·¥å…·ï¼Œèƒ½å¤Ÿå¿«é€Ÿå †ç Œèµ·æ¥é¡µé¢å°±å¥½ã€‚

#### å‰åç«¯åˆ†ç¦»
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;è¿™ç§äº§å“å½¢æ€åº”è¯¥æ˜¯ç›®å‰å¸‚é¢ä¸Šå¤§å¤šæ•°äº§å“çš„å¼€å‘æ¨¡å¼ï¼Œæ¯”å¦‚å¤§å‹çš„ToBé¡¹ç›®. æˆç†Ÿçš„APPç½‘é¡µå®¢æˆ·ç«¯. ç½‘é¡µè´­ç‰©ç­‰ã€‚è¿™ç§çš„äº§å“ï¼Œé¡µé¢æ¸²æŸ“åŸºæœ¬ä¸Šæ˜¯å‰ç«¯çš„å·¥ä½œï¼Œåç«¯åªéœ€è¦æä¾›APIæ–‡æ¡£å³å¯ã€‚

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;è¿™æ ·çš„äº§å“ï¼Œæ¨èåšæˆWebç«¯æ¸²æŸ“æ¡†æ¶å¼€å‘çš„å•é¡µåº”ç”¨ï¼Œæˆ–è€…ä½¿ç”¨node.jsåšæˆç›´å‡ºæ¨¡æ¿æ¸²æŸ“å¼çš„ã€‚å¦‚æœé¡¹ç›®ä¸šåŠ¡æ¯”è¾ƒå¤šï¼Œå¯ä»¥è€ƒè™‘éƒ¨ç½²å‰ç«¯å¾®æœåŠ¡ã€‚

#### åç«¯ä¸»å¯¼å¼€å‘
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;åç«¯ä¸»å¯¼çš„äº§å“å›¢é˜Ÿï¼Œä¸€èˆ¬ä¸Šä¸ä¼šæœ‰å•ç‹¬çš„å‰ç«¯å¼€å‘ç»„ï¼Œéƒ½æ˜¯ä¸€ä¸ªå›¢é˜Ÿé…ä¸€åˆ°ä¸¤ä¸ªå‰ç«¯æ¥é…åˆåç«¯å¼€å‘ã€‚æ­¤æ—¶ä½œä¸ºå‰ç«¯ï¼Œä½ å°±ä¸éœ€è¦æœ‰å¤ªå¤šè‡ªå·±çš„æƒ³æ³•ï¼Œä¸€åˆ‡ä»ç®€å³å¯ã€‚æ¯”å¦‚ä½¿ç”¨å‰ç«¯é¢„å¤„ç†å™¨Sassæ—¶ï¼Œå¯èƒ½å°±éœ€è¦æ…é‡ä¸€äº›ã€‚åŒæ—¶ä¹Ÿä¸è¦æ ‡æ–°ç«‹å¼‚ï¼Œä½¿ç”¨è¿™ä¸ªå›¢é˜Ÿæ²¡æœ‰ç”¨è¿‡çš„å‰ç«¯æ¡†æ¶ï¼Œè·ŸéšåŸæ¥çš„æŠ€æœ¯æ ˆèµ°å³å¯ã€‚

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;è¿™æ—¶å€™ä½ å¯èƒ½å°±ä¼šæ¯”è¾ƒç—›è‹¦ï¼Œä¸€æ–¹é¢è¦ç»´æŠ¤å‰ä»»å†™çš„ä¹±ä¸ƒå…«ç³Ÿçš„ä»£ç ï¼Œä¸€æ–¹é¢åˆä¸èƒ½ç”¨è‡ªå·±æ“…é•¿çš„æŠ€æœ¯ã€‚ä½œè€…å°±â€œæœ‰å¹¸â€åšè¿‡è¿™æ ·çš„äº§å“ã€‚å½“æ—¶åç«¯çš„è¦æ±‚æ˜¯APIæ¥å£æ˜ å°„åç§°ä¸èƒ½å†™æ­»åˆ°ä»£ç é‡Œï¼Œå‰ç«¯è¦åšæˆå¯é…ç½®å¼çš„ï¼›åç«¯ä¸æ„¿æ„ä¿®æ”¹è¿”å›çš„JSONï¼Œæˆ‘ä¸å¾—ä¸ä¸€å±‚å±‚æ¥è§£æåƒæ— åº•æ´ä¸€æ ·æ·±çš„JSONæ•°æ®ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œä¸å›¢é˜Ÿç§¯ææ²Ÿé€šæ˜¯ä¸€æ–¹é¢ï¼Œå¦ä¸€æ–¹é¢æ˜¯æ‰¾å‡†è‡ªå·±çš„å®šä½æ¥ä½¿ç”¨æŠ€æœ¯ã€‚è¿™æ ·æ‰æ˜¯ä¸€ä¸ªå¥½çš„ç¨‹åºå‘˜çš„åŸºæœ¬ä¿®å…»ï¼Œæ¯•ç«Ÿè¿™ä¸ªç¨‹åºä½ ä¸å¯èƒ½è‡ªå·±ä¸€ä¸ªäººæ‹¿å‡ºå»å–ä¸æ˜¯ã€‚

## 3. ä»é¢å‘ç”¨æˆ·ç¾¤æ¥è€ƒè™‘é€‰å‹
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å‰ç«¯äº§å“é¢å‘çš„ç”¨æˆ·ç¾¤ä½“ä¸åŒï¼Œå±•ç°çš„å½¢å¼ä¼šæœ‰å·®å¼‚ï¼Œç°ä»£äº’è”ç½‘å¼€å‘å¯¹äºåŒä¸€ä¸ªç”¨æˆ·ç¾¤åˆåˆ†ä¸ºPCç«¯å’Œç§»åŠ¨ç«¯äº§å“ä¸¤ç§ã€‚ä¸»è¦åˆ†ç±»æœ‰å¦‚ä¸‹å‡ ç§ï¼šå¤–éƒ¨ç”¨æˆ·PCç«¯. å¤–éƒ¨ç”¨æˆ·ç§»åŠ¨ç«¯. å†…éƒ¨ç”¨æˆ·PCç«¯. å†…éƒ¨ç”¨æˆ·ç§»åŠ¨ç«¯ï¼›åŒæ—¶å›½å†…å¤–ç”¨æˆ·çš„ä½¿ç”¨ä¹ æƒ¯ä¹Ÿä¼šæœ‰ç»†å¾®çš„å·®åˆ«ã€‚

#### å¤–éƒ¨ç”¨æˆ·PCç«¯
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å¯¹äºå¤–éƒ¨ç”¨æˆ·ï¼Œè§†è§‰ä½“éªŒæ˜¯ç¬¬ä¸€ä½çš„ï¼ŒPCç«¯ä¸ŠSSRä¹Ÿæ˜¯å¾ˆæœ‰å¿…è¦çš„ã€‚ä½ å¯èƒ½éœ€è¦ä¸€ä¸ªæ¯”è¾ƒå®Œå–„çš„æ¡†æ¶ï¼Œæ”¯æŒSSRé…ç½®å’ŒUIåŠ¨ç”»åº“ï¼Œè€Œä¸”è¦è°ƒç ”æ¸…æ¥šæ˜¯å¦è¦æ”¯æŒIEç”¨æˆ·ï¼ˆç”šè‡³æ˜¯IE8ï¼‰ï¼Œ`JQuery`(æˆ–**Zepto.js**) æœ‰æ—¶ä¹Ÿæ˜¯æ¯”è¾ƒç®¡ç”¨çš„ã€‚

#### å¤–éƒ¨ç”¨æˆ·ç§»åŠ¨ç«¯
**1. ç§»åŠ¨ç«¯è®¿é—®çš„é¡µé¢**

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å³ç”¨æ‰‹æœºæµè§ˆå™¨è®¿é—®Webé¡µé¢ã€‚é¡µé¢åˆ‡æ¢è¿˜éƒ½æ˜¯ä¼ ç»Ÿé“¾æ¥è·³è½¬ï¼Œå±äºä¼ ç»ŸWebé¡µé¢ï¼Œå‰åç«¯åˆ†ç¦»å¼€å‘ï¼Œé¡µé¢ç›´å‡ºæ¸²æŸ“ï¼Œä¸PCç«¯çš„æ¶æ„åŸºæœ¬ä¸€è‡´ï¼Œåªæ˜¯è¦åšä¸€äº›é€‚é…å·¥ä½œã€‚

**2. ç§»åŠ¨ç«¯Nativeåº”ç”¨**

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;è¿™éƒ¨åˆ†äº§å“ç›®å‰æ¥è¯´å¯¹äºå‰ç«¯å¼€å‘ç”¨çš„æŠ€æœ¯æ ˆæ¯”è¾ƒå¤šçš„æ˜¯`React Native`ï¼Œä½œè€…å°±æ›¾ç»åšè¿‡APPé‡Œçš„å¹¿å‘Šé¡µå’Œæ´»åŠ¨è¯¦æƒ…é¡µé¢ã€‚å¦‚æœä½ çš„äº§å“æœ‰NativeåŒ–çš„è¦æ±‚ï¼Œé‚£ä¹ˆæ•´ä¸ªäº§å“æŠ€æœ¯æ ˆé¦–é€‰Reactï¼Œæ¯•ç«Ÿè¦å’ŒReact Nativeå…¼å®¹ã€‚

#### å†…éƒ¨ç³»ç»Ÿç”¨æˆ·
**1. PCè®¿é—®çš„é¡µé¢**

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å†…éƒ¨ç”¨æˆ·ä½¿ç”¨çš„ç®¡ç†ç³»ç»Ÿã€‚è¯¸å¦‚OA. é¡¹ç›®ç®¡ç†ç³»ç»Ÿç­‰ã€‚è¿™äº›éœ€æ±‚æ¯”è¾ƒé€šç”¨ï¼Œå¯ä»¥ä½¿ç”¨å¿«é€Ÿå¼€å‘çš„æ¶æ„ï¼Œä½ ç”šè‡³éƒ½ä¸éœ€è¦ä½¿ç”¨å…¬å¸å†…éƒ¨çš„ç»„ä»¶åº“ï¼Œå¼€æºçš„æ¡†æ¶ + UIåº“ + å›¾è¡¨åº“å®Œå…¨å¯ä»¥æ»¡è¶³è¦æ±‚ã€‚

**2. ç§»åŠ¨ç«¯è®¿é—®çš„é¡µé¢**

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ä¼ä¸šå†…éƒ¨ä½¿ç”¨çš„ç§»åŠ¨ç«¯äº§å“ï¼Œå¤§å¤šä¾é™„äºä¼ä¸šå¾®ä¿¡ç­‰APPã€‚å°±æ‹¿ä¼ä¸šå¾®ä¿¡ä¸¾ä¾‹ï¼Œå·¥ä½œå°å¼€æ”¾æœ‰APIï¼Œæ”¯æŒäºŒæ¬¡å¼€å‘ã€‚è¿™æ ·çš„å†…åµŒH5é¡µé¢ä¹Ÿå¤šä¸ºå•é¡µåº”ç”¨ï¼Œå•ç‹¬éƒ¨ç½²å¹¶é…ç½®å¾®ä¿¡ç›¸å…³éªŒè¯å³å¯ã€‚

#### æµ·å¤–ç”¨æˆ·
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;é’ˆå¯¹æµ·å¤–ç”¨æˆ·ï¼Œé…ç½®PWAæˆ–è€…AMPåº”è¯¥ä¼šæˆä¸ºæ¶æ„é€‰æ‹©çš„ä¸€ä¸ªå¿…é€‰é¡¹ã€‚ç›®å‰ä¸‰å¤§æ¡†æ¶ä¹Ÿéƒ½æ™®éæ”¯æŒPWAã€‚

## 4. ä»äº§å“é¢„æœŸçš„æ•ˆæœæ¥è€ƒè™‘é€‰å‹

#### çŸ­ç”Ÿå‘½å‘¨æœŸ
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;çŸ­ç”Ÿå‘½å‘¨æœŸçš„äº§å“é€šå¸¸è¦æ±‚å¿«é€Ÿèµ·æ­¥ï¼šé—¨æ§›ä½. ä¹¦å†™è‡ªç”±. ä¸å¼ºåˆ¶éµå¾ªä»»ä½•æœ€ä½³å®è·µï¼Œä½¿ç”¨è¿‡åå°±åºŸå¼ƒã€‚è¿™æ—¶å€™å°±éœ€è¦ä½¿ç”¨ç®€å•çš„. ä¸è¿‡åº¦å°è£…çš„æ¶æ„ï¼Œä¸ä½¿ç”¨`eslint`å’Œ`Typescript`ã€‚ç”šè‡³ä¸éœ€è¦å®‰æ’code reviewï¼Œå› ä¸ºä¸è€ƒè™‘åæœŸç»´æŠ¤ã€‚

#### é•¿æœŸäº§å“
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å¯¹äºé•¿æœŸäº§å“ï¼ŒåæœŸç»´æŠ¤æ˜¯æ¯”è¾ƒé‡è¦çš„ã€‚è¦é€‰æ‹©å…·æœ‰å®Œæ•´ç”Ÿæ€çš„æ¶æ„ï¼Œèƒ½å¤Ÿå¹³ç¨³å‡çº§ï¼Œé‡‡ç”¨æ¨¡å—åŒ–å°è£…ä¸šåŠ¡ç»„ä»¶ï¼Œä¸ç”¨ç¡¬ç¼–ç ï¼Œæ§åˆ¶å•æ–‡ä»¶ä»£ç è¡Œæ•°ç­‰ã€‚åŒä¸€ä¸ªäº§å“çº¿ä¸Šçš„äº§å“è¿‡å¤šï¼Œæ¯”å¦‚é˜¿é‡Œäº‘çš„æ¶æ„ï¼Œä¸Šå¾®æœåŠ¡ä¹Ÿæ˜¯å¿…è¦çš„ã€‚

#### æ¢ç´¢æ€§äº§å“
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æ¢ç´¢å‹äº§å“å¾€å¾€ä¹Ÿæ˜¯çŸ­å‘¨æœŸäº§å“ï¼Œæ˜¯éœ€è¦æ¯”è¾ƒæ¿€è¿›çš„æ¢ç´¢æ–°çš„å‰æ²¿æŠ€æœ¯ã€‚å¦‚æœæˆåŠŸäº†ï¼Œå¯èƒ½ä¼šè¿‡æ¸¡åˆ°é•¿å‘¨æœŸäº§å“ä¸Šå»ã€‚è¿™ä¸­é—´éœ€è¦æ¶æ„å¸ˆåšå¥½å¯ç§»æ¤çš„èƒ½åŠ›ã€‚

## 5. æ¯”è¾ƒé€šç”¨çš„å»ºè®®

#### æ¡†æ¶é€‰æ‹©
> `React` OR `Vue` OR `Angular` ?

ç®€å•ä»‹ç»ï¼š
1. Vueä¸Šæ‰‹éš¾åº¦æœ€ä½ï¼Œå­¦å¥½äº†ä¸å®¹æ˜“ï¼Œ`2.0`å¾€`3.0`è¿ç§»ä¹Ÿä¸æ˜¯æ— åˆ›çš„ï¼Œé€æ¸å¼€å§‹å¯¹`TS`æ”¯æŒï¼Œä½†ä¸æ˜¯å¤©ç„¶æ”¯æŒï¼Œéœ€è¦ä½ åœ¨é…ç½®ä¸€ä¸‹ä¸‹ã€‚
2. Reactæ€§èƒ½å¾ˆå¥½ï¼Œä½†åŒæ—¶ä¹Ÿæ¯”è¾ƒéš¾å­¦ï¼Œç‰ˆæœ¬æ›´æ–°çš„å¾ˆå¿«ï¼Œæ–°ç‰ˆæœ¬çš„`Hooks`å¾ˆå¤šäººä¸èƒ½é€‚åº”ã€‚ä¸å¤æ‚å¯¹åº”çš„æ˜¯ä»–çš„çµæ´»æ€§ï¼Œç”Ÿæ€ä¹Ÿåšå¾—å¾ˆå¥½ï¼ŒåŒæ—¶ä¹Ÿæ”¯æŒ`TS`ã€‚
3. Angularå¤©ç„¶æ”¯æŒ`TS`ï¼Œå†…ç½®`Rxjs`ï¼Œå¯åµŒå…¥. æ³¨å…¥å’Œè‡ªå¸¦å•å…ƒæµ‹è¯•ã€‚ä½¿ç”¨è¿‡`Java`çš„åŒå­¦åº”è¯¥ä¼šæ¯”è¾ƒå®¹æ˜“æ¥å—ã€‚ç›®å‰åœ¨å›½å†…ä½¿ç”¨ç‡æ¯”è¾ƒä½ã€‚

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ä½œè€…çš„å»ºè®®æ˜¯ï¼Œ**ç”¨ä½ å›¢é˜Ÿå¸¸ç”¨çš„**ï¼è¿™æ˜¯æœ€ä¸»è¦çš„ï¼Œæˆ‘ä¹‹å‰çš„å…¬å¸æ˜¯ä»æœ€æ—©çš„å‰ç«¯MVCæ¶æ„æ¼”è¿›æ¥çš„ï¼Œä¿ç•™äº†å¤§é‡` Angular 1.x `çš„é¡¹ç›®ï¼Œé‚£å‡çº§è‡ªç„¶æ˜¯å¾€ `2.x `è¿ç§»ï¼ˆè™½ç„¶å®Œå…¨æ˜¯ä¸¤ä¸ªæ¡†æ¶ï¼Œä½†å¹¶ä¸å®Œå…¨æ˜¯! ğŸ¶ï¼›æ­¤å¤–ï¼Œä½ çš„å›¢é˜Ÿå¯¹äºä¹‹å‰ä½¿ç”¨çš„æ¡†æ¶æœ‰ç€å¤§é‡çš„æŠ€æœ¯ç§¯æ·€ï¼Œå°è£…äº†å¤§é‡çš„å·¥å…·åº“. å›¾è¡¨åº“æ¥æ”¯æŒè¿™ä¸ªæ¡†æ¶ï¼Œè´¸ç„¶åˆ‡æ¢æ¶æ„å¯èƒ½éœ€è¦é‡å¤é€ è½®å­ï¼Œå¢åŠ å­¦ä¹ æˆæœ¬ï¼Œé™¤éä½ çš„å®¢æˆ·æŒ‡æ˜è¦ä½ ç”¨ï¼

#### ä¾èµ–å‡çº§çš„å¹³æ»‘åº¦
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;é¡¹ç›®åœ¨æ¡†æ¶å‡çº§çš„æ—¶å€™ï¼Œä½ çš„package.jsoné‡Œçš„ä¾èµ–åº”èƒ½å¤Ÿå¹³æ»‘å‡çº§ï¼Œä½ åœ¨å¼•ç”¨ä¾èµ–ä¹‹å‰ï¼Œè¦å…ˆçœ‹å…¶ä¸»é¡µä¸Šæè¿°çš„æ”¯æŒçš„æ¡†æ¶ç‰ˆæœ¬ï¼Œå¹¶ä¸”è¦æ¸…æ¥šå…¶å°†æ¥ä¼šä¸ä¼šæ”¯æŒæ–°ç‰ˆæœ¬çš„æ¡†æ¶ã€‚å¯¹äºä¸€äº›å·¥å…·å‹çš„ä¾èµ–éƒ½è¿˜å¥½è¯´ï¼Œä½†æ˜¯æœ‰äº›ä¾èµ–ï¼Œæ¯”å¦‚`moment.js`å“ªä¸€å¤©è¯´å…¶ä¸æ”¯æŒ`React18`äº†ï¼ˆå¼€ä¸ªç©ç¬‘ï¼‰ï¼Œä½ çš„é‡æ„æˆæœ¬å°±ä¼šå¾ˆé«˜ã€‚

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ä½œè€…ç»™çš„å»ºè®®æ˜¯ï¼Œå°å‹é¡¹ç›®ç”¨æˆç†Ÿçš„å¼€æºUIåº“å’Œå·¥å…·åº“æ²¡æœ‰å…³ç³»ï¼Œå°†æ¥é‡æ„çš„æˆæœ¬è¿˜èƒ½æ¥å—ï¼Œå†µä¸”å°†æ¥ä¹Ÿä¸å¤ªä¼šæ¶‰åŠåˆ°ä¸»ç‰ˆæœ¬çš„é¢‘ç¹æ›´æ–°ã€‚å¦‚æœæ˜¯é•¿æœŸç»´æŠ¤çš„é‡è¦é¡¹ç›®ï¼Œå»ºè®®ä¸»è¦çš„ä¾èµ–ï¼Œæ¯”å¦‚UIåº“ç­‰æœ€å¥½ä½¿ç”¨å…¬å¸å†…éƒ¨çš„ï¼Œè¿™æ ·åœ¨æ¡†æ¶å‡çº§çš„æ—¶å€™ï¼ŒUIå¯ä»¥åŒæ­¥è·Ÿç€å‡çº§å°±å¥½ï¼Œè€Œä¸ç”¨çœ‹ç¬¬ä¸‰æ–¹åº“çš„è„¸è‰²äº†ã€‚

#### TS or JS
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å›¢é˜Ÿæ²¡ç”¨è¿‡TSï¼Œå°±ä¸è¦è´¸ç„¶ç”¨ï¼Œä¸€ç›´ç”¨TSçš„è¯å°±ä¸€å®šè¦ç”¨ã€‚å¿«é€Ÿé¡¹ç›®ç”¨JSï¼Œå¤§å‹é¡¹ç›®ç”¨TSã€‚

#### UI/å›¾è¡¨åº“é€‰æ‹©
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æœ‰èƒ½åŠ›å°±å›¢é˜Ÿè‡ªå·±å¼€å‘ï¼Œå·®ä¸€ç‚¹çš„å°±å¯¹å¼€æºåº“ï¼Œæ¯”å¦‚UIåº“åƒ`antd`. `elementUI`. `MaterialUI`ç­‰ï¼Œå›¾è¡¨åº“å¦‚`D3.js`. `Apache ECharts`. `g2plot`è¿›è¡ŒäºŒæ¬¡å°è£…åä½¿ç”¨ã€‚

#### ä½œè€…å¸¸ç”¨çš„æŠ€æœ¯æ ˆ
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ä¸‹é¢æ˜¯ä½œè€…å¸¸ç”¨çš„æŠ€æœ¯æ ˆï¼Œç»è¿‡å…¬å¸åå¤æ‰“ç£¨è¿‡çš„ï¼Œæœ‰ä¸€å®šçš„å‚è€ƒä»·å€¼ï¼Œä½†ä¹Ÿä¸è¦ç›²ç›®ç›¸ä¿¡ã€‚

1. `Angular9+` + `ng-zorro` (æˆ–è€…è‡ªå»ºç»„ä»¶åº“) + `lodash-es` + `echarts` + `jsplumb`.
2. `React17+` + `antd/Material UI`ï¼ˆæˆ–è€…è‡ªå»ºç»„ä»¶åº“ï¼‰ + è‡ªå»ºAPI Serviceåº“ + å…¬å¸è‡ªå»ºå¾®æœåŠ¡æ¶æ„ + `moment.js` + `Typescript` + `webpack`ï¼ŒçŠ¶æ€ç®¡ç†ä½¿ç”¨`mobx`.
3. `Vue2` + `Vuex` + `elementUI` + `echarts` + `axios`.
4. ç±»åº“ä½¿ç”¨ `rollup`

## 6. ç»“è®º
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;æ²¡æœ‰æœ€å¥½çš„æ¶æ„é€‰æ‹©ï¼Œåªæœ‰é€‚åˆè‡ªå·±çš„ã€‚ä¹Ÿä¸è¦ç›²ç›®ç›¸ä¿¡åˆ«äººçš„ç»éªŒï¼Œè¿˜æ˜¯è¦åŸºäºè‡ªå·±çš„äº§å“å’Œå›¢é˜Ÿè¿›è¡Œè°ƒç ”åï¼ŒæŒ‰ç…§å®äº‹æ¥åˆ¶å®šç­–ç•¥ã€‚


> æ¬¢è¿è¯„è®ºäº¤æµï¼å¦‚æœå‘ç°æœ‰ä¸è¶³çš„åœ°æ–¹ï¼Œå¸Œæœ›å„ä½å¤§ç¥ä¸åèµæ•™ï¼0:{"buildId":"gG-fcHfRh54-2G67d48NM","rsc":["$","$1","c",{"children":[["$","$L2",null,{"content":{"en":{"projects":[{"id":"1","title":"Pixel-UI","description":"An open-source Vue component library focusing on pixel style design.","link":"https://maomentai817.github.io/pixel-ui/","image":"/img/projects/pixel-ui.webp","tags":["Vue","Pixel Style","UI"],"category":"UI"},{"id":"2","title":"Pixel-UI React","description":"ä¸€ä¸ªå¼€æºçš„ React ç»„ä»¶åº“ï¼Œä¸“æ³¨äºåƒç´ é£æ ¼è®¾è®¡ã€‚","link":"https://maomentai817.github.io/pixel-ui-react/","image":"/img/projects/pixel-ui-react.webp","tags":["Vue","Pixel Style","UI"],"category":"UI"},{"id":"3","title":"Dux-UI","description":"A React component library, providing one-stop project setup, component development, and documentation system deployment using dumi.","link":"https://heiheihoho1213.github.io/dux-ui/","image":"/img/projects/dux-ui.webp","tags":["React","Component Library"],"category":"UI"},{"id":"2","title":"CodeReview AI","description":"A code review tool based on AI, supporting multiple languages.","link":"https://code-review-home.vercel.app/","image":"/img/projects/code-review.webp","tags":["AI","Code Review"],"category":"Tools"},{"id":"3","title":"Chinese Color Palette","description":"A color palette for Chinese style.","link":"https://heiheihoho1213.github.io/monto-color/","image":"/img/projects/china-color.webp","tags":["Color Palette"],"category":"Tools"},{"id":"1","title":"Colorful Bookmark","description":"A colorful tag bookmark extension for Chrome.","link":"https://chromewebstore.google.com/detail/colorful-bookmark/ilcmekmgeldhckdembghkiohkdffihpe?hl=zh-CN&utm_source=ext_sidebar","image":"/img/projects/colorful-bookmark.webp","tags":["Chrome Extension"],"category":"Tools"},{"id":"4","title":"Timestamp Converter-Time Zone Clock","description":"A timestamp converter and time zone clock extension for Chrome.","link":"https://chromewebstore.google.com/detail/%E6%97%B6%E9%97%B4%E6%88%B3%E8%BD%AC%E6%8D%A2-%E6%97%B6%E5%8C%BA%E6%97%B6%E9%92%9F/pjcapgdifnhgkkojoggfdlijpelpohcf?hl=zh-CN&gl=DE","image":"/img/projects/clock.webp","tags":["Chrome Extension"],"category":"Tools"},{"id":"1","title":"Web Themes Switch","description":"Use css variables to implement theme switching, support black mode, light mode and dark mode.","link":"https://code.juejin.cn/pen/7317573307016806435","image":"/img/projects/themes-switch.webp","tags":["CSS"],"category":"Web Themes Switch"},{"id":"2","title":"Ant Design Themes Switch","description":"Use antd's theme to implement theme switching, support light mode and dark mode.","link":"https://heiheihoho1213.github.io/antd-theme/","image":"/img/projects/themes-switch-1.webp","tags":["CSS"],"category":"Web Themes Switch"},{"id":"3","title":"Sass Preprocessor Theme Switch","description":"Use Sass preprocessor to implement theme switching, support light mode, blue mode and dark mode.","link":"https://heiheihoho1213.github.io/sass-theme/","image":"/img/projects/themes-switch-2.webp","tags":["CSS"],"category":"Web Themes Switch"}],"blog":[{"id":"1","title":"ğŸ® ä» NES åˆ°ç°ä»£ Web â€”â€” åƒç´ é£ç»„ä»¶åº“ Pixel UI  React ç‰ˆæœ¬ï¼Œæ¬¢è¿å¤§å®¶ä¸€èµ·å‚ä¸è¿™ä¸ªé¡¹ç›®","date":"2025-11-19","readTime":"3 min","excerpt":"æ˜é‡‘ä½œè€… @çŒ«é—·å°817 çš„ Pixel U Vue3 ç‰ˆä¸Šçº¿äº†ï¼Œç°åœ¨æˆ‘ä¸ä»–åˆä½œçš„ React ç‰ˆä¹Ÿæ¥äº†...","tags":["REACT","GITHUB","UI/UX"],"content":"$3","slug":"Pixel-UI-React"},{"title":"React æºç è§£è¯»","date":"2024-04-25","readTime":"10 min","excerpt":"ä»‹ç» React çš„è™šæ‹Ÿ DOMã€Fiber ç»“æ„ã€è°ƒåº¦å™¨ç­‰æ ¸å¿ƒæ¦‚å¿µå’Œå®ç°åŸç† ...","tags":["React","æºç è§£è¯»"],"content":"$4","slug":"react-source"},{"title":"å›¾ç‰‡æ‡’åŠ è½½ï¼šä»ä½åƒç´ é¢„è§ˆåˆ°é«˜æ¸…åŠ è½½","date":"2024-02-07","readTime":"10 min","excerpt":"ä»‹ç»å›¾ç‰‡æ‡’åŠ è½½çš„å®ç°æ–¹æ³• ...","tags":["æ€§èƒ½ä¼˜åŒ–","å›¾ç‰‡æ‡’åŠ è½½"],"content":"$5","slug":"react-18-use-12"},{"title":"å‰ç«¯ä¸»é¢˜åˆ‡æ¢æµ…æï¼šä½¿ç”¨å‰ç«¯CSSæ¡†æ¶","date":"2024-01-25","readTime":"2 min","excerpt":"ä½¿ç”¨å‰ç«¯CSSæ¡†æ¶å®ç°ä¸»é¢˜åˆ‡æ¢ ...","tags":["CSS","ä¸»é¢˜åˆ‡æ¢"],"content":"$6","slug":"theme-css-frame"},{"title":"å‰ç«¯ä¸»é¢˜åˆ‡æ¢æµ…æï¼šCSS-IN-JS","date":"2024-01-25","readTime":"2 min","excerpt":"ä½¿ç”¨CSS-IN-JSå®ç°ä¸»é¢˜åˆ‡æ¢ ...","tags":["CSS","ä¸»é¢˜åˆ‡æ¢"],"content":"$7","slug":"theme-css-in-js"},{"title":"å‰ç«¯ä¸»é¢˜åˆ‡æ¢æµ…æï¼šä½¿ç”¨CSSé¢„å¤„ç†å™¨","date":"2024-01-25","readTime":"2 min","excerpt":"ä½¿ç”¨CSSé¢„å¤„ç†å™¨å®ç°ä¸»é¢˜åˆ‡æ¢ ...","tags":["CSS","ä¸»é¢˜åˆ‡æ¢"],"content":"## CSS é¢„å¤„ç†å™¨\n\næˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªä¾‹å­ï¼š[sass é¢„ç¼–è¯‘ theme](https://duheng1992.github.io/sass-theme/)\n\nå°†æ‰€æœ‰çš„æ ·å¼æ–‡ä»¶ä½¿ç”¨ Sass é¢„å…ˆå®šä¹‰å¥½ï¼š\n\n![image.png](/img/posts/2024-1-25/2024-1-25-5.png)\n\nç„¶åå†™ä¸€ä¸ª `buildThemes.js` è„šæœ¬åœ¨æ‰“åŒ…å‰ç¼–è¯‘ä¸º cssï¼Œç„¶åå°†è¿™ä¸ªæ–‡ä»¶åŠ¨æ€æ’å…¥åˆ° head é‡Œï¼š\n\n```js\nconst createLinkElementWithKey = (key) => {\n  const linkEl = document.createElement('link');\n  linkEl.setAttribute('rel', 'stylesheet');\n  linkEl.classList.add(getClassNameForKey(key));\n  document.head.appendChild(linkEl);\n  return linkEl;\n};\n\n...\n// åˆ‡æ¢æ—¶è°ƒç”¨\nconst setStyle = (key = 'theme', path = 'white') => {\n  getLinkElementForKey(key).setAttribute('href', `sass-theme/assets/themes/${path}.css`);\n}\n```\n\nç¤ºæ„å›¾ï¼š\n![image.png](/img/posts/2024-1-25/2024-1-25-6.png)\n\n> è„šæœ¬çš„å†™æ³•è§ [Demo](https://github.com/heiheihoho1213/sass-theme/tree/master)\n\næœ€ç»ˆæ•ˆæœï¼š\n\n![image.png](/img/posts/2024-1-25/2024-1-25-7.png)\n\n> åœ¨æˆ‘è¿™ä¸ª demo é‡Œï¼Œå…¶å®ä¹Ÿæ˜¯æŠŠä¸»é¢˜æ ·å¼æŒ‚è½½ä¸ºå…¨å±€çš„ css å˜é‡ï¼Œåªæ˜¯ä½¿ç”¨ css é¢„å¤„ç†å™¨è¿‡åº¦äº†ä¸€ä¸‹\n\n\nä¼˜ç‚¹ï¼š\n\n- æ ·å¼åˆ‡æ¢æµç•…ï¼Œä¸ä¼šå¡é¡¿\n- è¯­æ³•æ›´å¤šæ ·ï¼Œå¼€å‘æˆæœ¬ä½\n- ä¸ css å˜é‡ä¸€æ ·ï¼Œæ–°å¢æˆ–ä¿®æ”¹æ ·å¼ï¼Œåªéœ€è¦æ”¹åŠ¨ Scss/Less å˜é‡å³å¯\n\nç¼ºç‚¹ï¼š\n\n- éœ€è¦åœ¨ç¼–è¯‘æ—¶æ‰‹åŠ¨ç¼–è¯‘ï¼Œè¿è¡Œæ—¶æ²¡åŠæ³•çƒ­æ›¿æ¢\n- å­¦ä¹ æˆæœ¬é«˜ä¸€äº›","slug":"theme-css-preprocessor"},{"title":"å‰ç«¯ä¸»é¢˜åˆ‡æ¢æµ…æï¼šä½¿ç”¨CSSå˜é‡","date":"2024-01-25","readTime":"2 min","excerpt":"ä½¿ç”¨CSSå˜é‡å®ç°ä¸»é¢˜åˆ‡æ¢ ...","tags":["CSS","ä¸»é¢˜åˆ‡æ¢"],"content":"## CSS å˜é‡\n\nè¿™ä¸ªæ–¹æ¡ˆæ˜¯ç›®å‰ä¸»æµæ¨èçš„æ–¹æ¡ˆã€‚åœ¨ä»‹ç»ä¹‹å‰ï¼Œå…ˆè®²ä¸€ä¸‹æµè§ˆå™¨çš„å‡ ä¸ªæ–°ç‰¹æ€§ã€‚\n\n#### color-scheme æ–¹æ¡ˆ\n \n [color-scheme](https://developer.mozilla.org/zh-CN/docs/Web/CSS/color-scheme) æ˜¯æµè§ˆå™¨æ™®éæ”¯æŒçš„é…ç½®ä¸»é¢˜çš„å±æ€§ã€‚ä»–è¡¨ç¤ºè°ƒç”¨æ“ä½œç³»ç»Ÿé»˜è®¤çš„ä¸»é¢˜æ–¹æ¡ˆè¦†ç›–å½“å‰å…ƒç´ æ ·å¼ï¼š\n \n [color-schemeï¼šCSS å˜é‡ä¸»é¢˜åˆ‡æ¢æ¡ˆä¾‹](https://code.juejin.cn/pen/7317573307016806435)\n \n#### è‡ªå®šä¹‰æ–¹æ¡ˆ\n\nå¦‚æœè¦è‡ªå®šä¹‰å˜é‡ï¼Œå¯ä»¥è¿™æ ·å®šä¹‰è‡ªå·±çš„æ ·å¼å˜é‡ï¼š\n\n```css\n// theme.css\n\n// å¤œé—´æ¨¡å¼\nhtml[data-theme='dark'] {\n  --text-color: #fff;\n  --brand-primary: #1668dc;\n}\n\n// æ™®é€šæ¨¡å¼\n:root {\n  --text-color: #333;\n  --brand-primary: #1677ff;\n}\n```\n\nç„¶ååœ¨ä½¿ç”¨æ—¶ï¼š\n\n```js\n// å…¥å£æ–‡ä»¶\nimport './theme.css';\n\n// ç»„ä»¶æ ·å¼\na {\n  color: var(--brand-primary);\n}\n```\n\nåœ¨åˆ‡æ¢ä¸»é¢˜æ—¶ï¼š\n\n```js\ndocument.documentElement.dataset.theme = è¦è®¾ç½®çš„theme\n```\n\nä½ å¯ä»¥ç»´æŠ¤ä¸€ä¸ª `useTheme` æ¥åŠ¨æ€è·å–å½“å‰çš„ä¸»é¢˜ã€‚\n\nè¿™é‡Œæœ‰ä¸€ä¸ªæˆç†Ÿçš„æ¡ˆä¾‹ï¼š[daisyUI](https://daisyui.com/)\n\nä¼˜ç‚¹ï¼š\n\n- åŸç”Ÿæ”¯æŒï¼Œæ˜¯ç°åœ¨ä¸»æµæ–¹æ¡ˆ\n- è½»é‡çº§ï¼Œéƒ¨ç½²æ–¹ä¾¿ï¼Œå¯å®šåˆ¶åŒ–ç¨‹åº¦é«˜\n- ä¸å­˜åœ¨ä¼˜å…ˆçº§å†²çªé—®é¢˜\n- å¯å®ç°çƒ­æ›¿æ¢å’Œæ›´æ”¹\n\nç¼ºç‚¹ï¼š\n\n- è€çš„æµè§ˆå™¨å­˜åœ¨å…¼å®¹æ€§é—®é¢˜","slug":"theme-css-variable"},{"title":"å‰ç«¯ä¸»é¢˜åˆ‡æ¢æµ…æï¼šä½¿ç”¨LinkåŠ¨æ€å¼•å…¥","date":"2024-01-25","readTime":"2 min","excerpt":"ä½¿ç”¨LinkåŠ¨æ€å¼•å…¥å®ç°ä¸»é¢˜åˆ‡æ¢ ...","tags":["CSS","ä¸»é¢˜åˆ‡æ¢"],"content":"## Link åŠ¨æ€å¼•å…¥\n\næå‰å‡†å¤‡å¥½å„ä¸ªä¸»é¢˜çš„ CSS æ–‡ä»¶ï¼Œåœ¨åˆ‡æ¢çš„æ—¶å€™åŠ è½½ï¼Œæ¯”å¦‚ï¼š\n\n```js\n// js\n const autoThemeChange = (e) => {\n    const isDark = e.matches;\n    document.getElementById('theme').href = `${isDark ? 'dark' : 'light'}.css`; // è¿™é‡Œçš„æ–‡ä»¶ï¼Œå¯ä»¥æ˜¯è¿œç¨‹çš„ï¼Œä¹Ÿå¯ä»¥æ˜¯é¡¹ç›®ä¸­çš„é™æ€æ–‡ä»¶\n}\n\n mediaQueryListDark = window.matchMedia('(prefers-color-scheme: dark)');\n mediaQueryListDark.addListener(autoThemeChange); \n```\n\n```html\n<!-- html -->\n<head>\n  <link rel=\"stylesheet\" src=\"https://cdn.xxx.com/dark.css\">\n<head>\n```\n\nä¼˜ç‚¹ï¼š\n\n- å®ç°ç®€å•ï¼Œåªéœ€è¦å…³æ³¨ç»´æŠ¤ css å³å¯\n- å¯ä»¥å®ç°ä¸»é¢˜æ ·å¼æŒ‰éœ€åŠ è½½\n\nç¼ºç‚¹ï¼š\n\n- å¦‚æœ css æ–‡ä»¶è¿‡å¤§, å¯èƒ½ä¼šå¯¼è‡´é¡µé¢æ ·å¼é—ªçƒ\n- å„ä¸ªä¸»é¢˜æ–‡ä»¶ç›¸äº’ç‹¬ç«‹ï¼Œä¿®æ”¹æ ·å¼æ¯”è¾ƒéº»çƒ¦\n- åœ¨æœåŠ¡ç«¯æ¸²æŸ“æ—¶ï¼Œæ²¡åŠæ³•ç›´æ¥æ“ä½œå®¢æˆ·ç«¯ DOM å…ƒç´ ï¼Œä¼šå½±å“åŠ è½½æ€§èƒ½\n- ä¸å¤Ÿçµæ´»ï¼Œä¸èƒ½æ»¡è¶³ç°ä»£å‰ç«¯å¼€å‘çš„éœ€æ±‚","slug":"theme-link"},{"title":"å‰ç«¯ä¸»é¢˜åˆ‡æ¢æµ…æï¼šæå‰åŠ è½½æ ·å¼ï¼Œç±»ååˆ‡æ¢æ–¹æ¡ˆ","date":"2024-01-25","readTime":"2 min","excerpt":"æå‰åŠ è½½æ ·å¼ï¼Œç±»ååˆ‡æ¢æ–¹æ¡ˆå®ç°ä¸»é¢˜åˆ‡æ¢ ...","tags":["CSS","ä¸»é¢˜åˆ‡æ¢"],"content":"## æå‰åŠ è½½æ ·å¼ï¼Œç±»ååˆ‡æ¢æ–¹æ¡ˆ\n\nå…ˆå¼•å…¥å„ä¸ªä¸»é¢˜çš„ cssï¼Œé€šè¿‡åˆ‡æ¢ç±»åå®ç°ä¸»é¢˜åˆ‡æ¢ã€‚\n\næˆ‘ä»¬æ¥çœ‹ä¸€ä¸ª antd çš„å®ç°æ¡ˆä¾‹ï¼š[antd-theme-change-demo](https://heiheihoho1213.github.io/antd-theme/)\n\nä»–çš„åŸç†æ˜¯åˆ‡æ¢ä¸»é¢˜æ—¶ï¼Œå¼•å…¥ä¸åŒçš„ä¸»é¢˜ç®—æ³•ï¼ˆcss æ–‡ä»¶ï¼‰ï¼š\n\nç„¶åé…ç½® `ThemeProvider`:\n\n```js\nreturn (\n   <ConfigProvider\n     theme={{\n       algorithm: themeLight ? theme.defaultAlgorithm : theme.darkAlgorithm,\n     }}\n   >\n     {children}\n   </ConfigProvider>\n );\n```\nåœ¨ä¸¤ç§æ¨¡å¼ä¸‹ï¼Œç›¸åŒçš„å…ƒç´ ï¼Œä½†æ˜¯ç±»åä¸åŒäº†ï¼Œåˆ™ä½¿ç”¨ä¸åŒçš„ css ä¸»é¢˜æ–‡ä»¶ï¼š\n\näº®ï¼š\n![image.png](/img/posts/2024-1-25/2024-1-25-1.png)\n\næš—ï¼š\n![image.png](/img/posts/2024-1-25/2024-1-25-2.png)\n\næ­¤å¤–ï¼Œè¿˜å¯ä»¥é…ç½®å‰ç¼€æ¥è‡ªå®šä¹‰ç»„ä»¶æ ·å¼ï¼š\n\n```js\nexport const PREFIX = 'tech-theme';\n...\n\n<ConfigProvider\n  prefixCls={prefixCls}\n>\n  {children}\n</ConfigProvider>\n```\né»˜è®¤ï¼š\n![image.png](/img/posts/2024-1-25/2024-1-25-3.png)\n\nè‡ªå®šä¹‰å‰ç¼€ï¼š\n\n![image.png](/img/posts/2024-1-25/2024-1-25-4.png)\n\n> æ­¤æ–¹æ¡ˆçš„æ ·å¼è¿˜å¯ä»¥é€šè¿‡ hook åŠ¨æ€è·å–ä¸º token ä½¿ç”¨ã€‚\n\nä¼˜ç‚¹ï¼š\n\n- æ ·å¼åˆ‡æ¢ä¼šæ›´åŠ é¡ºç•…\n- ä¾¿äºç»„ä»¶å°è£…ä¸çŠ¶æ€ç®¡ç†\n- å¯é…ç½®æ€§æ¯”è¾ƒå¼ºï¼Œæ”¯æŒåŠ¨æ€è‡ªå®šä¹‰æ ·å¼\n\nç¼ºç‚¹ï¼š\n\n- é¦–å±åŠ è½½ä¼šæ…¢ä¸€äº›\n- é™¤äº†æ ·å¼åˆ‡æ¢ä¸ä¼šé—ªçƒï¼Œå…¶ä½™ç¼ºç‚¹ä¸åŠ¨æ€ link æ–¹æ¡ˆç¼ºç‚¹ä¸€æ ·","slug":"theme-preload"},{"title":"Nextjs: App Router çš„å®˜ç½‘è§£è¯»","date":"2024-01-19","readTime":"10 min","excerpt":"ä»‹ç» Nextjs App Router çš„å®ç°æ–¹æ³• ...","tags":["Nextjs","SSR"],"content":"$8","slug":"nextjs-app-router"},{"title":"æ­å»ºå¾®å‰ç«¯ MontoAppï¼ˆå…­ï¼‰ - js æ²™ç®±ï¼šè‡ªæ‰§è¡Œ Script ä¸ å¿«ç…§éš”ç¦»","date":"2024-01-11","readTime":"10 min","excerpt":"ä»‹ç»è‡ªæ‰§è¡Œ Script ä¸ å¿«ç…§éš”ç¦»çš„å®ç°æ–¹æ³• ...","tags":["å¾®å‰ç«¯"],"content":"$9","slug":"monto-app-sandbox-snapshot-script"},{"title":"æ­å»ºå¾®å‰ç«¯ MontoAppï¼ˆäº”ï¼‰ - js æ²™ç®±ï¼šWeb Components ä¸ iframeéš”ç¦»","date":"2024-01-10","readTime":"10 min","excerpt":"ä»‹ç» Web Components ä¸ iframeéš”ç¦»çš„å®ç°æ–¹æ³• ...","tags":["å¾®å‰ç«¯"],"content":"$a","slug":"monto-app-sandbox-webcomponents-iframe"},{"title":"æ­å»ºå¾®å‰ç«¯ MontoAppï¼ˆä¸‰ï¼‰ - åŠ¨æ€ script æ–¹æ¡ˆ","date":"2024-01-09","readTime":"10 min","excerpt":"ä»‹ç»åŠ¨æ€ script æ–¹æ¡ˆçš„å®ç°æ–¹æ³• ...","tags":["å¾®å‰ç«¯"],"content":"$b","slug":"monto-app-dym-script-1"},{"title":"æ­å»ºå¾®å‰ç«¯ MontoAppï¼ˆå››ï¼‰ - Web Components æ–¹æ¡ˆ","date":"2024-01-9","readTime":"10 min","excerpt":"ä»‹ç» Web Components æ–¹æ¡ˆçš„å®ç°æ–¹æ³• ...","tags":["å¾®å‰ç«¯"],"content":"$c","slug":"monto-app-web-component"},{"title":"æ­å»ºå¾®å‰ç«¯ MontoAppï¼ˆäºŒï¼‰ - NPM æ–¹æ¡ˆ","date":"2024-01-08","readTime":"10 min","excerpt":"ä»‹ç» NPM æ–¹æ¡ˆçš„å®ç°æ–¹æ³• ...","tags":["å¾®å‰ç«¯"],"content":"$d","slug":"monto-app-npm-1"},{"title":"æ­å»ºå¾®å‰ç«¯ MontoAppï¼ˆä¸€ï¼‰ - iframe æ–¹æ¡ˆ","date":"2024-01-03","readTime":"10 min","excerpt":"ä»‹ç» iframe æ–¹æ¡ˆçš„å®ç°æ–¹æ³• ...","tags":["å¾®å‰ç«¯"],"content":"$e","slug":"monto-app-iframe-1"},{"title":"æµ…è°ˆä½œä¸ºå‰ç«¯å¼€å‘å¯¹äºŒå‰æ ‘éå†çš„ç†è§£","date":"2023-12-06","readTime":"10 min","excerpt":"ä»‹ç»äºŒå‰æ ‘éå†çš„å®ç°æ–¹æ³• ...","tags":["ç®—æ³•"],"content":"$f","slug":"btree-1"},{"title":"å¹´ç»ˆç›˜ç‚¹ï¼š2023å¹´ CSS é¢†åŸŸæ–°çš„ä¸€äº›å˜åŒ–","date":"2023-12-01","readTime":"10 min","excerpt":"ä»‹ç»2023å¹´ CSS é¢†åŸŸæ–°çš„ä¸€äº›å˜åŒ– ...","tags":["CSS"],"content":"$10","slug":"new-2023"},{"title":"å°è‚šå¸¦æ‚¨ Tailwind CSS å¿«é€Ÿå…¥é—¨","date":"2023-11-11","readTime":"10 min","excerpt":"ä»‹ç» Tailwind CSS çš„å¿«é€Ÿå…¥é—¨ ...","tags":["CSS","Tailwind CSS"],"content":"$11","slug":"fe-tailwindcss-guide"},{"title":"æ–°ç‰ˆReactå®˜æ–¹æ–‡æ¡£è§£è¯»ï¼ˆå°¾ç« ï¼‰- å®éªŒæ€§åŠŸèƒ½","date":"2023-11-09","readTime":"10 min","excerpt":"ä»‹ç» React 18 çš„ useã€useOptimisticã€useFormStateã€useFormStatusã€cacheã€experimental_taintObjectReferenceã€experimental_taintUniqueValue ...","tags":["React","React 18","å®˜æ–¹æ–‡æ¡£ç¿»è¯‘"],"content":"$12","slug":"react-18-use-12"},{"title":"è®²è®² React æœåŠ¡ç«¯æ¸²æŸ“æœ€ä½³å®è·µæ–¹æ¡ˆã€æ–°ç‰ˆReact + Nextjs å®˜æ–¹æ–‡æ¡£è§£è¯»ã€‘","date":"2023-11-03","readTime":"10 min","excerpt":"ä»‹ç» React æœåŠ¡ç«¯æ¸²æŸ“æœ€ä½³å®è·µæ–¹æ¡ˆçš„å®ç°æ–¹æ³• ...","tags":["Nextjs","React","SSR"],"content":"$13","slug":"react-ssr"},{"title":"å›¾è§£æµè§ˆå™¨æ¸²æŸ“åŸç†","date":"2023-10-26","readTime":"10 min","excerpt":"ä»‹ç»å›¾è§£æµè§ˆå™¨æ¸²æŸ“åŸç†çš„æ–¹æ¡ˆ ...","tags":["æµè§ˆå™¨"],"content":"$14","slug":"v8-render"},{"title":"å›¾è§£æµè§ˆå™¨äº‹ä»¶å¾ªç¯","date":"2023-10-12","readTime":"10 min","excerpt":"ä»‹ç»å›¾è§£æµè§ˆå™¨äº‹ä»¶å¾ªç¯çš„æ–¹æ¡ˆ ...","tags":["æµè§ˆå™¨"],"content":"$15","slug":"message-loop"},{"title":"æ–°ç‰ˆReactå®˜æ–¹æ–‡æ¡£è§£è¯»ï¼ˆåä¸€ï¼‰- Client API ä¹‹ createRootã€hydrateRoot","date":"2023-09-17","readTime":"5 min","excerpt":"ä»‹ç» React 18 çš„ createRoot å’Œ hydrateRoot ...","tags":["React","React 18","å®˜æ–¹æ–‡æ¡£ç¿»è¯‘"],"content":"$16","slug":"react-18-use-11"},{"title":"æ–°ç‰ˆReactå®˜æ–¹æ–‡æ¡£è§£è¯»ï¼ˆåï¼‰- react-dom API ä¹‹ createPortal å’Œ flushSync","date":"2023-09-15","readTime":"10 min","excerpt":"ä»‹ç» React 18 çš„ createPortal å’Œ flushSync ...","tags":["React","React 18","å®˜æ–¹æ–‡æ¡£ç¿»è¯‘"],"content":"$17","slug":"react-18-use-10"},{"title":"æ–°ç‰ˆReactå®˜æ–¹æ–‡æ¡£è§£è¯»ï¼ˆä¹ï¼‰- react API ä¹‹ memo ã€forwardRef","date":"2023-09-13","readTime":"10 min","excerpt":"ä»‹ç» React 18 çš„ memo å’Œ forwardRef ...","tags":["React","React 18","å®˜æ–¹æ–‡æ¡£ç¿»è¯‘"],"content":"$18","slug":"react-18-use-9"},{"title":"æ–°ç‰ˆReactå®˜æ–¹æ–‡æ¡£è§£è¯»ï¼ˆå…«ï¼‰- react API ä¹‹ startTransitionã€ createContext å’Œ lazy","date":"2023-09-06","readTime":"10 min","excerpt":"ä»‹ç» React 18 çš„ startTransitionã€ createContext å’Œ lazy ...","tags":["React","React 18","å®˜æ–¹æ–‡æ¡£ç¿»è¯‘"],"content":"$19","slug":"react-18-use-8"},{"title":"é’ˆå¯¹å‰ç«¯å‘å¸ƒæ–°ç‰ˆæœ¬åç”¨æˆ·é¡µé¢èµ„æºä¸¢å¤±é—®é¢˜çš„è§£å†³æ–¹æ¡ˆ","date":"2023-08-27","readTime":"10 min","excerpt":"ä»‹ç»é’ˆå¯¹å‰ç«¯å‘å¸ƒæ–°ç‰ˆæœ¬åç”¨æˆ·é¡µé¢èµ„æºä¸¢å¤±é—®é¢˜çš„è§£å†³æ–¹æ¡ˆçš„æ–¹æ¡ˆ ...","tags":["å‰ç«¯"],"content":"$1a","slug":"version-404"},{"title":"æ–°ç‰ˆReactå®˜æ–¹æ–‡æ¡£è§£è¯»ï¼ˆä¸ƒï¼‰- react ç»„ä»¶","date":"2023-08-24","readTime":"10 min","excerpt":"ä»‹ç» React 18 çš„ Profiler å’Œ Suspense ...","tags":["React","React 18","å®˜æ–¹æ–‡æ¡£ç¿»è¯‘"],"content":"$1b","slug":"react-18-use-7"},{"title":"æ–°ç‰ˆReactå®˜æ–¹æ–‡æ¡£è§£è¯»ï¼ˆå…­ï¼‰- Hooks ä¹‹ useTransitionã€useDeferredValue","date":"2023-08-18","readTime":"10 min","excerpt":"ä»‹ç» React 18 çš„ useTransition å’Œ useDeferredValue ...","tags":["React","React 18","å®˜æ–¹æ–‡æ¡£ç¿»è¯‘"],"content":"$1c","slug":"react-18-use-6"},{"title":"æ–°ç‰ˆReactå®˜æ–¹æ–‡æ¡£è§£è¯»ï¼ˆäº”ï¼‰- Hooks ä¹‹ useId å’Œ useSyncExternalStore","date":"2023-07-05","readTime":"10 min","excerpt":"ä»‹ç» React 18 çš„ useId å’Œ useSyncExternalStore ...","tags":["React","React 18","å®˜æ–¹æ–‡æ¡£ç¿»è¯‘"],"content":"$1d","slug":"react-18-use-5"},{"title":"æ–°ç‰ˆReactå®˜æ–¹æ–‡æ¡£è§£è¯»ï¼ˆå››ï¼‰- Hooks ä¹‹ useContextã€useRef å’Œ useImperativeHandle","date":"2023-07-04","readTime":"10 min","excerpt":"ä»‹ç» React 18 çš„ useContextã€useRef å’Œ useImperativeHandle ...","tags":["React","React 18","å®˜æ–¹æ–‡æ¡£ç¿»è¯‘"],"content":"$1e","slug":"react-18-use-4"},{"title":"æ–°ç‰ˆReactå®˜æ–¹æ–‡æ¡£è§£è¯»ï¼ˆä¸‰ï¼‰- Hooks ä¹‹ useEffectã€useLayoutEffect å’Œ useInsertionEffect","date":"2023-07-03","readTime":"10 min","excerpt":"ä»‹ç» React 18 çš„ useEffectã€useLayoutEffect å’Œ useInsertionEffect ...","tags":["React","React 18","å®˜æ–¹æ–‡æ¡£ç¿»è¯‘"],"content":"$1f","slug":"react-18-use-3"},{"title":"æ–°ç‰ˆReactå®˜æ–¹æ–‡æ¡£è§£è¯»ï¼ˆäºŒï¼‰- Hooks ä¹‹ useState å’Œ useReducer","date":"2023-07-02","readTime":"10 min","excerpt":"ä»‹ç» React 18 çš„ useState å’Œ useReducer ...","tags":["React","React 18","å®˜æ–¹æ–‡æ¡£ç¿»è¯‘"],"content":"$20","slug":"react-18-use-2"},{"title":"æ–°ç‰ˆReactå®˜æ–¹æ–‡æ¡£è§£è¯»ï¼ˆä¸€ï¼‰- Hooks ä¹‹ useCallback å’Œ useMemo","date":"2023-07-01","readTime":"10 min","excerpt":"ä»‹ç» React 18 çš„ useCallback å’Œ useMemo ...","tags":["React","React 18","å®˜æ–¹æ–‡æ¡£ç¿»è¯‘"],"content":"$21","slug":"react-18-use-1"},{"title":"å‰ç«¯æ—¶é—´å›½é™…åŒ–çš„ä¸€ç§è§£å†³æ–¹æ¡ˆ","date":"2023-06-26","readTime":"10 min","excerpt":"ä»‹ç»å‰ç«¯æ—¶é—´å›½é™…åŒ–çš„ä¸€ç§è§£å†³æ–¹æ¡ˆçš„æ–¹æ¡ˆ ...","tags":["å·¥ç¨‹åŒ–"],"content":"$22","slug":"timezone-format"},{"title":"ESLinté…ç½®é¡¹è¯¦è§£ï¼Œå¹¶å°†é…ç½®æ‰“åŒ…npm","date":"2023-04-21","readTime":"10 min","excerpt":"ä»‹ç»ESLinté…ç½®é¡¹è¯¦è§£ï¼Œå¹¶å°†é…ç½®æ‰“åŒ…npmçš„æ–¹æ¡ˆ ...","tags":["ESLint"],"content":"$23","slug":"eslint-start"},{"title":"å†™ä¸€ä¸ªç®€æ˜“çš„å‰ç«¯ç°åº¦ç³»ç»Ÿ","date":"2023-03-19","readTime":"10 min","excerpt":"ä»‹ç»å†™ä¸€ä¸ªç®€æ˜“çš„å‰ç«¯ç°åº¦ç³»ç»Ÿçš„æ–¹æ¡ˆ ...","tags":["å·¥ç¨‹åŒ–"],"content":"$24","slug":"stark-start"},{"title":"å‰ç«¯Nginxé…ç½®æŒ‡åŒ— + HTTPSå®‰å…¨åŸç†","date":"2023-03-18","readTime":"10 min","excerpt":"ä»‹ç»å‰ç«¯Nginxé…ç½®æŒ‡åŒ— + HTTPSå®‰å…¨åŸç†çš„æ–¹æ¡ˆ ...","tags":["Nginx"],"content":"$25","slug":"nginx-start"},{"title":"Gitlab CI/CD + Nginx å®ç°è‡ªåŠ¨åŒ–é›†æˆæ„å»ºä¸éƒ¨ç½²","date":"2023-01-01","readTime":"10 min","excerpt":"ä»‹ç»Gitlab CI/CD + Nginx å®ç°è‡ªåŠ¨åŒ–é›†æˆæ„å»ºä¸éƒ¨ç½²çš„æ–¹æ¡ˆ ...","tags":["å·¥ç¨‹åŒ–"],"content":"$26","slug":"gitlab-cicd"},{"title":"å¼€å§‹ä½¿ç”¨ Mobx å§ï¼","date":"2022-12-26","readTime":"10 min","excerpt":"ä»‹ç»å¼€å§‹ä½¿ç”¨ Mobx å§ï¼çš„æ–¹æ¡ˆ ...","tags":["å·¥ç¨‹åŒ–"],"content":"$27","slug":"start-mobx"},{"title":"å‰ç«¯é¡¹ç›®éƒ¨ç½²ä¸åŒåŸŸåé—´å…±äº«cookieçš„æ–¹æ¡ˆ","date":"2022-12-25","readTime":"10 min","excerpt":"ä»‹ç»å‰ç«¯é¡¹ç›®éƒ¨ç½²ä¸åŒåŸŸåé—´å…±äº«cookieçš„æ–¹æ¡ˆ ...","tags":["å·¥ç¨‹åŒ–"],"content":"$28","slug":"cookie-share"},{"title":"Gitlabå®‰è£…ä¸ä»“åº“ç®¡ç†","date":"2022-12-24","readTime":"10 min","excerpt":"ä»‹ç»Gitlabå®‰è£…ä¸ä»“åº“ç®¡ç†çš„æ–¹æ¡ˆ ...","tags":["å·¥ç¨‹åŒ–"],"content":"$29","slug":"gitlab-install"},{"title":"ä½¿ç”¨ Docker + Nginx éƒ¨ç½²å‰ç«¯é¡¹ç›®","date":"2022-12-01","readTime":"10 min","excerpt":"ä»‹ç»ä½¿ç”¨ Docker + Nginx éƒ¨ç½²å‰ç«¯é¡¹ç›®çš„æ–¹æ¡ˆ ...","tags":["å·¥ç¨‹åŒ–"],"content":"$2a","slug":"docker-nginx"},{"title":"å¦‚ä½•ä½¿ç”¨npmå‘å¸ƒåŒ…çš„æµ‹è¯•ç‰ˆå’Œæ­£å¼ç‰ˆ","date":"2022-12-01","readTime":"10 min","excerpt":"ä»‹ç»å¦‚ä½•ä½¿ç”¨npmå‘å¸ƒåŒ…çš„æµ‹è¯•ç‰ˆå’Œæ­£å¼ç‰ˆçš„æ–¹æ¡ˆ ...","tags":["npm"],"content":"$2b","slug":"npm-version"},{"title":"React Router v6 å®˜æ–¹æ–‡æ¡£ç¿»è¯‘ ï¼ˆå…«ï¼‰ ---- æ–°ç‰ˆæ–°å¢åŠŸèƒ½æ±‡æ€»","date":"2022-09-30","readTime":"10 min","excerpt":"ä»‹ç» React Router v6 çš„æ–°ç‰ˆæ–°å¢åŠŸèƒ½æ±‡æ€» ...","tags":["React","React Router","å®˜æ–¹æ–‡æ¡£ç¿»è¯‘"],"content":"$2c","slug":"react-router-6-new-features-summary"},{"title":"React Router v6 å®˜æ–¹æ–‡æ¡£ç¿»è¯‘ ï¼ˆä¸ƒï¼‰ ---- å†…ç½®API","date":"2022-09-19","readTime":"10 min","excerpt":"ä»‹ç» React Router v6 çš„createRoutesFromChildrenã€createSearchParamsã€generatePathã€Locationã€matchPathã€matchRoutesã€renderMatchesã€resolvePathç­‰å†…ç½®API ...","tags":["React","React Router","å®˜æ–¹æ–‡æ¡£ç¿»è¯‘"],"content":"$2d","slug":"react-router-6-built-in-api"},{"title":"React Router v6 å®˜æ–¹æ–‡æ¡£ç¿»è¯‘ ï¼ˆå…­ï¼‰ ---- Hooks","date":"2022-08-26","readTime":"10 min","excerpt":"ä»‹ç» React Router v6 çš„useHrefã€useInRouterContextã€useLinkClickHandlerã€useLinkPressHandlerã€useLocationã€useMatchã€useNavigateã€useNavigationTypeã€useOutletã€useOutletContextã€useParamsã€useResolvedPathã€useRoutesã€useSearchParamsç­‰Hooks ...","tags":["React","React Router","å®˜æ–¹æ–‡æ¡£ç¿»è¯‘"],"content":"$2e","slug":"react-router-6-hooks"},{"title":"å‰ç«¯é•¿åˆ—è¡¨æ»šåŠ¨æ–¹æ¡ˆæ¢è®¨ï¼Œçœ‹å®Œä¸è¦å†è¯´ä¸çŸ¥é“æ€ä¹ˆå®ç°è™šæ‹Ÿåˆ—è¡¨äº†","date":"2022-08-23","readTime":"10 min","excerpt":"ä»‹ç»å‰ç«¯é•¿åˆ—è¡¨æ»šåŠ¨æ–¹æ¡ˆçš„å®ç°æ–¹æ³• ...","tags":["æ€§èƒ½ä¼˜åŒ–","è™šæ‹Ÿåˆ—è¡¨"],"content":"$2f","slug":"react-18-use-12"},{"title":"æ‰‹æŠŠæ‰‹æ­å»ºåŸºäºReactçš„å‰ç«¯UIåº“ ï¼ˆå…«ï¼‰-- æ¨¡æ€æ¡†ç»„ä»¶","date":"2022-6-28","readTime":"8 min","excerpt":"ä»é›¶å¼€å§‹æ­å»ºåŸºäºReact + dumiæ–‡æ¡£ç³»ç»Ÿçš„å‰ç«¯UIåº“ ...","tags":["REACT","GITHUB","UI/UX","ç»„ä»¶åº“æ­å»º"],"content":"$30","slug":"fe-UI-8"},{"title":"æ‰‹æŠŠæ‰‹æ­å»ºåŸºäºReactçš„å‰ç«¯UIåº“ ï¼ˆä¸ƒï¼‰-- å¼¹å‡ºå±‚ç»„ä»¶","date":"2022-6-22","readTime":"8 min","excerpt":"ä»é›¶å¼€å§‹æ­å»ºåŸºäºReact + dumiæ–‡æ¡£ç³»ç»Ÿçš„å‰ç«¯UIåº“ ...","tags":["REACT","GITHUB","UI/UX","ç»„ä»¶åº“æ­å»º"],"content":"$31","slug":"fe-UI-7"},{"title":"Rxjs ä½¿ç”¨æŒ‡åŒ—","date":"2022-06-19","readTime":"10 min","excerpt":"ä»‹ç»Rxjs ä½¿ç”¨æŒ‡åŒ—çš„æ–¹æ¡ˆ ...","tags":["Rxjs"],"content":"$32","slug":"rxjs"},{"title":"ä¼ªå…ƒç´ æ¨¡æ‹Ÿå®ç°å¾®è½¯logoé˜´å½±","date":"2022-06-15","readTime":"10 min","excerpt":"ä»‹ç»ä¼ªå…ƒç´ æ¨¡æ‹Ÿå®ç°å¾®è½¯logoé˜´å½±çš„å®ç°æ–¹æ³• ...","tags":["CSS"],"content":"$33","slug":"microsoft-logo"},{"title":"shadow æ¢ç©¶(äºŒ) - ç¯çŠ¶åŠ¨ç”»","date":"2022-06-15","readTime":"10 min","excerpt":"ä»‹ç»ç¯çŠ¶åŠ¨ç”»çš„å®ç°æ–¹æ³• ...","tags":["CSS"],"content":"$34","slug":"ring-animation"},{"title":"shadow æ¢ç©¶(ä¸€) - ç«‹ä½“å¡ç‰‡","date":"2022-06-15","readTime":"10 min","excerpt":"ä»‹ç»ç«‹ä½“å¡ç‰‡çš„å®ç°æ–¹æ³• ...","tags":["CSS"],"content":"$35","slug":"shadow-card"},{"title":"JavaScript å†å²ç‰ˆæœ¬ä¸€è§ˆ","date":"2022-06-15","readTime":"10 min","excerpt":"ä» ECMA-262 æ ‡å‡†åˆ° JavaScript çš„å†å²ç‰ˆæœ¬ä¸€è§ˆ ...","tags":["JavaScript"],"content":"$36","slug":"js-history"},{"title":"React Router v6 å®˜æ–¹æ–‡æ¡£ç¿»è¯‘ ï¼ˆäº”ï¼‰ ---- è·¯ç”±ç»„ä»¶","date":"2022-06-09","readTime":"10 min","excerpt":"ä»‹ç» React Router v6 çš„Linkã€NavLinkã€Navigateã€Outletã€Routesã€Routeç­‰è·¯ç”±ç»„ä»¶ ...","tags":["React","React Router","å®˜æ–¹æ–‡æ¡£ç¿»è¯‘"],"content":"$37","slug":"react-router-6-routing-components"},{"title":"React Router v6 å®˜æ–¹æ–‡æ¡£ç¿»è¯‘ ï¼ˆå››ï¼‰ ---- å„ç§ç±»å‹çš„Router","date":"2022-06-08","readTime":"10 min","excerpt":"ä»‹ç» React Router v6 çš„æµè§ˆå™¨Routerã€HashRouterã€HistoryRouterã€MemoryRouterã€NativeRouterã€StaticRouterç­‰ ...","tags":["React","React Router","å®˜æ–¹æ–‡æ¡£ç¿»è¯‘"],"content":"$38","slug":"react-router-6-various-types-of-routers"},{"title":"React Router v6 å®˜æ–¹æ–‡æ¡£ç¿»è¯‘ ï¼ˆä¸‰ï¼‰ ---- ä¸»è¦æ¦‚å¿µ","date":"2022-06-07","readTime":"10 min","excerpt":"ä»‹ç» React Router v6 çš„ä¸»è¦æ¦‚å¿µ ...","tags":["React","React Router","å®˜æ–¹æ–‡æ¡£ç¿»è¯‘"],"content":"$39","slug":"react-router-6-concepts"},{"title":"æ‰‹æŠŠæ‰‹æ­å»ºåŸºäºReactçš„å‰ç«¯UIåº“ ï¼ˆå…­ï¼‰-- æ‰“åŒ…ä¸å‘å¸ƒ","date":"2022-5-23","readTime":"4 min","excerpt":"ä»é›¶å¼€å§‹æ­å»ºåŸºäºReact + dumiæ–‡æ¡£ç³»ç»Ÿçš„å‰ç«¯UIåº“ ...","tags":["REACT","GITHUB","UI/UX","ç»„ä»¶åº“æ­å»º"],"content":"$3a","slug":"fe-UI-6"},{"title":"æ‰‹æŠŠæ‰‹æ­å»ºåŸºäºReactçš„å‰ç«¯UIåº“ ï¼ˆäº”ï¼‰-- è¡¨å•ç»„ä»¶","date":"2022-5-22","readTime":"4 min","excerpt":"ä»é›¶å¼€å§‹æ­å»ºåŸºäºReact + dumiæ–‡æ¡£ç³»ç»Ÿçš„å‰ç«¯UIåº“ ...","tags":["REACT","GITHUB","UI/UX","ç»„ä»¶åº“æ­å»º"],"content":"$3b","slug":"fe-UI-5"},{"title":"ğŸ”¥ å‰ç«¯å·¥ç¨‹åŒ–å¿…ç»çš„ä¸€ç¯ -- å‰åç«¯æ¥å£è§„èŒƒ","date":"2022-05-01","readTime":"10 min","excerpt":"ä»‹ç»å‰åç«¯æ¥å£è§„èŒƒçš„æ–¹æ¡ˆ ...","tags":["å·¥ç¨‹åŒ–"],"content":"$3c","slug":"fe-vs-be"},{"title":"React Router v6 å®˜æ–¹æ–‡æ¡£ç¿»è¯‘ ï¼ˆäºŒï¼‰ ---- FAQs","date":"2022-04-25","readTime":"10 min","excerpt":"ä»‹ç» React Router v6 çš„å¸¸è§é—®é¢˜å’Œè§£ç­” ...","tags":["React","React Router","å®˜æ–¹æ–‡æ¡£ç¿»è¯‘"],"content":"$3d","slug":"react-router-6-faqs"},{"title":"React Router v6 å®˜æ–¹æ–‡æ¡£ç¿»è¯‘ ï¼ˆä¸€ï¼‰ ---- Installation && Quick Start","date":"2022-04-12","readTime":"10 min","excerpt":"ä»‹ç» React Router v6 çš„å®‰è£…å’Œå¿«é€Ÿå¼€å§‹ ...","tags":["React","React Router","å®˜æ–¹æ–‡æ¡£ç¿»è¯‘"],"content":"$3e","slug":"react-router-6-installation-quick-start"},{"title":"æ‰‹æŠŠæ‰‹æ­å»ºåŸºäºReactçš„å‰ç«¯UIåº“ ï¼ˆå››ï¼‰-- å¸ƒå±€ç»„ä»¶","date":"2022-3-21","readTime":"4 min","excerpt":"ä»é›¶å¼€å§‹æ­å»ºåŸºäºReact + dumiæ–‡æ¡£ç³»ç»Ÿçš„å‰ç«¯UIåº“ ...","tags":["REACT","GITHUB","UI/UX","ç»„ä»¶åº“æ­å»º"],"content":"$3f","slug":"fe-UI-4"},{"title":"æ‰‹æŠŠæ‰‹æ­å»ºåŸºäºReactçš„å‰ç«¯UIåº“ ï¼ˆä¸‰ï¼‰-- åŸºç¡€ç»„ä»¶Iconå’ŒButton","date":"2022-3-20","readTime":"6 min","excerpt":"ä»é›¶å¼€å§‹æ­å»ºåŸºäºReact + dumiæ–‡æ¡£ç³»ç»Ÿçš„å‰ç«¯UIåº“ ...","tags":["REACT","GITHUB","UI/UX","ç»„ä»¶åº“æ­å»º"],"content":"$40","slug":"fe-UI-3"},{"id":"3","title":"æ‰‹æŠŠæ‰‹æ­å»ºåŸºäºReactçš„å‰ç«¯UIåº“ ï¼ˆäºŒï¼‰-- ä¸»é¢˜é…ç½®","date":"2022-3-19","readTime":"6 min","excerpt":"ä»é›¶å¼€å§‹æ­å»ºåŸºäºReact + dumiæ–‡æ¡£ç³»ç»Ÿçš„å‰ç«¯UIåº“ ...","tags":["REACT","GITHUB","UI/UX","ç»„ä»¶åº“æ­å»º"],"content":"$41","slug":"fe-UI-2"},{"id":"2","title":"æ‰‹æŠŠæ‰‹æ­å»ºåŸºäºReactçš„å‰ç«¯UIåº“ ï¼ˆä¸€ï¼‰-- é¡¹ç›®åˆå§‹åŒ–","date":"2022-3-14","readTime":"3 min","excerpt":"ä»é›¶å¼€å§‹æ­å»ºåŸºäºReact + dumiæ–‡æ¡£ç³»ç»Ÿçš„å‰ç«¯UIåº“ ...","tags":["REACT","GITHUB","UI/UX","ç»„ä»¶åº“æ­å»º"],"content":"$42","slug":"fe-UI-1"},{"title":"å‰ç«¯ç¯å¢ƒæ­å»º","date":"2022-03-01","readTime":"10 min","excerpt":"ä»‹ç»å‰ç«¯ç¯å¢ƒæ­å»ºçš„æ–¹æ¡ˆ ...","tags":["å·¥ç¨‹åŒ–"],"content":"$43","slug":"fe-prepare"},{"title":"å…³äºå‰ç«¯äº§å“æŠ€æœ¯é€‰å‹é—®é¢˜çš„è‹¥å¹²æ€è€ƒ","date":"2022-02-01","readTime":"10 min","excerpt":"ä»‹ç»å…³äºå‰ç«¯äº§å“æŠ€æœ¯é€‰å‹é—®é¢˜çš„è‹¥å¹²æ€è€ƒçš„æ–¹æ¡ˆ ...","tags":["æŠ€æœ¯é€‰å‹"],"content":"$44","slug":"select-frame"}],"gallery":[{"id":"img-0","src":"https://picsum.photos/1200/1200?random=10","alt":"Abstract composition 1","category":"3D RENDER","title":"Render Experiment #1","description":"An exploration of procedural generation using Blender geometry nodes. The texture work focuses on imperfection and realism within a digital construct."},{"id":"img-1","src":"https://picsum.photos/1200/1200?random=11","alt":"Abstract composition 2","category":"PHOTOGRAPHY","title":"Urban Study #2","description":"Captured on 35mm film in Tokyo. This shot emphasizes the interplay between brutalist architecture and organic city life."},{"id":"img-2","src":"https://picsum.photos/1200/1200?random=12","alt":"Abstract composition 3","category":"3D RENDER","title":"Render Experiment #3","description":"An exploration of procedural generation using Blender geometry nodes. The texture work focuses on imperfection and realism within a digital construct."},{"id":"img-3","src":"https://picsum.photos/1200/1200?random=13","alt":"Abstract composition 4","category":"PHOTOGRAPHY","title":"Urban Study #4","description":"Captured on 35mm film in Tokyo. This shot emphasizes the interplay between brutalist architecture and organic city life."},{"id":"img-4","src":"https://picsum.photos/1200/1200?random=14","alt":"Abstract composition 5","category":"3D RENDER","title":"Render Experiment #5","description":"An exploration of procedural generation using Blender geometry nodes. The texture work focuses on imperfection and realism within a digital construct."},{"id":"img-5","src":"https://picsum.photos/1200/1200?random=15","alt":"Abstract composition 6","category":"PHOTOGRAPHY","title":"Urban Study #6","description":"Captured on 35mm film in Tokyo. This shot emphasizes the interplay between brutalist architecture and organic city life."},{"id":"img-6","src":"https://picsum.photos/1200/1200?random=16","alt":"Abstract composition 7","category":"3D RENDER","title":"Render Experiment #7","description":"An exploration of procedural generation using Blender geometry nodes. The texture work focuses on imperfection and realism within a digital construct."},{"id":"img-7","src":"https://picsum.photos/1200/1200?random=17","alt":"Abstract composition 8","category":"PHOTOGRAPHY","title":"Urban Study #8","description":"Captured on 35mm film in Tokyo. This shot emphasizes the interplay between brutalist architecture and organic city life."},{"id":"img-8","src":"https://picsum.photos/1200/1200?random=18","alt":"Abstract composition 9","category":"3D RENDER","title":"Render Experiment #9","description":"An exploration of procedural generation using Blender geometry nodes. The texture work focuses on imperfection and realism within a digital construct."}]},"zh":{"projects":[{"id":"1","title":"Pixel-UI","description":"ä¸€ä¸ªå¼€æºçš„ Vue ç»„ä»¶åº“ï¼Œä¸“æ³¨äºåƒç´ é£æ ¼è®¾è®¡ã€‚","link":"https://maomentai817.github.io/pixel-ui/","image":"/img/projects/pixel-ui.webp","tags":["Vue","Pixel Style","Component Library"],"category":"UI"},{"id":"2","title":"Pixel-UI React","description":"ä¸€ä¸ªå¼€æºçš„ React ç»„ä»¶åº“ï¼Œä¸“æ³¨äºåƒç´ é£æ ¼è®¾è®¡ã€‚","link":"https://maomentai817.github.io/pixel-ui-react/","image":"/img/projects/pixel-ui-react.webp","tags":["Vue","Pixel Style","Component Library"],"category":"UI"},{"id":"3","title":"React ç»„ä»¶åº“å¼€å‘æ•™å­¦é¡¹ç›® Dux-UI","description":"ä¸€ä¸ª React ç»„ä»¶åº“å¼€å‘æ•™å­¦é¡¹ç›®ï¼Œä¸€ç«™å¼é¡¹ç›®æ­å»ºã€ç»„ä»¶å¼€å‘ã€ä½¿ç”¨ dumi éƒ¨ç½²æ–‡æ¡£ç³»ç»Ÿã€‚","link":"https://heiheihoho1213.github.io/dux-ui/","image":"/img/projects/dux-ui.webp","tags":["React","Component Library"],"category":"UI"},{"id":"2","title":"CodeReview AI","description":"åŸºäº AI çš„ä»£ç å®¡æŸ¥å·¥å…·ï¼Œæ”¯æŒå¤šç§è¯­è¨€ã€‚","link":"https://code-review-home.vercel.app/","image":"/img/projects/code-review.webp","tags":["AI","Code Review"],"category":"å·¥å…·"},{"id":"3","title":"ä¸­å¼è‰²å¡","description":"ä¸­å¼è‰²å½©é…è‰²æ–¹æ¡ˆ","link":"https://heiheihoho1213.github.io/monto-color/","image":"/img/projects/china-color.webp","tags":["Color Palette"],"category":"å·¥å…·"},{"id":"1","title":"å¤šå½©ä¹¦ç­¾ ï¼ˆéœ€æ¢¯å­è®¿é—®ï¼‰","description":"ä¸€ä¸ªåŸºäº tag åˆ†ç±»çš„Chrome æµè§ˆå™¨ä¹¦ç­¾æ‰©å±•æ’ä»¶ã€‚","link":"https://chromewebstore.google.com/detail/colorful-bookmark/ilcmekmgeldhckdembghkiohkdffihpe?hl=zh-CN&utm_source=ext_sidebar","image":"/img/projects/colorful-bookmark.webp","tags":["Chrome æ‰©å±•"],"category":"å·¥å…·"},{"id":"4","title":"æ—¶é—´æˆ³è½¬æ¢-æ—¶åŒºæ—¶é’Ÿï¼ˆéœ€æ¢¯å­è®¿é—®ï¼‰","description":"ä¸€ä¸ªæ—¶é—´æˆ³è½¬æ¢å’Œæ—¶åŒºæ—¶é’Ÿçš„Chrome æµè§ˆå™¨æ‰©å±•æ’ä»¶ã€‚","link":"https://chromewebstore.google.com/detail/%E6%97%B6%E9%97%B4%E6%88%B3%E8%BD%AC%E6%8D%A2-%E6%97%B6%E5%8C%BA%E6%97%B6%E9%92%9F/pjcapgdifnhgkkojoggfdlijpelpohcf?hl=zh-CN&gl=DE","image":"/img/projects/clock.webp","tags":["Chrome æ‰©å±•"],"category":"å·¥å…·"},{"id":"1","title":"css å˜é‡å®ç°ä¸»é¢˜åˆ‡æ¢","description":"ä½¿ç”¨ css å˜é‡å®ç°ä¸»é¢˜åˆ‡æ¢ï¼Œæ”¯æŒé»‘è‰²æ¨¡å¼ã€äº®è‰²æ¨¡å¼å’Œæš—è‰²æ¨¡å¼ã€‚","link":"https://code.juejin.cn/pen/7317573307016806435","image":"/img/projects/themes-switch.webp","tags":["CSS"],"category":"Web ä¸»é¢˜åˆ‡æ¢"},{"id":"2","title":"antd ä¸»é¢˜åˆ‡æ¢","description":"ä½¿ç”¨ antd çš„ theme å®ç°ä¸»é¢˜åˆ‡æ¢ï¼Œæ”¯æŒäº®è‰²æ¨¡å¼å’Œæš—è‰²æ¨¡å¼ã€‚","link":"https://heiheihoho1213.github.io/antd-theme/","image":"/img/projects/themes-switch-1.webp","tags":["CSS"],"category":"Web ä¸»é¢˜åˆ‡æ¢"},{"id":"3","title":"Sass é¢„å¤„ç†å™¨å®ç°ä¸»é¢˜åˆ‡æ¢","description":"ä½¿ç”¨ Sass é¢„å¤„ç†å™¨å®ç°ä¸»é¢˜åˆ‡æ¢ï¼Œæ”¯æŒäº®è‰²æ¨¡å¼ã€è“è‰²æ¨¡å¼å’Œæš—è‰²æ¨¡å¼ã€‚","link":"https://heiheihoho1213.github.io/sass-theme/","image":"/img/projects/themes-switch-2.webp","tags":["CSS"],"category":"Web ä¸»é¢˜åˆ‡æ¢"}],"blog":[{"id":"1","title":"ğŸ® ä» NES åˆ°ç°ä»£ Web â€”â€” åƒç´ é£ç»„ä»¶åº“ Pixel UI  React ç‰ˆæœ¬ï¼Œæ¬¢è¿å¤§å®¶ä¸€èµ·å‚ä¸è¿™ä¸ªé¡¹ç›®","date":"2025-11-19","readTime":"3 min","excerpt":"æ˜é‡‘ä½œè€… @çŒ«é—·å°817 çš„ Pixel U Vue3 ç‰ˆä¸Šçº¿äº†ï¼Œç°åœ¨æˆ‘ä¸ä»–åˆä½œçš„ React ç‰ˆä¹Ÿæ¥äº†...","tags":["REACT","GITHUB","UI/UX"],"content":"$45","slug":"Pixel-UI-React"},{"title":"React æºç è§£è¯»","date":"2024-04-25","readTime":"10 min","excerpt":"ä»‹ç» React çš„è™šæ‹Ÿ DOMã€Fiber ç»“æ„ã€è°ƒåº¦å™¨ç­‰æ ¸å¿ƒæ¦‚å¿µå’Œå®ç°åŸç† ...","tags":["React","æºç è§£è¯»"],"content":"$46","slug":"react-source"},{"title":"å›¾ç‰‡æ‡’åŠ è½½ï¼šä»ä½åƒç´ é¢„è§ˆåˆ°é«˜æ¸…åŠ è½½","date":"2024-02-07","readTime":"10 min","excerpt":"ä»‹ç»å›¾ç‰‡æ‡’åŠ è½½çš„å®ç°æ–¹æ³• ...","tags":["æ€§èƒ½ä¼˜åŒ–","å›¾ç‰‡æ‡’åŠ è½½"],"content":"$47","slug":"react-18-use-12"},{"title":"å‰ç«¯ä¸»é¢˜åˆ‡æ¢æµ…æï¼šä½¿ç”¨å‰ç«¯CSSæ¡†æ¶","date":"2024-01-25","readTime":"2 min","excerpt":"ä½¿ç”¨å‰ç«¯CSSæ¡†æ¶å®ç°ä¸»é¢˜åˆ‡æ¢ ...","tags":["CSS","ä¸»é¢˜åˆ‡æ¢"],"content":"$48","slug":"theme-css-frame"},{"title":"å‰ç«¯ä¸»é¢˜åˆ‡æ¢æµ…æï¼šCSS-IN-JS","date":"2024-01-25","readTime":"2 min","excerpt":"ä½¿ç”¨CSS-IN-JSå®ç°ä¸»é¢˜åˆ‡æ¢ ...","tags":["CSS","ä¸»é¢˜åˆ‡æ¢"],"content":"$49","slug":"theme-css-in-js"},{"title":"å‰ç«¯ä¸»é¢˜åˆ‡æ¢æµ…æï¼šä½¿ç”¨CSSé¢„å¤„ç†å™¨","date":"2024-01-25","readTime":"2 min","excerpt":"ä½¿ç”¨CSSé¢„å¤„ç†å™¨å®ç°ä¸»é¢˜åˆ‡æ¢ ...","tags":["CSS","ä¸»é¢˜åˆ‡æ¢"],"content":"## CSS é¢„å¤„ç†å™¨\n\næˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªä¾‹å­ï¼š[sass é¢„ç¼–è¯‘ theme](https://duheng1992.github.io/sass-theme/)\n\nå°†æ‰€æœ‰çš„æ ·å¼æ–‡ä»¶ä½¿ç”¨ Sass é¢„å…ˆå®šä¹‰å¥½ï¼š\n\n![image.png](/img/posts/2024-1-25/2024-1-25-5.png)\n\nç„¶åå†™ä¸€ä¸ª `buildThemes.js` è„šæœ¬åœ¨æ‰“åŒ…å‰ç¼–è¯‘ä¸º cssï¼Œç„¶åå°†è¿™ä¸ªæ–‡ä»¶åŠ¨æ€æ’å…¥åˆ° head é‡Œï¼š\n\n```js\nconst createLinkElementWithKey = (key) => {\n  const linkEl = document.createElement('link');\n  linkEl.setAttribute('rel', 'stylesheet');\n  linkEl.classList.add(getClassNameForKey(key));\n  document.head.appendChild(linkEl);\n  return linkEl;\n};\n\n...\n// åˆ‡æ¢æ—¶è°ƒç”¨\nconst setStyle = (key = 'theme', path = 'white') => {\n  getLinkElementForKey(key).setAttribute('href', `sass-theme/assets/themes/${path}.css`);\n}\n```\n\nç¤ºæ„å›¾ï¼š\n![image.png](/img/posts/2024-1-25/2024-1-25-6.png)\n\n> è„šæœ¬çš„å†™æ³•è§ [Demo](https://github.com/heiheihoho1213/sass-theme/tree/master)\n\næœ€ç»ˆæ•ˆæœï¼š\n\n![image.png](/img/posts/2024-1-25/2024-1-25-7.png)\n\n> åœ¨æˆ‘è¿™ä¸ª demo é‡Œï¼Œå…¶å®ä¹Ÿæ˜¯æŠŠä¸»é¢˜æ ·å¼æŒ‚è½½ä¸ºå…¨å±€çš„ css å˜é‡ï¼Œåªæ˜¯ä½¿ç”¨ css é¢„å¤„ç†å™¨è¿‡åº¦äº†ä¸€ä¸‹\n\n\nä¼˜ç‚¹ï¼š\n\n- æ ·å¼åˆ‡æ¢æµç•…ï¼Œä¸ä¼šå¡é¡¿\n- è¯­æ³•æ›´å¤šæ ·ï¼Œå¼€å‘æˆæœ¬ä½\n- ä¸ css å˜é‡ä¸€æ ·ï¼Œæ–°å¢æˆ–ä¿®æ”¹æ ·å¼ï¼Œåªéœ€è¦æ”¹åŠ¨ Scss/Less å˜é‡å³å¯\n\nç¼ºç‚¹ï¼š\n\n- éœ€è¦åœ¨ç¼–è¯‘æ—¶æ‰‹åŠ¨ç¼–è¯‘ï¼Œè¿è¡Œæ—¶æ²¡åŠæ³•çƒ­æ›¿æ¢\n- å­¦ä¹ æˆæœ¬é«˜ä¸€äº›","slug":"theme-css-preprocessor"},{"title":"å‰ç«¯ä¸»é¢˜åˆ‡æ¢æµ…æï¼šä½¿ç”¨CSSå˜é‡","date":"2024-01-25","readTime":"2 min","excerpt":"ä½¿ç”¨CSSå˜é‡å®ç°ä¸»é¢˜åˆ‡æ¢ ...","tags":["CSS","ä¸»é¢˜åˆ‡æ¢"],"content":"## CSS å˜é‡\n\nè¿™ä¸ªæ–¹æ¡ˆæ˜¯ç›®å‰ä¸»æµæ¨èçš„æ–¹æ¡ˆã€‚åœ¨ä»‹ç»ä¹‹å‰ï¼Œå…ˆè®²ä¸€ä¸‹æµè§ˆå™¨çš„å‡ ä¸ªæ–°ç‰¹æ€§ã€‚\n\n#### color-scheme æ–¹æ¡ˆ\n \n [color-scheme](https://developer.mozilla.org/zh-CN/docs/Web/CSS/color-scheme) æ˜¯æµè§ˆå™¨æ™®éæ”¯æŒçš„é…ç½®ä¸»é¢˜çš„å±æ€§ã€‚ä»–è¡¨ç¤ºè°ƒç”¨æ“ä½œç³»ç»Ÿé»˜è®¤çš„ä¸»é¢˜æ–¹æ¡ˆè¦†ç›–å½“å‰å…ƒç´ æ ·å¼ï¼š\n \n [color-schemeï¼šCSS å˜é‡ä¸»é¢˜åˆ‡æ¢æ¡ˆä¾‹](https://code.juejin.cn/pen/7317573307016806435)\n \n#### è‡ªå®šä¹‰æ–¹æ¡ˆ\n\nå¦‚æœè¦è‡ªå®šä¹‰å˜é‡ï¼Œå¯ä»¥è¿™æ ·å®šä¹‰è‡ªå·±çš„æ ·å¼å˜é‡ï¼š\n\n```css\n// theme.css\n\n// å¤œé—´æ¨¡å¼\nhtml[data-theme='dark'] {\n  --text-color: #fff;\n  --brand-primary: #1668dc;\n}\n\n// æ™®é€šæ¨¡å¼\n:root {\n  --text-color: #333;\n  --brand-primary: #1677ff;\n}\n```\n\nç„¶ååœ¨ä½¿ç”¨æ—¶ï¼š\n\n```js\n// å…¥å£æ–‡ä»¶\nimport './theme.css';\n\n// ç»„ä»¶æ ·å¼\na {\n  color: var(--brand-primary);\n}\n```\n\nåœ¨åˆ‡æ¢ä¸»é¢˜æ—¶ï¼š\n\n```js\ndocument.documentElement.dataset.theme = è¦è®¾ç½®çš„theme\n```\n\nä½ å¯ä»¥ç»´æŠ¤ä¸€ä¸ª `useTheme` æ¥åŠ¨æ€è·å–å½“å‰çš„ä¸»é¢˜ã€‚\n\nè¿™é‡Œæœ‰ä¸€ä¸ªæˆç†Ÿçš„æ¡ˆä¾‹ï¼š[daisyUI](https://daisyui.com/)\n\nä¼˜ç‚¹ï¼š\n\n- åŸç”Ÿæ”¯æŒï¼Œæ˜¯ç°åœ¨ä¸»æµæ–¹æ¡ˆ\n- è½»é‡çº§ï¼Œéƒ¨ç½²æ–¹ä¾¿ï¼Œå¯å®šåˆ¶åŒ–ç¨‹åº¦é«˜\n- ä¸å­˜åœ¨ä¼˜å…ˆçº§å†²çªé—®é¢˜\n- å¯å®ç°çƒ­æ›¿æ¢å’Œæ›´æ”¹\n\nç¼ºç‚¹ï¼š\n\n- è€çš„æµè§ˆå™¨å­˜åœ¨å…¼å®¹æ€§é—®é¢˜","slug":"theme-css-variable"},{"title":"å‰ç«¯ä¸»é¢˜åˆ‡æ¢æµ…æï¼šä½¿ç”¨LinkåŠ¨æ€å¼•å…¥","date":"2024-01-25","readTime":"2 min","excerpt":"ä½¿ç”¨LinkåŠ¨æ€å¼•å…¥å®ç°ä¸»é¢˜åˆ‡æ¢ ...","tags":["CSS","ä¸»é¢˜åˆ‡æ¢"],"content":"## Link åŠ¨æ€å¼•å…¥\n\næå‰å‡†å¤‡å¥½å„ä¸ªä¸»é¢˜çš„ CSS æ–‡ä»¶ï¼Œåœ¨åˆ‡æ¢çš„æ—¶å€™åŠ è½½ï¼Œæ¯”å¦‚ï¼š\n\n```js\n// js\n const autoThemeChange = (e) => {\n    const isDark = e.matches;\n    document.getElementById('theme').href = `${isDark ? 'dark' : 'light'}.css`; // è¿™é‡Œçš„æ–‡ä»¶ï¼Œå¯ä»¥æ˜¯è¿œç¨‹çš„ï¼Œä¹Ÿå¯ä»¥æ˜¯é¡¹ç›®ä¸­çš„é™æ€æ–‡ä»¶\n}\n\n mediaQueryListDark = window.matchMedia('(prefers-color-scheme: dark)');\n mediaQueryListDark.addListener(autoThemeChange); \n```\n\n```html\n<!-- html -->\n<head>\n  <link rel=\"stylesheet\" src=\"https://cdn.xxx.com/dark.css\">\n<head>\n```\n\nä¼˜ç‚¹ï¼š\n\n- å®ç°ç®€å•ï¼Œåªéœ€è¦å…³æ³¨ç»´æŠ¤ css å³å¯\n- å¯ä»¥å®ç°ä¸»é¢˜æ ·å¼æŒ‰éœ€åŠ è½½\n\nç¼ºç‚¹ï¼š\n\n- å¦‚æœ css æ–‡ä»¶è¿‡å¤§, å¯èƒ½ä¼šå¯¼è‡´é¡µé¢æ ·å¼é—ªçƒ\n- å„ä¸ªä¸»é¢˜æ–‡ä»¶ç›¸äº’ç‹¬ç«‹ï¼Œä¿®æ”¹æ ·å¼æ¯”è¾ƒéº»çƒ¦\n- åœ¨æœåŠ¡ç«¯æ¸²æŸ“æ—¶ï¼Œæ²¡åŠæ³•ç›´æ¥æ“ä½œå®¢æˆ·ç«¯ DOM å…ƒç´ ï¼Œä¼šå½±å“åŠ è½½æ€§èƒ½\n- ä¸å¤Ÿçµæ´»ï¼Œä¸èƒ½æ»¡è¶³ç°ä»£å‰ç«¯å¼€å‘çš„éœ€æ±‚","slug":"theme-link"},{"title":"å‰ç«¯ä¸»é¢˜åˆ‡æ¢æµ…æï¼šæå‰åŠ è½½æ ·å¼ï¼Œç±»ååˆ‡æ¢æ–¹æ¡ˆ","date":"2024-01-25","readTime":"2 min","excerpt":"æå‰åŠ è½½æ ·å¼ï¼Œç±»ååˆ‡æ¢æ–¹æ¡ˆå®ç°ä¸»é¢˜åˆ‡æ¢ ...","tags":["CSS","ä¸»é¢˜åˆ‡æ¢"],"content":"## æå‰åŠ è½½æ ·å¼ï¼Œç±»ååˆ‡æ¢æ–¹æ¡ˆ\n\nå…ˆå¼•å…¥å„ä¸ªä¸»é¢˜çš„ cssï¼Œé€šè¿‡åˆ‡æ¢ç±»åå®ç°ä¸»é¢˜åˆ‡æ¢ã€‚\n\næˆ‘ä»¬æ¥çœ‹ä¸€ä¸ª antd çš„å®ç°æ¡ˆä¾‹ï¼š[antd-theme-change-demo](https://heiheihoho1213.github.io/antd-theme/)\n\nä»–çš„åŸç†æ˜¯åˆ‡æ¢ä¸»é¢˜æ—¶ï¼Œå¼•å…¥ä¸åŒçš„ä¸»é¢˜ç®—æ³•ï¼ˆcss æ–‡ä»¶ï¼‰ï¼š\n\nç„¶åé…ç½® `ThemeProvider`:\n\n```js\nreturn (\n   <ConfigProvider\n     theme={{\n       algorithm: themeLight ? theme.defaultAlgorithm : theme.darkAlgorithm,\n     }}\n   >\n     {children}\n   </ConfigProvider>\n );\n```\nåœ¨ä¸¤ç§æ¨¡å¼ä¸‹ï¼Œç›¸åŒçš„å…ƒç´ ï¼Œä½†æ˜¯ç±»åä¸åŒäº†ï¼Œåˆ™ä½¿ç”¨ä¸åŒçš„ css ä¸»é¢˜æ–‡ä»¶ï¼š\n\näº®ï¼š\n![image.png](/img/posts/2024-1-25/2024-1-25-1.png)\n\næš—ï¼š\n![image.png](/img/posts/2024-1-25/2024-1-25-2.png)\n\næ­¤å¤–ï¼Œè¿˜å¯ä»¥é…ç½®å‰ç¼€æ¥è‡ªå®šä¹‰ç»„ä»¶æ ·å¼ï¼š\n\n```js\nexport const PREFIX = 'tech-theme';\n...\n\n<ConfigProvider\n  prefixCls={prefixCls}\n>\n  {children}\n</ConfigProvider>\n```\né»˜è®¤ï¼š\n![image.png](/img/posts/2024-1-25/2024-1-25-3.png)\n\nè‡ªå®šä¹‰å‰ç¼€ï¼š\n\n![image.png](/img/posts/2024-1-25/2024-1-25-4.png)\n\n> æ­¤æ–¹æ¡ˆçš„æ ·å¼è¿˜å¯ä»¥é€šè¿‡ hook åŠ¨æ€è·å–ä¸º token ä½¿ç”¨ã€‚\n\nä¼˜ç‚¹ï¼š\n\n- æ ·å¼åˆ‡æ¢ä¼šæ›´åŠ é¡ºç•…\n- ä¾¿äºç»„ä»¶å°è£…ä¸çŠ¶æ€ç®¡ç†\n- å¯é…ç½®æ€§æ¯”è¾ƒå¼ºï¼Œæ”¯æŒåŠ¨æ€è‡ªå®šä¹‰æ ·å¼\n\nç¼ºç‚¹ï¼š\n\n- é¦–å±åŠ è½½ä¼šæ…¢ä¸€äº›\n- é™¤äº†æ ·å¼åˆ‡æ¢ä¸ä¼šé—ªçƒï¼Œå…¶ä½™ç¼ºç‚¹ä¸åŠ¨æ€ link æ–¹æ¡ˆç¼ºç‚¹ä¸€æ ·","slug":"theme-preload"},{"title":"Nextjs: App Router çš„å®˜ç½‘è§£è¯»","date":"2024-01-19","readTime":"10 min","excerpt":"ä»‹ç» Nextjs App Router çš„å®ç°æ–¹æ³• ...","tags":["Nextjs","SSR"],"content":"$4a","slug":"nextjs-app-router"},{"title":"æ­å»ºå¾®å‰ç«¯ MontoAppï¼ˆå…­ï¼‰ - js æ²™ç®±ï¼šè‡ªæ‰§è¡Œ Script ä¸ å¿«ç…§éš”ç¦»","date":"2024-01-11","readTime":"10 min","excerpt":"ä»‹ç»è‡ªæ‰§è¡Œ Script ä¸ å¿«ç…§éš”ç¦»çš„å®ç°æ–¹æ³• ...","tags":["å¾®å‰ç«¯"],"content":"$4b","slug":"monto-app-sandbox-snapshot-script"},{"title":"æ­å»ºå¾®å‰ç«¯ MontoAppï¼ˆäº”ï¼‰ - js æ²™ç®±ï¼šWeb Components ä¸ iframeéš”ç¦»","date":"2024-01-10","readTime":"10 min","excerpt":"ä»‹ç» Web Components ä¸ iframeéš”ç¦»çš„å®ç°æ–¹æ³• ...","tags":["å¾®å‰ç«¯"],"content":"$4c","slug":"monto-app-sandbox-webcomponents-iframe"},{"title":"æ­å»ºå¾®å‰ç«¯ MontoAppï¼ˆä¸‰ï¼‰ - åŠ¨æ€ script æ–¹æ¡ˆ","date":"2024-01-09","readTime":"10 min","excerpt":"ä»‹ç»åŠ¨æ€ script æ–¹æ¡ˆçš„å®ç°æ–¹æ³• ...","tags":["å¾®å‰ç«¯"],"content":"$4d","slug":"monto-app-dym-script-1"},{"title":"æ­å»ºå¾®å‰ç«¯ MontoAppï¼ˆå››ï¼‰ - Web Components æ–¹æ¡ˆ","date":"2024-01-9","readTime":"10 min","excerpt":"ä»‹ç» Web Components æ–¹æ¡ˆçš„å®ç°æ–¹æ³• ...","tags":["å¾®å‰ç«¯"],"content":"$4e","slug":"monto-app-web-component"},{"title":"æ­å»ºå¾®å‰ç«¯ MontoAppï¼ˆäºŒï¼‰ - NPM æ–¹æ¡ˆ","date":"2024-01-08","readTime":"10 min","excerpt":"ä»‹ç» NPM æ–¹æ¡ˆçš„å®ç°æ–¹æ³• ...","tags":["å¾®å‰ç«¯"],"content":"$4f","slug":"monto-app-npm-1"},{"title":"æ­å»ºå¾®å‰ç«¯ MontoAppï¼ˆä¸€ï¼‰ - iframe æ–¹æ¡ˆ","date":"2024-01-03","readTime":"10 min","excerpt":"ä»‹ç» iframe æ–¹æ¡ˆçš„å®ç°æ–¹æ³• ...","tags":["å¾®å‰ç«¯"],"content":"$50","slug":"monto-app-iframe-1"},{"title":"æµ…è°ˆä½œä¸ºå‰ç«¯å¼€å‘å¯¹äºŒå‰æ ‘éå†çš„ç†è§£","date":"2023-12-06","readTime":"10 min","excerpt":"ä»‹ç»äºŒå‰æ ‘éå†çš„å®ç°æ–¹æ³• ...","tags":["ç®—æ³•"],"content":"$51","slug":"btree-1"},{"title":"å¹´ç»ˆç›˜ç‚¹ï¼š2023å¹´ CSS é¢†åŸŸæ–°çš„ä¸€äº›å˜åŒ–","date":"2023-12-01","readTime":"10 min","excerpt":"ä»‹ç»2023å¹´ CSS é¢†åŸŸæ–°çš„ä¸€äº›å˜åŒ– ...","tags":["CSS"],"content":"$52","slug":"new-2023"},{"title":"å°è‚šå¸¦æ‚¨ Tailwind CSS å¿«é€Ÿå…¥é—¨","date":"2023-11-11","readTime":"10 min","excerpt":"ä»‹ç» Tailwind CSS çš„å¿«é€Ÿå…¥é—¨ ...","tags":["CSS","Tailwind CSS"],"content":"$53","slug":"fe-tailwindcss-guide"},{"title":"æ–°ç‰ˆReactå®˜æ–¹æ–‡æ¡£è§£è¯»ï¼ˆå°¾ç« ï¼‰- å®éªŒæ€§åŠŸèƒ½","date":"2023-11-09","readTime":"10 min","excerpt":"ä»‹ç» React 18 çš„ useã€useOptimisticã€useFormStateã€useFormStatusã€cacheã€experimental_taintObjectReferenceã€experimental_taintUniqueValue ...","tags":["React","React 18","å®˜æ–¹æ–‡æ¡£ç¿»è¯‘"],"content":"$54","slug":"react-18-use-12"},{"title":"è®²è®² React æœåŠ¡ç«¯æ¸²æŸ“æœ€ä½³å®è·µæ–¹æ¡ˆã€æ–°ç‰ˆReact + Nextjs å®˜æ–¹æ–‡æ¡£è§£è¯»ã€‘","date":"2023-11-03","readTime":"10 min","excerpt":"ä»‹ç» React æœåŠ¡ç«¯æ¸²æŸ“æœ€ä½³å®è·µæ–¹æ¡ˆçš„å®ç°æ–¹æ³• ...","tags":["Nextjs","React","SSR"],"content":"$55","slug":"react-ssr"},{"title":"å›¾è§£æµè§ˆå™¨æ¸²æŸ“åŸç†","date":"2023-10-26","readTime":"10 min","excerpt":"ä»‹ç»å›¾è§£æµè§ˆå™¨æ¸²æŸ“åŸç†çš„æ–¹æ¡ˆ ...","tags":["æµè§ˆå™¨"],"content":"$56","slug":"v8-render"},{"title":"å›¾è§£æµè§ˆå™¨äº‹ä»¶å¾ªç¯","date":"2023-10-12","readTime":"10 min","excerpt":"ä»‹ç»å›¾è§£æµè§ˆå™¨äº‹ä»¶å¾ªç¯çš„æ–¹æ¡ˆ ...","tags":["æµè§ˆå™¨"],"content":"$57","slug":"message-loop"},{"title":"æ–°ç‰ˆReactå®˜æ–¹æ–‡æ¡£è§£è¯»ï¼ˆåä¸€ï¼‰- Client API ä¹‹ createRootã€hydrateRoot","date":"2023-09-17","readTime":"5 min","excerpt":"ä»‹ç» React 18 çš„ createRoot å’Œ hydrateRoot ...","tags":["React","React 18","å®˜æ–¹æ–‡æ¡£ç¿»è¯‘"],"content":"$58","slug":"react-18-use-11"},{"title":"æ–°ç‰ˆReactå®˜æ–¹æ–‡æ¡£è§£è¯»ï¼ˆåï¼‰- react-dom API ä¹‹ createPortal å’Œ flushSync","date":"2023-09-15","readTime":"10 min","excerpt":"ä»‹ç» React 18 çš„ createPortal å’Œ flushSync ...","tags":["React","React 18","å®˜æ–¹æ–‡æ¡£ç¿»è¯‘"],"content":"$59","slug":"react-18-use-10"},{"title":"æ–°ç‰ˆReactå®˜æ–¹æ–‡æ¡£è§£è¯»ï¼ˆä¹ï¼‰- react API ä¹‹ memo ã€forwardRef","date":"2023-09-13","readTime":"10 min","excerpt":"ä»‹ç» React 18 çš„ memo å’Œ forwardRef ...","tags":["React","React 18","å®˜æ–¹æ–‡æ¡£ç¿»è¯‘"],"content":"$5a","slug":"react-18-use-9"},{"title":"æ–°ç‰ˆReactå®˜æ–¹æ–‡æ¡£è§£è¯»ï¼ˆå…«ï¼‰- react API ä¹‹ startTransitionã€ createContext å’Œ lazy","date":"2023-09-06","readTime":"10 min","excerpt":"ä»‹ç» React 18 çš„ startTransitionã€ createContext å’Œ lazy ...","tags":["React","React 18","å®˜æ–¹æ–‡æ¡£ç¿»è¯‘"],"content":"$5b","slug":"react-18-use-8"},{"title":"é’ˆå¯¹å‰ç«¯å‘å¸ƒæ–°ç‰ˆæœ¬åç”¨æˆ·é¡µé¢èµ„æºä¸¢å¤±é—®é¢˜çš„è§£å†³æ–¹æ¡ˆ","date":"2023-08-27","readTime":"10 min","excerpt":"ä»‹ç»é’ˆå¯¹å‰ç«¯å‘å¸ƒæ–°ç‰ˆæœ¬åç”¨æˆ·é¡µé¢èµ„æºä¸¢å¤±é—®é¢˜çš„è§£å†³æ–¹æ¡ˆçš„æ–¹æ¡ˆ ...","tags":["å‰ç«¯"],"content":"$5c","slug":"version-404"},{"title":"æ–°ç‰ˆReactå®˜æ–¹æ–‡æ¡£è§£è¯»ï¼ˆä¸ƒï¼‰- react ç»„ä»¶","date":"2023-08-24","readTime":"10 min","excerpt":"ä»‹ç» React 18 çš„ Profiler å’Œ Suspense ...","tags":["React","React 18","å®˜æ–¹æ–‡æ¡£ç¿»è¯‘"],"content":"$5d","slug":"react-18-use-7"},{"title":"æ–°ç‰ˆReactå®˜æ–¹æ–‡æ¡£è§£è¯»ï¼ˆå…­ï¼‰- Hooks ä¹‹ useTransitionã€useDeferredValue","date":"2023-08-18","readTime":"10 min","excerpt":"ä»‹ç» React 18 çš„ useTransition å’Œ useDeferredValue ...","tags":["React","React 18","å®˜æ–¹æ–‡æ¡£ç¿»è¯‘"],"content":"$5e","slug":"react-18-use-6"},{"title":"æ–°ç‰ˆReactå®˜æ–¹æ–‡æ¡£è§£è¯»ï¼ˆäº”ï¼‰- Hooks ä¹‹ useId å’Œ useSyncExternalStore","date":"2023-07-05","readTime":"10 min","excerpt":"ä»‹ç» React 18 çš„ useId å’Œ useSyncExternalStore ...","tags":["React","React 18","å®˜æ–¹æ–‡æ¡£ç¿»è¯‘"],"content":"$5f","slug":"react-18-use-5"},{"title":"æ–°ç‰ˆReactå®˜æ–¹æ–‡æ¡£è§£è¯»ï¼ˆå››ï¼‰- Hooks ä¹‹ useContextã€useRef å’Œ useImperativeHandle","date":"2023-07-04","readTime":"10 min","excerpt":"ä»‹ç» React 18 çš„ useContextã€useRef å’Œ useImperativeHandle ...","tags":["React","React 18","å®˜æ–¹æ–‡æ¡£ç¿»è¯‘"],"content":"$60","slug":"react-18-use-4"},{"title":"æ–°ç‰ˆReactå®˜æ–¹æ–‡æ¡£è§£è¯»ï¼ˆä¸‰ï¼‰- Hooks ä¹‹ useEffectã€useLayoutEffect å’Œ useInsertionEffect","date":"2023-07-03","readTime":"10 min","excerpt":"ä»‹ç» React 18 çš„ useEffectã€useLayoutEffect å’Œ useInsertionEffect ...","tags":["React","React 18","å®˜æ–¹æ–‡æ¡£ç¿»è¯‘"],"content":"$61","slug":"react-18-use-3"},{"title":"æ–°ç‰ˆReactå®˜æ–¹æ–‡æ¡£è§£è¯»ï¼ˆäºŒï¼‰- Hooks ä¹‹ useState å’Œ useReducer","date":"2023-07-02","readTime":"10 min","excerpt":"ä»‹ç» React 18 çš„ useState å’Œ useReducer ...","tags":["React","React 18","å®˜æ–¹æ–‡æ¡£ç¿»è¯‘"],"content":"$62","slug":"react-18-use-2"},{"title":"æ–°ç‰ˆReactå®˜æ–¹æ–‡æ¡£è§£è¯»ï¼ˆä¸€ï¼‰- Hooks ä¹‹ useCallback å’Œ useMemo","date":"2023-07-01","readTime":"10 min","excerpt":"ä»‹ç» React 18 çš„ useCallback å’Œ useMemo ...","tags":["React","React 18","å®˜æ–¹æ–‡æ¡£ç¿»è¯‘"],"content":"$63","slug":"react-18-use-1"},{"title":"å‰ç«¯æ—¶é—´å›½é™…åŒ–çš„ä¸€ç§è§£å†³æ–¹æ¡ˆ","date":"2023-06-26","readTime":"10 min","excerpt":"ä»‹ç»å‰ç«¯æ—¶é—´å›½é™…åŒ–çš„ä¸€ç§è§£å†³æ–¹æ¡ˆçš„æ–¹æ¡ˆ ...","tags":["å·¥ç¨‹åŒ–"],"content":"$64","slug":"timezone-format"},{"title":"ESLinté…ç½®é¡¹è¯¦è§£ï¼Œå¹¶å°†é…ç½®æ‰“åŒ…npm","date":"2023-04-21","readTime":"10 min","excerpt":"ä»‹ç»ESLinté…ç½®é¡¹è¯¦è§£ï¼Œå¹¶å°†é…ç½®æ‰“åŒ…npmçš„æ–¹æ¡ˆ ...","tags":["ESLint"],"content":"$65","slug":"eslint-start"},{"title":"å†™ä¸€ä¸ªç®€æ˜“çš„å‰ç«¯ç°åº¦ç³»ç»Ÿ","date":"2023-03-19","readTime":"10 min","excerpt":"ä»‹ç»å†™ä¸€ä¸ªç®€æ˜“çš„å‰ç«¯ç°åº¦ç³»ç»Ÿçš„æ–¹æ¡ˆ ...","tags":["å·¥ç¨‹åŒ–"],"content":"$66","slug":"stark-start"},{"title":"å‰ç«¯Nginxé…ç½®æŒ‡åŒ— + HTTPSå®‰å…¨åŸç†","date":"2023-03-18","readTime":"10 min","excerpt":"ä»‹ç»å‰ç«¯Nginxé…ç½®æŒ‡åŒ— + HTTPSå®‰å…¨åŸç†çš„æ–¹æ¡ˆ ...","tags":["Nginx"],"content":"$67","slug":"nginx-start"},{"title":"Gitlab CI/CD + Nginx å®ç°è‡ªåŠ¨åŒ–é›†æˆæ„å»ºä¸éƒ¨ç½²","date":"2023-01-01","readTime":"10 min","excerpt":"ä»‹ç»Gitlab CI/CD + Nginx å®ç°è‡ªåŠ¨åŒ–é›†æˆæ„å»ºä¸éƒ¨ç½²çš„æ–¹æ¡ˆ ...","tags":["å·¥ç¨‹åŒ–"],"content":"$68","slug":"gitlab-cicd"},{"title":"å¼€å§‹ä½¿ç”¨ Mobx å§ï¼","date":"2022-12-26","readTime":"10 min","excerpt":"ä»‹ç»å¼€å§‹ä½¿ç”¨ Mobx å§ï¼çš„æ–¹æ¡ˆ ...","tags":["å·¥ç¨‹åŒ–"],"content":"$69","slug":"start-mobx"},{"title":"å‰ç«¯é¡¹ç›®éƒ¨ç½²ä¸åŒåŸŸåé—´å…±äº«cookieçš„æ–¹æ¡ˆ","date":"2022-12-25","readTime":"10 min","excerpt":"ä»‹ç»å‰ç«¯é¡¹ç›®éƒ¨ç½²ä¸åŒåŸŸåé—´å…±äº«cookieçš„æ–¹æ¡ˆ ...","tags":["å·¥ç¨‹åŒ–"],"content":"$6a","slug":"cookie-share"},{"title":"Gitlabå®‰è£…ä¸ä»“åº“ç®¡ç†","date":"2022-12-24","readTime":"10 min","excerpt":"ä»‹ç»Gitlabå®‰è£…ä¸ä»“åº“ç®¡ç†çš„æ–¹æ¡ˆ ...","tags":["å·¥ç¨‹åŒ–"],"content":"$6b","slug":"gitlab-install"},{"title":"ä½¿ç”¨ Docker + Nginx éƒ¨ç½²å‰ç«¯é¡¹ç›®","date":"2022-12-01","readTime":"10 min","excerpt":"ä»‹ç»ä½¿ç”¨ Docker + Nginx éƒ¨ç½²å‰ç«¯é¡¹ç›®çš„æ–¹æ¡ˆ ...","tags":["å·¥ç¨‹åŒ–"],"content":"$6c","slug":"docker-nginx"},{"title":"å¦‚ä½•ä½¿ç”¨npmå‘å¸ƒåŒ…çš„æµ‹è¯•ç‰ˆå’Œæ­£å¼ç‰ˆ","date":"2022-12-01","readTime":"10 min","excerpt":"ä»‹ç»å¦‚ä½•ä½¿ç”¨npmå‘å¸ƒåŒ…çš„æµ‹è¯•ç‰ˆå’Œæ­£å¼ç‰ˆçš„æ–¹æ¡ˆ ...","tags":["npm"],"content":"$6d","slug":"npm-version"},{"title":"React Router v6 å®˜æ–¹æ–‡æ¡£ç¿»è¯‘ ï¼ˆå…«ï¼‰ ---- æ–°ç‰ˆæ–°å¢åŠŸèƒ½æ±‡æ€»","date":"2022-09-30","readTime":"10 min","excerpt":"ä»‹ç» React Router v6 çš„æ–°ç‰ˆæ–°å¢åŠŸèƒ½æ±‡æ€» ...","tags":["React","React Router","å®˜æ–¹æ–‡æ¡£ç¿»è¯‘"],"content":"$6e","slug":"react-router-6-new-features-summary"},{"title":"React Router v6 å®˜æ–¹æ–‡æ¡£ç¿»è¯‘ ï¼ˆä¸ƒï¼‰ ---- å†…ç½®API","date":"2022-09-19","readTime":"10 min","excerpt":"ä»‹ç» React Router v6 çš„createRoutesFromChildrenã€createSearchParamsã€generatePathã€Locationã€matchPathã€matchRoutesã€renderMatchesã€resolvePathç­‰å†…ç½®API ...","tags":["React","React Router","å®˜æ–¹æ–‡æ¡£ç¿»è¯‘"],"content":"$6f","slug":"react-router-6-built-in-api"},{"title":"React Router v6 å®˜æ–¹æ–‡æ¡£ç¿»è¯‘ ï¼ˆå…­ï¼‰ ---- Hooks","date":"2022-08-26","readTime":"10 min","excerpt":"ä»‹ç» React Router v6 çš„useHrefã€useInRouterContextã€useLinkClickHandlerã€useLinkPressHandlerã€useLocationã€useMatchã€useNavigateã€useNavigationTypeã€useOutletã€useOutletContextã€useParamsã€useResolvedPathã€useRoutesã€useSearchParamsç­‰Hooks ...","tags":["React","React Router","å®˜æ–¹æ–‡æ¡£ç¿»è¯‘"],"content":"$70","slug":"react-router-6-hooks"},{"title":"å‰ç«¯é•¿åˆ—è¡¨æ»šåŠ¨æ–¹æ¡ˆæ¢è®¨ï¼Œçœ‹å®Œä¸è¦å†è¯´ä¸çŸ¥é“æ€ä¹ˆå®ç°è™šæ‹Ÿåˆ—è¡¨äº†","date":"2022-08-23","readTime":"10 min","excerpt":"ä»‹ç»å‰ç«¯é•¿åˆ—è¡¨æ»šåŠ¨æ–¹æ¡ˆçš„å®ç°æ–¹æ³• ...","tags":["æ€§èƒ½ä¼˜åŒ–","è™šæ‹Ÿåˆ—è¡¨"],"content":"$71","slug":"react-18-use-12"},{"title":"æ‰‹æŠŠæ‰‹æ­å»ºåŸºäºReactçš„å‰ç«¯UIåº“ ï¼ˆå…«ï¼‰-- æ¨¡æ€æ¡†ç»„ä»¶","date":"2022-6-28","readTime":"8 min","excerpt":"ä»é›¶å¼€å§‹æ­å»ºåŸºäºReact + dumiæ–‡æ¡£ç³»ç»Ÿçš„å‰ç«¯UIåº“ ...","tags":["REACT","GITHUB","UI/UX","ç»„ä»¶åº“æ­å»º"],"content":"$72","slug":"fe-UI-8"},{"title":"æ‰‹æŠŠæ‰‹æ­å»ºåŸºäºReactçš„å‰ç«¯UIåº“ ï¼ˆä¸ƒï¼‰-- å¼¹å‡ºå±‚ç»„ä»¶","date":"2022-6-22","readTime":"8 min","excerpt":"ä»é›¶å¼€å§‹æ­å»ºåŸºäºReact + dumiæ–‡æ¡£ç³»ç»Ÿçš„å‰ç«¯UIåº“ ...","tags":["REACT","GITHUB","UI/UX","ç»„ä»¶åº“æ­å»º"],"content":"$73","slug":"fe-UI-7"},{"title":"Rxjs ä½¿ç”¨æŒ‡åŒ—","date":"2022-06-19","readTime":"10 min","excerpt":"ä»‹ç»Rxjs ä½¿ç”¨æŒ‡åŒ—çš„æ–¹æ¡ˆ ...","tags":["Rxjs"],"content":"$74","slug":"rxjs"},{"title":"ä¼ªå…ƒç´ æ¨¡æ‹Ÿå®ç°å¾®è½¯logoé˜´å½±","date":"2022-06-15","readTime":"10 min","excerpt":"ä»‹ç»ä¼ªå…ƒç´ æ¨¡æ‹Ÿå®ç°å¾®è½¯logoé˜´å½±çš„å®ç°æ–¹æ³• ...","tags":["CSS"],"content":"$75","slug":"microsoft-logo"},{"title":"shadow æ¢ç©¶(äºŒ) - ç¯çŠ¶åŠ¨ç”»","date":"2022-06-15","readTime":"10 min","excerpt":"ä»‹ç»ç¯çŠ¶åŠ¨ç”»çš„å®ç°æ–¹æ³• ...","tags":["CSS"],"content":"$76","slug":"ring-animation"},{"title":"shadow æ¢ç©¶(ä¸€) - ç«‹ä½“å¡ç‰‡","date":"2022-06-15","readTime":"10 min","excerpt":"ä»‹ç»ç«‹ä½“å¡ç‰‡çš„å®ç°æ–¹æ³• ...","tags":["CSS"],"content":"$77","slug":"shadow-card"},{"title":"JavaScript å†å²ç‰ˆæœ¬ä¸€è§ˆ","date":"2022-06-15","readTime":"10 min","excerpt":"ä» ECMA-262 æ ‡å‡†åˆ° JavaScript çš„å†å²ç‰ˆæœ¬ä¸€è§ˆ ...","tags":["JavaScript"],"content":"$78","slug":"js-history"},{"title":"React Router v6 å®˜æ–¹æ–‡æ¡£ç¿»è¯‘ ï¼ˆäº”ï¼‰ ---- è·¯ç”±ç»„ä»¶","date":"2022-06-09","readTime":"10 min","excerpt":"ä»‹ç» React Router v6 çš„Linkã€NavLinkã€Navigateã€Outletã€Routesã€Routeç­‰è·¯ç”±ç»„ä»¶ ...","tags":["React","React Router","å®˜æ–¹æ–‡æ¡£ç¿»è¯‘"],"content":"$79","slug":"react-router-6-routing-components"},{"title":"React Router v6 å®˜æ–¹æ–‡æ¡£ç¿»è¯‘ ï¼ˆå››ï¼‰ ---- å„ç§ç±»å‹çš„Router","date":"2022-06-08","readTime":"10 min","excerpt":"ä»‹ç» React Router v6 çš„æµè§ˆå™¨Routerã€HashRouterã€HistoryRouterã€MemoryRouterã€NativeRouterã€StaticRouterç­‰ ...","tags":["React","React Router","å®˜æ–¹æ–‡æ¡£ç¿»è¯‘"],"content":"$7a","slug":"react-router-6-various-types-of-routers"},{"title":"React Router v6 å®˜æ–¹æ–‡æ¡£ç¿»è¯‘ ï¼ˆä¸‰ï¼‰ ---- ä¸»è¦æ¦‚å¿µ","date":"2022-06-07","readTime":"10 min","excerpt":"ä»‹ç» React Router v6 çš„ä¸»è¦æ¦‚å¿µ ...","tags":["React","React Router","å®˜æ–¹æ–‡æ¡£ç¿»è¯‘"],"content":"$7b","slug":"react-router-6-concepts"},{"title":"æ‰‹æŠŠæ‰‹æ­å»ºåŸºäºReactçš„å‰ç«¯UIåº“ ï¼ˆå…­ï¼‰-- æ‰“åŒ…ä¸å‘å¸ƒ","date":"2022-5-23","readTime":"4 min","excerpt":"ä»é›¶å¼€å§‹æ­å»ºåŸºäºReact + dumiæ–‡æ¡£ç³»ç»Ÿçš„å‰ç«¯UIåº“ ...","tags":["REACT","GITHUB","UI/UX","ç»„ä»¶åº“æ­å»º"],"content":"$7c","slug":"fe-UI-6"},{"title":"æ‰‹æŠŠæ‰‹æ­å»ºåŸºäºReactçš„å‰ç«¯UIåº“ ï¼ˆäº”ï¼‰-- è¡¨å•ç»„ä»¶","date":"2022-5-22","readTime":"4 min","excerpt":"ä»é›¶å¼€å§‹æ­å»ºåŸºäºReact + dumiæ–‡æ¡£ç³»ç»Ÿçš„å‰ç«¯UIåº“ ...","tags":["REACT","GITHUB","UI/UX","ç»„ä»¶åº“æ­å»º"],"content":"$7d","slug":"fe-UI-5"},{"title":"ğŸ”¥ å‰ç«¯å·¥ç¨‹åŒ–å¿…ç»çš„ä¸€ç¯ -- å‰åç«¯æ¥å£è§„èŒƒ","date":"2022-05-01","readTime":"10 min","excerpt":"ä»‹ç»å‰åç«¯æ¥å£è§„èŒƒçš„æ–¹æ¡ˆ ...","tags":["å·¥ç¨‹åŒ–"],"content":"$7e","slug":"fe-vs-be"},{"title":"React Router v6 å®˜æ–¹æ–‡æ¡£ç¿»è¯‘ ï¼ˆäºŒï¼‰ ---- FAQs","date":"2022-04-25","readTime":"10 min","excerpt":"ä»‹ç» React Router v6 çš„å¸¸è§é—®é¢˜å’Œè§£ç­” ...","tags":["React","React Router","å®˜æ–¹æ–‡æ¡£ç¿»è¯‘"],"content":"$7f","slug":"react-router-6-faqs"},{"title":"React Router v6 å®˜æ–¹æ–‡æ¡£ç¿»è¯‘ ï¼ˆä¸€ï¼‰ ---- Installation && Quick Start","date":"2022-04-12","readTime":"10 min","excerpt":"ä»‹ç» React Router v6 çš„å®‰è£…å’Œå¿«é€Ÿå¼€å§‹ ...","tags":["React","React Router","å®˜æ–¹æ–‡æ¡£ç¿»è¯‘"],"content":"$80","slug":"react-router-6-installation-quick-start"},{"title":"æ‰‹æŠŠæ‰‹æ­å»ºåŸºäºReactçš„å‰ç«¯UIåº“ ï¼ˆå››ï¼‰-- å¸ƒå±€ç»„ä»¶","date":"2022-3-21","readTime":"4 min","excerpt":"ä»é›¶å¼€å§‹æ­å»ºåŸºäºReact + dumiæ–‡æ¡£ç³»ç»Ÿçš„å‰ç«¯UIåº“ ...","tags":["REACT","GITHUB","UI/UX","ç»„ä»¶åº“æ­å»º"],"content":"$81","slug":"fe-UI-4"},{"title":"æ‰‹æŠŠæ‰‹æ­å»ºåŸºäºReactçš„å‰ç«¯UIåº“ ï¼ˆä¸‰ï¼‰-- åŸºç¡€ç»„ä»¶Iconå’ŒButton","date":"2022-3-20","readTime":"6 min","excerpt":"ä»é›¶å¼€å§‹æ­å»ºåŸºäºReact + dumiæ–‡æ¡£ç³»ç»Ÿçš„å‰ç«¯UIåº“ ...","tags":["REACT","GITHUB","UI/UX","ç»„ä»¶åº“æ­å»º"],"content":"$82","slug":"fe-UI-3"},{"id":"3","title":"æ‰‹æŠŠæ‰‹æ­å»ºåŸºäºReactçš„å‰ç«¯UIåº“ ï¼ˆäºŒï¼‰-- ä¸»é¢˜é…ç½®","date":"2022-3-19","readTime":"6 min","excerpt":"ä»é›¶å¼€å§‹æ­å»ºåŸºäºReact + dumiæ–‡æ¡£ç³»ç»Ÿçš„å‰ç«¯UIåº“ ...","tags":["REACT","GITHUB","UI/UX","ç»„ä»¶åº“æ­å»º"],"content":"$83","slug":"fe-UI-2"},{"id":"2","title":"æ‰‹æŠŠæ‰‹æ­å»ºåŸºäºReactçš„å‰ç«¯UIåº“ ï¼ˆä¸€ï¼‰-- é¡¹ç›®åˆå§‹åŒ–","date":"2022-3-14","readTime":"3 min","excerpt":"ä»é›¶å¼€å§‹æ­å»ºåŸºäºReact + dumiæ–‡æ¡£ç³»ç»Ÿçš„å‰ç«¯UIåº“ ...","tags":["REACT","GITHUB","UI/UX","ç»„ä»¶åº“æ­å»º"],"content":"$84","slug":"fe-UI-1"},{"title":"å‰ç«¯ç¯å¢ƒæ­å»º","date":"2022-03-01","readTime":"10 min","excerpt":"ä»‹ç»å‰ç«¯ç¯å¢ƒæ­å»ºçš„æ–¹æ¡ˆ ...","tags":["å·¥ç¨‹åŒ–"],"content":"$85","slug":"fe-prepare"},{"title":"å…³äºå‰ç«¯äº§å“æŠ€æœ¯é€‰å‹é—®é¢˜çš„è‹¥å¹²æ€è€ƒ","date":"2022-02-01","readTime":"10 min","excerpt":"ä»‹ç»å…³äºå‰ç«¯äº§å“æŠ€æœ¯é€‰å‹é—®é¢˜çš„è‹¥å¹²æ€è€ƒçš„æ–¹æ¡ˆ ...","tags":["æŠ€æœ¯é€‰å‹"],"content":"$86","slug":"select-frame"}],"gallery":[{"id":"img-0","src":"https://picsum.photos/1200/1200?random=10","alt":"æŠ½è±¡æ„å›¾ 1","category":"3D æ¸²æŸ“","title":"æ¸²æŸ“å®éªŒ #1","description":"ä½¿ç”¨ Blender å‡ ä½•èŠ‚ç‚¹æ¢ç´¢ç¨‹åºåŒ–ç”Ÿæˆã€‚çº¹ç†å·¥ä½œä¸“æ³¨äºæ•°å­—æ„é€ ä¸­çš„ä¸å®Œç¾å’ŒçœŸå®æ„Ÿã€‚"},{"id":"img-1","src":"https://picsum.photos/1200/1200?random=11","alt":"æŠ½è±¡æ„å›¾ 2","category":"æ‘„å½±","title":"åŸå¸‚ç ”ç©¶ #2","description":"åœ¨ä¸œäº¬ç”¨ 35mm èƒ¶ç‰‡æ‹æ‘„ã€‚è¿™å¼ ç…§ç‰‡å¼ºè°ƒäº†ç²—é‡ä¸»ä¹‰å»ºç­‘ä¸æœ‰æœºåŸå¸‚ç”Ÿæ´»ä¹‹é—´çš„ç›¸äº’ä½œç”¨ã€‚"},{"id":"img-2","src":"https://picsum.photos/1200/1200?random=12","alt":"æŠ½è±¡æ„å›¾ 3","category":"3D æ¸²æŸ“","title":"æ¸²æŸ“å®éªŒ #3","description":"ä½¿ç”¨ Blender å‡ ä½•èŠ‚ç‚¹æ¢ç´¢ç¨‹åºåŒ–ç”Ÿæˆã€‚çº¹ç†å·¥ä½œä¸“æ³¨äºæ•°å­—æ„é€ ä¸­çš„ä¸å®Œç¾å’ŒçœŸå®æ„Ÿã€‚"},{"id":"img-3","src":"https://picsum.photos/1200/1200?random=13","alt":"æŠ½è±¡æ„å›¾ 4","category":"æ‘„å½±","title":"åŸå¸‚ç ”ç©¶ #4","description":"åœ¨ä¸œäº¬ç”¨ 35mm èƒ¶ç‰‡æ‹æ‘„ã€‚è¿™å¼ ç…§ç‰‡å¼ºè°ƒäº†ç²—é‡ä¸»ä¹‰å»ºç­‘ä¸æœ‰æœºåŸå¸‚ç”Ÿæ´»ä¹‹é—´çš„ç›¸äº’ä½œç”¨ã€‚"},{"id":"img-4","src":"https://picsum.photos/1200/1200?random=14","alt":"æŠ½è±¡æ„å›¾ 5","category":"3D æ¸²æŸ“","title":"æ¸²æŸ“å®éªŒ #5","description":"ä½¿ç”¨ Blender å‡ ä½•èŠ‚ç‚¹æ¢ç´¢ç¨‹åºåŒ–ç”Ÿæˆã€‚çº¹ç†å·¥ä½œä¸“æ³¨äºæ•°å­—æ„é€ ä¸­çš„ä¸å®Œç¾å’ŒçœŸå®æ„Ÿã€‚"},{"id":"img-5","src":"https://picsum.photos/1200/1200?random=15","alt":"æŠ½è±¡æ„å›¾ 6","category":"æ‘„å½±","title":"åŸå¸‚ç ”ç©¶ #6","description":"åœ¨ä¸œäº¬ç”¨ 35mm èƒ¶ç‰‡æ‹æ‘„ã€‚è¿™å¼ ç…§ç‰‡å¼ºè°ƒäº†ç²—é‡ä¸»ä¹‰å»ºç­‘ä¸æœ‰æœºåŸå¸‚ç”Ÿæ´»ä¹‹é—´çš„ç›¸äº’ä½œç”¨ã€‚"},{"id":"img-6","src":"https://picsum.photos/1200/1200?random=16","alt":"æŠ½è±¡æ„å›¾ 7","category":"3D æ¸²æŸ“","title":"æ¸²æŸ“å®éªŒ #7","description":"ä½¿ç”¨ Blender å‡ ä½•èŠ‚ç‚¹æ¢ç´¢ç¨‹åºåŒ–ç”Ÿæˆã€‚çº¹ç†å·¥ä½œä¸“æ³¨äºæ•°å­—æ„é€ ä¸­çš„ä¸å®Œç¾å’ŒçœŸå®æ„Ÿã€‚"},{"id":"img-7","src":"https://picsum.photos/1200/1200?random=17","alt":"æŠ½è±¡æ„å›¾ 8","category":"æ‘„å½±","title":"åŸå¸‚ç ”ç©¶ #8","description":"åœ¨ä¸œäº¬ç”¨ 35mm èƒ¶ç‰‡æ‹æ‘„ã€‚è¿™å¼ ç…§ç‰‡å¼ºè°ƒäº†ç²—é‡ä¸»ä¹‰å»ºç­‘ä¸æœ‰æœºåŸå¸‚ç”Ÿæ´»ä¹‹é—´çš„ç›¸äº’ä½œç”¨ã€‚"},{"id":"img-8","src":"https://picsum.photos/1200/1200?random=18","alt":"æŠ½è±¡æ„å›¾ 9","category":"3D æ¸²æŸ“","title":"æ¸²æŸ“å®éªŒ #9","description":"ä½¿ç”¨ Blender å‡ ä½•èŠ‚ç‚¹æ¢ç´¢ç¨‹åºåŒ–ç”Ÿæˆã€‚çº¹ç†å·¥ä½œä¸“æ³¨äºæ•°å­—æ„é€ ä¸­çš„ä¸å®Œç¾å’ŒçœŸå®æ„Ÿã€‚"}]}}}],["$L87"],"$L88"]}],"loading":null,"isPartial":false}
87:["$","script","script-0",{"src":"/_next/static/chunks/4a4bc4fd39133772.js","async":true}]
88:["$","$L89",null,{"children":["$","$8a",null,{"name":"Next.MetadataOutlet","children":"$@8b"}]}]
8b:null
